define(function(require,exports,module){const PreferencesManager=require("preferences/PreferencesManager"),Menus=require("command/Menus"),Editor=require("editor/Editor").Editor,EditorManager=require("editor/EditorManager"),AppInit=require("utils/AppInit"),Commands=require("command/Commands"),CommandManager=require("command/CommandManager"),MainViewManager=require("view/MainViewManager"),Strings=require("strings"),COMMAND_NAME=Strings.CMD_TOGGLE_INDENT_GUIDES,COMMAND_ID=Commands.TOGGLE_INDENT_GUIDES,GUIDE_CLASS="phcode-indent-guides",GUIDE_CLASS_NONE="phcode-indent-guides-none",PREFERENCES_EDITOR_INDENT_GUIDES="editor.indentGuides",PREFERENCES_EDITOR_INDENT_HIDE_FIRST="editor.indentHideFirst";let enabled=!0,hideFirst=!1;function _createOverlayObject(spaceUnits){return{_spaceUnits:spaceUnits,_cmRefreshPending:!1,token:function(stream,_state){let char="",colNum=0,isTabStart=!1;return char=stream.next(),colNum=stream.column(),hideFirst&&0===colNum?null:"\t"===char?enabled?GUIDE_CLASS:GUIDE_CLASS_NONE:" "!==char?(stream.skipToEnd(),null):(isTabStart=colNum%this._spaceUnits==0," "===char&&isTabStart?enabled?GUIDE_CLASS:GUIDE_CLASS_NONE:null)},flattenSpans:!1}}function applyPreferences(){enabled=PreferencesManager.get(PREFERENCES_EDITOR_INDENT_GUIDES),hideFirst=PreferencesManager.get(PREFERENCES_EDITOR_INDENT_HIDE_FIRST)}function updateUI(){const editor=EditorManager.getActiveEditor();if(!editor||!editor._codeMirror)return;const cm=editor._codeMirror;function _reRenderOverlay(){cm.removeOverlay(editor.__indentGuidesOverlay),cm.addOverlay(editor.__indentGuidesOverlay)}editor.__indentGuidesOverlay||(editor.__indentGuidesOverlay=_createOverlayObject(Editor.getSpaceUnits(editor.document.file.fullPath))),editor.off(Editor.EVENT_OPTION_CHANGE+".indentGuide"),editor.on(Editor.EVENT_OPTION_CHANGE+".indentGuide",()=>{const newSpaceUnits=Editor.getSpaceUnits(editor.document.file.fullPath);newSpaceUnits!==editor.__indentGuidesOverlay._spaceUnits&&(editor.__indentGuidesOverlay._spaceUnits=newSpaceUnits,EditorManager.getActiveEditor()===editor&&(console.log("space units changed, refreshing indent guides for",newSpaceUnits,editor.document.file.fullPath),_reRenderOverlay()))});let shouldRerender=!1;cm.__indentGuidesOverlayAttached?cm.__indentGuidesOverlayAttached&&cm.__indentGuidesOverlayAttached!==editor.__indentGuidesOverlay?(cm.removeOverlay(cm.__indentGuidesOverlayAttached),cm.addOverlay(editor.__indentGuidesOverlay),cm.__overlayEnabled=enabled):cm.__overlayEnabled!==enabled&&(cm.__overlayEnabled=enabled,_reRenderOverlay(),console.log("Refreshing indent guides")):(cm.addOverlay(editor.__indentGuidesOverlay),cm.__indentGuidesOverlayAttached=editor.__indentGuidesOverlay,cm.__overlayEnabled=enabled)}function handleToggleGuides(){enabled=!enabled,PreferencesManager.set(PREFERENCES_EDITOR_INDENT_GUIDES,enabled)}function preferenceChanged(){applyPreferences(),updateUI(),CommandManager.get(COMMAND_ID).setChecked(enabled)}PreferencesManager.definePreference(PREFERENCES_EDITOR_INDENT_GUIDES,"boolean",enabled,{description:Strings.DESCRIPTION_INDENT_GUIDES_ENABLED}),PreferencesManager.definePreference(PREFERENCES_EDITOR_INDENT_HIDE_FIRST,"boolean",hideFirst,{description:Strings.DESCRIPTION_HIDE_FIRST}),AppInit.appReady(function(){CommandManager.register(COMMAND_NAME,COMMAND_ID,handleToggleGuides),Menus.getMenu(Menus.AppMenuBar.VIEW_MENU).addMenuItem(COMMAND_ID,"",Menus.AFTER,Commands.TOGGLE_RULERS),PreferencesManager.on("change",PREFERENCES_EDITOR_INDENT_GUIDES,preferenceChanged),PreferencesManager.on("change",PREFERENCES_EDITOR_INDENT_HIDE_FIRST,preferenceChanged),MainViewManager.on("currentFileChange",updateUI),EditorManager.on("activeEditorChange",updateUI),preferenceChanged()})});
//# sourceMappingURL=main.js.map
