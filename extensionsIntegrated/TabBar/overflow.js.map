{"version":3,"sources":["extensionsIntegrated/TabBar/overflow.js"],"names":["define","require","exports","module","DropdownButton","MainViewManager","CommandManager","Commands","EditorManager","FileSystem","$dropdown","_getListOfHiddenTabs","paneId","$currentTabBar","$","tabBarRect","getBoundingClientRect","hiddenTabs","find","each","tabRect","this","isVisible","left","right","$tab","tabData","path","data","name","text","isActive","hasClass","isDirty","isPlaceholder","$icon","clone","push","toggleOverflowVisibility","$overflowButton","length","removeClass","addClass","showOverflowMenu","x","y","closingTabPaths","item","index","iconHtml","outerHTML","dirtyHtml","closeIconHtml","placeholderClass","html","enabled","dropdownExtraClasses","append","$button","css","position","top","zIndex","document","one","e","tabPath","preventDefault","showDropdown","on","file","getFileForPath","setTimeout","execute","FILE_CLOSE","filePath","setActivePaneId","FILE_OPEN","fullPath","$tabBarElement","scrollToActiveTab","display","activePath","activeEditor","getActiveEditor","currentFile","getCurrentlyViewedFile","$activeTab","tabBar","tabBarVisibleWidth","width","tabLeftRelative","tabRightRelative","currentScroll","scrollLeft","targetScroll","scrollDistance","scrollAdjustment","Math","abs","duration","min","max","stop","animate","_closeDropdown","remove","_handleOverflowButtonClick","stopPropagation","pageX","pageY","init","target","closest"],"mappings":"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","sourcesContent":["/*\n * GNU AGPL-3.0 License\n *\n * Copyright (c) 2021 - present core.ai . All rights reserved.\n *\n * This program is free software: you can redistribute it and/or modify it\n * under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT\n * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License\n * for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see https://opensource.org/licenses/AGPL-3.0.\n *\n */\n\n\n/*\n * This file houses the functionality for overflow tabs,\n * the overflow tabs appear when there are too many tabs in a pane\n * overflow button when clicked opens up a dropdown menu which displays all the hidden tabs\n * and allows the user to open them, close them and to achieve other functionalities from there\n */\n/* eslint-disable no-invalid-this */\ndefine(function (require, exports, module) {\n\n    const DropdownButton = require(\"widgets/DropdownButton\");\n    const MainViewManager = require(\"view/MainViewManager\");\n    const CommandManager = require(\"command/CommandManager\");\n    const Commands = require(\"command/Commands\");\n    const EditorManager = require(\"editor/EditorManager\");\n    const FileSystem = require(\"filesystem/FileSystem\");\n\n    // holds the dropdown instance\n    let $dropdown = null;\n\n    /**\n     * This function determines which tabs are hidden in the tab bar due to overflow\n     * and returns them as an array of tab data objects\n     *\n     * @param {String} paneId - The ID of the pane (\"first-pane\" or \"second-pane\")\n     * @returns {Array} - Array of hidden tab data objects\n     */\n    function _getListOfHiddenTabs(paneId) {\n        // get the appropriate tab bar based on pane ID\n        const $currentTabBar = paneId === \"first-pane\"\n            ? $(\"#phoenix-tab-bar\")\n            : $(\"#phoenix-tab-bar-2\");\n\n        // access the DOM element to get its bounding rectangle\n        const tabBarRect = $currentTabBar[0].getBoundingClientRect();\n\n        // an array of hidden tabs objects which will store properties like\n        // path, name, isActive, isDirty and $icon\n        const hiddenTabs = [];\n\n        // check each tab to determine if it's visible\n        $currentTabBar.find('.tab').each(function () {\n            const tabRect = this.getBoundingClientRect();\n\n            // A tab is considered hidden if it is not completely visible\n            // 2 is added here, because when we scroll till the very end of the tab bar even though,\n            // the last tab was shown in the overflow menu even though it was completely visible\n            // this bug was coming because a part of the last tab got hidden inside the dropdown icon\n            const isVisible = tabRect.left >= tabBarRect.left &&\n                tabRect.right <= (tabBarRect.right + 2);\n\n            if (!isVisible) {\n                // extract and store information about the hidden tab\n                const $tab = $(this);\n                const tabData = {\n                    path: $tab.data('path'),\n                    name: $tab.find('.tab-name').text(),\n                    isActive: $tab.hasClass('active'),\n                    isDirty: $tab.hasClass('dirty'),\n                    isPlaceholder: $tab.hasClass('placeholder'),\n                    $icon: $tab.find('.tab-icon').clone()\n                };\n\n                hiddenTabs.push(tabData);\n            }\n        });\n\n        return hiddenTabs;\n    }\n\n\n    /**\n     * Toggles the visibility of the overflow button based on whether\n     * there are any hidden tabs\n     * Hidden tabs are tabs that are currently not visible in the tab bar\n     *\n     * @param {String} paneId - The ID of the pane (\"first-pane\" or \"second-pane\")\n     */\n    function toggleOverflowVisibility(paneId) {\n        const hiddenTabs = _getListOfHiddenTabs(paneId);\n\n        if (paneId === \"first-pane\") {\n            // for the html element, refer to ./html/tabbar-pane.html\n            const $overflowButton = $(\"#overflow-button\");\n\n            if (hiddenTabs.length > 0) {\n                $overflowButton.removeClass(\"hidden\");\n            } else {\n                $overflowButton.addClass(\"hidden\");\n            }\n        } else {\n            // for the html element, refer to ./html/tabbar-second-pane.html\n            const $overflowButton = $(\"#overflow-button-2\");\n\n            if (hiddenTabs.length > 0) {\n                $overflowButton.removeClass(\"hidden\");\n            } else {\n                $overflowButton.addClass(\"hidden\");\n            }\n        }\n    }\n\n\n    /**\n     * This function is called when the overflow button is clicked\n     * This will show the overflow context menu\n     *\n     * @param {String} paneId - the id of the pane [\"first-pane\", \"second-pane\"]\n     * @param {Number} x - x coordinate for positioning the menu\n     * @param {Number} y - y coordinate for positioning the menu\n     */\n    function showOverflowMenu(paneId, x, y) {\n        const hiddenTabs = _getListOfHiddenTabs(paneId);\n\n        // Create a map to track tabs that are being closed\n        // Using paths as keys for quick lookup\n        const closingTabPaths = {};\n\n        // create the dropdown\n        $dropdown = new DropdownButton.DropdownButton(\"\", hiddenTabs, function (item, index) {\n            const iconHtml = item.$icon[0].outerHTML; // the file icon\n            const dirtyHtml = item.isDirty\n                ? '<span class=\"tab-dirty-icon-overflow\">â€¢</span>'\n                : '<span class=\"tab-dirty-icon-overflow empty\"></span>'; // adding an empty span for better alignment\n\n            const closeIconHtml =\n                `<span class=\"tab-close-icon-overflow\" data-tab-path=\"${item.path}\" data-tab-index=\"${index}\">\n                <i class=\"fa-solid fa-times\"></i>\n            </span>`;\n\n            // add placeholder class to style it differently\n            const placeholderClass = item.isPlaceholder ? ' placeholder-name' : '';\n\n            // return html for this item\n            return {\n                html:\n                    `<div class=\"dropdown-tab-item${item.isPlaceholder\n                        ? ' placeholder-item' : ''\n                    }\" data-tab-path=\"${item.path}\">\n                <div class=\"tab-info-container\">\n                    ${dirtyHtml}\n                    <span class=\"tab-icon-container\">${iconHtml}</span>\n                    <span class=\"tab-name-container${placeholderClass}\">${item.name}</span>\n                </div>\n                ${closeIconHtml}\n            </div>`,\n                enabled: true\n            };\n        });\n\n        // add custom class to separate overflow dropdown from regular ones\n        $dropdown.dropdownExtraClasses = \"dropdown-overflow-menu\";\n\n        // appending to document body. we'll position this with absolute positioning\n        $(\"body\").append($dropdown.$button);\n\n        // position the dropdown where the user clicked\n        $dropdown.$button.css({\n            position: \"absolute\",\n            left: x + \"px\",\n            top: y + \"px\",\n            zIndex: 1000\n        });\n\n\n        // custom handler for close button clicks - must be set up BEFORE showing dropdown\n        // using one because we only want to run this handler once\n        $(document).one(\"mousedown\", \".tab-close-icon-overflow\", function (e) {\n            // store the path of the tab being closed\n            const tabPath = $(this).data(\"tab-path\");\n            closingTabPaths[tabPath] = true;\n\n            // we don't stop propagation here - let the event bubble up\n            // because we want the tab click handler to run as we are not closing the tab here\n            // Why all this is done instead of simply closing the tab?\n            // There was no way to stop the tab click handler from running.\n            // Tried propagating the event, and all other stuff but that didn't work.\n            // So what used to happen was that the tab used to get closed but then appeared again\n\n            // But we do prevent the default action\n            e.preventDefault();\n        });\n\n        $dropdown.showDropdown();\n\n        // handle the option selection\n        $dropdown.on(\"select\", function (e, item, index) {\n            // check if this tab was marked for closing\n            if (closingTabPaths[item.path]) {\n                // this tab is being closed, so handle the close operation\n                const file = FileSystem.getFileForPath(item.path);\n\n                if (file) {\n                    // use setTimeout to ensure this happens after all event handlers\n                    setTimeout(function () {\n                        CommandManager.execute(Commands.FILE_CLOSE, { file: file, paneId: paneId });\n                        // clean up\n                        delete closingTabPaths[item.path];\n                    }, 0);\n                }\n\n                return false;\n            }\n            // regular tab selection - open the file\n            const filePath = item.path;\n            if (filePath) {\n                // Set the active pane and open the file\n                MainViewManager.setActivePaneId(paneId);\n                CommandManager.execute(Commands.FILE_OPEN, { fullPath: filePath });\n\n                // get the tab bar element based on paneId and scroll to the active tab\n                // we use setTimeout to ensure that the DOM has updated after the file open command\n                setTimeout(function () {\n                    const $tabBarElement = paneId === \"first-pane\" ?\n                        $(\"#phoenix-tab-bar\") : $(\"#phoenix-tab-bar-2\");\n                    scrollToActiveTab($tabBarElement);\n                }, 100);\n            }\n        });\n\n        // a button was getting displayed on the screen wherever a click was made. not sure why\n        // but this fixes it\n        $dropdown.$button.css({\n            display: \"none\"\n        });\n    }\n\n\n    /**\n     * Scrolls the tab bar to the active tab.\n     * When scrolling the tab bar, we calculate the distance we need to scroll and based on that distance,\n     * we set the duration.\n     * This ensures that the scrolling speed is consistent no matter the distance or number of tabs present in tab bar.\n     *\n     * @param {JQuery} $tabBarElement - The tab bar element,\n     * this is either $('#phoenix-tab-bar') or $('phoenix-tab-bar-2')\n     */\n    function scrollToActiveTab($tabBarElement) {\n        if (!$tabBarElement || !$tabBarElement.length) {\n            return;\n        }\n\n        let activePath;\n\n        // get the active file\n        const activeEditor = EditorManager.getActiveEditor();\n        if (activeEditor && activeEditor.document && activeEditor.document.file) {\n            activePath = activeEditor.document.file.fullPath;\n        } else {\n            // If there is no active editor, we need to check if its an image file\n            const currentFile = MainViewManager.getCurrentlyViewedFile();\n            if (currentFile) {\n                activePath = currentFile.fullPath;\n            } else {\n                // if not an image file, not a text file, we don't need to scroll\n                return;\n            }\n        }\n\n        // get the active tab. the active tab is the tab that is currently open\n        const $activeTab = $tabBarElement.find(`.tab[data-path=\"${activePath}\"]`);\n\n        if ($activeTab.length) {\n            // get the tab bar container's dimensions\n            const tabBar = $tabBarElement[0];\n            const tabBarRect = tabBar.getBoundingClientRect();\n            const tabBarVisibleWidth = tabBarRect.width;\n\n            // get the active tab's dimensions\n            const tabRect = $activeTab[0].getBoundingClientRect();\n\n            // calculate the tab's position relative to the tab bar container\n            const tabLeftRelative = tabRect.left - tabBarRect.left;\n            const tabRightRelative = tabRect.right - tabBarRect.left;\n\n            // get current scroll position\n            const currentScroll = tabBar.scrollLeft;\n            let targetScroll = currentScroll;\n            let scrollDistance = 0;\n\n            // calculate needed scroll adjustment\n            if (tabLeftRelative < 0) {\n                targetScroll = currentScroll + tabLeftRelative - 10;\n            } else if (tabRightRelative > tabBarVisibleWidth) {\n                const scrollAdjustment = tabRightRelative - tabBarVisibleWidth + 10;\n                targetScroll = currentScroll + scrollAdjustment;\n            }\n\n            // calculate the scroll distance in pixels\n            scrollDistance = Math.abs(targetScroll - currentScroll);\n\n            // calculate duration based on distance (0.15ms per pixel + 100ms base)\n            // min 100ms, max 400ms\n            let duration = Math.min(Math.max(scrollDistance * 0.15, 100), 400);\n\n            // only animate if we need to move more than 5 pixels\n            // otherwise, we can just jump\n            if (scrollDistance > 5) {\n                $tabBarElement.stop(true).animate(\n                    { scrollLeft: targetScroll },\n                    duration,\n                    'linear'\n                );\n            } else {\n                tabBar.scrollLeft = targetScroll;\n            }\n        }\n    }\n\n    /**\n     * to close the overflow button's dropdown\n     */\n    function _closeDropdown() {\n        if ($dropdown) {\n            if ($dropdown.$button) {\n                $dropdown.$button.remove();\n            }\n            $dropdown = null;\n        }\n    }\n\n    /**\n     * this function gets called when the overflow button gets clicked\n     * it shows/closes the dropdown as required\n     * @param {Event} e - the event instance\n     * @param {String} paneId - the pane id \"first-pane\" or \"second-pane\"\n     */\n    function _handleOverflowButtonClick(e, paneId) {\n        e.stopPropagation();\n        $dropdown ? _closeDropdown() : showOverflowMenu(paneId, e.pageX, e.pageY);\n    }\n\n    /**\n     * initialize the handling of the overflow buttons\n     * this also registers the event handlers\n     */\n    function init() {\n        // when clicked anywhere on the page we want to close the dropdown\n        // except the overflow-buttons\n        $(\"html\").on(\"click\", function (e) {\n            if ($(e.target).closest(\"#overflow-button, #overflow-button-2\").length) { return; }\n            _closeDropdown();\n        });\n\n        // handle when the overflow button is clicked for the first pane\n        $(document).on(\"click\", \"#overflow-button\", function (e) {\n            _handleOverflowButtonClick(e, \"first-pane\");\n        });\n\n        // for second pane\n        $(document).on(\"click\", \"#overflow-button-2\", function (e) {\n            _handleOverflowButtonClick(e, \"second-pane\");\n        });\n    }\n\n    module.exports = {\n        init,\n        toggleOverflowVisibility,\n        scrollToActiveTab\n    };\n});\n"],"file":"overflow.js"}