{"version":3,"sources":["services/login-utils.js"],"names":["define","require","exports","module","KernalModeTrust","window","Error","validTillExpired","entitlements","lastRecordedEntitlement","now","Date","isNewlyExpired","validTill","lastValidTill","plan","name","brackets","config","main_pro_plan","key","entitlement","haveEntitlementsChanged","current","last","currentPaidSub","paidSubscriber","lastPaidSub","currentIsSubscriber","isSubscriber","lastIsSubscriber","currentPlanName","lastPlanName","Object","keys","currentActivated","activated","lastActivated","LoginUtils","Phoenix","isTestWindow"],"mappings":"AAyBAA,OAAO,SAAUC,QAASC,QAASC,QAE/B,MAAMC,gBAAkBC,OAAOD,gBAC/B,IAAIA,gBAEA,MAAM,IAAIE,MAAM,qFAUpB,SAASC,iBAAiBC,aAAcC,yBACpC,IAAKD,aACD,OAAO,KAGX,MAAME,IAAMC,KAAKD,MAEjB,SAASE,eAAeC,UAAWC,eAC/B,OACID,WACAA,UAAYH,OACVI,eAAiBA,eAAiBJ,KAK5C,GAAIF,aAAaO,KAAM,CACnB,MAAMF,UAAYL,aAAaO,KAAKF,UAC9BC,cAAiBL,yBAA2BA,wBAAwBM,KACpEN,wBAAwBM,KAAKF,UAC7B,KAEN,GAAID,eAAeC,UAAWC,eAC1B,OAAON,aAAaO,KAAKC,MAAQC,SAASC,OAAOC,cAKzD,GAAIX,aAAaA,aACb,IAAK,MAAMY,OAAOZ,aAAaA,aAAc,CACzC,MAAMa,YAAcb,aAAaA,aAAaY,KAC9C,IAAKC,YACD,SAGJ,MAAMR,UAAYQ,YAAYR,UACxBC,cAAiBL,yBACnBA,wBAAwBD,cACxBC,wBAAwBD,aAAaY,KACnCX,wBAAwBD,aAAaY,KAAKP,UAC1C,KAEN,GAAID,eAAeC,UAAWC,eAC1B,OAAOM,IAKnB,OAAO,KAUX,SAASE,wBAAwBC,QAASC,MACtC,IAAKA,OAASD,QACV,OAAO,EAEX,IAAMC,MAAQD,UAAcA,SAAWC,KACnC,OAAO,EAEX,IAAMA,KAAKhB,cAAgBe,QAAQf,eAAmBe,QAAQf,cAAgBgB,KAAKhB,aAC/E,OAAO,EAIX,MAAMiB,eAAiBF,QAAQR,MAAQQ,QAAQR,KAAKW,eAC9CC,YAAcH,KAAKT,MAAQS,KAAKT,KAAKW,eAErCE,oBAAsBL,QAAQR,MAAQQ,QAAQR,KAAKc,aACnDC,iBAAmBN,KAAKT,MAAQS,KAAKT,KAAKc,aAChD,GAAID,sBAAwBE,kBAAoBL,iBAAmBE,YAC/D,OAAO,EAIX,MAAMI,gBAAkBR,QAAQR,MAAQQ,QAAQR,KAAKC,KAC/CgB,aAAeR,KAAKT,MAAQS,KAAKT,KAAKC,KAC5C,GAAIe,kBAAoBC,aACpB,OAAO,EAIX,GAAIT,QAAQf,cAAgBgB,KAAKhB,aAC7B,IAAK,MAAMY,OAAOa,OAAOC,KAAKX,QAAQf,cAAe,CACjD,MAAM2B,iBAAmBZ,QAAQf,aAAaY,MAAQG,QAAQf,aAAaY,KAAKgB,UAC1EC,cAAgBb,KAAKhB,aAAaY,MAAQI,KAAKhB,aAAaY,KAAKgB,UACvE,GAAID,mBAAqBE,cACrB,OAAO,EAKnB,OAAO,EAGXjC,gBAAgBkC,WAAa,CACzB/B,iBAAAA,iBACAe,wBAAAA,yBAGDiB,QAAQC,eACPtC,QAAQK,iBAAmBA,iBAC3BL,QAAQoB,wBAA0BA","sourcesContent":["/*\n * GNU AGPL-3.0 License\n *\n * Copyright (c) 2021 - present core.ai . All rights reserved.\n *\n * This program is free software: you can redistribute it and/or modify it under\n * the terms of the GNU Affero General Public License as published by the Free\n * Software Foundation, either version 3 of the License, or (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n * See the GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see https://opensource.org/licenses/AGPL-3.0.\n *\n */\n\n/**\n * Login Service Utilities\n *\n * This module contains utility functions for login service operations,\n * including entitlements expiration checking and change detection.\n */\n\ndefine(function (require, exports, module) {\n\n    const KernalModeTrust = window.KernalModeTrust;\n    if(!KernalModeTrust){\n        // integrated extensions will have access to kernal mode, but not external extensions\n        throw new Error(\"Login utils should have access to KernalModeTrust. Cannot boot without trust ring\");\n    }\n\n    /**\n     * Check if any validTill time has expired\n     *\n     * @param {Object|null} entitlements - Current entitlements object\n     * @param {Object|null} lastRecordedEntitlement - Previously recorded entitlements\n     * @returns {string|null} - Name of expired plan/entitlement or null if none expired\n     */\n    function validTillExpired(entitlements, lastRecordedEntitlement) {\n        if (!entitlements) {\n            return null;\n        }\n\n        const now = Date.now();\n\n        function isNewlyExpired(validTill, lastValidTill) {\n            return (\n                validTill &&\n                validTill < now &&                      // expired now\n                (!lastValidTill || lastValidTill >= now) // but wasn't expired before\n            );\n        }\n\n        // Check plan validTill\n        if (entitlements.plan) {\n            const validTill = entitlements.plan.validTill;\n            const lastValidTill = (lastRecordedEntitlement && lastRecordedEntitlement.plan)\n                ? lastRecordedEntitlement.plan.validTill\n                : null;\n\n            if (isNewlyExpired(validTill, lastValidTill)) {\n                return entitlements.plan.name || brackets.config.main_pro_plan;\n            }\n        }\n\n        // Check entitlements validTill\n        if (entitlements.entitlements) {\n            for (const key in entitlements.entitlements) {\n                const entitlement = entitlements.entitlements[key];\n                if (!entitlement) {\n                    continue;\n                }\n\n                const validTill = entitlement.validTill;\n                const lastValidTill = (lastRecordedEntitlement &&\n                    lastRecordedEntitlement.entitlements &&\n                    lastRecordedEntitlement.entitlements[key])\n                    ? lastRecordedEntitlement.entitlements[key].validTill\n                    : null;\n\n                if (isNewlyExpired(validTill, lastValidTill)) {\n                    return key;\n                }\n            }\n        }\n\n        return null;\n    }\n\n    /**\n     * Check if entitlements have changed from last recorded state\n     *\n     * @param {Object|null} current - Current entitlements object\n     * @param {Object|null} last - Last recorded entitlements object\n     * @returns {boolean} - True if entitlements have changed, false otherwise\n     */\n    function haveEntitlementsChanged(current, last) {\n        if (!last && !current) {\n            return false;\n        }\n        if ((!last && current) || (!current && last)) {\n            return true;\n        }\n        if ((!last.entitlements && current.entitlements) || (!current.entitlements && last.entitlements)) {\n            return true;\n        }\n\n        // Check paidSubscriber changes\n        const currentPaidSub = current.plan && current.plan.paidSubscriber;\n        const lastPaidSub = last.plan && last.plan.paidSubscriber;\n        // Check isSubscriber changes\n        const currentIsSubscriber = current.plan && current.plan.isSubscriber;\n        const lastIsSubscriber = last.plan && last.plan.isSubscriber;\n        if (currentIsSubscriber !== lastIsSubscriber || currentPaidSub !== lastPaidSub) {\n            return true;\n        }\n\n        // Check plan name changes\n        const currentPlanName = current.plan && current.plan.name;\n        const lastPlanName = last.plan && last.plan.name;\n        if (currentPlanName !== lastPlanName) {\n            return true;\n        }\n\n        // Check entitlement activations\n        if (current.entitlements && last.entitlements) {\n            for (const key of Object.keys(current.entitlements)) {\n                const currentActivated = current.entitlements[key] && current.entitlements[key].activated;\n                const lastActivated = last.entitlements[key] && last.entitlements[key].activated;\n                if (currentActivated !== lastActivated) {\n                    return true;\n                }\n            }\n        }\n\n        return false;\n    }\n\n    KernalModeTrust.LoginUtils = {\n        validTillExpired,\n        haveEntitlementsChanged\n    };\n    // Test only Export functions\n    if(Phoenix.isTestWindow) {\n        exports.validTillExpired = validTillExpired;\n        exports.haveEntitlementsChanged = haveEntitlementsChanged;\n    }\n});\n"],"file":"login-utils.js"}