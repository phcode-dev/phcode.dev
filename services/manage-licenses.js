define(function(require,exports,module){const KernalModeTrust=window.KernalModeTrust;if(!KernalModeTrust)throw new Error("manage-licenses should have access to KernalModeTrust. Cannot boot without trust ring");const Strings=require("strings"),Dialogs=require("widgets/Dialogs"),Mustache=require("thirdparty/mustache/mustache"),licenseManagementHTML=require("text!./html/license-management.html");let fetchFn=window.fetch;function _getAPIBaseURL(){return"localhost"===location.hostname||"127.0.0.1"===location.hostname?"/proxy/accounts":Phoenix.config.account_url.replace(/\/$/,"")}async function _validateDeviceLicense(deviceLicenseKey){const apiURL=`${_getAPIBaseURL()}/validateDeviceLicense`;try{const response=await fetchFn(apiURL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deviceLicenseKey:deviceLicenseKey})});if(!response.ok)throw new Error(`HTTP ${response.status}: ${response.statusText}`);return await response.json()}catch(error){throw console.error("Error validating device license:",error),error}}async function _registerDevice(licenseKey,deviceLicenseKey,platform,deviceLabel){const apiURL=`${_getAPIBaseURL()}/registerDevice`;try{const response=await fetchFn(apiURL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({licenseKey:licenseKey,deviceLicenseKey:deviceLicenseKey,platform:platform,deviceLabel:deviceLabel})}),result=await response.json();if(!response.ok)throw new Error(result.errorMessage||`HTTP ${response.status}: ${response.statusText}`);return result}catch(error){throw console.error("Error registering device:",error),error}}function _formatDate(timestamp){if(!timestamp)return Strings.LICENSE_VALID_NEVER;const date=new Date(timestamp);return date.toLocaleDateString(Phoenix.getLocale(),{year:"numeric",month:"long",day:"numeric"})}async function _updateLicenseStatusDisplay($dialog,licenseData){const $loading=$dialog.find("#license-status-loading"),$none=$dialog.find("#license-status-none"),$valid=$dialog.find("#license-status-valid"),$error=$dialog.find("#license-status-error"),$reapplyContainer=$dialog.find("#reapply-license-container");if($loading.hide(),$none.hide(),$valid.hide(),$error.hide(),$reapplyContainer.hide(),licenseData&&licenseData.isValid){$dialog.find("#licensed-to-name").text(licenseData.licensedToName||Strings.LICENSE_STATUS_UNKNOWN),$dialog.find("#license-type-name").text(licenseData.licenseTypeName||Strings.LICENSE_STATUS_UNKNOWN),$dialog.find("#license-valid-till").text(_formatDate(licenseData.validTill)),$valid.show();const isLicensed=await KernalModeTrust.loginService.isLicensedDeviceSystemWide();isLicensed||$reapplyContainer.show()}else licenseData&&!1===licenseData.isValid?$none.show():($dialog.find("#license-error-message").text(Strings.LICENSE_STATUS_ERROR_CHECK),$error.show())}function _showActivationMessage($dialog,isSuccess,message){const $messageDiv=$dialog.find("#activation-message"),$messageText=$dialog.find("#activation-message-text");$messageText.text(message),$messageDiv.removeClass("success error"),isSuccess?$messageDiv.addClass("success"):$messageDiv.addClass("error"),$messageDiv.show(),setTimeout(()=>{$messageDiv.fadeOut()},5e3)}async function _loadLicenseStatus($dialog){try{const deviceID=await KernalModeTrust.loginService.getDeviceID();if(!deviceID)return void _updateLicenseStatusDisplay($dialog,{isValid:!1});const licenseData=await _validateDeviceLicense(deviceID);_updateLicenseStatusDisplay($dialog,licenseData)}catch(error){console.error("Error loading license status:",error),_updateLicenseStatusDisplay($dialog,null)}}async function _handleLicenseActivation($dialog,licenseKey){const $btn=$dialog.find("#activate-license-btn"),$btnText=$btn.find(".btn-text"),$btnSpinner=$btn.find(".btn-spinner");try{$btn.prop("disabled",!0),$btnText.hide(),$btnSpinner.show();const deviceID=await KernalModeTrust.loginService.getDeviceID();if(!deviceID)throw new Error("Unable to get device ID. Device licenses are only supported on desktop applications.");const platform=Phoenix.platform||"unknown",deviceLabel=`Phoenix Code - ${platform}`,result=await _registerDevice(licenseKey,deviceID,platform,deviceLabel);if(result.isSuccess){const addSuccess=await KernalModeTrust.loginService.addDeviceLicense(),successString=addSuccess?Strings.LICENSE_ACTIVATE_SUCCESS:Strings.LICENSE_ACTIVATE_SUCCESS_PARTIAL;_showActivationMessage($dialog,!0,successString),$dialog.find("#license-key-input").val(""),await _loadLicenseStatus($dialog)}else _showActivationMessage($dialog,!1,result.errorMessage||Strings.LICENSE_ACTIVATE_FAIL)}catch(error){_showActivationMessage($dialog,!1,error.message||Strings.LICENSE_ACTIVATE_FAIL)}finally{$btn.prop("disabled",!1),$btnText.show(),$btnSpinner.hide()}}async function _handleReapplyLicense($dialog){const $link=$dialog.find("#reapply-license-link"),originalText=$link.html();try{$link.html('<i class="fa fa-spinner fa-spin" style="margin-right: 6px;"></i>Applying...'),$link.css("pointer-events","none");const addSuccess=await KernalModeTrust.loginService.addDeviceLicense();addSuccess?(_showActivationMessage($dialog,!0,Strings.LICENSE_ACTIVATE_SUCCESS),await _loadLicenseStatus($dialog)):_showActivationMessage($dialog,!1,Strings.LICENSE_ACTIVATE_FAIL_APPLY)}catch(error){_showActivationMessage($dialog,!1,Strings.LICENSE_ACTIVATE_FAIL_APPLY)}finally{$link.html(originalText),$link.css("pointer-events","auto")}}async function showManageLicensesDialog(){const $template=$(Mustache.render(licenseManagementHTML,{Strings:Strings}));Dialogs.showModalDialogUsingTemplate($template);const $dialog=$template,$licenseInput=$dialog.find("#license-key-input"),$activateBtn=$dialog.find("#activate-license-btn"),$reapplyLink=$dialog.find("#reapply-license-link");$activateBtn.on("click",async function(){const licenseKey=$licenseInput.val().trim();licenseKey?await _handleLicenseActivation($dialog,licenseKey):_showActivationMessage($dialog,!1,Strings.LICENSE_ENTER_KEY)}),$licenseInput.on("keypress",function(e){13===e.which&&$activateBtn.click()}),$reapplyLink.on("click",async function(e){e.preventDefault(),await _handleReapplyLicense($dialog)}),await _loadLicenseStatus($dialog)}exports.showManageLicensesDialog=showManageLicensesDialog});
//# sourceMappingURL=manage-licenses.js.map
