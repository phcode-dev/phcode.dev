define(function(require,exports,module){const KernalModeTrust=window.KernalModeTrust;if(!KernalModeTrust)throw new Error("Login service should have access to KernalModeTrust. Cannot boot without trust ring");const EventDispatcher=require("utils/EventDispatcher"),AIControl=require("./ai-control"),UserNotifications=require("./UserNotifications"),Strings=require("strings"),StringUtils=require("utils/StringUtils"),MS_IN_DAY=864e5,FREE_PLAN_VALIDITY_DAYS=1e4;let LoginService;const EntitlementsManager={};EventDispatcher.makeEventDispatcher(EntitlementsManager),KernalModeTrust.EntitlementsManager=EntitlementsManager;const EVENT_ENTITLEMENTS_CHANGED="entitlements_changed";function isLoggedIn(){return LoginService.isLoggedIn()}function loginToAccount(){isLoggedIn()||KernalModeTrust.loginService.signInToAccount().catch(function(err){console.error("Error signing in to account",err)})}let effectiveEntitlementsCached=void 0;async function _getEffectiveEntitlements(){if(void 0!==effectiveEntitlementsCached)return effectiveEntitlementsCached;const entitlements=await LoginService.getEffectiveEntitlements();return effectiveEntitlementsCached=entitlements,entitlements}async function getPlanDetails(){const entitlements=await _getEffectiveEntitlements();if(entitlements&&entitlements.plan)return entitlements.plan;const currentDate=Date.now();return{isSubscriber:!1,paidSubscriber:!1,name:Strings.USER_FREE_PLAN_NAME_DO_NOT_TRANSLATE,validTill:currentDate+FREE_PLAN_VALIDITY_DAYS*MS_IN_DAY}}async function isPaidSubscriber(){if(!LoginService.isLoggedIn())return!1;const planDetails=await getPlanDetails();return!!planDetails.paidSubscriber}async function isInProTrial(){const entitlements=await _getEffectiveEntitlements();return!(!entitlements||!entitlements.isInProTrial)}async function getTrialRemainingDays(){const entitlements=await _getEffectiveEntitlements();return entitlements&&entitlements.trialDaysRemaining?entitlements.trialDaysRemaining:0}async function getRawEntitlements(){return await LoginService.getEntitlements()}async function getNotifications(){const entitlements=await _getEffectiveEntitlements();return entitlements&&entitlements.notifications?entitlements.notifications:[]}async function getLiveEditEntitlement(){const entitlements=await _getEffectiveEntitlements();return entitlements&&entitlements.entitlements&&entitlements.entitlements.liveEdit?entitlements.entitlements.liveEdit:{activated:!1,subscribeURL:brackets.config.purchase_url,upgradeToPlan:brackets.config.main_pro_plan}}async function getAIEntitlement(){if(!isLoggedIn())return{needsLogin:!0,activated:!1,upsellDialog:{title:Strings.AI_LOGIN_DIALOG_TITLE,message:Strings.AI_LOGIN_DIALOG_MESSAGE}};const aiControlStatus=await EntitlementsManager.getAIControlStatus();if(!aiControlStatus.aiEnabled)return{activated:!1,upsellDialog:{title:Strings.AI_DISABLED_DIALOG_TITLE,message:aiControlStatus.message||Strings.AI_CONTROL_ADMIN_DISABLED}};const defaultAIBrandName=brackets.config.ai_brand_name,defaultPurchaseURL=brackets.config.purchase_url,defaultUpsellTitle=StringUtils.format(Strings.AI_UPSELL_DIALOG_TITLE,defaultAIBrandName),defaultUpsellMessage=StringUtils.format(Strings.AI_UPSELL_DIALOG_MESSAGE,defaultAIBrandName),entitlements=await _getEffectiveEntitlements();if(!entitlements||!entitlements.entitlements||!entitlements.entitlements.aiAgent)return{activated:!1,aiBrandName:defaultAIBrandName,buyURL:defaultPurchaseURL,upgradeToPlan:defaultAIBrandName,upsellDialog:{title:defaultUpsellTitle,message:defaultUpsellMessage,buyURL:defaultPurchaseURL}};const aiEntitlement=entitlements.entitlements.aiAgent;if(aiEntitlement.activated)return{activated:!0,aiBrandName:aiEntitlement.aiBrandName,buyURL:aiEntitlement.subscribeURL,upgradeToPlan:aiEntitlement.upgradeToPlan,validTill:aiEntitlement.validTill};const upsellTitle=StringUtils.format(Strings.AI_UPSELL_DIALOG_TITLE,aiEntitlement.aiBrandName||defaultAIBrandName),upsellMessage=StringUtils.format(Strings.AI_UPSELL_DIALOG_MESSAGE,aiEntitlement.aiBrandName||defaultAIBrandName),upsellDialog=aiEntitlement.upsellDialog||{};return{activated:!1,aiBrandName:aiEntitlement.aiBrandName,buyURL:aiEntitlement.subscribeURL||defaultPurchaseURL,upgradeToPlan:aiEntitlement.upgradeToPlan,validTill:aiEntitlement.validTill,upsellDialog:{title:upsellDialog.title||upsellTitle,message:upsellDialog.message||upsellMessage,buyURL:upsellDialog.buyURL||aiEntitlement.subscribeURL||defaultPurchaseURL}}}let inited=!1;function init(){inited||(inited=!0,(LoginService=KernalModeTrust.loginService).on(LoginService.EVENT_ENTITLEMENTS_CHANGED,function(){effectiveEntitlementsCached=void 0,EntitlementsManager.trigger(EVENT_ENTITLEMENTS_CHANGED)}),AIControl.init(),UserNotifications.init())}Phoenix.isTestWindow&&(window._test_entitlements_exports={EntitlementsService:EntitlementsManager,isLoggedIn:isLoggedIn,getPlanDetails:getPlanDetails,isPaidSubscriber:isPaidSubscriber,isInProTrial:isInProTrial,getTrialRemainingDays:getTrialRemainingDays,getRawEntitlements:getRawEntitlements,getNotifications:getNotifications,getLiveEditEntitlement:getLiveEditEntitlement,loginToAccount:loginToAccount}),exports.init=init,EntitlementsManager.isLoggedIn=isLoggedIn,EntitlementsManager.loginToAccount=loginToAccount,EntitlementsManager.getPlanDetails=getPlanDetails,EntitlementsManager.isPaidSubscriber=isPaidSubscriber,EntitlementsManager.isInProTrial=isInProTrial,EntitlementsManager.getTrialRemainingDays=getTrialRemainingDays,EntitlementsManager.getRawEntitlements=getRawEntitlements,EntitlementsManager.getNotifications=getNotifications,EntitlementsManager.getLiveEditEntitlement=getLiveEditEntitlement,EntitlementsManager.getAIEntitlement=getAIEntitlement,EntitlementsManager.EVENT_ENTITLEMENTS_CHANGED=EVENT_ENTITLEMENTS_CHANGED});
//# sourceMappingURL=EntitlementsManager.js.map
