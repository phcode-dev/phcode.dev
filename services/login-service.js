define(function(require,exports,module){require("./setup-login-service"),require("./promotions"),require("./login-utils");const NodeUtils=require("utils/NodeUtils"),PreferencesManager=require("preferences/PreferencesManager"),Commands=require("command/Commands"),CommandManager=require("command/CommandManager"),EntitlementsDirectImport=require("./EntitlementsManager"),Metrics=require("utils/Metrics"),Strings=require("strings"),PREF_STATE_LICENSED_DEVICE_CHECK="LICENSED_DEVICE_CHECK";PreferencesManager.stateManager.definePreference(PREF_STATE_LICENSED_DEVICE_CHECK,"boolean",!1);const MS_IN_DAY=864e6,TEN_MINUTES=6e5,FREE_PLAN_VALIDITY_DAYS=1e4,FALLBACK_SALT="fallback-salt-2f309322-b32d-4d59-85b4-2baef666a9f4";let currentSalt;const CACHED_ENTITLEMENTS_FILE=path.join(Phoenix.app.getApplicationSupportDirectory(),"cached_entitlements.json");let fetchFn=window.fetch,dateNowFn=Date.now;const KernalModeTrust=window.KernalModeTrust;if(!KernalModeTrust)throw new Error("Login service should have access to KernalModeTrust. Cannot boot without trust ring");const LoginService=KernalModeTrust.loginService,EVENT_ENTITLEMENTS_CHANGED="entitlements_changed";let cachedEntitlements=void 0,lastRecordedState=null,entitlementsChangedTimer=null;const ENTITLEMENT_CHANGED_DEBOUNCE_WINDOW=Phoenix.isTestWindow?100:1e3;function _debounceEntitlementsChanged(){entitlementsChangedTimer||(entitlementsChangedTimer=setTimeout(()=>{LoginService.trigger(EVENT_ENTITLEMENTS_CHANGED),entitlementsChangedTimer=null},ENTITLEMENT_CHANGED_DEBOUNCE_WINDOW))}async function getSalt(){if(currentSalt)return currentSalt;try{if(Phoenix.isNativeApp){let salt=await KernalModeTrust.getCredential(KernalModeTrust.SIGNATURE_SALT_KEY);return salt||(salt=crypto.randomUUID(),await KernalModeTrust.setCredential(KernalModeTrust.SIGNATURE_SALT_KEY,salt)),currentSalt=salt,salt}return currentSalt=FALLBACK_SALT,FALLBACK_SALT}catch(error){return console.error("Error getting signature salt:",error),Metrics.countEvent(Metrics.EVENT_TYPE.AUTH,"saltGet","Err"),currentSalt=FALLBACK_SALT,FALLBACK_SALT}}async function _loadCachedEntitlements(){if(!Phoenix.isNativeApp)return null;try{const fileData=await Phoenix.VFS.readFileResolves(CACHED_ENTITLEMENTS_FILE,"utf8");if(fileData.error||!fileData.data)return null;const cachedData=JSON.parse(fileData.data);if(!cachedData.jsonData||!cachedData.sign)return console.warn("Invalid cached entitlements format - missing jsonData or sign"),await _clearCachedEntitlements(),null;const salt=await getSalt(),isValidSignature=await KernalModeTrust.validateDataSignature(cachedData.jsonData,cachedData.sign,salt);return isValidSignature?JSON.parse(cachedData.jsonData):(console.warn("Cached entitlements signature validation failed - possible tampering detected"),Metrics.countEvent(Metrics.EVENT_TYPE.PRO,"entCacheLD","signInvalid"),await _clearCachedEntitlements(),null)}catch(error){return console.error("Error loading cached entitlements:",error),Metrics.countEvent(Metrics.EVENT_TYPE.PRO,"entCacheLD","error"),await _clearCachedEntitlements(),null}}async function _saveCachedEntitlements(entitlements){if(Phoenix.isNativeApp&&entitlements)try{const jsonData=JSON.stringify(entitlements),salt=await getSalt(),signature=await KernalModeTrust.generateDataSignature(jsonData,salt),cacheData={jsonData:jsonData,sign:signature};await Phoenix.VFS.writeFileAsync(CACHED_ENTITLEMENTS_FILE,JSON.stringify(cacheData),"utf8"),console.log("Entitlements cached successfully")}catch(error){Metrics.countEvent(Metrics.EVENT_TYPE.PRO,"entCacheSave","err"),console.error("Error saving cached entitlements:",error)}}async function _clearCachedEntitlements(){if(Phoenix.isNativeApp)try{await Phoenix.VFS.unlinkResolves(CACHED_ENTITLEMENTS_FILE),console.log("Cached entitlements cleared")}catch(error){console.log("Error clearing cached entitlements:",error)}}let deviceIDCached=void 0;async function getDeviceID(){if(!Phoenix.isNativeApp)return null;if(void 0!==deviceIDCached)return deviceIDCached;try{const deviceID=await NodeUtils.getDeviceID();if(!deviceID)return deviceIDCached=null,Metrics.countEvent(Metrics.EVENT_TYPE.AUTH,"deviceID","nullErr"),null;deviceIDCached=KernalModeTrust.generateDataSignature(deviceID)}catch(e){logger.reportError(e,"failed to sign deviceID"),Metrics.countEvent(Metrics.EVENT_TYPE.AUTH,"deviceID","SignErr"),deviceIDCached=null}return deviceIDCached}let deviceLicensePrimed=!1,licencedDeviceCredsAvailable=!1;async function getEntitlements(forceRefresh=!1){if(deviceLicensePrimed||(deviceLicensePrimed=!0,licencedDeviceCredsAvailable=await isLicensedDevice()),!LoginService.isLoggedIn()&&!licencedDeviceCredsAvailable)return null;if(void 0!==cachedEntitlements&&!forceRefresh)return cachedEntitlements;if(cachedEntitlements&&!navigator.onLine)return cachedEntitlements;async function _processDiscCachedEntitlement(){const diskCachedEntitlements=await _loadCachedEntitlements();if(diskCachedEntitlements){console.log("offline/network/server error: Using cached entitlements from disk");const entitlementsChanged=JSON.stringify(cachedEntitlements)!==JSON.stringify(diskCachedEntitlements);return cachedEntitlements=diskCachedEntitlements,entitlementsChanged&&_debounceEntitlementsChanged(),cachedEntitlements}return null}try{const accountBaseURL=LoginService.getAccountBaseURL(),language=brackets.getLocale(),currentVersion=window.AppConfig.apiVersion||"1.0.0";let url=`${accountBaseURL}/getAppEntitlements?lang=${language}&version=${currentVersion}`+`&platform=${Phoenix.platform}&appType=${Phoenix.isNativeApp?"desktop":"browser"}`;licencedDeviceCredsAvailable&&(url+=`&deviceID=${await getDeviceID()}`);let fetchOptions={method:"GET",headers:{Accept:"application/json"}};if(Phoenix.isNativeApp){const profile=LoginService.getProfile();if(profile&&profile.apiKey&&profile.validationCode)url+=`&appSessionID=${encodeURIComponent(profile.apiKey)}&validationCode=${encodeURIComponent(profile.validationCode)}`;else if(!licencedDeviceCredsAvailable)return console.error("Missing appSessionID or validationCode for desktop app entitlements"),null}else fetchOptions.credentials="include";if(Phoenix.isNativeApp&&!navigator.onLine){const processedEntitlement=await _processDiscCachedEntitlement();if(processedEntitlement)return processedEntitlement}const response=await fetchFn(url,fetchOptions);if(response.ok){const result=await response.json();if(result.isSuccess){const entitlementsChanged=JSON.stringify(cachedEntitlements)!==JSON.stringify(result);return cachedEntitlements=result,Phoenix.isNativeApp&&await _saveCachedEntitlements(result),entitlementsChanged&&_debounceEntitlementsChanged(),cachedEntitlements}}else if(response.status>=500&&response.status<600){if(Phoenix.isNativeApp){console.warn("Fetch entitlements server error:",response.status);const processedEntitlement=await _processDiscCachedEntitlement();if(processedEntitlement)return processedEntitlement}}else Phoenix.isNativeApp&&(console.warn("Cearing entitlements, entitlements server error:",response.status),await _clearCachedEntitlements())}catch(error){if(console.error("Failed to fetch entitlements:",error),Phoenix.isNativeApp){const processedEntitlement=await _processDiscCachedEntitlement();if(processedEntitlement)return processedEntitlement}}return null}async function clearEntitlements(){cachedEntitlements&&(cachedEntitlements=void 0,_debounceEntitlementsChanged()),deviceLicensePrimed=!1}function startEffectiveEntitlementsMonitor(){Phoenix.isTestWindow||(setTimeout(async function(){lastRecordedState=await getEffectiveEntitlements(!1)},3e4),setInterval(async()=>{try{const freshEntitlements=await getEffectiveEntitlements(!0),expiredPlanName=KernalModeTrust.LoginUtils.validTillExpired(freshEntitlements,lastRecordedState),hasChanged=KernalModeTrust.LoginUtils.haveEntitlementsChanged(freshEntitlements,lastRecordedState);(expiredPlanName||hasChanged)&&(console.log(`Entitlements monitor detected changes, Expired: ${expiredPlanName},`+`changed: ${hasChanged} refreshing...`),Metrics.countEvent(Metrics.EVENT_TYPE.PRO,"entRefresh",expiredPlanName?"exp_"+expiredPlanName:"changed"),_debounceEntitlementsChanged()),lastRecordedState=freshEntitlements}catch(error){console.error("Entitlements monitor error:",error)}},TEN_MINUTES),console.log("Entitlements monitor started (10-minute interval)"))}function _validateAndFilterEntitlements(entitlements){if(!entitlements)return;const currentDate=dateNowFn();entitlements.plan&&(!entitlements.plan.validTill||currentDate>entitlements.plan.validTill)&&(entitlements.plan={...entitlements.plan,isSubscriber:!1,paidSubscriber:!1,name:Strings.USER_FREE_PLAN_NAME_DO_NOT_TRANSLATE,fullName:Strings.USER_FREE_PLAN_NAME_DO_NOT_TRANSLATE,validTill:currentDate+FREE_PLAN_VALIDITY_DAYS*MS_IN_DAY});const featureEntitlements=entitlements.entitlements;if(featureEntitlements)for(const featureName in featureEntitlements){const feature=featureEntitlements[featureName];feature&&(!feature.validTill||currentDate>feature.validTill)&&(feature.activated=!1,feature.upgradeToPlan=feature.upgradeToPlan||brackets.config.main_pro_plan,feature.subscribeURL=feature.subscribeURL||brackets.config.purchase_url,feature.validTill=feature.validTill||currentDate-MS_IN_DAY)}}async function getEffectiveEntitlements(forceRefresh=!1){const serverEntitlements=await getEntitlements(forceRefresh);_validateAndFilterEntitlements(serverEntitlements);const trialDaysRemaining=await LoginService.getProTrialDaysRemaining();return trialDaysRemaining<=0?serverEntitlements:serverEntitlements&&serverEntitlements.plan?serverEntitlements.plan.isSubscriber?serverEntitlements:{...serverEntitlements,plan:{...serverEntitlements.plan,isSubscriber:!0,paidSubscriber:serverEntitlements.plan.paidSubscriber||!1,name:brackets.config.main_pro_plan,fullName:brackets.config.main_pro_plan,validTill:dateNowFn()+trialDaysRemaining*MS_IN_DAY},isInProTrial:!0,trialDaysRemaining:trialDaysRemaining,entitlements:{...serverEntitlements.entitlements,liveEdit:{activated:!0,subscribeURL:brackets.config.purchase_url,upgradeToPlan:brackets.config.main_pro_plan,validTill:dateNowFn()+trialDaysRemaining*MS_IN_DAY}}}:{plan:{isSubscriber:!0,paidSubscriber:!1,name:brackets.config.main_pro_plan,fullName:brackets.config.main_pro_plan,validTill:dateNowFn()+trialDaysRemaining*MS_IN_DAY},isInProTrial:!0,trialDaysRemaining:trialDaysRemaining,entitlements:{liveEdit:{activated:!0,subscribeURL:brackets.config.purchase_url,upgradeToPlan:brackets.config.main_pro_plan,validTill:dateNowFn()+trialDaysRemaining*MS_IN_DAY}}}}async function addDeviceLicense(){return deviceLicensePrimed=!1,PreferencesManager.stateManager.set(PREF_STATE_LICENSED_DEVICE_CHECK,!0),NodeUtils.addDeviceLicenseSystemWide()}async function removeDeviceLicense(){return deviceLicensePrimed=!1,PreferencesManager.stateManager.set(PREF_STATE_LICENSED_DEVICE_CHECK,!1),NodeUtils.removeDeviceLicenseSystemWide()}async function isLicensedDeviceSystemWide(){return NodeUtils.isLicensedDeviceSystemWide()}let _isLicensedDeviceFlagForTest=!1;async function isLicensedDevice(){if(Phoenix.isTestWindow)return _isLicensedDeviceFlagForTest;if(!Phoenix.isNativeApp)return!1;const userCheck=PreferencesManager.stateManager.get(PREF_STATE_LICENSED_DEVICE_CHECK),systemCheck=await isLicensedDeviceSystemWide();return userCheck||systemCheck}async function handleReinstallCreds(){if(!Phoenix.isNativeApp)throw new Error("Reinstall credentials is only available in native apps");try{await KernalModeTrust.reinstallCreds(),console.log("Credentials reinstalled successfully")}catch(error){throw console.error("Error reinstalling credentials:",error),error}}LoginService.getEntitlements=getEntitlements,LoginService.getEffectiveEntitlements=getEffectiveEntitlements,LoginService.clearEntitlements=clearEntitlements,LoginService.getSalt=getSalt,LoginService.addDeviceLicense=addDeviceLicense,LoginService.removeDeviceLicense=removeDeviceLicense,LoginService.isLicensedDevice=isLicensedDevice,LoginService.isLicensedDeviceSystemWide=isLicensedDeviceSystemWide,LoginService.getDeviceID=getDeviceID,LoginService.EVENT_ENTITLEMENTS_CHANGED=EVENT_ENTITLEMENTS_CHANGED;let inited=!1;function init(){inited||(inited=!0,EntitlementsDirectImport.init(),Phoenix.isNativeApp&&CommandManager.register("Reinstall Credentials",Commands.REINSTALL_CREDS,handleReinstallCreds))}Phoenix.isTestWindow&&(window._test_login_service_exports={LoginService:LoginService,setIsLicensedDevice:function(_isLicensedDevice){_isLicensedDeviceFlagForTest=_isLicensedDevice},setFetchFn:function(fn){fetchFn=fn},setDateNowFn:function(fn){dateNowFn=fn},_validateAndFilterEntitlements:_validateAndFilterEntitlements}),startEffectiveEntitlementsMonitor(),exports.init=init});
//# sourceMappingURL=login-service.js.map
