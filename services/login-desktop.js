define(function(require,exports,module){const LoginServiceDirectImport=require("./login-service"),EventDispatcher=require("utils/EventDispatcher"),PreferencesManager=require("preferences/PreferencesManager"),Metrics=require("utils/Metrics"),Dialogs=require("widgets/Dialogs"),DefaultDialogs=require("widgets/DefaultDialogs"),Strings=require("strings"),NativeApp=require("utils/NativeApp"),ProfileMenu=require("./profile-menu"),Mustache=require("thirdparty/mustache/mustache"),NodeConnector=require("NodeConnector"),otpDialogTemplate=require("text!./html/otp-dialog.html"),KernalModeTrust=window.KernalModeTrust;if(!KernalModeTrust)throw new Error("Login service should have access to KernalModeTrust. Cannot boot without trust ring");const LoginService=KernalModeTrust.loginService;let userProfile=null,isLoggedInUser=!1,fetchFn=window.fetch;const PREF_USER_PROFILE_VERSION="userProfileVersion",_EVT_PAGE_FOCUSED="page_focused",focusWatcher={};EventDispatcher.makeEventDispatcher(focusWatcher),$(window).focus(function(){focusWatcher.trigger(_EVT_PAGE_FOCUSED)});const AUTH_CONNECTOR_ID="ph_auth",EVENT_CONNECTED="connected";let authNodeConnector;function isLoggedIn(){return isLoggedInUser}function getProfile(){return userProfile}function getAccountBaseURL(){return"localhost"===location.hostname||"127.0.0.1"===location.hostname?"/proxy/accounts":Phoenix.config.account_url.replace(/\/$/,"")}function _getAccountWebURL(){return Phoenix.config.account_url}Phoenix.isNativeApp&&(authNodeConnector=NodeConnector.createNodeConnector("ph_auth",exports));const ERR_RETRY_LATER="retry_later",ERR_INVALID="invalid";async function _resolveAPIKey(apiKey,validationCode){const resolveURL=`${getAccountBaseURL()}/resolveAppSessionID?appSessionID=${apiKey}&validationCode=${validationCode}`;if(!navigator.onLine)return{err:ERR_RETRY_LATER};try{if(Phoenix.isTestWindow&&fetchFn===fetch)return{err:ERR_INVALID};const response=await fetchFn(resolveURL);if(400===response.status||404===response.status)return{err:ERR_INVALID};if(response.ok){const userDetails=await response.json();return userDetails.apiKey=apiKey,userDetails.validationCode=validationCode,{userDetails:userDetails}}return console.log("Other error:",response.status),{err:ERR_RETRY_LATER}}catch(e){return console.error(e,"Failed to call resolve API endpoint",resolveURL),{err:ERR_RETRY_LATER}}}async function _resetAccountLogin(){isLoggedInUser=!1,ProfileMenu.setNotLoggedIn(),await KernalModeTrust.removeCredential(KernalModeTrust.CRED_KEY_API),PreferencesManager.stateManager.set(PREF_USER_PROFILE_VERSION,crypto.randomUUID())}async function _verifyLogin(silentCheck=!1){const savedUserProfile=await KernalModeTrust.getCredential(KernalModeTrust.CRED_KEY_API);if(!savedUserProfile)return console.log("No savedUserProfile found. Not logged in"),silentCheck||ProfileMenu.setNotLoggedIn(),void(isLoggedInUser=!1);try{userProfile=JSON.parse(savedUserProfile)}catch(e){return console.error(e,"Failed to parse saved user profile credentials"),void(silentCheck||ProfileMenu.setNotLoggedIn())}isLoggedInUser=!0,ProfileMenu.setLoggedIn(userProfile.profileIcon.initials,userProfile.profileIcon.color);const resolveResponse=await _resolveAPIKey(userProfile.apiKey,userProfile.validationCode);if(resolveResponse.userDetails)return userProfile=resolveResponse.userDetails,ProfileMenu.setLoggedIn(userProfile.profileIcon.initials,userProfile.profileIcon.color),void await KernalModeTrust.setCredential(KernalModeTrust.CRED_KEY_API,JSON.stringify(userProfile));resolveResponse.err===ERR_INVALID&&(_resetAccountLogin().catch(console.error),Dialogs.showModalDialog(DefaultDialogs.DIALOG_ID_ERROR,Strings.SIGNED_OUT,Strings.SIGNED_OUT_MESSAGE))}function _getAutoAuthPortURL(){const localAutoAuthURL=KernalModeTrust.localAutoAuthURL;return localAutoAuthURL?localAutoAuthURL.replace("http://localhost:",""):"9797/urlDoesntExist"}const PLATFORM_STRINGS={win:"Windows",mac:"mac",linux:"Linux"};async function _getAppAuthSession(){const authPortURL=_getAutoAuthPortURL(),platformStr=PLATFORM_STRINGS[Phoenix.platform]||Phoenix.platform,appName=encodeURIComponent(`${Strings.APP_NAME} Desktop on ${platformStr}`),resolveURL=`${getAccountBaseURL()}/getAppAuthSession?autoAuthPort=${authPortURL}&appName=${appName}`;try{if(Phoenix.isTestWindow&&fetchFn===fetch)return null;const response=await fetchFn(resolveURL);if(response.ok){const{appSessionID:appSessionID,validationCode:validationCode}=await response.json();if(!appSessionID||!validationCode)throw new Error("Invalid response from getAppAuthSession API endpoint"+resolveURL);return{appSessionID:appSessionID,validationCode:validationCode}}return null}catch(e){return console.error(e,"Failed to call getAppAuthSession API endpoint",resolveURL),Metrics.countEvent(Metrics.EVENT_TYPE.AUTH,"getAppAuth",Phoenix.platform),logger.reportError(e,"Failed to call getAppAuthSession API endpoint"+resolveURL),null}}async function setAutoVerificationCode(validationCode){const TIMEOUT_MS=1e3;try{await Promise.race([authNodeConnector.execPeer("setVerificationCode",validationCode),new Promise((_,reject)=>setTimeout(()=>reject(new Error("timeout")),1e3))])}catch(e){console.error("failed to send auth login verification code to node",e),Metrics.countEvent(Metrics.EVENT_TYPE.AUTH,"autoFail",Phoenix.platform)}}async function signInToAccount(){if(!navigator.onLine)return void Dialogs.showModalDialog(DefaultDialogs.DIALOG_ID_ERROR,Strings.SIGNED_IN_OFFLINE_TITLE,Strings.SIGNED_IN_OFFLINE_MESSAGE);const appAuthSession=await _getAppAuthSession();if(!appAuthSession)return void Dialogs.showModalDialog(DefaultDialogs.DIALOG_ID_ERROR,Strings.SIGNED_IN_FAILED_TITLE,Strings.SIGNED_IN_FAILED_MESSAGE);const{appSessionID:appSessionID,validationCode:validationCode}=appAuthSession;await setAutoVerificationCode(validationCode);const appSignInURL=`${_getAccountWebURL()}authorizeApp?appSessionID=${appSessionID}`,dialogData={validationCode:validationCode,Strings:Strings},$template=$(Mustache.render(otpDialogTemplate,dialogData)),dialog=Dialogs.showModalDialogUsingTemplate($template),closeTimeout=setTimeout(()=>{dialog.close()},3e5);$template.on("click",'[data-button-id="copy"]',function(){Phoenix.app.copyToClipboard(validationCode);const $validationCodeSpan=$template.find(".validation-code span"),originalText=$validationCodeSpan.text();$validationCodeSpan.text(Strings.VALIDATION_CODE_COPIED),setTimeout(()=>{$validationCodeSpan.text(originalText)},1500)}),$template.on("click",'[data-button-id="open"]',function(){NativeApp.openURLInDefaultBrowser(appSignInURL)}),$template.on("click",'[data-button-id="cancel"]',function(){dialog.close()}),$template.on("click",'[data-button-id="refresh"]',function(){checkLoginStatus()});let checking=!1,checkAgain=!1;async function checkLoginStatus(){if(checking)checkAgain=!0;else{checking=!0;try{const resolveResponse=await _resolveAPIKey(appSessionID,validationCode);resolveResponse.userDetails&&(userProfile=resolveResponse.userDetails,ProfileMenu.setLoggedIn(userProfile.profileIcon.initials,userProfile.profileIcon.color),await KernalModeTrust.setCredential(KernalModeTrust.CRED_KEY_API,JSON.stringify(userProfile)),PreferencesManager.stateManager.set(PREF_USER_PROFILE_VERSION,crypto.randomUUID()),checkAgain=!1,isLoggedInUser=!0,dialog.close())}catch(e){console.error("Failed to check login status.",e)}checking=!1,checkAgain&&(checkAgain=!1,setTimeout(checkLoginStatus,100))}}let isAutoSignedIn=!1;async function _AutoSignedIn(){isAutoSignedIn=!0,await checkLoginStatus()}focusWatcher.on(_EVT_PAGE_FOCUSED,checkLoginStatus),authNodeConnector.one(EVENT_CONNECTED,_AutoSignedIn),dialog.done(function(){focusWatcher.off(_EVT_PAGE_FOCUSED,checkLoginStatus),authNodeConnector.off(EVENT_CONNECTED,_AutoSignedIn),clearTimeout(closeTimeout),Metrics.countEvent(Metrics.EVENT_TYPE.AUTH,isAutoSignedIn?"autoLogin":"manLogin",Phoenix.platform),Metrics.countEvent(Metrics.EVENT_TYPE.AUTH,"dsktpLogin",isAutoSignedIn?"auto":"man")}),NativeApp.openURLInDefaultBrowser(appSignInURL)}async function signOutAccount(){const resolveURL=`${getAccountBaseURL()}/logoutSession`;try{let input={appSessionID:userProfile.apiKey};if(Phoenix.isTestWindow&&fetchFn===fetch)return;const response=await fetchFn(resolveURL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(input)}),result=await response.json();if(!result.isSuccess){console.error("Error logging out",result);const dialog=Dialogs.showModalDialog(DefaultDialogs.DIALOG_ID_ERROR,Strings.SIGNED_OUT_FAILED_TITLE,Strings.SIGNED_OUT_FAILED_MESSAGE);return dialog.done(()=>{NativeApp.openURLInDefaultBrowser(_getAccountWebURL()+"#advanced")}),void Metrics.countEvent(Metrics.EVENT_TYPE.AUTH,"logoutFail",Phoenix.platform)}await _resetAccountLogin(),await _verifyLogin(),Dialogs.showModalDialog(DefaultDialogs.DIALOG_ID_INFO,Strings.SIGNED_OUT,Strings.SIGNED_OUT_MESSAGE_FRIENDLY),Metrics.countEvent(Metrics.EVENT_TYPE.AUTH,"logoutOK",Phoenix.platform)}catch(error){console.error("Network error. Could not log out session.",error);const dialog=Dialogs.showModalDialog(DefaultDialogs.DIALOG_ID_ERROR,Strings.SIGNED_OUT_FAILED_TITLE,Strings.SIGNED_OUT_FAILED_MESSAGE);dialog.done(()=>{NativeApp.openURLInDefaultBrowser(_getAccountWebURL()+"#advanced")}),Metrics.countEvent(Metrics.EVENT_TYPE.AUTH,"getAppAuth",Phoenix.platform),logger.reportError(error,"Failed to call logout calling"+resolveURL)}}function init(){if(!Phoenix.isNativeApp)return void console.log("Desktop login service not needed for browser");ProfileMenu.init(),LoginServiceDirectImport.init(),_verifyLogin(!0).catch(console.error);const pref=PreferencesManager.stateManager.definePreference(PREF_USER_PROFILE_VERSION,"string","0");pref.watchExternalChanges(),pref.on("change",_verifyLogin)}Phoenix.isNativeApp&&(LoginService.isLoggedIn=isLoggedIn,LoginService.signInToAccount=signInToAccount,LoginService.signOutAccount=signOutAccount,LoginService.getProfile=getProfile,LoginService._verifyLoginStatus=(()=>_verifyLogin(!1)),LoginService.getAccountBaseURL=getAccountBaseURL,init()),Phoenix.isTestWindow&&(window._test_login_desktop_exports={setFetchFn:function _setFetchFn(fn){fetchFn=fn}}),exports.isLoggedIn=isLoggedIn});
//# sourceMappingURL=login-desktop.js.map
