define(function(require){var _=brackets.getModule("thirdparty/lodash"),DefaultDialogs=brackets.getModule("widgets/DefaultDialogs"),Dialogs=brackets.getModule("widgets/Dialogs"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),Metrics=brackets.getModule("utils/Metrics"),Strings=brackets.getModule("strings"),StringUtils=brackets.getModule("utils/StringUtils"),ErrorHandler=require("src/ErrorHandler"),Events=require("src/Events"),EventEmitter=require("src/EventEmitter"),Git=require("src/git/Git"),Preferences=require("src/Preferences"),ProgressDialog=require("src/dialogs/Progress"),PullDialog=require("src/dialogs/Pull"),PushDialog=require("src/dialogs/Push"),Utils=require("src/Utils"),gitRemotesPickerTemplate=require("text!templates/git-remotes-picker.html"),$selectedRemote=null,$remotesDropdown=null,$gitPanel=null,$gitPush=null;function initVariables(){$gitPanel=$("#git-panel"),$selectedRemote=$gitPanel.find(".git-selected-remote"),$remotesDropdown=$gitPanel.find(".git-remotes-dropdown"),$gitPush=$gitPanel.find(".git-push")}function getDefaultRemote(allRemotes){var defaultRemotes,candidate=(Preferences.get("defaultRemotes")||{})[Preferences.get("currentGitRoot")],exists;return _.find(allRemotes,function(remote){return remote.name===candidate})||(candidate=null,allRemotes.length>0&&(candidate=_.first(allRemotes).name)),candidate}function setDefaultRemote(remoteName){var defaultRemotes=Preferences.get("defaultRemotes")||{};defaultRemotes[Preferences.get("currentGitRoot")]=remoteName,Preferences.set("defaultRemotes",defaultRemotes)}function clearRemotePicker(){$selectedRemote.html("&mdash;").data("remote",null)}function selectRemote(remoteName,type){if(!remoteName)return clearRemotePicker();"git"===type&&setDefaultRemote(remoteName),$gitPanel.find(".git-pull").prop("disabled","git"!==type),$gitPush.prop("disabled",!1).attr("x-selected-remote-type",type),$selectedRemote.text(remoteName).attr("data-type",type).data("remote",remoteName)}function refreshRemotesPicker(){Git.getRemotes().then(function(remotes){var defaultRemoteName=getDefaultRemote(remotes);$gitPanel.find(".git-pull, .git-push, .git-fetch").prop("disabled",0===remotes.length),remotes.forEach(function(remote){remote.deletable="origin"!==remote.name});var compiledTemplate=Mustache.render(gitRemotesPickerTemplate,{Strings:Strings,remotes:remotes});$remotesDropdown.html(compiledTemplate),EventEmitter.emit(Events.REMOTES_REFRESH_PICKER),remotes.length>0?selectRemote(defaultRemoteName,"git"):clearRemotePicker()}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_GETTING_REMOTES)})}function handleRemoteCreation(){return Utils.askQuestion(Strings.CREATE_NEW_REMOTE,Strings.ENTER_REMOTE_NAME).then(function(name){return Utils.askQuestion(Strings.CREATE_NEW_REMOTE,Strings.ENTER_REMOTE_URL).then(function(url){return[name,url]})}).then(function([name,url]){return Git.createRemote(name,url).then(function(){return refreshRemotesPicker()})}).catch(function(err){ErrorHandler.equals(err,Strings.USER_ABORTED)||ErrorHandler.showError(err,Strings.ERROR_REMOTE_CREATION)})}function deleteRemote(remoteName){return Utils.askQuestion(Strings.DELETE_REMOTE,StringUtils.format(Strings.DELETE_REMOTE_NAME,remoteName),{booleanResponse:!0}).then(function(response){if(!0===response)return Git.deleteRemote(remoteName).then(function(){return refreshRemotesPicker()})}).catch(function(err){ErrorHandler.logError(err)})}function showPushResult(result){"string"==typeof result.remoteUrl&&(result.remoteUrl=Utils.encodeSensitiveInformation(result.remoteUrl));var template=["<h3>{{flagDescription}}</h3>","Info:","Remote url - {{remoteUrl}}","Local branch - {{from}}","Remote branch - {{to}}","Summary - {{summary}}","<h4>Status - {{status}}</h4>"].join("<br>");Dialogs.showModalDialog(DefaultDialogs.DIALOG_ID_INFO,Strings.GIT_PUSH_RESPONSE,Mustache.render(template,result))}function pushToRemote(remote){if(!remote)return ErrorHandler.showError(StringUtils.format(Strings.ERROR_NO_REMOTE_SELECTED,"push"));var pushConfig={remote:remote};PushDialog.show(pushConfig).then(function(pushConfig){var q=Promise.resolve(),additionalArgs=[];return pushConfig.tags&&additionalArgs.push("--tags"),pushConfig.noVerify&&additionalArgs.push("--no-verify"),pushConfig.branch&&pushConfig.setBranchAsTracking&&(q=q.then(function(){return Git.setUpstreamBranch(pushConfig.remote,pushConfig.branch)})),pushConfig.remoteUrlNew&&(q=q.then(function(){return Git.setRemoteUrl(pushConfig.remote,pushConfig.remoteUrlNew)})),q=q.then(function(){let op;const progressTracker=ProgressDialog.newProgressTracker();return pushConfig.pushToNew?op=Git.pushToNewUpstream(pushConfig.remote,pushConfig.branch,{noVerify:!0,progressTracker:progressTracker}):"DEFAULT"===pushConfig.strategy?op=Git.push(pushConfig.remote,pushConfig.branch,additionalArgs,progressTracker):"FORCED"===pushConfig.strategy?op=Git.pushForced(pushConfig.remote,pushConfig.branch,{noVerify:!0,progressTracker:progressTracker}):"DELETE_BRANCH"===pushConfig.strategy&&(op=Git.deleteRemoteBranch(pushConfig.remote,pushConfig.branch,{noVerify:!0,progressTracker:progressTracker})),ProgressDialog.show(op,progressTracker).then(function(result){return ProgressDialog.waitForClose().then(function(){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"push","success"),showPushResult(result)})}).catch(function(err){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"push","fail"),ErrorHandler.showError(err,Strings.ERROR_PUSHING_REMOTE,{errorMetric:"push"})})}),pushConfig.remoteUrlRestore&&(q=q.finally(function(){return Git.setRemoteUrl(pushConfig.remote,pushConfig.remoteUrlRestore)})),q.finally(function(){EventEmitter.emit(Events.REFRESH_ALL)})}).catch(function(err){err&&ErrorHandler.showError(err,Strings.ERROR_PUSHING_OPERATION)})}function pullFromRemote(remote){if(!remote)return ErrorHandler.showError(StringUtils.format(Strings.ERROR_NO_REMOTE_SELECTED,"pull"));var pullConfig={remote:remote};PullDialog.show(pullConfig).then(function(pullConfig){var q=Promise.resolve();return pullConfig.branch&&pullConfig.setBranchAsTracking&&(q=q.then(function(){return Git.setUpstreamBranch(pullConfig.remote,pullConfig.branch)})),pullConfig.remoteUrlNew&&(q=q.then(function(){return Git.setRemoteUrl(pullConfig.remote,pullConfig.remoteUrlNew)})),q=q.then(function(){const progressTracker=ProgressDialog.newProgressTracker();return ProgressDialog.show(Git.fetchRemote(pullConfig.remote,progressTracker),progressTracker).then(function(){return"DEFAULT"===pullConfig.strategy?Git.mergeRemote(pullConfig.remote,pullConfig.branch,!1,!1,{progressTracker:progressTracker}):"AVOID_MERGING"===pullConfig.strategy?Git.mergeRemote(pullConfig.remote,pullConfig.branch,!0,!1,{progressTracker:progressTracker}):"MERGE_NOCOMMIT"===pullConfig.strategy?Git.mergeRemote(pullConfig.remote,pullConfig.branch,!1,!0,{progressTracker:progressTracker}):"REBASE"===pullConfig.strategy?Git.rebaseRemote(pullConfig.remote,pullConfig.branch,progressTracker):"RESET"===pullConfig.strategy?Git.resetRemote(pullConfig.remote,pullConfig.branch,progressTracker):void 0}).then(function(result){return ProgressDialog.waitForClose().then(function(){return Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"pull","success"),Utils.showOutput(result||Strings.GIT_PULL_SUCCESS,Strings.GIT_PULL_RESPONSE)})}).catch(function(err){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"pull","fail"),ErrorHandler.showError(err,Strings.ERROR_PULLING_REMOTE,{errorMetric:"pull"})})}),pullConfig.remoteUrlRestore&&(q=q.finally(function(){return Git.setRemoteUrl(pullConfig.remote,pullConfig.remoteUrlRestore)})),q.finally(function(){EventEmitter.emit(Events.REFRESH_ALL)})}).catch(function(err){err&&ErrorHandler.showError(err,Strings.ERROR_PULLING_OPERATION)})}function handleFetch(){EventEmitter.emit(Events.FETCH_STARTED);const tracker=ProgressDialog.newProgressTracker();return ProgressDialog.show(Git.fetchAllRemotes(tracker),tracker).then(()=>{Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"fetch","success")}).catch(function(err){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"fetch","fail"),ErrorHandler.showError(err,void 0,{errorMetric:"fetch"})}).then(ProgressDialog.waitForClose).finally(function(){EventEmitter.emit(Events.FETCH_COMPLETE)})}EventEmitter.on(Events.GIT_ENABLED,function(){initVariables(),refreshRemotesPicker()}),EventEmitter.on(Events.HANDLE_REMOTE_PICK,function(event){var $remote=$(event.target).closest(".remote-name"),remoteName,type;selectRemote($remote.data("remote-name"),$remote.data("type")),EventEmitter.emit(Events.REFRESH_COUNTERS)}),EventEmitter.on(Events.HANDLE_REMOTE_CREATE,function(){handleRemoteCreation()}),EventEmitter.on(Events.HANDLE_REMOTE_DELETE,function(event){var remoteName;deleteRemote($(event.target).closest(".remote-name").data("remote-name"))}),EventEmitter.on(Events.HANDLE_PULL,function(){var remoteName;pullFromRemote($selectedRemote.data("remote"))}),EventEmitter.on(Events.HANDLE_PUSH,function(){var remoteName;pushToRemote($selectedRemote.data("remote"))}),EventEmitter.on(Events.HANDLE_FETCH,function(){handleFetch()})});
//# sourceMappingURL=Remotes.js.map
