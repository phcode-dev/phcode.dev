define(function(require,exports){const _=brackets.getModule("thirdparty/lodash"),StateManager=brackets.getModule("preferences/StateManager"),CodeInspection=brackets.getModule("language/CodeInspection"),CommandManager=brackets.getModule("command/CommandManager"),Commands=brackets.getModule("command/Commands"),Dialogs=brackets.getModule("widgets/Dialogs"),DocumentManager=brackets.getModule("document/DocumentManager"),EditorManager=brackets.getModule("editor/EditorManager"),FileViewController=brackets.getModule("project/FileViewController"),FileSystem=brackets.getModule("filesystem/FileSystem"),Menus=brackets.getModule("command/Menus"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),FindInFiles=brackets.getModule("search/FindInFiles"),WorkspaceManager=brackets.getModule("view/WorkspaceManager"),ProjectManager=brackets.getModule("project/ProjectManager"),StringUtils=brackets.getModule("utils/StringUtils"),Strings=brackets.getModule("strings"),Metrics=brackets.getModule("utils/Metrics"),NotificationUI=brackets.getModule("widgets/NotificationUI"),Constants=require("src/Constants"),Git=require("src/git/Git"),Events=require("./Events"),EventEmitter=require("./EventEmitter"),Preferences=require("./Preferences"),Setup=require("src/utils/Setup"),ErrorHandler=require("./ErrorHandler"),ExpectedError=require("./ExpectedError"),Main=require("./Main"),GutterManager=require("./GutterManager"),Utils=require("src/Utils"),ProgressDialog=require("src/dialogs/Progress"),gitPanelTemplate=require("text!templates/git-panel.html"),gitPanelResultsTemplate=require("text!templates/git-panel-results.html"),gitAuthorsDialogTemplate=require("text!templates/authors-dialog.html"),gitCommitDialogTemplate=require("text!templates/git-commit-dialog.html"),gitCommitLintResultTemplate=require("text!templates/git-commit-dialog-lint-results.html"),gitDiffDialogTemplate=require("text!templates/git-diff-dialog.html"),questionDialogTemplate=require("text!templates/git-question-dialog.html"),showFileWhiteList=/^\.gitignore$/,GIT_PANEL_SHOWN_ON_FIRST_BOOT="GIT_PANEL_SHOWN_ON_FIRST_BOOT",COMMIT_MODE={CURRENT:"CURRENT",ALL:"ALL",DEFAULT:"DEFAULT"};var gitPanel=null,$gitPanel=$(null),$mainToolbar,gitPanelDisabled=null,gitPanelMode=null,showingUntracked=!0,$tableContainer=$(null),lastCommitMessage={};function lintFile(filename){var fullPath=Preferences.get("currentGitRoot")+filename,codeInspectionPromise;try{codeInspectionPromise=CodeInspection.inspectFile(FileSystem.getFileForPath(fullPath))}catch(e){ErrorHandler.logError("CodeInspection.inspectFile failed to execute for file "+fullPath),ErrorHandler.logError(e),codeInspectionPromise=Promise.reject(e)}return jsPromise(codeInspectionPromise)}function _makeDialogBig($dialog){var $wrapper;0!==$dialog.parents(".modal-wrapper").first().length&&$dialog.width("80%").children(".modal-body").css("max-height","72vh").end()}function _showCommitDialog(stagedDiff,prefilledMessage,commitMode,files){const compiledTemplate=Mustache.render(gitCommitDialogTemplate,{Strings:Strings}),dialog=Dialogs.showModalDialogUsingTemplate(compiledTemplate),$dialog=dialog.getElement();Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"commit","showDialog");let totalLintErrors=0;inspectFiles(files,$dialog).then(function(lintResults){(lintResults=lintResults||[]).forEach(function(lintResult){lintResult.errors=[];const lintingFilePath=path.join(ProjectManager.getProjectRoot().fullPath,lintResult.filename);Array.isArray(lintResult.result)?lintResult.result.forEach(function(resultSet){if(resultSet.result&&resultSet.result.errors){var providerName=resultSet.provider.name;resultSet.result.errors.forEach(function(e){lintResult.errors.push({errorLineMessage:e.pos.line+1+": "+e.message+" ("+providerName+")",line:e.pos.line,ch:e.pos.ch,file:lintingFilePath})})}}):ErrorHandler.logError("[brackets-git] lintResults contain object in unexpected format: "+JSON.stringify(lintResult)),lintResult.hasErrors=lintResult.errors.length>0,totalLintErrors+=lintResult.errors.length}),Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"commit","lintErr"+Metrics.getRangeName(totalLintErrors)),lintResults=_.filter(lintResults,function(lintResult){return lintResult.hasErrors});const compiledResultHTML=Mustache.render(gitCommitLintResultTemplate,{Strings:Strings,lintResults:lintResults});if($dialog&&$dialog.is(":visible")){if($dialog.find(".accordion-title").html(Strings.CODE_INSPECTION_PROBLEMS),!lintResults.length)return $dialog.find(".lint-errors").html(Strings.CODE_INSPECTION_PROBLEMS_NONE),void $dialog.find(".accordion").addClass("forced-hidden");$dialog.find(".lint-errors").html(compiledResultHTML),$dialog.find(".lint-errors").is(":visible")||$dialog.find(".accordion-toggle").click(),$dialog.find(".lint-error-commit-link").click(e=>{e.preventDefault();const $el=$(e.target),fileToOpen=$el.data("file"),line=$el.data("line"),ch=$el.data("ch");CommandManager.execute(Commands.FILE_OPEN,{fullPath:fileToOpen}).done(()=>{EditorManager.getCurrentFullEditor().setCursorPos(line,ch,!0)}),dialog.close()})}}),_makeDialogBig($dialog);const diff=Utils.formatDiff(stagedDiff);diff===Utils.FORMAT_DIFF_TOO_LARGE&&Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"commit","diffTooLarge"),$dialog.find(".commit-diff").append(diff);var toggleAmendCheckbox=function(bool){$dialog.find(".amend-commit").prop("disabled",!bool).parent().attr("title",bool?null:Strings.AMEND_COMMIT_FORBIDDEN)};function getCommitMessageElement(){var r=$dialog.find("[name='commit-message']:visible");if(1!==r.length){r=$dialog.find("[name='commit-message']");for(var i=0;i<r.length;i++)if("none"!==$(r[i]).css("display"))return $(r[i])}return r}toggleAmendCheckbox(!1),Git.getCommitCounts().then(function(commits){var hasRemote=null!=$gitPanel.find(".git-selected-remote").data("remote"),hasCommitsAhead=commits.ahead>0;toggleAmendCheckbox(!hasRemote||hasRemote&&hasCommitsAhead)}).catch(function(err){ErrorHandler.logError(err)});var $commitMessageCount=$dialog.find("input[name='commit-message-count']"),recalculateMessageLength=function(){var val=getCommitMessageElement().val().trim(),length=val.length;val.indexOf("\n")&&(length=Math.max.apply(null,val.split("\n").map(function(l){return l.length}))),$commitMessageCount.val(length).toggleClass("over50",length>50&&length<=100).toggleClass("over100",length>100)},usingTextArea=!1;function switchCommitMessageElement(){usingTextArea=!usingTextArea;var findStr="[name='commit-message']",currentValue=$dialog.find(findStr+":visible").val();$dialog.find(findStr).toggle(),$dialog.find(findStr+":visible").val(currentValue).focus(),recalculateMessageLength()}function prefillMessage(msg){-1===msg.indexOf("\n")||usingTextArea||switchCommitMessageElement(),$dialog.find("[name='commit-message']:visible").val(msg),recalculateMessageLength()}$dialog.find("button.primary").on("click",function(e){var $commitMessage=getCommitMessageElement();0===$commitMessage.val().trim().length?(e.stopPropagation(),$commitMessage.addClass("invalid")):$commitMessage.removeClass("invalid")}),$dialog.find("button.extendedCommit").on("click",function(){switchCommitMessageElement(),Preferences.set("useTextAreaForCommitByDefault",usingTextArea)}),$dialog.find(".amend-commit").on("click",function(){!1===$(this).prop("checked")?prefillMessage(""):Git.getLastCommitMessage().then(function(msg){prefillMessage(msg)})}),Preferences.get("useTextAreaForCommitByDefault")&&switchCommitMessageElement(),prefilledMessage&&prefillMessage(prefilledMessage.trim()),getCommitMessageElement().focus(),$dialog.find("[name='commit-message']").on("keyup",recalculateMessageLength).on("change",recalculateMessageLength),recalculateMessageLength(),dialog.done(function(buttonId){const commitMessageElement=getCommitMessageElement();if(commitMessageElement&&(lastCommitMessage[ProjectManager.getProjectRoot().fullPath]=commitMessageElement.val()),"ok"===buttonId)if(commitMode===COMMIT_MODE.ALL||commitMode===COMMIT_MODE.CURRENT){var filePaths=_.map(files,function(next){return next.file});Git.stage(filePaths).then(function(){return _getStagedDiff()}).then(function(diff){_doGitCommit($dialog,getCommitMessageElement,diff)}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_CANT_GET_STAGED_DIFF)})}else _doGitCommit($dialog,getCommitMessageElement,stagedDiff);else Git.status()})}function _doGitCommit($dialog,getCommitMessageElement,stagedDiff){var commitMessage=getCommitMessageElement().val(),amendCommit=$dialog.find(".amend-commit").prop("checked"),noVerify=$dialog.find(".commit-no-verify").prop("checked"),s=commitMessage.split("\n");s.length>1&&""!==s[1].trim()&&s.splice(1,0,""),commitMessage=s.join("\n"),lastCommitMessage[ProjectManager.getProjectRoot().fullPath]=commitMessage,_getStagedDiff().then(function(diff){if(diff===stagedDiff){const tracker=ProgressDialog.newProgressTracker();return ProgressDialog.show(Git.commit(commitMessage,amendCommit,noVerify,tracker),tracker,{title:Strings.GIT_COMMIT_IN_PROGRESS,options:{preDelay:1,postDelay:1}}).then(function(){lastCommitMessage[ProjectManager.getProjectRoot().fullPath]=null})}throw new ExpectedError(Strings.ERROR_MODIFIED_DIALOG_FILES)}).then(()=>{Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"commit","success")}).catch(function(err){if(ErrorHandler.contains(err,"Please tell me who you are"))return new Promise(resolve=>{EventEmitter.emit(Events.GIT_CHANGE_USERNAME,function(){EventEmitter.emit(Events.GIT_CHANGE_EMAIL,function(){resolve()})})});ErrorHandler.showError(err,Strings.ERROR_GIT_COMMIT_FAILED,{errorMetric:"commit"}),Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"commit","fail")}).finally(function(){EventEmitter.emit(Events.GIT_COMMITED),refresh()})}function _showAuthors(file,blame,fromLine,toLine){var linesTotal=blame.length,blameStats=blame.reduce(function(stats,lineInfo){var name=lineInfo.author+" "+lineInfo["author-mail"];return stats[name]?stats[name]+=1:stats[name]=1,stats},{});blameStats=_.reduce(blameStats,function(arr,val,key){return arr.push({authorName:key,lines:val,percentage:Math.round(val/(linesTotal/100))}),arr},[]),blameStats=_.sortBy(blameStats,"lines").reverse(),(fromLine||toLine)&&(file+=" ("+Strings.LINES+" "+fromLine+"-"+toLine+")");var compiledTemplate=Mustache.render(gitAuthorsDialogTemplate,{file:file,blameStats:blameStats,Strings:Strings});Dialogs.showModalDialogUsingTemplate(compiledTemplate)}function _getCurrentFilePath(editor){var gitRoot=Preferences.get("currentGitRoot"),document,filePath=(editor?editor.document:DocumentManager.getCurrentDocument()).file.fullPath;return 0===filePath.indexOf(gitRoot)&&(filePath=filePath.substring(gitRoot.length)),filePath}function handleAuthorsSelection(){var editor=EditorManager.getActiveEditor(),filePath=_getCurrentFilePath(editor),currentSelection=editor.getSelection(),fromLine=currentSelection.start.line+1,toLine=currentSelection.end.line+1,isSomethingSelected;0===currentSelection.end.ch&&(toLine-=1),currentSelection.start.line!==currentSelection.end.line||currentSelection.start.ch!==currentSelection.end.ch?editor.document.isDirty?ErrorHandler.showError(new ExpectedError(Strings.ERROR_SAVE_FIRST)):Git.getBlame(filePath,fromLine,toLine).then(function(blame){return _showAuthors(filePath,blame,fromLine,toLine)}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_GIT_BLAME_FAILED)}):ErrorHandler.showError(new ExpectedError(Strings.ERROR_NOTHING_SELECTED))}function handleAuthorsFile(){var filePath=_getCurrentFilePath();Git.getBlame(filePath).then(function(blame){return _showAuthors(filePath,blame)}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_GIT_BLAME_FAILED)})}function handleGitDiff(file){Preferences.get("useDifftool")?Git.difftool(file):Git.diffFileNice(file).then(function(diff){var compiledTemplate=Mustache.render(gitDiffDialogTemplate,{file:file,Strings:Strings}),dialog,$dialog=Dialogs.showModalDialogUsingTemplate(compiledTemplate).getElement();_makeDialogBig($dialog);const diffVal=Utils.formatDiff(diff);diffVal===Utils.FORMAT_DIFF_TOO_LARGE?Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"diffBtn","diffTooLarge"):Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"diffBtn","success"),$dialog.find(".commit-diff").append(diffVal)}).catch(function(err){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"diffBtn","error"),ErrorHandler.showError(err,Strings.ERROR_GIT_DIFF_FAILED)})}function handleGitUndo(file){var compiledTemplate=Mustache.render(questionDialogTemplate,{title:Strings.UNDO_CHANGES,question:StringUtils.format(Strings.Q_UNDO_CHANGES,_.escape(file)),Strings:Strings});Dialogs.showModalDialogUsingTemplate(compiledTemplate).done(function(buttonId){"ok"===buttonId&&Git.discardFileChanges(file).then(function(){var gitRoot=Preferences.get("currentGitRoot");DocumentManager.getAllOpenDocuments().forEach(function(doc){doc.file.fullPath===gitRoot+file&&Utils.reloadDoc(doc)}),refresh()}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_DISCARD_CHANGES_FAILED)})})}function handleGitDelete(file){FileSystem.resolve(Preferences.get("currentGitRoot")+file,function(err,fileEntry){err?ErrorHandler.showError(err,Strings.ERROR_COULD_NOT_RESOLVE_FILE):CommandManager.execute(Commands.FILE_DELETE,{file:fileEntry})})}function _getStagedDiff(commitMode,files=[]){const tracker=ProgressDialog.newProgressTracker(),fileNamesString=files.map(file=>file.file).join(", ");return ProgressDialog.show(_getStagedDiffForCommitMode(commitMode,files),tracker,{title:Strings.GETTING_STAGED_DIFF_PROGRESS,initialMessage:`${fileNamesString}\n${Strings.PLEASE_WAIT}`,options:{preDelay:3,postDelay:1}}).catch(function(err){if(ErrorHandler.contains(err,"cleanup"))return!1;throw err}).then(function(diff){return diff||Git.getListOfStagedFiles().then(function(filesList){return Strings.DIFF_FAILED_SEE_FILES+"\n\n"+filesList})})}function _getStagedDiffForCommitMode(commitMode,files){return commitMode===COMMIT_MODE.ALL?_getStaggedDiffForAllFiles():commitMode===COMMIT_MODE.CURRENT&&_.isArray(files)?files.length>1?Promise.reject("_getStagedDiffForCommitMode() got files.length > 1"):-1!==files[0].status.indexOf(Git.FILE_STATUS.UNTRACKED)?_getDiffForUntrackedFiles(files[0].file):Git.getDiffOfAllIndexFiles(files[0].file):Git.getDiffOfStagedFiles();var isUntracked}function _getStaggedDiffForAllFiles(){return Git.status().then(function(statusFiles){var untrackedFiles=[],fileArray=[];return statusFiles.forEach(function(fileObject){var isUntracked;-1!==fileObject.status.indexOf(Git.FILE_STATUS.UNTRACKED)?untrackedFiles.push(fileObject.file):fileArray.push(fileObject.file)}),untrackedFiles.length>0?_getDiffForUntrackedFiles(fileArray.concat(untrackedFiles)):Git.getDiffOfAllIndexFiles(fileArray)})}function _getDiffForUntrackedFiles(files){var diff;return Git.stage(files,!1).then(function(){return Git.getDiffOfStagedFiles()}).then(function(_diff){return diff=_diff,Git.resetIndex()}).then(function(){return diff})}function handleRebase(whatToDo){Git.rebase(whatToDo).then(function(){EventEmitter.emit(Events.REFRESH_ALL)}).catch(function(err){ErrorHandler.showError(err,"Rebase "+whatToDo+" failed")})}function abortMerge(){Git.discardAllChanges().then(function(){EventEmitter.emit(Events.REFRESH_ALL)}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_MERGE_ABORT_FAILED)})}function findConflicts(){FindInFiles.doSearch(/^<<<<<<<\s|^=======\s|^>>>>>>>\s/gm)}function commitMerge(){Utils.loadPathContent(Preferences.get("currentGitRoot")+"/.git/MERGE_MSG").then(function(msg){handleGitCommit(msg,!0,COMMIT_MODE.DEFAULT),EventEmitter.once(Events.GIT_COMMITED,function(){EventEmitter.emit(Events.REFRESH_ALL)})}).catch(function(err){ErrorHandler.showError(err,"Merge commit failed")})}function inspectFiles(gitStatusResults,$dialog){const lintResults=[];let totalFiles=gitStatusResults.length,totalFilesLinted=0,filesDone=0;function showProgress(){const $progressBar=$dialog.find(".accordion-progress-bar-inner");$progressBar.length&&($progressBar[0].style.width=`${filesDone/totalFiles*100}%`),filesDone===totalFiles&&$dialog.find(".accordion-progress-bar").addClass("forced-inVisible");const progressString=StringUtils.format(Strings.CODE_INSPECTION_DONE_FILES,filesDone,totalFiles);$dialog.find(".lint-errors").html(progressString)}const codeInspectionPromises=gitStatusResults.map(function(fileObj){const isDeleted=-1!==fileObj.status.indexOf(Git.FILE_STATUS.DELETED);return isDeleted?(filesDone++,void showProgress()):new Promise(resolve=>{setTimeout(()=>{lintFile(fileObj.file).catch(function(){return[{provider:{name:"See console [F12] for details"},result:{errors:[{pos:{line:0,ch:0},message:"CodeInspection failed to execute for this file."}]}}]}).then(function(result){result&&lintResults.push({filename:fileObj.file,result:result}),resolve()}).finally(()=>{filesDone++,totalFilesLinted++,showProgress()})},0)})});return Promise.all(_.compact(codeInspectionPromises)).then(function(){return Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"commit","files"+Metrics.getRangeName(totalFiles)),Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"commit","lint"+Metrics.getRangeName(totalFilesLinted)),lintResults})}function handleGitCommit(prefilledMessage,isMerge,commitMode){if(!Utils.isLoading($gitPanel.find(".git-commit"))){var stripWhitespace=Preferences.get("stripWhitespaceFromCommits"),p;Utils.setLoading($gitPanel.find(".git-commit")),commitMode===COMMIT_MODE.DEFAULT?p=Git.status().then(function(files){return 0!==(files=_.filter(files,function(file){return-1!==file.status.indexOf(Git.FILE_STATUS.STAGED)})).length||isMerge?handleGitCommitInternal(stripWhitespace,files,commitMode,prefilledMessage):ErrorHandler.showError(new Error("Commit button should have been disabled"),"Nothing staged to commit")}):commitMode===COMMIT_MODE.ALL?p=Git.status().then(function(files){return handleGitCommitInternal(stripWhitespace,files,commitMode,prefilledMessage)}):commitMode===COMMIT_MODE.CURRENT&&(p=Git.status().then(function(files){var gitRoot=Preferences.get("currentGitRoot"),currentDoc=DocumentManager.getCurrentDocument();if(currentDoc){var relativePath=currentDoc.file.fullPath.substring(gitRoot.length),currentFile=_.filter(files,function(next){return relativePath===next.file});return handleGitCommitInternal(stripWhitespace,currentFile,commitMode,prefilledMessage)}})),p.catch(function(err){ErrorHandler.showError(err,Strings.ERROR_PREPARING_COMMIT_DIALOG)}).finally(function(){Utils.unsetLoading($gitPanel.find(".git-commit"))})}}function handleGitCommitInternal(stripWhitespace,files,commitMode,prefilledMessage){let queue=Promise.resolve();return stripWhitespace&&(queue=queue.then(function(){const tracker=ProgressDialog.newProgressTracker();return ProgressDialog.show(Utils.stripWhitespaceFromFiles(files,commitMode===COMMIT_MODE.DEFAULT,tracker),tracker,{title:Strings.CLEANING_WHITESPACE_PROGRESS,options:{preDelay:3,postDelay:1}})})),queue.then(function(){return _getStagedDiff(commitMode,files).then(function(diff){return _showCommitDialog(diff,prefilledMessage,commitMode,files)})})}function refreshCurrentFile(){var gitRoot=Preferences.get("currentGitRoot"),currentDoc=DocumentManager.getCurrentDocument();currentDoc?$gitPanel.find("tr").each(function(){var currentFullPath=currentDoc.file.fullPath,thisFile=$(this).attr("x-file");$(this).toggleClass("selected",gitRoot+thisFile===currentFullPath)}):$gitPanel.find("tr").removeClass("selected")}function shouldShow(fileObj){return!!showFileWhiteList.test(fileObj.name)||ProjectManager.shouldShow(fileObj)}function _refreshTableContainer(files){if(gitPanel.isVisible()){var allStaged=(files=_.filter(files,function(file){return shouldShow(file)})).length>0&&_.all(files,function(file){return-1!==file.status.indexOf(Git.FILE_STATUS.STAGED)});$gitPanel.find(".check-all").prop("checked",allStaged).prop("disabled",0===files.length);var $editedList=$tableContainer.find(".git-edited-list"),visibleBefore=!$editedList.length||$editedList.is(":visible");$editedList.remove(),0===files.length?$tableContainer.append($("<p class='git-edited-list nothing-to-commit' />").text(Strings.NOTHING_TO_COMMIT)):(!1===showingUntracked&&(files=_.filter(files,function(file){return-1===file.status.indexOf(Git.FILE_STATUS.UNTRACKED)})),files.forEach(function(file){file.staged=-1!==file.status.indexOf(Git.FILE_STATUS.STAGED),file.statusText=file.status.map(function(status){return Strings["FILE_"+status]}).join(", "),file.allowDiff=-1===file.status.indexOf(Git.FILE_STATUS.UNTRACKED)&&-1===file.status.indexOf(Git.FILE_STATUS.RENAMED)&&-1===file.status.indexOf(Git.FILE_STATUS.DELETED),file.allowDelete=-1!==file.status.indexOf(Git.FILE_STATUS.UNTRACKED)||-1!==file.status.indexOf(Git.FILE_STATUS.STAGED)&&-1!==file.status.indexOf(Git.FILE_STATUS.ADDED),file.allowUndo=!file.allowDelete}),$tableContainer.append(Mustache.render(gitPanelResultsTemplate,{files:files,Strings:Strings})),refreshCurrentFile()),$tableContainer.find(".git-edited-list").toggle(visibleBefore)}}function _setName(commandID,newName){const command=CommandManager.get(commandID);command&&command.setName(newName)}function refreshCommitCounts(){var $pullBtn=$gitPanel.find(".git-pull"),$pushBtn=$gitPanel.find(".git-push"),clearCounts=function(){$pullBtn.children("span").remove(),$pushBtn.children("span").remove(),_setName(Constants.CMD_GIT_PULL,Strings.PULL_SHORTCUT),_setName(Constants.CMD_GIT_PUSH,Strings.PUSH_SHORTCUT)},remotes,defaultRemote;return(Preferences.get("defaultRemotes")||{})[Preferences.get("currentGitRoot")]?Git.getCommitCounts().then(function(commits){clearCounts(),commits.behind>0&&($pullBtn.append($("<span/>").text(" ("+commits.behind+")")),_setName(Constants.CMD_GIT_PULL,StringUtils.format(Strings.PULL_SHORTCUT_BEHIND,commits.behind))),commits.ahead>0&&($pushBtn.append($("<span/>").text(" ("+commits.ahead+")")),_setName(Constants.CMD_GIT_PUSH,StringUtils.format(Strings.PUSH_SHORTCUT_AHEAD,commits.ahead)))}).catch(function(err){clearCounts(),ErrorHandler.logError(err)}):(clearCounts(),Promise.resolve())}function refresh(){if($gitPanel.find(".git-history-toggle").removeClass("active").attr("title",Strings.TOOLTIP_SHOW_HISTORY),$gitPanel.find(".git-file-history").removeClass("active").attr("title",Strings.TOOLTIP_SHOW_FILE_HISTORY),"not-repo"===gitPanelMode)return $tableContainer.empty(),Promise.resolve();$tableContainer.find("#git-history-list").remove(),$tableContainer.find(".git-edited-list").show();var p1=Git.status().catch(function(err){ErrorHandler.contains(err,"Not a git repository")}),p2=refreshCommitCounts();return $gitPanel.find(".git-clone").prop("disabled",!1),Promise.all([p1,p2])}function toggle(bool){!0!==gitPanelDisabled&&("boolean"!=typeof bool&&(bool=!gitPanel.isVisible()),Preferences.set("panelEnabled",bool),Main.$icon.toggleClass("on",bool),Main.$icon.toggleClass("selected-button",bool),gitPanel.setVisible(bool),CommandManager.get(Constants.CMD_GIT_TOGGLE_PANEL).setChecked(bool),bool&&($("#git-toolbar-icon").removeClass("forced-hidden"),refresh()))}function handleToggleUntracked(){showingUntracked=!showingUntracked;const command=CommandManager.get(Constants.CMD_GIT_TOGGLE_UNTRACKED);command&&command.setChecked(!showingUntracked),refresh()}function commitCurrentFile(){jsPromise(CommandManager.execute("file.save")).then(function(){return Git.resetIndex()}).then(function(){return handleGitCommit(lastCommitMessage[ProjectManager.getProjectRoot().fullPath],!1,COMMIT_MODE.CURRENT)}).catch(err=>{throw console.error(err),new Error("Error commitCurrentFile in git panel.js. this should not have happened here.")})}function commitAllFiles(){jsPromise(CommandManager.execute("file.saveAll")).then(function(){return Git.resetIndex()}).then(function(){return handleGitCommit(lastCommitMessage[ProjectManager.getProjectRoot().fullPath],!1,COMMIT_MODE.ALL)}).catch(err=>{throw console.error(err),new Error("Error commitAllFiles in git panel.js. this should not have happened here.")})}function _toggleCommitButton(files){var anyStaged=_.any(files,function(file){return-1!==file.status.indexOf(Git.FILE_STATUS.STAGED)});$gitPanel.find(".git-commit").prop("disabled",!anyStaged)}function undoLastLocalCommit(){return Utils.askQuestion(Strings.UNDO_COMMIT,Strings.UNDO_LOCAL_COMMIT_CONFIRM,{booleanResponse:!0}).then(function(response){response&&Git.undoLastLocalCommit().catch(function(err){ErrorHandler.showError(err,Strings.ERROR_UNDO_LAST_COMMIT_FAILED)}).finally(function(){refresh()})})}EventEmitter.on(Events.GIT_STATUS_RESULTS,function(results){_refreshTableContainer(results),_toggleCommitButton(results)});var lastCheckOneClicked=null;function attachDefaultTableHandlers(){$tableContainer=$gitPanel.find(".table-container").off().on("click",".check-one",function(e){e.stopPropagation();var $tr=$(this).closest("tr"),file=$tr.attr("x-file"),status=$tr.attr("x-status"),isChecked=$(this).is(":checked");if(e.shiftKey){var lc=lastCheckOneClicked.localeCompare(file),lcClickedSelector="[x-file='"+lastCheckOneClicked+"']",sequence;if(lc<0?sequence=$tr.prevUntil(lcClickedSelector).andSelf():lc>0&&(sequence=$tr.nextUntil(lcClickedSelector).andSelf()),sequence){var promises=(sequence=sequence.add($tr.parent().children(lcClickedSelector))).map(function(){var $this=$(this),method=isChecked?"stage":"unstage",file=$this.attr("x-file"),status=$this.attr("x-status");return Git[method](file,status===Git.FILE_STATUS.DELETED)}).toArray();return Promise.all(promises).then(function(){return Git.status()}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_MODIFY_FILE_STATUS_FAILED)})}}lastCheckOneClicked=file,isChecked?Git.stage(file,status===Git.FILE_STATUS.DELETED).then(function(){Git.status()}):Git.unstage(file).then(function(){Git.status()})}).on("dblclick",".check-one",function(e){e.stopPropagation()}).on("click",".btn-git-diff",function(e){e.stopPropagation(),handleGitDiff($(e.target).closest("tr").attr("x-file"))}).on("click",".btn-git-undo",function(e){e.stopPropagation(),handleGitUndo($(e.target).closest("tr").attr("x-file"))}).on("click",".btn-git-delete",function(e){e.stopPropagation(),handleGitDelete($(e.target).closest("tr").attr("x-file"))}).on("mousedown",".modified-file",function(e){var $this=$(e.currentTarget);$(e.target).is("button, input")||$(e.target).closest("button").length||$this.attr("x-status")!==Git.FILE_STATUS.DELETED&&CommandManager.execute(Commands.FILE_OPEN,{fullPath:Preferences.get("currentGitRoot")+$this.attr("x-file")})}).on("dblclick",".modified-file",function(e){var $this=$(e.currentTarget);$this.attr("x-status")!==Git.FILE_STATUS.DELETED&&FileViewController.openFileAndAddToWorkingSet(Preferences.get("currentGitRoot")+$this.attr("x-file"))})}function setGerritCheckState(enabled){const command=CommandManager.get(Constants.CMD_GIT_GERRIT_PUSH_REF);command&&command.setChecked(enabled)}function discardAllChanges(){return Utils.askQuestion(Strings.RESET_LOCAL_REPO,Strings.RESET_LOCAL_REPO_CONFIRM,{booleanResponse:!0,customOkBtn:Strings.DISCARD_CHANGES,customOkBtnClass:"danger"}).then(function(response){if(response)return Git.discardAllChanges().catch(function(err){ErrorHandler.showError(err,Strings.ERROR_RESET_LOCAL_REPO_FAILED)}).then(function(){refresh()})})}function getSelectedHistoryCommit(){const $historyRow=$(".history-commit.selected");return $historyRow.is(":visible")?{hash:$historyRow.attr("x-hash"),subject:$historyRow.find(".commit-subject").text()}:{}}function _panelResized(_entries){if(!$mainToolbar||!$mainToolbar.is(":visible"))return;const mainToolbarWidth=$mainToolbar.width();let overFlowWidth=565;const breakpoints=[{width:565,className:"hide-when-small"},{width:400,className:"hide-when-x-small"}];mainToolbarWidth<565?$gitPanel.find(".mainToolbar").addClass("hide-overflow"):$gitPanel.find(".mainToolbar").removeClass("hide-overflow"),breakpoints.forEach(bp=>{mainToolbarWidth<bp.width?$gitPanel.find(`.${bp.className}`).addClass("forced-hidden"):$gitPanel.find(`.${bp.className}`).removeClass("forced-hidden")})}function init(){var panelHtml=Mustache.render(gitPanelTemplate,{S:Strings}),$panelHtml=$(panelHtml);$panelHtml.find(".git-available, .git-not-available").hide(),gitPanel=WorkspaceManager.createBottomPanel("main-git.panel",$panelHtml,100),$gitPanel=gitPanel.$panel;const resizeObserver=new ResizeObserver(_panelResized);resizeObserver.observe($gitPanel[0]),$mainToolbar=$gitPanel.find(".mainToolbar"),$gitPanel.on("click",".close",toggle).on("click",".check-all",function(){return $(this).is(":checked")?Git.stageAll().then(function(){return Git.status()}).catch(err=>{throw console.error(err),new Error("Error stage all by checkbox in git panel.js. this should not have happened")}):Git.resetIndex().then(function(){return Git.status()}).catch(err=>{throw console.error(err),new Error("Error unstage all by checkbox in git panel.js. this should not have happened")})}).on("click",".git-refresh",EventEmitter.getEmitter(Events.REFRESH_ALL,["panel","refreshBtn"])).on("click",".git-commit",EventEmitter.getEmitter(Events.HANDLE_GIT_COMMIT)).on("click",".git-rebase-continue",function(e){handleRebase("continue",e)}).on("click",".git-rebase-skip",function(e){handleRebase("skip",e)}).on("click",".git-rebase-abort",function(e){handleRebase("abort",e)}).on("click",".git-commit-merge",commitMerge).on("click",".git-merge-abort",abortMerge).on("click",".git-find-conflicts",findConflicts).on("click",".git-prev-gutter",()=>{Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"panel","prevBtn"),GutterManager.goToPrev()}).on("click",".git-next-gutter",()=>{Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"panel","nextBtn"),GutterManager.goToNext()}).on("click",".git-file-history",EventEmitter.getEmitter(Events.HISTORY_SHOW_FILE)).on("click",".git-history-toggle",EventEmitter.getEmitter(Events.HISTORY_SHOW_GLOBAL)).on("click",".git-fetch",EventEmitter.getEmitter(Events.HANDLE_FETCH,["panel","fetchBtn"])).on("click",".git-push",function(){var typeOfRemote;Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"panel","pushBtn"),"git"===$(this).attr("x-selected-remote-type")&&EventEmitter.emit(Events.HANDLE_PUSH)}).on("click",".git-pull",EventEmitter.getEmitter(Events.HANDLE_PULL,["panel","pullBtn"])).on("click",".git-init",EventEmitter.getEmitter(Events.HANDLE_GIT_INIT)).on("click",".git-clone",EventEmitter.getEmitter(Events.HANDLE_GIT_CLONE)).on("click",".change-remote",EventEmitter.getEmitter(Events.HANDLE_REMOTE_PICK,["panel","changeRemote"])).on("click",".remove-remote",EventEmitter.getEmitter(Events.HANDLE_REMOTE_DELETE,["panel","removeRemote"])).on("click",".git-remote-new",EventEmitter.getEmitter(Events.HANDLE_REMOTE_CREATE,["panel","newRemote"])).on("contextmenu","tr",function(e){const $this=$(this);if($this.hasClass("history-commit"))return Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"cmenu","history"),$this.hasClass("selected")||$this.click(),void Menus.getContextMenu(Constants.GIT_PANEL_HISTORY_CMENU).open(e);$this.click(),setTimeout(function(){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"cmenu","filechanges"),Menus.getContextMenu(Constants.GIT_PANEL_CHANGES_CMENU).open(e)},1)}),attachDefaultTableHandlers(),CommandManager.register(Strings.PANEL_COMMAND,Constants.CMD_GIT_TOGGLE_PANEL,toggle),CommandManager.register(Strings.COMMIT_CURRENT_SHORTCUT,Constants.CMD_GIT_COMMIT_CURRENT,commitCurrentFile),CommandManager.register(Strings.COMMIT_ALL_SHORTCUT,Constants.CMD_GIT_COMMIT_ALL,commitAllFiles),CommandManager.register(Strings.PUSH_SHORTCUT,Constants.CMD_GIT_PUSH,EventEmitter.getEmitter(Events.HANDLE_PUSH)),CommandManager.register(Strings.PULL_SHORTCUT,Constants.CMD_GIT_PULL,EventEmitter.getEmitter(Events.HANDLE_PULL)),CommandManager.register(Strings.FETCH_SHORTCUT,Constants.CMD_GIT_FETCH,EventEmitter.getEmitter(Events.HANDLE_FETCH)),CommandManager.register(Strings.GOTO_PREVIOUS_GIT_CHANGE,Constants.CMD_GIT_GOTO_PREVIOUS_CHANGE,GutterManager.goToPrev),CommandManager.register(Strings.GOTO_NEXT_GIT_CHANGE,Constants.CMD_GIT_GOTO_NEXT_CHANGE,GutterManager.goToNext),CommandManager.register(Strings.REFRESH_GIT,Constants.CMD_GIT_REFRESH,EventEmitter.getEmitter(Events.REFRESH_ALL)),CommandManager.register(Strings.RESET_LOCAL_REPO,Constants.CMD_GIT_DISCARD_ALL_CHANGES,discardAllChanges),CommandManager.register(Strings.UNDO_LAST_LOCAL_COMMIT,Constants.CMD_GIT_UNDO_LAST_COMMIT,undoLastLocalCommit),CommandManager.register(Strings.CHANGE_USER_NAME,Constants.CMD_GIT_CHANGE_USERNAME,EventEmitter.getEmitter(Events.GIT_CHANGE_USERNAME)),CommandManager.register(Strings.CHANGE_USER_EMAIL,Constants.CMD_GIT_CHANGE_EMAIL,EventEmitter.getEmitter(Events.GIT_CHANGE_EMAIL)),CommandManager.register(Strings.ENABLE_GERRIT_PUSH_REF,Constants.CMD_GIT_GERRIT_PUSH_REF,EventEmitter.getEmitter(Events.GERRIT_TOGGLE_PUSH_REF)),CommandManager.register(Strings.VIEW_AUTHORS_SELECTION,Constants.CMD_GIT_AUTHORS_OF_SELECTION,handleAuthorsSelection),CommandManager.register(Strings.VIEW_AUTHORS_FILE,Constants.CMD_GIT_AUTHORS_OF_FILE,handleAuthorsFile),CommandManager.register(Strings.HIDE_UNTRACKED,Constants.CMD_GIT_TOGGLE_UNTRACKED,handleToggleUntracked),CommandManager.register(Strings.GIT_INIT,Constants.CMD_GIT_INIT,EventEmitter.getEmitter(Events.HANDLE_GIT_INIT)),CommandManager.register(Strings.GIT_CLONE,Constants.CMD_GIT_CLONE,EventEmitter.getEmitter(Events.HANDLE_GIT_CLONE)),Preferences.get("panelEnabled")&&Setup.isExtensionActivated()&&toggle(!0),_panelResized(),GutterManager.init()}function enable(){EventEmitter.emit(Events.GIT_ENABLED),gitPanelMode=null,$gitPanel.find(".git-available").show(),$gitPanel.find(".git-not-available").hide(),Utils.enableCommand(Constants.CMD_GIT_INIT,!1),Utils.enableCommand(Constants.CMD_GIT_CLONE,!1),Main.$icon.removeClass("warning"),gitPanelDisabled=!1,refresh()}function disable(cause){EventEmitter.emit(Events.GIT_DISABLED,cause),"not-repo"===(gitPanelMode=cause)?($gitPanel.find(".git-available").hide(),$gitPanel.find(".git-not-available").show(),Utils.enableCommand(Constants.CMD_GIT_INIT,!0),Utils.enableCommand(Constants.CMD_GIT_CLONE,!0)):(Main.$icon.addClass("warning"),toggle(!1),gitPanelDisabled=!0),refresh()}EventEmitter.on(Events.GIT_CHANGE_USERNAME,function(callback){return Git.getConfig("user.name").then(function(currentUserName){return Utils.askQuestion(Strings.CHANGE_USER_NAME_TITLE,Strings.ENTER_NEW_USER_NAME,{defaultValue:currentUserName}).then(function(userName){return userName.length||(userName=currentUserName),Git.setConfig("user.name",userName,!0).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_CHANGE_USERNAME_FAILED)}).then(function(){EventEmitter.emit(Events.GIT_USERNAME_CHANGED,userName)}).finally(function(){callback&&callback(userName)})})})}),EventEmitter.on(Events.GIT_CHANGE_EMAIL,function(callback){return Git.getConfig("user.email").then(function(currentUserEmail){return Utils.askQuestion(Strings.CHANGE_USER_EMAIL_TITLE,Strings.ENTER_NEW_USER_EMAIL,{defaultValue:currentUserEmail}).then(function(userEmail){return userEmail.length||(userEmail=currentUserEmail),Git.setConfig("user.email",userEmail,!0).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_CHANGE_EMAIL_FAILED)}).then(function(){EventEmitter.emit(Events.GIT_EMAIL_CHANGED,userEmail)}).finally(function(){callback&&callback(userEmail)})})})}),EventEmitter.on(Events.GERRIT_TOGGLE_PUSH_REF,function(){return Git.getConfig("gerrit.pushref").then(function(strEnabled){var toggledValue="true"!==strEnabled;return Preferences.set("gerritPushref",toggledValue),Git.setConfig("gerrit.pushref",toggledValue,!0).then(function(){EventEmitter.emit(Events.GERRIT_PUSH_REF_TOGGLED,toggledValue)})}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_TOGGLE_GERRIT_PUSH_REF_FAILED)})}),EventEmitter.on(Events.GERRIT_PUSH_REF_TOGGLED,function(enabled){setGerritCheckState(enabled)}),EventEmitter.on(Events.GIT_USERNAME_CHANGED,function(userName){_setName(Constants.CMD_GIT_CHANGE_USERNAME,userName?StringUtils.format(Strings.CHANGE_USER_NAME_MENU,userName):Strings.CHANGE_USER_NAME)}),EventEmitter.on(Events.GIT_EMAIL_CHANGED,function(email){$gitPanel.find(".git-user-email").text(email),_setName(Constants.CMD_GIT_CHANGE_EMAIL,email?StringUtils.format(Strings.CHANGE_USER_EMAIL_MENU,email):Strings.CHANGE_USER_EMAIL)}),EventEmitter.on(Events.GIT_REMOTE_AVAILABLE,function(){$gitPanel.find(".git-pull, .git-push, .git-fetch").prop("disabled",!1)}),EventEmitter.on(Events.GIT_REMOTE_NOT_AVAILABLE,function(){$gitPanel.find(".git-pull, .git-push, .git-fetch").prop("disabled",!0)}),EventEmitter.on(Events.GIT_ENABLED,function(){StateManager.get(GIT_PANEL_SHOWN_ON_FIRST_BOOT)||(StateManager.set(GIT_PANEL_SHOWN_ON_FIRST_BOOT,!0),toggle(!0),NotificationUI.createFromTemplate(Strings.GIT_TOAST_TITLE,Strings.GIT_TOAST_MESSAGE,"git-toolbar-icon",{allowedPlacements:["left"],dismissOnClick:!0,toastStyle:"width-250"})),Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"project","enabled"),Git.getConfig("user.name").then(function(currentUserName){EventEmitter.emit(Events.GIT_USERNAME_CHANGED,currentUserName)}),Git.getConfig("user.email").then(function(currentEmail){EventEmitter.emit(Events.GIT_EMAIL_CHANGED,currentEmail)}),Git.getConfig("gerrit.pushref").then(function(strEnabled){var enabled="true"===strEnabled;enabled&&!Preferences.get("gerritPushref")&&Preferences.set("gerritPushref",!0),EventEmitter.emit(Events.GERRIT_PUSH_REF_TOGGLED,enabled)})}),EventEmitter.on(Events.BRACKETS_CURRENT_DOCUMENT_CHANGE,function(){gitPanel&&refreshCurrentFile()}),EventEmitter.on(Events.BRACKETS_DOCUMENT_SAVED,function(){gitPanel&&refresh()}),EventEmitter.on(Events.BRACKETS_FILE_CHANGED,function(fileSystemEntry){fileSystemEntry.isDirectory&&refresh()}),EventEmitter.on(Events.REBASE_MERGE_MODE,function(rebaseEnabled,mergeEnabled){$gitPanel.find(".git-rebase").toggle(rebaseEnabled),$gitPanel.find(".git-merge").toggle(mergeEnabled),$gitPanel.find("button.git-commit").toggle(!rebaseEnabled&&!mergeEnabled)}),EventEmitter.on(Events.FETCH_STARTED,function(){$gitPanel.find(".git-fetch").addClass("btn-loading").prop("disabled",!0)}),EventEmitter.on(Events.FETCH_COMPLETE,function(){$gitPanel.find(".git-fetch").removeClass("btn-loading").prop("disabled",!1),refreshCommitCounts()}),EventEmitter.on(Events.REFRESH_COUNTERS,function(){refreshCommitCounts()}),EventEmitter.on(Events.HANDLE_GIT_COMMIT,function(){handleGitCommit(lastCommitMessage[ProjectManager.getProjectRoot().fullPath],!1,COMMIT_MODE.DEFAULT)}),exports.init=init,exports.refresh=refresh,exports.toggle=toggle,exports.enable=enable,exports.disable=disable,exports.getSelectedHistoryCommit=getSelectedHistoryCommit,exports.getPanel=function(){return $gitPanel}});
//# sourceMappingURL=Panel.js.map
