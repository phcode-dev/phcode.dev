{"version":3,"sources":["extensions/default/Git/src/git/Git.js"],"names":["define","require","exports","Preferences","GitCli","Utils","pushToNewUpstream","remoteName","remoteBranch","options","args","noVerify","push","progressTracker","getRemoteUrl","remote","getConfig","setRemoteUrl","url","setConfig","sortBranches","branches","sort","a","b","ar","br","sortPrefix","sortName","getBranches","then","getAllBranches","getHistory","branch","skip","getFileHistory","file","resetIndex","reset","discardAllChanges","clean","getMergeInfo","baseCheck","mergeCheck","rebaseCheck","gitFolder","get","Promise","all","map","fileName","loadPathContent","mergeMode","rebaseMode","obj","head","msg","mergeHead","trim","msgSplit","split","mergeMessage","mergeConflicts","line","next","last","rebaseNext","rebaseLast","rebaseHead","substring","length","discardFileChanges","unstage","checkout","pushForced","deleteRemoteBranch","undoLastLocalCommit","Object","keys","forEach","method"],"mappings":"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","sourcesContent":["/*\n    This file acts as an entry point to GitCli.js and other possible\n    implementations of Git communication besides Cli. Application\n    should not access GitCli directly.\n*/\ndefine(function (require, exports) {\n\n    // Local modules\n    const Preferences = require(\"src/Preferences\"),\n        GitCli      = require(\"src/git/GitCli\"),\n        Utils       = require(\"src/Utils\");\n\n    // Implementation\n    function pushToNewUpstream(remoteName, remoteBranch, options = {}) {\n        const args = [\"--set-upstream\"];\n\n        if (options.noVerify) {\n            args.push(\"--no-verify\");\n        }\n\n        return GitCli.push(remoteName, remoteBranch, args, options.progressTracker);\n    }\n\n    function getRemoteUrl(remote) {\n        return GitCli.getConfig(\"remote.\" + remote + \".url\");\n    }\n\n    function setRemoteUrl(remote, url) {\n        return GitCli.setConfig(\"remote.\" + remote + \".url\", url);\n    }\n\n    function sortBranches(branches) {\n        return branches.sort(function (a, b) {\n            var ar = a.remote || \"\",\n                br = b.remote || \"\";\n            // origin remote first\n            if (br && ar === \"origin\" && br !== \"origin\") {\n                return -1;\n            } else if (ar && ar !== \"origin\" && br === \"origin\") {\n                return 1;\n            }\n            // sort by remotes\n            if (ar < br) {\n                return -1;\n            } else if (ar > br) {\n                return 1;\n            }\n            // sort by sortPrefix (# character)\n            if (a.sortPrefix < b.sortPrefix) {\n                return -1;\n            } else if (a.sortPrefix > b.sortPrefix) {\n                return 1;\n            }\n            // master branch first\n            if (a.sortName === \"master\" && b.sortName !== \"master\") {\n                return -1;\n            } else if (a.sortName !== \"master\" && b.sortName === \"master\") {\n                return 1;\n            }\n            // sort by sortName (lowercased branch name)\n            return a.sortName < b.sortName ? -1 : a.sortName > b.sortName ? 1 : 0;\n        });\n    }\n\n    function getBranches() {\n        return GitCli.getBranches().then(function (branches) {\n            return sortBranches(branches);\n        });\n    }\n\n    function getAllBranches() {\n        return GitCli.getAllBranches().then(function (branches) {\n            return sortBranches(branches);\n        });\n    }\n\n    function getHistory(branch, skip) {\n        return GitCli.getHistory(branch, skip);\n    }\n\n    function getFileHistory(file, branch, skip) {\n        return GitCli.getHistory(branch, skip, file);\n    }\n\n    function resetIndex() {\n        return GitCli.reset();\n    }\n\n    function discardAllChanges() {\n        return GitCli.reset(\"--hard\").then(function () {\n            return GitCli.clean();\n        });\n    }\n\n    function getMergeInfo() {\n        var baseCheck  = [\"MERGE_MODE\", \"rebase-apply\"],\n            mergeCheck = [\"MERGE_HEAD\", \"MERGE_MSG\"],\n            rebaseCheck = [\"rebase-apply/next\", \"rebase-apply/last\", \"rebase-apply/head-name\"],\n            gitFolder  = Preferences.get(\"currentGitRoot\") + \".git/\";\n\n        return Promise.all(baseCheck.map(function (fileName) {\n            return Utils.loadPathContent(gitFolder + fileName);\n        })).then(function ([mergeMode, rebaseMode]) {\n            var obj = {\n                mergeMode: mergeMode !== null,\n                rebaseMode: rebaseMode !== null\n            };\n            if (obj.mergeMode) {\n\n                return Promise.all(mergeCheck.map(function (fileName) {\n                    return Utils.loadPathContent(gitFolder + fileName);\n                })).then(function ([head, msg]) {\n\n                    if (head) {\n                        obj.mergeHead = head.trim();\n                    }\n                    var msgSplit = msg ? msg.trim().split(/conflicts:/i) : [];\n                    if (msgSplit[0]) {\n                        obj.mergeMessage = msgSplit[0].trim();\n                    }\n                    if (msgSplit[1]) {\n                        obj.mergeConflicts = msgSplit[1].trim().split(\"\\n\").map(function (line) { return line.trim(); });\n                    }\n                    return obj;\n\n                });\n\n            }\n            if (obj.rebaseMode) {\n\n                return Promise.all(rebaseCheck.map(function (fileName) {\n                    return Utils.loadPathContent(gitFolder + fileName);\n                })).then(function ([next, last, head]) {\n\n                    if (next) { obj.rebaseNext = next.trim(); }\n                    if (last) { obj.rebaseLast = last.trim(); }\n                    if (head) { obj.rebaseHead = head.trim().substring(\"refs/heads/\".length); }\n                    return obj;\n\n                });\n\n            }\n            return obj;\n        });\n    }\n\n    function discardFileChanges(file) {\n        return GitCli.unstage(file).then(function () {\n            return GitCli.checkout(file);\n        });\n    }\n\n    function pushForced(remote, branch, options = {}) {\n        const args = [\"--force\"];\n\n        if (options.noVerify) {\n            args.push(\"--no-verify\");\n        }\n\n        return GitCli.push(remote, branch, args, options.progressTracker);\n    }\n\n    function deleteRemoteBranch(remote, branch, options = {}) {\n        const args = [\"--delete\"];\n\n        if (options.noVerify) {\n            args.push(\"--no-verify\");\n        }\n\n        return GitCli.push(remote, branch, args, options.progressTracker);\n    }\n\n    function undoLastLocalCommit() {\n        return GitCli.reset(\"--soft\", \"HEAD~1\");\n    }\n\n    // Public API\n    exports.pushToNewUpstream       = pushToNewUpstream;\n    exports.getBranches             = getBranches;\n    exports.getAllBranches          = getAllBranches;\n    exports.getHistory              = getHistory;\n    exports.getFileHistory          = getFileHistory;\n    exports.resetIndex              = resetIndex;\n    exports.discardAllChanges       = discardAllChanges;\n    exports.getMergeInfo            = getMergeInfo;\n    exports.discardFileChanges      = discardFileChanges;\n    exports.getRemoteUrl            = getRemoteUrl;\n    exports.setRemoteUrl            = setRemoteUrl;\n    exports.pushForced              = pushForced;\n    exports.deleteRemoteBranch      = deleteRemoteBranch;\n    exports.undoLastLocalCommit     = undoLastLocalCommit;\n\n    Object.keys(GitCli).forEach(function (method) {\n        if (!exports[method]) {\n            exports[method] = GitCli[method];\n        }\n    });\n});\n"],"file":"Git.js"}