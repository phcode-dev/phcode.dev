{"version":3,"sources":["extensions/default/Git/src/Branch.js"],"names":["define","require","exports","_","brackets","getModule","CommandManager","Dialogs","EditorManager","FileSyncManager","FileSystem","Menus","Mustache","PopUpManager","StringUtils","DocumentManager","Strings","Metrics","MainViewManager","Git","Events","EventEmitter","ErrorHandler","Panel","Setup","Preferences","ProgressDialog","Utils","branchesMenuTemplate","newBranchTemplate","mergeBranchTemplate","$gitBranchName","$","currentEditor","$dropdown","renderList","branches","map","name","currentBranch","indexOf","canDelete","templateVars","branchList","filter","o","render","closeDropdown","removePopUp","detachCloseEvents","doMerge","fromBranch","getBranches","then","compiledTemplate","dialog","showModalDialogUsingTemplate","$dialog","getElement","find","focus","$toBranch","$useRebase","$useNoff","prop","val","$mergeMessage","attr","on","prMsg","setSelectionRange","useRebase","trigger","done","buttonId","useNoff","mergeMsg","rebaseInit","catch","err","countEvent","EVENT_TYPE","GIT","showError","ERROR_REBASE_FAILED","stdout","showOutput","GIT_REBASE_SUCCESS","REBASE_RESULT","finally","emit","REFRESH_ALL","console","error","mergeBranch","ERROR_MERGE_FAILED","GIT_MERGE_SUCCESS","MERGE_RESULT","Error","_reloadBranchSelect","$el","template","html","closeNotExistingFiles","oldBranchName","newBranchName","getDeletedFiles","deletedFiles","gitRoot","get","openedFiles","getWorkingSet","ALL_PANES","forEach","dFile","oFile","fullPath","closeFullEditor","ERROR_GETTING_DELETED_FILES","handleEvents","e","stopPropagation","getAllBranches","$input","$select","$opt","remote","newVal","substring","length","$this","this","tracker","newProgressTracker","show","fetchAllRemotes","ERROR_FETCH_REMOTE_INFO","branchName","trim","$option","children","originName","isRemote","track","createBranch","ERROR_CREATE_BRANCH","addClass","removeClass","parent","data","askQuestion","DELETE_LOCAL_BRANCH","format","DELETE_LOCAL_BRANCH_NAME","booleanResponse","response","branchDelete","question","forceBranchDelete","output","GIT_BRANCH_DELETE_SUCCESS","ERROR_BRANCH_DELETE_FORCED","getCurrentBranchName","checkout","ERROR_SWITCHING_BRANCHES","ERROR_GETTING_CURRENT_BRANCH","attachCloseEvents","getCurrentFullEditor","_codeMirror","off","toggleDropdown","closeAll","ERROR_GETTING_BRANCH_LIST","reduce","arr","branch","push","$toggle","marginLeft","parseInt","css","toggleOffset","offset","left","top","outerHeight","appendTo","maxHeight","height","topOffset","position","addPopUp","closeCurrentPopups","handleSelectionEvents","enableSearchFilter","_getHeadFilePath","addHeadToTheFileIndex","resolve","logError","checkBranch","getFileForPath","read","contents","ERROR_READING_GIT_HEAD","m","match","branchInHead","branchInUi","text","refresh","ERROR_PARSING_BRANCH_NAME","getGitRoot","projectRoot","getProjectRoot","isRepositoryRootOrChild","toggle","set","getMergeInfo","mergeInfo","mergeMode","rebaseMode","rebaseHead","rebaseNext","rebaseLast","REBASE_MERGE_MODE","MAX_LEN","tooltip","ON_BRANCH","enable","ERROR_READING_GIT_STATE","ex","contains","disable","init","$html","click","isExtensionActivated","BRACKETS_FILE_CHANGED","file","syncOpenDocuments","execute","BRACKETS_PROJECT_CHANGE","BRACKETS_PROJECT_REFRESH","GIT_ENABLED","GIT_DISABLED"],"mappings":"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","sourcesContent":["define(function (require, exports) {\n\n    var _                       = brackets.getModule(\"thirdparty/lodash\"),\n        CommandManager          = brackets.getModule(\"command/CommandManager\"),\n        Dialogs                 = brackets.getModule(\"widgets/Dialogs\"),\n        EditorManager           = brackets.getModule(\"editor/EditorManager\"),\n        FileSyncManager         = brackets.getModule(\"project/FileSyncManager\"),\n        FileSystem              = brackets.getModule(\"filesystem/FileSystem\"),\n        Menus                   = brackets.getModule(\"command/Menus\"),\n        Mustache                = brackets.getModule(\"thirdparty/mustache/mustache\"),\n        PopUpManager            = brackets.getModule(\"widgets/PopUpManager\"),\n        StringUtils             = brackets.getModule(\"utils/StringUtils\"),\n        DocumentManager         = brackets.getModule(\"document/DocumentManager\"),\n        Strings                 = brackets.getModule(\"strings\"),\n        Metrics                 = brackets.getModule(\"utils/Metrics\"),\n        MainViewManager         = brackets.getModule(\"view/MainViewManager\");\n\n    var Git                     = require(\"src/git/Git\"),\n        Events                  = require(\"src/Events\"),\n        EventEmitter            = require(\"src/EventEmitter\"),\n        ErrorHandler            = require(\"src/ErrorHandler\"),\n        Panel                   = require(\"src/Panel\"),\n        Setup                   = require(\"src/utils/Setup\"),\n        Preferences             = require(\"src/Preferences\"),\n        ProgressDialog          = require(\"src/dialogs/Progress\"),\n        Utils                   = require(\"src/Utils\"),\n        branchesMenuTemplate    = require(\"text!templates/git-branches-menu.html\"),\n        newBranchTemplate       = require(\"text!templates/branch-new-dialog.html\"),\n        mergeBranchTemplate     = require(\"text!templates/branch-merge-dialog.html\");\n\n    var $gitBranchName          = $(null),\n        currentEditor,\n        $dropdown;\n\n    function renderList(branches) {\n        branches = branches.map(function (name) {\n            return {\n                name: name,\n                currentBranch: name.indexOf(\"* \") === 0,\n                canDelete: name !== \"master\"\n            };\n        });\n        var templateVars  = {\n            branchList: _.filter(branches, function (o) { return !o.currentBranch; }),\n            Strings:    Strings\n        };\n        return Mustache.render(branchesMenuTemplate, templateVars);\n    }\n\n    function closeDropdown() {\n        if ($dropdown) {\n            PopUpManager.removePopUp($dropdown);\n        }\n        detachCloseEvents();\n    }\n\n    function doMerge(fromBranch) {\n        Git.getBranches().then(function (branches) {\n\n            var compiledTemplate = Mustache.render(mergeBranchTemplate, {\n                fromBranch: fromBranch,\n                branches: branches,\n                Strings: Strings\n            });\n\n            var dialog  = Dialogs.showModalDialogUsingTemplate(compiledTemplate);\n            var $dialog = dialog.getElement();\n            $dialog.find(\"input\").focus();\n\n            var $toBranch = $dialog.find(\"[name='branch-target']\");\n            var $useRebase = $dialog.find(\"[name='use-rebase']\");\n            var $useNoff = $dialog.find(\"[name='use-noff']\");\n\n            if (fromBranch === \"master\") {\n                $useRebase.prop(\"checked\", true);\n            }\n            if ($toBranch.val() === \"master\") {\n                $useRebase.prop(\"checked\", false).prop(\"disabled\", true);\n            }\n\n            // fill merge message if possible\n            var $mergeMessage = $dialog.find(\"[name='merge-message']\");\n            $mergeMessage.attr(\"placeholder\", \"Merge branch '\" + fromBranch + \"'\");\n            $dialog.find(\".fill-pr\").on(\"click\", function () {\n                var prMsg = \"Merge pull request #??? from \" + fromBranch;\n                $mergeMessage.val(prMsg);\n                $mergeMessage[0].setSelectionRange(prMsg.indexOf(\"???\"), prMsg.indexOf(\"???\") + 3);\n            });\n\n            // can't use rebase and no-ff together so have a change handler for this\n            $useRebase.on(\"change\", function () {\n                var useRebase = $useRebase.prop(\"checked\");\n                $useNoff.prop(\"disabled\", useRebase);\n                if (useRebase) { $useNoff.prop(\"checked\", false); }\n            }).trigger(\"change\");\n\n            dialog.done(function (buttonId) {\n                // right now only merge to current branch without any configuration\n                // later delete merge branch and so ...\n                var useRebase = $useRebase.prop(\"checked\");\n                var useNoff = $useNoff.prop(\"checked\");\n                var mergeMsg = $mergeMessage.val();\n\n                if (buttonId === \"ok\") {\n\n                    if (useRebase) {\n\n                        Git.rebaseInit(fromBranch).catch(function (err) {\n                            Metrics.countEvent(Metrics.EVENT_TYPE.GIT, 'rebase', \"fail\");\n                            throw ErrorHandler.showError(err, Strings.ERROR_REBASE_FAILED);\n                        }).then(function (stdout) {\n                            Metrics.countEvent(Metrics.EVENT_TYPE.GIT, 'rebase', \"success\");\n                            Utils.showOutput(stdout || Strings.GIT_REBASE_SUCCESS, Strings.REBASE_RESULT).finally(function () {\n                                EventEmitter.emit(Events.REFRESH_ALL);\n                            });\n                        }).catch(console.error);\n                    } else {\n\n                        Git.mergeBranch(fromBranch, mergeMsg, useNoff).catch(function (err) {\n                            Metrics.countEvent(Metrics.EVENT_TYPE.GIT, 'merge', \"fail\");\n                            throw ErrorHandler.showError(err, Strings.ERROR_MERGE_FAILED);\n                        }).then(function (stdout) {\n                            Metrics.countEvent(Metrics.EVENT_TYPE.GIT, 'merge', \"success\");\n                            Utils.showOutput(stdout || Strings.GIT_MERGE_SUCCESS, Strings.MERGE_RESULT).finally(function () {\n                                EventEmitter.emit(Events.REFRESH_ALL);\n                            });\n                        }).catch(console.error);\n                    }\n                }\n            });\n        }).catch(err => {\n            console.error(\"Error Getting branches\", err);\n            // we need to strip all user entered info from git thrown exception for get branches which shouldn't fail,\n            // so we throw a blank error for bugsnag\n            throw new Error(\"Failed to get getBranches while doMerge\");\n        });\n    }\n\n    function _reloadBranchSelect($el, branches) {\n        var template = \"{{#branches}}<option value='{{name}}' remote='{{remote}}' \" +\n            \"{{#currentBranch}}selected{{/currentBranch}}>{{name}}</option>{{/branches}}\";\n        var html = Mustache.render(template, { branches: branches });\n        $el.html(html);\n    }\n\n    function closeNotExistingFiles(oldBranchName, newBranchName) {\n        return Git.getDeletedFiles(oldBranchName, newBranchName).then(function (deletedFiles) {\n\n            var gitRoot     = Preferences.get(\"currentGitRoot\"),\n                openedFiles = MainViewManager.getWorkingSet(MainViewManager.ALL_PANES);\n\n            // Close files that does not exists anymore in the new selected branch\n            deletedFiles.forEach(function (dFile) {\n                var oFile = _.find(openedFiles, function (oFile) {\n                    return oFile.fullPath === gitRoot + dFile;\n                });\n                if (oFile) {\n                    DocumentManager.closeFullEditor(oFile);\n                }\n            });\n\n            EventEmitter.emit(Events.REFRESH_ALL);\n\n        }).catch(function (err) {\n            ErrorHandler.showError(err, Strings.ERROR_GETTING_DELETED_FILES);\n        });\n    }\n\n    function handleEvents() {\n        $dropdown.on(\"click\", \"a.git-branch-new\", function (e) {\n            e.stopPropagation();\n            closeDropdown();\n\n            Git.getAllBranches().catch(function (err) {\n                ErrorHandler.showError(err);\n            }).then(function (branches = []) {\n\n                var compiledTemplate = Mustache.render(newBranchTemplate, {\n                    branches: branches,\n                    Strings: Strings\n                });\n\n                var dialog  = Dialogs.showModalDialogUsingTemplate(compiledTemplate);\n\n                var $input  = dialog.getElement().find(\"[name='branch-name']\"),\n                    $select = dialog.getElement().find(\".branchSelect\");\n\n                $select.on(\"change\", function () {\n                    if (!$input.val()) {\n                        var $opt = $select.find(\":selected\"),\n                            remote = $opt.attr(\"remote\"),\n                            newVal = $opt.val();\n                        if (remote) {\n                            newVal = newVal.substring(remote.length + 1);\n                            if (remote !== \"origin\") {\n                                newVal = remote + \"#\" + newVal;\n                            }\n                        }\n                        $input.val(newVal);\n                    }\n                });\n\n                _reloadBranchSelect($select, branches);\n                dialog.getElement().find(\".fetchBranches\").on(\"click\", function () {\n                    var $this = $(this);\n                    const tracker = ProgressDialog.newProgressTracker();\n                    ProgressDialog.show(Git.fetchAllRemotes(tracker), tracker)\n                        .then(function () {\n                            return Git.getAllBranches().then(function (branches) {\n                                $this.prop(\"disabled\", true).attr(\"title\", \"Already fetched\");\n                                _reloadBranchSelect($select, branches);\n                            });\n                        }).catch(function (err) {\n                            throw ErrorHandler.showError(err, Strings.ERROR_FETCH_REMOTE_INFO);\n                        });\n                });\n\n                dialog.getElement().find(\"input\").focus();\n                dialog.done(function (buttonId) {\n                    if (buttonId === \"ok\") {\n\n                        var $dialog     = dialog.getElement(),\n                            branchName  = $dialog.find(\"input[name='branch-name']\").val().trim(),\n                            $option     = $dialog.find(\"select[name='branch-origin']\").children(\"option:selected\"),\n                            originName  = $option.val(),\n                            isRemote    = $option.attr(\"remote\"),\n                            track       = !!isRemote;\n\n                        Git.createBranch(branchName, originName, track).catch(function (err) {\n                            Metrics.countEvent(Metrics.EVENT_TYPE.GIT, 'branch', \"createFail\");\n                            throw ErrorHandler.showError(err, Strings.ERROR_CREATE_BRANCH);\n                        }).then(function () {\n                            Metrics.countEvent(Metrics.EVENT_TYPE.GIT, 'branch', \"create\");\n                            EventEmitter.emit(Events.REFRESH_ALL);\n                        });\n                    }\n                });\n            });\n\n        }).on(\"mouseenter\", \"a\", function () {\n            $(this).addClass(\"selected\");\n        }).on(\"mouseleave\", \"a\", function () {\n            $(this).removeClass(\"selected\");\n        }).on(\"click\", \"a.git-branch-link .trash-icon\", function (e) {\n            e.stopPropagation();\n            closeDropdown();\n            var branchName = $(this).parent().data(\"branch\");\n            Utils.askQuestion(Strings.DELETE_LOCAL_BRANCH,\n                              StringUtils.format(Strings.DELETE_LOCAL_BRANCH_NAME, branchName),\n                              { booleanResponse: true })\n                .then(function (response) {\n                    if (response === true) {\n                        return Git.branchDelete(branchName).catch(function (err) {\n\n                            return Utils.showOutput(err, \"Branch deletion failed\", {\n                                question: \"Do you wish to force branch deletion?\"\n                            }).then(function (response) {\n                                if (response === true) {\n                                    return Git.forceBranchDelete(branchName).then(function (output) {\n                                        Metrics.countEvent(Metrics.EVENT_TYPE.GIT, 'branch', \"delete\");\n                                        return Utils.showOutput(output || Strings.GIT_BRANCH_DELETE_SUCCESS);\n                                    }).catch(function (err) {\n                                        Metrics.countEvent(Metrics.EVENT_TYPE.GIT, 'branch', \"deleteFail\");\n                                        ErrorHandler.showError(err, Strings.ERROR_BRANCH_DELETE_FORCED);\n                                    });\n                                }\n                            });\n\n                        });\n                    }\n                })\n                .catch(function (err) {\n                    ErrorHandler.showError(err);\n                });\n\n        }).on(\"click\", \".merge-branch\", function (e) {\n            e.stopPropagation();\n            closeDropdown();\n            var fromBranch = $(this).parent().data(\"branch\");\n            doMerge(fromBranch);\n        }).on(\"click\", \"a.git-branch-link\", function (e) {\n\n            e.stopPropagation();\n            closeDropdown();\n            var newBranchName = $(this).data(\"branch\");\n\n            Git.getCurrentBranchName().then(function (oldBranchName) {\n                Git.checkout(newBranchName).then(function () {\n                    Metrics.countEvent(Metrics.EVENT_TYPE.GIT, 'branch', \"switch\");\n                    return closeNotExistingFiles(oldBranchName, newBranchName);\n                }).catch(function (err) {\n                    Metrics.countEvent(Metrics.EVENT_TYPE.GIT, 'branch', \"switchFail\");\n                    ErrorHandler.showError(err, Strings.ERROR_SWITCHING_BRANCHES);\n                });\n            }).catch(function (err) {\n                Metrics.countEvent(Metrics.EVENT_TYPE.GIT, 'branch', \"switchFail\");\n                ErrorHandler.showError(err, Strings.ERROR_GETTING_CURRENT_BRANCH);\n            });\n\n        });\n    }\n\n    function attachCloseEvents() {\n        $(\"html\").on(\"click\", closeDropdown);\n        $(\"#project-files-container\").on(\"scroll\", closeDropdown);\n        $(\"#titlebar .nav\").on(\"click\", closeDropdown);\n\n        currentEditor = EditorManager.getCurrentFullEditor();\n        if (currentEditor) {\n            currentEditor._codeMirror.on(\"focus\", closeDropdown);\n        }\n\n        // $(window).on(\"keydown\", keydownHook);\n    }\n\n    function detachCloseEvents() {\n        $(\"html\").off(\"click\", closeDropdown);\n        $(\"#project-files-container\").off(\"scroll\", closeDropdown);\n        $(\"#titlebar .nav\").off(\"click\", closeDropdown);\n\n        if (currentEditor) {\n            currentEditor._codeMirror.off(\"focus\", closeDropdown);\n        }\n\n        // $(window).off(\"keydown\", keydownHook);\n\n        $dropdown = null;\n    }\n\n    function toggleDropdown(e) {\n        e.stopPropagation();\n\n        // If the dropdown is already visible, close it\n        if ($dropdown) {\n            closeDropdown();\n            return;\n        }\n\n        Menus.closeAll();\n\n        Git.getBranches().catch(function (err) {\n            ErrorHandler.showError(err, Strings.ERROR_GETTING_BRANCH_LIST);\n        }).then(function (branches = []) {\n            branches = branches.reduce(function (arr, branch) {\n                if (!branch.currentBranch && !branch.remote) {\n                    arr.push(branch.name);\n                }\n                return arr;\n            }, []);\n\n            $dropdown = $(renderList(branches));\n            const $toggle = $(\"#git-branch-dropdown-toggle\");\n            // two margins to account for the preceding project dropdown as well\n            const marginLeft = (parseInt($toggle.css(\"margin-left\"), 10) * 2) || 0;\n\n            const toggleOffset = $toggle.offset();\n\n            $dropdown\n                .css({\n                    left: toggleOffset.left - marginLeft + 3,\n                    top: toggleOffset.top + $toggle.outerHeight() - 3\n                })\n                .appendTo($(\"body\"));\n\n            // fix so it doesn't overflow the screen\n            var maxHeight = $dropdown.parent().height(),\n                height = $dropdown.height(),\n                topOffset = $dropdown.position().top;\n            if (height + topOffset >= maxHeight - 10) {\n                $dropdown.css(\"bottom\", \"10px\");\n            }\n\n            PopUpManager.addPopUp($dropdown, detachCloseEvents, true, {closeCurrentPopups: true});\n            PopUpManager.handleSelectionEvents($dropdown, {enableSearchFilter: true});\n            attachCloseEvents();\n            handleEvents();\n        });\n    }\n\n    function _getHeadFilePath() {\n        return Preferences.get(\"currentGitRoot\") + \".git/HEAD\";\n    }\n\n    function addHeadToTheFileIndex() {\n        FileSystem.resolve(_getHeadFilePath(), function (err) {\n            if (err) {\n                ErrorHandler.logError(err, \"Resolving .git/HEAD file failed\");\n                return;\n            }\n        });\n    }\n\n    function checkBranch() {\n        FileSystem.getFileForPath(_getHeadFilePath()).read(function (err, contents) {\n            if (err) {\n                ErrorHandler.showError(err, Strings.ERROR_READING_GIT_HEAD);\n                return;\n            }\n\n            contents = contents.trim();\n\n            var m = contents.match(/^ref:\\s+refs\\/heads\\/(\\S+)/);\n\n            // alternately try to parse the hash\n            if (!m) { m = contents.match(/^([a-f0-9]{40})$/); }\n\n            if (!m) {\n                ErrorHandler.showError(new Error(StringUtils.format(Strings.ERROR_PARSING_BRANCH_NAME, contents)));\n                return;\n            }\n\n            var branchInHead  = m[1],\n                branchInUi    = $gitBranchName.text();\n\n            if (branchInHead !== branchInUi) {\n                refresh();\n            }\n        });\n    }\n\n    function refresh() {\n        if ($gitBranchName.length === 0) { return; }\n\n        // show info that branch is refreshing currently\n        $gitBranchName\n            .text(\"\\u2026\")\n            .parent()\n                .show();\n\n        return Git.getGitRoot().then(function (gitRoot) {\n            var projectRoot             = Utils.getProjectRoot(),\n                isRepositoryRootOrChild = gitRoot && projectRoot.indexOf(gitRoot) === 0;\n\n            $gitBranchName.parent().toggle(isRepositoryRootOrChild);\n\n            if (!isRepositoryRootOrChild) {\n                Preferences.set(\"currentGitRoot\", projectRoot);\n                Preferences.set(\"currentGitSubfolder\", \"\");\n\n                $gitBranchName\n                    .off(\"click\")\n                    .text(\"not a git repo\");\n                Panel.disable(\"not-repo\");\n\n                return;\n            }\n\n            Preferences.set(\"currentGitRoot\", gitRoot);\n            Preferences.set(\"currentGitSubfolder\", projectRoot.substring(gitRoot.length));\n\n            // we are in a .git repo so read the head\n            addHeadToTheFileIndex();\n\n            return Git.getCurrentBranchName().then(function (branchName) {\n\n                Git.getMergeInfo().then(function (mergeInfo) {\n\n                    if (mergeInfo.mergeMode) {\n                        branchName += \"|MERGING\";\n                    }\n\n                    if (mergeInfo.rebaseMode) {\n                        if (mergeInfo.rebaseHead) {\n                            branchName = mergeInfo.rebaseHead;\n                        }\n                        branchName += \"|REBASE\";\n                        if (mergeInfo.rebaseNext && mergeInfo.rebaseLast) {\n                            branchName += \"(\" + mergeInfo.rebaseNext + \"/\" + mergeInfo.rebaseLast + \")\";\n                        }\n                    }\n\n                    EventEmitter.emit(Events.REBASE_MERGE_MODE, mergeInfo.rebaseMode, mergeInfo.mergeMode);\n\n                    var MAX_LEN = 18;\n\n                    const tooltip = StringUtils.format(Strings.ON_BRANCH, branchName);\n                    const html = `<i class=\"fas fa-code-branch\"></i> ${\n                        branchName.length > MAX_LEN ? branchName.substring(0, MAX_LEN) + \"\\u2026\" : branchName\n                    }`;\n                    $gitBranchName\n                        .html(html)\n                        .attr(\"title\", tooltip)\n                        .off(\"click\")\n                        .on(\"click\", toggleDropdown);\n                    Panel.enable();\n\n                }).catch(function (err) {\n                    ErrorHandler.showError(err, Strings.ERROR_READING_GIT_STATE);\n                });\n\n            }).catch(function (ex) {\n                if (ErrorHandler.contains(ex, \"unknown revision\")) {\n                    $gitBranchName\n                        .off(\"click\")\n                        .text(\"no branch\");\n                    Panel.enable();\n                } else {\n                    throw ex;\n                }\n            });\n        }).catch(function (err) {\n            ErrorHandler.showError(err);\n        });\n    }\n\n    function init() {\n        // Add branch name to project tree\n        const $html = $(`<div id='git-branch-dropdown-toggle' class='btn-alt-quiet'>\n            <span id='git-branch'>\n                <i class=\"fas fa-code-branch\"></i>\n            </span>\n            <span class=\"dropdown-arrow\"></span>\n            </div>`);\n        $html.appendTo($(\"#project-files-header\"));\n        $gitBranchName = $(\"#git-branch\");\n        $html.on(\"click\", function () {\n            $gitBranchName.click();\n            return false;\n        });\n        if(Setup.isExtensionActivated()){\n            refresh();\n            return;\n        }\n        $(\"#git-branch-dropdown-toggle\").addClass(\"forced-inVisible\");\n    }\n\n    EventEmitter.on(Events.BRACKETS_FILE_CHANGED, function (file) {\n        if (file.fullPath === _getHeadFilePath()) {\n            checkBranch();\n        }\n    });\n\n    EventEmitter.on(Events.REFRESH_ALL, function () {\n        FileSyncManager.syncOpenDocuments();\n        CommandManager.execute(\"file.refresh\");\n        refresh();\n    });\n\n    EventEmitter.on(Events.BRACKETS_PROJECT_CHANGE, function () {\n        refresh();\n    });\n\n    EventEmitter.on(Events.BRACKETS_PROJECT_REFRESH, function () {\n        refresh();\n    });\n\n    EventEmitter.on(Events.GIT_ENABLED, function () {\n        $(\"#git-branch-dropdown-toggle\").removeClass(\"forced-inVisible\");\n    });\n    EventEmitter.on(Events.GIT_DISABLED, function () {\n        $(\"#git-branch-dropdown-toggle\").addClass(\"forced-inVisible\");\n    });\n\n    exports.init    = init;\n    exports.refresh = refresh;\n\n});\n"],"file":"Branch.js"}