define(function(require,exports){var _=brackets.getModule("thirdparty/lodash"),CommandManager=brackets.getModule("command/CommandManager"),Dialogs=brackets.getModule("widgets/Dialogs"),EditorManager=brackets.getModule("editor/EditorManager"),FileSyncManager=brackets.getModule("project/FileSyncManager"),FileSystem=brackets.getModule("filesystem/FileSystem"),Menus=brackets.getModule("command/Menus"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),PopUpManager=brackets.getModule("widgets/PopUpManager"),StringUtils=brackets.getModule("utils/StringUtils"),DocumentManager=brackets.getModule("document/DocumentManager"),Strings=brackets.getModule("strings"),Metrics=brackets.getModule("utils/Metrics"),MainViewManager=brackets.getModule("view/MainViewManager"),Git=require("src/git/Git"),Events=require("src/Events"),EventEmitter=require("src/EventEmitter"),ErrorHandler=require("src/ErrorHandler"),Panel=require("src/Panel"),Setup=require("src/utils/Setup"),Preferences=require("src/Preferences"),ProgressDialog=require("src/dialogs/Progress"),Utils=require("src/Utils"),branchesMenuTemplate=require("text!templates/git-branches-menu.html"),newBranchTemplate=require("text!templates/branch-new-dialog.html"),mergeBranchTemplate=require("text!templates/branch-merge-dialog.html"),$gitBranchName=$(null),currentEditor,$dropdown;function renderList(branches){branches=branches.map(function(name){return{name:name,currentBranch:0===name.indexOf("* "),canDelete:"master"!==name}});var templateVars={branchList:_.filter(branches,function(o){return!o.currentBranch}),Strings:Strings};return Mustache.render(branchesMenuTemplate,templateVars)}function closeDropdown(){$dropdown&&PopUpManager.removePopUp($dropdown),detachCloseEvents()}function doMerge(fromBranch){Git.getBranches().then(function(branches){var compiledTemplate=Mustache.render(mergeBranchTemplate,{fromBranch:fromBranch,branches:branches,Strings:Strings}),dialog=Dialogs.showModalDialogUsingTemplate(compiledTemplate),$dialog=dialog.getElement();$dialog.find("input").focus();var $toBranch=$dialog.find("[name='branch-target']"),$useRebase=$dialog.find("[name='use-rebase']"),$useNoff=$dialog.find("[name='use-noff']");"master"===fromBranch&&$useRebase.prop("checked",!0),"master"===$toBranch.val()&&$useRebase.prop("checked",!1).prop("disabled",!0);var $mergeMessage=$dialog.find("[name='merge-message']");$mergeMessage.attr("placeholder","Merge branch '"+fromBranch+"'"),$dialog.find(".fill-pr").on("click",function(){var prMsg="Merge pull request #??? from "+fromBranch;$mergeMessage.val(prMsg),$mergeMessage[0].setSelectionRange(prMsg.indexOf("???"),prMsg.indexOf("???")+3)}),$useRebase.on("change",function(){var useRebase=$useRebase.prop("checked");$useNoff.prop("disabled",useRebase),useRebase&&$useNoff.prop("checked",!1)}).trigger("change"),dialog.done(function(buttonId){var useRebase=$useRebase.prop("checked"),useNoff=$useNoff.prop("checked"),mergeMsg=$mergeMessage.val();"ok"===buttonId&&(useRebase?Git.rebaseInit(fromBranch).catch(function(err){throw Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"rebase","fail"),ErrorHandler.showError(err,Strings.ERROR_REBASE_FAILED)}).then(function(stdout){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"rebase","success"),Utils.showOutput(stdout||Strings.GIT_REBASE_SUCCESS,Strings.REBASE_RESULT).finally(function(){EventEmitter.emit(Events.REFRESH_ALL)})}).catch(console.error):Git.mergeBranch(fromBranch,mergeMsg,useNoff).catch(function(err){throw Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"merge","fail"),ErrorHandler.showError(err,Strings.ERROR_MERGE_FAILED)}).then(function(stdout){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"merge","success"),Utils.showOutput(stdout||Strings.GIT_MERGE_SUCCESS,Strings.MERGE_RESULT).finally(function(){EventEmitter.emit(Events.REFRESH_ALL)})}).catch(console.error))})}).catch(err=>{throw console.error("Error Getting branches",err),new Error("Failed to get getBranches while doMerge")})}function _reloadBranchSelect($el,branches){var template="{{#branches}}<option value='{{name}}' remote='{{remote}}' {{#currentBranch}}selected{{/currentBranch}}>{{name}}</option>{{/branches}}",html=Mustache.render(template,{branches:branches});$el.html(html)}function closeNotExistingFiles(oldBranchName,newBranchName){return Git.getDeletedFiles(oldBranchName,newBranchName).then(function(deletedFiles){var gitRoot=Preferences.get("currentGitRoot"),openedFiles=MainViewManager.getWorkingSet(MainViewManager.ALL_PANES);deletedFiles.forEach(function(dFile){var oFile=_.find(openedFiles,function(oFile){return oFile.fullPath===gitRoot+dFile});oFile&&DocumentManager.closeFullEditor(oFile)}),EventEmitter.emit(Events.REFRESH_ALL)}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_GETTING_DELETED_FILES)})}function handleEvents(){$dropdown.on("click","a.git-branch-new",function(e){e.stopPropagation(),closeDropdown(),Git.getAllBranches().catch(function(err){ErrorHandler.showError(err)}).then(function(branches=[]){var compiledTemplate=Mustache.render(newBranchTemplate,{branches:branches,Strings:Strings}),dialog=Dialogs.showModalDialogUsingTemplate(compiledTemplate),$input=dialog.getElement().find("[name='branch-name']"),$select=dialog.getElement().find(".branchSelect");$select.on("change",function(){if(!$input.val()){var $opt=$select.find(":selected"),remote=$opt.attr("remote"),newVal=$opt.val();remote&&(newVal=newVal.substring(remote.length+1),"origin"!==remote&&(newVal=remote+"#"+newVal)),$input.val(newVal)}}),_reloadBranchSelect($select,branches),dialog.getElement().find(".fetchBranches").on("click",function(){var $this=$(this);const tracker=ProgressDialog.newProgressTracker();ProgressDialog.show(Git.fetchAllRemotes(tracker),tracker).then(function(){return Git.getAllBranches().then(function(branches){$this.prop("disabled",!0).attr("title","Already fetched"),_reloadBranchSelect($select,branches)})}).catch(function(err){throw ErrorHandler.showError(err,Strings.ERROR_FETCH_REMOTE_INFO)})}),dialog.getElement().find("input").focus(),dialog.done(function(buttonId){if("ok"===buttonId){var $dialog=dialog.getElement(),branchName=$dialog.find("input[name='branch-name']").val().trim(),$option=$dialog.find("select[name='branch-origin']").children("option:selected"),originName=$option.val(),isRemote,track=!!$option.attr("remote");Git.createBranch(branchName,originName,track).catch(function(err){throw Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"branch","createFail"),ErrorHandler.showError(err,Strings.ERROR_CREATE_BRANCH)}).then(function(){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"branch","create"),EventEmitter.emit(Events.REFRESH_ALL)})}})})}).on("mouseenter","a",function(){$(this).addClass("selected")}).on("mouseleave","a",function(){$(this).removeClass("selected")}).on("click","a.git-branch-link .trash-icon",function(e){e.stopPropagation(),closeDropdown();var branchName=$(this).parent().data("branch");Utils.askQuestion(Strings.DELETE_LOCAL_BRANCH,StringUtils.format(Strings.DELETE_LOCAL_BRANCH_NAME,branchName),{booleanResponse:!0}).then(function(response){if(!0===response)return Git.branchDelete(branchName).catch(function(err){return Utils.showOutput(err,"Branch deletion failed",{question:"Do you wish to force branch deletion?"}).then(function(response){if(!0===response)return Git.forceBranchDelete(branchName).then(function(output){return Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"branch","delete"),Utils.showOutput(output||Strings.GIT_BRANCH_DELETE_SUCCESS)}).catch(function(err){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"branch","deleteFail"),ErrorHandler.showError(err,Strings.ERROR_BRANCH_DELETE_FORCED)})})})}).catch(function(err){ErrorHandler.showError(err)})}).on("click",".merge-branch",function(e){var fromBranch;e.stopPropagation(),closeDropdown(),doMerge($(this).parent().data("branch"))}).on("click","a.git-branch-link",function(e){e.stopPropagation(),closeDropdown();var newBranchName=$(this).data("branch");Git.getCurrentBranchName().then(function(oldBranchName){Git.checkout(newBranchName).then(function(){return Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"branch","switch"),closeNotExistingFiles(oldBranchName,newBranchName)}).catch(function(err){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"branch","switchFail"),ErrorHandler.showError(err,Strings.ERROR_SWITCHING_BRANCHES)})}).catch(function(err){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"branch","switchFail"),ErrorHandler.showError(err,Strings.ERROR_GETTING_CURRENT_BRANCH)})})}function attachCloseEvents(){$("html").on("click",closeDropdown),$("#project-files-container").on("scroll",closeDropdown),$("#titlebar .nav").on("click",closeDropdown),(currentEditor=EditorManager.getCurrentFullEditor())&&currentEditor._codeMirror.on("focus",closeDropdown)}function detachCloseEvents(){$("html").off("click",closeDropdown),$("#project-files-container").off("scroll",closeDropdown),$("#titlebar .nav").off("click",closeDropdown),currentEditor&&currentEditor._codeMirror.off("focus",closeDropdown),$dropdown=null}function toggleDropdown(e){e.stopPropagation(),$dropdown?closeDropdown():(Menus.closeAll(),Git.getBranches().catch(function(err){ErrorHandler.showError(err,Strings.ERROR_GETTING_BRANCH_LIST)}).then(function(branches=[]){branches=branches.reduce(function(arr,branch){return branch.currentBranch||branch.remote||arr.push(branch.name),arr},[]),$dropdown=$(renderList(branches));const $toggle=$("#git-branch-dropdown-toggle"),marginLeft=2*parseInt($toggle.css("margin-left"),10)||0,toggleOffset=$toggle.offset();$dropdown.css({left:toggleOffset.left-marginLeft+3,top:toggleOffset.top+$toggle.outerHeight()-3}).appendTo($("body"));var maxHeight=$dropdown.parent().height(),height,topOffset;$dropdown.height()+$dropdown.position().top>=maxHeight-10&&$dropdown.css("bottom","10px"),PopUpManager.addPopUp($dropdown,detachCloseEvents,!0,{closeCurrentPopups:!0}),PopUpManager.handleSelectionEvents($dropdown,{enableSearchFilter:!0}),attachCloseEvents(),handleEvents()}))}function _getHeadFilePath(){return Preferences.get("currentGitRoot")+".git/HEAD"}function addHeadToTheFileIndex(){FileSystem.resolve(_getHeadFilePath(),function(err){err&&ErrorHandler.logError(err,"Resolving .git/HEAD file failed")})}function checkBranch(){FileSystem.getFileForPath(_getHeadFilePath()).read(function(err,contents){if(err)ErrorHandler.showError(err,Strings.ERROR_READING_GIT_HEAD);else{var m=(contents=contents.trim()).match(/^ref:\s+refs\/heads\/(\S+)/),branchInHead,branchInUi;if(m||(m=contents.match(/^([a-f0-9]{40})$/)),m)m[1]!==$gitBranchName.text()&&refresh();else ErrorHandler.showError(new Error(StringUtils.format(Strings.ERROR_PARSING_BRANCH_NAME,contents)))}})}function refresh(){if(0!==$gitBranchName.length)return $gitBranchName.text("…").parent().show(),Git.getGitRoot().then(function(gitRoot){var projectRoot=Utils.getProjectRoot(),isRepositoryRootOrChild=gitRoot&&0===projectRoot.indexOf(gitRoot);return $gitBranchName.parent().toggle(isRepositoryRootOrChild),isRepositoryRootOrChild?(Preferences.set("currentGitRoot",gitRoot),Preferences.set("currentGitSubfolder",projectRoot.substring(gitRoot.length)),addHeadToTheFileIndex(),Git.getCurrentBranchName().then(function(branchName){Git.getMergeInfo().then(function(mergeInfo){mergeInfo.mergeMode&&(branchName+="|MERGING"),mergeInfo.rebaseMode&&(mergeInfo.rebaseHead&&(branchName=mergeInfo.rebaseHead),branchName+="|REBASE",mergeInfo.rebaseNext&&mergeInfo.rebaseLast&&(branchName+="("+mergeInfo.rebaseNext+"/"+mergeInfo.rebaseLast+")")),EventEmitter.emit(Events.REBASE_MERGE_MODE,mergeInfo.rebaseMode,mergeInfo.mergeMode);var MAX_LEN=18;const tooltip=StringUtils.format(Strings.ON_BRANCH,branchName),html=`<i class="fas fa-code-branch"></i> ${branchName.length>18?branchName.substring(0,18)+"…":branchName}`;$gitBranchName.html(html).attr("title",tooltip).off("click").on("click",toggleDropdown),Panel.enable()}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_READING_GIT_STATE)})}).catch(function(ex){if(!ErrorHandler.contains(ex,"unknown revision"))throw ex;$gitBranchName.off("click").text("no branch"),Panel.enable()})):(Preferences.set("currentGitRoot",projectRoot),Preferences.set("currentGitSubfolder",""),$gitBranchName.off("click").text("not a git repo"),void Panel.disable("not-repo"))}).catch(function(err){ErrorHandler.showError(err)})}function init(){const $html=$("<div id='git-branch-dropdown-toggle' class='btn-alt-quiet'>\n            <span id='git-branch'>\n                <i class=\"fas fa-code-branch\"></i>\n            </span>\n            <span class=\"dropdown-arrow\"></span>\n            </div>");$html.appendTo($("#project-files-header")),$gitBranchName=$("#git-branch"),$html.on("click",function(){return $gitBranchName.click(),!1}),Setup.isExtensionActivated()?refresh():$("#git-branch-dropdown-toggle").addClass("forced-inVisible")}EventEmitter.on(Events.BRACKETS_FILE_CHANGED,function(file){file.fullPath===_getHeadFilePath()&&checkBranch()}),EventEmitter.on(Events.REFRESH_ALL,function(){FileSyncManager.syncOpenDocuments(),CommandManager.execute("file.refresh"),refresh()}),EventEmitter.on(Events.BRACKETS_PROJECT_CHANGE,function(){refresh()}),EventEmitter.on(Events.BRACKETS_PROJECT_REFRESH,function(){refresh()}),EventEmitter.on(Events.GIT_ENABLED,function(){$("#git-branch-dropdown-toggle").removeClass("forced-inVisible")}),EventEmitter.on(Events.GIT_DISABLED,function(){$("#git-branch-dropdown-toggle").addClass("forced-inVisible")}),exports.init=init,exports.refresh=refresh});
//# sourceMappingURL=Branch.js.map
