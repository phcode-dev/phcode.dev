define(function(require,exports){const _=brackets.getModule("thirdparty/lodash"),FileSystem=brackets.getModule("filesystem/FileSystem"),Strings=brackets.getModule("strings"),FileUtils=brackets.getModule("file/FileUtils"),Cli=require("src/Cli"),ErrorHandler=require("src/ErrorHandler"),Events=require("src/Events"),EventEmitter=require("src/EventEmitter"),ExpectedError=require("src/ExpectedError"),Preferences=require("src/Preferences"),Utils=require("src/Utils");let _gitPath=null,_gitQueue=[],_gitQueueBusy=!1,lastGitStatusResults;var FILE_STATUS={STAGED:"STAGED",UNMODIFIED:"UNMODIFIED",IGNORED:"IGNORED",UNTRACKED:"UNTRACKED",MODIFIED:"MODIFIED",ADDED:"ADDED",DELETED:"DELETED",RENAMED:"RENAMED",COPIED:"COPIED",UNMERGED:"UNMERGED"},EMPTY_TREE="4b825dc642cb6eb9a060e54bf8d69288fbee4904";function getGitPath(){return _gitPath||(_gitPath=Preferences.get("gitPath"))}function setGitPath(path){!0===path&&(path="git"),Preferences.set("gitPath",path),_gitPath=path}function strEndsWith(subjectString,searchString,position){(void 0===position||position>subjectString.length)&&(position=subjectString.length),position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return-1!==lastIndex&&lastIndex===position}function _processQueue(){if(_gitQueueBusy)return;if(0===_gitQueue.length)return void(_gitQueueBusy=!1);const item=_gitQueue.shift(),resolve=item[0],reject=item[1],args=item[2],opts=item[3];!0!==opts.nonblocking&&(_gitQueueBusy=!0),Cli.spawnCommand(getGitPath(),args,opts).then(function(r){resolve(r)}).catch(function(e){const call="call: git "+args.join(" ");e.stack=[call,e.stack].join("\n"),reject(e)}).finally(function(){!0!==opts.nonblocking&&(_gitQueueBusy=!1),_processQueue()})}function git(args,opts){return new Promise((resolve,reject)=>{_gitQueue.push([resolve,reject,args||[],opts||{}]),setTimeout(_processQueue)})}function setUpstreamBranch(remoteName,remoteBranch,progressTracker){if(!remoteName)throw new TypeError("remoteName argument is missing!");if(!remoteBranch)throw new TypeError("remoteBranch argument is missing!");return git(["branch","--no-color","-u",remoteName+"/"+remoteBranch],{progressTracker:progressTracker})}function branchDelete(branchName,progressTracker){return git(["branch","--no-color","-d",branchName],{progressTracker:progressTracker})}function forceBranchDelete(branchName,progressTracker){return git(["branch","--no-color","-D",branchName],{progressTracker:progressTracker})}function getBranches(moreArgs,progressTracker){var args=["branch","--no-color"];return moreArgs&&(args=args.concat(moreArgs)),git(args,{progressTracker:progressTracker}).then(function(stdout){return stdout?stdout.split("\n").reduce(function(arr,l){var name=l.trim(),currentBranch=!1,remote=null,sortPrefix="";if(-1!==name.indexOf("->"))return arr;0===name.indexOf("* ")&&(name=name.substring(2),currentBranch=!0),0===name.indexOf("remotes/")&&(remote=(name=name.substring("remotes/".length)).substring(0,name.indexOf("/")));var sortName=name.toLowerCase();return remote&&(sortName=sortName.substring(remote.length+1)),-1!==sortName.indexOf("#")&&(sortPrefix=sortName.slice(0,sortName.indexOf("#"))),arr.push({name:name,sortPrefix:sortPrefix,sortName:sortName,currentBranch:currentBranch,remote:remote}),arr},[]):[]})}function getAllBranches(progressTracker){return getBranches(["-a"],progressTracker)}function repositoryNotFoundHandler(err){var m=ErrorHandler.matches(err,/Repository (.*) not found$/gim);if(m)throw new ExpectedError(m[0]);throw err}function fetchRemote(remote,progressTracker){return git(["fetch","--progress",remote],{progressTracker:progressTracker,timeout:!1}).catch(repositoryNotFoundHandler)}function fetchAllRemotes(progressTracker){return git(["fetch","--progress","--all"],{progressTracker:progressTracker,timeout:!1}).catch(repositoryNotFoundHandler)}function getRemotes(){return git(["remote","-v"]).then(function(stdout){return stdout?_.uniq(stdout.replace(/\((push|fetch)\)/g,"").split("\n")).map(function(l){var s=l.trim().split("\t");return{name:s[0],url:s[1]}}):[]})}function createRemote(name,url){return git(["remote","add",name,url]).then(function(){return!0})}function deleteRemote(name){return git(["remote","rm",name]).then(function(){return!0})}function mergeRemote(remote,branch,ffOnly,noCommit,options={}){var args=["merge"];ffOnly&&args.push("--ff-only"),noCommit&&args.push("--no-commit","--no-ff"),args.push(remote+"/"+branch);var readMergeMessage=function(){return Utils.loadPathContent(Preferences.get("currentGitRoot")+"/.git/MERGE_MSG").then(function(msg){return msg})};return git(args,{progressTracker:options.progressTracker}).then(function(stdout){return stdout||readMergeMessage().then(function(msg){return msg||"Remote branch "+branch+" from "+remote+" was merged to current branch"})}).catch(function(error){return readMergeMessage().then(function(msg){if(msg)return msg;throw error})})}function rebaseRemote(remote,branch,progressTracker){return git(["rebase",remote+"/"+branch],{progressTracker:progressTracker})}function resetRemote(remote,branch,progressTracker){return git(["reset","--soft",remote+"/"+branch],{progressTracker:progressTracker}).then(function(stdout){return stdout||"Current branch was resetted to branch "+branch+" from "+remote})}function mergeBranch(branchName,mergeMessage,useNoff){var args=["merge"];return useNoff&&args.push("--no-ff"),mergeMessage&&mergeMessage.trim()&&args.push("-m",mergeMessage),args.push(branchName),git(args)}function push(remoteName,remoteBranch,additionalArgs,progressTracker){if(!remoteName)throw new TypeError("remoteName argument is missing!");var args=["push","--porcelain","--progress"];return Array.isArray(additionalArgs)&&(args=args.concat(additionalArgs)),args.push(remoteName),remoteBranch&&Preferences.get("gerritPushref")?getConfig("gerrit.pushref").then(function(strGerritEnabled){return"true"===strGerritEnabled?args.push("HEAD:refs/for/"+remoteBranch):args.push(remoteBranch),doPushWithArgs(args,progressTracker)}):(remoteBranch&&args.push(remoteBranch),doPushWithArgs(args,progressTracker))}function doPushWithArgs(args,progressTracker){return git(args,{progressTracker:progressTracker}).catch(repositoryNotFoundHandler).then(function(stdout){for(var lines=stdout.split("\n");lines.length>0&&null===lines[0].match(/^To/);)lines.shift();var retObj={},lineTwo=lines[1].split("\t");switch(retObj.remoteUrl=lines[0].trim().split(" ")[1],retObj.flag=lineTwo[0],retObj.from=lineTwo[1].split(":")[0],retObj.to=lineTwo[1].split(":")[1],retObj.summary=lineTwo[2],retObj.status=lines[2],retObj.flag){case" ":retObj.flagDescription=Strings.GIT_PUSH_SUCCESS_MSG;break;case"+":retObj.flagDescription=Strings.GIT_PUSH_FORCE_UPDATED_MSG;break;case"-":retObj.flagDescription=Strings.GIT_PUSH_DELETED_MSG;break;case"*":retObj.flagDescription=Strings.GIT_PUSH_NEW_REF_MSG;break;case"!":retObj.flagDescription=Strings.GIT_PUSH_REJECTED_MSG;break;case"=":retObj.flagDescription=Strings.GIT_PUSH_UP_TO_DATE_MSG;break;default:retObj.flagDescription="Unknown push flag received: "+retObj.flag}return retObj})}function getCurrentBranchName(){return git(["branch","--no-color"]).then(function(stdout){var branchName=_.find(stdout.split("\n"),function(l){return"*"===l[0]});if(branchName){var m=(branchName=branchName.substring(1).trim()).match(/^\(.*\s(\S+)\)$/);return m?m[1]:branchName}return stdout.match(/^\s*$/)?(EventEmitter.emit(Events.GIT_NO_BRANCH_EXISTS),"master"):git(["log","--pretty=format:%H %d","-1"]).then(function(stdout){var m=stdout.trim().match(/^(\S+)\s+\((.*)\)$/),hash=m[1].substring(0,20);return m[2].split(",").forEach(function(info){if("HEAD"!==(info=info.trim())){var m=info.match(/^tag:(.+)$/);hash=m?m[1].trim():info}}),hash})})}function getCurrentUpstreamBranch(){return git(["rev-parse","--abbrev-ref","--symbolic-full-name","@{u}"]).catch(function(){return null})}function getDeletedFiles(oldBranch,newBranch){return git(["diff","--no-ext-diff","--name-status",oldBranch+".."+newBranch]).then(function(stdout){var regex=/^D/;return stdout.split("\n").reduce(function(arr,row){return regex.test(row)&&arr.push(row.substring(1).trim()),arr},[])})}function getConfig(key){return git(["config",key.replace(/\s/g,"")])}function setConfig(key,value,allowGlobal){return git(["config",key=key.replace(/\s/g,""),value]).catch(function(err){if(allowGlobal&&ErrorHandler.contains(err,"No such file or directory"))return git(["config","--global",key,value]);throw err})}function getHistory(branch,skipCommits,file){var separator="_._",newline="_.nw._",format=["%h","%H","%an","%aI","%ae","%s","%b","%d"].join("_._")+newline,args=["log","-100","--date=iso"];return skipCommits&&args.push("--skip="+skipCommits),args.push("--format="+format,branch,"--"),file&&args.push(file),git(args).then(function(stdout){return(stdout=stdout.substring(0,stdout.length-newline.length))?stdout.split(newline).map(function(line){var data=line.trim().split("_._"),commit={};if(commit.hashShort=data[0],commit.hash=data[1],commit.author=data[2],commit.date=data[3],commit.email=data[4],commit.subject=data[5],commit.body=data[6],data[7]){var tags=data[7],regex=new RegExp("tag: ([^,|)]+)","g");for(var key in tags=tags.match(regex))tags[key]&&tags[key].replace&&(tags[key]=tags[key].replace("tag:",""));commit.tags=tags}return commit}):[]})}function init(){return git(["init"])}function clone(remoteGitUrl,destinationFolder,progressTracker){return git(["clone",remoteGitUrl,destinationFolder,"--progress"],{progressTracker:progressTracker,timeout:!1})}function stage(fileOrFiles,updateIndex){var args=["add"];return updateIndex&&args.push("-u"),git(args.concat("--",fileOrFiles))}function stageAll(){return git(["add","--all"])}function commit(message,amend,noVerify,progressTracker){var lines=message.split("\n"),args=["commit"];return amend&&args.push("--amend","--reset-author"),noVerify&&args.push("--no-verify"),1===lines.length?(args.push("-m",message),git(args,{progressTracker:progressTracker})):new Promise(function(resolve,reject){var fileEntry=FileSystem.getFileForPath(Preferences.get("currentGitRoot")+".phoenixGitTemp");jsPromise(FileUtils.writeText(fileEntry,message)).then(function(){return args.push("-F",".phoenixGitTemp"),git(args,{progressTracker:progressTracker})}).then(function(res){fileEntry.unlink(function(){resolve(res)})}).catch(function(err){fileEntry.unlink(function(){reject(err)})})})}function reset(type,hash){var args=["reset",type||"--mixed"];return hash&&args.push(hash,"--"),git(args)}function unstage(file){return git(["reset","--",file])}function checkout(hash){return git(["checkout",hash],{timeout:!1})}function createBranch(branchName,originBranch,trackOrigin){var args=["checkout","-b",branchName];return originBranch&&(trackOrigin&&args.push("--track"),args.push(originBranch)),git(args)}function _isquoted(str){return'"'===str[0]&&'"'===str[str.length-1]}function _unquote(str){return str.substring(1,str.length-1)}function _isescaped(str){return/\\[0-9]{3}/.test(str)}function status(type){return git(["status","-u","--porcelain"]).then(function(stdout){if(!stdout)return[];var currentSubFolder=Preferences.get("currentGitSubfolder"),isEscaped=!1,needReset=[],results=[],lines;return stdout.split("\n").forEach(function(line){var statusStaged=line.substring(0,1),statusUnstaged=line.substring(1,2),status=[],file=line.substring(3);if(_isquoted(file)&&_isescaped(file=_unquote(file))&&(isEscaped=!0)," "===statusStaged||" "===statusUnstaged||"?"===statusStaged||"?"===statusUnstaged){var statusChar;switch(" "!==statusStaged&&"?"!==statusStaged?(status.push(FILE_STATUS.STAGED),statusChar=statusStaged):statusChar=statusUnstaged,statusChar){case" ":status.push(FILE_STATUS.UNMODIFIED);break;case"!":status.push(FILE_STATUS.IGNORED);break;case"?":status.push(FILE_STATUS.UNTRACKED);break;case"M":status.push(FILE_STATUS.MODIFIED);break;case"A":status.push(FILE_STATUS.ADDED);break;case"D":status.push(FILE_STATUS.DELETED);break;case"R":status.push(FILE_STATUS.RENAMED);break;case"C":status.push(FILE_STATUS.COPIED);break;case"U":status.push(FILE_STATUS.UNMERGED);break;default:throw new Error("Unexpected status: "+statusChar)}var display=file,io=file.indexOf("->");-1!==io&&(file=file.substring(io+2).trim()),currentSubFolder&&0===display.indexOf(currentSubFolder)&&(display=display.substring(currentSubFolder.length)),results.push({status:status,display:display,file:file,name:file.substring(file.lastIndexOf("/")+1)})}else needReset.push(file)}),isEscaped?setConfig("core.quotepath","false").then(function(){if("SET_QUOTEPATH"===type)throw new Error("git status is calling itself in a recursive loop!");return status("SET_QUOTEPATH")}):needReset.length>0?Promise.all(needReset.map(function(fileName){return-1!==fileName.indexOf("->")&&(fileName=fileName.split("->")[1].trim()),unstage(fileName)})).then(function(){if("RECURSIVE_CALL"===type)throw new Error("git status is calling itself in a recursive loop!");return status("RECURSIVE_CALL")}):results.sort(function(a,b){return a.file<b.file?-1:a.file>b.file?1:0})}).then(function(results){return lastGitStatusResults=results,EventEmitter.emit(Events.GIT_STATUS_RESULTS,results),results})}function hasStatusChanged(){const prevStatus=lastGitStatusResults;return status().then(function(currentStatus){if(!prevStatus||prevStatus.length!==currentStatus.length)return!0;for(let i=0;i<prevStatus.length;i++)if(prevStatus[i].file!==currentStatus[i].file||prevStatus[i].status.join(", ")!==currentStatus[i].status.join(", "))return!0;return!1}).catch(function(error){return console.error("Error fetching Git status in hasStatusChanged:",error),!1})}function _isFileStaged(file){return git(["status","-u","--porcelain","--",file]).then(function(stdout){return!!stdout&&_.any(stdout.split("\n"),function(line){return" "!==line[0]&&"?"!==line[0]&&line.lastIndexOf(" "+file)===line.length-file.length-1})})}function getDiffOfStagedFiles(){return git(["diff","--no-ext-diff","--no-color","--staged"],{timeout:!1})}function getDiffOfAllIndexFiles(files){var args=["diff","--no-ext-diff","--no-color","--full-index"];return files&&(args=args.concat("--",files)),git(args,{timeout:!1})}function getListOfStagedFiles(){return git(["diff","--no-ext-diff","--no-color","--staged","--name-only"],{timeout:!1})}function diffFile(file){return _isFileStaged(file).then(function(staged){var args=["diff","--no-ext-diff","--no-color"];return staged&&args.push("--staged"),args.push("-U0","--",file),git(args,{timeout:!1})})}function diffFileNice(file){return _isFileStaged(file).then(function(staged){var args=["diff","--no-ext-diff","--no-color"];return staged&&args.push("--staged"),args.push("--",file),git(args,{timeout:!1})})}function difftool(file){return _isFileStaged(file).then(function(staged){var args=["difftool"];return staged&&args.push("--staged"),args.push("--",file),git(args,{timeout:!1,nonblocking:!0})})}function clean(){return git(["clean","-f","-d"])}function getFilesFromCommit(hash,isInitial){var args=["diff","--no-ext-diff","--name-only"];return git(args=(args=args.concat((isInitial?EMPTY_TREE:hash+"^")+".."+hash)).concat("--")).then(function(stdout){return stdout?stdout.split("\n"):[]})}function getDiffOfFileFromCommit(hash,file,isInitial){var args=["diff","--no-ext-diff","--no-color"];return git(args=(args=args.concat((isInitial?EMPTY_TREE:hash+"^")+".."+hash)).concat("--",file))}function difftoolFromHash(hash,file,isInitial){return git(["difftool",(isInitial?EMPTY_TREE:hash+"^")+".."+hash,"--",file],{timeout:!1})}function rebaseInit(branchName){return git(["rebase","--ignore-date",branchName])}function rebase(whatToDo){return git(["rebase","--"+whatToDo])}function getVersion(){return git(["--version"]).then(function(stdout){var m=stdout.match(/[0-9].*/);return m?m[0]:stdout.trim()})}function getCommitCountsFallback(){return git(["rev-list","HEAD","--not","--remotes"]).then(function(stdout){var ahead;return"-1 "+(stdout?stdout.split("\n").length:0)}).catch(function(err){return ErrorHandler.logError(err),"-1 -1"})}function getCommitCounts(){var remotes,remote=(Preferences.get("defaultRemotes")||{})[Preferences.get("currentGitRoot")];return getCurrentBranchName().then(function(branch){return branch&&remote?git(["rev-list","--left-right","--count",remote+"/"+branch+"...@{0}","--"]).catch(function(err){return ErrorHandler.logError(err),getCommitCountsFallback()}).then(function(stdout){var matches=/(-?\d+)\s+(-?\d+)/.exec(stdout);return matches?{behind:parseInt(matches[1],10),ahead:parseInt(matches[2],10)}:{behind:-1,ahead:-1}}):getCommitCountsFallback()})}function getLastCommitMessage(){return git(["log","-1","--pretty=%B"]).then(function(stdout){return stdout.trim()})}function getBlame(file,from,to){var args=["blame","-w","--line-porcelain"];return(from||to)&&args.push("-L"+from+","+to),args.push(file),git(args).then(function(stdout){if(!stdout)return[];var sep="-@-BREAK-HERE-@-",sep2="$$#-#$BREAK$$-$#";return(stdout=stdout.replace(sep,sep2).replace(/^\t(.*)$/gm,function(a,b){return b+sep})).split(sep).reduce(function(arr,lineInfo){if(!(lineInfo=lineInfo.replace(sep2,sep).trimLeft()))return arr;var obj={},lines=lineInfo.split("\n"),firstLine=_.first(lines).split(" ");obj.hash=firstLine[0],obj.num=firstLine[2],obj.content=_.last(lines);for(var i=1,l=lines.length-1;i<l;i++){var line=lines[i],io=line.indexOf(" "),key=line.substring(0,io),val=line.substring(io+1);obj[key]=val}return arr.push(obj),arr},[])}).catch(function(stderr){var m=stderr.match(/no such path (\S+)/);if(m)throw new Error("File is not tracked by Git: "+m[1]);throw stderr})}function getGitRoot(){var projectRoot=Utils.getProjectRoot();return git(["rev-parse","--show-toplevel"],{cwd:fs.getTauriPlatformPath(projectRoot)}).catch(function(e){if(ErrorHandler.contains(e,"Not a git repository"))return null;throw e}).then(function(root){if(null===root)return root;function checkPathRecursive(path){return strEndsWith(path,"/")&&(path=path.slice(0,-1)),Utils.consoleDebug("Checking path for .git: "+path),new Promise(function(resolve){"undefined"!=typeof brackets&&brackets.fs&&brackets.fs.stat?brackets.fs.stat(path+"/.git",function(err,result){var exists;!err&&(result.isFile()||result.isDirectory())?(Utils.consoleDebug("Found .git in path: "+path),resolve(path)):(Utils.consoleDebug("Failed to find .git in path: "+path),(path=path.split("/")).pop(),path=path.join("/"),resolve(checkPathRecursive(path)))}):FileSystem.resolve(path+"/.git",function(err,item,stat){var exists;!err&&(stat.isFile||stat.isDirectory)?(Utils.consoleDebug("Found .git in path: "+path),resolve(path)):(Utils.consoleDebug("Failed to find .git in path: "+path),(path=path.split("/")).pop(),path=path.join("/"),resolve(checkPathRecursive(path)))})})}return checkPathRecursive(projectRoot).then(function(path){return path+"/"})})}function setTagName(tagname,commitHash){const args=["tag",tagname];return commitHash&&args.push(commitHash),git(args).then(function(stdout){return stdout.trim()})}Preferences.getExtensionPref().on("change","gitPath",()=>{_gitPath=Preferences.get("gitPath")}),exports._git=git,exports.setGitPath=setGitPath,exports.FILE_STATUS=FILE_STATUS,exports.fetchRemote=fetchRemote,exports.fetchAllRemotes=fetchAllRemotes,exports.getRemotes=getRemotes,exports.createRemote=createRemote,exports.deleteRemote=deleteRemote,exports.push=push,exports.setUpstreamBranch=setUpstreamBranch,exports.getCurrentBranchName=getCurrentBranchName,exports.getCurrentUpstreamBranch=getCurrentUpstreamBranch,exports.getConfig=getConfig,exports.setConfig=setConfig,exports.getBranches=getBranches,exports.getAllBranches=getAllBranches,exports.branchDelete=branchDelete,exports.forceBranchDelete=forceBranchDelete,exports.getDeletedFiles=getDeletedFiles,exports.getHistory=getHistory,exports.init=init,exports.clone=clone,exports.stage=stage,exports.unstage=unstage,exports.stageAll=stageAll,exports.commit=commit,exports.reset=reset,exports.checkout=checkout,exports.createBranch=createBranch,exports.status=status,exports.hasStatusChanged=hasStatusChanged,exports.diffFile=diffFile,exports.diffFileNice=diffFileNice,exports.difftool=difftool,exports.clean=clean,exports.getFilesFromCommit=getFilesFromCommit,exports.getDiffOfFileFromCommit=getDiffOfFileFromCommit,exports.difftoolFromHash=difftoolFromHash,exports.rebase=rebase,exports.rebaseInit=rebaseInit,exports.mergeRemote=mergeRemote,exports.rebaseRemote=rebaseRemote,exports.resetRemote=resetRemote,exports.getVersion=getVersion,exports.getCommitCounts=getCommitCounts,exports.getLastCommitMessage=getLastCommitMessage,exports.mergeBranch=mergeBranch,exports.getDiffOfAllIndexFiles=getDiffOfAllIndexFiles,exports.getDiffOfStagedFiles=getDiffOfStagedFiles,exports.getListOfStagedFiles=getListOfStagedFiles,exports.getBlame=getBlame,exports.getGitRoot=getGitRoot,exports.setTagName=setTagName});