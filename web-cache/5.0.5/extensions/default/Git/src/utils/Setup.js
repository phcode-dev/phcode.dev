define(function(require,exports){const _=brackets.getModule("thirdparty/lodash"),Metrics=brackets.getModule("utils/Metrics"),Cli=require("src/Cli"),Git=require("src/git/Git"),Preferences=require("src/Preferences");let standardGitPathsWin=["C:\\Program Files (x86)\\Git\\cmd\\git.exe","C:\\Program Files\\Git\\cmd\\git.exe"],standardGitPathsNonWin=["/usr/local/git/bin/git","/usr/local/bin/git","/usr/bin/git"],extensionActivated=!1;function getGitVersion(){return new Promise(function(resolve,reject){var pathsToLook=[Preferences.get("gitPath"),"git"].concat("win"===brackets.platform?standardGitPathsWin:standardGitPathsNonWin);pathsToLook=_.unique(_.compact(pathsToLook));var results=[],errors=[],finish=_.after(pathsToLook.length,function(){var searchedPaths="\n\nSearched paths:\n"+pathsToLook.join("\n");if(0===results.length)reject("No Git has been found on this computer"+searchedPaths);else{var gits=_.sortBy(results,"version").reverse(),latestGit=gits[0],m=latestGit.version.match(/([0-9]+)\.([0-9]+)/),major=parseInt(m[1],10),minor=parseInt(m[2],10);if(1===major&&minor<8)return reject("Brackets Git requires Git 1.8 or later - latest version found was "+latestGit.version+searchedPaths);latestGit=_.sortBy(_.filter(gits,function(git){return git.version===latestGit.version}),"index")[0],Git.setGitPath(latestGit.path),resolve(latestGit.version)}});pathsToLook.forEach(function(path,index){Cli.spawnCommand(path,["--version"],{cwd:"./"}).then(function(stdout){var m=stdout.match(/^git version\s+(.*)$/);m&&results.push({path:path,version:m[1],index:index})}).catch(function(err){errors.push({path:path,err:err})}).finally(function(){finish()})})})}function isExtensionActivated(){return extensionActivated&&Preferences.get("enableGit")}function init(){return new Promise(resolve=>{if(!Preferences.get("enableGit"))return resolve(!1),void console.log("Git is disabled in preferences.");getGitVersion().then(function(_version){resolve(extensionActivated=!0),Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"installed","yes")}).catch(function(err){extensionActivated=!1,console.warn("Failed to launch Git executable. Deactivating Git extension. Is git installed?",err),resolve(extensionActivated),Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"installed","no")})})}exports.init=init,exports.isExtensionActivated=isExtensionActivated,exports.getGitVersion=getGitVersion});