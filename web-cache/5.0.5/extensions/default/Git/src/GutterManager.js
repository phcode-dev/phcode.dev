define(function(require,exports){var _=brackets.getModule("thirdparty/lodash"),CommandManager=brackets.getModule("command/CommandManager"),DocumentManager=brackets.getModule("document/DocumentManager"),EditorManager=brackets.getModule("editor/EditorManager"),ScrollTrackMarkers=brackets.getModule("search/ScrollTrackMarkers"),MainViewManager=brackets.getModule("view/MainViewManager"),ErrorHandler=require("src/ErrorHandler"),Events=require("src/Events"),EventEmitter=require("src/EventEmitter"),Git=require("src/git/Git"),Preferences=require("./Preferences"),Strings=brackets.getModule("strings");const GIT_SCROLL_MARKS="git_marks";var gitAvailable=!1,gutterName="brackets-git-gutter",editorsWithGutters=[],openWidgets=[];function _addDummyGutterMarkerIfNotExist(cm,line){var lineInfo=cm.lineInfo(line),gutters,gutterEnabled;if(lineInfo&&-1!==cm.getOption("gutters").slice(0).indexOf(gutterName)){var gutterMarkers=lineInfo.gutterMarkers,existingMarker;if(!(gutterMarkers&&gutterMarkers[gutterName])){var dummy=document.createElement("div");dummy.className="CodeMirror-gitGutter-none",cm.setGutterMarker(line,gutterName,dummy)}}}function _cursorActivity(_evt,editor){editor.hasSelection()||_addDummyGutterMarkerIfNotExist(editor._codeMirror,editor.getCursorPos().line)}function clearWidgets(){var lines=openWidgets.map(function(mark){var w=mark.lineWidget;return w.visible&&(w.visible=!1,w.widget.clear()),{cm:mark.cm,line:mark.line}});return openWidgets=[],lines}function clearOld(editor){var cm=editor._codeMirror;if(cm){var gutters=cm.getOption("gutters").slice(0),io=gutters.indexOf(gutterName);-1!==io&&(gutters.splice(io,1),cm.clearGutter(gutterName),cm.setOption("gutters",gutters),cm.off("gutterClick",gutterClick)),delete cm.gitGutters,clearWidgets()}}function prepareGutter(editor){var cm=editor._codeMirror,gutters=cm.getOption("gutters").slice(0);-1===gutters.indexOf(gutterName)&&(gutters.unshift(gutterName),cm.setOption("gutters",gutters),cm.on("gutterClick",gutterClick)),-1===editorsWithGutters.indexOf(editor)&&editorsWithGutters.push(editor)}function prepareGutters(editors){editors.forEach(function(editor){prepareGutter(editor)});for(var idx=editorsWithGutters.length;idx--;)-1===editors.indexOf(editorsWithGutters[idx])&&(clearOld(editorsWithGutters[idx]),editorsWithGutters.splice(idx,1))}function _showGutters(editor,_results){prepareGutter(editor);var cm=editor._codeMirror;cm.gitGutters=_.sortBy(_results,"line");var openBefore=clearWidgets();cm.clearGutter(gutterName),cm.gitGutters.forEach(function(obj){var $marker=$("<div>").addClass(gutterName+"-"+obj.type+" gitline-"+(obj.line+1)).html("&nbsp;");cm.setGutterMarker(obj.line,gutterName,$marker[0])}),_cursorActivity(null,editor),openBefore.forEach(function(obj){gutterClick(obj.cm,obj.line,gutterName)})}function gutterClick(cm,lineIndex,gutterId){if(cm&&(gutterId===gutterName||"CodeMirror-linenumbers"===gutterId)){var mark=_.find(cm.gitGutters,function(o){return o.line===lineIndex});if(mark&&"added"!==mark.type){if(mark.cm=cm,mark.parentMark&&(mark=mark.parentMark),!mark.lineWidget){mark.lineWidget={visible:!1,element:$("<div class='"+gutterName+"-deleted-lines'></div>")};var $btn=$("<button/>").addClass("brackets-git-gutter-copy-button").text("R").on("click",function(){var doc;DocumentManager.getCurrentDocument().replaceRange(mark.content+"\n",{line:mark.line,ch:0}),CommandManager.execute("file.save"),refresh()});$("<pre/>").attr("style","tab-size:"+cm.getOption("tabSize")).text(mark.content||" ").append($btn).appendTo(mark.lineWidget.element)}if(!0!==mark.lineWidget.visible)mark.lineWidget.visible=!0,mark.lineWidget.widget=cm.addLineWidget(mark.line,mark.lineWidget.element[0],{coverGutter:!1,noHScroll:!1,above:!0,showIfHidden:!1}),openWidgets.push(mark);else{mark.lineWidget.visible=!1,mark.lineWidget.widget.clear();var io=openWidgets.indexOf(mark);-1!==io&&openWidgets.splice(io,1)}}}}function getEditorFromPane(paneId){var currentPath=MainViewManager.getCurrentlyViewedPath(paneId),doc=currentPath&&DocumentManager.getOpenDocumentForPath(currentPath);return doc&&doc._masterEditor}function hasVerticalScrollbar(editor){const cm=editor._codeMirror,scrollEl=cm.getScrollerElement();return scrollEl.scrollHeight>scrollEl.clientHeight}function _markScrollbar(editor,allChanges){if(ScrollTrackMarkers.clear(editor,GIT_SCROLL_MARKS),!hasVerticalScrollbar(editor))return;const added=allChanges.filter(item=>"added"===item.type).map(({line:line})=>({line:line,ch:0})),removed=allChanges.filter(item=>"removed"===item.type).map(({line:line})=>({line:line,ch:0})),modified=allChanges.filter(item=>"modified"===item.type).map(({line:line})=>({line:line,ch:0})),trackers=[{arr:added,css:"brackets-git-added"},{arr:removed,css:"brackets-git-removed"},{arr:modified,css:"brackets-git-modified"}];for(let tracker of trackers){if(!tracker.arr.length)continue;let posArray=tracker.arr.map(item=>({line:item.line,ch:0}));ScrollTrackMarkers.addTickmarks(editor,posArray,{trackStyle:ScrollTrackMarkers.TRACK_STYLES.ON_LEFT,name:GIT_SCROLL_MARKS,cssColorClass:tracker.css})}}function processDiffResults(editor,diff){var added=[],removed=[],modified=[],changesets=diff.split(/\n@@/).map(function(str){return"@@"+str});changesets.shift(),changesets.forEach(function(str){var m=str.match(/^@@ -([,0-9]+) \+([,0-9]+) @@/),s1=m[1].split(","),s2=m[2].split(","),lineRemovedFrom,lineFrom=parseInt(s2[0],10),lineCount=parseInt(s1[1],10);isNaN(lineCount)&&(lineCount=1),lineCount>0&&(lineRemovedFrom=lineFrom-1,removed.push({type:"removed",line:lineRemovedFrom,content:str.split("\n").filter(function(l){return 0===l.indexOf("-")}).map(function(l){return l.substring(1)}).join("\n")})),lineFrom=parseInt(s2[0],10),lineCount=parseInt(s2[1],10),isNaN(lineCount)&&(lineCount=1);for(var isModifiedMark=!1,firstAddedMark=!1,i=lineFrom,lineTo=lineFrom+lineCount;i<lineTo;i++){var lineNo=i-1;if(lineNo===lineRemovedFrom){var o=removed.pop();o.type="modified",modified.push(o),isModifiedMark=o}else{var mark={type:isModifiedMark?"modified":"added",line:lineNo,parentMark:isModifiedMark||firstAddedMark||null};isModifiedMark||firstAddedMark||(firstAddedMark=mark),added.push(mark)}}}),removed.forEach(function(o){o.line=o.line+1});const allChanges=[].concat(added,removed,modified);_showGutters(editor,allChanges),_markScrollbar(editor,allChanges)}function refresh(){if(gitAvailable&&Preferences.get("useGitGutter")){var currentGitRoot=Preferences.get("currentGitRoot"),editors=_.compact(_.map(MainViewManager.getPaneIdList(),function(paneId){return getEditorFromPane(paneId)}));prepareGutters(editors),editors.forEach(function(editor){var currentFilePath=null;if(editor.document&&editor.document.file&&(currentFilePath=editor.document.file.fullPath),0===currentFilePath.indexOf(currentGitRoot)){var filename=currentFilePath.substring(currentGitRoot.length);Git.diffFile(filename).then(function(diff){processDiffResults(editor,diff)}).catch(function(err){ErrorHandler.contains(err,"Not a git repository")||ErrorHandler.contains(err,"No such file or directory")||ErrorHandler.showError(err,Strings.ERROR_REFRESH_GUTTER)})}})}}function goToPrev(){var activeEditor=EditorManager.getActiveEditor();if(activeEditor){for(var results=activeEditor._codeMirror.gitGutters||[],searched=_.filter(results,function(i){return!i.parentMark}),currentPos=activeEditor.getCursorPos(),i=searched.length;i--&&!(searched[i].line<currentPos.line););if(i>-1){var goToMark=searched[i];activeEditor.setCursorPos(goToMark.line,currentPos.ch)}}}function goToNext(){var activeEditor=EditorManager.getActiveEditor();if(activeEditor){for(var results=activeEditor._codeMirror.gitGutters||[],searched=_.filter(results,function(i){return!i.parentMark}),currentPos=activeEditor.getCursorPos(),i=0,l=searched.length;i<l&&!(searched[i].line>currentPos.line);i++);if(i<searched.length){var goToMark=searched[i];activeEditor.setCursorPos(goToMark.line,currentPos.ch)}}}function init(){const editor=EditorManager.getActiveEditor();editor&&(editor.off("cursorActivity.gitGutter"),editor.on("cursorActivity.gitGutter",_cursorActivity),_cursorActivity(null,editor))}EditorManager.on("activeEditorChange",function(event,newEditor,oldEditor){newEditor&&(newEditor.off("cursorActivity.gitGutter"),newEditor.on("cursorActivity.gitGutter",_cursorActivity),_cursorActivity(null,newEditor)),oldEditor&&oldEditor.off("cursorActivity.gitGutter")}),EventEmitter.on(Events.GIT_ENABLED,function(){gitAvailable=!0,refresh()}),EventEmitter.on(Events.GIT_DISABLED,function(){gitAvailable=!1,prepareGutters([])}),EventEmitter.on(Events.BRACKETS_CURRENT_DOCUMENT_CHANGE,function(file){var alreadyOpened;file&&(_.filter(editorsWithGutters,function(editor){return editor.document.file.fullPath===file.fullPath}).length>0||refresh())}),EventEmitter.on(Events.GIT_COMMITED,function(){refresh()}),EventEmitter.on(Events.BRACKETS_FILE_CHANGED,function(file){var alreadyOpened;_.filter(editorsWithGutters,function(editor){return editor.document.file.fullPath===file.fullPath}).length>0&&refresh()}),exports.init=init,exports.goToPrev=goToPrev,exports.goToNext=goToNext});