define(function(require,exports,module){const KernalModeTrust=window.KernalModeTrust;if(!KernalModeTrust)throw new Error("Guided Tour should have access to KernalModeTrust. Cannot boot without trust ring");const NotificationUI=require("widgets/NotificationUI"),Commands=require("command/Commands"),Strings=require("strings"),Menus=require("command/Menus"),StringUtils=require("utils/StringUtils"),KeyBindingManager=require("command/KeyBindingManager"),Metrics=require("utils/Metrics"),Dialogs=require("widgets/Dialogs"),Mustache=require("thirdparty/mustache/mustache"),SurveyTemplate=require("text!./html/survey-template.html"),NOTIFICATION_BACKOFF=1e4,GUIDED_TOUR_LOCAL_STORAGE_KEY="guidedTourActions",surveyLinksURL="https://updates.phcode.io/surveys.json",GENERAL_SURVEY_TIME=21e5,SURVEY_PRELOAD_DELAY=1e4,POWER_USER_SURVEY_INTERVAL_DAYS=45,userAlreadyDidAction=PhStore.getItem(GUIDED_TOUR_LOCAL_STORAGE_KEY)?JSON.parse(PhStore.getItem(GUIDED_TOUR_LOCAL_STORAGE_KEY)):{version:1,newProjectShown:!1,beautifyCodeShown:!1,generalSurveyShownVersion:0};let currentlyShowingNotification;function _showBeautifyNotification(){if(userAlreadyDidAction.beautifyCodeShown)return;let editorContextMenu=Menus.getContextMenu(Menus.ContextMenuIds.EDITOR_MENU);function _showNotification(){currentlyShowingNotification||setTimeout(()=>{let keyboardShortcut=KeyBindingManager.getKeyBindingsDisplay(Commands.EDIT_BEAUTIFY_CODE);keyboardShortcut=keyboardShortcut||"",userAlreadyDidAction.beautifyCodeShown=!0,PhStore.setItem(GUIDED_TOUR_LOCAL_STORAGE_KEY,JSON.stringify(userAlreadyDidAction)),Metrics.countEvent(Metrics.EVENT_TYPE.UI,"guide","beautify"),(currentlyShowingNotification=NotificationUI.createFromTemplate(Strings.CMD_BEAUTIFY_CODE,StringUtils.format(Strings.BEAUTIFY_CODE_NOTIFICATION,keyboardShortcut),"editor-context-menu-edit.beautifyCode",{allowedPlacements:["left","right"],autoCloseTimeS:15,dismissOnClick:!0})).done(()=>{currentlyShowingNotification=null}),editorContextMenu.off(Menus.EVENT_BEFORE_CONTEXT_MENU_OPEN,_showNotification)},500)}editorContextMenu.on(Menus.EVENT_BEFORE_CONTEXT_MENU_OPEN,_showNotification)}function _showNewProjectNotification(){userAlreadyDidAction.newProjectShown||(currentlyShowingNotification?setTimeout(_showNewProjectNotification,NOTIFICATION_BACKOFF):(userAlreadyDidAction.newProjectShown=!0,PhStore.setItem(GUIDED_TOUR_LOCAL_STORAGE_KEY,JSON.stringify(userAlreadyDidAction)),Metrics.countEvent(Metrics.EVENT_TYPE.UI,"guide","newProj"),(currentlyShowingNotification=NotificationUI.createFromTemplate(Strings.START_PROJECT,Strings.NEW_PROJECT_NOTIFICATION,"newProject",{allowedPlacements:["top","bottom"],autoCloseTimeS:15,dismissOnClick:!0})).done(()=>{currentlyShowingNotification=null})))}function _showFirstUseSurvey(surveyURL,delayOverride,title,useDialog){let surveyVersion=6,$surveyFrame;6!==userAlreadyDidAction.generalSurveyShownVersion&&(useDialog&&($surveyFrame=addSurveyIframe(surveyURL)),setTimeout(()=>{useDialog?(Metrics.countEvent(Metrics.EVENT_TYPE.USER,"survey","firstDialog",1),_showDialogSurvey($surveyFrame)):(Metrics.countEvent(Metrics.EVENT_TYPE.USER,"survey","firstNotification",1),_showSurveyNotification(surveyURL,title)),userAlreadyDidAction.generalSurveyShownVersion=6,PhStore.setItem(GUIDED_TOUR_LOCAL_STORAGE_KEY,JSON.stringify(userAlreadyDidAction))},delayOverride||GENERAL_SURVEY_TIME))}function addSurveyIframe(surveyURL){const $surveyFrame=$("<iframe>",{src:surveyURL,class:"forced-hidden",css:{border:"0",position:"absolute",top:0,"z-index":1e4}});return $("#alwaysHiddenElements").append($surveyFrame),$surveyFrame}function repositionIframe($surveyFrame,$destContainer){const container=$destContainer.offset(),height=$destContainer.outerHeight(),width=$destContainer.outerWidth();$surveyFrame.css({top:container.top+"px",left:container.left+"px",width:width+"px",height:height+"px",display:"block"}),$surveyFrame.removeClass("forced-hidden")}function observerPositionChanges($surveyFrame,$destContainer){const resizeObserver=new ResizeObserver(function(){repositionIframe($surveyFrame,$destContainer)});return resizeObserver.observe(document.body),resizeObserver}function _showDialogSurvey($surveyFrame){const templateVars={Strings:Strings};let positionObserver;Dialogs.showModalDialogUsingTemplate(Mustache.render(SurveyTemplate,templateVars)).done(()=>{positionObserver&&positionObserver.disconnect(),$surveyFrame.remove()});const $surveyFrameContainer=$("#surveyFrameContainer");setTimeout(()=>{repositionIframe($surveyFrame,$surveyFrameContainer),positionObserver=observerPositionChanges($surveyFrame,$surveyFrameContainer)},200)}function _showSurveyNotification(surveyUrl,title){NotificationUI.createToastFromTemplate(title||Strings.SURVEY_TITLE_VOTE_FOR_FEATURES_YOU_WANT,`<div class="survey-notification-popup">\n                    <iframe src="${surveyUrl}" style="width: 500px; height: 645px;" frameborder="0"></iframe></div>`,{toastStyle:`${NotificationUI.NOTIFICATION_STYLES_CSS_CLASS.INFO} survey-notification-big forced-hidden`,dismissOnClick:!1}),setTimeout(()=>{$(".survey-notification-big").removeClass("forced-hidden")},SURVEY_PRELOAD_DELAY)}function _showRepeatUserSurvey(surveyURL,intervalOverride,title,useDialog){let nextPowerSurveyShowDate=userAlreadyDidAction.nextPowerSurveyShowDate;if(!nextPowerSurveyShowDate){let nextShowDate=new Date;return nextShowDate.setUTCDate(nextShowDate.getUTCDate()+14),userAlreadyDidAction.nextPowerSurveyShowDate=nextShowDate.getTime(),void PhStore.setItem(GUIDED_TOUR_LOCAL_STORAGE_KEY,JSON.stringify(userAlreadyDidAction))}const intervalDays=intervalOverride||POWER_USER_SURVEY_INTERVAL_DAYS;let nextShowDate=new Date(nextPowerSurveyShowDate),currentDate;if(new Date<nextShowDate)return;if(useDialog){const $surveyFrame=addSurveyIframe(surveyURL);setTimeout(()=>{Metrics.countEvent(Metrics.EVENT_TYPE.USER,"survey","powerDialog",1),_showDialogSurvey($surveyFrame)},SURVEY_PRELOAD_DELAY)}else Metrics.countEvent(Metrics.EVENT_TYPE.USER,"survey","powerNotification",1),_showSurveyNotification(surveyURL,title);let newNextShowDate=new Date;newNextShowDate.setUTCDate(newNextShowDate.getUTCDate()+intervalDays),userAlreadyDidAction.nextPowerSurveyShowDate=newNextShowDate.getTime(),PhStore.setItem(GUIDED_TOUR_LOCAL_STORAGE_KEY,JSON.stringify(userAlreadyDidAction))}function _isLoggedIn(){return KernalModeTrust.EntitlementsManager&&KernalModeTrust.EntitlementsManager.isLoggedIn()}function _isPaidSubscriber(){return KernalModeTrust.EntitlementsManager&&KernalModeTrust.EntitlementsManager.isPaidSubscriber()}async function _resolvePowerUserSurveyURL(surveyJson){try{const isLoggedIn=_isLoggedIn();if(!isLoggedIn)return surveyJson.powerUser;const paidSubscriber=await _isPaidSubscriber();return paidSubscriber&&surveyJson.powerUserPaid?surveyJson.powerUserPaid:surveyJson.powerUserLoggedIn||surveyJson.powerUser}catch(e){logger.reportError(e,"Error resolving power user survey URL")}return surveyJson.powerUser}async function _showSurveys(){try{if(!navigator.onLine)return;let surveyJSON=await fetch(surveyLinksURL);surveyJSON=await surveyJSON.json(),!Phoenix.isNativeApp&&surveyJSON.browser&&(surveyJSON={newUser:surveyJSON.browser.newUser||surveyJSON.newUser,newUserTitle:surveyJSON.browser.newUserTitle||surveyJSON.newUserTitle,newUserShowDelayMS:surveyJSON.browser.newUserShowDelayMS||surveyJSON.newUserShowDelayMS,newUserUseDialog:surveyJSON.browser.newUserUseDialog||surveyJSON.newUserUseDialog,powerUser:surveyJSON.browser.powerUser||surveyJSON.powerUser,powerUserPaid:surveyJSON.browser.powerUserPaid||surveyJSON.powerUserPaid,powerUserLoggedIn:surveyJSON.browser.powerUserLoggedIn||surveyJSON.powerUserLoggedIn,powerUserTitle:surveyJSON.browser.powerUserTitle||surveyJSON.powerUserTitle,powerUserShowIntervalDays:surveyJSON.browser.powerUserShowIntervalDays||surveyJSON.powerUserShowIntervalDays,powerUserUseDialog:surveyJSON.browser.powerUserUseDialog||surveyJSON.powerUserUseDialog}),surveyJSON.newUser&&_showFirstUseSurvey(surveyJSON.newUser,surveyJSON.newUserShowDelayMS,surveyJSON.newUserTitle,surveyJSON.newUserUseDialog);const powerUserSurveyURL=await _resolvePowerUserSurveyURL(surveyJSON);powerUserSurveyURL&&_showRepeatUserSurvey(powerUserSurveyURL,surveyJSON.powerUserShowIntervalDays,surveyJSON.powerUserTitle,surveyJSON.powerUserUseDialog)}catch(e){console.error("Error fetching survey link",surveyLinksURL,e),Metrics.countEvent(Metrics.EVENT_TYPE.USER,"survey","fetchError",1)}}let tourStarted=!1;exports.startTourIfNeeded=function(){tourStarted||(tourStarted=!0,_showNewProjectNotification(),_showBeautifyNotification(),_showSurveys())}});