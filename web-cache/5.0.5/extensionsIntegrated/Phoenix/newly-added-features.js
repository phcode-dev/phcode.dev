define(function(require,exports,module){const FileViewController=require("project/FileViewController"),DocumentManager=require("document/DocumentManager"),FileSystem=require("filesystem/FileSystem"),FileUtils=require("file/FileUtils"),StringUtils=require("utils/StringUtils"),StateManager=require("preferences/StateManager"),Metrics=require("utils/Metrics"),STATE_LAST_SHOWN_HASH="newlyAddedFeaturesHash";function _getUpdateMarkdownURL(){return Phoenix.baseURL+"assets/default-project/en/Newly_added_features.md"}function _getUpdateMarkdownLocalPath(){return Phoenix.VFS.getDefaultProjectDir()+"Newly_added_features.md"}async function _getUpdateMarkdownText(){return new Promise((resolve,reject)=>{fetch(_getUpdateMarkdownURL()).then(response=>response.text()).then(async function(text){resolve(text)}).catch(reject)})}function _showNewFeatureMarkdownDoc(){setTimeout(()=>{FileViewController.openFileAndAddToWorkingSet(_getUpdateMarkdownLocalPath()),Metrics.countEvent(Metrics.EVENT_TYPE.PLATFORM,"newFeatMD","shown")},3e3)}async function _readMarkdownTextFile(){try{let markdownFile=FileSystem.getFileForPath(_getUpdateMarkdownLocalPath());return await window.jsPromise(DocumentManager.getDocumentText(markdownFile))}catch(e){return""}}async function _showNewUpdatesIfPresent(){let newMarkdownText=(await _getUpdateMarkdownText()).replace(/\r/g,""),newMarkdownTextHash=StringUtils.hashCode(newMarkdownText),currentMarkdownText;if(StateManager.get(STATE_LAST_SHOWN_HASH)!==newMarkdownTextHash&&newMarkdownText!==(await _readMarkdownTextFile()).replace(/\r/g,"")){StateManager.set(STATE_LAST_SHOWN_HASH,newMarkdownTextHash);let markdownFile=FileSystem.getFileForPath(_getUpdateMarkdownLocalPath());FileUtils.writeText(markdownFile,newMarkdownText,!0).done(_showNewFeatureMarkdownDoc).fail(e=>{console.error("Error while showing new feature markdown on update",e)})}}exports.init=function(){Phoenix.firstBoot||window.testEnvironment||_showNewUpdatesIfPresent().catch(console.error)}});