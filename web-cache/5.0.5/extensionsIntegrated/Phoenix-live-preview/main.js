define(function(require,exports,module){const ExtensionUtils=require("utils/ExtensionUtils"),EditorManager=require("editor/EditorManager"),FileViewController=require("project/FileViewController"),DocumentManager=require("document/DocumentManager"),ExtensionInterface=require("utils/ExtensionInterface"),CommandManager=require("command/CommandManager"),Commands=require("command/Commands"),Menus=require("command/Menus"),WorkspaceManager=require("view/WorkspaceManager"),AppInit=require("utils/AppInit"),ModalBar=require("widgets/ModalBar").ModalBar,PreferencesManager=require("preferences/PreferencesManager"),ProjectManager=require("project/ProjectManager"),MainViewManager=require("view/MainViewManager"),Strings=require("strings"),Mustache=require("thirdparty/mustache/mustache"),Metrics=require("utils/Metrics"),CONSTANTS=require("LiveDevelopment/LivePreviewConstants"),LiveDevelopment=require("LiveDevelopment/main"),LiveDevServerManager=require("LiveDevelopment/LiveDevServerManager"),MultiBrowserLiveDev=require("LiveDevelopment/LiveDevMultiBrowser"),NativeApp=require("utils/NativeApp"),StringUtils=require("utils/StringUtils"),FileSystem=require("filesystem/FileSystem"),DropdownButton=require("widgets/DropdownButton"),BrowserStaticServer=require("./BrowserStaticServer"),NodeStaticServer=require("./NodeStaticServer"),LivePreviewSettings=require("./LivePreviewSettings"),NodeUtils=require("utils/NodeUtils"),TrustProjectHTML=require("text!./trust-project.html"),panelHTML=require("text!./panel.html"),Dialogs=require("widgets/Dialogs"),DefaultDialogs=require("widgets/DefaultDialogs"),utils=require("./utils"),KernalModeTrust=window.KernalModeTrust;if(!KernalModeTrust)throw new Error("KernalModeTrust is not defined. Cannot boot without trust ring");const StateManager=PreferencesManager.stateManager,STATE_CUSTOM_SERVER_BANNER_ACK="customServerBannerDone";let customServerModalBar;const isBrowser=!Phoenix.isNativeApp,StaticServer=Phoenix.isNativeApp?NodeStaticServer:BrowserStaticServer,EVENT_EMBEDDED_IFRAME_WHO_AM_I="whoAmIframePhoenix",EVENT_EMBEDDED_IFRAME_FOCUS_EDITOR="embeddedIframeFocusEditor",PREVIEW_TRUSTED_PROJECT_KEY="preview_trusted",PREVIEW_PROJECT_README_KEY="preview_readme";let $dropdown=null;const PREFERENCE_LIVE_PREVIEW_MODE="livePreviewMode",PREFERENCE_PROJECT_ELEMENT_HIGHLIGHT=CONSTANTS.PREFERENCE_PROJECT_ELEMENT_HIGHLIGHT;PreferencesManager.definePreference(PREFERENCE_PROJECT_ELEMENT_HIGHLIGHT,"string",CONSTANTS.HIGHLIGHT_HOVER,{description:Strings.LIVE_DEV_SETTINGS_ELEMENT_HIGHLIGHT_PREFERENCE,values:[CONSTANTS.HIGHLIGHT_HOVER,CONSTANTS.HIGHLIGHT_CLICK]});const PREFERENCE_SHOW_RULER_LINES=CONSTANTS.PREFERENCE_SHOW_RULER_LINES;PreferencesManager.definePreference(PREFERENCE_SHOW_RULER_LINES,"boolean",!1,{description:Strings.LIVE_DEV_SETTINGS_SHOW_RULER_LINES_PREFERENCE});const LIVE_PREVIEW_PANEL_ID="live-preview-panel",LIVE_PREVIEW_IFRAME_ID="panel-live-preview-frame",LIVE_PREVIEW_IFRAME_HTML='\n    <iframe id="panel-live-preview-frame" title="Live Preview" style="border: none"\n             width="100%" height="100%" seamless="true"\n             src=\'about:blank\'\n             sandbox="allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-scripts allow-forms allow-modals allow-pointer-lock">\n    </iframe>\n    ';let $icon,$settingsIcon,$iframe,$panel,$pinUrlBtn,$livePreviewPopBtn,$reloadBtn,$chromeButton,$safariButton,$edgeButton,$firefoxButton,$chromeButtonBallast,$safariButtonBallast,$edgeButtonBallast,$firefoxButtonBallast,$panelTitle,$modeBtn,$previewBtn;Phoenix.isTestWindow&&(window._livePreviewIntegTest={urlLoadCount:0,STATE_CUSTOM_SERVER_BANNER_ACK:STATE_CUSTOM_SERVER_BANNER_ACK});let customLivePreviewBannerShown=!1,$statusOverlay=null,$statusOverlayMessage=null,$statusOverlayClose=null,shouldShowSyncErrorOverlay=!0,shouldShowConnectingOverlay=!0,connectingOverlayTimer=null,connectingOverlayTimeDuration=3e3;function _getLiveEditEntitlement(){return KernalModeTrust.EntitlementsManager&&KernalModeTrust.EntitlementsManager.getLiveEditEntitlement()}let isProEditUser=!1;async function _entitlementsChanged(){try{const entitlement=await _getLiveEditEntitlement();isProEditUser=entitlement&&entitlement.activated}catch(error){console.error("Error updating pro user status:",error),isProEditUser=!1}}function _handleOverlay(textMessage,status){if(!$panel)return;if(_hideOverlay(),LivePreviewSettings.isUsingCustomServer())return;const currentDocument=DocumentManager.getCurrentDocument();if(!currentDocument||!currentDocument.file)return;const filePath=currentDocument.file.fullPath;utils.isHTMLFile(filePath)&&(status!==MultiBrowserLiveDev.STATUS_CONNECTING||shouldShowConnectingOverlay)&&(status!==MultiBrowserLiveDev.STATUS_SYNC_ERROR||shouldShowSyncErrorOverlay)&&(status!==MultiBrowserLiveDev.STATUS_CONNECTING?_showOverlay(textMessage,status):connectingOverlayTimer=setTimeout(()=>{LivePreviewSettings.isUsingCustomServer()?connectingOverlayTimer=null:(_showOverlay(textMessage,status),connectingOverlayTimer=null)},connectingOverlayTimeDuration))}function _initOverlay(){$panel&&($statusOverlay=$panel.find(".live-preview-status-overlay"),$statusOverlayMessage=$statusOverlay.find(".live-preview-overlay-message"),($statusOverlayClose=$statusOverlay.find(".live-preview-overlay-close")).on("click",()=>{const currentStatue=$statusOverlay.data("status");currentStatue===MultiBrowserLiveDev.STATUS_CONNECTING?shouldShowConnectingOverlay=!1:currentStatue===MultiBrowserLiveDev.STATUS_SYNC_ERROR&&(shouldShowSyncErrorOverlay=!1),_hideOverlay()}))}function _showOverlay(textMessage,status){$statusOverlay&&($statusOverlayMessage.text(textMessage),$statusOverlay.data("status",status))}function _hideOverlay(){_clearConnectingOverlayTimer(),$statusOverlay&&$statusOverlay.addClass("forced-hidden")}function _clearConnectingOverlayTimer(){connectingOverlayTimer&&(clearTimeout(connectingOverlayTimer),connectingOverlayTimer=null)}function _updateModeButton(mode){$modeBtn&&($modeBtn[0].textContent="highlight"===mode?Strings.LIVE_PREVIEW_MODE_HIGHLIGHT:"edit"===mode?Strings.LIVE_PREVIEW_MODE_EDIT:Strings.LIVE_PREVIEW_MODE_PREVIEW)}function _initializeMode(){const currentMode=LiveDevelopment.getCurrentMode();currentMode===LiveDevelopment.CONSTANTS.LIVE_PREVIEW_MODE?$previewBtn.addClass("selected"):$previewBtn.removeClass("selected"),_updateModeButton(currentMode)}function _showModeSelectionDropdown(event){const isEditFeaturesActive=isProEditUser,items=[Strings.LIVE_PREVIEW_MODE_PREVIEW,Strings.LIVE_PREVIEW_MODE_HIGHLIGHT,Strings.LIVE_PREVIEW_MODE_EDIT];isEditFeaturesActive&&(items.push("---"),items.push(Strings.LIVE_PREVIEW_EDIT_HIGHLIGHT_ON),items.push(Strings.LIVE_PREVIEW_SHOW_RULER_LINES));const currentMode=LiveDevelopment.getCurrentMode();$dropdown=new DropdownButton.DropdownButton("",items,function(item,index){if(item===Strings.LIVE_PREVIEW_MODE_PREVIEW)return currentMode===LiveDevelopment.CONSTANTS.LIVE_PREVIEW_MODE?`✓ ${item}`:`${" ".repeat(4)}${item}`;if(item===Strings.LIVE_PREVIEW_MODE_HIGHLIGHT)return currentMode===LiveDevelopment.CONSTANTS.LIVE_HIGHLIGHT_MODE?`✓ ${item}`:`${" ".repeat(4)}${item}`;if(item===Strings.LIVE_PREVIEW_MODE_EDIT){const checkmark=currentMode===LiveDevelopment.CONSTANTS.LIVE_EDIT_MODE?"✓ ":`${" ".repeat(4)}`,crownIcon=isEditFeaturesActive?"":' <span style="color: #FBB03B; border: 1px solid #FBB03B; padding: 2px 4px; border-radius: 10px; font-size: 9px; margin-left: 12px;"><i class="fas fa-crown"></i> Pro</span>';return{html:`${checkmark}${item}${crownIcon}`,enabled:!0}}if(item===Strings.LIVE_PREVIEW_EDIT_HIGHLIGHT_ON){const isHoverMode=PreferencesManager.get(PREFERENCE_PROJECT_ELEMENT_HIGHLIGHT)===CONSTANTS.HIGHLIGHT_HOVER;return isHoverMode?`✓ ${Strings.LIVE_PREVIEW_EDIT_HIGHLIGHT_ON}`:`${" ".repeat(4)}${Strings.LIVE_PREVIEW_EDIT_HIGHLIGHT_ON}`}if(item===Strings.LIVE_PREVIEW_SHOW_RULER_LINES){const isEnabled=PreferencesManager.get(PREFERENCE_SHOW_RULER_LINES);return isEnabled?`✓ ${Strings.LIVE_PREVIEW_SHOW_RULER_LINES}`:`${" ".repeat(4)}${Strings.LIVE_PREVIEW_SHOW_RULER_LINES}`}return item}),$("body").append($dropdown.$button),$dropdown.$button.css({position:"absolute",left:event.pageX+"px",top:event.pageY+"px",zIndex:1e3}),$dropdown.dropdownExtraClasses="mode-context-menu",$dropdown.showDropdown(),$(".mode-context-menu").css("max-height","300px"),$dropdown.on("select",function(e,item,index){if(0===index)LiveDevelopment.setMode(LiveDevelopment.CONSTANTS.LIVE_PREVIEW_MODE);else if(1===index)LiveDevelopment.setMode(LiveDevelopment.CONSTANTS.LIVE_HIGHLIGHT_MODE);else if(2===index)LiveDevelopment.setMode(LiveDevelopment.CONSTANTS.LIVE_EDIT_MODE)||(KernalModeTrust.ProDialogs?KernalModeTrust.ProDialogs.showProUpsellDialog(KernalModeTrust.ProDialogs.UPSELL_TYPE_LIVE_EDIT):Metrics.countEvent(Metrics.EVENT_TYPE.PRO,"proUpsellDlg","fail"));else{if(item===Strings.LIVE_PREVIEW_EDIT_HIGHLIGHT_ON){if(!isEditFeaturesActive)return;const currMode=PreferencesManager.get(PREFERENCE_PROJECT_ELEMENT_HIGHLIGHT),newMode=currMode!==CONSTANTS.HIGHLIGHT_CLICK?CONSTANTS.HIGHLIGHT_CLICK:CONSTANTS.HIGHLIGHT_HOVER;return void PreferencesManager.set(PREFERENCE_PROJECT_ELEMENT_HIGHLIGHT,newMode)}if(item===Strings.LIVE_PREVIEW_SHOW_RULER_LINES){if(!isEditFeaturesActive)return;const currentValue=PreferencesManager.get(PREFERENCE_SHOW_RULER_LINES);return void PreferencesManager.set(PREFERENCE_SHOW_RULER_LINES,!currentValue)}}}),$dropdown.$button.css({display:"none"})}function _closeDropdown(){$dropdown&&($dropdown.$button&&$dropdown.$button.remove(),$dropdown=null)}function _handleLPModeBtnClick(e){e.stopPropagation(),$dropdown?_closeDropdown():_showModeSelectionDropdown(e)}function _getTrustProjectPage(){const trustProjectMessage=StringUtils.format(Strings.TRUST_PROJECT,path.basename(ProjectManager.getProjectRoot().fullPath)),templateVars={trustProjectMessage:trustProjectMessage,Strings:Strings};return Mustache.render(TrustProjectHTML,templateVars)}function _isProjectPreviewTrusted(){if(Phoenix.isTestWindow||Phoenix.isNativeApp)return!0;const projectPath=ProjectManager.getProjectRoot().fullPath;if(projectPath===ProjectManager.getWelcomeProjectPath()||projectPath===ProjectManager.getExploreProjectPath())return!0;const isTrustedProject=`${PREVIEW_TRUSTED_PROJECT_KEY}-${projectPath}`;return!!PhStore.getItem(isTrustedProject)}function _setProjectReadmePreviewdOnce(){const projectPath=ProjectManager.getProjectRoot().fullPath,previewReadmeKey=`${PREVIEW_PROJECT_README_KEY}-${projectPath}`;PhStore.setItem(previewReadmeKey,!0)}function _isProjectReadmePreviewdOnce(){const projectPath=ProjectManager.getProjectRoot().fullPath,previewReadmeKey=`${PREVIEW_PROJECT_README_KEY}-${projectPath}`;return!!PhStore.getItem(previewReadmeKey)}function _createStaticServer(){var config={pathResolver:ProjectManager.makeProjectRelativeIfPossible,root:ProjectManager.getProjectRoot().fullPath};return new StaticServer.StaticServer(config)}StaticServer.on("whoAmIframePhoenix",function(){if($iframe&&$iframe[0]){const iframeDom=$iframe[0];iframeDom.contentWindow.postMessage({type:"WHO_AM_I_RESPONSE",isTauri:Phoenix.isNativeApp,platform:Phoenix.platform},"*")}}),StaticServer.on("embeddedIframeFocusEditor",function(){const editor=EditorManager.getActiveEditor();editor.focus()}),window._trustCurrentProjectForLivePreview=function(){$iframe.attr("srcdoc",null);const projectPath=ProjectManager.getProjectRoot().fullPath,isTrustedProjectKey=`${PREVIEW_TRUSTED_PROJECT_KEY}-${projectPath}`;PhStore.setItem(isTrustedProjectKey,!0),_loadPreview(!0)},ExtensionInterface.registerExtensionInterface(ExtensionInterface._DEFAULT_EXTENSIONS_INTERFACE_NAMES.PHOENIX_LIVE_PREVIEW,exports),ExtensionUtils.loadStyleSheet(module,"live-preview.css");let panel,urlPinned,currentLivePreviewURL="",currentPreviewFile="",panelShownAtStartup;function _blankIframe(){let newIframe=$(LIVE_PREVIEW_IFRAME_HTML);newIframe.insertAfter($iframe),$iframe.remove(),$iframe=newIframe}function _setPanelVisibility(isVisible){isVisible?(panelShownAtStartup=!0,$icon.toggleClass("active"),panel.show(),_loadPreview(!0,!0),_showCustomServerBannerIfNeeded()):($icon.toggleClass("active"),_blankIframe(),panel.hide())}function _startOrStopLivePreviewIfRequired(explicitClickOnLPIcon){let visible=panel&&panel.isVisible();visible&&(LiveDevelopment.isInactive()||explicitClickOnLPIcon)?LiveDevelopment.openLivePreview():visible||!LiveDevelopment.isActive()||StaticServer.hasActiveLivePreviews()||LiveDevelopment.closeLivePreview()}function _toggleVisibilityOnClick(){let visible;_setPanelVisibility(!panel.isVisible()),_startOrStopLivePreviewIfRequired(!0)}function _togglePinUrl(){let pinStatus=$pinUrlBtn.hasClass("pin-icon");pinStatus?$pinUrlBtn.removeClass("pin-icon").addClass("unpin-icon"):$pinUrlBtn.removeClass("unpin-icon").addClass("pin-icon"),urlPinned=!pinStatus,LiveDevelopment.setLivePreviewPinned(urlPinned,currentPreviewFile),_loadPreview(!0),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"pinURLBtn","click")}const ALLOWED_BROWSERS_NAMES=["chrome","firefox","safari","edge","browser","browserPrivate"];function _popoutLivePreview(browserName){const openURL=StaticServer.getTabPopoutURL(currentLivePreviewURL);browserName&&ALLOWED_BROWSERS_NAMES.includes(browserName)?(Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"popout",browserName),NodeUtils.openUrlInBrowser(openURL,browserName).then(()=>{_loadPreview(!0),_setPanelVisibility(!1)}).catch(err=>{console.error("Error opening url in browser: ",browserName,err),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"popFail",browserName),Dialogs.showModalDialog(DefaultDialogs.DIALOG_ID_ERROR,StringUtils.format(Strings.LIVE_DEV_OPEN_ERROR_TITLE,browserName),StringUtils.format(Strings.LIVE_DEV_OPEN_ERROR_MESSAGE,browserName))})):(NativeApp.openURLInDefaultBrowser(openURL,"livePreview"),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"popoutBtn","click"),_loadPreview(!0),_setPanelVisibility(!1))}function _setTitle(fileName,fullPath,currentLivePreviewURL){let message=Strings.LIVE_DEV_SELECT_FILE_TO_PREVIEW,tooltip=message;fileName&&(message=`${fileName}`,tooltip=StringUtils.format(Strings.LIVE_DEV_TOOLTIP_SHOW_IN_EDITOR,fileName)),currentLivePreviewURL&&(tooltip=`${tooltip}\n${currentLivePreviewURL}`),$panelTitle.text(currentLivePreviewURL||message),$panelTitle.attr("title",tooltip),$panelTitle.attr("data-fullPath",fullPath)}function _showOpenBrowserIcons(){Phoenix.isNativeApp&&($chromeButton.removeClass("forced-hidden"),$chromeButtonBallast.removeClass("forced-hidden"),$chromeButtonBallast.addClass("forced-inVisible"),$edgeButton.removeClass("forced-hidden"),$edgeButtonBallast.removeClass("forced-hidden"),$edgeButtonBallast.addClass("forced-inVisible"),$firefoxButton.removeClass("forced-hidden"),$firefoxButtonBallast.removeClass("forced-hidden"),$firefoxButtonBallast.addClass("forced-inVisible"),"mac"===brackets.platform&&($safariButton.removeClass("forced-hidden"),$safariButtonBallast.removeClass("forced-hidden"),$safariButtonBallast.addClass("forced-inVisible")))}function _handlePreviewBtnClick(){if($previewBtn.hasClass("selected")){$previewBtn.removeClass("selected");const defaultMode=isProEditUser?"edit":"highlight";PreferencesManager.set(PREFERENCE_LIVE_PREVIEW_MODE,defaultMode)}else $previewBtn.addClass("selected"),PreferencesManager.set(PREFERENCE_LIVE_PREVIEW_MODE,"preview")}async function _createExtensionPanel(){let templateVars={Strings:Strings,livePreview:Strings.LIVE_DEV_STATUS_TIP_OUT_OF_SYNC,clickToReload:Strings.LIVE_DEV_CLICK_TO_RELOAD_PAGE,clickToPreview:Strings.LIVE_PREVIEW_MODE_TOGGLE_PREVIEW,livePreviewSettings:Strings.LIVE_DEV_SETTINGS,livePreviewConfigureModes:Strings.LIVE_PREVIEW_CONFIGURE_MODES,clickToPopout:Strings.LIVE_DEV_CLICK_POPOUT,openInChrome:Strings.LIVE_DEV_OPEN_CHROME,openInSafari:Strings.LIVE_DEV_OPEN_SAFARI,openInEdge:Strings.LIVE_DEV_OPEN_EDGE,openInFirefox:Strings.LIVE_DEV_OPEN_FIREFOX,clickToPinUnpin:Strings.LIVE_DEV_CLICK_TO_PIN_UNPIN};const PANEL_MIN_SIZE=50,INITIAL_PANEL_SIZE=document.body.clientWidth/2.5;($icon=$("#toolbar-go-live")).click(_toggleVisibilityOnClick),$panel=$(Mustache.render(panelHTML,templateVars)),$iframe=$panel.find("#panel-live-preview-frame"),$pinUrlBtn=$panel.find("#pinURLButton"),$reloadBtn=$panel.find("#reloadLivePreviewButton"),$livePreviewPopBtn=$panel.find("#livePreviewPopoutButton"),$chromeButton=$panel.find("#chromeButton"),$safariButton=$panel.find("#safariButton"),$edgeButton=$panel.find("#edgeButton"),$firefoxButton=$panel.find("#firefoxButton"),$chromeButtonBallast=$panel.find("#chromeButtonBallast"),$safariButtonBallast=$panel.find("#safariButtonBallast"),$edgeButtonBallast=$panel.find("#edgeButtonBallast"),$firefoxButtonBallast=$panel.find("#firefoxButtonBallast"),$panelTitle=$panel.find("#panel-live-preview-title"),$settingsIcon=$panel.find("#livePreviewSettingsBtn"),$modeBtn=$panel.find("#livePreviewModeBtn"),$previewBtn=$panel.find("#previewModeLivePreviewButton"),$panel.find(".live-preview-settings-banner-btn").on("click",()=>{CommandManager.execute(Commands.FILE_LIVE_FILE_PREVIEW_SETTINGS),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"settingsBtnBanner","click")}),$panel.find(".custom-server-banner-close-icon").on("click",()=>{$panel.find(".live-preview-custom-banner").addClass("forced-hidden")}),$iframe[0].onload=function(){$iframe.attr("srcdoc",null)},$panelTitle.on("click",()=>{const fullPath=$panelTitle.attr("data-fullPath"),openPanes=MainViewManager.findInAllWorkingSets(fullPath);let paneToUse=MainViewManager.ACTIVE_PANE;openPanes.length&&(paneToUse=openPanes[0].paneId),FileViewController.openFileAndAddToWorkingSet(fullPath,paneToUse)}),$chromeButton.on("click",()=>{_popoutLivePreview("chrome")}),$safariButton.on("click",()=>{_popoutLivePreview("safari")}),$edgeButton.on("click",()=>{_popoutLivePreview("edge")}),$firefoxButton.on("click",()=>{_popoutLivePreview("firefox")}),$modeBtn.on("click",_handleLPModeBtnClick),$previewBtn.on("click",_handlePreviewBtnClick),_showOpenBrowserIcons(),$settingsIcon.click(()=>{CommandManager.execute(Commands.FILE_LIVE_FILE_PREVIEW_SETTINGS),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"settingsBtn","click")});const popoutSupported=Phoenix.isNativeApp||Phoenix.browser.desktop.isChromeBased||Phoenix.browser.desktop.isFirefox;popoutSupported||$livePreviewPopBtn.addClass("forced-hidden"),panel=WorkspaceManager.createPluginPanel(LIVE_PREVIEW_PANEL_ID,$panel,50,$icon,INITIAL_PANEL_SIZE),WorkspaceManager.recomputeLayout(!1),$pinUrlBtn.click(_togglePinUrl),$livePreviewPopBtn.click(_popoutLivePreview),$reloadBtn.click(()=>{_loadPreview(!0,!0),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"reloadBtn","click")}),_initOverlay()}async function _loadPreview(force,isReload){const isPreviewLoadable=panel.isVisible()||StaticServer.hasActiveLivePreviews();if(!isPreviewLoadable)return;let previewDetails=await StaticServer.getPreviewDetails();if(urlPinned&&!force)return;let newSrc=encodeURI(previewDetails.URL);if($iframe.attr("src")===newSrc&&!force)return;urlPinned||(currentLivePreviewURL=newSrc,currentPreviewFile=previewDetails.fullPath),isReload&&previewDetails.isHTMLFile&&LiveDevelopment.openLivePreview();let relativeOrFullPath=ProjectManager.makeProjectRelativeIfPossible(currentPreviewFile);if(_setTitle(relativeOrFullPath=Phoenix.app.getDisplayPath(relativeOrFullPath),currentPreviewFile,previewDetails.isCustomServer?currentLivePreviewURL:""),panel.isVisible()){!customLivePreviewBannerShown&&LivePreviewSettings.isUsingCustomServer()&&previewDetails.isCustomServer&&(customLivePreviewBannerShown=!0,$panel.find(".live-preview-custom-banner").removeClass("forced-hidden"),$panel.find(".live-preview-banner-message").text(StringUtils.format(Strings.LIVE_PREVIEW_CUSTOM_SERVER_BANNER,LivePreviewSettings.getCustomServeBaseURL())));let newIframe=$(LIVE_PREVIEW_IFRAME_HTML);newIframe.insertAfter($iframe),$iframe.remove(),$iframe=newIframe,_isProjectPreviewTrusted()?($iframe.attr("src",currentLivePreviewURL),Phoenix.isTestWindow&&(window._livePreviewIntegTest.currentLivePreviewURL=currentLivePreviewURL,window._livePreviewIntegTest.urlLoadCount++)):$iframe.attr("srcdoc",_getTrustProjectPage())}Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"render",utils.getExtension(previewDetails.fullPath)),StaticServer.redirectAllTabs(currentLivePreviewURL,force),Phoenix.isTestWindow&&(window._livePreviewIntegTest.redirectURL=currentLivePreviewURL,window._livePreviewIntegTest.redirectURLforce=force)}async function _projectFileChanges(evt,changedFile){if(changedFile&&changedFile.isFile&&(utils.isPreviewableFile(changedFile.fullPath)||utils.isServerRenderedFile(changedFile.fullPath))){const previewDetails=await StaticServer.getPreviewDetails();let shouldReload=!1;previewDetails.isCustomServer&&!previewDetails.serverSupportsHotReload&&(shouldReload=!0),previewDetails.isCustomServer||LiveDevelopment.isActive()&&previewDetails.isHTMLFile||(shouldReload=!0),shouldReload&&_loadPreview(!0)}}function _openReadmeMDIfFirstTime(){if(!_isProjectReadmePreviewdOnce()&&!Phoenix.isTestWindow){const readmePath=`${ProjectManager.getProjectRoot().fullPath}README.md`,fileEntry=FileSystem.getFileForPath(readmePath);fileEntry.exists(function(err,exists){!err&&exists&&(_setPanelVisibility(!0),CommandManager.execute(Commands.CMD_ADD_TO_WORKINGSET_AND_OPEN,{fullPath:readmePath}),_setProjectReadmePreviewdOnce())})}}function _switchToEditModeIfNeeded(){const projectPath=ProjectManager.getProjectRoot().fullPath,exploreProjectPath=ProjectManager.getExploreProjectPath(),isExploreProject=projectPath===exploreProjectPath;isExploreProject?LiveDevelopment.setMode(LiveDevelopment.CONSTANTS.LIVE_HIGHLIGHT_MODE):isProEditUser&&LiveDevelopment.setMode(LiveDevelopment.CONSTANTS.LIVE_EDIT_MODE)}let startupFilesLoadHandled=!1;async function _projectOpened(){if(_switchToEditModeIfNeeded(),customLivePreviewBannerShown=!1,$panel.find(".live-preview-custom-banner").addClass("forced-hidden"),_openReadmeMDIfFirstTime(),_customServerMetrics(),LiveDevelopment.isActive()||!panel.isVisible()&&!StaticServer.hasActiveLivePreviews()||LiveDevelopment.openLivePreview(),urlPinned&&_togglePinUrl(),$iframe.attr("src",StaticServer.getNoPreviewURL()),!panelShownAtStartup&&!isBrowser&&ProjectManager.isStartupFilesLoaded()){startupFilesLoadHandled=!0;const currentDocument=DocumentManager.getCurrentDocument(),currentFile=currentDocument?currentDocument.file:ProjectManager.getSelectedItem(),isPreviewable=!!currentFile&&utils.isPreviewableFile(currentFile.fullPath);isPreviewable&&_setPanelVisibility(!0)}panel.isVisible()&&_loadPreview(!0)}function _startupFilesLoaded(){if(!startupFilesLoadHandled&&!panelShownAtStartup&&!isBrowser&&ProjectManager.isStartupFilesLoaded()){const currentDocument=DocumentManager.getCurrentDocument(),currentFile=currentDocument?currentDocument.file:ProjectManager.getSelectedItem(),isPreviewable=!!currentFile&&utils.isPreviewableFile(currentFile.fullPath);isPreviewable&&(_setPanelVisibility(!0),_loadPreview(!0,!0))}}function _projectClosed(){urlPinned&&_togglePinUrl(),LiveDevelopment.closeLivePreview(),customServerModalBar&&(customServerModalBar.close(),customServerModalBar=null)}function _activeDocChanged(event,focusedEditor,lostEditor){if(LivePreviewSettings.isUsingCustomServer()||LiveDevelopment.isActive()||!panel.isVisible()&&!StaticServer.hasActiveLivePreviews()||LiveDevelopment.openLivePreview(),!focusedEditor||!focusedEditor.document)return void _hideOverlay();const filePath=focusedEditor.document.file.fullPath,isPreviewable=utils.isPreviewableFile(filePath)||utils.isServerRenderedFile(filePath),customServeURL=LivePreviewSettings.isUsingCustomServer()&&LivePreviewSettings.getCustomServerConfig(filePath);isPreviewable||customServeURL||_hideOverlay()}async function _openLivePreviewURL(_event,previewDetails){if(LivePreviewSettings.isUsingCustomServer())return void _hideOverlay();_loadPreview(!0);const currentPreviewDetails=await StaticServer.getPreviewDetails();currentPreviewDetails.isHTMLFile&&currentPreviewDetails.fullPath!==previewDetails.fullPath&&console.error("Live preview URLs differ between phoenix live preview extension and core live preview",currentPreviewDetails,previewDetails);const status=MultiBrowserLiveDev.status;status===MultiBrowserLiveDev.STATUS_CONNECTING?_handleOverlay(Strings.LIVE_DEV_STATUS_TIP_PROGRESS1,status):status===MultiBrowserLiveDev.STATUS_SYNC_ERROR&&_handleOverlay(Strings.LIVE_DEV_STATUS_TIP_SYNC_ERROR,status)}async function _currentFileChanged(_event,changedFile){if(!changedFile||!changedFile.fullPath||!ProjectManager.isStartupFilesLoaded())return;const fullPath=changedFile.fullPath;changedFile&&_shouldShowCustomServerBar(fullPath)&&_showCustomServerBar(fullPath);const shouldUseInbuiltPreview=utils.isMarkdownFile(fullPath)||utils.isSVG(fullPath),customServeURL=LivePreviewSettings.isUsingCustomServer()&&LivePreviewSettings.getCustomServerConfig(fullPath);if(urlPinned||LivePreviewSettings.isUsingCustomServer()&&!customServeURL&&!shouldUseInbuiltPreview)return;const shouldSwitchCustomServer=customServeURL&&currentLivePreviewURL!==customServeURL&&(!currentLivePreviewURL||!currentLivePreviewURL.startsWith(customServeURL));if(changedFile&&(utils.isPreviewableFile(fullPath)||utils.isServerRenderedFile(fullPath)||shouldSwitchCustomServer)&&(_loadPreview(),!panelShownAtStartup&&ProjectManager.isStartupFilesLoaded())){let previewDetails=await StaticServer.getPreviewDetails();previewDetails&&!previewDetails.isNoPreview&&(_setPanelVisibility(!0),_loadPreview())}}function _showSettingsDialog(){return new Promise(resolve=>{LivePreviewSettings.showSettingsDialog().then(()=>{_loadPreview(),resolve()})})}function _customServerMetrics(){LivePreviewSettings.isUsingCustomServer()&&(Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"customServ","yes"),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"framework",LivePreviewSettings.getCustomServerFramework()||"unknown"),LivePreviewSettings.serverSupportsHotReload()&&Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"hotReload","yes"))}function _showCustomServerBannerIfNeeded(){const editor=EditorManager.getActiveEditor();editor&&_shouldShowCustomServerBar(editor.document.file.fullPath)&&_showCustomServerBar(editor.document.file.fullPath)}function _shouldShowCustomServerBar(fullPath){const isBannerAck=StateManager.get(STATE_CUSTOM_SERVER_BANNER_ACK,StateManager.PROJECT_CONTEXT);let panelVisible=panel&&panel.isVisible();return!(isBannerAck||LivePreviewSettings.isUsingCustomServer()||!panelVisible)&&utils.isServerRenderedFile(fullPath)}function _showCustomServerBar(fullFilePath){if(customServerModalBar)return void $(".custom-banner-setup-server-text-message").html(StringUtils.format(Strings.LIVE_DEV_SETTINGS_BANNER,path.extname(fullFilePath)));const searchBarHTML=`<div style="display: flex;justify-content: end;align-items: baseline;">\n            <div style="margin-right: 5px;" class="custom-banner-setup-server-text-message">\n                ${StringUtils.format(Strings.LIVE_DEV_SETTINGS_BANNER,path.extname(fullFilePath))}\n            </div>\n            <button class="btn btn-mini live-preview-settings" style="margin-right: 5px;">\n                ${Strings.LIVE_DEV_SETTINGS}\n            </button>\n            <div class="close-icon" style="align-self: center;margin-left: 10px;margin-right: 5px;cursor: pointer;"\n                title="${Strings.CLOSE}">\n                <i class="fa-solid fa-xmark"></i>\n            </div>\n        </div>`,$modal=(customServerModalBar=new ModalBar(searchBarHTML)).getRoot();$modal.find(".live-preview-settings").click(()=>{_showSettingsDialog().then(()=>{LivePreviewSettings.isUsingCustomServer()&&(customServerModalBar&&customServerModalBar.close(),customServerModalBar=null,StateManager.set(STATE_CUSTOM_SERVER_BANNER_ACK,!0,StateManager.PROJECT_CONTEXT))})}),$modal.find(".close-icon").click(()=>{customServerModalBar&&customServerModalBar.close(),customServerModalBar=null,StateManager.set(STATE_CUSTOM_SERVER_BANNER_ACK,!0,StateManager.PROJECT_CONTEXT)})}function _registerHandlers(){$("html").on("click",function(e){$(e.target).closest("#livePreviewModeBtn").length||_closeDropdown()}),$(document).on("click","#livePreviewModeBtn",function(e){_handleLPModeBtnClick(e)}),$(document).on("keydown",function(e){"F8"===e.key&&(e.preventDefault(),_handlePreviewBtnClick())})}AppInit.appReady(function(){if(Phoenix.isSpecRunnerWindow)return;panelShownAtStartup=!LivePreviewSettings.shouldShowLivePreviewAtStartup(),Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW,"atStart",LivePreviewSettings.shouldShowLivePreviewAtStartup()?"show":"hide"),_createExtensionPanel(),StaticServer.init(),LiveDevServerManager.registerServer({create:_createStaticServer},5),ProjectManager.on(ProjectManager.EVENT_PROJECT_FILE_CHANGED,_projectFileChanges),ProjectManager.on(ProjectManager.EVENT_PROJECT_OPEN,_projectOpened),ProjectManager.on(ProjectManager.EVENT_PROJECT_CLOSE,_projectClosed),EditorManager.on("activeEditorChange",_activeDocChanged),ProjectManager.on(ProjectManager.EVENT_AFTER_STARTUP_FILES_LOADED,_startupFilesLoaded);let fileChangeListenerStartDelay=0;Phoenix.isNativeApp&&"mac"===Phoenix.platform&&(fileChangeListenerStartDelay=600),setTimeout(()=>{MainViewManager.on("currentFileChange",_currentFileChanged),Phoenix.isNativeApp&&"mac"===Phoenix.platform&&MainViewManager.getCurrentlyViewedFile()&&_currentFileChanged(null,MainViewManager.getCurrentlyViewedFile())},fileChangeListenerStartDelay),CommandManager.register(Strings.CMD_LIVE_FILE_PREVIEW,Commands.FILE_LIVE_FILE_PREVIEW,function(){_toggleVisibilityOnClick()}),CommandManager.register(Strings.CMD_LIVE_FILE_PREVIEW_SETTINGS,Commands.FILE_LIVE_FILE_PREVIEW_SETTINGS,_showSettingsDialog),CommandManager.register(Strings.CMD_RELOAD_LIVE_PREVIEW,Commands.CMD_RELOAD_LIVE_PREVIEW,function(){_loadPreview(!0,!0)});let fileMenu=Menus.getMenu(Menus.AppMenuBar.FILE_MENU);function refreshPreview(){StaticServer.getPreviewDetails().then(previewDetails=>{if(_openReadmeMDIfFirstTime(),!LivePreviewSettings.shouldShowLivePreviewAtStartup())return;!previewDetails.URL||!isBrowser&&previewDetails.isNoPreview||panelShownAtStartup||_setPanelVisibility(!0);const shouldReload=!Phoenix.isNativeApp;_loadPreview(!0,shouldReload)})}fileMenu.addMenuItem(Commands.FILE_LIVE_FILE_PREVIEW,"",Menus.AFTER,Commands.FILE_EXTENSION_MANAGER),fileMenu.addMenuItem(Commands.CMD_RELOAD_LIVE_PREVIEW,"",Menus.AFTER,Commands.FILE_LIVE_FILE_PREVIEW),fileMenu.addMenuItem(Commands.FILE_LIVE_FILE_PREVIEW_SETTINGS,"",Menus.AFTER,Commands.CMD_RELOAD_LIVE_PREVIEW),fileMenu.addMenuDivider(Menus.BEFORE,Commands.FILE_LIVE_FILE_PREVIEW),_registerHandlers(),_initializeMode(),PreferencesManager.on("change","livePreviewMode",function(){_initializeMode()}),PreferencesManager.on("change",PREFERENCE_PROJECT_ELEMENT_HIGHLIGHT,function(){LiveDevelopment.updateElementHighlightConfig()}),PreferencesManager.on("change",PREFERENCE_SHOW_RULER_LINES,function(){LiveDevelopment.updateRulerLinesConfig()}),LiveDevelopment.updateElementHighlightConfig(),LiveDevelopment.updateRulerLinesConfig(),LiveDevelopment.openLivePreview(),LiveDevelopment.on(LiveDevelopment.EVENT_OPEN_PREVIEW_URL,_openLivePreviewURL),LiveDevelopment.on(LiveDevelopment.EVENT_LIVE_PREVIEW_RELOAD,()=>{_loadPreview(!0)}),MultiBrowserLiveDev.on(MultiBrowserLiveDev.EVENT_STATUS_CHANGE,function(event,status){LivePreviewSettings.isUsingCustomServer()?_hideOverlay():status===MultiBrowserLiveDev.STATUS_CONNECTING?_handleOverlay(Strings.LIVE_DEV_STATUS_TIP_PROGRESS1,status):status===MultiBrowserLiveDev.STATUS_SYNC_ERROR?_handleOverlay(Strings.LIVE_DEV_STATUS_TIP_SYNC_ERROR,status):_hideOverlay()});let customServerRefreshedOnce=!1;function _handleNewCustomServer(){customLivePreviewBannerShown=!1,refreshPreview(),_customServerMetrics()}StaticServer.on(StaticServer.EVENT_SERVER_READY,function(_evt,event){LivePreviewSettings.isUsingCustomServer()&&customServerRefreshedOnce||(customServerRefreshedOnce=!0,refreshPreview())}),LivePreviewSettings.on(LivePreviewSettings.EVENT_SERVER_CHANGED,_handleNewCustomServer),LivePreviewSettings.on(LivePreviewSettings.EVENT_CUSTOM_SERVER_ENABLED_CHANGED,(_evt,enabled)=>{enabled?_handleNewCustomServer():$panel.find(".live-preview-custom-banner").addClass("forced-hidden")});let consecutiveEmptyClientsCount=0;setInterval(()=>{StaticServer.hasActiveLivePreviews()?consecutiveEmptyClientsCount=0:consecutiveEmptyClientsCount++,consecutiveEmptyClientsCount>5&&_startOrStopLivePreviewIfRequired()},1e3),_projectOpened(),Phoenix.isSpecRunnerWindow||(_entitlementsChanged(),KernalModeTrust.EntitlementsManager&&KernalModeTrust.EntitlementsManager.on(KernalModeTrust.EntitlementsManager.EVENT_ENTITLEMENTS_CHANGED,_entitlementsChanged))}),exports.LIVE_PREVIEW_PANEL_ID=LIVE_PREVIEW_PANEL_ID});