define(function(require,exports,module){const KeyEvent=require("utils/KeyEvent"),EditorManager=require("editor/EditorManager"),TAB_STOP_REGEX=/\$\{(\d+)\}/g;let activeSnippetSession=null;function SnippetSession(editor,tabStops,startLine,endLine){this.editor=editor,this.tabStops=tabStops,this.currentTabNumber=tabStops.length>0?tabStops[0].number:1,this.startLine=startLine,this.endLine=endLine,this.isActive=!0}function parseTemplateText(templateText){const tabStops=[];let match;for(TAB_STOP_REGEX.lastIndex=0;null!==(match=TAB_STOP_REGEX.exec(templateText));){const tabNumber=parseInt(match[1],10);tabStops.push({number:tabNumber})}return tabStops.sort((a,b)=>0===a.number?1:0===b.number?-1:a.number-b.number),{text:templateText,tabStops:tabStops}}function findTabStops(editor,startLine,endLine){const tabStops=[],document=editor.document;for(let line=startLine;line<=endLine;line++){const lineText=document.getLine(line);let match;for(TAB_STOP_REGEX.lastIndex=0;null!==(match=TAB_STOP_REGEX.exec(lineText));){const tabNumber=parseInt(match[1],10);tabStops.push({number:tabNumber,line:line,start:{line:line,ch:match.index},end:{line:line,ch:match.index+match[0].length}})}}return tabStops.sort((a,b)=>0===a.number?1:0===b.number?-1:a.number-b.number),tabStops}function shouldContinueSession(){if(!activeSnippetSession||!activeSnippetSession.isActive)return!1;const session=activeSnippetSession,tabStops=findTabStops(session.editor,session.startLine,session.endLine);return session.tabStops=tabStops,tabStops.length>0}function getLineIndentation(editor,position){const line=editor.document.getLine(position.line),match=line.match(/^\s*/);return match?match[0]:""}function addIndentationToSnippet(templateText,baseIndent){const lines=templateText.split(/(\r\n|\n)/g);let result="",isFirstLine=!0;for(let i=0;i<lines.length;i++){const line=lines[i];"\n"!==line&&"\r\n"!==line?""!==line.trim()?isFirstLine?(result+=line,isFirstLine=!1):result+=baseIndent+line:result+=line:result+=line}return result}function insertSnippetWithTabStops(editor,templateText,startPos,endPos){const parsed=parseTemplateText(templateText),baseIndent=getLineIndentation(editor,startPos),indentedText=addIndentationToSnippet(parsed.text,baseIndent);editor.document.replaceRange(indentedText,startPos,endPos);const lines=indentedText.split("\n"),startLine=startPos.line,endLine=startPos.line+lines.length-1,tabStops=findTabStops(editor,startLine,endLine);if(tabStops.length>0)navigateToTabStop((activeSnippetSession=new SnippetSession(editor,tabStops,startLine,endLine)).currentTabNumber);else{const finalPos={line:endLine,ch:1===lines.length?startPos.ch+lines[0].length:lines[lines.length-1].length};editor.setCursorPos(finalPos)}}function navigateToTabStop(tabNumber){if(!shouldContinueSession())return void endSnippetSession();const session=activeSnippetSession,tabStop=session.tabStops.find(t=>t.number===tabNumber);tabStop?(session.currentTabNumber=tabNumber,session.editor.setSelection(tabStop.start,tabStop.end),session.editor.focus()):endSnippetSession()}function navigateToNextTabStop(){if(!shouldContinueSession())return endSnippetSession(),!1;const session=activeSnippetSession,currentNumber=session.currentTabNumber;let nextTabStop=null;if(0===currentNumber)return endSnippetSession(),!1;for(let i=0;i<session.tabStops.length;i++)if(session.tabStops[i].number>currentNumber&&0!==session.tabStops[i].number){nextTabStop=session.tabStops[i];break}return nextTabStop||(nextTabStop=session.tabStops.find(t=>0===t.number)),nextTabStop?(navigateToTabStop(nextTabStop.number),!0):(endSnippetSession(),!1)}function navigateToPreviousTabStop(){if(!shouldContinueSession())return endSnippetSession(),!1;const session=activeSnippetSession,currentNumber=session.currentTabNumber;let prevTabStop=null;if(0===currentNumber){let maxNumber=-1;for(let i=0;i<session.tabStops.length;i++)0!==session.tabStops[i].number&&session.tabStops[i].number>maxNumber&&(maxNumber=session.tabStops[i].number,prevTabStop=session.tabStops[i])}else for(let i=session.tabStops.length-1;i>=0;i--)if(session.tabStops[i].number<currentNumber&&0!==session.tabStops[i].number){prevTabStop=session.tabStops[i];break}return!!prevTabStop&&(navigateToTabStop(prevTabStop.number),!0)}function endSnippetSession(){if(activeSnippetSession){const session=activeSnippetSession,tabStops=findTabStops(session.editor,session.startLine,session.endLine);tabStops.reverse().forEach(tabStop=>{session.editor.document.replaceRange("",tabStop.start,tabStop.end)}),activeSnippetSession.isActive=!1,activeSnippetSession=null}}function isInSnippetSession(){return activeSnippetSession&&activeSnippetSession.isActive}function isCursorInSnippetLines(cursorPos){return!!activeSnippetSession&&(cursorPos.line>=activeSnippetSession.startLine&&cursorPos.line<=activeSnippetSession.endLine)}function handleKeyEvent(jqEvent,editor,event){if(!isInSnippetSession()||activeSnippetSession.editor!==editor)return!1;const cursorPos=editor.getCursorPos();if(!isCursorInSnippetLines(cursorPos))return endSnippetSession(),!1;if(event.keyCode===KeyEvent.DOM_VK_TAB)if(event.shiftKey){if(navigateToPreviousTabStop())return event.preventDefault(),!0}else if(navigateToNextTabStop())return event.preventDefault(),!0;return event.keyCode===KeyEvent.DOM_VK_ESCAPE?(endSnippetSession(),event.preventDefault(),!0):(event.keyCode!==KeyEvent.DOM_VK_DELETE&&event.keyCode!==KeyEvent.DOM_VK_BACK_SPACE||setTimeout(()=>{shouldContinueSession()||endSnippetSession()},10),!1)}function handleCursorActivity(event,editor){if(!isInSnippetSession()||activeSnippetSession.editor!==editor)return;if(editor.getSelections().length>1)return void endSnippetSession();const cursorPos=editor.getCursorPos();isCursorInSnippetLines(cursorPos)||endSnippetSession()}function registerHandlers(){const editorHolder=$("#editor-holder")[0];function registerCursorActivityForEditor(editor){editor&&editor.on("cursorActivity",handleCursorActivity)}editorHolder&&editorHolder.addEventListener("keydown",function(event){const editor=EditorManager.getActiveEditor();editor&&handleKeyEvent(null,editor,event)},!0),EditorManager.on("activeEditorChange",function(event,current,previous){isInSnippetSession()&&endSnippetSession()});const currentEditor=EditorManager.getActiveEditor();currentEditor&&registerCursorActivityForEditor(currentEditor),EditorManager.on("activeEditorChange",function(event,current,previous){previous&&previous.off("cursorActivity",handleCursorActivity),current&&registerCursorActivityForEditor(current),isInSnippetSession()&&endSnippetSession()})}exports.parseTemplateText=parseTemplateText,exports.insertSnippetWithTabStops=insertSnippetWithTabStops,exports.isInSnippetSession=isInSnippetSession,exports.handleKeyEvent=handleKeyEvent,exports.handleCursorActivity=handleCursorActivity,exports.endSnippetSession=endSnippetSession,exports.registerHandlers=registerHandlers});