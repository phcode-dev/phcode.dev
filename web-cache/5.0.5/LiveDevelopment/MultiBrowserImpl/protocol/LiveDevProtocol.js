define(function(require,exports,module){const EventDispatcher=require("utils/EventDispatcher"),CONSTANTS=require("LiveDevelopment/LivePreviewConstants"),LiveDevProtocolRemote=require("text!LiveDevelopment/BrowserScripts/LiveDevProtocolRemote.js"),DocumentObserver=require("text!LiveDevelopment/BrowserScripts/DocumentObserver.js"),LanguageManager=require("language/LanguageManager"),RemoteFunctions=require("text!LiveDevelopment/BrowserScripts/RemoteFunctions.js"),EditorManager=require("editor/EditorManager"),LiveDevMultiBrowser=require("LiveDevelopment/LiveDevMultiBrowser"),PreferencesManager=require("preferences/PreferencesManager"),HTMLInstrumentation=require("LiveDevelopment/MultiBrowserImpl/language/HTMLInstrumentation"),StringUtils=require("utils/StringUtils"),FileViewController=require("project/FileViewController"),MainViewManager=require("view/MainViewManager"),LIVE_DEV_REMOTE_SCRIPTS_FILE_NAME=`phoenix_live_preview_scripts_instrumented_${StringUtils.randomString(8)}.js`,LIVE_DEV_REMOTE_WORKER_SCRIPTS_FILE_NAME=`pageLoaderWorker_${StringUtils.randomString(8)}.js`,EVENT_LIVE_PREVIEW_CLICKED="livePreviewClicked",EVENT_LIVE_PREVIEW_RELOAD="livePreviewReload",MAX_PENDING_LP_CALLS_1000=1e3;var _connections={},_transport=null,_nextMsgId=1;const pendingLpResponses=new Phoenix.libs.LRUCache({max:1e3}),pendingCallsByClient=new Map;function _trackPending(fnCallID,clientId,deferred){pendingLpResponses.set(fnCallID,{deferred:deferred,clientId:clientId});let set=pendingCallsByClient.get(clientId);set||(set=new Set,pendingCallsByClient.set(clientId,set)),set.add(fnCallID)}function _untrackPending(fnCallID){const pendingHandler=pendingLpResponses.get(fnCallID);if(pendingHandler){if(pendingLpResponses.delete(fnCallID),pendingHandler.clientId){const set=pendingCallsByClient.get(pendingHandler.clientId);set&&(set.delete(fnCallID),0===set.size&&pendingCallsByClient.delete(pendingHandler.clientId))}return pendingHandler}}function rejectAllPendingForClient(clientId){const set=pendingCallsByClient.get(clientId);if(!set||0===set.size)return;const callIds=Array.from(set);for(const fnCallID of callIds){const pendingHandler=_untrackPending(fnCallID);pendingHandler&&pendingHandler.deferred.reject(new Error(`Live Preview client disconnected: ${clientId}`))}}let _remoteFunctionProvider=null;function setCustomRemoteFunctionProvider(callbackFn){_remoteFunctionProvider=callbackFn}function getConnectionIds(){return Object.keys(_connections)}function _focusEditorIfNeeded(editor,tagName,contentEditable){const focusShouldBeInLivePreview=["INPUT","TEXTAREA"].includes(tagName)||contentEditable;focusShouldBeInLivePreview||editor.focus()}const cssLangIDS=["css","scss","sass","less"],lessLangIDS=["scss","sass","less"];function _isLessOrSCSS(editor){if(!editor)return!1;const language=LanguageManager.getLanguageForPath(editor.document.file.fullPath);return language&&lessLangIDS.includes(language.getId())}function _searchAndCursorIfCSS(editor,allSelectors,nodeName){const codeMirror=editor._codeMirror,language=LanguageManager.getLanguageForPath(editor.document.file.fullPath);if(!language||!cssLangIDS.includes(language.getId()))return;if(allSelectors&&allSelectors.length)for(let selector of allSelectors){const cursor=codeMirror.getSearchCursor(selector),found=cursor.findNext();if(found)return void editor.setCursorPos(cursor.from().line,cursor.from().ch,!0)}const htmlTagSearch=new RegExp(nodeName,"i"),cursor=codeMirror.getSearchCursor(htmlTagSearch),found=cursor.findNext();found&&editor.setCursorPos(cursor.from().line,cursor.from().ch,!0)}function _tagSelectedInLivePreview(tagId,nodeName,contentEditable,allSelectors){const livePreviewMode=PreferencesManager.get(CONSTANTS.PREFERENCE_LIVE_PREVIEW_MODE);if(livePreviewMode===CONSTANTS.LIVE_PREVIEW_MODE)return;const liveDoc=LiveDevMultiBrowser.getCurrentLiveDoc(),activeEditor=EditorManager.getActiveEditor(),activeFullEditor=EditorManager.getCurrentFullEditor(),liveDocPath=liveDoc?liveDoc.doc.file.fullPath:null,activeEditorPath=activeEditor?activeEditor.document.file.fullPath:null,activeFullEditorPath=activeFullEditor?activeFullEditor.document.file.fullPath:null;if(!liveDocPath)return void(activeEditor&&activeEditor.focus());const allOpenFileCount=MainViewManager.getWorkingSetSize(MainViewManager.ALL_PANES);function selectInHTMLEditor(fullHtmlEditor){const positionResult=HTMLInstrumentation.getPositionFromTagId(fullHtmlEditor,parseInt(tagId,10));if(positionResult&&positionResult.from&&fullHtmlEditor){const position=positionResult.from,masterEditor=fullHtmlEditor.document._masterEditor||fullHtmlEditor;masterEditor.setCursorPos(position.line,position.ch,!0),_focusEditorIfNeeded(masterEditor,nodeName,contentEditable)}}liveDocPath===activeFullEditorPath?selectInHTMLEditor(activeFullEditor):liveDoc.isRelated(activeEditorPath)||_isLessOrSCSS(activeEditor)?(_focusEditorIfNeeded(activeEditor,nodeName,contentEditable),_searchAndCursorIfCSS(activeEditor,allSelectors,nodeName)):allOpenFileCount||FileViewController.openAndSelectDocument(liveDocPath,FileViewController.WORKING_SET_VIEW,MainViewManager.ACTIVE_PANE).done(()=>{selectInHTMLEditor(EditorManager.getActiveEditor())})}const processedMessageIDs=new Phoenix.libs.LRUCache({max:1e3});let _livePreviewMessageHandler;function setLivePreviewMessageHandler(handler){_livePreviewMessageHandler=handler}function _receive(clientId,msgStr,messageID){const msg=JSON.parse(msgStr),event=msg.method||"event";if(!messageID||!processedMessageIDs.has(messageID))if(messageID&&processedMessageIDs.set(messageID,!0),msg&&"object"==typeof msg&&msg.execFnName)_executePhoenixFn(msg.execFnName,msg.paramObj,msg.fnExecID,clientId);else{if(_livePreviewMessageHandler){let preventDefault;if(_livePreviewMessageHandler(msg))return}if(msg.requestConfigRefresh)LiveDevMultiBrowser.refreshConfig();else if(msg.id){const pendingHandler=_untrackPending(msg.id);pendingHandler&&(msg.error?pendingHandler.deferred.reject(msg):pendingHandler.deferred.resolve(msg))}else if(msg.clicked&&msg.tagId){const livePreviewMode=PreferencesManager.get(CONSTANTS.PREFERENCE_LIVE_PREVIEW_MODE),editMode=livePreviewMode===CONSTANTS.LIVE_EDIT_MODE,liveDoc=LiveDevMultiBrowser.getCurrentLiveDoc();editMode&&liveDoc&&liveDoc.disableHighlightOnCursorActivity(!0);try{_tagSelectedInLivePreview(msg.tagId,msg.nodeName,msg.contentEditable,msg.allSelectors),exports.trigger(EVENT_LIVE_PREVIEW_CLICKED,msg)}catch(e){console.error("error in tag selection",e)}editMode&&liveDoc&&liveDoc.disableHighlightOnCursorActivity(!1),liveDoc&&liveDoc.updateHighlight()}else msg.clientId=clientId,exports.trigger(event,msg)}}function _send(msg,clients){var id=_nextMsgId++,result=new $.Deferred;if(!_transport)return console.error("Cannot send message before live preview transport initialised"),result.reject(),result.promise();if(clients=clients||getConnectionIds(),msg.id=id,Array.isArray(clients)||(clients=[clients]),0===clients.length)return result.reject(new Error("No live preview clients connected")),result.promise();const clientId=clients[0];return _trackPending(id,clientId,result),_transport.send(clients,JSON.stringify(msg)),result.promise()}function _connect(clientId,url){_connections[clientId]=!0,exports.trigger("ConnectionConnect",{clientId:clientId,url:url}),triggerLPFn("PH_LP_COMM_READY","",clientId)}function _close(clientId){_connections[clientId]&&(rejectAllPendingForClient(clientId),delete _connections[clientId],exports.trigger("ConnectionClose",{clientId:clientId}))}function setTransport(transport){_transport&&_transport.off(".livedev"),(_transport=transport).on("connect.livedev",function(event,msg){_connect(msg[0],msg[1])}).on("message.livedev",function(event,msg){_receive(msg[0],msg[1],msg[2])}).on("close.livedev",function(event,msg){_close(msg[0])}),_transport.start()}function _getRemoteFunctionsScript(){let script="";return script+=DocumentObserver,"\n"+(script+=_remoteFunctionProvider?_remoteFunctionProvider():"\nwindow._LD=("+RemoteFunctions+"("+JSON.stringify(LiveDevMultiBrowser.getConfig())+"))")+"\n"}function getRemoteScriptContents(){const transportScript=_transport.getRemoteScript()||"",remoteFunctionsScript=_getRemoteFunctionsScript()||"";return transportScript+"\n"+LiveDevProtocolRemote+"\n"+remoteFunctionsScript}function getRemoteScript(){return`\n\t\t<script src="${LIVE_DEV_REMOTE_SCRIPTS_FILE_NAME}"><\/script>`}function evaluate(script,clients){return _send({method:"Runtime.evaluate",params:{expression:script}},clients)}function setStylesheetText(url,text,clients){return _send({method:"CSS.setStylesheetText",params:{url:url,text:text}})}function getStylesheetText(url,clients){return _send({method:"CSS.getStylesheetText",params:{url:url}},clients)}function reload(ignoreCache,clients){return exports.trigger(EVENT_LIVE_PREVIEW_RELOAD,clients),_send({method:"Page.reload",params:{ignoreCache:!0}},clients)}const registeredFunctions={};function registerPhoenixFn(fnName,fn){if(registeredFunctions[fnName])throw new Error(`Function "${fnName}" already registered with LPComm`);registeredFunctions[fnName]=fn}function _toErrorString(e){return e instanceof Error?e.stack?`${e.message}\n${e.stack}`:e.message||String(e):String(e)}function _executePhoenixFn(fnName,params,fnExecID,clientId){try{if(registeredFunctions[fnName]){const response=registeredFunctions[fnName](params,clientId);if(response instanceof Promise)return void response.then(resolveValue=>{_transport.send([clientId],JSON.stringify({method:"phoenixFnResponse",fnName:fnName,fnExecID:fnExecID,resolveWith:resolveValue}))}).catch(err=>{_transport.send([clientId],JSON.stringify({method:"phoenixFnResponse",fnName:fnName,fnExecID:fnExecID,rejectWith:_toErrorString(err)}))});_transport.send([clientId],JSON.stringify({method:"phoenixFnResponse",fnName:fnName,fnExecID:fnExecID,resolveWith:response}))}else console.error(`Function "${fnName}" not registered with registerPhoenixFn`),_transport.send([clientId],JSON.stringify({method:"phoenixFnResponse",fnName:fnName,fnExecID:fnExecID,rejectWith:`Function "${fnName}" not registered with registerPhoenixFn`}))}catch(err){_transport.send([clientId],JSON.stringify({method:"phoenixFnResponse",fnName:fnName,fnExecID:fnExecID,rejectWith:_toErrorString(err)}))}}function triggerLPFn(fnName,fnArgs,clientIdOrArray){let clientIds;(clientIds=null==clientIdOrArray?getConnectionIds():Array.isArray(clientIdOrArray)?clientIdOrArray:[clientIdOrArray]).map(clientId=>{_transport.send([clientId],JSON.stringify({method:"PhoenixComm.execLPFn",fnName:fnName,params:fnArgs}))})}function close(clientId){_transport.close(clientId)}function closeAllConnections(){getConnectionIds().forEach(function(clientId){close(clientId),rejectAllPendingForClient(clientId)}),_connections={}}EventDispatcher.makeEventDispatcher(exports),exports.setTransport=setTransport,exports.getRemoteScript=getRemoteScript,exports.getRemoteScriptContents=getRemoteScriptContents,exports.evaluate=evaluate,exports.setStylesheetText=setStylesheetText,exports.getStylesheetText=getStylesheetText,exports.reload=reload,exports.close=close,exports.getConnectionIds=getConnectionIds,exports.closeAllConnections=closeAllConnections,exports.setLivePreviewMessageHandler=setLivePreviewMessageHandler,exports.setCustomRemoteFunctionProvider=setCustomRemoteFunctionProvider,exports.registerPhoenixFn=registerPhoenixFn,exports.triggerLPFn=triggerLPFn,exports.LIVE_DEV_REMOTE_SCRIPTS_FILE_NAME=LIVE_DEV_REMOTE_SCRIPTS_FILE_NAME,exports.LIVE_DEV_REMOTE_WORKER_SCRIPTS_FILE_NAME=LIVE_DEV_REMOTE_WORKER_SCRIPTS_FILE_NAME,exports.EVENT_LIVE_PREVIEW_CLICKED=EVENT_LIVE_PREVIEW_CLICKED,exports.EVENT_LIVE_PREVIEW_RELOAD=EVENT_LIVE_PREVIEW_RELOAD});