define(function(require,exports,module){var CodeMirror=brackets.getModule("thirdparty/CodeMirror/lib/codemirror"),Strings=brackets.getModule("strings"),AppInit=brackets.getModule("utils/AppInit"),CommandManager=brackets.getModule("command/CommandManager"),DocumentManager=brackets.getModule("document/DocumentManager"),Editor=brackets.getModule("editor/Editor").Editor,EditorManager=brackets.getModule("editor/EditorManager"),ProjectManager=brackets.getModule("project/ProjectManager"),ViewStateManager=brackets.getModule("view/ViewStateManager"),KeyBindingManager=brackets.getModule("command/KeyBindingManager"),ExtensionUtils=brackets.getModule("utils/ExtensionUtils"),Menus=brackets.getModule("command/Menus"),prefs=require("Prefs"),COLLAPSE_ALL="codefolding.collapse.all",COLLAPSE="codefolding.collapse",EXPAND="codefolding.expand",EXPAND_ALL="codefolding.expand.all",GUTTER_NAME="CodeMirror-foldgutter",CODE_FOLDING_GUTTER_PRIORITY=Editor.CODE_FOLDING_GUTTER_PRIORITY,codeFoldingMenuDivider="codefolding.divider",collapseKey="Alt-Shift-Left",collapseKeyDisplay="Alt-Shift-←",expandKey="Alt-Shift-Right",expandKeyDisplay="Alt-Shift-→",collapseAllKey="Ctrl-Alt-[",expandAllKey="Ctrl-Alt-]";ExtensionUtils.loadStyleSheet(module,"main.less"),brackets.getModule(["thirdparty/CodeMirror/addon/fold/brace-fold"]),brackets.getModule(["thirdparty/CodeMirror/addon/fold/comment-fold"]),brackets.getModule(["thirdparty/CodeMirror/addon/fold/markdown-fold"]);var foldGutter=require("foldhelpers/foldgutter"),foldCode=require("foldhelpers/foldcode"),indentFold=require("foldhelpers/indentFold"),handlebarsFold=require("foldhelpers/handlebarsFold"),selectionFold=require("foldhelpers/foldSelected"),_isInitialized=!1;function restoreLineFolds(editor){function rangeEqualsSelection(range,selection){return range.from.line===selection.start.line&&range.from.ch===selection.start.ch&&range.to.line===selection.end.line&&range.to.ch===selection.end.ch}function isInViewStateSelection(range,viewState){return!(!viewState||!viewState.selections)&&viewState.selections.some(function(selection){return rangeEqualsSelection(range,selection)})}var saveFolds=prefs.getSetting("saveFoldStates");if(editor&&saveFolds){var cm=editor._codeMirror,viewState=ViewStateManager.getViewState(editor.document.file),path=editor.document.file.fullPath,folds=cm._lineFolds||prefs.getFolds(path)||{},nonSelectionFolds={},selectionFolds={},range;Object.keys(folds).forEach(function(line){isInViewStateSelection(range=folds[line],viewState)?selectionFolds[line]=range:nonSelectionFolds[line]=range}),nonSelectionFolds=cm.getValidFolds(nonSelectionFolds),Object.keys(selectionFolds).forEach(function(line){nonSelectionFolds[line]=selectionFolds[line]}),cm._lineFolds=nonSelectionFolds,prefs.setFolds(path,cm._lineFolds),Object.keys(cm._lineFolds).forEach(function(line){cm.foldCode(Number(line),{range:cm._lineFolds[line]})})}else editor&&(editor._codeMirror._lineFolds=editor._codeMirror._lineFolds||{})}function saveLineFolds(editor){var saveFolds=prefs.getSetting("saveFoldStates");if(editor&&saveFolds){var folds=editor._codeMirror._lineFolds||{},path=editor.document.file.fullPath;Object.keys(folds).length?prefs.setFolds(path,folds):prefs.setFolds(path,void 0)}}function onGutterClick(cm,line,gutter,event){var opts=cm.state.foldGutter.options,pos=CodeMirror.Pos(line);if(gutter===opts.gutter){var range,_lineFolds=cm._lineFolds;cm.isFolded(line)?event.altKey?(range=_lineFolds[line],CodeMirror.commands.unfoldAll(cm,range.from.line,range.to.line)):cm.unfoldCode(line,{range:_lineFolds[line]}):event.altKey?(range=CodeMirror.fold.auto(cm,pos))&&CodeMirror.commands.foldToLevel(cm,range.from.line,range.to.line):cm.foldCode(line)}}function collapseCurrent(){var editor=EditorManager.getFocusedEditor();if(editor){var cm=editor._codeMirror,cursor,i;for(i=editor.getCursorPos().line;i>=0;i--)if(cm.foldCode(i))return void editor.setCursorPos(i)}}function expandCurrent(){var editor=EditorManager.getFocusedEditor();if(editor){var cursor=editor.getCursorPos(),cm;editor._codeMirror.unfoldCode(cursor.line)}}function collapseAll(){var editor=EditorManager.getFocusedEditor();if(editor){var cm=editor._codeMirror;CodeMirror.commands.foldAll(cm)}}function expandAll(){var editor=EditorManager.getFocusedEditor();if(editor){var cm=editor._codeMirror;CodeMirror.commands.unfoldAll(cm)}}function clearGutter(editor){var cm=editor._codeMirror,BLANK_GUTTER_CLASS="CodeMirror-foldgutter-blank";editor.clearGutter(GUTTER_NAME);var blank=window.document.createElement("div");blank.className=BLANK_GUTTER_CLASS;var vp=cm.getViewport();cm.operation(function(){cm.eachLine(vp.from,vp.to,function(line){editor.setGutterMarker(line.lineNo(),GUTTER_NAME,blank)})})}function setupGutterEventListeners(editor){var cm=editor._codeMirror;$(editor.getRootElement()).addClass("folding-enabled"),cm.setOption("foldGutter",{onGutterClick:onGutterClick}),$(cm.getGutterElement()).on({mouseenter:function(){prefs.getSetting("hideUntilMouseover")?foldGutter.updateInViewport(cm):$(editor.getRootElement()).addClass("over-gutter")},mouseleave:function(){prefs.getSetting("hideUntilMouseover")?clearGutter(editor):$(editor.getRootElement()).removeClass("over-gutter")}})}function removeGutters(editor){Editor.unregisterGutter(GUTTER_NAME),$(editor.getRootElement()).removeClass("folding-enabled"),CodeMirror.defineOption("foldGutter",!1,null)}function enableFoldingInEditor(editor){restoreLineFolds(editor),setupGutterEventListeners(editor),editor._codeMirror.refresh()}function onActiveEditorChanged(event,current,previous){current&&!current._codeMirror._lineFolds&&enableFoldingInEditor(current),previous&&saveLineFolds(previous)}function saveBeforeClose(){saveLineFolds(EditorManager.getActiveEditor())}function deinit(){_isInitialized=!1,KeyBindingManager.removeBinding(collapseKey),KeyBindingManager.removeBinding(expandKey),KeyBindingManager.removeBinding(collapseAllKey),KeyBindingManager.removeBinding(expandAllKey),Menus.getMenu(Menus.AppMenuBar.VIEW_MENU).removeMenuDivider(codeFoldingMenuDivider.id),Menus.getMenu(Menus.AppMenuBar.VIEW_MENU).removeMenuItem(COLLAPSE),Menus.getMenu(Menus.AppMenuBar.VIEW_MENU).removeMenuItem(EXPAND),Menus.getMenu(Menus.AppMenuBar.VIEW_MENU).removeMenuItem(COLLAPSE_ALL),Menus.getMenu(Menus.AppMenuBar.VIEW_MENU).removeMenuItem(EXPAND_ALL),EditorManager.off(".CodeFolding"),DocumentManager.off(".CodeFolding"),ProjectManager.off(".CodeFolding"),Editor.forEveryEditor(function(editor){CodeMirror.commands.unfoldAll(editor._codeMirror)}),removeGutters()}function init(){_isInitialized=!0,foldCode.init(),foldGutter.init(),CodeMirror.registerGlobalHelper("fold","selectionFold",function(mode,cm){return prefs.getSetting("makeSelectionsFoldable")},selectionFold),CodeMirror.registerGlobalHelper("fold","indent",function(mode,cm){return prefs.getSetting("alwaysUseIndentFold")},indentFold),CodeMirror.registerHelper("fold","handlebars",handlebarsFold),CodeMirror.registerHelper("fold","htmlhandlebars",handlebarsFold),CodeMirror.registerHelper("fold","htmlmixed",handlebarsFold),EditorManager.on("activeEditorChange.CodeFolding",onActiveEditorChanged),DocumentManager.on("documentRefreshed.CodeFolding",function(event,doc){restoreLineFolds(doc._masterEditor)}),ProjectManager.on("beforeProjectClose.CodeFolding beforeAppClose.CodeFolding",saveBeforeClose),codeFoldingMenuDivider=Menus.getMenu(Menus.AppMenuBar.VIEW_MENU).addMenuDivider(),Menus.getMenu(Menus.AppMenuBar.VIEW_MENU).addMenuItem(COLLAPSE_ALL),Menus.getMenu(Menus.AppMenuBar.VIEW_MENU).addMenuItem(EXPAND_ALL),Menus.getMenu(Menus.AppMenuBar.VIEW_MENU).addMenuItem(COLLAPSE),Menus.getMenu(Menus.AppMenuBar.VIEW_MENU).addMenuItem(EXPAND),KeyBindingManager.addBinding(COLLAPSE_ALL,[{key:collapseAllKey}]),KeyBindingManager.addBinding(EXPAND_ALL,[{key:expandAllKey}]),KeyBindingManager.addBinding(COLLAPSE,[{key:collapseKey,displayKey:collapseKeyDisplay}]),KeyBindingManager.addBinding(EXPAND,[{key:expandKey,displayKey:expandKeyDisplay}]),Editor.registerGutter(GUTTER_NAME,CODE_FOLDING_GUTTER_PRIORITY),Editor.forEveryEditor(function(editor){enableFoldingInEditor(editor)})}function watchPrefsForChanges(){prefs.prefsObject.on("change",function(e,data){if(data.ids.indexOf("enabled")>-1){var isEnabled=prefs.getSetting("enabled");isEnabled&&!_isInitialized?init():!isEnabled&&_isInitialized&&deinit()}})}AppInit.htmlReady(function(){CommandManager.register(Strings.COLLAPSE_ALL,COLLAPSE_ALL,collapseAll),CommandManager.register(Strings.EXPAND_ALL,EXPAND_ALL,expandAll),CommandManager.register(Strings.COLLAPSE_CURRENT,COLLAPSE,collapseCurrent),CommandManager.register(Strings.EXPAND_CURRENT,EXPAND,expandCurrent),prefs.getSetting("enabled")&&init(),watchPrefsForChanges()})});
//# sourceMappingURL=main.js.map
