!function(root,mod){"object"==typeof exports&&"object"==typeof module?mod(exports,require("./infer"),require("./signal"),require("acorn"),require("acorn-walk")):"function"==typeof define&&define.amd?define(["exports","./infer","./signal","acorn/dist/acorn","acorn-walk/dist/walk"],mod):mod(root.tern||(root.tern={}),tern,tern.signal,acorn,acorn.walk)}(this,function(exports,infer,signal,acorn,walk){"use strict";var plugins=Object.create(null);exports.registerPlugin=function(name,init){plugins[name]=init};var defaultOptions=exports.defaultOptions={debug:!1,async:!1,getFile:function(_f,c){this.async&&c(null,null)},normalizeFilename:function(name){return name},defs:[],plugins:{},fetchTimeout:1e3,dependencyBudget:2e4,reuseInstances:!0,stripCRs:!1,ecmaVersion:9,projectDir:"/",parent:null},queryTypes={completions:{takesFile:!0,run:findCompletions},properties:{run:findProperties},type:{takesFile:!0,run:findTypeAt},documentation:{takesFile:!0,run:findDocs},definition:{takesFile:!0,run:findDef},refs:{takesFile:!0,fullFile:!0,run:findRefs},rename:{takesFile:!0,fullFile:!0,run:buildRename},files:{run:listFiles}};function File(name,parent){this.name=name,this.parent=parent,this.scope=this.text=this.ast=this.lineOffsets=null}function parseFile(srv,file){var options={directSourceFile:file,allowReturnOutsideFunction:!0,allowImportExportEverywhere:!0,ecmaVersion:srv.options.ecmaVersion,allowHashBang:!0},text=srv.signalReturnFirst("preParse",file.text,options)||file.text,ast=infer.parse(text,options);return srv.signal("postParse",ast,text),ast}exports.defineQueryType=function(name,desc){queryTypes[name]=desc},File.prototype.asLineChar=function(pos){return asLineChar(this,pos)};var astral=/[\uD800-\uDBFF]/g,Server;function updateText(file,text,srv){file.text=srv.options.stripCRs?text.replace(/\r\n/g,"\n"):text,file.hasAstral=astral.test(file.text),infer.withContext(srv.cx,function(){file.ast=parseFile(srv,file)}),file.lineOffsets=null}function doRequest(srv,doc,c){if(doc.query&&!queryTypes.hasOwnProperty(doc.query.type))return c("No query type '"+doc.query.type+"' defined");var query=doc.query;query||c(null,{});var files=doc.files||[];files.length&&++srv.uses;for(var i=0;i<files.length;++i){var file=files[i];file.name=srv.normalizeFilename(file.name),"delete"==file.type?srv.delFile(file.name):ensureFile(srv,file.name,null,"full"==file.type?file.text:null)}var timeBudget="number"==typeof doc.timeout?[doc.timeout]:null;if(query){var queryType=queryTypes[query.type];if(queryType.takesFile){if("string"!=typeof query.file)return c(".query.file must be a string");/^#/.test(query.file)||ensureFile(srv,query.file,null)}analyzeAll(srv,timeBudget,function(err){if(err)return c(err);var file=queryType.takesFile&&resolveFile(srv,files,query.file);if(queryType.fullFile&&"part"==file.type)return c("Can't run a "+query.type+" query on a file fragment");infer.resetGuessing(),infer.withContext(srv.cx,function(){var result,run=function(){result=queryType.run(srv,query,file)};try{timeBudget?infer.withTimeout(timeBudget[0],run):run()}catch(e){return srv.options.debug&&"TernError"!=e.name&&console.error(e.stack),c(e)}c(null,result)})})}else analyzeAll(srv,timeBudget,function(){})}function analyzeFile(srv,file){return infer.withContext(srv.cx,function(){file.scope=srv.cx.topScope,srv.signal("beforeLoad",file),infer.analyze(file.ast,file.name,file.scope),srv.signal("afterLoad",file)}),file}function ensureFile(srv,name,parent,text){var known=srv.findFile(name);if(known)return null!=text&&(known.scope&&(srv.needsPurge.push(name),infer.clearScopes(known.ast),known.scope=null),updateText(known,text,srv)),void(parentDepth(srv,known.parent)>parentDepth(srv,parent)&&(known.parent=parent,known.excluded&&(known.excluded=null)));var file=new File(name,parent);srv.files.push(file),srv.fileMap[name]=file,null!=text?updateText(file,text,srv):srv.options.async?(srv.startAsyncAction(),srv.options.getFile(name,function(err,text){updateText(file,text||"",srv),srv.finishAsyncAction(err)})):updateText(file,srv.options.getFile(name)||"",srv)}function fetchAll(srv,c){var done=!0,returned=!1;srv.files.forEach(function(file){if(null==file.text)if(srv.options.async)done=!1,srv.options.getFile(file.name,function(err,text){if(err&&!returned)return returned=!0,c(err);updateText(file,text||"",srv),fetchAll(srv,c)});else try{updateText(file,srv.options.getFile(file.name)||"",srv)}catch(e){return c(e)}}),done&&c()}function waitOnFetch(srv,timeBudget,c){var done=function(){srv.off("everythingFetched",done),clearTimeout(timeout),analyzeAll(srv,timeBudget,c)};srv.on("everythingFetched",done);var timeout=setTimeout(done,srv.options.fetchTimeout)}function analyzeAll(srv,timeBudget,c){if(srv.pending)return waitOnFetch(srv,timeBudget,c);var e=srv.fetchError;if(e)return srv.fetchError=null,c(e);srv.needsPurge.length>0&&infer.withContext(srv.cx,function(){infer.purge(srv.needsPurge),srv.needsPurge.length=0});for(var done=!0,i=0;i<srv.files.length;){for(var toAnalyze=[];i<srv.files.length;++i){var file;null==(file=srv.files[i]).text?done=!1:null!=file.scope||file.excluded||toAnalyze.push(file)}toAnalyze.sort(function(a,b){return parentDepth(srv,a.parent)-parentDepth(srv,b.parent)});for(var j=0;j<toAnalyze.length;j++){var file;if((file=toAnalyze[j]).parent&&!chargeOnBudget(srv,file))file.excluded=!0;else if(timeBudget){var startTime=+new Date;try{infer.withTimeout(timeBudget[0],function(){analyzeFile(srv,file)})}catch(e){if(e instanceof infer.TimedOut)return c(e);throw e}timeBudget[0]-=+new Date-startTime}else analyzeFile(srv,file)}}done?c():waitOnFetch(srv,timeBudget,c)}function firstLine(str){var end=str.indexOf("\n");return end<0?str:str.slice(0,end)}function findMatchingPosition(line,file,near){var pos=Math.max(0,near-500),closest=null;if(!/^\s*$/.test(line))for(;;){var found=file.indexOf(line,pos);if(found<0||found>near+500)break;(null==closest||Math.abs(closest-near)>Math.abs(found-near))&&(closest=found),pos=found+line.length}return closest}function scopeDepth(s){for(var i=0;s;++i,s=s.prev);return i}function ternError(msg){var err=new Error(msg);return err.name="TernError",err}function resolveFile(srv,localFiles,name){var isRef=name.match(/^#(\d+)$/);if(!isRef)return srv.findFile(name);var file=localFiles[isRef[1]];if(!file||"delete"==file.type)throw ternError("Reference to unknown file "+name);if("full"==file.type)return srv.fileMap[file.name];var realFile=file.backing=srv.fileMap[file.name],offset=resolvePos(realFile,null==file.offsetLines?file.offset:{line:file.offsetLines,ch:0},!0),line=firstLine(file.text),foundPos=findMatchingPosition(line,realFile.text,offset),pos=null==foundPos?Math.max(0,realFile.text.lastIndexOf("\n",offset)):foundPos,inObject,atFunction;return infer.withContext(srv.cx,function(){infer.purge(file.name,pos,pos+file.text.length);var text=file.text,m;if(m=text.match(/(?:"([^"]*)"|([\w$]+))\s*:\s*function\b/)){var objNode=walk.findNodeAround(file.backing.ast,pos,"ObjectExpression");objNode&&objNode.node.objType&&(inObject={type:objNode.node.objType,prop:m[2]||m[1]})}if(foundPos&&(m=line.match(/^(.*?)\bfunction\b/))){for(var cut=m[1].length,white="",i=0;i<cut;++i)white+=" ";file.text=white+text.slice(cut),atFunction=!0}var scopeStart=infer.scopeAt(realFile.ast,pos,realFile.scope),scopeEnd=infer.scopeAt(realFile.ast,pos+text.length,realFile.scope),scope=file.scope=scopeDepth(scopeStart)<scopeDepth(scopeEnd)?scopeEnd:scopeStart;file.ast=parseFile(srv,file),infer.analyze(file.ast,file.name,scope);tieTogether:if(inObject||atFunction){var newInner=infer.scopeAt(file.ast,line.length,scopeStart),prop;if(!newInner.fnType)break tieTogether;if(inObject)inObject.type.getProp(inObject.prop).addType(newInner.fnType);else if(atFunction){var inner=infer.scopeAt(realFile.ast,pos+line.length,realFile.scope);if(inner==scopeStart||!inner.fnType)break tieTogether;var fOld=inner.fnType,fNew=newInner.fnType;if(!fNew||fNew.name!=fOld.name&&fOld.name)break tieTogether;for(var i=0,e=Math.min(fOld.args.length,fNew.args.length);i<e;++i)fOld.args[i].propagate(fNew.args[i]);fOld.self.propagate(fNew.self),fNew.retval.propagate(fOld.retval)}}}),file}function astSize(node){var size=0;return walk.simple(node,{Expression:function(){++size}}),size}function parentDepth(srv,parent){for(var depth=0;parent;)parent=srv.fileMap[parent].parent,++depth;return depth}function budgetName(srv,file){for(;;){var parent=srv.fileMap[file.parent];if(!parent.parent)break;file=parent}return file.name}function chargeOnBudget(srv,file){var bName=budgetName(srv,file),size=astSize(file.ast),known=srv.budgets[bName];return null==known&&(known=srv.budgets[bName]=srv.options.dependencyBudget),!(known<size)&&(srv.budgets[bName]=known-size,!0)}function isPosition(val){return"number"==typeof val||"object"==typeof val&&"number"==typeof val.line&&"number"==typeof val.ch}function invalidDoc(doc){if(doc.query){if("string"!=typeof doc.query.type)return".query.type must be a string";if(doc.query.start&&!isPosition(doc.query.start))return".query.start must be a position";if(doc.query.end&&!isPosition(doc.query.end))return".query.end must be a position"}if(doc.files){if(!Array.isArray(doc.files))return"Files property must be an array";for(var i=0;i<doc.files.length;++i){var file=doc.files[i];if("object"!=typeof file)return".files[n] must be objects";if("string"!=typeof file.name)return".files[n].name must be a string";if("delete"!=file.type){if("string"!=typeof file.text)return".files[n].text must be a string";if("part"==file.type){if(!isPosition(file.offset)&&"number"!=typeof file.offsetLines)return".files[n].offset must be a position"}else if("full"!=file.type)return'.files[n].type must be "full" or "part"'}}}}(exports.Server=function(options){for(var o in this.cx=null,this.options=options||{},defaultOptions)options.hasOwnProperty(o)||(options[o]=defaultOptions[o]);for(var plugin in this.projectDir=options.projectDir.replace(/\\/g,"/"),/\/$/.test(this.projectDir)||(this.projectDir+="/"),this.parent=options.parent,this.handlers=Object.create(null),this.files=[],this.fileMap=Object.create(null),this.needsPurge=[],this.budgets=Object.create(null),this.uses=0,this.pending=0,this.asyncError=null,this.mod={},this.defs=options.defs.slice(0),this.plugins=Object.create(null),options.plugins)options.plugins.hasOwnProperty(plugin)&&this.loadPlugin(plugin,options.plugins[plugin]);this.reset()}).prototype=signal.mixin({addFile:function(name,text,parent){!parent||parent in this.fileMap||(parent=null),name in this.fileMap||(name=this.normalizeFilename(name)),ensureFile(this,name,parent,text)},delFile:function(name){var file=this.findFile(name);if(file){this.needsPurge.push(file.name);for(var i=0;i<this.files.length;i++)this.files[i]==file?this.files.splice(i--,1):this.files[i].parent==name&&(this.files[i].parent=null);delete this.fileMap[file.name]}},reset:function(){this.signal("reset"),this.cx=new infer.Context(this.defs,this),this.uses=0,this.budgets=Object.create(null);for(var i=0;i<this.files.length;++i){var file=this.files[i];file.scope&&(infer.clearScopes(file.ast),file.scope=null)}this.signal("postReset")},request:function(doc,c){var inv=invalidDoc(doc);if(inv)return c(inv);var self=this;doRequest(this,doc,function(err,data){c(err,data),self.uses>40&&(self.reset(),analyzeAll(self,null,function(){}))})},findFile:function(name){return this.fileMap[this.normalizeFilename(name)]},flush:function(c){var cx=this.cx;analyzeAll(this,null,function(err){if(err)return c(err);infer.withContext(cx,c)})},startAsyncAction:function(){++this.pending},finishAsyncAction:function(err){err&&(this.asyncError=err),0==--this.pending&&this.signal("everythingFetched")},addDefs:function(defs,toFront){toFront?this.defs.unshift(defs):this.defs.push(defs),this.cx&&this.reset()},deleteDefs:function(name){for(var i=0;i<this.defs.length;i++)if(this.defs[i]["!name"]==name)return this.defs.splice(i,1),void(this.cx&&this.reset())},loadPlugin:function(name,options){if(1==arguments.length&&(options=this.options.plugins[name]||!0),!(name in this.plugins)&&name in plugins&&options){this.plugins[name]=!0;var init=plugins[name](this,options);if(init&&(init.defs&&this.addDefs(init.defs,init.loadFirst),init.passes))for(var type in init.passes)init.passes.hasOwnProperty(type)&&this.on(type,init.passes[type])}},normalizeFilename:function(name){var norm=this.options.normalizeFilename(name).replace(/\\/g,"/");return 0==norm.indexOf(this.projectDir)&&(norm=norm.slice(this.projectDir.length)),norm}});var offsetSkipLines=25;function forwardCharacters(file,start,chars){var pos=start+chars,m;if(file.hasAstral)for(astral.lastIndex=start;(m=astral.exec(file.text))&&m.index<pos;)pos++;return pos}function findLineStart(file,line){for(var text=file.text,offsets=file.lineOffsets||(file.lineOffsets=[0]),pos=0,curLine=0,storePos=Math.min(Math.floor(line/offsetSkipLines),offsets.length-1),pos=offsets[storePos],curLine=storePos*offsetSkipLines;curLine<line;){if(++curLine,0===(pos=text.indexOf("\n",pos)+1))return null;curLine%offsetSkipLines==0&&offsets.push(pos)}return pos}var resolvePos=exports.resolvePos=function(file,pos,tolerant){if("number"!=typeof pos){var lineStart=findLineStart(file,pos.line);if(null==lineStart){if(!tolerant)throw ternError("File doesn't contain a line "+pos.line);pos=file.text.length}else pos=forwardCharacters(file,lineStart,pos.ch)}else pos=forwardCharacters(file,0,pos);if(pos>file.text.length){if(!tolerant)throw ternError("Position "+pos+" is outside of file.");pos=file.text.length}return pos};function charDistanceBetween(file,start,end){var diff=end-start,m;if(file.hasAstral)for(astral.lastIndex=start;(m=astral.exec(file.text))&&m.index<end;)diff--;return diff}function asLineChar(file,pos){if(!file)return{line:0,ch:0};for(var offsets=file.lineOffsets||(file.lineOffsets=[0]),text=file.text,line,lineStart,i=offsets.length-1;i>=0;--i)offsets[i]<=pos&&(line=i*offsetSkipLines,lineStart=offsets[i]);for(;;){var eol=text.indexOf("\n",lineStart);if(eol>=pos||eol<0)break;lineStart=eol+1,++line}return{line:line,ch:charDistanceBetween(file,lineStart,pos)}}var outputPos=exports.outputPos=function(query,file,pos){if(query.lineCharPositions){var out=asLineChar(file,pos);return"part"==file.type&&(out.line+=null!=file.offsetLines?file.offsetLines:asLineChar(file.backing,file.offset).line),out}return charDistanceBetween(file,0,pos)+("part"==file.type?file.offset:0)};function clean(obj){for(var prop in obj)null==obj[prop]&&delete obj[prop];return obj}function maybeSet(obj,prop,val){null!=val&&(obj[prop]=val)}function compareCompletions(a,b){"string"!=typeof a&&(a=a.name,b=b.name);var aUp=/^[A-Z]/.test(a),bUp;return aUp==/^[A-Z]/.test(b)?a<b?-1:a==b?0:1:aUp?1:-1}function isStringAround(node,start,end){return"Literal"==node.type&&"string"==typeof node.value&&node.start==start-1&&node.end<=end+1}function pointInProp(objNode,point){for(var i=0;i<objNode.properties.length;i++){var curProp=objNode.properties[i];if(curProp.key&&curProp.key.start<=point&&curProp.key.end>=point)return curProp}}var jsKeywords="break do instanceof typeof case else new var catch finally return void continue for switch while debugger function this with default if throw delete in try".split(" "),jsKeywordsES6=jsKeywords.concat("export class extends const super yield import let static".split(" ")),addCompletion=exports.addCompletion=function(query,completions,name,aval,depth){for(var typeInfo=query.types||query.docs||query.urls||query.origins,wrapAsObjs=typeInfo||query.depths,i=0;i<completions.length;++i){var c=completions[i];if((wrapAsObjs?c.name:c)==name)return}var rec=wrapAsObjs?{name:name}:name;if(completions.push(rec),aval&&typeInfo){infer.resetGuessing();var type=aval.getType();rec.guess=infer.didGuess(),query.types&&(rec.type=infer.toString(aval)),query.docs&&maybeSet(rec,"doc",parseDoc(query,aval.doc||type&&type.doc)),query.urls&&maybeSet(rec,"url",aval.url||type&&type.url),query.origins&&maybeSet(rec,"origin",aval.origin||type&&type.origin)}return query.depths&&(rec.depth=depth||0),rec};function findCompletions(srv,query,file){if(null==query.end)throw ternError("missing .query.end field");var fromPlugin=srv.signalReturnFirst("completion",file,query);if(fromPlugin)return fromPlugin;for(var wordStart=resolvePos(file,query.end),wordEnd=wordStart,text=file.text;wordStart&&acorn.isIdentifierChar(text.charCodeAt(wordStart-1));)--wordStart;if(!1!==query.expandWordForward)for(;wordEnd<text.length&&acorn.isIdentifierChar(text.charCodeAt(wordEnd));)++wordEnd;var word=text.slice(wordStart,wordEnd),completions=[],ignoreObj,hookname,prop,objType,isKey;function gather(prop,obj,depth,addInfo){if((!objLit&&!1===query.omitObjectPrototype||obj!=srv.cx.protos.Object||word)&&!(!1!==query.filter&&word&&0!==(query.caseInsensitive?prop.toLowerCase():prop).indexOf(word)||ignoreObj&&ignoreObj.props[prop])){var result=addCompletion(query,completions,prop,obj&&obj.props[prop],depth);addInfo&&result&&"string"!=typeof result&&addInfo(result)}}query.caseInsensitive&&(word=word.toLowerCase());var exprAt=infer.findExpressionAround(file.ast,null,wordStart,file.scope),memberExpr,objLit;if(exprAt){var exprNode=exprAt.node;if(!1===query.inLiteral&&"Literal"===exprNode.type&&("string"==typeof exprNode.value||exprNode.regex))return{start:outputPos(query,file,wordStart),end:outputPos(query,file,wordEnd),completions:[]};if("MemberExpression"==exprNode.type&&exprNode.object.end<wordStart)memberExpr=exprAt;else if(isStringAround(exprNode,wordStart,wordEnd)){var parent=infer.parentNode(exprNode,file.ast);"MemberExpression"==parent.type&&parent.property==exprNode&&(memberExpr={node:parent,state:exprAt.state})}else if("ObjectExpression"==exprNode.type){var objProp=pointInProp(exprNode,wordEnd);objProp?(objLit=exprAt,prop=isKey=objProp.key.name||objProp.key.value):word||/:\s*$/.test(file.text.slice(0,wordStart))||(objLit=exprAt,prop=isKey=!0)}}if(objLit)objType=infer.typeFromContext(file.ast,objLit),ignoreObj=objLit.node.objType;else if(memberExpr)prop="Literal"==(prop=memberExpr.node.property).type?prop.value.slice(1):prop.name,memberExpr.node=memberExpr.node.object,objType=infer.expressionType(memberExpr);else if("."==text.charAt(wordStart-1)){for(var pathStart=wordStart-1;pathStart&&("."==text.charAt(pathStart-1)||acorn.isIdentifierChar(text.charCodeAt(pathStart-1)));)pathStart--;var path=text.slice(pathStart,wordStart-1);path&&(objType=infer.def.parsePath(path,file.scope).getObjType(),prop=word)}if(null!=prop){if(srv.cx.completingProperty=prop,objType&&infer.forAllPropertiesOf(objType,gather),!completions.length&&!1!==query.guess&&objType&&objType.guessProperties&&objType.guessProperties(function(p,o,d){p!=prop&&"âœ–"!=p&&"<i>"!=p&&gather(p,o,d)}),!completions.length&&word.length>=2&&!1!==query.guess)for(var prop in srv.cx.props)gather(prop,srv.cx.props[prop][0],0);hookname="memberCompletion"}else infer.forAllLocalsAt(file.ast,wordStart,file.scope,gather),query.includeKeywords&&(srv.options.ecmaVersion>=6?jsKeywordsES6:jsKeywords).forEach(function(kw){gather(kw,null,0,function(rec){rec.isKeyword=!0})}),hookname="variableCompletion";return srv.signal(hookname,file,wordStart,wordEnd,gather),!1!==query.sort&&completions.sort(compareCompletions),srv.cx.completingProperty=null,{start:outputPos(query,file,wordStart),end:outputPos(query,file,wordEnd),isProperty:!!prop,isObjectKey:!!isKey,completions:completions}}function findProperties(srv,query){var prefix=query.prefix,found=[];for(var prop in srv.cx.props)"<i>"==prop||prefix&&0!==prop.indexOf(prefix)||found.push(prop);return!1!==query.sort&&found.sort(compareCompletions),{completions:found}}function inBody(node,pos){var body=node.body,start,end;return!!body&&(Array.isArray(body)?(start=body[0].start,end=body[body.length-1].end):(start=body.start,end=body.end),start<=pos&&end>=pos)}var findExpr=exports.findQueryExpr=function(file,query,wide){if(null==query.end)throw ternError("missing .query.end field");if(query.variable){var scope=infer.scopeAt(file.ast,resolvePos(file,query.end),file.scope);return{node:{type:"Identifier",name:query.variable,start:query.end,end:query.end+1},state:scope}}var start=query.start&&resolvePos(file,query.start),end=resolvePos(file,query.end),expr=infer.findExpressionAt(file.ast,start,end,file.scope);if(!expr){var span=infer.findClosestExpression(file.ast,start,end,file.scope);span&&!inBody(span.node,end)&&(wide||(null==start?end:start)-span.node.start<20||span.node.end-end<20)&&(expr=span)}if(!expr){var around=infer.findExpressionAround(file.ast,start,end,file.scope);around&&!inBody(around.node,end)&&("ObjectExpression"==around.node.type||wide||(null==start?end:start)-around.node.start<20||around.node.end-end<20)&&(expr=around)}return expr};function findExprAround(file,query,wide){var start=query.start&&resolvePos(file,query.start),end=resolvePos(file,query.end),expr=null,around=infer.findExpressionAround(file.ast,start,end,file.scope);return around&&!inBody(around.node,end)&&("ObjectExpression"==around.node.type||wide||(null==start?end:start)-around.node.start<20||around.node.end-end<20)&&(expr=around),expr}function findExprOrThrow(file,query,wide){var expr=findExpr(file,query,wide);if(expr)return expr;throw ternError("No expression at the given position.")}function ensureObj(tp){return tp&&(tp=tp.getType())&&tp instanceof infer.Obj?tp:null}function findExprType(srv,query,file,expr){var type;expr&&(infer.resetGuessing(),type=infer.expressionType(expr));var typeHandlers=srv.hasHandler("typeAt"),objProp;if(typeHandlers)for(var pos=resolvePos(file,query.end),i=0;i<typeHandlers.length;i++)type=typeHandlers[i](file,pos,expr,type);if(!type)throw ternError("No type found at the given position.");if("ObjectExpression"==expr.node.type&&null!=query.end&&(objProp=pointInProp(expr.node,resolvePos(file,query.end)))){var name=objProp.key.name,fromCx=ensureObj(infer.typeFromContext(file.ast,expr));if(fromCx&&fromCx.hasProp(name))type=fromCx.hasProp(name);else{var fromLocal=ensureObj(type);fromLocal&&fromLocal.hasProp(name)&&(type=fromLocal.hasProp(name))}}return type}function findTypeAtExpr(srv,query,file,expr){var exprName,exprType,type=findExprType(srv,query,file,expr),exprType=type;if(type=query.preferFunction&&type.getFunctionType()||type.getType(),expr&&("Identifier"==expr.node.type?exprName=expr.node.name:"MemberExpression"!=expr.node.type||expr.node.computed?"MethodDefinition"!=expr.node.type||expr.node.computed||(exprName=expr.node.key.name):exprName=expr.node.property.name),null!=query.depth&&"number"!=typeof query.depth)throw ternError(".query.depth must be a number");return[type,exprName,exprType]}function findTypeAt(srv,query,file){var type,exprName,exprType,expr=findExpr(file,query),typeResult=findTypeAtExpr(srv,query,file,expr);(type=typeResult[0])||(type=(typeResult=findTypeAtExpr(srv,query,file,expr=findExprAround(file,query)))[0]),exprName=typeResult[1],exprType=typeResult[2];var result={guess:infer.didGuess(),type:infer.toString(exprType,query.depth),name:type&&type.name,exprName:exprName,doc:exprType.doc,url:exprType.url};return type&&storeTypeDocs(query,type,result),clean(result)}function parseDoc(query,doc){if(!doc)return null;if("full"==query.docFormat)return doc;var parabreak=/.\n[\s@\n]/.exec(doc);if(parabreak&&(doc=doc.slice(0,parabreak.index+1)),(doc=doc.replace(/\n\s*/g," ")).length<100)return doc;var sentenceEnd=/[\.!?] [A-Z]/g;sentenceEnd.lastIndex=80;var found=sentenceEnd.exec(doc);return found&&(doc=doc.slice(0,found.index+1)),doc}function findDocs(srv,query,file){var expr=findExpr(file,query),type=findExprType(srv,query,file,expr),inner=type.getType();inner||(inner=(type=findExprType(srv,query,file,expr=findExprAround(file,query))).getType());var result={url:type.url,doc:parseDoc(query,type.doc),type:infer.toString(type)};return inner&&storeTypeDocs(query,inner,result),clean(result)}function storeTypeDocs(query,type,out){out.url||(out.url=type.url),out.doc||(out.doc=parseDoc(query,type.doc)),out.origin||(out.origin=type.origin);var ctor,boring=infer.cx().protos;!out.url&&!out.doc&&type.proto&&(ctor=type.proto.hasCtor)&&type.proto!=boring.Object&&type.proto!=boring.Function&&type.proto!=boring.Array&&(out.url=ctor.url,out.doc=parseDoc(query,ctor.doc))}var getSpan=exports.getSpan=function(obj){if(obj.origin){if(obj.originNode){var node=obj.originNode;return/^Function/.test(node.type)&&node.id&&(node=node.id),{origin:obj.origin,node:node}}return obj.span?{origin:obj.origin,span:obj.span}:void 0}},storeSpan=exports.storeSpan=function(srv,query,span,target){if(target.origin=span.origin,span.span){var m=/^(\d+)\[(\d+):(\d+)\]-(\d+)\[(\d+):(\d+)\]$/.exec(span.span);target.start=query.lineCharPositions?{line:Number(m[2]),ch:Number(m[3])}:Number(m[1]),target.end=query.lineCharPositions?{line:Number(m[5]),ch:Number(m[6])}:Number(m[4])}else{var file=srv.fileMap[span.origin];target.start=outputPos(query,file,span.node.start),target.end=outputPos(query,file,span.node.end)}};function findDef(srv,query,file){var expr,type=findExprType(srv,query,file,findExpr(file,query));if(infer.didGuess())return{};var span=getSpan(type),result={url:type.url,doc:parseDoc(query,type.doc),origin:type.origin};if(type.types)for(var i=type.types.length-1;i>=0;--i){var tp=type.types[i];storeTypeDocs(query,tp,result),span||(span=getSpan(tp))}if(span&&span.node){var spanFile=span.node.sourceFile||srv.fileMap[span.origin],start=outputPos(query,spanFile,span.node.start),end=outputPos(query,spanFile,span.node.end);result.start=start,result.end=end,result.file=span.origin;var cxStart=Math.max(0,span.node.start-50);result.contextOffset=span.node.start-cxStart,result.context=spanFile.text.slice(cxStart,cxStart+50)}else span&&(result.file=span.origin,storeSpan(srv,query,span,result));return clean(result)}function findRefsToVariable(srv,query,file,expr,isRename){for(var name=expr.node.name,scope=expr.state;scope&&!(name in scope.props);scope=scope.prev);if(!scope)throw ternError("Could not find a definition for "+name);var type,refs=[];function storeRef(file){return function(node,scopeHere,ancestors){var value={file:file.name,start:outputPos(query,file,node.start),end:outputPos(query,file,node.end)};if(isRename){for(var s=scopeHere;s!=scope;s=s.prev){var exists=s.hasProp(isRename);if(exists)throw ternError("Renaming `"+name+"` to `"+isRename+"` would make a variable at line "+(asLineChar(file,node.start).line+1)+" point to the definition at line "+(asLineChar(file,exists.name.start).line+1))}var parent=ancestors[ancestors.length-2];parent&&"Property"==parent.type&&parent.key==parent.value&&(value.isShorthand=!0)}refs.push(value)}}if(scope.originNode){if(type="local",isRename){for(var prev=scope.prev;prev&&!(isRename in prev.props);prev=prev.prev);prev&&infer.findRefs(scope.originNode,scope,isRename,prev,function(node){throw ternError("Renaming `"+name+"` to `"+isRename+"` would shadow the definition used at line "+(asLineChar(file,node.start).line+1))})}infer.findRefs(scope.originNode,scope,name,scope,storeRef(file))}else if(type="global",query.onlySourceFile)infer.findRefs(file.ast,file.scope,name,scope,storeRef(file));else for(var i=0;i<srv.files.length;++i){var cur=srv.files[i];infer.findRefs(cur.ast,cur.scope,name,scope,storeRef(cur))}return{refs:refs,type:type,name:name}}function findRefsToProperty(srv,query,sourceFile,expr,prop){var exprType=infer.expressionType(expr);"MethodDefinition"==expr.node.type&&(exprType=exprType.propertyOf);var objType=exprType.getObjType();if(!objType)throw ternError("Couldn't determine type of base object.");var refs=[];function storeRef(file){return function(node){refs.push({file:file.name,start:outputPos(query,file,node.start),end:outputPos(query,file,node.end)})}}if(query.onlySourceFile)infer.findPropRefs(sourceFile.ast,sourceFile.scope,objType,prop.name,storeRef(sourceFile));else for(var i=0;i<srv.files.length;++i){var cur=srv.files[i];infer.findPropRefs(cur.ast,cur.scope,objType,prop.name,storeRef(cur))}return{refs:refs,name:prop.name}}function findRefs(srv,query,file){var expr=findExprOrThrow(file,query,!0);if(expr&&"Identifier"==expr.node.type)return findRefsToVariable(srv,query,file,expr);if(expr&&"MemberExpression"==expr.node.type&&!expr.node.computed){var p=expr.node.property;return expr.node=expr.node.object,findRefsToProperty(srv,query,file,expr,p)}if(expr&&"ObjectExpression"==expr.node.type)for(var pos=resolvePos(file,query.end),i=0;i<expr.node.properties.length;++i){var k=expr.node.properties[i].key;if(k.start<=pos&&k.end>=pos)return findRefsToProperty(srv,query,file,expr,k)}else if(expr&&"MethodDefinition"==expr.node.type){var p;return findRefsToProperty(srv,query,file,expr,p=expr.node.key)}throw ternError("Not at a variable or property name.")}function buildRename(srv,query,file){if("string"!=typeof query.newName)throw ternError(".query.newName should be a string");var expr=findExprOrThrow(file,query);if(!expr||"Identifier"!=expr.node.type)throw ternError("Not at a variable.");var data=findRefsToVariable(srv,query,file,expr,query.newName),refs=data.refs;delete data.refs,data.files=srv.files.map(function(f){return f.name});for(var changes=data.changes=[],i=0;i<refs.length;++i){var use=refs[i];use.isShorthand?use.text=expr.node.name+": "+query.newName:use.text=query.newName,changes.push(use)}return data}function listFiles(srv){return{files:srv.files.map(function(f){return f.name})}}exports.version="0.24.3"});
//# sourceMappingURL=tern.js.map
