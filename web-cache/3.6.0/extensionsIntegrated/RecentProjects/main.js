define(function(require,exports,module){const ProjectManager=require("project/ProjectManager"),SidebarView=require("project/SidebarView"),PreferencesManager=require("preferences/PreferencesManager"),Commands=require("command/Commands"),CommandManager=require("command/CommandManager"),Menus=require("command/Menus"),MainViewManager=require("view/MainViewManager"),FileSystem=require("filesystem/FileSystem"),AppInit=require("utils/AppInit"),KeyEvent=require("utils/KeyEvent"),FileUtils=require("file/FileUtils"),PopUpManager=require("widgets/PopUpManager"),Strings=require("strings"),Mustache=require("thirdparty/mustache/mustache"),ProjectsMenuTemplate=require("text!./htmlContent/projects-menu.html"),ExtensionInterface=require("utils/ExtensionInterface"),RECENT_PROJECTS_INTERFACE="Extn.Phoenix.recentProjects";ExtensionInterface.registerExtensionInterface(RECENT_PROJECTS_INTERFACE,exports);const RECENT_PROJECT_STATE="recentProjects";PreferencesManager.stateManager.definePreference(RECENT_PROJECT_STATE,"array",[]).watchExternalChanges();let TOGGLE_DROPDOWN="recentProjects.toggle";var MAX_PROJECTS=20,$dropdownItem,$dropdown,$links;function getRecentProjects(){var recentProjects=PreferencesManager.getViewState(RECENT_PROJECT_STATE)||[],i;for(i=0;i<recentProjects.length;i++)recentProjects[i]=FileUtils.stripTrailingSlash(ProjectManager.updateWelcomeProjectPath(recentProjects[i]+"/"));return recentProjects}function add(){var root=FileUtils.stripTrailingSlash(ProjectManager.getProjectRoot().fullPath),recentProjects=getRecentProjects(),index=recentProjects.indexOf(root);-1!==index&&recentProjects.splice(index,1),recentProjects.unshift(root),recentProjects.length>MAX_PROJECTS&&(recentProjects=recentProjects.slice(0,MAX_PROJECTS)),PreferencesManager.setViewState(RECENT_PROJECT_STATE,recentProjects)}function checkHovers(pageX,pageY){$dropdown.children().each(function(){var offset=$(this).offset(),width=$(this).outerWidth(),height=$(this).outerHeight();pageX>=offset.left&&pageX<=offset.left+width&&pageY>=offset.top&&pageY<=offset.top+height&&$(".recent-folder-link",this).triggerHandler("mouseenter")})}function removeFromRecentProject(fullPath){fullPath=FileUtils.stripTrailingSlash(fullPath);let recentProjects=getRecentProjects(),index=recentProjects.indexOf(fullPath),newProjects=[],i;for(i=0;i<recentProjects.length;i++)i!==index&&newProjects.push(recentProjects[i]);PreferencesManager.setViewState(RECENT_PROJECT_STATE,newProjects)}function renderDelete(){return $("<div id='recent-folder-delete' class='trash-icon'>&times;</div>").mouseup(function(e){e.stopPropagation(),removeFromRecentProject($(this).parent().data("path")),$(this).closest("li").remove(),checkHovers(e.pageX,e.pageY),1===getRecentProjects().length&&$dropdown.find(".divider").remove()})}function removeDeleteButton(){$("#recent-folder-delete").remove()}function addDeleteButton($target){removeDeleteButton(),renderDelete().css("top",$target.position().top+6).appendTo($target)}function selectNextItem(direction){let $links=$dropdown.find("a:visible"),index=$dropdownItem?$links.index($dropdownItem):direction>0?-1:0,$newItem=$links.eq((index+direction)%$links.length);searchStr&&1===$links.length||($newItem.parent().hasClass("sticky-li-top")&&(-1===index&&(index=0),$newItem=$links.eq((index+direction)%$links.length)),$dropdownItem&&$dropdownItem.removeClass("selected"),$newItem.addClass("selected"),$dropdownItem=$newItem,removeDeleteButton())}let searchStr="";function filterDropdown(searchString){searchStr=searchString;const $stickyLi=$dropdown.find("li.sticky-li-top");searchString?$stickyLi.removeClass("forced-hidden"):$stickyLi.addClass("forced-hidden"),$dropdown.find("li").each(function(index,li){if(0===index)return;const $li=$(li);$li.text().toLowerCase().includes(searchString.toLowerCase())?$li.removeClass("forced-hidden"):$li.addClass("forced-hidden")}),searchString?($stickyLi.removeClass("forced-hidden"),$stickyLi.find(".searchTextSpan").text(searchString)):$stickyLi.addClass("forced-hidden")}function removeSelectedItem(e){var recentProjects=getRecentProjects(),$cacheItem=$dropdownItem,index=recentProjects.indexOf($cacheItem.data("path"));return-1!==index&&(recentProjects.splice(index,1),PreferencesManager.setViewState(RECENT_PROJECT_STATE,recentProjects),checkHovers(e.pageX,e.pageY),1===recentProjects.length&&$dropdown.find(".divider").remove(),selectNextItem(1),$cacheItem.closest("li").remove(),!0)}function keydownHook(event){var keyHandled=!1;switch(event.keyCode){case KeyEvent.DOM_VK_UP:selectNextItem(-1),keyHandled=!0;break;case KeyEvent.DOM_VK_DOWN:selectNextItem(1),keyHandled=!0;break;case KeyEvent.DOM_VK_ENTER:case KeyEvent.DOM_VK_RETURN:$dropdownItem&&$dropdownItem.trigger("click"),keyHandled=!0;break;case KeyEvent.DOM_VK_DELETE:$dropdownItem&&(removeSelectedItem(event),keyHandled=!0)}if(keyHandled)return event.stopImmediatePropagation(),event.preventDefault(),keyHandled;if((event.ctrlKey||event.metaKey)&&"v"===event.key)Phoenix.app.clipboardReadText().then(text=>{filterDropdown(searchStr+=text)}),keyHandled=!0;else if(1===event.key.length)searchStr+=event.key,keyHandled=!0;else{if("Backspace"!==event.key)return!1;searchStr=searchStr.slice(0,-1),keyHandled=!0}return filterDropdown(searchStr),keyHandled&&(event.stopImmediatePropagation(),event.preventDefault()),keyHandled}function closeDropdown(){$dropdown&&PopUpManager.removePopUp($dropdown),searchStr=""}function cleanupDropdown(){$("html").off("click",closeDropdown),$("#project-files-container").off("scroll",closeDropdown),$("#titlebar .nav").off("click",closeDropdown),$dropdown=null,MainViewManager.focusActivePane(),$(window).off("keydown",keydownHook),searchStr=""}function openProjectWithPath(fullPath){return new Promise((resolve,reject)=>{ProjectManager.openProject(fullPath).then(resolve).fail(function(){var recentProjects=getRecentProjects(),index=recentProjects.indexOf(fullPath);-1!==index?FileSystem.resolve(fullPath,function(err,item){err&&recentProjects.splice(index,1),reject()}):reject()})})}function _handleListEvents(){$dropdown.on("click","a",function(){var $link=$(this),id=$link.attr("id"),path=$link.data("path");path?(openProjectWithPath(path),closeDropdown()):"open-folder-link"===id?CommandManager.execute(Commands.FILE_OPEN_FOLDER):"new-project-link"===id?CommandManager.execute(Commands.FILE_NEW_PROJECT):"download-project-link"===id&&CommandManager.execute(Commands.FILE_DOWNLOAD_PROJECT)}).on("mouseenter","a",function(){$dropdownItem&&$dropdownItem.removeClass("selected"),($dropdownItem=$(this).addClass("selected")).hasClass("recent-folder-link")&&addDeleteButton($(this))}).on("mouseleave","a",function(){var $link=$(this).removeClass("selected");$link.get(0)===$dropdownItem.get(0)&&($dropdownItem=null),$link.hasClass("recent-folder-link")&&removeDeleteButton()})}function renderPath(fullPath){let parentDirPath=Phoenix.VFS.ensureTrailingSlash(window.path.dirname(fullPath)),rest;if(parentDirPath.startsWith(Phoenix.VFS.getTauriDir()))rest=" - "+window.fs.getTauriPlatformPath(parentDirPath);else if(parentDirPath.startsWith(Phoenix.VFS.getMountDir())){const displayPath=parentDirPath.replace(Phoenix.VFS.getMountDir(),"");displayPath&&(rest=" - "+displayPath)}else rest=" - "+Strings.PROJECT_FROM_BROWSER_TERSE;return{path:fullPath,folder:window.path.basename(fullPath),rest:rest}}function renderList(){const recentProjects=getRecentProjects(),downloadProjectCommand=CommandManager.get(Commands.FILE_DOWNLOAD_PROJECT),currentProject=FileUtils.stripTrailingSlash(ProjectManager.getProjectRoot().fullPath),templateVars={projectList:[],Strings:Strings,downloadProjectClass:downloadProjectCommand.getEnabled()?"":"forced-hidden"};return recentProjects.forEach(function(root){root!==currentProject&&templateVars.projectList.push(renderPath(root))}),Mustache.render(ProjectsMenuTemplate,templateVars)}function showDropdown(position){$dropdown||(Menus.closeAll(),$dropdown=$(renderList()).css({left:position.pageX,top:position.pageY}).appendTo($("body")),PopUpManager.addPopUp($dropdown,cleanupDropdown,!0),$("html").on("click",closeDropdown),$("#project-files-container").on("scroll",closeDropdown),$("#titlebar .nav").on("click",closeDropdown),_handleListEvents(),$(window).on("keydown",keydownHook))}function handleKeyEvent(){$dropdown||(SidebarView.isVisible()||SidebarView.show(),$("#project-dropdown-toggle").trigger("click"),$dropdown.focus(),$links=$dropdown.find("a"),($dropdownItem=$links.eq($links.length>1?1:0)).addClass("selected"),window.setTimeout(function(){$dropdown.focus()},0))}CommandManager.register(Strings.CMD_TOGGLE_RECENT_PROJECTS,TOGGLE_DROPDOWN,handleKeyEvent),AppInit.appReady(function(){ProjectManager.on("projectOpen",add),ProjectManager.on("beforeProjectClose",add),add()}),AppInit.htmlReady(function(){$("#project-title").wrap("<div id='project-dropdown-toggle' class='btn-alt-quiet'></div>").after("<span class='dropdown-arrow'></span>");var cmenuAdapter={open:showDropdown,close:closeDropdown,isOpen:function(){return!!$dropdown}};Menus.ContextMenu.assignContextMenuToSelector("#project-dropdown-toggle",cmenuAdapter)}),exports.getRecentProjects=getRecentProjects,exports.openProjectWithPath=openProjectWithPath,exports.removeFromRecentProject=removeFromRecentProject});
//# sourceMappingURL=main.js.map
