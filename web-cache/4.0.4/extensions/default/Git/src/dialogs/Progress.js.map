{"version":3,"sources":["extensions/default/Git/src/dialogs/Progress.js"],"names":["define","require","exports","EventDispatcher","brackets","getModule","Dialogs","Strings","Mustache","Events","template","lines","$textarea","maxLines","addLine","str","length","shift","push","updateTimeout","updateTextarea","setTimeout","val","join","scrollTop","scrollHeight","height","onProgress","show","promise","progressTracker","showOpts","finally","Error","title","options","Promise","resolve","reject","initialMessage","dialog","finished","showDialog","templateArgs","OPERATION_IN_PROGRESS_TITLE","compiledTemplate","render","showModalDialogUsingTemplate","getElement","find","PLEASE_WAIT","finalValue","finalError","finish","close","preDelay","off","GIT_PROGRESS_EVENT","on","_evt","data","then","catch","err","postDelay","waitForClose","check","visible","$","is","newProgressTracker","tracker","makeEventDispatcher"],"mappings":"AAAAA,OAAO,SAAUC,QAASC,SACtB,MAAMC,gBAAkBC,SAASC,UAAU,yBAErCC,QAAUF,SAASC,UAAU,mBAC/BE,QAAsBH,SAASC,UAAU,WACzCG,SAAWJ,SAASC,UAAU,gCAG5BI,OAAgBR,QAAQ,cAG9B,IAAIS,SAAWT,QAAQ,mDAGnBU,MACAC,UAEJ,MAAMC,SAAW,IAIjB,SAASC,QAAQC,KACTJ,MAAMK,QAAUH,UAChBF,MAAMM,QAEVN,MAAMO,KAAKH,KAEf,IAAII,cAAgB,KACpB,SAASC,iBACFD,gBAIHA,cAAgBE,WAAW,KACvBF,cAAgB,KACZP,WAAcD,MAAMK,SAGxBJ,UAAUU,IAAIX,MAAMY,KAAK,OACzBX,UAAUY,UAAUZ,UAAU,GAAGa,aAAeb,UAAUc,YAC3D,MAGP,SAASC,WAAWZ,KACG,iBAARA,KACPD,QAAQC,KAEZK,iBAGJ,SAASQ,KAAKC,QAASC,gBAAiBC,SAAW,IAC/C,IAAKF,UAAYA,QAAQG,QACrB,MAAM,IAAIC,MAAM,iDAEpB,IAAIH,gBACA,MAAM,IAAIG,MAAM,yDAGpB,MAAMC,MAAQH,SAASG,MACjBC,QAAUJ,SAASI,SAAW,GAEpC,OAAO,IAAIC,QAAQ,SAAUC,QAASC,QAElC3B,MAAQoB,SAASQ,eAAiB,CAACR,SAASQ,gBAAkB,GAC9D3B,UAAY,KAEZ,IAAI4B,OACAC,UAAW,EAEf,SAASC,aACL,IAAID,SAAJ,CAIA,IAAIE,aAAe,CACfT,MAAOA,OAAS3B,QAAQqC,4BACxBrC,QAASA,SAGTsC,iBAAmBrC,SAASsC,OAAOpC,SAAUiC,cACjDH,OAASlC,QAAQyC,6BAA6BF,mBAE9CjC,UAAY4B,OAAOQ,aAAaC,KAAK,aAC3B3B,IAAIf,QAAQ2C,aACtBvB,cAGJ,IAAIwB,WAAYC,WAChB,SAASC,SACLZ,UAAW,EACPD,QACAA,OAAOc,QAERF,WACCd,OAAOc,YAEPf,QAAQc,YAIXhB,QAAQoB,SAGTlC,WAAW,WACPqB,cACkB,IAAnBP,QAAQoB,UAJXb,aAOJZ,gBAAgB0B,OAAO/C,OAAOgD,kCAC9B3B,gBAAgB4B,MAAMjD,OAAOgD,iCAAkC,CAACE,KAAMC,QAClEjC,WAAWiC,QAEf/B,QACKgC,KAAKvC,MACF6B,WAAa7B,MAEhBwC,MAAMC,MACHX,WAAaW,MAEhB/B,QAAQ,WACLF,gBAAgB0B,OAAO/C,OAAOgD,kCAC9B9B,WAAW,aACNQ,QAAQ6B,WAAcxB,OAGvBnB,WAAW,WACPgC,UACmB,IAApBlB,QAAQ6B,WAJXX,aAWpB,SAASY,eACL,OAAO,IAAI7B,QAAQ,SAAUC,SACzB,SAAS6B,QACL,IAAIC,QAAUC,EAAE,wBAAwBC,GAAG,YAIvChD,WAAW6C,MAAO,IAFlB7B,UAKRhB,WAAW6C,MAAO,MAI1B,SAASI,qBACL,MAAMC,QAAU,GAEhB,OADApE,gBAAgBqE,oBAAoBD,SAC7BA,QAGXrE,QAAQ0B,KAAOA,KACf1B,QAAQoE,mBAAqBA,mBAC7BpE,QAAQ+D,aAAeA","sourcesContent":["define(function (require, exports) {\n    const EventDispatcher = brackets.getModule(\"utils/EventDispatcher\");\n    // Brackets modules\n    const Dialogs = brackets.getModule(\"widgets/Dialogs\"),\n        Strings             = brackets.getModule(\"strings\"),\n        Mustache = brackets.getModule(\"thirdparty/mustache/mustache\");\n\n    // Local modules\n    const Events        = require(\"src/Events\");\n\n    // Templates\n    var template = require(\"text!src/dialogs/templates/progress-dialog.html\");\n\n    // Module variables\n    var lines,\n        $textarea;\n\n    const maxLines = 5000;\n    // some git commit may have pre commit/push hooks which\n    // may run tests suits that print large amount of data on the console, so we need to\n    // debounce and truncate the git output we get in progress window.\n    function addLine(str) {\n        if (lines.length >= maxLines) {\n            lines.shift(); // Remove the oldest line\n        }\n        lines.push(str);\n    }\n    let updateTimeout = null;\n    function updateTextarea() {\n        if(updateTimeout){\n            // an update is scheduled, debounce, we dont need to print now\n            return;\n        }\n        updateTimeout = setTimeout(() => {\n            updateTimeout = null;\n            if(!$textarea || !lines.length){\n                return;\n            }\n            $textarea.val(lines.join(\"\\n\"));\n            $textarea.scrollTop($textarea[0].scrollHeight - $textarea.height());\n        }, 100);\n    }\n\n    function onProgress(str) {\n        if (typeof str === \"string\") {\n            addLine(str);\n        }\n        updateTextarea();\n    }\n\n    function show(promise, progressTracker, showOpts = {}) {\n        if (!promise || !promise.finally) {\n            throw new Error(\"Invalid promise argument for progress dialog!\");\n        }\n        if(!progressTracker) {\n            throw new Error(\"Invalid progressTracker argument for progress dialog!\");\n        }\n\n        const title = showOpts.title;\n        const options = showOpts.options || {};\n\n        return new Promise(function (resolve, reject) {\n\n            lines = showOpts.initialMessage ? [showOpts.initialMessage] : [];\n            $textarea = null;\n\n            var dialog,\n                finished = false;\n\n            function showDialog() {\n                if (finished) {\n                    return;\n                }\n\n                var templateArgs = {\n                    title: title || Strings.OPERATION_IN_PROGRESS_TITLE,\n                    Strings: Strings\n                };\n\n                var compiledTemplate = Mustache.render(template, templateArgs);\n                dialog = Dialogs.showModalDialogUsingTemplate(compiledTemplate);\n\n                $textarea = dialog.getElement().find(\"textarea\");\n                $textarea.val(Strings.PLEASE_WAIT);\n                onProgress();\n            }\n\n            let finalValue, finalError;\n            function finish() {\n                finished = true;\n                if (dialog) {\n                    dialog.close();\n                }\n                if(finalError){\n                    reject(finalError);\n                } else {\n                    resolve(finalValue);\n                }\n            }\n\n            if (!options.preDelay) {\n                showDialog();\n            } else {\n                setTimeout(function () {\n                    showDialog();\n                }, options.preDelay * 1000);\n            }\n\n            progressTracker.off(`${Events.GIT_PROGRESS_EVENT}.progressDlg`);\n            progressTracker.on(`${Events.GIT_PROGRESS_EVENT}.progressDlg`, (_evt, data)=>{\n                onProgress(data);\n            });\n            promise\n                .then(val => {\n                    finalValue = val;\n                })\n                .catch(err => {\n                    finalError = err;\n                })\n                .finally(function () {\n                    progressTracker.off(`${Events.GIT_PROGRESS_EVENT}.progressDlg`);\n                    onProgress(\"Finished!\");\n                    if (!options.postDelay || !dialog) {\n                        finish();\n                    } else {\n                        setTimeout(function () {\n                            finish();\n                        }, options.postDelay * 1000);\n                    }\n                });\n\n        });\n    }\n\n    function waitForClose() {\n        return new Promise(function (resolve) {\n            function check() {\n                var visible = $(\"#git-progress-dialog\").is(\":visible\");\n                if (!visible) {\n                    resolve();\n                } else {\n                    setTimeout(check, 20);\n                }\n            }\n            setTimeout(check, 20);\n        });\n    }\n\n    function newProgressTracker() {\n        const tracker = {};\n        EventDispatcher.makeEventDispatcher(tracker);\n        return tracker;\n    }\n\n    exports.show = show;\n    exports.newProgressTracker = newProgressTracker;\n    exports.waitForClose = waitForClose;\n\n});\n"],"file":"Progress.js"}