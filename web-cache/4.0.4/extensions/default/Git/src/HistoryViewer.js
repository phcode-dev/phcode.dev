define(function(require,exports){const _=brackets.getModule("thirdparty/lodash"),LanguageManager=brackets.getModule("language/LanguageManager"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),WorkspaceManager=brackets.getModule("view/WorkspaceManager"),Strings=brackets.getModule("strings"),Metrics=brackets.getModule("utils/Metrics"),marked=brackets.getModule("thirdparty/marked.min").marked,ErrorHandler=require("src/ErrorHandler"),Git=require("src/git/Git"),Preferences=require("src/Preferences"),Utils=require("src/Utils");var historyViewerTemplate=require("text!templates/history-viewer.html"),historyViewerFilesTemplate=require("text!templates/history-viewer-files.html");let useDifftool=!1,isShown=!1,commit=null,currentlyViewedCommit=null,isInitial=null,$viewer=null,$editorHolder=null;var setExpandState=_.debounce(function(){var allFiles=$viewer.find(".commit-files a"),activeFiles=allFiles.filter(".active"),allExpanded=allFiles.length===activeFiles.length;$viewer.find(".toggle-diffs").toggleClass("opened",allExpanded)},100),PAGE_SIZE=25,currentPage=0,hasNextPage=!1;function toggleDiff($a){if($a.hasClass("active"))return $a.removeClass("active"),void setExpandState();if($(".commit-files a.active").attr("scrollPos",$(".commit-diff").scrollTop()),$a.is(".loaded"))$a.addClass("active"),setExpandState();else{var $li=$a.closest("[x-file]"),relativeFilePath=$li.attr("x-file"),$diffContainer=$li.find(".commit-diff");Git.getDiffOfFileFromCommit(commit.hash,relativeFilePath,isInitial).then(function(diff){$diffContainer.html(Utils.formatDiff(diff)),$diffContainer.scrollTop($a.attr("scrollPos")||0),$a.addClass("active loaded"),setExpandState()}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_GET_DIFF_FILE_COMMIT)})}}function showDiff($el){var file=$el.closest("[x-file]").attr("x-file");Git.difftoolFromHash(commit.hash,file,isInitial)}function expandAll(){$viewer.find(".commit-files a").not(".active").trigger("click"),Preferences.set("autoExpandDiffsInHistory",!0)}function collapseAll(){$viewer.find(".commit-files a").filter(".active").trigger("click"),Preferences.set("autoExpandDiffsInHistory",!1)}function attachEvents(){$viewer.on("click",".commit-files a",function(){toggleDiff($(this))}).on("click",".commit-files .difftool",function(e){e.stopPropagation(),showDiff($(this))}).on("click",".openFile",function(e){e.stopPropagation();var file=$(this).closest("[x-file]").attr("x-file");Utils.openEditorForFile(file,!0),hide()}).on("click",".close",function(){remove()}).on("click",".git-extend-sha",function(){var $parent=$(this).parent(),sha=$parent.data("hash");$parent.find("span.selectable-text").text(sha),$(this).remove()}).on("click",".toggle-diffs",expandAll).on("click",".toggle-diffs.opened",collapseAll),$viewer.find(".body").on("scroll",function(){$viewer.find(".body").scrollTop()>0?$viewer.find(".header").addClass("shadow"):$viewer.find(".header").removeClass("shadow")}),Preferences.get("autoExpandDiffsInHistory")&&expandAll()}function renderViewerContent(files,selectedFile){var bodyMarkdown=marked(commit.body,{gfm:!0,breaks:!0});if($viewer.html(Mustache.render(historyViewerTemplate,{commit:commit,bodyMarkdown:bodyMarkdown,Strings:Strings})),renderFiles(files),selectedFile){var $fileEntry=$viewer.find(".commit-files li[x-file='"+selectedFile+"'] a").first();$fileEntry.length&&(toggleDiff($fileEntry),window.setTimeout(function(){$viewer.find(".body").animate({scrollTop:$fileEntry.position().top-10})},80))}attachEvents()}function renderFiles(files){$viewer.find(".filesContainer").append(Mustache.render(historyViewerFilesTemplate,{files:files,Strings:Strings,useDifftool:useDifftool})),$viewer.find(".loadMore").toggle(hasNextPage).off("click").on("click",function(){currentPage++,loadMoreFiles()})}function loadMoreFiles(){Git.getFilesFromCommit(commit.hash,isInitial).then(function(files){hasNextPage=files.slice((currentPage+1)*PAGE_SIZE).length>0;var list=(files=files.slice(currentPage*PAGE_SIZE,(currentPage+1)*PAGE_SIZE)).map(function(file){var fileExtension=LanguageManager.getCompoundFileExtension(file),i=file.lastIndexOf("."+fileExtension),fileName;return{name:file.substring(0,fileExtension&&i>=0?i:file.length),extension:fileExtension?"."+fileExtension:"",file:file}}),file;return 0===currentPage?renderViewerContent(list,$("#git-history-list").data("file-relative")):renderFiles(list)}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_GET_DIFF_FILES)}).finally(function(){$viewer.removeClass("spinner large spin")})}function render(){$viewer?($viewer.off("click"),$viewer.find(".body").off("scroll")):($viewer=$("<div>").addClass("git spinner large spin")).appendTo($editorHolder),currentPage=0,loadMoreFiles()}var initialize=_.once(function(){Git.getConfig("diff.tool").then(function(config){useDifftool=!!config})});function toggle(commitInfo,doc,options){const commitHash=commitInfo.hash;return isShown&&commitHash===currentlyViewedCommit?(remove(),!1):(show(commitInfo,doc,options),!0)}function show(commitInfo,doc,options){if(Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"history","detailView"),initialize(),commit=commitInfo,isInitial=options.isInitial,$editorHolder=$("#editor-holder"),render(),currentlyViewedCommit=commitInfo.hash,isShown=!0,$("#first-pane").length){const firstPaneStyle=$("#first-pane").prop("style")&&$("#first-pane").prop("style").cssText?$("#first-pane").prop("style").cssText:"";$("#first-pane").prop("style",firstPaneStyle+";display: none !important;")}if($("#second-pane").length){const secondPaneStyle=$("#second-pane").prop("style")&&$("#second-pane").prop("style").cssText?$("#second-pane").prop("style").cssText:"";$("#second-pane").prop("style",secondPaneStyle+";display: none !important;")}}function onRemove(){isShown=!1,$viewer=null,currentlyViewedCommit=null,$("#first-pane").show(),$("#second-pane").show(),WorkspaceManager.recomputeLayout()}function hide(){isShown&&remove()}function remove(){$viewer.remove(),onRemove()}function isVisible(){return isShown}exports.toggle=toggle,exports.show=show,exports.hide=hide,exports.isVisible=isVisible});
//# sourceMappingURL=HistoryViewer.js.map
