{"version":3,"sources":["extensions/default/HTMLCodeHints/html-lint.js"],"names":["define","require","exports","module","CodeInspection","brackets","getModule","AppInit","Strings","StringUtils","EditorManager","ProjectManager","PreferencesManager","Metrics","FileSystem","IndexingWorker","Phoenix","isTestWindow","on","window","_htmlLintExtensionReadyToIntegTest","loadScriptInWorker","uri","prefs","getExtensionPrefs","PREFS_HTML_LINT_DISABLED","CONFIG_FILE_NAME","UNSUPPORTED_CONFIG_FILES","projectSpecificOptions","configErrorMessage","configID","projectConfigPaths","getTypeFromSeverity","sev","Type","WARNING","ERROR","META","_getLinterConfigFileErrorMsg","pos","line","ch","message","type","async","lintOneFile","text","fullPath","Promise","resolve","reject","errors","execPeer","filePath","config","then","lintResult","editor","getCurrentFullEditor","document","file","length","map","lintError","posFromIndex","start","startPos","endPos","end","highlightOffset","ruleId","severity","moreInfoURL","ruleUrl","catch","err","console","error","Error","_readConfig","dir","configFilePath","path","join","displayPath","getProjectRelativeOrDisplayPath","fs","readFile","content","ERR_CODES","ENOENT","code","JSON","parse","log","e","format","HTML_LINT_CONFIG_JSON_ERROR","_validateUnsupportedConfig","scanningProjectPath","errorMessage","unsupportedFileName","exists","existsAsync","HTML_LINT_CONFIG_UNSUPPORTED","getProjectRoot","requestRun","HTML_LINT_NAME","_reloadOptions","countEvent","EVENT_TYPE","LINT","_getConfigPaths","fileName","_projectFileChanged","_evt","changedPath","addedSet","removedSet","configPaths","configPath","has","definePreference","description","DESCRIPTION_HTML_LINT_DISABLE","appReady","EVENT_PROJECT_CHANGED_OR_RENAMED_PATH","EVENT_PROJECT_OPEN","registration","name","scanFileAsync","canInspect","_fullPath","get","register"],"mappings":"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","sourcesContent":["/*\n * GNU AGPL-3.0 License\n *\n * Copyright (c) 2021 - present core.ai . All rights reserved.\n * Original work Copyright (c) 2012 - 2021 Adobe Systems Incorporated. All rights reserved.\n *\n * This program is free software: you can redistribute it and/or modify it\n * under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT\n * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License\n * for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see https://opensource.org/licenses/AGPL-3.0.\n *\n */\n\n/* global path, fs*/\n\n/**\n * Provides JSLint results via the core linting extension point\n */\ndefine(function (require, exports, module) {\n\n    // Load dependent modules\n    const CodeInspection   = brackets.getModule(\"language/CodeInspection\"),\n        AppInit            = brackets.getModule(\"utils/AppInit\"),\n        Strings            = brackets.getModule(\"strings\"),\n        StringUtils        = brackets.getModule(\"utils/StringUtils\"),\n        EditorManager      = brackets.getModule(\"editor/EditorManager\"),\n        ProjectManager     = brackets.getModule(\"project/ProjectManager\"),\n        PreferencesManager = brackets.getModule(\"preferences/PreferencesManager\"),\n        Metrics            = brackets.getModule(\"utils/Metrics\"),\n        FileSystem         = brackets.getModule(\"filesystem/FileSystem\"),\n        IndexingWorker     = brackets.getModule(\"worker/IndexingWorker\");\n\n    if(Phoenix.isTestWindow) {\n        IndexingWorker.on(\"html_lint_extension_Loaded\", ()=>{\n            window._htmlLintExtensionReadyToIntegTest = true;\n        });\n    }\n    IndexingWorker.loadScriptInWorker(`${module.uri}/../worker/html-worker.js`);\n\n    const prefs = PreferencesManager.getExtensionPrefs(\"HTMLLint\");\n    const PREFS_HTML_LINT_DISABLED = \"disabled\";\n    const CONFIG_FILE_NAME = \".htmlvalidate.json\";\n    const UNSUPPORTED_CONFIG_FILES = [\".htmlvalidate.js\", \".htmlvalidate.cjs\"];\n\n    let projectSpecificOptions, configErrorMessage, configID = 0;\n\n    prefs.definePreference(PREFS_HTML_LINT_DISABLED, \"boolean\", false, {\n        description: Strings.DESCRIPTION_HTML_LINT_DISABLE\n    }).on(\"change\", function () {\n        CodeInspection.requestRun(Strings.HTML_LINT_NAME);\n    });\n\n    function getTypeFromSeverity(sev) {\n        // https://html-validate.org/guide/api/getting-started.html\n        switch (sev) {\n        case 1:  return CodeInspection.Type.WARNING;\n        case 2:  return CodeInspection.Type.ERROR;\n        default: return CodeInspection.Type.META;\n        }\n    }\n\n    function _getLinterConfigFileErrorMsg() {\n        return [{\n            // JSLint returns 1-based line/col numbers\n            pos: { line: -1, ch: 0 },\n            message: configErrorMessage,\n            type: CodeInspection.Type.ERROR\n        }];\n    }\n\n    /**\n     * Run JSLint on the current document. Reports results to the main UI. Displays\n     * a gold star when no errors are found.\n     */\n    async function lintOneFile(text, fullPath) {\n        return new Promise((resolve, reject)=>{\n            if(configErrorMessage){\n                resolve({ errors: _getLinterConfigFileErrorMsg() });\n                return;\n            }\n            IndexingWorker.execPeer(\"htmlLint\", {\n                text,\n                filePath: fullPath,\n                configID,\n                config: projectSpecificOptions\n            }).then(lintResult =>{\n                let editor = EditorManager.getCurrentFullEditor();\n                if(!editor || editor.document.file.fullPath !== fullPath) {\n                    // this is not the active editor the lint is about. so the html validate api sends the startPos of\n                    // the error, but doesn't send the end pos, instead it sends the end offset. We need end line:ch pos\n                    //to highlight error properly, and computing that needs an editor(or we need to impl that logic)\n                    // so for now, we use the active editor if there is one to properly underline errors, and if we\n                    // cant find the active editor, we will do an approximation on the current line\n                    editor = null;\n                }\n                if (lintResult && lintResult.length) {\n                    lintResult = lintResult.map(function (lintError) {\n                        return {\n                            pos: editor ? editor.posFromIndex(lintError.start) : lintError.startPos,\n                            endPos: editor ?  editor.posFromIndex(lintError.end): {\n                                line: lintError.startPos.line,\n                                // highlightOffset can span multiple lines, so this is at best an approximation\n                                ch: lintError.startPos.ch + lintError.highlightOffset\n                            },\n                            message: `${lintError.message} (${lintError.ruleId})`,\n                            type: getTypeFromSeverity(lintError.severity),\n                            moreInfoURL: lintError.ruleUrl\n                        };\n                    });\n\n                    resolve({ errors: lintResult });\n                }\n                resolve();\n            }).catch(err=>{\n                console.error(\"HTML Lint failed:\", err);\n                reject(new Error(\"HTML Lint failed as HTML plugin is not yet loaded. Please try again.\"));\n            });\n        });\n    }\n\n    function _readConfig(dir) {\n        return new Promise((resolve, reject)=>{\n            const configFilePath = path.join(dir, CONFIG_FILE_NAME);\n            let displayPath = ProjectManager.getProjectRelativeOrDisplayPath(configFilePath);\n            // directly reading from fs as we are still getting deleted file from document manager read.\n            fs.readFile(configFilePath, 'utf8', function (err, content) {\n                if (err && fs.ERR_CODES.ENOENT === err.code) {\n                    resolve(null); // no config file is a valid case. we just resolve with null\n                } else if(err){\n                    console.error(\"Error reading JSHint Config File\", configFilePath, err);\n                    reject(\"Error reading JSHint Config File\", displayPath);\n                } else {\n                    let config;\n                    try {\n                        config = JSON.parse(content);\n                        console.log(\"html-lint: loaded config file for project \" + configFilePath);\n                    } catch (e) {\n                        console.log(\"html-lint: error parsing \" + configFilePath, content, e);\n                        // just log and return as this is an expected failure for us while the user edits code\n                        reject(StringUtils.format(Strings.HTML_LINT_CONFIG_JSON_ERROR, displayPath));\n                        return;\n                    }\n                    resolve(config);\n                }\n            });\n        });\n    }\n\n    async function _validateUnsupportedConfig(scanningProjectPath) {\n        let errorMessage;\n        for(let unsupportedFileName of UNSUPPORTED_CONFIG_FILES) {\n            let exists = await FileSystem.existsAsync(path.join(scanningProjectPath, unsupportedFileName));\n            if(exists) {\n                errorMessage = StringUtils.format(Strings.HTML_LINT_CONFIG_UNSUPPORTED, unsupportedFileName);\n                break;\n            }\n        }\n        if(scanningProjectPath !== ProjectManager.getProjectRoot().fullPath) {\n            // this is a rare race condition where the user switches project between the config reload\n            // Eg. in integ tests. do nothing as another scan for the new project will be in progress.\n            return;\n        }\n        configErrorMessage = errorMessage;\n        CodeInspection.requestRun(Strings.HTML_LINT_NAME);\n    }\n\n    function _reloadOptions() {\n        projectSpecificOptions = null;\n        configErrorMessage = null;\n        const scanningProjectPath = ProjectManager.getProjectRoot().fullPath;\n        configID++;\n        _readConfig(scanningProjectPath).then((config)=>{\n            configID++;\n            if(scanningProjectPath !== ProjectManager.getProjectRoot().fullPath){\n                // this is a rare race condition where the user switches project between the get document call.\n                // Eg. in integ tests. do nothing as another scan for the new project will be in progress.\n                return;\n            }\n            if(config) {\n                Metrics.countEvent(Metrics.EVENT_TYPE.LINT, \"html\", \"configPresent\");\n                projectSpecificOptions = config;\n                configErrorMessage = null;\n                CodeInspection.requestRun(Strings.HTML_LINT_NAME);\n            } else {\n                _validateUnsupportedConfig(scanningProjectPath)\n                    .catch(console.error);\n            }\n        }).catch((err)=>{\n            configID++;\n            if(scanningProjectPath !== ProjectManager.getProjectRoot().fullPath){\n                return;\n            }\n            Metrics.countEvent(Metrics.EVENT_TYPE.LINT, \"HTMLConfig\", \"error\");\n            configErrorMessage = err;\n            CodeInspection.requestRun(Strings.HTML_LINT_NAME);\n        });\n    }\n\n    let projectConfigPaths;\n    function _getConfigPaths() {\n        if(!projectConfigPaths){\n            projectConfigPaths=[\n                path.join(ProjectManager.getProjectRoot().fullPath, CONFIG_FILE_NAME),\n                ...UNSUPPORTED_CONFIG_FILES.map(fileName=>\n                    path.join(ProjectManager.getProjectRoot().fullPath, fileName))\n            ];\n        }\n        return projectConfigPaths;\n    }\n\n    function _projectFileChanged(_evt, changedPath, addedSet, removedSet) {\n        const configPaths = _getConfigPaths();\n        for(let configPath of configPaths) {\n            if(changedPath=== configPath || addedSet.has(configPath) || removedSet.has(configPath)){\n                _reloadOptions();\n                return;\n            }\n        }\n    }\n\n    AppInit.appReady(function () {\n        ProjectManager.on(ProjectManager.EVENT_PROJECT_CHANGED_OR_RENAMED_PATH, _projectFileChanged);\n        ProjectManager.on(ProjectManager.EVENT_PROJECT_OPEN, ()=>{\n            projectConfigPaths = null;\n            _reloadOptions();\n        });\n        _reloadOptions();\n    });\n\n    const registration = {\n        name: Strings.HTML_LINT_NAME,\n        scanFileAsync: lintOneFile,\n        canInspect: function (_fullPath) {\n            return !prefs.get(PREFS_HTML_LINT_DISABLED);\n        }\n    };\n    CodeInspection.register(\"html\", registration);\n    CodeInspection.register(\"php\", registration);\n});\n"],"file":"html-lint.js"}