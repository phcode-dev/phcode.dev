define(function(require,exports,module){const NotificationUI=require("widgets/NotificationUI"),Commands=require("command/Commands"),Strings=require("strings"),Menus=require("command/Menus"),StringUtils=require("utils/StringUtils"),KeyBindingManager=require("command/KeyBindingManager"),Metrics=require("utils/Metrics"),Dialogs=require("widgets/Dialogs"),Mustache=require("thirdparty/mustache/mustache"),SurveyTemplate=require("text!./html/survey-template.html"),NOTIFICATION_BACKOFF=1e4,GUIDED_TOUR_LOCAL_STORAGE_KEY="guidedTourActions",surveyLinksURL="https://updates.phcode.io/surveys.json",GENERAL_SURVEY_TIME=12e5,SURVEY_PRELOAD_DELAY=1e4,ONE_MONTH_IN_DAYS=30,POWER_USER_SURVEY_INTERVAL_DAYS=35,userAlreadyDidAction=PhStore.getItem(GUIDED_TOUR_LOCAL_STORAGE_KEY)?JSON.parse(PhStore.getItem(GUIDED_TOUR_LOCAL_STORAGE_KEY)):{version:1,newProjectShown:!1,beautifyCodeShown:!1,generalSurveyShownVersion:0};let currentlyShowingNotification;function _showBeautifyNotification(){if(userAlreadyDidAction.beautifyCodeShown)return;let editorContextMenu=Menus.getContextMenu(Menus.ContextMenuIds.EDITOR_MENU);function _showNotification(){currentlyShowingNotification||setTimeout(()=>{let keyboardShortcut=KeyBindingManager.getKeyBindingsDisplay(Commands.EDIT_BEAUTIFY_CODE);keyboardShortcut=keyboardShortcut||"",userAlreadyDidAction.beautifyCodeShown=!0,PhStore.setItem(GUIDED_TOUR_LOCAL_STORAGE_KEY,JSON.stringify(userAlreadyDidAction)),Metrics.countEvent(Metrics.EVENT_TYPE.UI,"guide","beautify"),(currentlyShowingNotification=NotificationUI.createFromTemplate(Strings.CMD_BEAUTIFY_CODE,StringUtils.format(Strings.BEAUTIFY_CODE_NOTIFICATION,keyboardShortcut),"editor-context-menu-edit.beautifyCode",{allowedPlacements:["left","right"],autoCloseTimeS:15,dismissOnClick:!0})).done(()=>{currentlyShowingNotification=null}),editorContextMenu.off(Menus.EVENT_BEFORE_CONTEXT_MENU_OPEN,_showNotification)},500)}editorContextMenu.on(Menus.EVENT_BEFORE_CONTEXT_MENU_OPEN,_showNotification)}function _showNewProjectNotification(){userAlreadyDidAction.newProjectShown||(currentlyShowingNotification?setTimeout(_showNewProjectNotification,NOTIFICATION_BACKOFF):(userAlreadyDidAction.newProjectShown=!0,PhStore.setItem(GUIDED_TOUR_LOCAL_STORAGE_KEY,JSON.stringify(userAlreadyDidAction)),Metrics.countEvent(Metrics.EVENT_TYPE.UI,"guide","newProj"),(currentlyShowingNotification=NotificationUI.createFromTemplate(Strings.START_PROJECT,Strings.NEW_PROJECT_NOTIFICATION,"newProject",{allowedPlacements:["top","bottom"],autoCloseTimeS:15,dismissOnClick:!0})).done(()=>{currentlyShowingNotification=null})))}function _loadTwitterScripts(){if(window.twttr)return;const twitterScript=document.createElement("script");twitterScript.setAttribute("src","https://platform.twitter.com/widgets.js"),document.body.appendChild(twitterScript),twitterScript.addEventListener("load",()=>{window.twttr?window.twttr.events.bind("click",function(ev){Metrics.countEvent(Metrics.EVENT_TYPE.USER,"notify","twit.click",1),Phoenix.isNativeApp&&Phoenix.app.openURLInDefaultBrowser("https://twitter.com/intent/tweet?screen_name=phcodedev&ref_src=twsrc%5Etfw")}):console.error("twitter scripts not loaded")})}function _openStarsPopup(){_loadTwitterScripts();let notification=$(`${Strings.GITHUB_STARS_POPUP}\n                        <div class="gtstarph" style="display: flex;justify-content: space-around;margin-top: 6px;">\n                            <a class="github-button"\n                             href="https://github.com/phcode-dev/phoenix"\n                             data-color-scheme="no-preference: dark; light: dark; dark: dark;"\n                             data-icon="octicon-star"\n                             data-size="large"\n                             data-show-count="true"\n                             title="Star phcode.dev on GitHub"\n                             aria-label="Star phcode-dev/phoenix on GitHub">Star</a>\n                             <a class="github-button"\n                             href="https://github.com/sponsors/phcode-dev"\n                             data-color-scheme="no-preference: dark; light: dark; dark: dark;"\n                             data-icon="octicon-heart"\n                             data-size="large"\n                             data-show-count="true"\n                             title="Star phcode.dev on GitHub"\n                             aria-label="Sponsor @phcode-dev on GitHub">Sponsor</a>\n                           <script async defer src="https://buttons.github.io/buttons.js"><\/script>\n                        </div>\n                       ${Strings.GITHUB_STARS_POPUP_TWITTER}\n                       <div class="twbnpop" style="display: flex;justify-content: space-around;margin-top: 6px;">\n                            <a href="https://twitter.com/intent/tweet?screen_name=phcodedev&ref_src=twsrc%5Etfw"\n                             class="twitter-mention-button"\n                             data-size="large"\n                             data-related="BracketsCont,brackets"\n                             data-show-count="false">Tweet to @phcodedev</a>\n                       </div>\n                    </div>`);notification.find(".gtstarph").click(()=>{Metrics.countEvent(Metrics.EVENT_TYPE.USER,"notify","star.click",1),Phoenix.isNativeApp&&Phoenix.app.openURLInDefaultBrowser("https://github.com/phcode-dev/phoenix")}),NotificationUI.createToastFromTemplate(Strings.ENJOYING_APP,notification,{dismissOnClick:!1})}function _showRequestStarsPopup(){if(Phoenix.firstBoot)return;let lastShownDate=userAlreadyDidAction.lastShownGithubStarsDate,nextShowDate=new Date(lastShownDate);nextShowDate.setUTCDate(nextShowDate.getUTCDate()+ONE_MONTH_IN_DAYS);let currentDate=new Date;(!lastShownDate||currentDate>=nextShowDate)&&(Metrics.countEvent(Metrics.EVENT_TYPE.USER,"notify","star",1),_openStarsPopup(),userAlreadyDidAction.lastShownGithubStarsDate=Date.now(),PhStore.setItem(GUIDED_TOUR_LOCAL_STORAGE_KEY,JSON.stringify(userAlreadyDidAction)))}function _showFirstUseSurvey(surveyURL,delayOverride,title,useDialog){let surveyVersion=6,$surveyFrame;6!==userAlreadyDidAction.generalSurveyShownVersion&&(useDialog&&($surveyFrame=addSurveyIframe(surveyURL)),setTimeout(()=>{useDialog?(Metrics.countEvent(Metrics.EVENT_TYPE.USER,"survey","firstDialog",1),_showDialogSurvey($surveyFrame)):(Metrics.countEvent(Metrics.EVENT_TYPE.USER,"survey","firstNotification",1),_showSurveyNotification(surveyURL,title)),userAlreadyDidAction.generalSurveyShownVersion=6,PhStore.setItem(GUIDED_TOUR_LOCAL_STORAGE_KEY,JSON.stringify(userAlreadyDidAction))},delayOverride||GENERAL_SURVEY_TIME))}function addSurveyIframe(surveyURL){const $surveyFrame=$("<iframe>",{src:surveyURL,class:"forced-hidden",css:{border:"0",position:"absolute",top:0,"z-index":1e4}});return $("#alwaysHiddenElements").append($surveyFrame),$surveyFrame}function repositionIframe($surveyFrame,$destContainer){const container=$destContainer.offset(),height=$destContainer.outerHeight(),width=$destContainer.outerWidth();$surveyFrame.css({top:container.top+"px",left:container.left+"px",width:width+"px",height:height+"px",display:"block"}),$surveyFrame.removeClass("forced-hidden")}function observerPositionChanges($surveyFrame,$destContainer){const resizeObserver=new ResizeObserver(function(){repositionIframe($surveyFrame,$destContainer)});return resizeObserver.observe(document.body),resizeObserver}function _showDialogSurvey($surveyFrame){const templateVars={Strings:Strings};let positionObserver;Dialogs.showModalDialogUsingTemplate(Mustache.render(SurveyTemplate,templateVars)).done(()=>{positionObserver&&positionObserver.disconnect(),$surveyFrame.remove()});const $surveyFrameContainer=$("#surveyFrameContainer");setTimeout(()=>{repositionIframe($surveyFrame,$surveyFrameContainer),positionObserver=observerPositionChanges($surveyFrame,$surveyFrameContainer)},200)}function _showSurveyNotification(surveyUrl,title){NotificationUI.createToastFromTemplate(title||Strings.SURVEY_TITLE_VOTE_FOR_FEATURES_YOU_WANT,`<div class="survey-notification-popup">\n                    <iframe src="${surveyUrl}" style="width: 500px; height: 645px;" frameborder="0"></iframe></div>`,{toastStyle:`${NotificationUI.NOTIFICATION_STYLES_CSS_CLASS.INFO} survey-notification-big forced-hidden`,dismissOnClick:!1}),setTimeout(()=>{$(".survey-notification-big").removeClass("forced-hidden")},SURVEY_PRELOAD_DELAY)}function _showRepeatUserSurvey(surveyURL,intervalOverride,title,useDialog){let nextPowerSurveyShowDate=userAlreadyDidAction.nextPowerSurveyShowDate;if(!nextPowerSurveyShowDate){let nextShowDate=new Date;return nextShowDate.setUTCDate(nextShowDate.getUTCDate()+14),userAlreadyDidAction.nextPowerSurveyShowDate=nextShowDate.getTime(),void PhStore.setItem(GUIDED_TOUR_LOCAL_STORAGE_KEY,JSON.stringify(userAlreadyDidAction))}const intervalDays=intervalOverride||POWER_USER_SURVEY_INTERVAL_DAYS;let nextShowDate=new Date(nextPowerSurveyShowDate),currentDate;if(!(new Date<nextShowDate)){if(useDialog){const $surveyFrame=addSurveyIframe(surveyURL);setTimeout(()=>{Metrics.countEvent(Metrics.EVENT_TYPE.USER,"survey","powerDialog",1),_showDialogSurvey($surveyFrame)},SURVEY_PRELOAD_DELAY)}else Metrics.countEvent(Metrics.EVENT_TYPE.USER,"survey","powerNotification",1),_showSurveyNotification(surveyURL,title);nextShowDate.setUTCDate(nextShowDate.getUTCDate()+intervalDays),userAlreadyDidAction.nextPowerSurveyShowDate=nextShowDate.getTime(),PhStore.setItem(GUIDED_TOUR_LOCAL_STORAGE_KEY,JSON.stringify(userAlreadyDidAction))}}async function _showSurveys(){try{if(!navigator.onLine)return;let surveyJSON=await fetch(surveyLinksURL);surveyJSON=await surveyJSON.json(),!Phoenix.isNativeApp&&surveyJSON.browser&&(surveyJSON={newUser:surveyJSON.browser.newUser||surveyJSON.newUser,newUserTitle:surveyJSON.browser.newUserTitle||surveyJSON.newUserTitle,newUserShowDelayMS:surveyJSON.browser.newUserShowDelayMS||surveyJSON.newUserShowDelayMS,newUserUseDialog:surveyJSON.browser.newUserUseDialog||surveyJSON.newUserUseDialog,powerUser:surveyJSON.browser.powerUser||surveyJSON.powerUser,powerUserTitle:surveyJSON.browser.powerUserTitle||surveyJSON.powerUserTitle,powerUserShowIntervalDays:surveyJSON.browser.powerUserShowIntervalDays||surveyJSON.powerUserShowIntervalDays,powerUserUseDialog:surveyJSON.browser.powerUserUseDialog||surveyJSON.powerUserUseDialog}),surveyJSON.newUser&&_showFirstUseSurvey(surveyJSON.newUser,surveyJSON.newUserShowDelayMS,surveyJSON.newUserTitle,surveyJSON.newUserUseDialog),surveyJSON.powerUser&&_showRepeatUserSurvey(surveyJSON.powerUser,surveyJSON.powerUserShowIntervalDays,surveyJSON.powerUserTitle,surveyJSON.powerUserUseDialog)}catch(e){console.error("Error fetching survey link",surveyLinksURL,e),Metrics.countEvent(Metrics.EVENT_TYPE.USER,"survey","fetchError",1)}}let tourStarted=!1;exports.startTourIfNeeded=function(){tourStarted||(tourStarted=!0,_showNewProjectNotification(),_showBeautifyNotification(),_showRequestStarsPopup(),_showSurveys())}});
//# sourceMappingURL=guided-tour.js.map
