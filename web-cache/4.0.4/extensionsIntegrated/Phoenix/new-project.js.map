{"version":3,"sources":["extensionsIntegrated/Phoenix/new-project.js"],"names":["define","require","exports","module","Dialogs","Mustache","newProjectTemplate","Strings","StringUtils","ExtensionInterface","CommandManager","Commands","Menus","Metrics","DefaultDialogs","FileSystem","FileUtils","ZipUtils","ProjectManager","EventDispatcher","DocumentCommandHandlers","createProjectDialogue","replaceProjectDialogue","replaceKeepProjectDialogue","defaultProjects","guidedTour","makeEventDispatcher","NEW_PROJECT_INTERFACE","MAX_DEDUPE_COUNT","registerExtensionInterface","newProjectDialogueObj","createProjectDialogueObj","downloadCancelled","_focusContentWindow","attempts","maxAttempts","intervalId","setInterval","frame","document","getElementById","contentWindow","focus","clearInterval","console","warn","_showNewProjectDialogue","window","testEnvironment","isVisible","templateVars","newProjectURL","Phoenix","baseURL","dialogueContents","render","showModalDialogUsingTemplate","countEvent","EVENT_TYPE","NEW_PROJECT","_addMenuEntries","register","CMD_PROJECT_NEW","FILE_NEW_PROJECT","fileMenu","getMenu","AppMenuBar","FILE_MENU","addMenuItem","AFTER","FILE_NEW_FOLDER","closeDialogue","close","trigger","EVENT_NEW_PROJECT_DIALOGUE_CLOSED","startTourIfNeeded","showErrorDialogue","title","message","showModalDialog","DIALOG_ID_ERROR","openFolder","execute","FILE_OPEN_FOLDER","then","async","_shouldNotShowDialog","isNativeApp","getProjectRoot","fullPath","getWelcomeProjectPath","_isOpenWithFileFromOS","cliArgs","app","getCommandLineArgs","args","length","projectOpened","getPlaceholderProjectPath","init","shouldShowWelcome","PhStore","getItem","notShow","on","_EVENT_OPEN_WITH_FILE_FROM_OS","_showProjectErrorDialogue","desc","projectPath","err","format","ERROR_LOADING_PROJECT","_showReplaceProjectConfirmDialogue","DIRECTORY_REPLACE_MESSAGE","MESSAGE","_showReplaceKeepProjectConfirmDialogue","_checkIfPathIsWritable","path","Promise","resolve","reject","file","getFileForPath","writeText","done","fail","_validateProjectFolder","dir","getDirectoryForPath","displayPath","getDisplayPath","REQUEST_NATIVE_FILE_SYSTEM_ERROR","NOT_FOUND_ERR","getContents","contents","READ_DIRECTORY_ENTRIES_ERROR","_resolveIfWritable","catch","id","DIALOG_BTN_OK","_findFreeFolderName","basePath","i","newPath","exists","VFS","existsAsync","ensureExistsDirAsync","e","_getSuggestedProjectDir","suggestedProjectName","getLocalProjectsPath","DIALOG_BTN_CANCEL","_showCreateProjectDialogue","TITLE","_closeCreateProjectDialogue","_updateCreateProjectDialogueMessage","el","textContent","_unzipProject","data","flattenFirstLevelInZip","progressCb","UNZIP_IN_PROGRESS","DOWNLOAD_COMPLETE","unzipBinDataToLocation","downloadAndOpenProject","downloadURL","log","SETTING_UP_PROJECT","DOWNLOADING","JSZipUtils","getBinaryContent","callback","error","DOWNLOAD_FAILED","DOWNLOAD_FAILED_MESSAGE","_progressCB","total","EXTRACTING_FILES_PROGRESS","openProject","UNZIP_FAILED","progress","status","percent","Math","round","abortCheck","showFolderSelect","initialPath","showOpenDialog","CHOOSE_FOLDER","files","gitClone","url","cloneDIR","cloneFolderExists","_dirExists","jsPromise","setTimeout","ERROR_CLONING_TITLE","_getGitFolderName","gitURL","trim","parts","replace","split","entry","resolveAsync","isDirectory","getGitCloneDir","selectedDir","selectedDirExists","ERROR_GIT_FOLDER_NOT_EXIST","clonePath","selectedEntry","isEmptyAsync","folderName","ERROR_GIT_FOLDER_NOT_EMPTY","childDirPath","join","childDirExists","childEntry","isChildEmpty","showAboutBox","HELP_ABOUT","EVENT_AFTER_PROJECT_OPEN","setupExploreProject","setupStartupProject","alreadyExists","getExploreProjectPath","getMountDir","getTauriDir","getTauriPlatformPath","fs"],"mappings":"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","sourcesContent":["/*\n * GNU AGPL-3.0 License\n *\n * Copyright (c) 2021 - present core.ai . All rights reserved.\n *\n * This program is free software: you can redistribute it and/or modify it\n * under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT\n * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License\n * for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see https://opensource.org/licenses/AGPL-3.0.\n *\n */\n\n/*global path, jsPromise*/\n\ndefine(function (require, exports, module) {\n    const Dialogs = require(\"widgets/Dialogs\"),\n        Mustache = require(\"thirdparty/mustache/mustache\"),\n        newProjectTemplate = require(\"text!./html/new-project-template.html\"),\n        Strings = require(\"strings\"),\n        StringUtils = require(\"utils/StringUtils\"),\n        ExtensionInterface = require(\"utils/ExtensionInterface\"),\n        CommandManager = require(\"command/CommandManager\"),\n        Commands = require(\"command/Commands\"),\n        Menus = require(\"command/Menus\"),\n        Metrics = require(\"utils/Metrics\"),\n        DefaultDialogs = require(\"widgets/DefaultDialogs\"),\n        FileSystem = require(\"filesystem/FileSystem\"),\n        FileUtils = require(\"file/FileUtils\"),\n        ZipUtils = require(\"utils/ZipUtils\"),\n        ProjectManager = require(\"project/ProjectManager\"),\n        EventDispatcher     = require(\"utils/EventDispatcher\"),\n        DocumentCommandHandlers = require(\"document/DocumentCommandHandlers\"),\n        createProjectDialogue = require(\"text!./html/create-project-dialogue.html\"),\n        replaceProjectDialogue = require(\"text!./html/replace-project-dialogue.html\"),\n        replaceKeepProjectDialogue = require(\"text!./html/replace-keep-project-dialogue.html\"),\n        defaultProjects   = require(\"./default-projects\"),\n        guidedTour = require(\"./guided-tour\");\n\n    EventDispatcher.makeEventDispatcher(exports);\n\n    const NEW_PROJECT_INTERFACE = \"Extn.Phoenix.newProject\",\n        MAX_DEDUPE_COUNT = 10000;\n\n    ExtensionInterface.registerExtensionInterface(NEW_PROJECT_INTERFACE, exports);\n\n    let newProjectDialogueObj,\n        createProjectDialogueObj,\n        downloadCancelled = false;\n\n    function _focusContentWindow() {\n        let attempts = 0;\n        const maxAttempts = 10; // 10 * 100ms = 1 second total scan time\n        const intervalId = setInterval(() => {\n            const frame = document.getElementById(\"newProjectFrame\");\n            if (frame && frame.contentWindow) {\n                frame.contentWindow.focus();\n                clearInterval(intervalId);\n            }\n\n            attempts++;\n            if (attempts >= maxAttempts) {\n                clearInterval(intervalId);\n                console.warn(\"Could not find or focus on newProjectFrame\");\n            }\n        }, 100);\n    }\n\n    function _showNewProjectDialogue() {\n        if(window.testEnvironment){\n            return;\n        }\n        if(newProjectDialogueObj && newProjectDialogueObj.isVisible()){\n            return;\n        }\n        let templateVars = {\n            Strings: Strings,\n            newProjectURL: `${window.Phoenix.baseURL}assets/new-project/code-editor.html`\n        };\n        let dialogueContents = Mustache.render(newProjectTemplate, templateVars);\n        newProjectDialogueObj = Dialogs.showModalDialogUsingTemplate(dialogueContents, true);\n        _focusContentWindow();\n        Metrics.countEvent(Metrics.EVENT_TYPE.NEW_PROJECT, \"dialogue\", \"open\");\n    }\n\n    function _addMenuEntries() {\n        CommandManager.register(Strings.CMD_PROJECT_NEW, Commands.FILE_NEW_PROJECT, _showNewProjectDialogue);\n        const fileMenu = Menus.getMenu(Menus.AppMenuBar.FILE_MENU);\n        fileMenu.addMenuItem(Commands.FILE_NEW_PROJECT, \"\", Menus.AFTER, Commands.FILE_NEW_FOLDER);\n    }\n\n    function closeDialogue() {\n        Metrics.countEvent(Metrics.EVENT_TYPE.NEW_PROJECT, \"dialogue\", \"close\");\n        newProjectDialogueObj.close();\n        exports.trigger(exports.EVENT_NEW_PROJECT_DIALOGUE_CLOSED);\n        guidedTour.startTourIfNeeded();\n    }\n\n    function showErrorDialogue(title, message) {\n        Dialogs.showModalDialog(\n            DefaultDialogs.DIALOG_ID_ERROR,\n            title,\n            message\n        );\n    }\n\n    function openFolder () {\n        CommandManager.execute(Commands.FILE_OPEN_FOLDER).then(closeDialogue);\n    }\n\n    async function _shouldNotShowDialog() {\n        if(!Phoenix.isNativeApp){\n            // in browser we always show the new project dialog even if there is a different startup project open. This\n            // is mainly for users to discover the download native app button in the new project window.\n            return false;\n        }\n        // in tauri, we don't show the dialog if its not default project or\n        // if phoenix was opened with a file/folder from os with cli args. In mac, this is done via\n        // setSingleInstanceCLIArgsHandler as it doesnt use cli args for open with like other os.\n        if(ProjectManager.getProjectRoot().fullPath !== ProjectManager.getWelcomeProjectPath() ||\n            DocumentCommandHandlers._isOpenWithFileFromOS()){\n            return true;\n        }\n        // we are in the default project, show the dialog only if we are not opened with a file\n        const cliArgs= await Phoenix.app.getCommandLineArgs();\n        const args = cliArgs && cliArgs.args;\n        if(!args || args.length <= 1){\n            return false;\n        }\n        return true;\n    }\n\n    function projectOpened() {\n        if(ProjectManager.getProjectRoot().fullPath === ProjectManager.getPlaceholderProjectPath()){\n            _showNewProjectDialogue();\n        }\n    }\n\n    ProjectManager.on(ProjectManager.EVENT_AFTER_PROJECT_OPEN, projectOpened);\n\n    function init() {\n        _addMenuEntries();\n        const shouldShowWelcome = PhStore.getItem(\"new-project.showWelcomeScreen\") || 'Y';\n        if(shouldShowWelcome !== 'Y') {\n            Metrics.countEvent(Metrics.EVENT_TYPE.NEW_PROJECT, \"dialogue\", \"disabled\");\n            guidedTour.startTourIfNeeded();\n            return;\n        }\n        _shouldNotShowDialog()\n            .then(notShow=>{\n                if(notShow){\n                    return;\n                }\n                _showNewProjectDialogue();\n                DocumentCommandHandlers.on(DocumentCommandHandlers._EVENT_OPEN_WITH_FILE_FROM_OS, ()=>{\n                    closeDialogue();\n                });\n            });\n    }\n\n    function _showProjectErrorDialogue(desc, projectPath, err) {\n        let message = StringUtils.format(desc, projectPath, err);\n        showErrorDialogue(Strings.ERROR_LOADING_PROJECT, message);\n    }\n\n    function _showReplaceProjectConfirmDialogue(projectPath) {\n        let message = StringUtils.format(Strings.DIRECTORY_REPLACE_MESSAGE, projectPath);\n        let templateVars = {\n            Strings: Strings,\n            MESSAGE: message\n        };\n        return Dialogs.showModalDialogUsingTemplate(Mustache.render(replaceProjectDialogue, templateVars));\n    }\n\n    function _showReplaceKeepProjectConfirmDialogue(projectPath) {\n        let message = StringUtils.format(Strings.DIRECTORY_REPLACE_MESSAGE, projectPath);\n        let templateVars = {\n            Strings: Strings,\n            MESSAGE: message\n        };\n        return Dialogs.showModalDialogUsingTemplate(Mustache.render(replaceKeepProjectDialogue, templateVars));\n    }\n\n    function _checkIfPathIsWritable(path) {\n        // this is needed as for fs access APIs in native folders, the browser will ask an additional write permission\n        // to the user. We have to validate that before proceeding.\n        // We do this by writing a file `.phcode.json` to the folder\n        return new Promise((resolve, reject)=>{\n            let file = FileSystem.getFileForPath(`${path}/.phcode.json`);\n            FileUtils.writeText(file, \"{}\", true)\n                .done(resolve)\n                .fail(reject);\n        });\n    }\n\n    async function _validateProjectFolder(projectPath) {\n        return new Promise((resolve, reject)=>{\n            let dir = FileSystem.getDirectoryForPath(projectPath);\n            let displayPath = Phoenix.app.getDisplayPath(projectPath);\n            if(!dir){\n                _showProjectErrorDialogue(Strings.REQUEST_NATIVE_FILE_SYSTEM_ERROR, displayPath, Strings.NOT_FOUND_ERR);\n                reject();\n            }\n            dir.getContents(function (err, contents) {\n                if (err) {\n                    _showProjectErrorDialogue(Strings.READ_DIRECTORY_ENTRIES_ERROR, displayPath, Strings.NOT_FOUND_ERR);\n                    reject();\n                    return;\n                }\n                function _resolveIfWritable() {\n                    _checkIfPathIsWritable(projectPath)\n                        .then(resolve)\n                        .catch(reject);\n                }\n                if(contents.length >0){\n                    _showReplaceProjectConfirmDialogue(displayPath).done(function (id) {\n                        if (id === Dialogs.DIALOG_BTN_OK) {\n                            _resolveIfWritable();\n                            return;\n                        }\n                        reject();\n                    });\n                } else {\n                    _resolveIfWritable();\n                }\n            });\n        });\n    }\n\n    async function _findFreeFolderName(basePath) {\n        return new Promise(async (resolve, reject)=>{ // eslint-disable-line\n            try {\n                for(let i=0; i< MAX_DEDUPE_COUNT; i++){\n                    let newPath = `${basePath}-${i}`;\n                    let exists = await window.Phoenix.VFS.existsAsync(newPath);\n                    if(!exists){\n                        await window.Phoenix.VFS.ensureExistsDirAsync(newPath);\n                        resolve(newPath);\n                        return;\n                    }\n                }\n                reject();\n            } catch (e) {\n                reject(e);\n            }\n        });\n    }\n\n    async function _getSuggestedProjectDir(suggestedProjectName) {\n        return new Promise(async (resolve, reject)=>{ // eslint-disable-line\n            try{\n                // try suggested path first\n                let projectPath = `${ProjectManager.getLocalProjectsPath()}${suggestedProjectName}`;\n                let exists = await window.Phoenix.VFS.existsAsync(projectPath);\n                if(!exists){\n                    resolve(projectPath);\n                    return;\n                }\n                _showReplaceKeepProjectConfirmDialogue(suggestedProjectName).done(function (id) {\n                    if (id === Dialogs.DIALOG_BTN_OK) {\n                        resolve(projectPath);\n                        return;\n                    } else if(id === Dialogs.DIALOG_BTN_CANCEL){\n                        reject();\n                        return;\n                    }\n                    _findFreeFolderName(projectPath)\n                        .then(projectPath=>resolve(projectPath))\n                        .catch(reject);\n                });\n            } catch (e) {\n                reject(e);\n            }\n        });\n    }\n\n    function _showCreateProjectDialogue(title, message) {\n        let templateVars = {\n            Strings: Strings,\n            TITLE: title,\n            MESSAGE: message\n        };\n        createProjectDialogueObj=\n            Dialogs.showModalDialogUsingTemplate(Mustache.render(createProjectDialogue, templateVars));\n        return createProjectDialogueObj;\n    }\n\n    function _closeCreateProjectDialogue() {\n        createProjectDialogueObj.close();\n    }\n\n    function _updateCreateProjectDialogueMessage(message, title) {\n        let el = document.getElementById('new-prj-msg-dlg-message');\n        if(el){\n            el.textContent = message;\n        }\n        el = document.getElementById('new-prj-msg-dlg-title');\n        if(el && title){\n            el.textContent = title;\n        }\n    }\n\n    function _unzipProject(data, projectPath, flattenFirstLevelInZip, progressCb) {\n        return new Promise((resolve, reject)=>{\n            _updateCreateProjectDialogueMessage(Strings.UNZIP_IN_PROGRESS, Strings.DOWNLOAD_COMPLETE);\n            ZipUtils.unzipBinDataToLocation(data, projectPath, flattenFirstLevelInZip, progressCb)\n                .then(resolve)\n                .catch(reject);\n        });\n    }\n\n    /**\n     *\n     * @param downloadURL\n     * @param projectPath\n     * @param suggestedProjectName\n     * @param flattenFirstLevelInZip if set to true, then if zip contents are nested inside a directory, the nexted dir\n     * will be removed in the path structure in destination. For Eg. some Zip may contain a `contents` folder inside the\n     * zip which has all the contents. If we blindly extract the zio, all the contents will be placed inside a\n     * `contents` folder in root and not the root dir itself.\n     * See a sample zip file here: https://api.github.com/repos/StartBootstrap/startbootstrap-grayscales/zipball\n     * @returns {Promise<void>}\n     */\n    async function downloadAndOpenProject(downloadURL, projectPath, suggestedProjectName, flattenFirstLevelInZip) {\n        return new Promise(async (resolve, reject)=>{ // eslint-disable-line\n            try {\n                // if project path is null, create one in default folder\n                if(!projectPath){\n                    projectPath = await _getSuggestedProjectDir(suggestedProjectName);\n                } else {\n                    await _validateProjectFolder(projectPath);\n                }\n                console.log(\n                    `downloadAndOpenProject ${suggestedProjectName} from URL: ${downloadURL} to: ${projectPath}`);\n\n                downloadCancelled = false;\n                _showCreateProjectDialogue(Strings.SETTING_UP_PROJECT, Strings.DOWNLOADING).done(function (id) {\n                    if (id === Dialogs.DIALOG_BTN_CANCEL) {\n                        downloadCancelled = true;\n                    }\n                });\n                window.JSZipUtils.getBinaryContent(downloadURL, {\n                    callback: async function(err, data) {\n                        if(downloadCancelled){\n                            reject();\n                        } else if(err) {\n                            console.error(\"could not load phoenix default project from zip file!\", err);\n                            _closeCreateProjectDialogue();\n                            showErrorDialogue(Strings.DOWNLOAD_FAILED, Strings.DOWNLOAD_FAILED_MESSAGE);\n                            reject();\n                        } else {\n                            function _progressCB(done, total) {\n                                let message = StringUtils.format(Strings.EXTRACTING_FILES_PROGRESS, done, total);\n                                _updateCreateProjectDialogueMessage(message);\n                                return !downloadCancelled; // continueExtraction id not download cancelled\n                            }\n                            _unzipProject(data, projectPath, flattenFirstLevelInZip, _progressCB)\n                                .then(()=>{\n                                    _closeCreateProjectDialogue();\n                                    ProjectManager.openProject(projectPath)\n                                        .then(resolve)\n                                        .fail(reject);\n                                    console.log(\"Project Setup complete: \", projectPath);\n                                })\n                                .catch(()=>{\n                                    _closeCreateProjectDialogue();\n                                    showErrorDialogue(Strings.ERROR_LOADING_PROJECT, Strings.UNZIP_FAILED);\n                                    reject();\n                                });\n                        }\n                    },\n                    progress: function (status){\n                        if(status.percent > 0){\n                            _updateCreateProjectDialogueMessage(\n                                `${Strings.DOWNLOADING} ${Math.round(status.percent)}%`);\n                        }\n                    },\n                    abortCheck: function (){\n                        return downloadCancelled;\n                    }\n                });\n            } catch (e) {\n                reject(e);\n            }\n        });\n    }\n\n    function showFolderSelect(initialPath = \"\") {\n        return new Promise((resolve, reject)=>{\n            FileSystem.showOpenDialog(false, true, Strings.CHOOSE_FOLDER, initialPath, null, function (err, files) {\n                if(err || files.length !== 1){\n                    reject();\n                    return;\n                }\n                resolve(files[0]);\n            });\n        });\n    }\n\n    async function gitClone(url, cloneDIR) {\n        try{\n            const cloneFolderExists = await _dirExists(cloneDIR);\n            if(!cloneFolderExists) {\n                await Phoenix.VFS.ensureExistsDirAsync(cloneDIR);\n            }\n            await jsPromise(ProjectManager.openProject(cloneDIR));\n            CommandManager.execute(\"git-clone-url\", url, cloneDIR );\n        } catch (e) {\n            setTimeout(async ()=>{\n                // we need this timeout as when user clicks clone in new project dialog, it will immediately\n                // close the error dialog too as it dismisses itself.\n                showErrorDialogue(Strings.ERROR_CLONING_TITLE, e.message || e);\n            }, 100);\n            console.error(\"git clone failed: \", url, cloneDIR, e);\n            Metrics.countEvent(Metrics.EVENT_TYPE.NEW_PROJECT, \"gitClone\", \"fail\");\n        }\n    }\n\n    function _getGitFolderName(gitURL) {\n        if (typeof gitURL !== 'string' || !gitURL.trim()) {\n            return \"\";\n        }\n        // Remove trailing `.git` if it exists and split the URL\n        const parts = gitURL.replace(/\\.git$/, '').split('/');\n        // Return the last segment as the project folder name\n        return parts[parts.length - 1];\n    }\n\n    async function _dirExists(fullPath) {\n        try {\n            const {entry} = await FileSystem.resolveAsync(fullPath);\n            return entry.isDirectory;\n        } catch (e) {\n            return false;\n        }\n    }\n\n    /**\n     * Determines which directory to use for a Git clone operation:\n     *  1. If the selected directory is empty, returns that directory.\n     *  2. Otherwise, checks/creates a child directory named after the Git project.\n     *     - If that child directory is (or becomes) empty, returns its entry.\n     *     - If it is not empty, returns null.\n     *\n     * @param {string} selectedDir - The full path to the user-selected directory.\n     * @param {string} gitURL - The Git clone URL (used to derive the child folder name).\n     * @returns {Promise<{error, }>} error string to show to user and the path to clone.\n     */\n    async function getGitCloneDir(selectedDir, gitURL) {\n        const selectedDirExists = await _dirExists(selectedDir);\n        if (!selectedDirExists) {\n            return {error: Strings.ERROR_GIT_FOLDER_NOT_EXIST, clonePath: selectedDir};\n        }\n\n        const {entry: selectedEntry} = await FileSystem.resolveAsync(selectedDir);\n        if (await selectedEntry.isEmptyAsync()) {\n            return {clonePath: selectedDir};\n        }\n\n        // If not empty, compute the child directory path\n        const folderName = _getGitFolderName(gitURL);\n        if(!folderName){\n            return {error: Strings.ERROR_GIT_FOLDER_NOT_EMPTY, clonePath: selectedDir};\n        }\n\n        const childDirPath = path.join(selectedDir, folderName);\n        const childDirExists = await _dirExists(childDirPath);\n        if (!childDirExists) {\n            return {clonePath: childDirPath};\n        }\n        // The child directory exists; check if it is empty\n        const {entry: childEntry} = await FileSystem.resolveAsync(childDirPath);\n        const isChildEmpty = await childEntry.isEmptyAsync();\n        if(isChildEmpty){\n            return {clonePath: childDirPath};\n        }\n        return {error: Strings.ERROR_GIT_FOLDER_NOT_EMPTY, clonePath: childDirPath};\n    }\n\n    function showAboutBox() {\n        CommandManager.execute(Commands.HELP_ABOUT);\n    }\n\n    exports.init = init;\n    exports.openFolder = openFolder;\n    exports.closeDialogue = closeDialogue;\n    exports.downloadAndOpenProject = downloadAndOpenProject;\n    exports.showFolderSelect = showFolderSelect;\n    exports.showErrorDialogue = showErrorDialogue;\n    exports.getGitCloneDir = getGitCloneDir;\n    exports.gitClone = gitClone;\n    exports.setupExploreProject = defaultProjects.setupExploreProject;\n    exports.setupStartupProject = defaultProjects.setupStartupProject;\n    exports.alreadyExists = window.Phoenix.VFS.existsAsync;\n    exports.Metrics = Metrics;\n    exports.EVENT_NEW_PROJECT_DIALOGUE_CLOSED = \"newProjectDlgClosed\";\n    exports.getWelcomeProjectPath = ProjectManager.getWelcomeProjectPath;\n    exports.getExploreProjectPath = ProjectManager.getExploreProjectPath;\n    exports.getLocalProjectsPath = ProjectManager.getLocalProjectsPath;\n    exports.getMountDir = Phoenix.VFS.getMountDir;\n    exports.path = Phoenix.path;\n    exports.getTauriDir = Phoenix.VFS.getTauriDir;\n    exports.getTauriPlatformPath = Phoenix.fs.getTauriPlatformPath;\n    exports.showAboutBox = showAboutBox;\n});\n"],"file":"new-project.js"}