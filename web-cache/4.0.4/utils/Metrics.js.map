{"version":3,"sources":["utils/Metrics.js"],"names":["define","require","exports","module","MAX_AUDIT_ENTRIES","ONE_DAY","initDone","disabled","loggedDataForAudit","Map","isFirstUseDay","userID","isPowerUserFn","cachedIsPowerUser","_setUserID","userIDKey","window","PhStore","getItem","crypto","randomUUID","setItem","_setFirstDayFlag","firstUseDayKey","firstBootTime","Date","now","firstUseDay","dayAfterFirstUse","setUTCDate","getUTCDate","today","setTimeout","EVENT_TYPE","PLATFORM","PROJECT","THEMES","EXTENSIONS","NOTIFICATIONS","UI","UI_MENU","UI_DIALOG","UI_BOTTOM_PANEL","UI_SIDE_PANEL","UPDATES","LIVE_PREVIEW","KEYBOARD","CODE_HINTS","EDITOR","QUICK_VIEW","SEARCH","SHARING","PERFORMANCE","STORAGE","NEW_PROJECT","ERROR","USER","NODEJS","LINT","GIT","_createAnalyticsShims","analytics","_initData","loadStartTime","getTime","event","push","arguments","Phoenix","isNativeApp","dataLayer","gtag","length","splice","MINUTES_10","tauriGaErrorCountSent","sendOnceMore","noFurtherReporting","_sendTauriGAEvent","analyticsID","customUserID","events","__TAURI__","emit","catch","err","debugMode","console","error","logger","reportError","tauriGAEvents","_sendGaEvent","eventAct","category","label","count","key","existingEvent","get","set","event_category","event_label","value","TAURI_GA_EVENT_QUEUE_INTERVAL","_sendQueuedTauriGAEvents","brackets","config","googleAnalyticsIDDesktop","Array","from","values","clear","_initGoogleAnalytics","setInterval","script","document","createElement","type","async","onload","googleAnalyticsID","page_title","page_path","page_location","location","origin","src","getElementsByTagName","appendChild","_initCoreAnalytics","appName","coreAnalyticsAppNameDesktop","coreAnalyticsAppName","initAnalyticsSession","coreAnalyticsID","init","initOptions","testEnvironment","ignoredGAEvents","_sendToGoogleAnalytics","action","includes","_sendToCoreAnalytics","AUDIT_TYPE_COUNT","AUDIT_TYPE_VALUE","_logEventForAudit","eventType","eventCategory","eventSubCategory","val","defaultVal","sum","newVal","size","NUM_ENTRIES_TO_DELETE","keys","slice","forEach","k","delete","_countEvent","countEvent","_valueEvent","valueEvent","setDisabled","shouldDisable","isDisabled","getLoggedDataForAudit","clearAuditData","flushMetrics","e","logPerformanceTime","durationMs","Number","getRangeName","number","ranges","i","isPowerUser","Error"],"mappings":"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","sourcesContent":["/*\n * GNU AGPL-3.0 License\n *\n * Copyright (c) 2021 - present core.ai . All rights reserved.\n * Original work Copyright (c) 2015 - 2021 Adobe Systems Incorporated. All rights reserved.\n *\n * This program is free software: you can redistribute it and/or modify it\n * under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT\n * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License\n * for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see https://opensource.org/licenses/AGPL-3.0.\n *\n */\n\n/*global gtag, analytics, logger*/\n\n/**\n * The Metrics API can be used to send analytics data to track feature usage in accordance with users privacy settings.\n *\n *`Status: Internal - Not to be used by third party extensions.`\n *\n * ### Import\n * @example\n * ```js\n * // usage within core:\n * const Metrics = require(\"utils/Metrics\");\n *\n * // usage within default extensions:\n * const Metrics = brackets.getModule(\"utils/Metrics\");\n * ```\n *\n * @module utils/Metrics\n */\ndefine(function (require, exports, module) {\n    const MAX_AUDIT_ENTRIES = 3000,\n        ONE_DAY = 24 * 60* 60 * 1000;\n    let initDone = false,\n        disabled = false,\n        loggedDataForAudit = new Map();\n\n    let isFirstUseDay;\n    let userID, isPowerUserFn;\n    let cachedIsPowerUser = false;\n\n    function _setUserID() {\n        const userIDKey = \"phoenixUserPseudoID\";\n        userID = window.PhStore.getItem(userIDKey);\n        if(!userID){\n            userID = crypto.randomUUID();\n            window.PhStore.setItem(userIDKey, userID);\n        }\n    }\n    _setUserID();\n\n    function _setFirstDayFlag() {\n        const firstUseDayKey = \"healthData.firstUseDay\";\n        let firstBootTime = window.PhStore.getItem(firstUseDayKey);\n        if(!firstBootTime){\n            firstBootTime = Date.now();\n            window.PhStore.setItem(firstUseDayKey, firstBootTime);\n        }\n        let firstUseDay= new Date(firstBootTime);\n        let dayAfterFirstUse = new Date(firstUseDay);\n        dayAfterFirstUse.setUTCDate(firstUseDay.getUTCDate() + 1);\n        let today = new Date();\n        isFirstUseDay = today < dayAfterFirstUse;\n        if(!isFirstUseDay){\n            setTimeout(_setFirstDayFlag, ONE_DAY);\n        }\n    }\n    _setFirstDayFlag();\n\n    /**\n     * This section outlines the properties and methods available in this module\n     * @name API\n     */\n\n    /**\n     * The Type of events that can be specified as an `eventType` in the API calls.\n     *\n     * ### Properties\n     * `PLATFORM`, `PROJECT`, `THEMES`, `EXTENSIONS`, `EXTENSIONS`, `UI`, `UI_DIALOG`, `UI_BOTTOM_PANEL`,\n     * `UI_SIDE_PANEL`, `LIVE_PREVIEW`, `CODE_HINTS`, `EDITOR`, `SEARCH`, `SHARING`, `PERFORMANCE`, `NEW_PROJECT`\n     * `ERROR`, `USER`, `NODEJS`, `LINT`, `GIT`\n     *\n     * @typedef EVENT_TYPE\n     * @type {Object}\n     */\n    const EVENT_TYPE = {\n        PLATFORM: \"platform\",\n        PROJECT: \"project\",\n        THEMES: \"themes\",\n        EXTENSIONS: \"extensions\",\n        NOTIFICATIONS: \"notifications\",\n        UI: \"UI\",\n        UI_MENU: \"UIMenu\",\n        UI_DIALOG: \"ui-dialog\",\n        UI_BOTTOM_PANEL: \"ui-bottomPanel\",\n        UI_SIDE_PANEL: \"ui-sidePanel\",\n        UPDATES: \"update\",\n        LIVE_PREVIEW: \"live-preview\",\n        KEYBOARD: \"keyboard\",\n        CODE_HINTS: \"code-hints\",\n        EDITOR: \"editor\",\n        QUICK_VIEW: \"quickView\",\n        SEARCH: \"search\",\n        SHARING: \"sharing\",\n        PERFORMANCE: \"performance\",\n        STORAGE: \"storage\",\n        NEW_PROJECT: \"new-project\",\n        ERROR: \"error\",\n        USER: \"user\",\n        NODEJS: \"node\",\n        LINT: \"lint\",\n        GIT: \"git\"\n    };\n\n    /**\n     * This is so that phoenix can starting as soon as the shims are inited. The events logged before init() will be\n     * placed into a holding queue by ga and core analytics. When the lib is loaded and inited,\n     * the events will be processed without any loss.\n     * @private\n     */\n    function _createAnalyticsShims() {\n        // for core analytics\n        if(!window.analytics){ window.analytics = {\n            _initData: [], loadStartTime: new Date().getTime(),\n            event: function (){window.analytics._initData.push(arguments);}\n        };}\n        // for google analytics\n        if(!Phoenix.isNativeApp) {\n            // ga is not inpage in tauri builds. see below explanation in _initGoogleAnalytics\n            window.dataLayer = window.dataLayer || [];\n            window.gtag = function(){\n                window.dataLayer.push(arguments);\n                if(window.dataLayer.length > 500){\n                    window.dataLayer.splice(0, 250); // remove half the elements(offline queue guard)\n                }\n            };\n        }\n    }\n\n    _createAnalyticsShims();\n\n    const MINUTES_10 = 10*1000;\n    let tauriGaErrorCountSent = 0, sendOnceMore = false, noFurtherReporting = false;\n    function _sendTauriGAEvent(analyticsID, customUserID, events=[]) {\n        window.__TAURI__.event.emit(\"health\", {\n            analyticsID: analyticsID,\n            customUserID: customUserID,\n            events\n        }).catch(err=>{\n            if(window.debugMode){\n                console.error(err);\n            }\n            if(noFurtherReporting){\n                return;\n            }\n            // we only report 1 error once to prevent too many Bugsnag reports. We seen in bugsnag that like 2-3\n            // users triggers thousands of this error in bugsnag report per day as they send continuous error reports\n            // every minute due to this error. We throttle to send only 2 errors to bugsnag any minute at app level,\n            // so this will starve other genuine errors as well if not captured here.\n            tauriGaErrorCountSent ++;\n            if(sendOnceMore){\n                // we send the crash stack once and then another report 10 minutes later. After that, this is likeley\n                // to fail always.\n                noFurtherReporting = true;\n                logger.reportError(err,\n                    `${tauriGaErrorCountSent} _sendTauriGAEvent failures in ${MINUTES_10/1000} minutes`);\n            }\n            if(tauriGaErrorCountSent !== 1){\n                return;\n            }\n            logger.reportError(err);\n            setTimeout(()=>{\n                sendOnceMore = true;\n            }, MINUTES_10);\n        });\n    }\n\n    let tauriGAEvents = new Map();\n\n    function _sendGaEvent(eventAct, category, label, count) {\n        if(Phoenix.isNativeApp) {\n            const key = `${eventAct}:${category}:${label}}`;\n            const existingEvent = tauriGAEvents.get(key);\n            if(existingEvent) {\n                existingEvent.count = (existingEvent.count||0) + count;\n                return;\n            }\n            tauriGAEvents.set(key, {eventAct, category, label, count});\n            return;\n        }\n        gtag('event', eventAct, {\n            'event_category': category,\n            'event_label': label,\n            'value': count\n        });\n    }\n\n    const TAURI_GA_EVENT_QUEUE_INTERVAL = 3000;\n    function _sendQueuedTauriGAEvents() {\n        _sendTauriGAEvent(brackets.config.googleAnalyticsIDDesktop, userID, Array.from(tauriGAEvents.values()));\n        tauriGAEvents.clear();\n    }\n\n    function _initGoogleAnalytics() {\n        // Load google analytics scripts\n        if(Phoenix.isNativeApp) {\n            // in tauri google analytics is in a hidden window instead of current page as ga only supports http and\n            // https urls and not the tauri custom protocol urls. So we have a hidden window that loads ga from a\n            // http(s) page which is usually `https://phcode.dev/desktop-metrics.html` or\n            // \"http://localhost:8000/src/metrics.html\" for live dev builds in tauri.\n            _sendTauriGAEvent(brackets.config.googleAnalyticsIDDesktop, userID);\n            setInterval(_sendQueuedTauriGAEvents, TAURI_GA_EVENT_QUEUE_INTERVAL);\n            return;\n        }\n        let script = document.createElement('script');\n        script.type = 'text/javascript';\n        script.async = true;\n        script.onload = function(){\n            gtag('js', new Date());\n\n            // TODO use googleAnalyticsIDDesktop for desktop analytics\n            gtag('config', brackets.config.googleAnalyticsID, {\n                'page_title': 'Phoenix editor',\n                'page_path': '/index.html',\n                'page_location': window.location.origin\n            });\n        };\n        script.src = 'https://www.googletagmanager.com/gtag/js?' + brackets.config.googleAnalyticsID;\n        document.getElementsByTagName('head')[0].appendChild(script);\n    }\n\n    function _initCoreAnalytics() {\n        // Load core analytics scripts\n        let script = document.createElement('script');\n        script.type = 'text/javascript';\n        script.async = true;\n        window.analytics.debugMode = window.debugMode;\n        script.onload = function(){\n            // replace `your_analytics_account_ID` and `appName` below with your values\n            const appName = Phoenix.isNativeApp ?\n                brackets.config.coreAnalyticsAppNameDesktop:\n                brackets.config.coreAnalyticsAppName;\n            window.initAnalyticsSession( brackets.config.coreAnalyticsID, appName);\n            window.analytics.event(\"core-analytics\", \"client-lib\", \"loadTime\", 1,\n                (new Date().getTime())- window.analytics.loadStartTime);\n        };\n        script.src = 'https://unpkg.com/@aicore/core-analytics-client-lib/dist/analytics.min.js';\n        document.getElementsByTagName('head')[0].appendChild(script);\n    }\n\n    /**\n     * We are transitioning to our own analytics instead of google as we breached the free user threshold of google\n     * and paid plans for GA starts at 100,000 USD.\n     * @private\n     */\n    function init(initOptions = {}){\n        if(initDone || window.testEnvironment){\n            return;\n        }\n        _initGoogleAnalytics();\n        _initCoreAnalytics();\n        initDone = true;\n        if (initOptions.isPowerUserFn) {\n            isPowerUserFn = initOptions.isPowerUserFn;\n            cachedIsPowerUser = isPowerUserFn();  // only call once to avoid heavy computations repeatedly\n            setInterval(()=>{\n                cachedIsPowerUser = isPowerUserFn();\n            }, ONE_DAY);\n        }\n    }\n\n    // some events generate too many ga events that ga can't handle. ignore them.\n    const ignoredGAEvents = ['instantSearch'];\n    function _sendToGoogleAnalytics(category, action, label, count) {\n        // https://developers.google.com/analytics/devguides/collection/analyticsjs/events\n        // TODO, see if we are sending too many events to ga, unlike core analytics, GA has a limit of\n        //  1 Million events per month for free plan.\n        if(disabled || window.testEnvironment){\n            return;\n        }\n        category = category || \"category\";\n        action = action || \"action\";\n        if(!label){\n            label = action;\n        }\n        if(!count){\n            count = 1;\n        }\n        let eventAct = `${category}.${action}.${label}`;\n        if(ignoredGAEvents.includes(action)){\n            return;\n        }\n        _sendGaEvent(eventAct, category, label, count);\n    }\n\n    function _sendToCoreAnalytics(category, action, label, count, value) {\n        // https://developers.google.com/analytics/devguides/collection/analyticsjs/events\n        if(disabled || window.testEnvironment){\n            return;\n        }\n        category = category || \"category\";\n        action = action || \"action\";\n        if(!label){\n            label = action;\n        }\n        if(!value){\n            value = 1;\n        }\n        analytics.event(category, action, label, count, value);\n    }\n\n    const AUDIT_TYPE_COUNT = \"count\",\n        AUDIT_TYPE_VALUE = \"val\";\n    function _logEventForAudit(eventType, eventCategory, eventSubCategory, val, type) {\n        let defaultVal = {\n            eventType: type,\n            sum: 0,\n            count: 0\n        };\n        let key = `${eventType}.${eventCategory}.${eventSubCategory}`;\n        let newVal = loggedDataForAudit.get(key) || defaultVal;\n        newVal.count = newVal.count + 1;\n        newVal.sum = newVal.sum + val;\n        loggedDataForAudit.set(key, newVal);\n        if(loggedDataForAudit.size >= MAX_AUDIT_ENTRIES){\n            const NUM_ENTRIES_TO_DELETE = 1000;\n            let keys = Array.from(loggedDataForAudit.keys()).slice(0, NUM_ENTRIES_TO_DELETE);\n            keys.forEach(k => loggedDataForAudit.delete(k));\n        }\n    }\n\n    function _countEvent(eventType, eventCategory, eventSubCategory, count= 1) {\n        _logEventForAudit(eventType, eventCategory, eventSubCategory, count, AUDIT_TYPE_COUNT);\n        _sendToGoogleAnalytics(eventType, eventCategory, eventSubCategory, count);\n        _sendToCoreAnalytics(eventType, eventCategory, eventSubCategory, count);\n    }\n\n    /**\n     * log a numeric count >=0\n     * To log that user clicked searchButton 5 times:\n     * Metrics.countEvent(Metrics.EVENT_TYPE.UI, \"searchButton\", \"click\");\n     * Metrics.countEvent(Metrics.EVENT_TYPE.UI, \"searchButton\", \"click\", 5);\n     *\n     * @param {EVENT_TYPE|string} eventType The kind of Event Type that needs to be logged- should be a js var compatible string.\n     * Some standard event types are available as `EVENT_TYPE`.\n     * @param {string} eventCategory The kind of Event Category that\n     * needs to be logged- should be a js var compatible string\n     * @param {string} eventSubCategory The kind of Event Sub Category that\n     * needs to be logged- should be a js var compatible string\n     * @param {number} [count=1] >=0 , optional, if not set defaults to 1\n     * @type {function}\n     */\n    function countEvent(eventType, eventCategory, eventSubCategory, count= 1) {\n        if(cachedIsPowerUser){\n            // emit power user metrics too\n            _countEvent(`P-${eventType}`, eventCategory, eventSubCategory, count);\n        } else if(!isFirstUseDay){\n            // emit repeat user metrics too\n            _countEvent(`R-${eventType}`, eventCategory, eventSubCategory, count);\n        }\n        _countEvent(eventType, eventCategory, eventSubCategory, count);\n    }\n\n    function _valueEvent(eventType, eventCategory, eventSubCategory, value) {\n        _logEventForAudit(eventType, eventCategory, eventSubCategory, value, AUDIT_TYPE_VALUE);\n        _sendToGoogleAnalytics(eventType, eventCategory, eventSubCategory, value);\n        _sendToCoreAnalytics(eventType, eventCategory, eventSubCategory, 1, value);\n    }\n\n    /**\n     * log a numeric value (number).\n     * To log that startup time is 200ms:\n     * Metrics.valueEvent(Metrics.EVENT_TYPE.PERFORMANCE, \"startupTime\", \"ms\", 200);\n     *\n     * @param {EVENT_TYPE|string} eventType The kind of Event Type that needs to be logged- should be a js var compatible string.\n     * some standard event types are available as `EVENT_TYPE`.\n     * @param {string} eventCategory The kind of Event Category that\n     * needs to be logged- should be a js var compatible string\n     * @param {string} eventSubCategory The kind of Event Sub Category that\n     * needs to be logged- should be a js var compatible string\n     * @param {number} value\n     * @type {function}\n     */\n    function valueEvent(eventType, eventCategory, eventSubCategory, value) {\n        if(cachedIsPowerUser){\n            // emit power user metrics too\n            _valueEvent(`P-${eventType}`, eventCategory, eventSubCategory, value);\n        } else if(!isFirstUseDay){\n            // emit repeat user metrics too\n            _valueEvent(`R-${eventType}`, eventCategory, eventSubCategory, value);\n        }\n        _valueEvent(eventType, eventCategory, eventSubCategory, value);\n    }\n\n    function setDisabled(shouldDisable) {\n        disabled = shouldDisable;\n    }\n\n    function isDisabled() {\n        return disabled;\n    }\n\n    function getLoggedDataForAudit() {\n        return loggedDataForAudit;\n    }\n\n    function clearAuditData() {\n        loggedDataForAudit.clear();\n    }\n\n    /**\n     * Send all pending metrics, useful before app quit.\n     * Will never throw Error.\n     */\n    async function flushMetrics() {\n        try{\n            if(Phoenix.isNativeApp) {\n                _sendQueuedTauriGAEvents();\n            }\n        } catch (e) {\n            console.error(\"Error while flushMetrics: \", e);\n        }\n    }\n\n    /**\n     * Logs the performance time taken for a specific action.\n     *\n     * @param {string} action - The key representing the action being measured (e.g., 'startupTime').\n     * @param {number} durationMs - The duration of the action in milliseconds.\n     */\n    function logPerformanceTime(action, durationMs) {\n        valueEvent(EVENT_TYPE.PERFORMANCE, \"ms\", action, Number(durationMs));\n    }\n\n    /**\n     * Get the range name for a given number.\n     *\n     * The function returns the first range that the number fits into, based on predefined ranges:\n     * 0, 10, 25, 50, 100, 250, 500, 1000, 5000, 10000, and \"10000+\" for numbers exceeding 10000.\n     *\n     * @param {number} number - The number to determine the range for.\n     * @returns {string} The range name that the number belongs to.\n     */\n    function getRangeName(number) {\n        // Define the ranges\n        const ranges = [0, 5, 10, 25, 50, 100, 250, 500, 1000, 5000, 10000];\n\n        // Iterate through the ranges and return the first range that is greater than or equal to the number\n        // small array, linear scan is most efficient than binary search in most cases comparing the overheads and\n        // maintainability\n        for (let i = 0; i < ranges.length; i++) {\n            if (number <= ranges[i]) {\n                return \"\"+ranges[i];\n            }\n        }\n\n        // If the number exceeds the largest range, return \"10000+\"\n        return \"10000+\";\n    }\n\n    /**\n     * A power user is someone who has used Phoenix at least 3 days or 8 hours in the last two weeks\n     * @returns {boolean}\n     */\n    function isPowerUser() {\n        if(!isPowerUserFn) {\n            throw new Error(\"PowerUser fn is not initialized in Metrics.\");\n        }\n        return isPowerUserFn();\n    }\n\n    // Define public API\n    exports.init               = init;\n    exports.setDisabled        = setDisabled;\n    exports.isDisabled         = isDisabled;\n    exports.getLoggedDataForAudit      = getLoggedDataForAudit;\n    exports.clearAuditData     = clearAuditData;\n    exports.countEvent         = countEvent;\n    exports.valueEvent         = valueEvent;\n    exports.logPerformanceTime = logPerformanceTime;\n    exports.flushMetrics       = flushMetrics;\n    exports.getRangeName       = getRangeName;\n    exports.isPowerUser        = isPowerUser;\n    exports.EVENT_TYPE = EVENT_TYPE;\n    exports.AUDIT_TYPE_COUNT = AUDIT_TYPE_COUNT;\n    exports.AUDIT_TYPE_VALUE = AUDIT_TYPE_VALUE;\n});\n"],"file":"Metrics.js"}