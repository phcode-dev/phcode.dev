{"version":3,"sources":["utils/NodeUtils.js"],"names":["define","require","exports","module","Strings","NodeConnector","UTILS_NODE_CONNECTOR","utilsConnector","async","fetchURLText","url","encoding","Phoenix","isNativeApp","Error","buffer","execPeer","iconv","decode","Buffer","from","_updateNodeLocaleStrings","getPhoenixBinaryVersion","cliArgs","window","__TAURI__","invoke","phoenixBinPath","getLinuxOSFlavorName","platform","openUrlInBrowser","browserName","app","_openUrlInBrowserWin","_loadNodeExtensionModule","moduleNativeDir","_npmInstallInFolder","getEnvironmentVariable","varName","ESLintFile","text","fullFilePath","projectFullPath","fs","getTauriPlatformPath","openNativeTerminal","cwd","usePowerShell","openInDefaultApp","fullPath","createNodeConnector","cachedDeviceID","undefined","_systemSettingsDir","getDeviceID","err","logger","reportError","addDeviceLicenseSystemWide","removeDeviceLicenseSystemWide","isLicensedDeviceSystemWide","console","error","getOSUserName","getSystemSettingsDir","isNodeAvailable","isTestWindow","_setIsTestWindowGitHubActions","actionsEnv","isTestWindowGitHubActions","catch","e","urlSearchParams","URLSearchParams","location","search","get","isNodeReady","NodeUtils"],"mappings":"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","sourcesContent":["/*\n * GNU AGPL-3.0 License\n *\n * Copyright (c) 2021 - present core.ai . All rights reserved.\n * Original work Copyright (c) 2012 - 2021 Adobe Systems Incorporated. All rights reserved.\n *\n * This program is free software: you can redistribute it and/or modify it\n * under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT\n * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License\n * for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see https://opensource.org/licenses/AGPL-3.0.\n *\n */\n\n// @INCLUDE_IN_API_DOCS\n\n/*global logger*/\n\n/**\n * Generic node util APIs connector. see `src-node/utils.js` for node peer\n */\n\ndefine(function (require, exports, module) {\n    const Strings             = require(\"strings\"),\n        NodeConnector = require('NodeConnector');\n    const UTILS_NODE_CONNECTOR = \"ph_utils\";\n\n    let utilsConnector;\n    if(Phoenix.isNativeApp) {\n        // node not available in browser builds!\n        utilsConnector = NodeConnector.createNodeConnector(UTILS_NODE_CONNECTOR, exports);\n    }\n\n    /**\n     * Fetches text content from a URL\n     * This is only available in the native app\n     *\n     * @param {string} url\n     * @param {string} encoding\n     * @return {Promise<string>}\n     */\n    async function fetchURLText(url, encoding) {\n        if(!Phoenix.isNativeApp) {\n            throw new Error(\"node not available in browser\");\n        }\n        const {buffer} = await utilsConnector.execPeer(\"getURLContent\", {url});\n        return iconv.decode(Buffer.from(buffer), encoding);\n    }\n\n    /**\n     * updates the localized strings in brackets `Strings` to node.\n     *\n     * @private\n     * @return {Promise<boolean>} Promise resolves to true if strings was updated in node, else false(in browser.)\n     */\n    async function _updateNodeLocaleStrings() {\n        if(!Phoenix.isNativeApp) {\n            // this does nothing in browser builds.\n            return false;\n        }\n        await utilsConnector.execPeer(\"setLocaleStrings\", Strings);\n        return true;\n    }\n\n    /**\n     * Gets the version of the Phoenix binary\n     * This is only available in the native app\n     *\n     * @return {Promise<string>}\n     */\n    async function getPhoenixBinaryVersion() {\n        if(!Phoenix.isNativeApp) {\n            throw new Error(\"getPhoenixBinaryVersion not available in browser\");\n        }\n        const cliArgs = await window.__TAURI__.invoke('_get_commandline_args');\n        const phoenixBinPath = cliArgs[0];\n        return utilsConnector.execPeer(\"getPhoenixBinaryVersion\", phoenixBinPath);\n    }\n\n    /**\n     * Retrieves the Linux OS flavor name\n     * This is only available in the native app on Linux\n     *\n     * @return {Promise<string|null>}\n     */\n    async function getLinuxOSFlavorName() {\n        if(Phoenix.platform !== \"linux\" || !Phoenix.isNativeApp) {\n            return null;\n        }\n        return utilsConnector.execPeer(\"getLinuxOSFlavorName\");\n    }\n\n    /**\n     * Opens a URL in the default browser.\n     * This is only available in the native app.\n     *\n     * @param {string} url\n     * @param {string} browserName\n     */\n    async function openUrlInBrowser(url, browserName) {\n        if(!Phoenix.isNativeApp) {\n            throw new Error(\"openUrlInBrowser not available in browser\");\n        }\n        if(Phoenix.platform === \"win\") {\n            return Phoenix.app._openUrlInBrowserWin(url, browserName);\n        }\n        return utilsConnector.execPeer(\"openUrlInBrowser\", {url, browserName});\n    }\n\n    async function _loadNodeExtensionModule(moduleNativeDir) {\n        if(!Phoenix.isNativeApp) {\n            throw new Error(\"_loadNodeExtensionModule not available in browser\");\n        }\n        return utilsConnector.execPeer(\"_loadNodeExtensionModule\", {moduleNativeDir});\n    }\n\n    async function _npmInstallInFolder(moduleNativeDir) {\n        if(!Phoenix.isNativeApp) {\n            throw new Error(\"_npmInstallInFolder not available in browser\");\n        }\n        return utilsConnector.execPeer(\"_npmInstallInFolder\", {moduleNativeDir});\n    }\n\n    /**\n     * Gets an environment variable's value\n     * This is only available in the native app\n     *\n     * @param {string} varName\n     * @return {Promise<string>}\n     */\n    async function getEnvironmentVariable(varName) {\n        if(!Phoenix.isNativeApp) {\n            throw new Error(\"getEnvironmentVariable not available in browser\");\n        }\n        return utilsConnector.execPeer(\"getEnvironmentVariable\", varName);\n    }\n\n    /**\n     * Runs ESLint on a file\n     * This is only available in the native app\n     *\n     * @param {string} text\n     * @param {string} fullFilePath\n     * @param {string} projectFullPath\n     */\n    async function ESLintFile(text, fullFilePath, projectFullPath) {\n        if(!Phoenix.isNativeApp) {\n            throw new Error(\"ESLintFile not available in browser\");\n        }\n        return utilsConnector.execPeer(\"ESLintFile\", {\n            text,\n            fullFilePath: window.fs.getTauriPlatformPath(fullFilePath),\n            projectFullPath: window.fs.getTauriPlatformPath(projectFullPath)\n        });\n    }\n\n    /**\n     * Runs ESLint on a file\n     * This is only available in the native app\n     *\n     * @param {string} cwd the working directory of terminal\n     * @param {boolean} [usePowerShell]\n     */\n    async function openNativeTerminal(cwd, usePowerShell = false) {\n        if(!Phoenix.isNativeApp) {\n            throw new Error(\"openNativeTerminal not available in browser\");\n        }\n        return utilsConnector.execPeer(\"openNativeTerminal\", {\n            cwd: window.fs.getTauriPlatformPath(cwd),\n            usePowerShell\n        });\n    }\n\n    /**\n     * Opens a file in the default application for its type on Windows, macOS, and Linux.\n     *\n     * @param {string} fullPath - The path to the file/folder to open.\n     * @returns {Promise<void>} - Resolves if the file/folder is opened successfully, rejects otherwise.\n     */\n    async function openInDefaultApp(fullPath) {\n        if(!Phoenix.isNativeApp) {\n            throw new Error(\"openInDefaultApp not available in browser\");\n        }\n        return utilsConnector.execPeer(\"openInDefaultApp\", window.fs.getTauriPlatformPath(fullPath));\n    }\n\n\n    let cachedDeviceID = undefined;\n    /**\n     * gets the os device id. this usually won't change till os reinstall.\n     *\n     * @returns {Promise<string|null>} - Resolves with the os identifier or null\n     * @throws {Error} - If called from the browser\n     */\n    async function getDeviceID() {\n        if (!Phoenix.isNativeApp) {\n            throw new Error(\"getDeviceID not available in browser\");\n        }\n        if(cachedDeviceID !== undefined) {\n            return cachedDeviceID;\n        }\n        try {\n            cachedDeviceID = await utilsConnector.execPeer(\"getDeviceID\");\n            return cachedDeviceID;\n        } catch (err) {\n            cachedDeviceID = null;\n            logger.reportError(err, \"getDeviceID failed in NodeUtils\");\n        }\n        return cachedDeviceID;\n    }\n\n    /**\n     * Enables device license by creating a system-wide license file.\n     * On Windows, macOS, and Linux this will request elevation if needed.\n     *\n     * @returns {Promise<boolean>} - Resolves true if system wide defile file added, else false.\n     * @throws {Error} - If called from the browser\n     */\n    async function addDeviceLicenseSystemWide() {\n        if (!Phoenix.isNativeApp) {\n            throw new Error(\"addDeviceLicense not available in browser\");\n        }\n        try {\n            await utilsConnector.execPeer(\"addDeviceLicense\");\n            return true;\n        } catch (err) {\n            logger.reportError(err, \"system wide device license activation failed\");\n        }\n        return false;\n    }\n\n    /**\n     * Removes the system-wide device license file.\n     * On Windows, macOS, and Linux this will request elevation if needed.\n     *\n     * @returns {Promise<boolean>} - Resolves true if system wide defile file removed, else false.\n     * @throws {Error} - If called from the browser\n     */\n    async function removeDeviceLicenseSystemWide() {\n        if (!Phoenix.isNativeApp) {\n            throw new Error(\"removeDeviceLicense not available in browser\");\n        }\n        try {\n            await utilsConnector.execPeer(\"removeDeviceLicense\");\n            return true;\n        } catch (err) {\n            logger.reportError(err, \"system wide device license remove failed\");\n        }\n        return false;\n    }\n\n    /**\n     * Checks if the current machine is configured to check for system-wide device license for all users at app start.\n     * This validates that the system-wide license file exists, contains valid JSON, and has `licensedDevice: true`.\n     *\n     * @returns {Promise<boolean>} - Resolves with `true` if the device is licensed, `false` otherwise.\n     */\n    async function isLicensedDeviceSystemWide() {\n        if (!Phoenix.isNativeApp) {\n            console.error(\"isLicensedDevice not available in browser\");\n            return false;\n        }\n        try {\n            return utilsConnector.execPeer(\"isLicensedDevice\");\n        } catch (err) {\n            logger.reportError(err, \"system wide device check failed\");\n        }\n        return false;\n    }\n\n    /**\n     * Retrieves the operating system username of the current user.\n     * This method is only available in native apps.\n     *\n     * @throws {Error} Throws an error if called in a browser environment.\n     * @return {Promise<string>} A promise that resolves to the OS username of the current user.\n     */\n    async function getOSUserName() {\n        if (!Phoenix.isNativeApp) {\n            throw new Error(\"getOSUserName not available in browser\");\n        }\n        return utilsConnector.execPeer(\"getOSUserName\");\n    }\n\n    let _systemSettingsDir;\n    /**\n     * Retrieves the directory path for system settings. This method is applicable to native apps only.\n     *\n     * @return {Promise<string>} A promise that resolves to the path of the system settings directory.\n     * @throws {Error} If the method is called in browser app.\n     */\n    async function getSystemSettingsDir() {\n        if (!Phoenix.isNativeApp) {\n            throw new Error(\"getSystemSettingsDir is sudo folder is win/linux/mac. not available in browser.\");\n        }\n        if(!_systemSettingsDir){\n            _systemSettingsDir = await utilsConnector.execPeer(\"getSystemSettingsDir\");\n        }\n        return _systemSettingsDir;\n    }\n\n    if(NodeConnector.isNodeAvailable()) {\n        // todo we need to update the strings if a user extension adds its translations. Since we dont support\n        // node extensions for now, should consider when we support node extensions.\n        _updateNodeLocaleStrings();\n    }\n\n    try {\n        if(Phoenix.isTestWindow) {\n            if(Phoenix.isNativeApp) {\n                async function _setIsTestWindowGitHubActions() {\n                    const actionsEnv = await utilsConnector.execPeer(\"getEnvironmentVariable\", \"GITHUB_ACTIONS\");\n                    Phoenix.isTestWindowGitHubActions = !!actionsEnv;\n                }\n                _setIsTestWindowGitHubActions().catch(e=>{\n                    console.error(\"Error setting Phoenix.isTestWindowGitHubActions\", e);\n                });\n            } else {\n                const urlSearchParams = new window.URLSearchParams(window.location.search || \"\");\n                Phoenix.isTestWindowGitHubActions = urlSearchParams.get(\"isTestWindowGitHubActions\") === \"yes\";\n            }\n        }\n    } catch (e) {\n        console.error(\"Error setting Phoenix.isTestWindowGitHubActions\", e);\n    }\n\n    // private apis\n    exports._loadNodeExtensionModule = _loadNodeExtensionModule;\n    exports._npmInstallInFolder = _npmInstallInFolder;\n\n    // public apis\n    exports.fetchURLText = fetchURLText;\n    exports.getPhoenixBinaryVersion = getPhoenixBinaryVersion;\n    exports.getLinuxOSFlavorName = getLinuxOSFlavorName;\n    exports.openUrlInBrowser = openUrlInBrowser;\n    exports.ESLintFile = ESLintFile;\n    exports.getEnvironmentVariable = getEnvironmentVariable;\n    exports.openNativeTerminal = openNativeTerminal;\n    exports.openInDefaultApp = openInDefaultApp;\n    exports.addDeviceLicenseSystemWide = addDeviceLicenseSystemWide;\n    exports.removeDeviceLicenseSystemWide = removeDeviceLicenseSystemWide;\n    exports.isLicensedDeviceSystemWide = isLicensedDeviceSystemWide;\n    exports.getDeviceID = getDeviceID;\n    exports.getOSUserName = getOSUserName;\n    exports.getSystemSettingsDir = getSystemSettingsDir;\n\n    /**\n     * checks if Node connector is ready\n     *\n     * @return {boolean} returns true if it's ready, otherwise false\n     */\n    exports.isNodeReady = NodeConnector.isNodeReady;\n\n    window.NodeUtils = exports;\n});\n"],"file":"NodeUtils.js"}