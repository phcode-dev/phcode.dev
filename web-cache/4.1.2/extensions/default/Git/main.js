define(function(require,exports,module){const _=brackets.getModule("thirdparty/lodash"),AppInit=brackets.getModule("utils/AppInit"),ExtensionUtils=brackets.getModule("utils/ExtensionUtils");require("src/SettingsDialog");const EventEmitter=require("src/EventEmitter"),Events=require("src/Events"),Main=require("src/Main"),Preferences=require("src/Preferences"),Git=require("src/git/Git"),BracketsEvents=require("src/BracketsEvents");var modules;if(require(["src/GutterManager","src/History","src/NoRepo","src/ProjectTreeMarks","src/Remotes","src/TabBarIntegration"]),"dev"===Phoenix.config.environment?ExtensionUtils.loadStyleSheet(module,"styles/git-styles.less"):ExtensionUtils.loadStyleSheet(module,"styles/git-styles-min.css"),AppInit.appReady(function(){Main.init().then(enabled=>{enabled||BracketsEvents.disableAll()})}),"object"==typeof window){const TabBarIntegration=require("src/TabBarIntegration");window.phoenixGitEvents={EventEmitter:EventEmitter,Events:Events,Git:Git,TabBarIntegration:TabBarIntegration}}}),define("src/BracketsEvents",function(require,exports,module){const _=brackets.getModule("thirdparty/lodash"),DocumentManager=brackets.getModule("document/DocumentManager"),FileSystem=brackets.getModule("filesystem/FileSystem"),ProjectManager=brackets.getModule("project/ProjectManager"),MainViewManager=brackets.getModule("view/MainViewManager"),Events=require("src/Events"),EventEmitter=require("src/EventEmitter"),HistoryViewer=require("src/HistoryViewer"),Preferences=require("src/Preferences"),Utils=require("src/Utils"),watchedInsideGit=["HEAD"],GIT_EVENTS="gitEvents";function disableAll(){FileSystem.off(`change.${GIT_EVENTS}`),DocumentManager.off(`documentSaved.${GIT_EVENTS}`),MainViewManager.off(`currentFileChange.${GIT_EVENTS}`),ProjectManager.off(`projectOpen.${GIT_EVENTS}`),ProjectManager.off(`projectRefresh.${GIT_EVENTS}`),ProjectManager.off(`beforeProjectClose.${GIT_EVENTS}`)}FileSystem.on(`change.${GIT_EVENTS}`,function(evt,file){var currentGitRoot=Preferences.get("currentGitRoot");if(file&&0===file.fullPath.indexOf(currentGitRoot)){var whitelisted;if(0===file.fullPath.indexOf(currentGitRoot+".git/"))if(!_.any(watchedInsideGit,function(entry){return file.fullPath===currentGitRoot+".git/"+entry}))return void Utils.consoleDebug("Ignored FileSystem.change event: "+file.fullPath);EventEmitter.emit(Events.BRACKETS_FILE_CHANGED,file)}}),DocumentManager.on(`documentSaved.${GIT_EVENTS}`,function(evt,doc){0===doc.file.fullPath.indexOf(Preferences.get("currentGitRoot"))&&EventEmitter.emit(Events.BRACKETS_DOCUMENT_SAVED,doc)}),MainViewManager.on(`currentFileChange.${GIT_EVENTS}`,function(evt,currentDocument,previousDocument){currentDocument=currentDocument||DocumentManager.getCurrentDocument(),HistoryViewer.isVisible()?HistoryViewer.hide():EventEmitter.emit(Events.BRACKETS_CURRENT_DOCUMENT_CHANGE,currentDocument,previousDocument)}),ProjectManager.on(`projectOpen.${GIT_EVENTS}`,function(){EventEmitter.emit(Events.BRACKETS_PROJECT_CHANGE)}),ProjectManager.on(`projectRefresh.${GIT_EVENTS}`,function(){EventEmitter.emit(Events.BRACKETS_PROJECT_REFRESH)}),ProjectManager.on(`beforeProjectClose.${GIT_EVENTS}`,function(){EventEmitter.emit(Events.GIT_DISABLED)}),exports.disableAll=disableAll}),define("src/Branch",function(require,exports){var _=brackets.getModule("thirdparty/lodash"),CommandManager=brackets.getModule("command/CommandManager"),Dialogs=brackets.getModule("widgets/Dialogs"),EditorManager=brackets.getModule("editor/EditorManager"),FileSyncManager=brackets.getModule("project/FileSyncManager"),FileSystem=brackets.getModule("filesystem/FileSystem"),Menus=brackets.getModule("command/Menus"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),PopUpManager=brackets.getModule("widgets/PopUpManager"),StringUtils=brackets.getModule("utils/StringUtils"),DocumentManager=brackets.getModule("document/DocumentManager"),Strings=brackets.getModule("strings"),Metrics=brackets.getModule("utils/Metrics"),MainViewManager=brackets.getModule("view/MainViewManager"),Git=require("src/git/Git"),Events=require("src/Events"),EventEmitter=require("src/EventEmitter"),ErrorHandler=require("src/ErrorHandler"),Panel=require("src/Panel"),Setup=require("src/utils/Setup"),Preferences=require("src/Preferences"),ProgressDialog=require("src/dialogs/Progress"),Utils=require("src/Utils"),branchesMenuTemplate='<ul id="git-branch-dropdown" class="dropdown-menu" tabindex="-1">\n    <li>\n        <a class="git-branch-new">\n            <span>{{Strings.CREATE_NEW_BRANCH}}</span>\n        </a>\n    </li>\n\n    {{#branchList.length}}\n    <li class="divider"></li>\n    {{/branchList.length}}\n\n    {{#branchList}}\n    <li>\n        <a class="git-branch-link" data-branch="{{name}}">\n            {{#canDelete}}\n            <span class="trash-icon">&times;</span>\n            {{/canDelete}}\n            <span class="merge-branch"><i title="{{Strings.MERGE_BRANCH}}" class="octicon octicon-git-merge"></i></span>\n            <span class="switch-branch">{{name}}</span>\n        </a>\n    </li>\n    {{/branchList}}\n</ul>\n',newBranchTemplate='<div class="modal git">\n    <div class="modal-header">\n        <h1 class="dialog-title">{{Strings.CREATE_NEW_BRANCH_TITLE}}</h1>\n    </div>\n    <div class="modal-body tab-content">\n\n        <form>\n            <div>\n                <label>{{Strings.ORIGIN_BRANCH}}:</label>\n                <div>\n                    <div class="input-append">\n                        <select class="branchSelect" name="branch-origin"></select>\n                        <button class="btn fetchBranches" type="button">\n                            <i class="octicon octicon-sync"></i>\n                        </button>\n                    </div>\n                </div>\n            </div>\n            <div>\n                <label>{{Strings.BRANCH_NAME}}:</label>\n                <div>\n                    <input name="branch-name" type="text" autocomplete="off" spellcheck="false" />\n                </div>\n            </div>\n        </form>\n\n    </div>\n    <div class="modal-footer">\n        <button data-button-id="cancel" class="dialog-button btn cancel" >{{Strings.BUTTON_CANCEL}}</button>\n        <button data-button-id="ok"     class="dialog-button btn primary">{{Strings.BUTTON_OK}}</button>\n    </div>\n</div>\n',mergeBranchTemplate='<div class="modal git">\n    <div class="modal-header">\n        <h1 class="dialog-title">{{Strings.MERGE_BRANCH}} "{{fromBranch}}"</h1>\n    </div>\n    <div class="modal-body tab-content">\n        <form>\n            <div>\n                <label>{{Strings.TARGET_BRANCH}}:</label>\n                <div>\n                    <select disabled name="branch-target">\n                        {{#branches}}\n                        <option value="{{name}}" remote="{{remote}}" {{#currentBranch}}selected{{/currentBranch}}>\n                        {{name}}\n                        </option>\n                        {{/branches}}\n                    </select>\n                </div>\n            </div>\n            <div>\n                <label>{{Strings.MERGE_MESSAGE}}:</label>\n                <div>\n                    <div class="input-append">\n                        <input name="merge-message" type="text" placeholder="default" autocomplete="off">\n                        <button class="btn fill-pr" type="button">PR</button>\n                    </div>\n                </div>\n            </div>\n            <div>\n                <div>\n                    <label>\n                        <input type="checkbox" name="use-rebase"> {{Strings.USE_REBASE}}\n                    </label>\n                </div>\n            </div>\n            <div>\n                <div>\n                    <label>\n                        <input type="checkbox" name="use-noff"> {{Strings.USE_NOFF}}\n                    </label>\n                </div>\n            </div>\n        </form>\n    </div>\n\n    <div class="modal-footer">\n        <button data-button-id="cancel" class="dialog-button btn cancel btn-80" >{{Strings.BUTTON_CANCEL}}</button>\n        <button data-button-id="ok"     class="dialog-button btn primary btn-80">{{Strings.BUTTON_OK}}</button>\n    </div>\n</div>\n',$gitBranchName=$(null),currentEditor,$dropdown;function renderList(branches){branches=branches.map(function(name){return{name:name,currentBranch:0===name.indexOf("* "),canDelete:"master"!==name}});var templateVars={branchList:_.filter(branches,function(o){return!o.currentBranch}),Strings:Strings};return Mustache.render(branchesMenuTemplate,templateVars)}function closeDropdown(){$dropdown&&PopUpManager.removePopUp($dropdown),detachCloseEvents()}function doMerge(fromBranch){Git.getBranches().then(function(branches){var compiledTemplate=Mustache.render(mergeBranchTemplate,{fromBranch:fromBranch,branches:branches,Strings:Strings}),dialog=Dialogs.showModalDialogUsingTemplate(compiledTemplate),$dialog=dialog.getElement();$dialog.find("input").focus();var $toBranch=$dialog.find("[name='branch-target']"),$useRebase=$dialog.find("[name='use-rebase']"),$useNoff=$dialog.find("[name='use-noff']");"master"===fromBranch&&$useRebase.prop("checked",!0),"master"===$toBranch.val()&&$useRebase.prop("checked",!1).prop("disabled",!0);var $mergeMessage=$dialog.find("[name='merge-message']");$mergeMessage.attr("placeholder","Merge branch '"+fromBranch+"'"),$dialog.find(".fill-pr").on("click",function(){var prMsg="Merge pull request #??? from "+fromBranch;$mergeMessage.val(prMsg),$mergeMessage[0].setSelectionRange(prMsg.indexOf("???"),prMsg.indexOf("???")+3)}),$useRebase.on("change",function(){var useRebase=$useRebase.prop("checked");$useNoff.prop("disabled",useRebase),useRebase&&$useNoff.prop("checked",!1)}).trigger("change"),dialog.done(function(buttonId){var useRebase=$useRebase.prop("checked"),useNoff=$useNoff.prop("checked"),mergeMsg=$mergeMessage.val();"ok"===buttonId&&(useRebase?Git.rebaseInit(fromBranch).catch(function(err){throw Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"rebase","fail"),ErrorHandler.showError(err,Strings.ERROR_REBASE_FAILED)}).then(function(stdout){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"rebase","success"),Utils.showOutput(stdout||Strings.GIT_REBASE_SUCCESS,Strings.REBASE_RESULT).finally(function(){EventEmitter.emit(Events.REFRESH_ALL)})}).catch(console.error):Git.mergeBranch(fromBranch,mergeMsg,useNoff).catch(function(err){throw Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"merge","fail"),ErrorHandler.showError(err,Strings.ERROR_MERGE_FAILED)}).then(function(stdout){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"merge","success"),Utils.showOutput(stdout||Strings.GIT_MERGE_SUCCESS,Strings.MERGE_RESULT).finally(function(){EventEmitter.emit(Events.REFRESH_ALL)})}).catch(console.error))})}).catch(err=>{throw console.error("Error Getting branches",err),new Error("Failed to get getBranches while doMerge")})}function _reloadBranchSelect($el,branches){var template="{{#branches}}<option value='{{name}}' remote='{{remote}}' {{#currentBranch}}selected{{/currentBranch}}>{{name}}</option>{{/branches}}",html=Mustache.render(template,{branches:branches});$el.html(html)}function closeNotExistingFiles(oldBranchName,newBranchName){return Git.getDeletedFiles(oldBranchName,newBranchName).then(function(deletedFiles){var gitRoot=Preferences.get("currentGitRoot"),openedFiles=MainViewManager.getWorkingSet(MainViewManager.ALL_PANES);deletedFiles.forEach(function(dFile){var oFile=_.find(openedFiles,function(oFile){return oFile.fullPath===gitRoot+dFile});oFile&&DocumentManager.closeFullEditor(oFile)}),EventEmitter.emit(Events.REFRESH_ALL)}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_GETTING_DELETED_FILES)})}function handleEvents(){$dropdown.on("click","a.git-branch-new",function(e){e.stopPropagation(),closeDropdown(),Git.getAllBranches().catch(function(err){ErrorHandler.showError(err)}).then(function(branches=[]){var compiledTemplate=Mustache.render(newBranchTemplate,{branches:branches,Strings:Strings}),dialog=Dialogs.showModalDialogUsingTemplate(compiledTemplate),$input=dialog.getElement().find("[name='branch-name']"),$select=dialog.getElement().find(".branchSelect");$select.on("change",function(){if(!$input.val()){var $opt=$select.find(":selected"),remote=$opt.attr("remote"),newVal=$opt.val();remote&&(newVal=newVal.substring(remote.length+1),"origin"!==remote&&(newVal=remote+"#"+newVal)),$input.val(newVal)}}),_reloadBranchSelect($select,branches),dialog.getElement().find(".fetchBranches").on("click",function(){var $this=$(this);const tracker=ProgressDialog.newProgressTracker();ProgressDialog.show(Git.fetchAllRemotes(tracker),tracker).then(function(){return Git.getAllBranches().then(function(branches){$this.prop("disabled",!0).attr("title","Already fetched"),_reloadBranchSelect($select,branches)})}).catch(function(err){throw ErrorHandler.showError(err,Strings.ERROR_FETCH_REMOTE_INFO)})}),dialog.getElement().find("input").focus(),dialog.done(function(buttonId){if("ok"===buttonId){var $dialog=dialog.getElement(),branchName=$dialog.find("input[name='branch-name']").val().trim(),$option=$dialog.find("select[name='branch-origin']").children("option:selected"),originName=$option.val(),isRemote,track=!!$option.attr("remote");Git.createBranch(branchName,originName,track).catch(function(err){throw Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"branch","createFail"),ErrorHandler.showError(err,Strings.ERROR_CREATE_BRANCH)}).then(function(){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"branch","create"),EventEmitter.emit(Events.REFRESH_ALL)})}})})}).on("mouseenter","a",function(){$(this).addClass("selected")}).on("mouseleave","a",function(){$(this).removeClass("selected")}).on("click","a.git-branch-link .trash-icon",function(e){e.stopPropagation(),closeDropdown();var branchName=$(this).parent().data("branch");Utils.askQuestion(Strings.DELETE_LOCAL_BRANCH,StringUtils.format(Strings.DELETE_LOCAL_BRANCH_NAME,branchName),{booleanResponse:!0}).then(function(response){if(!0===response)return Git.branchDelete(branchName).catch(function(err){return Utils.showOutput(err,"Branch deletion failed",{question:"Do you wish to force branch deletion?"}).then(function(response){if(!0===response)return Git.forceBranchDelete(branchName).then(function(output){return Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"branch","delete"),Utils.showOutput(output||Strings.GIT_BRANCH_DELETE_SUCCESS)}).catch(function(err){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"branch","deleteFail"),ErrorHandler.showError(err,Strings.ERROR_BRANCH_DELETE_FORCED)})})})}).catch(function(err){ErrorHandler.showError(err)})}).on("click",".merge-branch",function(e){var fromBranch;e.stopPropagation(),closeDropdown(),doMerge($(this).parent().data("branch"))}).on("click","a.git-branch-link",function(e){e.stopPropagation(),closeDropdown();var newBranchName=$(this).data("branch");Git.getCurrentBranchName().then(function(oldBranchName){Git.checkout(newBranchName).then(function(){return Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"branch","switch"),closeNotExistingFiles(oldBranchName,newBranchName)}).catch(function(err){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"branch","switchFail"),ErrorHandler.showError(err,Strings.ERROR_SWITCHING_BRANCHES)})}).catch(function(err){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"branch","switchFail"),ErrorHandler.showError(err,Strings.ERROR_GETTING_CURRENT_BRANCH)})})}function attachCloseEvents(){$("html").on("click",closeDropdown),$("#project-files-container").on("scroll",closeDropdown),$("#titlebar .nav").on("click",closeDropdown),(currentEditor=EditorManager.getCurrentFullEditor())&&currentEditor._codeMirror.on("focus",closeDropdown)}function detachCloseEvents(){$("html").off("click",closeDropdown),$("#project-files-container").off("scroll",closeDropdown),$("#titlebar .nav").off("click",closeDropdown),currentEditor&&currentEditor._codeMirror.off("focus",closeDropdown),$dropdown=null}function toggleDropdown(e){e.stopPropagation(),$dropdown?closeDropdown():(Menus.closeAll(),Git.getBranches().catch(function(err){ErrorHandler.showError(err,Strings.ERROR_GETTING_BRANCH_LIST)}).then(function(branches=[]){branches=branches.reduce(function(arr,branch){return branch.currentBranch||branch.remote||arr.push(branch.name),arr},[]),$dropdown=$(renderList(branches));const $toggle=$("#git-branch-dropdown-toggle"),marginLeft=2*parseInt($toggle.css("margin-left"),10)||0,toggleOffset=$toggle.offset();$dropdown.css({left:toggleOffset.left-marginLeft+3,top:toggleOffset.top+$toggle.outerHeight()-3}).appendTo($("body"));var maxHeight=$dropdown.parent().height(),height,topOffset;$dropdown.height()+$dropdown.position().top>=maxHeight-10&&$dropdown.css("bottom","10px"),PopUpManager.addPopUp($dropdown,detachCloseEvents,!0,{closeCurrentPopups:!0}),PopUpManager.handleSelectionEvents($dropdown,{enableSearchFilter:!0}),attachCloseEvents(),handleEvents()}))}function _getHeadFilePath(){return Preferences.get("currentGitRoot")+".git/HEAD"}function addHeadToTheFileIndex(){FileSystem.resolve(_getHeadFilePath(),function(err){err&&ErrorHandler.logError(err,"Resolving .git/HEAD file failed")})}function checkBranch(){FileSystem.getFileForPath(_getHeadFilePath()).read(function(err,contents){if(err)ErrorHandler.showError(err,Strings.ERROR_READING_GIT_HEAD);else{var m=(contents=contents.trim()).match(/^ref:\s+refs\/heads\/(\S+)/),branchInHead,branchInUi;if(m||(m=contents.match(/^([a-f0-9]{40})$/)),m)m[1]!==$gitBranchName.text()&&refresh();else ErrorHandler.showError(new Error(StringUtils.format(Strings.ERROR_PARSING_BRANCH_NAME,contents)))}})}function refresh(){if(0!==$gitBranchName.length)return $gitBranchName.text("…").parent().show(),Git.getGitRoot().then(function(gitRoot){var projectRoot=Utils.getProjectRoot(),isRepositoryRootOrChild=gitRoot&&0===projectRoot.indexOf(gitRoot);return $gitBranchName.parent().toggle(isRepositoryRootOrChild),isRepositoryRootOrChild?(Preferences.set("currentGitRoot",gitRoot),Preferences.set("currentGitSubfolder",projectRoot.substring(gitRoot.length)),addHeadToTheFileIndex(),Git.getCurrentBranchName().then(function(branchName){Git.getMergeInfo().then(function(mergeInfo){mergeInfo.mergeMode&&(branchName+="|MERGING"),mergeInfo.rebaseMode&&(mergeInfo.rebaseHead&&(branchName=mergeInfo.rebaseHead),branchName+="|REBASE",mergeInfo.rebaseNext&&mergeInfo.rebaseLast&&(branchName+="("+mergeInfo.rebaseNext+"/"+mergeInfo.rebaseLast+")")),EventEmitter.emit(Events.REBASE_MERGE_MODE,mergeInfo.rebaseMode,mergeInfo.mergeMode);var MAX_LEN=18;const tooltip=StringUtils.format(Strings.ON_BRANCH,branchName),html=`<i class="fas fa-code-branch"></i> ${branchName.length>18?branchName.substring(0,18)+"…":branchName}`;$gitBranchName.html(html).attr("title",tooltip).off("click").on("click",toggleDropdown),Panel.enable()}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_READING_GIT_STATE)})}).catch(function(ex){if(!ErrorHandler.contains(ex,"unknown revision"))throw ex;$gitBranchName.off("click").text("no branch"),Panel.enable()})):(Preferences.set("currentGitRoot",projectRoot),Preferences.set("currentGitSubfolder",""),$gitBranchName.off("click").text("not a git repo"),void Panel.disable("not-repo"))}).catch(function(err){ErrorHandler.showError(err)})}function init(){const $html=$("<div id='git-branch-dropdown-toggle' class='btn-alt-quiet'>\n            <span id='git-branch'>\n                <i class=\"fas fa-code-branch\"></i>\n            </span>\n            <span class=\"dropdown-arrow\"></span>\n            </div>");$html.appendTo($("#project-files-header")),$gitBranchName=$("#git-branch"),$html.on("click",function(){return $gitBranchName.click(),!1}),Setup.isExtensionActivated()?refresh():$("#git-branch-dropdown-toggle").addClass("forced-inVisible")}EventEmitter.on(Events.BRACKETS_FILE_CHANGED,function(file){file.fullPath===_getHeadFilePath()&&checkBranch()}),EventEmitter.on(Events.REFRESH_ALL,function(){FileSyncManager.syncOpenDocuments(),CommandManager.execute("file.refresh"),refresh()}),EventEmitter.on(Events.BRACKETS_PROJECT_CHANGE,function(){refresh()}),EventEmitter.on(Events.BRACKETS_PROJECT_REFRESH,function(){refresh()}),EventEmitter.on(Events.GIT_ENABLED,function(){$("#git-branch-dropdown-toggle").removeClass("forced-inVisible")}),EventEmitter.on(Events.GIT_DISABLED,function(){$("#git-branch-dropdown-toggle").addClass("forced-inVisible")}),exports.init=init,exports.refresh=refresh}),define("src/Cli",function(require,exports,module){const NodeConnector=brackets.getModule("NodeConnector"),ErrorHandler=require("src/ErrorHandler"),Preferences=require("src/Preferences"),Events=require("src/Events"),Utils=require("src/Utils");let gitTimeout=1e3*Preferences.get("gitTimeout"),nextCliId=0,deferredMap={};Preferences.getExtensionPref().on("change","gitTimeout",()=>{gitTimeout=1e3*Preferences.get("gitTimeout")});var MAX_COUNTER_VALUE=4294967295;let gitNodeConnector=NodeConnector.createNodeConnector("phcode-git-core",exports);function getNextCliId(){return nextCliId>=MAX_COUNTER_VALUE&&(nextCliId=0),++nextCliId}function normalizePathForOs(path){return"win"===brackets.platform&&(path=path.replace(/\//g,"\\")),path}function sanitizeOutput(str){return"string"!=typeof str&&(str=null!=str?str.toString():""),str}function logDebug(opts,debugInfo,method,type,out){if(logger.loggingOptions.logGit){var processInfo=[],duration=(new Date).getTime()-debugInfo.startTime;processInfo.push(duration+"ms"),opts.cliId&&processInfo.push("ID="+opts.cliId);var msg="cmd-"+method+"-"+type+" ("+processInfo.join(";")+")";out&&(msg+=': "'+out+'"'),Utils.consoleDebug(msg)}}function cliHandler(method,cmd,args,opts,retry){const cliPromise=new Promise((resolve,reject)=>{const cliId=getNextCliId();args=args||[];const progressTracker=(opts=opts||{}).progressTracker,savedDefer={resolve:resolve,reject:reject,progressTracker:progressTracker};deferredMap[cliId]=savedDefer;const watchProgress=!!progressTracker||-1!==args.indexOf("--progress"),startTime=(new Date).getTime();opts.cwd||(opts.cwd=fs.getTauriPlatformPath(Preferences.get("currentGitRoot")||Utils.getProjectRoot())),opts.cwd=normalizePathForOs(opts.cwd),Utils.consoleDebug("cmd-"+method+(watchProgress?"-watch":"")+": "+opts.cwd+" -> "+cmd+" "+args.join(" "));let resolved=!1,timeoutLength=opts.timeout?1e3*opts.timeout:gitTimeout;const domainOpts={cliId:cliId,watchProgress:watchProgress},debugInfo={startTime:startTime};function timeoutPromise(){logDebug(domainOpts,debugInfo,method,"timeout");var err=new Error("cmd-"+method+"-timeout: "+cmd+" "+args.join(" "));opts.timeoutExpected||ErrorHandler.logError(err),gitNodeConnector.execPeer("kill",domainOpts.cliId).catch(function(err){ErrorHandler.logError(err)}),delete deferredMap[cliId],reject(ErrorHandler.toError(err)),resolved=!0,progressTracker&&progressTracker.off(`${Events.GIT_PROGRESS_EVENT}.${cliId}`)}watchProgress&&progressTracker&&progressTracker.trigger(Events.GIT_PROGRESS_EVENT,"Running command: git "+args.join(" ")),gitNodeConnector.execPeer(method,{directory:opts.cwd,command:cmd,args:args,opts:domainOpts}).catch(function(err){if(!resolved){err=sanitizeOutput(err),logDebug(domainOpts,debugInfo,method,"fail",err),delete deferredMap[cliId];var invalidCwdErr="spawn ENOENT";if((err=ErrorHandler.toError(err)).stack&&err.stack.indexOf(invalidCwdErr)&&(err.message=err.message.replace(invalidCwdErr,"spawn ENOENT ("+opts.cwd+")"),err.stack=err.stack.replace(invalidCwdErr,"spawn ENOENT ("+opts.cwd+")")),err.stack&&-1!==err.stack.indexOf("WebSocket.self._ws.onclose")&&!retry)return void cliHandler(method,cmd,args,opts,!0).then(function(response){savedDefer.isResolved=!0,resolve(response)}).catch(function(err){reject(err)});reject(err)}}).then(function(out){resolved||(out=sanitizeOutput(out),logDebug(domainOpts,debugInfo,method,"out",out),delete deferredMap[cliId],resolve(out))}).finally(function(){progressTracker&&progressTracker.off(`${Events.GIT_PROGRESS_EVENT}.${cliId}`),resolved=!0});var lastProgressTime=0;function timeoutCall(){setTimeout(function(){if(!resolved)if(domainOpts.watchProgress){const currentTime=(new Date).getTime(),diff=currentTime-lastProgressTime;diff>timeoutLength?(Utils.consoleDebug("cmd("+cliId+") - last progress message was sent "+diff+"ms ago - timeout"),timeoutPromise()):(Utils.consoleDebug("cmd("+cliId+") - last progress message was sent "+diff+"ms ago - delay"),timeoutCall())}else timeoutPromise()},timeoutLength)}!1!==opts.timeout&&(domainOpts.watchProgress&&progressTracker&&(progressTracker.off(`${Events.GIT_PROGRESS_EVENT}.${cliId}`),progressTracker.on(`${Events.GIT_PROGRESS_EVENT}.${cliId}`,function(){lastProgressTime=(new Date).getTime()})),timeoutCall())});return cliPromise}function which(cmd){return cliHandler("which",cmd)}function spawnCommand(cmd,args,opts){return cliHandler("spawn",cmd,args,opts)}gitNodeConnector.on(Events.GIT_PROGRESS_EVENT,(_event,evtData)=>{const deferred=deferredMap[evtData.cliId];deferred?!deferred.isResolved&&deferred.progressTracker&&deferred.progressTracker.trigger(Events.GIT_PROGRESS_EVENT,evtData.data):ErrorHandler.logError("Progress sent for a non-existing process("+evtData.cliId+"): "+evtData)}),exports.cliHandler=cliHandler,exports.which=which,exports.spawnCommand=spawnCommand}),define("src/CloseNotModified",function(require,exports){const DocumentManager=brackets.getModule("document/DocumentManager"),Commands=brackets.getModule("command/Commands"),CommandManager=brackets.getModule("command/CommandManager"),Strings=brackets.getModule("strings"),MainViewManager=brackets.getModule("view/MainViewManager"),Events=require("src/Events"),EventEmitter=require("src/EventEmitter"),Git=require("src/git/Git"),Preferences=require("src/Preferences"),Constants=require("src/Constants"),Utils=require("src/Utils");let closeUnmodifiedCmd;function handleCloseNotModified(){Git.status().then(function(modifiedFiles){var openFiles=MainViewManager.getWorkingSet(MainViewManager.ALL_PANES),currentGitRoot=Preferences.get("currentGitRoot");openFiles.forEach(function(openFile){var removeOpenFile=!0;if(modifiedFiles.forEach(function(modifiedFile){currentGitRoot+modifiedFile.file===openFile.fullPath&&(removeOpenFile=!1)}),removeOpenFile){const doc=DocumentManager.getOpenDocumentForPath(openFile.fullPath);doc&&doc.isDirty||CommandManager.execute(Commands.FILE_CLOSE_LIST,{PaneId:MainViewManager.ALL_PANES,fileList:[openFile]})}}),MainViewManager.focusActivePane()})}function init(){closeUnmodifiedCmd=CommandManager.register(Strings.CMD_CLOSE_UNMODIFIED,Constants.CMD_GIT_CLOSE_UNMODIFIED,handleCloseNotModified),Utils.enableCommand(Constants.CMD_GIT_CLOSE_UNMODIFIED,!1)}EventEmitter.on(Events.GIT_ENABLED,function(){Utils.enableCommand(Constants.CMD_GIT_CLOSE_UNMODIFIED,!0)}),EventEmitter.on(Events.GIT_DISABLED,function(){Utils.enableCommand(Constants.CMD_GIT_CLOSE_UNMODIFIED,!1)}),exports.init=init}),define("src/Constants",function(require,exports){const Commands=brackets.getModule("command/Commands"),Menus=brackets.getModule("command/Menus");exports.GIT_STRING_UNIVERSAL="Git",exports.GIT_SUB_MENU=Menus.SubMenuIds.GIT_SUB_MENU,exports.GIT_PANEL_CHANGES_CMENU="git-panel-changes-cmenu",exports.GIT_PANEL_HISTORY_CMENU="git-panel-history-cmenu",exports.GIT_PANEL_OPTIONS_CMENU="git-panel-options-cmenu",exports.CMD_GIT_INIT=Commands.CMD_GIT_INIT,exports.CMD_GIT_CLONE=Commands.CMD_GIT_CLONE,exports.CMD_GIT_CLONE_WITH_URL=Commands.CMD_GIT_CLONE_WITH_URL,exports.CMD_GIT_SETTINGS_COMMAND_ID=Commands.CMD_GIT_SETTINGS_COMMAND_ID,exports.CMD_GIT_CLOSE_UNMODIFIED=Commands.CMD_GIT_CLOSE_UNMODIFIED,exports.CMD_GIT_CHECKOUT=Commands.CMD_GIT_CHECKOUT,exports.CMD_GIT_RESET_HARD=Commands.CMD_GIT_RESET_HARD,exports.CMD_GIT_RESET_SOFT=Commands.CMD_GIT_RESET_SOFT,exports.CMD_GIT_RESET_MIXED=Commands.CMD_GIT_RESET_MIXED,exports.CMD_GIT_TOGGLE_PANEL=Commands.CMD_GIT_TOGGLE_PANEL,exports.CMD_GIT_GOTO_NEXT_CHANGE=Commands.CMD_GIT_GOTO_NEXT_CHANGE,exports.CMD_GIT_GOTO_PREVIOUS_CHANGE=Commands.CMD_GIT_GOTO_PREVIOUS_CHANGE,exports.CMD_GIT_COMMIT_CURRENT=Commands.CMD_GIT_COMMIT_CURRENT,exports.CMD_GIT_COMMIT_ALL=Commands.CMD_GIT_COMMIT_ALL,exports.CMD_GIT_FETCH=Commands.CMD_GIT_FETCH,exports.CMD_GIT_PULL=Commands.CMD_GIT_PULL,exports.CMD_GIT_PUSH=Commands.CMD_GIT_PUSH,exports.CMD_GIT_REFRESH=Commands.CMD_GIT_REFRESH,exports.CMD_GIT_TAG=Commands.CMD_GIT_TAG,exports.CMD_GIT_DISCARD_ALL_CHANGES=Commands.CMD_GIT_DISCARD_ALL_CHANGES,exports.CMD_GIT_UNDO_LAST_COMMIT=Commands.CMD_GIT_UNDO_LAST_COMMIT,exports.CMD_GIT_CHANGE_USERNAME=Commands.CMD_GIT_CHANGE_USERNAME,exports.CMD_GIT_CHANGE_EMAIL=Commands.CMD_GIT_CHANGE_EMAIL,exports.CMD_GIT_GERRIT_PUSH_REF=Commands.CMD_GIT_GERRIT_PUSH_REF,exports.CMD_GIT_AUTHORS_OF_SELECTION=Commands.CMD_GIT_AUTHORS_OF_SELECTION,exports.CMD_GIT_AUTHORS_OF_FILE=Commands.CMD_GIT_AUTHORS_OF_FILE,exports.CMD_GIT_TOGGLE_UNTRACKED=Commands.CMD_GIT_TOGGLE_UNTRACKED,exports.CMD_GIT_HISTORY_GLOBAL=Commands.CMD_GIT_HISTORY_GLOBAL,exports.CMD_GIT_HISTORY_FILE=Commands.CMD_GIT_HISTORY_FILE}),define("src/ErrorHandler",function(require,exports){const Dialogs=brackets.getModule("widgets/Dialogs"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),Metrics=brackets.getModule("utils/Metrics"),Strings=brackets.getModule("strings"),NotificationUI=brackets.getModule("widgets/NotificationUI"),Utils=require("src/Utils"),errorDialogTemplate='<div id="git-error-dialog" class="modal">\n    <div class="modal-header">\n        <h1 class="dialog-title">{{Strings.BRACKETS_GIT_ERROR}}</h1>\n    </div>\n    <div class="modal-body table-striped tab-content">\n        <h3>{{title}}</h3>\n        <pre>{{body}}</pre>\n    </div>\n    <div class="modal-footer">\n        <button data-button-id="close"  class="primary dialog-button btn btn-80">{{Strings.BUTTON_CLOSE}}</button>\n    </div>\n</div>\n';function errorToString(err){return Utils.encodeSensitiveInformation(err.toString())}exports.isTimeout=function(err){return err instanceof Error&&(0===err.message.indexOf("cmd-execute-timeout")||0===err.message.indexOf("cmd-spawn-timeout"))},exports.equals=function(err,what){return err.toString().toLowerCase()===what.toLowerCase()},exports.contains=function(err,what){return-1!==err.toString().toLowerCase().indexOf(what.toLowerCase())},exports.matches=function(err,regExp){return err.toString().match(regExp)},exports.logError=function(err){const msg=err&&err.stack?err.stack:err;return Utils.consoleError("[brackets-git] "+msg),err},exports.showError=function(err,title,options={}){const dontStripError=options.dontStripError,errorMetric=options.errorMetric;if(err.__shown)return err;let errorBody,errorStack;if(exports.logError(err),"string"==typeof err?errorBody=err:err instanceof Error&&(errorBody=dontStripError?err.toString():errorToString(err),errorStack=err.stack||""),!errorBody||"[object Object]"===errorBody)try{errorBody=JSON.stringify(err,null,4)}catch(e){errorBody="Error can't be stringified by JSON.stringify"}if(errorBody=window.debugMode?`${errorBody}\n${errorStack}`:errorBody,options.useNotification)Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"notifyErr",errorMetric||"Show"),NotificationUI.createToastFromTemplate(title,`<textarea readonly style="width: 200px; height: 200px; cursor: text; resize: none;">${errorBody}</textarea>`,{toastStyle:NotificationUI.NOTIFICATION_STYLES_CSS_CLASS.ERROR,dismissOnClick:!1,instantOpen:!0});else{Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"dialogErr",errorMetric||"Show");const compiledTemplate=Mustache.render(errorDialogTemplate,{title:title,body:errorBody,Strings:Strings});Dialogs.showModalDialogUsingTemplate(compiledTemplate)}return"string"==typeof err&&(err=new Error(err)),err.__shown=!0,err},exports.toError=function(arg){if(arg instanceof Error)return arg;var err=new Error(arg);return err.match=function(){return arg.match.apply(arg,arguments)},err}}),define("src/EventEmitter",function(require,exports,module){const EventDispatcher=brackets.getModule("utils/EventDispatcher"),Metrics=brackets.getModule("utils/Metrics"),emInstance={};function getEmitter(eventName,optionalMetricToLog){if(!eventName)throw new Error("no event has been passed to get the emittor!");return function(){emit(eventName,...arguments),optionalMetricToLog&&Metrics.countEvent(Metrics.EVENT_TYPE.GIT,optionalMetricToLog[0],optionalMetricToLog[1])}}function emit(){emInstance.trigger(...arguments)}function on(eventName,callback){emInstance.on(eventName,(...args)=>{const[,...rest]=args;callback(...rest)})}function one(eventName,callback){emInstance.one(eventName,(...args)=>{const[,...rest]=args;callback(...rest)})}EventDispatcher.makeEventDispatcher(emInstance),exports.getEmitter=getEmitter,exports.emit=emit,exports.on=on,exports.one=one}),define("src/Events",function(require,exports){exports.BRACKETS_CURRENT_DOCUMENT_CHANGE="brackets_current_document_change",exports.BRACKETS_PROJECT_CHANGE="brackets_project_change",exports.BRACKETS_PROJECT_REFRESH="brackets_project_refresh",exports.BRACKETS_DOCUMENT_SAVED="brackets_document_saved",exports.BRACKETS_FILE_CHANGED="brackets_file_changed",exports.GIT_PROGRESS_EVENT="git_progress",exports.GIT_USERNAME_CHANGED="git_username_changed",exports.GIT_EMAIL_CHANGED="git_email_changed",exports.GIT_COMMITED="git_commited",exports.GIT_NO_BRANCH_EXISTS="git_no_branch_exists",exports.GIT_CHANGE_USERNAME="git_change_username",exports.GIT_CHANGE_EMAIL="git_change_email",exports.GERRIT_TOGGLE_PUSH_REF="gerrit_toggle_push_ref",exports.GERRIT_PUSH_REF_TOGGLED="gerrit_push_ref_toggled",exports.REFRESH_ALL="git_refresh_all",exports.GIT_ENABLED="git_enabled",exports.GIT_DISABLED="git_disabled",exports.REBASE_MERGE_MODE="rebase_merge_mode",exports.HANDLE_GIT_INIT="handle_git_init",exports.HANDLE_GIT_CLONE="handle_git_clone",exports.HANDLE_GIT_COMMIT="handle_git_commit",exports.HANDLE_FETCH="handle_fetch",exports.HANDLE_PUSH="handle_push",exports.HANDLE_PULL="handle_pull",exports.HANDLE_REMOTE_PICK="handle_remote_pick",exports.HANDLE_REMOTE_DELETE="handle_remote_delete",exports.HANDLE_REMOTE_CREATE="handle_remote_create",exports.HANDLE_FTP_PUSH="handle_ftp_push",exports.HISTORY_SHOW_FILE="history_showFile",exports.HISTORY_SHOW_GLOBAL="history_showGlobal",exports.REFRESH_COUNTERS="refresh_counters",exports.REFRESH_HISTORY="refresh_history",exports.GIT_STATUS_RESULTS="git_status_results",exports.GIT_REMOTE_AVAILABLE="git_remote_available",exports.GIT_REMOTE_NOT_AVAILABLE="git_remote_not_available",exports.REMOTES_REFRESH_PICKER="remotes_refresh_picker",exports.FETCH_STARTED="remotes_fetch_started",exports.FETCH_COMPLETE="remotes_fetch_complete"}),define("src/ExpectedError",function(require,exports,module){function ExpectedError(){Error.apply(this,arguments),this.message=arguments[0]}ExpectedError.prototype=new Error,ExpectedError.prototype.name="ExpectedError",ExpectedError.prototype.toString=function(){return this.message},module.exports=ExpectedError}),define("src/GutterManager",function(require,exports){var _=brackets.getModule("thirdparty/lodash"),CommandManager=brackets.getModule("command/CommandManager"),DocumentManager=brackets.getModule("document/DocumentManager"),EditorManager=brackets.getModule("editor/EditorManager"),ScrollTrackMarkers=brackets.getModule("search/ScrollTrackMarkers"),MainViewManager=brackets.getModule("view/MainViewManager"),ErrorHandler=require("src/ErrorHandler"),Events=require("src/Events"),EventEmitter=require("src/EventEmitter"),Git=require("src/git/Git"),Preferences=require("./Preferences"),Strings=brackets.getModule("strings");const GIT_SCROLL_MARKS="git_marks";var gitAvailable=!1,gutterName="brackets-git-gutter",editorsWithGutters=[],openWidgets=[];function _addDummyGutterMarkerIfNotExist(cm,line){var lineInfo=cm.lineInfo(line),gutters,gutterEnabled;if(lineInfo&&-1!==cm.getOption("gutters").slice(0).indexOf(gutterName)){var gutterMarkers=lineInfo.gutterMarkers,existingMarker;if(!(gutterMarkers&&gutterMarkers[gutterName])){var dummy=document.createElement("div");dummy.className="CodeMirror-gitGutter-none",cm.setGutterMarker(line,gutterName,dummy)}}}function _cursorActivity(_evt,editor){editor.hasSelection()||_addDummyGutterMarkerIfNotExist(editor._codeMirror,editor.getCursorPos().line)}function clearWidgets(){var lines=openWidgets.map(function(mark){var w=mark.lineWidget;return w.visible&&(w.visible=!1,w.widget.clear()),{cm:mark.cm,line:mark.line}});return openWidgets=[],lines}function clearOld(editor){var cm=editor._codeMirror;if(cm){var gutters=cm.getOption("gutters").slice(0),io=gutters.indexOf(gutterName);-1!==io&&(gutters.splice(io,1),cm.clearGutter(gutterName),cm.setOption("gutters",gutters),cm.off("gutterClick",gutterClick)),delete cm.gitGutters,clearWidgets()}}function prepareGutter(editor){var cm=editor._codeMirror,gutters=cm.getOption("gutters").slice(0);-1===gutters.indexOf(gutterName)&&(gutters.unshift(gutterName),cm.setOption("gutters",gutters),cm.on("gutterClick",gutterClick)),-1===editorsWithGutters.indexOf(editor)&&editorsWithGutters.push(editor)}function prepareGutters(editors){editors.forEach(function(editor){prepareGutter(editor)});for(var idx=editorsWithGutters.length;idx--;)-1===editors.indexOf(editorsWithGutters[idx])&&(clearOld(editorsWithGutters[idx]),editorsWithGutters.splice(idx,1))}function _showGutters(editor,_results){prepareGutter(editor);var cm=editor._codeMirror;cm.gitGutters=_.sortBy(_results,"line");var openBefore=clearWidgets();cm.clearGutter(gutterName),cm.gitGutters.forEach(function(obj){var $marker=$("<div>").addClass(gutterName+"-"+obj.type+" gitline-"+(obj.line+1)).html("&nbsp;");cm.setGutterMarker(obj.line,gutterName,$marker[0])}),_cursorActivity(null,editor),openBefore.forEach(function(obj){gutterClick(obj.cm,obj.line,gutterName)})}function gutterClick(cm,lineIndex,gutterId){if(cm&&(gutterId===gutterName||"CodeMirror-linenumbers"===gutterId)){var mark=_.find(cm.gitGutters,function(o){return o.line===lineIndex});if(mark&&"added"!==mark.type){if(mark.cm=cm,mark.parentMark&&(mark=mark.parentMark),!mark.lineWidget){mark.lineWidget={visible:!1,element:$("<div class='"+gutterName+"-deleted-lines'></div>")};var $btn=$("<button/>").addClass("brackets-git-gutter-copy-button").text("R").on("click",function(){var doc;DocumentManager.getCurrentDocument().replaceRange(mark.content+"\n",{line:mark.line,ch:0}),CommandManager.execute("file.save"),refresh()});$("<pre/>").attr("style","tab-size:"+cm.getOption("tabSize")).text(mark.content||" ").append($btn).appendTo(mark.lineWidget.element)}if(!0!==mark.lineWidget.visible)mark.lineWidget.visible=!0,mark.lineWidget.widget=cm.addLineWidget(mark.line,mark.lineWidget.element[0],{coverGutter:!1,noHScroll:!1,above:!0,showIfHidden:!1}),openWidgets.push(mark);else{mark.lineWidget.visible=!1,mark.lineWidget.widget.clear();var io=openWidgets.indexOf(mark);-1!==io&&openWidgets.splice(io,1)}}}}function getEditorFromPane(paneId){var currentPath=MainViewManager.getCurrentlyViewedPath(paneId),doc=currentPath&&DocumentManager.getOpenDocumentForPath(currentPath);return doc&&doc._masterEditor}function hasVerticalScrollbar(editor){const cm=editor._codeMirror,scrollEl=cm.getScrollerElement();return scrollEl.scrollHeight>scrollEl.clientHeight}function _markScrollbar(editor,allChanges){if(ScrollTrackMarkers.clear(editor,GIT_SCROLL_MARKS),!hasVerticalScrollbar(editor))return;const added=allChanges.filter(item=>"added"===item.type).map(({line:line})=>({line:line,ch:0})),removed=allChanges.filter(item=>"removed"===item.type).map(({line:line})=>({line:line,ch:0})),modified=allChanges.filter(item=>"modified"===item.type).map(({line:line})=>({line:line,ch:0})),trackers=[{arr:added,css:"brackets-git-added"},{arr:removed,css:"brackets-git-removed"},{arr:modified,css:"brackets-git-modified"}];for(let tracker of trackers){if(!tracker.arr.length)continue;let posArray=tracker.arr.map(item=>({line:item.line,ch:0}));ScrollTrackMarkers.addTickmarks(editor,posArray,{trackStyle:ScrollTrackMarkers.TRACK_STYLES.ON_LEFT,name:GIT_SCROLL_MARKS,cssColorClass:tracker.css})}}function processDiffResults(editor,diff){var added=[],removed=[],modified=[],changesets=diff.split(/\n@@/).map(function(str){return"@@"+str});changesets.shift(),changesets.forEach(function(str){var m=str.match(/^@@ -([,0-9]+) \+([,0-9]+) @@/),s1=m[1].split(","),s2=m[2].split(","),lineRemovedFrom,lineFrom=parseInt(s2[0],10),lineCount=parseInt(s1[1],10);isNaN(lineCount)&&(lineCount=1),lineCount>0&&(lineRemovedFrom=lineFrom-1,removed.push({type:"removed",line:lineRemovedFrom,content:str.split("\n").filter(function(l){return 0===l.indexOf("-")}).map(function(l){return l.substring(1)}).join("\n")})),lineFrom=parseInt(s2[0],10),lineCount=parseInt(s2[1],10),isNaN(lineCount)&&(lineCount=1);for(var isModifiedMark=!1,firstAddedMark=!1,i=lineFrom,lineTo=lineFrom+lineCount;i<lineTo;i++){var lineNo=i-1;if(lineNo===lineRemovedFrom){var o=removed.pop();o.type="modified",modified.push(o),isModifiedMark=o}else{var mark={type:isModifiedMark?"modified":"added",line:lineNo,parentMark:isModifiedMark||firstAddedMark||null};isModifiedMark||firstAddedMark||(firstAddedMark=mark),added.push(mark)}}}),removed.forEach(function(o){o.line=o.line+1});const allChanges=[].concat(added,removed,modified);_showGutters(editor,allChanges),_markScrollbar(editor,allChanges)}function refresh(){if(gitAvailable&&Preferences.get("useGitGutter")){var currentGitRoot=Preferences.get("currentGitRoot"),editors=_.compact(_.map(MainViewManager.getPaneIdList(),function(paneId){return getEditorFromPane(paneId)}));prepareGutters(editors),editors.forEach(function(editor){var currentFilePath=null;if(editor.document&&editor.document.file&&(currentFilePath=editor.document.file.fullPath),0===currentFilePath.indexOf(currentGitRoot)){var filename=currentFilePath.substring(currentGitRoot.length);Git.diffFile(filename).then(function(diff){processDiffResults(editor,diff)}).catch(function(err){ErrorHandler.contains(err,"Not a git repository")||ErrorHandler.contains(err,"No such file or directory")||ErrorHandler.showError(err,Strings.ERROR_REFRESH_GUTTER)})}})}}function goToPrev(){var activeEditor=EditorManager.getActiveEditor();if(activeEditor){for(var results=activeEditor._codeMirror.gitGutters||[],searched=_.filter(results,function(i){return!i.parentMark}),currentPos=activeEditor.getCursorPos(),i=searched.length;i--&&!(searched[i].line<currentPos.line););if(i>-1){var goToMark=searched[i];activeEditor.setCursorPos(goToMark.line,currentPos.ch)}}}function goToNext(){var activeEditor=EditorManager.getActiveEditor();if(activeEditor){for(var results=activeEditor._codeMirror.gitGutters||[],searched=_.filter(results,function(i){return!i.parentMark}),currentPos=activeEditor.getCursorPos(),i=0,l=searched.length;i<l&&!(searched[i].line>currentPos.line);i++);if(i<searched.length){var goToMark=searched[i];activeEditor.setCursorPos(goToMark.line,currentPos.ch)}}}function init(){const editor=EditorManager.getActiveEditor();editor&&(editor.off("cursorActivity.gitGutter"),editor.on("cursorActivity.gitGutter",_cursorActivity),_cursorActivity(null,editor))}EditorManager.on("activeEditorChange",function(event,newEditor,oldEditor){newEditor&&(newEditor.off("cursorActivity.gitGutter"),newEditor.on("cursorActivity.gitGutter",_cursorActivity),_cursorActivity(null,newEditor)),oldEditor&&oldEditor.off("cursorActivity.gitGutter")}),EventEmitter.on(Events.GIT_ENABLED,function(){gitAvailable=!0,refresh()}),EventEmitter.on(Events.GIT_DISABLED,function(){gitAvailable=!1,prepareGutters([])}),EventEmitter.on(Events.BRACKETS_CURRENT_DOCUMENT_CHANGE,function(file){var alreadyOpened;file&&(_.filter(editorsWithGutters,function(editor){return editor.document.file.fullPath===file.fullPath}).length>0||refresh())}),EventEmitter.on(Events.GIT_COMMITED,function(){refresh()}),EventEmitter.on(Events.BRACKETS_FILE_CHANGED,function(file){var alreadyOpened;_.filter(editorsWithGutters,function(editor){return editor.document.file.fullPath===file.fullPath}).length>0&&refresh()}),exports.init=init,exports.goToPrev=goToPrev,exports.goToNext=goToNext}),define("src/History",function(require){var _=brackets.getModule("thirdparty/lodash"),DocumentManager=brackets.getModule("document/DocumentManager"),FileUtils=brackets.getModule("file/FileUtils"),LocalizationUtils=brackets.getModule("utils/LocalizationUtils"),Strings=brackets.getModule("strings"),Metrics=brackets.getModule("utils/Metrics"),Mustache=brackets.getModule("thirdparty/mustache/mustache");const ErrorHandler=require("src/ErrorHandler"),Events=require("src/Events"),EventEmitter=require("src/EventEmitter"),Git=require("src/git/Git"),HistoryViewer=require("src/HistoryViewer"),Preferences=require("src/Preferences");var gitPanelHistoryTemplate='<table id="git-history-list" class="bottom-panel-table table table-striped table-condensed row-highlight">\n    <tbody>\n        {{> commits}}\n    </tbody>\n</table>\n',gitPanelHistoryCommitsTemplate='{{#commits}}\n<tr class="history-commit" x-hash="{{hash}}">\n    <td>\n        <div class="commit-author-avatar">\n            <span style="{{cssAvatar}}">{{avatarLetter}}</span>\n        </div>\n    </td>\n    <td><span title="{{date.title}}">{{date.shown}}</span> {{Strings.HISTORY_COMMIT_BY}} <span class="commit-author">{{author}}</span></td>\n    <td class="commit-title"><span class="commit-subject">{{subject}} </span>{{#hasTag}}<span class="commit-tags" title="{{tags}}"><i class="octicon octicon-tag"></i>{{tags}}</span>{{/hasTag}}</td>\n    <td>{{hashShort}}</td>\n</tr>\n{{/commits}}\n';let $gitPanel=$(null),$tableContainer=$(null),$historyList=$(null),commitCache=[],lastDocumentSeen=null;function initVariables(){$gitPanel=$("#git-panel"),$tableContainer=$gitPanel.find(".table-container"),attachHandlers()}function attachHandlers(){$tableContainer.off(".history").on("scroll.history",function(){loadMoreHistory()}).on("click.history",".history-commit",function(){const $tr=$(this);var hash=$tr.attr("x-hash"),commit=_.find(commitCache,function(commit){return commit.hash===hash});const historyShown=HistoryViewer.toggle(commit,getCurrentDocument(),{isInitial:"true"===$(this).attr("x-initial-commit")});$tr.parent().find("tr.selected").removeClass("selected"),historyShown&&$tr.addClass("selected")})}var generateCssAvatar=_.memoize(function(author,email){var seededRandom=function(max,min,seed){var rnd;return(min=min||0)+(seed=(9301*seed+49297)%233280)/233280*((max=max||1)-min)},seedBase=parseInt(author.charCodeAt(3).toString(),email.length),seed=parseInt(email.charCodeAt(seedBase.toString().substring(1,2)).toString(),16),colors=["#ffb13b","#dd5f7a","#8dd43a","#2f7e2f","#4141b9","#3dafea","#7e3e3e","#f2f26b","#864ba3","#ac8aef","#f2f2ce","#379d9d","#ff6750","#8691a2","#d2fd8d","#88eadf"],texts=["#FEFEFE","#FEFEFE","#FEFEFE","#FEFEFE","#FEFEFE","#FEFEFE","#FEFEFE","#333333","#FEFEFE","#FEFEFE","#333333","#FEFEFE","#FEFEFE","#FEFEFE","#333333","#333333"],picked=Math.floor(seededRandom(0,16,seed));return"background-color: "+colors[picked]+"; color: "+texts[picked]},function(author,email){return author+email});function renderHistory(file){return commitCache=[],Git.getCurrentBranchName().then(function(branchName){var p;return(file?Git.getFileHistory(file.relative,branchName):Git.getHistory(branchName)).then(function(commits){commits=addAdditionalCommitInfo(commits),commitCache=commitCache.concat(commits);var templateData={commits:commits,Strings:Strings};$tableContainer.append(Mustache.render(gitPanelHistoryTemplate,templateData,{commits:gitPanelHistoryCommitsTemplate})),($historyList=$tableContainer.find("#git-history-list").data("file",file?file.absolute:null).data("file-relative",file?file.relative:null)).find("tr.history-commit:last-child").attr("x-initial-commit","true")})}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_GET_HISTORY)})}function loadMoreHistory(){if($historyList.is(":visible")&&$tableContainer.prop("scrollHeight")-$tableContainer.scrollTop()===$tableContainer.height()){if("true"===$historyList.attr("x-finished"))return;return Git.getCurrentBranchName().then(function(branchName){var p,file=$historyList.data("file-relative"),skipCount=$tableContainer.find("tr.history-commit").length;return(p=file?Git.getFileHistory(file,branchName,skipCount):Git.getHistory(branchName,skipCount)).then(function(commits){if(0===commits.length)return $historyList.attr("x-finished","true"),void $historyList.find("tr.history-commit:last-child").attr("x-initial-commit","true");commits=addAdditionalCommitInfo(commits),commitCache=commitCache.concat(commits);var templateData={commits:commits,Strings:Strings},commitsHtml=Mustache.render(gitPanelHistoryCommitsTemplate,templateData);$historyList.children("tbody").append(commitsHtml)}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_GET_MORE_HISTORY)})}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_GET_CURRENT_BRANCH)})}}function addAdditionalCommitInfo(commits){return _.forEach(commits,function(commit){commit.cssAvatar=generateCssAvatar(commit.author,commit.email),commit.avatarLetter=commit.author.substring(0,1);const dateTime=new Date(commit.date);isNaN(dateTime.getTime())?commit.date={title:commit.date,shown:commit.date}:commit.date={title:LocalizationUtils.getFormattedDateTime(dateTime),shown:LocalizationUtils.dateTimeFromNowFriendly(dateTime)},commit.hasTag=!!commit.tags}),commits}function getCurrentDocument(){if(HistoryViewer.isVisible())return lastDocumentSeen;var doc=DocumentManager.getCurrentDocument();return doc&&(lastDocumentSeen=doc),doc||lastDocumentSeen}function handleFileChange(){var currentDocument=getCurrentDocument();$historyList.is(":visible")&&$historyList.data("file")&&handleToggleHistory("FILE",currentDocument),$gitPanel.find(".git-file-history").prop("disabled",!currentDocument)}function handleToggleHistory(newHistoryMode,newDocument){let historyEnabled=($historyList=$tableContainer.find("#git-history-list")).is(":visible"),currentFile=$historyList.data("file")||null,currentHistoryMode=historyEnabled?currentFile?"FILE":"GLOBAL":"DISABLED",doc=newDocument||getCurrentDocument(),file,savedScrollTop,savedScrollLeft,selectedCommitHash,isRefresh=!1;"REFRESH"===newHistoryMode?(newHistoryMode=currentHistoryMode,isRefresh=!0,historyEnabled=!0,$historyList.length>0&&(savedScrollTop=$historyList.parent().scrollTop(),savedScrollLeft=$historyList.parent().scrollLeft(),selectedCommitHash=$historyList.find(".selected").attr("x-hash"))):currentHistoryMode!==newHistoryMode?historyEnabled=!0:newDocument||(historyEnabled=!historyEnabled),historyEnabled&&"FILE"===newHistoryMode&&(doc?((file={}).absolute=doc.file.fullPath,file.relative=FileUtils.getRelativeFilename(Preferences.get("currentGitRoot"),file.absolute)):historyEnabled=!1);var isEmpty=0===$historyList.find("tr").length,fileChanged=currentFile!==(file?file.absolute:null);if(historyEnabled&&(isEmpty||fileChanged||isRefresh)){$historyList.length>0&&$historyList.remove();var $spinner=$("<div class='spinner spin large'></div>").appendTo($gitPanel);renderHistory(file).finally(function(){if($spinner.remove(),isRefresh){let $newHistoryList=$tableContainer.find("#git-history-list");$newHistoryList.parent().scrollTop(savedScrollTop||0),$newHistoryList.parent().scrollLeft(savedScrollLeft||0),$historyList.find(`[x-hash="${selectedCommitHash}"]`).addClass("selected")}})}historyEnabled?$gitPanel.find(".git-commit, .check-all").prop("disabled",!0):Git.status(),$tableContainer.find(".git-edited-list").toggle(!historyEnabled),$historyList.toggle(historyEnabled),historyEnabled||HistoryViewer.hide();var globalButtonActive=historyEnabled&&"GLOBAL"===newHistoryMode,fileButtonActive=historyEnabled&&"FILE"===newHistoryMode;$gitPanel.find(".git-history-toggle").toggleClass("active",globalButtonActive).attr("title",globalButtonActive?Strings.TOOLTIP_HIDE_HISTORY:Strings.TOOLTIP_SHOW_HISTORY),$gitPanel.find(".git-file-history").toggleClass("active",fileButtonActive).attr("title",fileButtonActive?Strings.TOOLTIP_HIDE_FILE_HISTORY:Strings.TOOLTIP_SHOW_FILE_HISTORY)}EventEmitter.on(Events.GIT_ENABLED,function(){initVariables()}),EventEmitter.on(Events.GIT_DISABLED,function(){lastDocumentSeen=null,$historyList.remove(),$historyList=$()}),EventEmitter.on(Events.HISTORY_SHOW_FILE,function(){handleToggleHistory("FILE"),Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"panel","fileHistory")}),EventEmitter.on(Events.HISTORY_SHOW_GLOBAL,function(){handleToggleHistory("GLOBAL"),Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"panel","history")}),EventEmitter.on(Events.REFRESH_HISTORY,function(){handleToggleHistory("REFRESH")}),EventEmitter.on(Events.BRACKETS_CURRENT_DOCUMENT_CHANGE,function(){handleFileChange()})}),define("src/HistoryViewer",function(require,exports){const _=brackets.getModule("thirdparty/lodash"),LanguageManager=brackets.getModule("language/LanguageManager"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),WorkspaceManager=brackets.getModule("view/WorkspaceManager"),Strings=brackets.getModule("strings"),Metrics=brackets.getModule("utils/Metrics"),marked=brackets.getModule("thirdparty/marked.min").marked,ErrorHandler=require("src/ErrorHandler"),Git=require("src/git/Git"),Preferences=require("src/Preferences"),Utils=require("src/Utils");var historyViewerTemplate='<div id="history-viewer">\n    <div class="header">\n        <div>\n            <a href="#" class="close">&times;</a>\n        </div>\n        <div class="author-line">\n            <span class="commit-author">\n                <div class="commit-author-avatar">\n                    <span class="text" style="{{commit.cssAvatar}}">{{commit.avatarLetter}}</span>\n                </div>\n                <span class="commit-author-name">{{commit.author}}</span>\n                <span class="commit-author-email">&lt;{{commit.email}}&gt;</span>\n            </span>\n            <span class="commit-time" title="{{commit.date.title}}">\n                <i class="octicon octicon-calendar"></i>&nbsp;\n                <span class="selectable-text">{{commit.date.shown}}</span>\n            </span>\n            <span class="commit-hash" data-hash="{{commit.hash}}">\n                <i class="octicon octicon-git-commit"></i>&nbsp;<span class="selectable-text">{{commit.hashShort}}</span>\n                <a href="#" class="git-extend-sha">&hellip;</a>\n            </span>\n            <div class="actions">\n                <span class="toggle-diffs">\n                    <i class="octicon octicon-expand collapse"></i>\n                    <i class="octicon octicon-collapse expand"></i>\n                    <span class="expand">{{Strings.EXPAND_ALL}}</span>\n                    <span class="collapse">{{Strings.COLLAPSE_ALL}}</span>\n                </span>\n            </div>\n        </div>\n        <div>\n            <h1 class="commit-title selectable-text"><span>{{commit.subject}}</span></h1>\n        </div>\n    </div>\n    <div class="body">\n        <div class="commitBody selectable-text">{{{bodyMarkdown}}}</div>\n        <div class="table-striped tab-content">\n            <div class="commit-files">\n                <ul class="nav nav-tabs nav-stacked filesContainer"></ul>\n                <button class="btn loadMore">\n                    Load more files from this commit\n                </button>\n            </div>\n        </div>\n    </div>\n</div>\n',historyViewerFilesTemplate='{{#files}}\n    <li x-file="{{file}}">\n        <a>\n            <i class="caret caret-right closed"></i>\n            <i class="caret opened"></i>\n            {{name}}<span class="extension">{{extension}}</span>\n            <i class="octicon octicon-eye openFile" title="{{Strings.VIEW_THIS_FILE}}"></i>\n            {{#useDifftool}}<i class="octicon octicon-diff difftool" title="{{Strings.DIFFTOOL}}"></i>{{/useDifftool}}\n        </a>\n        <div class="commit-diff"></div>\n    </li>\n{{/files}}\n';let useDifftool=!1,isShown=!1,commit=null,currentlyViewedCommit=null,isInitial=null,$viewer=null,$editorHolder=null;var setExpandState=_.debounce(function(){var allFiles=$viewer.find(".commit-files a"),activeFiles=allFiles.filter(".active"),allExpanded=allFiles.length===activeFiles.length;$viewer.find(".toggle-diffs").toggleClass("opened",allExpanded)},100),PAGE_SIZE=25,currentPage=0,hasNextPage=!1;function toggleDiff($a){if($a.hasClass("active"))return $a.removeClass("active"),void setExpandState();if($(".commit-files a.active").attr("scrollPos",$(".commit-diff").scrollTop()),$a.is(".loaded"))$a.addClass("active"),setExpandState();else{var $li=$a.closest("[x-file]"),relativeFilePath=$li.attr("x-file"),$diffContainer=$li.find(".commit-diff");Git.getDiffOfFileFromCommit(commit.hash,relativeFilePath,isInitial).then(function(diff){$diffContainer.html(Utils.formatDiff(diff)),$diffContainer.scrollTop($a.attr("scrollPos")||0),$a.addClass("active loaded"),setExpandState()}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_GET_DIFF_FILE_COMMIT)})}}function showDiff($el){var file=$el.closest("[x-file]").attr("x-file");Git.difftoolFromHash(commit.hash,file,isInitial)}function expandAll(){$viewer.find(".commit-files a").not(".active").trigger("click"),Preferences.set("autoExpandDiffsInHistory",!0)}function collapseAll(){$viewer.find(".commit-files a").filter(".active").trigger("click"),Preferences.set("autoExpandDiffsInHistory",!1)}function attachEvents(){$viewer.on("click",".commit-files a",function(){toggleDiff($(this))}).on("click",".commit-files .difftool",function(e){e.stopPropagation(),showDiff($(this))}).on("click",".openFile",function(e){e.stopPropagation();var file=$(this).closest("[x-file]").attr("x-file");Utils.openEditorForFile(file,!0),hide()}).on("click",".close",function(){remove()}).on("click",".git-extend-sha",function(){var $parent=$(this).parent(),sha=$parent.data("hash");$parent.find("span.selectable-text").text(sha),$(this).remove()}).on("click",".toggle-diffs",expandAll).on("click",".toggle-diffs.opened",collapseAll),$viewer.find(".body").on("scroll",function(){$viewer.find(".body").scrollTop()>0?$viewer.find(".header").addClass("shadow"):$viewer.find(".header").removeClass("shadow")}),Preferences.get("autoExpandDiffsInHistory")&&expandAll()}function renderViewerContent(files,selectedFile){var bodyMarkdown=marked(commit.body,{gfm:!0,breaks:!0});if($viewer.html(Mustache.render(historyViewerTemplate,{commit:commit,bodyMarkdown:bodyMarkdown,Strings:Strings})),renderFiles(files),selectedFile){var $fileEntry=$viewer.find(".commit-files li[x-file='"+selectedFile+"'] a").first();$fileEntry.length&&(toggleDiff($fileEntry),window.setTimeout(function(){$viewer.find(".body").animate({scrollTop:$fileEntry.position().top-10})},80))}attachEvents()}function renderFiles(files){$viewer.find(".filesContainer").append(Mustache.render(historyViewerFilesTemplate,{files:files,Strings:Strings,useDifftool:useDifftool})),$viewer.find(".loadMore").toggle(hasNextPage).off("click").on("click",function(){currentPage++,loadMoreFiles()})}function loadMoreFiles(){Git.getFilesFromCommit(commit.hash,isInitial).then(function(files){hasNextPage=files.slice((currentPage+1)*PAGE_SIZE).length>0;var list=(files=files.slice(currentPage*PAGE_SIZE,(currentPage+1)*PAGE_SIZE)).map(function(file){var fileExtension=LanguageManager.getCompoundFileExtension(file),i=file.lastIndexOf("."+fileExtension),fileName;return{name:file.substring(0,fileExtension&&i>=0?i:file.length),extension:fileExtension?"."+fileExtension:"",file:file}}),file;return 0===currentPage?renderViewerContent(list,$("#git-history-list").data("file-relative")):renderFiles(list)}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_GET_DIFF_FILES)}).finally(function(){$viewer.removeClass("spinner large spin")})}function render(){$viewer?($viewer.off("click"),$viewer.find(".body").off("scroll")):($viewer=$("<div>").addClass("git spinner large spin")).appendTo($editorHolder),currentPage=0,loadMoreFiles()}var initialize=_.once(function(){Git.getConfig("diff.tool").then(function(config){useDifftool=!!config})});function toggle(commitInfo,doc,options){const commitHash=commitInfo.hash;return isShown&&commitHash===currentlyViewedCommit?(remove(),!1):(show(commitInfo,doc,options),!0)}function show(commitInfo,doc,options){if(Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"history","detailView"),initialize(),commit=commitInfo,isInitial=options.isInitial,$editorHolder=$("#editor-holder"),render(),currentlyViewedCommit=commitInfo.hash,isShown=!0,$("#first-pane").length){const firstPaneStyle=$("#first-pane").prop("style")&&$("#first-pane").prop("style").cssText?$("#first-pane").prop("style").cssText:"";$("#first-pane").prop("style",firstPaneStyle+";display: none !important;")}if($("#second-pane").length){const secondPaneStyle=$("#second-pane").prop("style")&&$("#second-pane").prop("style").cssText?$("#second-pane").prop("style").cssText:"";$("#second-pane").prop("style",secondPaneStyle+";display: none !important;")}}function onRemove(){isShown=!1,$viewer=null,currentlyViewedCommit=null,$("#first-pane").show(),$("#second-pane").show(),WorkspaceManager.recomputeLayout()}function hide(){isShown&&remove()}function remove(){$viewer.remove(),onRemove()}function isVisible(){return isShown}exports.toggle=toggle,exports.show=show,exports.hide=hide,exports.isVisible=isVisible}),define("src/Main",function(require,exports){const _=brackets.getModule("thirdparty/lodash"),CommandManager=brackets.getModule("command/CommandManager"),Commands=brackets.getModule("command/Commands"),Menus=brackets.getModule("command/Menus"),FileSystem=brackets.getModule("filesystem/FileSystem"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),Metrics=brackets.getModule("utils/Metrics"),ProjectManager=brackets.getModule("project/ProjectManager"),Constants=require("src/Constants"),Events=require("src/Events"),EventEmitter=require("src/EventEmitter"),Strings=brackets.getModule("strings"),StringUtils=brackets.getModule("utils/StringUtils"),ErrorHandler=require("src/ErrorHandler"),Panel=require("src/Panel"),Branch=require("src/Branch"),SettingsDialog=require("src/SettingsDialog"),Dialogs=brackets.getModule("widgets/Dialogs"),CloseNotModified=require("src/CloseNotModified"),Setup=require("src/utils/Setup"),Preferences=require("src/Preferences"),Utils=require("src/Utils"),Git=require("src/git/Git"),gitTagDialogTemplate='<div id="git-commit-dialog" class="modal">\n    <div class="modal-header">\n        <h1 class="dialog-title">{{Strings.TAG_NAME}}</h1>\n    </div>\n    <div class="modal-body table-striped tab-content">\n        <div class="commit-message-box">\n            <input name="commit-message" class="commit-message" type="text" placeholder="{{Strings.TAG_NAME_PLACEHOLDER}}" autocomplete="off"/>\n            <textarea name="commit-message" type="text" placeholder="{{Strings.TAG_NAME_PLACEHOLDER}}" autocomplete="off" style="display: none;"></textarea>\n        </div>\n    </div>\n    <div class="modal-footer">\n        <button data-button-id="cancel" class="dialog-button btn cancel btn-80" >{{Strings.BUTTON_CANCEL}}</button>\n        <button data-button-id="ok"     class="dialog-button btn primary btn-80">{{Strings.BUTTON_OK}}</button>\n    </div>\n</div>\n',CMD_ADD_TO_IGNORE="git.addToIgnore",CMD_REMOVE_FROM_IGNORE="git.removeFromIgnore",$icon=$(`<a id='git-toolbar-icon' title="${Strings.STATUSBAR_SHOW_GIT}" href='#'></a>`).addClass("forced-hidden").prependTo($(".bottom-buttons"));let gitEnabled=!1;function initUi(){Panel.init(),Branch.init(),CloseNotModified.init(),$icon.on("click",Panel.toggle)}function _addRemoveItemInGitignore(selectedEntry,method){var gitRoot=Preferences.get("currentGitRoot"),entryPath="/"+selectedEntry.fullPath.substring(gitRoot.length),gitignoreEntry=FileSystem.getFileForPath(gitRoot+".gitignore");gitignoreEntry.read(function(err,content){err&&(Utils.consoleWarn(err),content="");for(var lines=content.split("\n").map(function(l){return l.trim()});lines.length>0&&!lines[0];)lines.shift();for(;lines.length>0&&!lines[lines.length-1];)lines.pop();"add"===method?-1===lines.indexOf(entryPath)&&lines.push(entryPath):"remove"===method&&(lines=_.without(lines,entryPath)),lines[lines.length-1]&&lines.push(""),gitignoreEntry.write(lines.join("\n"),function(err){if(err)return ErrorHandler.showError(err,Strings.ERROR_MODIFY_GITIGNORE);Panel.refresh()})})}function addItemToGitingore(){return _addRemoveItemInGitignore(ProjectManager.getSelectedItem(),"add")}function removeItemFromGitingore(){return _addRemoveItemInGitignore(ProjectManager.getSelectedItem(),"remove")}function addItemToGitingoreFromPanel(){var filePath=Panel.getPanel().find("tr.selected").attr("x-file"),fileEntry;return _addRemoveItemInGitignore(FileSystem.getFileForPath(Preferences.get("currentGitRoot")+filePath),"add")}function removeItemFromGitingoreFromPanel(){var filePath=Panel.getPanel().find("tr.selected").attr("x-file"),fileEntry;return _addRemoveItemInGitignore(FileSystem.getFileForPath(Preferences.get("currentGitRoot")+filePath),"remove")}function _refreshCallback(){EventEmitter.emit(Events.REFRESH_ALL)}function checkoutCommit(commitHash){const commitDetail=Panel.getSelectedHistoryCommit()||{};commitHash=commitHash||commitDetail.hash;const commitDetailStr=commitDetail.subject||"";if(!commitHash)return void console.error(`Cannot do Git checkout as commit hash is ${commitHash}`);const displayStr=StringUtils.format(Strings.CHECKOUT_COMMIT_DETAIL,commitDetailStr,commitHash);Utils.askQuestion(Strings.TITLE_CHECKOUT,displayStr+"<br><br>"+Strings.DIALOG_CHECKOUT,{booleanResponse:!0,noescape:!0,customOkBtn:Strings.CHECKOUT_COMMIT}).then(function(response){if(!0===response)return Git.checkout(commitHash).then(_refreshCallback)})}function tagCommit(commitHash){const commitDetail=Panel.getSelectedHistoryCommit()||{};commitHash=commitHash||commitDetail.hash||"";const compiledTemplate=Mustache.render(gitTagDialogTemplate,{Strings:Strings}),dialog=Dialogs.showModalDialogUsingTemplate(compiledTemplate),$dialog=dialog.getElement();$dialog.find("input").focus(),$dialog.find("button.primary").on("click",function(){const tagname=$dialog.find("input.commit-message").val();Git.setTagName(tagname,commitHash).then(function(){EventEmitter.emit(Events.REFRESH_HISTORY)}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_CREATE_TAG)})})}function _resetOperation(operation,commitHash,title,message){const commitDetail=Panel.getSelectedHistoryCommit()||{};commitHash=commitHash||commitDetail.hash;const commitDetailStr=commitDetail.subject||"";if(!commitHash)return void console.error(`Cannot do Git Reset ${operation} as commit hash is ${commitHash}`);const gitCmdUsed=`git reset ${operation} ${commitHash}`,displayStr=StringUtils.format(Strings.RESET_DETAIL,commitDetailStr,gitCmdUsed);Utils.askQuestion(title,message+"<br><br>"+displayStr,{booleanResponse:!0,noescape:!0,customOkBtn:Strings.RESET,customOkBtnClass:"danger"}).then(function(response){if(!0===response)return Git.reset(operation,commitHash).then(_refreshCallback)})}function resetHard(commitHash){return _resetOperation("--hard",commitHash,Strings.RESET_HARD_TITLE,Strings.RESET_HARD_MESSAGE)}function resetMixed(commitHash){return _resetOperation("--mixed",commitHash,Strings.RESET_MIXED_TITLE,Strings.RESET_MIXED_MESSAGE)}function resetSoft(commitHash){return _resetOperation("--soft",commitHash,Strings.RESET_SOFT_TITLE,Strings.RESET_SOFT_MESSAGE)}function disableAllMenus(){const commandsToDisable=[Constants.CMD_GIT_INIT,Constants.CMD_GIT_CLONE,Constants.CMD_GIT_TOGGLE_PANEL,Constants.CMD_GIT_REFRESH,Constants.CMD_GIT_GOTO_NEXT_CHANGE,Constants.CMD_GIT_GOTO_PREVIOUS_CHANGE,Constants.CMD_GIT_CLOSE_UNMODIFIED,Constants.CMD_GIT_AUTHORS_OF_SELECTION,Constants.CMD_GIT_AUTHORS_OF_FILE,Constants.CMD_GIT_COMMIT_CURRENT,Constants.CMD_GIT_COMMIT_ALL,Constants.CMD_GIT_FETCH,Constants.CMD_GIT_PULL,Constants.CMD_GIT_PUSH,Constants.CMD_GIT_GERRIT_PUSH_REF,Constants.CMD_GIT_CHANGE_USERNAME,Constants.CMD_GIT_CHANGE_EMAIL,Constants.CMD_GIT_SETTINGS_COMMAND_ID,CMD_ADD_TO_IGNORE,CMD_REMOVE_FROM_IGNORE,CMD_ADD_TO_IGNORE+"2",CMD_REMOVE_FROM_IGNORE+"2",Constants.CMD_GIT_CHECKOUT,Constants.CMD_GIT_TAG,Constants.CMD_GIT_RESET_HARD,Constants.CMD_GIT_RESET_MIXED,Constants.CMD_GIT_RESET_SOFT,Constants.CMD_GIT_DISCARD_ALL_CHANGES,Constants.CMD_GIT_UNDO_LAST_COMMIT,Constants.CMD_GIT_TOGGLE_UNTRACKED,Constants.CMD_GIT_HISTORY_GLOBAL,Constants.CMD_GIT_HISTORY_FILE];commandsToDisable.forEach(cmdId=>{Utils.enableCommand(cmdId,!1)})}function initGitMenu(){const fileMenu=Menus.getMenu(Menus.AppMenuBar.FILE_MENU);let gitSubMenu=fileMenu.addSubMenu(Constants.GIT_STRING_UNIVERSAL,Constants.GIT_SUB_MENU,Menus.AFTER,Commands.FILE_EXTENSION_MANAGER);fileMenu.addMenuDivider(Menus.AFTER,Commands.FILE_EXTENSION_MANAGER),gitSubMenu.addMenuItem(Constants.CMD_GIT_INIT,void 0,void 0,void 0,{hideWhenCommandDisabled:!0}),gitSubMenu.addMenuItem(Constants.CMD_GIT_CLONE,void 0,void 0,void 0,{hideWhenCommandDisabled:!0}),gitSubMenu.addMenuItem(Constants.CMD_GIT_TOGGLE_PANEL),gitSubMenu.addMenuItem(Constants.CMD_GIT_REFRESH),gitSubMenu.addMenuDivider(),gitSubMenu.addMenuItem(Constants.CMD_GIT_GOTO_NEXT_CHANGE),gitSubMenu.addMenuItem(Constants.CMD_GIT_GOTO_PREVIOUS_CHANGE),gitSubMenu.addMenuItem(Constants.CMD_GIT_CLOSE_UNMODIFIED),gitSubMenu.addMenuDivider(),gitSubMenu.addMenuItem(Constants.CMD_GIT_HISTORY_GLOBAL),gitSubMenu.addMenuItem(Constants.CMD_GIT_HISTORY_FILE),gitSubMenu.addMenuDivider(),gitSubMenu.addMenuItem(Constants.CMD_GIT_AUTHORS_OF_SELECTION),gitSubMenu.addMenuItem(Constants.CMD_GIT_AUTHORS_OF_FILE),gitSubMenu.addMenuDivider(),gitSubMenu.addMenuItem(Constants.CMD_GIT_COMMIT_CURRENT),gitSubMenu.addMenuItem(Constants.CMD_GIT_COMMIT_ALL),gitSubMenu.addMenuDivider(),gitSubMenu.addMenuItem(Constants.CMD_GIT_FETCH),gitSubMenu.addMenuItem(Constants.CMD_GIT_PULL),gitSubMenu.addMenuItem(Constants.CMD_GIT_PUSH),gitSubMenu.addMenuDivider(),gitSubMenu.addMenuItem(Constants.CMD_GIT_GERRIT_PUSH_REF),gitSubMenu.addMenuItem(Constants.CMD_GIT_CHANGE_USERNAME),gitSubMenu.addMenuItem(Constants.CMD_GIT_CHANGE_EMAIL),gitSubMenu.addMenuDivider(),gitSubMenu.addMenuItem(Constants.CMD_GIT_SETTINGS_COMMAND_ID),CommandManager.register(Strings.ADD_TO_GITIGNORE,CMD_ADD_TO_IGNORE,addItemToGitingore),CommandManager.register(Strings.REMOVE_FROM_GITIGNORE,CMD_REMOVE_FROM_IGNORE,removeItemFromGitingore);const panelCmenu=Menus.registerContextMenu(Constants.GIT_PANEL_CHANGES_CMENU);CommandManager.register(Strings.ADD_TO_GITIGNORE,CMD_ADD_TO_IGNORE+"2",addItemToGitingoreFromPanel),CommandManager.register(Strings.REMOVE_FROM_GITIGNORE,CMD_REMOVE_FROM_IGNORE+"2",removeItemFromGitingoreFromPanel),panelCmenu.addMenuItem(CMD_ADD_TO_IGNORE+"2"),panelCmenu.addMenuItem(CMD_REMOVE_FROM_IGNORE+"2");const historyCmenu=Menus.registerContextMenu(Constants.GIT_PANEL_HISTORY_CMENU);CommandManager.register(Strings.CHECKOUT_COMMIT,Constants.CMD_GIT_CHECKOUT,checkoutCommit),CommandManager.register(Strings.MENU_RESET_HARD,Constants.CMD_GIT_RESET_HARD,resetHard),CommandManager.register(Strings.MENU_RESET_MIXED,Constants.CMD_GIT_RESET_MIXED,resetMixed),CommandManager.register(Strings.MENU_RESET_SOFT,Constants.CMD_GIT_RESET_SOFT,resetSoft),CommandManager.register(Strings.MENU_TAG_COMMIT,Constants.CMD_GIT_TAG,tagCommit),historyCmenu.addMenuItem(Constants.CMD_GIT_CHECKOUT),historyCmenu.addMenuItem(Constants.CMD_GIT_TAG),historyCmenu.addMenuDivider(),historyCmenu.addMenuItem(Constants.CMD_GIT_RESET_HARD),historyCmenu.addMenuItem(Constants.CMD_GIT_RESET_MIXED),historyCmenu.addMenuItem(Constants.CMD_GIT_RESET_SOFT);const optionsCmenu=Menus.registerContextMenu(Constants.GIT_PANEL_OPTIONS_CMENU);Menus.ContextMenu.assignContextMenuToSelector(".git-more-options-btn",optionsCmenu),optionsCmenu.addMenuItem(Constants.CMD_GIT_DISCARD_ALL_CHANGES),optionsCmenu.addMenuItem(Constants.CMD_GIT_UNDO_LAST_COMMIT),optionsCmenu.addMenuDivider(),optionsCmenu.addMenuItem(Constants.CMD_GIT_HISTORY_GLOBAL),optionsCmenu.addMenuItem(Constants.CMD_GIT_HISTORY_FILE),optionsCmenu.addMenuDivider(),optionsCmenu.addMenuItem(Constants.CMD_GIT_AUTHORS_OF_SELECTION),optionsCmenu.addMenuItem(Constants.CMD_GIT_AUTHORS_OF_FILE),optionsCmenu.addMenuDivider(),optionsCmenu.addMenuItem(Constants.CMD_GIT_FETCH),optionsCmenu.addMenuItem(Constants.CMD_GIT_PULL),optionsCmenu.addMenuItem(Constants.CMD_GIT_PUSH),optionsCmenu.addMenuDivider(),optionsCmenu.addMenuItem(Constants.CMD_GIT_TOGGLE_UNTRACKED),optionsCmenu.addMenuItem(Constants.CMD_GIT_GERRIT_PUSH_REF),optionsCmenu.addMenuItem(Constants.CMD_GIT_CHANGE_USERNAME),optionsCmenu.addMenuItem(Constants.CMD_GIT_CHANGE_EMAIL),optionsCmenu.addMenuDivider(),optionsCmenu.addMenuItem(Constants.CMD_GIT_SETTINGS_COMMAND_ID),Setup.isExtensionActivated()||disableAllMenus()}function init(){return CommandManager.register(Strings.GIT_SETTINGS,Constants.CMD_GIT_SETTINGS_COMMAND_ID,SettingsDialog.show),Setup.init().then(function(enabled){return initUi(),initGitMenu(),enabled})}EventEmitter.on(Events.GIT_DISABLED,function(){$icon.removeClass("dirty")}),EventEmitter.on(Events.GIT_STATUS_RESULTS,function(sortedResults){$icon.toggleClass("dirty",0!==sortedResults.length)});var _toggleMenuEntriesState=!1,_divider1=null,_divider2=null;function toggleMenuEntries(bool){if(bool!==_toggleMenuEntriesState){var projectCmenu=Menus.getContextMenu(Menus.ContextMenuIds.PROJECT_MENU),workingCmenu=Menus.getContextMenu(Menus.ContextMenuIds.WORKING_SET_CONTEXT_MENU);bool?(_divider1=projectCmenu.addMenuDivider(),_divider2=workingCmenu.addMenuDivider(),projectCmenu.addMenuItem(CMD_ADD_TO_IGNORE),workingCmenu.addMenuItem(CMD_ADD_TO_IGNORE),projectCmenu.addMenuItem(CMD_REMOVE_FROM_IGNORE),workingCmenu.addMenuItem(CMD_REMOVE_FROM_IGNORE)):(projectCmenu.removeMenuDivider(_divider1.id),workingCmenu.removeMenuDivider(_divider2.id),projectCmenu.removeMenuItem(CMD_ADD_TO_IGNORE),workingCmenu.removeMenuItem(CMD_ADD_TO_IGNORE),projectCmenu.removeMenuItem(CMD_REMOVE_FROM_IGNORE),workingCmenu.removeMenuItem(CMD_REMOVE_FROM_IGNORE)),_toggleMenuEntriesState=bool}}function _enableAllCommands(enabled){Utils.enableCommand(Constants.CMD_GIT_REFRESH,enabled),Utils.enableCommand(Constants.CMD_GIT_GOTO_NEXT_CHANGE,enabled),Utils.enableCommand(Constants.CMD_GIT_GOTO_PREVIOUS_CHANGE,enabled),Utils.enableCommand(Constants.CMD_GIT_CLOSE_UNMODIFIED,enabled),Utils.enableCommand(Constants.CMD_GIT_AUTHORS_OF_SELECTION,enabled),Utils.enableCommand(Constants.CMD_GIT_AUTHORS_OF_FILE,enabled),Utils.enableCommand(Constants.CMD_GIT_HISTORY_GLOBAL,enabled),Utils.enableCommand(Constants.CMD_GIT_HISTORY_FILE,enabled),Utils.enableCommand(Constants.CMD_GIT_COMMIT_CURRENT,enabled),Utils.enableCommand(Constants.CMD_GIT_COMMIT_ALL,enabled),Utils.enableCommand(Constants.CMD_GIT_FETCH,enabled),Utils.enableCommand(Constants.CMD_GIT_PULL,enabled),Utils.enableCommand(Constants.CMD_GIT_PUSH,enabled),Utils.enableCommand(Constants.CMD_GIT_DISCARD_ALL_CHANGES,enabled),Utils.enableCommand(Constants.CMD_GIT_UNDO_LAST_COMMIT,enabled),toggleMenuEntries(enabled),enabled?$icon.removeClass("forced-hidden"):$("#git-panel").is(":visible")||$icon.addClass("forced-hidden")}let isCommandExecuting=!1,scheduledRefresh=null;const REFRESH_DEDUPE_TIME=3e3;function refreshOnFocusChange(){if(gitEnabled){const isGitPanelVisible=Panel.getPanel().is(":visible");if(isCommandExecuting)return void(scheduledRefresh||(scheduledRefresh=setTimeout(()=>{scheduledRefresh=null,refreshOnFocusChange()},REFRESH_DEDUPE_TIME)));isCommandExecuting=!0,isGitPanelVisible?CommandManager.execute(Constants.CMD_GIT_REFRESH).fail(err=>{console.error("error refreshing on focus switch",err)}).always(()=>{isCommandExecuting=!1,scheduledRefresh&&(clearTimeout(scheduledRefresh),scheduledRefresh=null,refreshOnFocusChange())}):(Branch.refresh(),isCommandExecuting=!1,scheduledRefresh&&(clearTimeout(scheduledRefresh),scheduledRefresh=null,refreshOnFocusChange()))}}$(window).focus(refreshOnFocusChange);let projectSwitched=!0;EventEmitter.on(Events.BRACKETS_PROJECT_CHANGE,function(){projectSwitched=!0}),EventEmitter.on(Events.GIT_ENABLED,function(){_enableAllCommands(!0),gitEnabled=!0,projectSwitched&&Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"enabled","project"),projectSwitched=!1}),EventEmitter.on(Events.GIT_DISABLED,function(){_enableAllCommands(!1),gitEnabled=!1}),exports.$icon=$icon,exports.init=init}),define("src/NoRepo",function(require){const FileSystem=brackets.getModule("filesystem/FileSystem"),FileUtils=brackets.getModule("file/FileUtils"),ProjectManager=brackets.getModule("project/ProjectManager"),CommandManager=brackets.getModule("command/CommandManager"),Metrics=brackets.getModule("utils/Metrics"),Strings=brackets.getModule("strings"),StringUtils=brackets.getModule("utils/StringUtils"),ErrorHandler=require("src/ErrorHandler"),Events=require("src/Events"),EventEmitter=require("src/EventEmitter"),ExpectedError=require("src/ExpectedError"),ProgressDialog=require("src/dialogs/Progress"),CloneDialog=require("src/dialogs/Clone"),Git=require("src/git/Git"),Preferences=require("src/Preferences"),Constants=require("src/Constants"),Utils=require("src/Utils");var gitignoreTemplate="# https://git-scm.com/docs/gitignore\n# https://help.github.com/articles/ignoring-files\n# Example .gitignore files: https://github.com/github/gitignore\n/bower_components/\n/node_modules/";function createGitIgnore(){var gitIgnorePath=Preferences.get("currentGitRoot")+".gitignore";return Utils.pathExists(gitIgnorePath).then(function(exists){if(!exists)return jsPromise(FileUtils.writeText(FileSystem.getFileForPath(gitIgnorePath),gitignoreTemplate))})}function stageGitIgnore(){return createGitIgnore().then(function(){return Git.stage(".gitignore")})}function handleGitInit(){Utils.isProjectRootWritable().then(function(writable){if(!writable){const initPath=Phoenix.app.getDisplayPath(Utils.getProjectRoot()),errorStr=StringUtils.format(Strings.FOLDER_NOT_WRITABLE,initPath);throw new ExpectedError(errorStr)}return Git.init().catch(function(err){return new Promise((resolve,reject)=>{ErrorHandler.contains(err,"Please tell me who you are")?EventEmitter.emit(Events.GIT_CHANGE_USERNAME,function(){EventEmitter.emit(Events.GIT_CHANGE_EMAIL,function(){Git.init().then(function(result){resolve(result)}).catch(function(error){reject(error)})})}):reject(err)})})}).then(function(){return Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"init","success"),stageGitIgnore("Initial staging")}).catch(function(err){ErrorHandler.showError(err,Strings.INIT_NEW_REPO_FAILED,{dontStripError:!0}),Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"init","fail")}).then(function(){EventEmitter.emit(Events.REFRESH_ALL)})}function isProjectRootEmpty(){return new Promise(function(resolve,reject){ProjectManager.getProjectRoot().getContents(function(err,entries){if(err)return reject(err);resolve(0===entries.length)})})}function handleGitClone(gitCloneURL,destPath){var $gitPanel,$cloneButton=$("#git-panel").find(".git-clone");$cloneButton.prop("disabled",!0),isProjectRootEmpty().then(function(isEmpty){if(isEmpty){if(gitCloneURL)return _clone({remote:"origin",remoteUrlNew:gitCloneURL});CloneDialog.show().then(_clone).catch(function(err){err&&ErrorHandler.showError(err,Strings.GIT_CLONE_REMOTE_FAILED)})}else{const clonePath=Phoenix.app.getDisplayPath(Utils.getProjectRoot()),err=new ExpectedError(StringUtils.format(Strings.GIT_CLONE_ERROR_EXPLAIN,clonePath));ErrorHandler.showError(err,Strings.GIT_CLONE_REMOTE_FAILED,{dontStripError:!0})}function _clone(cloneConfig){var q=Promise.resolve(),remoteUrl=cloneConfig.remoteUrl;return cloneConfig.remoteUrlNew&&(remoteUrl=cloneConfig.remoteUrlNew),q=q.then(function(){const tracker=ProgressDialog.newProgressTracker();return destPath=destPath?fs.getTauriPlatformPath(destPath):".",ProgressDialog.show(Git.clone(remoteUrl,destPath,tracker),tracker)}).then(()=>{Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"clone","success")}).catch(function(err){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"clone","fail"),ErrorHandler.showError(err,Strings.GIT_CLONE_REMOTE_FAILED,{errorMetric:"clone"})}),cloneConfig.remoteUrlRestore&&(q=q.then(function(){return Git.setRemoteUrl(cloneConfig.remote,cloneConfig.remoteUrlRestore)})),q.finally(function(){EventEmitter.emit(Events.REFRESH_ALL)})}}).catch(function(err){ErrorHandler.showError(err)}).finally(function(){$cloneButton.prop("disabled",!1)})}CommandManager.register(Strings.GIT_CLONE,Constants.CMD_GIT_CLONE_WITH_URL,handleGitClone),EventEmitter.on(Events.HANDLE_GIT_INIT,function(){handleGitInit()}),EventEmitter.on(Events.HANDLE_GIT_CLONE,function(){handleGitClone()}),EventEmitter.on(Events.GIT_NO_BRANCH_EXISTS,function(){stageGitIgnore()})}),define("src/Panel",function(require,exports){const _=brackets.getModule("thirdparty/lodash"),StateManager=brackets.getModule("preferences/StateManager"),CodeInspection=brackets.getModule("language/CodeInspection"),CommandManager=brackets.getModule("command/CommandManager"),Commands=brackets.getModule("command/Commands"),Dialogs=brackets.getModule("widgets/Dialogs"),DocumentManager=brackets.getModule("document/DocumentManager"),EditorManager=brackets.getModule("editor/EditorManager"),FileViewController=brackets.getModule("project/FileViewController"),FileSystem=brackets.getModule("filesystem/FileSystem"),Menus=brackets.getModule("command/Menus"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),FindInFiles=brackets.getModule("search/FindInFiles"),WorkspaceManager=brackets.getModule("view/WorkspaceManager"),ProjectManager=brackets.getModule("project/ProjectManager"),StringUtils=brackets.getModule("utils/StringUtils"),Strings=brackets.getModule("strings"),Metrics=brackets.getModule("utils/Metrics"),NotificationUI=brackets.getModule("widgets/NotificationUI"),Constants=require("src/Constants"),Git=require("src/git/Git"),Events=require("./Events"),EventEmitter=require("./EventEmitter"),Preferences=require("./Preferences"),Setup=require("src/utils/Setup"),ErrorHandler=require("./ErrorHandler"),ExpectedError=require("./ExpectedError"),Main=require("./Main"),GutterManager=require("./GutterManager"),Utils=require("src/Utils"),ProgressDialog=require("src/dialogs/Progress"),gitPanelTemplate='<div id="git-panel" class="git bottom-panel vert-resizable top-resizer no-focus">\n    <div class="toolbar simple-toolbar-layout mainToolbar">\n\n        \x3c!-- on left --\x3e\n        <input type="checkbox" class="check-all git-available" />\n        <div class="btn-group git-available">\n            <button title="{{S.TOOLTIP_COMMIT}}" class="btn small git-commit" disabled><i class="octicon octicon-git-commit"></i><span>{{S.BUTTON_COMMIT}}</span></button>\n        </div>\n        <div class="git-available padding-right-small">\n            <div class="btn-group git-rebase">\n                <button title="{{S.TOOLTIP_REBASE_CONTINUE}}" class="btn small git-rebase-continue">\n                    <i class="octicon octicon-git-commit"></i><span>{{S.BUTTON_REBASE_CONTINUE}}</span>\n                </button>\n                <button title="{{S.TOOLTIP_REBASE_SKIP}}" class="btn small git-rebase-skip">\n                    <span>{{S.BUTTON_REBASE_SKIP}}</span>\n                </button>\n                <button title="{{S.TOOLTIP_REBASE_ABORT}}" class="btn small git-rebase-abort">\n                    <span>{{S.BUTTON_REBASE_ABORT}}</span>\n                </button>\n                \x3c!--\n                <button title="{{S.TOOLTIP_FIND_CONFLICTS}}" class="btn small git-find-conflicts">\n                    <span>{{S.BUTTON_FIND_CONFLICTS}}</span>\n                </button>\n                --\x3e\n            </div>\n        </div>\n        <div class="git-available padding-right-small">\n            <div class="btn-group git-merge">\n                <button title="{{S.TOOLTIP_COMMIT}}" class="btn small git-commit-merge">\n                    <i class="octicon octicon-git-commit"></i><span>{{S.BUTTON_COMMIT}}</span>\n                </button>\n                <button title="{{S.TOOLTIP_MERGE_ABORT}}" class="btn small git-merge-abort">\n                    <span>{{S.BUTTON_MERGE_ABORT}}</span>\n                </button>\n                \x3c!--\n                <button title="{{S.TOOLTIP_FIND_CONFLICTS}}" class="btn small git-find-conflicts">\n                    <span>{{S.BUTTON_FIND_CONFLICTS}}</span>\n                </button>\n                --\x3e\n            </div>\n        </div>\n        <div class="btn-group git-available hide-when-x-small">\n            <button title="{{S.GOTO_PREVIOUS_GIT_CHANGE}}" class="btn small git-prev-gutter"><i class="octicon octicon-arrow-up"></i></button>\n            <button title="{{S.GOTO_NEXT_GIT_CHANGE}}" class="btn small git-next-gutter"><i class="octicon octicon-arrow-down"></i></button>\n        </div>\n        <div class="btn-group git-available hide-when-x-small">\n            <button title="{{S.TOOLTIP_SHOW_HISTORY}}" class="btn small git-history-toggle"><i class="octicon octicon-history"></i></button>\n            <button title="{{S.TOOLTIP_SHOW_FILE_HISTORY}}" class="btn small git-file-history"><i class="octicon octicon-file-text"></i></button>\n        </div>\n        <div class="btn-group git-not-available">\n          <button title="{{S.TOOLTIP_INIT}}" class="btn small git-init"><i class="octicon octicon-repo-create"></i><span>{{S.GIT_INIT}}</span></button>\n          <button title="{{S.TOOLTIP_CLONE}}" class="btn small git-clone"><i class="octicon octicon-repo-clone"></i><span>{{S.GIT_CLONE}}</span></button>\n        </div>\n        \x3c!-- this should be last on left --\x3e\n        <div class="btn-group git-available hide-when-x-small">\n            <button title="{{S.TOOLTIP_REFRESH_PANEL}}" class="btn small git-refresh git-icon"><i class="octicon octicon-sync"></i></button>\n        </div>\n        \x3c!-- on right --\x3e\n        <div class="git-right-icons hide-when-small">\n            <div class="btn-group git-available dropup">\n                <ul class="dropdown-menu git-remotes-dropdown"></ul>\n                <button type="button" class="git-remotes btn small dropdown-toggle" data-toggle="dropdown" title="{{S.TOOLTIP_PICK_REMOTE}}">\n                    <span class="caret"></span>\n                    <span class="git-selected-remote">&mdash;</span>\n                </button>\n                <button title="{{S.TOOLTIP_FETCH}}" class="btn small git-fetch"><i class="octicon octicon-cloud-download"></i></button>\n                <button title="{{S.TOOLTIP_PULL}}" class="btn small git-pull"><i class="octicon octicon-repo-pull"></i></button>\n                <button title="{{S.TOOLTIP_PUSH}}" class="btn small git-push"><i class="octicon octicon-repo-push"></i></button>\n            </div>\n        </div>\n        <div class="git-more-options-btn btn-alt-quiet"><i class="fa-solid fa-ellipsis-vertical"></i></div>\n        <a href="#" class="close">&times;</a>\n\n    </div>\n    <div class="table-container" style="height: calc(100% - 42px);"></div>\n</div>\n',gitPanelResultsTemplate='<table class="git-edited-list bottom-panel-table table table-striped table-condensed row-highlight">\n    <tbody>\n        {{#files}}\n        <tr class="modified-file" x-file="{{file}}" x-status="{{status}}">\n            <td class="checkbox-column"><input type="checkbox" class="check-one" {{#staged}}checked="true"{{/staged}} /></td>\n            <td class="icons-column">\n                {{#allowDiff}}<button class="btn btn-mini btn-git-diff" title="{{Strings.DIFF}}"><i class="octicon octicon-diff"></i></button>{{/allowDiff}}\n            </td>\n            <td class="status-column">{{statusText}}</td>\n            <td>{{display}}</td>\n            <td>\n                <div class="btn-group">\n                    {{#allowUndo}}   <button class="btn btn-mini btn-git-undo">{{Strings.UNDO_CHANGES_BTN}}</button>  {{/allowUndo}}\n                    {{#allowDelete}} <button class="btn btn-mini btn-git-delete">{{Strings.DELETE_FILE_BTN}}</button> {{/allowDelete}}\n                </div>\n            </td>\n        </tr>\n        {{/files}}\n    </tbody>\n</table>\n',gitAuthorsDialogTemplate='<div id="git-authors-dialog" class="modal">\n    <div class="modal-header">\n        <h1 class="dialog-title">{{Strings.AUTHORS_OF}} {{file}}</h1>\n    </div>\n    <div class="modal-body tab-content">\n        <table class="table table-condensed">\n            <tr>\n                <th>\n                    {{String.AUTHOR}}\n                </th>\n                <th>\n                </th>\n            </tr>\n            {{#blameStats}}\n            <tr>\n                <td>\n                    {{authorName}}\n                </td>\n                <td>\n                    {{percentage}}% ({{lines}} {{Strings._LINES}})\n                </td>\n            </tr>\n            {{/blameStats}}\n        </table>\n    </div>\n    <div class="modal-footer">\n        <button data-button-id="close" class="dialog-button btn btn-80">{{Strings.BUTTON_CLOSE}}</button>\n    </div>\n</div>\n',gitCommitDialogTemplate='<div id="git-commit-dialog" class="modal">\n    <div class="modal-header">\n        <button class="extendedCommit btn pull-right">{{Strings.EXTENDED_COMMIT_MESSAGE}}</button>\n        <label class="checkbox pull-right" style="line-height: 28px; margin-right: 50px;">\n            <input class="amend-commit" type="checkbox" style="margin-top: 10px;" /> {{Strings.AMEND_COMMIT}}\n        </label>\n        <h1 class="dialog-title">{{Strings.GIT_COMMIT}}</h1>\n    </div>\n    <div class="modal-body table-striped tab-content">\n        <div>\n            <div class="accordion">\n                \x3c!-- Hidden checkbox to toggle the accordion --\x3e\n                <input type="checkbox" id="codeInspectionToggle" class="accordion-toggle" />\n                <label for="codeInspectionToggle" class="accordion-header">\n                    <span class="accordion-title">{{Strings.CODE_INSPECTION_IN_PROGRESS}}</span>\n                    <i class="fas fa-chevron-down"></i>\n                    <div class="accordion-progress-bar">\n                        <div class="accordion-progress-bar-inner"></div>\n                    </div>\n                </label>\n                <div class="accordion-content lint-errors">\n                    {{Strings.PLEASE_WAIT}}\n                </div>\n            </div>\n        </div>\n        <div class="commit-diff"></div>\n        <div class="commit-message-box">\n            <input name="commit-message" type="text" placeholder="{{Strings.COMMIT_MESSAGE_PLACEHOLDER}}" autocomplete="off" />\n            <textarea name="commit-message" type="text" placeholder="{{Strings.COMMIT_MESSAGE_PLACEHOLDER}}" autocomplete="off" style="display: none;"></textarea>\n            <input name="commit-message-count" readonly="readonly" type="text" tabindex="-1" />\n        </div>\n    </div>\n    <div class="modal-footer">\n        <label class="checkbox pull-left" style="line-height: 28px; margin-right: 50px;">\n            <input class="commit-no-verify" type="checkbox" style="margin-top: 10px;" /> {{Strings.SKIP_COMMIT_CHECKS}}\n        </label>\n        <button data-button-id="cancel" class="dialog-button btn cancel btn-80" >{{Strings.BUTTON_CANCEL}}</button>\n        <button data-button-id="ok"     class="dialog-button btn primary btn-80">{{Strings.BUTTON_OK}}</button>\n    </div>\n</div>\n',gitCommitLintResultTemplate='<ul>\n    {{#lintResults}}\n    {{#hasErrors}}\n    <li>\n        {{filename}}\n        <ul>\n            {{#errors}}\n            <li>\n                <a class="lint-error-commit-link" data-file="{{file}}" data-line="{{line}}" data-ch="{{ch}}" style="cursor: pointer">\n                    {{errorLineMessage}}\n                </a>\n            </li>\n            {{/errors}}\n        </ul>\n    </li>\n    {{/hasErrors}}\n    {{/lintResults}}\n</ul>\n',gitDiffDialogTemplate='<div id="git-diff-dialog" class="modal">\n    <div class="modal-header">\n        <h1 class="dialog-title">{{{Strings.GIT_DIFF}}} {{file}}</h1>\n    </div>\n    <div class="modal-body table-striped tab-content">\n        <div class="commit-diff"></div>\n    </div>\n    <div class="modal-footer">\n        <button data-button-id="close" class="dialog-button btn btn-80">{{Strings.BUTTON_CLOSE}}</button>\n    </div>\n</div>\n',questionDialogTemplate='<div id="git-question-dialog" class="modal">\n    <div class="modal-header">\n        <h1 class="dialog-title">{{title}}</h1>\n    </div>\n    <div class="modal-body table-striped tab-content">\n        <p>{{{question}}}</p>\n        {{#stringInput}}\n        <input class="stringInput" type="text" value="{{defaultValue}}" autocomplete="off" spellcheck="false" />\n        {{/stringInput}}\n        {{#passwordInput}}\n        <input class="stringInput" type="password" value="{{defaultValue}}" autocomplete="off" spellcheck="false" />\n        {{/passwordInput}}\n    </div>\n    <div class="modal-footer">\n        <button data-button-id="cancel" class="dialog-button btn cancel btn-80" >{{Strings.BUTTON_CANCEL}}</button>\n        <button data-button-id="ok"     class="dialog-button btn btn-80 {{#customOkBtnClass}}{{customOkBtnClass}}{{/customOkBtnClass}}{{^customOkBtnClass}}primary{{/customOkBtnClass}}">\n            {{#customOkBtn}}{{customOkBtn}}{{/customOkBtn}}{{^customOkBtn}}{{Strings.BUTTON_OK}}{{/customOkBtn}}\n        </button>\n    </div>\n</div>\n',showFileWhiteList=/^\.gitignore$/,GIT_PANEL_SHOWN_ON_FIRST_BOOT="GIT_PANEL_SHOWN_ON_FIRST_BOOT",COMMIT_MODE={CURRENT:"CURRENT",ALL:"ALL",DEFAULT:"DEFAULT"};var gitPanel=null,$gitPanel=$(null),$mainToolbar,gitPanelDisabled=null,gitPanelMode=null,showingUntracked=!0,$tableContainer=$(null),lastCommitMessage={};function lintFile(filename){var fullPath=Preferences.get("currentGitRoot")+filename,codeInspectionPromise;try{codeInspectionPromise=CodeInspection.inspectFile(FileSystem.getFileForPath(fullPath))}catch(e){ErrorHandler.logError("CodeInspection.inspectFile failed to execute for file "+fullPath),ErrorHandler.logError(e),codeInspectionPromise=Promise.reject(e)}return jsPromise(codeInspectionPromise)}function _makeDialogBig($dialog){var $wrapper;0!==$dialog.parents(".modal-wrapper").first().length&&$dialog.width("80%").children(".modal-body").css("max-height","72vh").end()}function _showCommitDialog(stagedDiff,prefilledMessage,commitMode,files){const compiledTemplate=Mustache.render(gitCommitDialogTemplate,{Strings:Strings}),dialog=Dialogs.showModalDialogUsingTemplate(compiledTemplate),$dialog=dialog.getElement();Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"commit","showDialog");let totalLintErrors=0;inspectFiles(files,$dialog).then(function(lintResults){(lintResults=lintResults||[]).forEach(function(lintResult){lintResult.errors=[];const lintingFilePath=path.join(ProjectManager.getProjectRoot().fullPath,lintResult.filename);Array.isArray(lintResult.result)?lintResult.result.forEach(function(resultSet){if(resultSet.result&&resultSet.result.errors){var providerName=resultSet.provider.name;resultSet.result.errors.forEach(function(e){lintResult.errors.push({errorLineMessage:e.pos.line+1+": "+e.message+" ("+providerName+")",line:e.pos.line,ch:e.pos.ch,file:lintingFilePath})})}}):ErrorHandler.logError("[brackets-git] lintResults contain object in unexpected format: "+JSON.stringify(lintResult)),lintResult.hasErrors=lintResult.errors.length>0,totalLintErrors+=lintResult.errors.length}),Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"commit","lintErr"+Metrics.getRangeName(totalLintErrors)),lintResults=_.filter(lintResults,function(lintResult){return lintResult.hasErrors});const compiledResultHTML=Mustache.render(gitCommitLintResultTemplate,{Strings:Strings,lintResults:lintResults});if($dialog&&$dialog.is(":visible")){if($dialog.find(".accordion-title").html(Strings.CODE_INSPECTION_PROBLEMS),!lintResults.length)return $dialog.find(".lint-errors").html(Strings.CODE_INSPECTION_PROBLEMS_NONE),void $dialog.find(".accordion").addClass("forced-hidden");$dialog.find(".lint-errors").html(compiledResultHTML),$dialog.find(".lint-errors").is(":visible")||$dialog.find(".accordion-toggle").click(),$dialog.find(".lint-error-commit-link").click(e=>{e.preventDefault();const $el=$(e.target),fileToOpen=$el.data("file"),line=$el.data("line"),ch=$el.data("ch");CommandManager.execute(Commands.FILE_OPEN,{fullPath:fileToOpen}).done(()=>{EditorManager.getCurrentFullEditor().setCursorPos(line,ch,!0)}),dialog.close()})}}),_makeDialogBig($dialog);const diff=Utils.formatDiff(stagedDiff);diff===Utils.FORMAT_DIFF_TOO_LARGE&&Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"commit","diffTooLarge"),$dialog.find(".commit-diff").append(diff);var toggleAmendCheckbox=function(bool){$dialog.find(".amend-commit").prop("disabled",!bool).parent().attr("title",bool?null:Strings.AMEND_COMMIT_FORBIDDEN)};function getCommitMessageElement(){var r=$dialog.find("[name='commit-message']:visible");if(1!==r.length){r=$dialog.find("[name='commit-message']");for(var i=0;i<r.length;i++)if("none"!==$(r[i]).css("display"))return $(r[i])}return r}toggleAmendCheckbox(!1),Git.getCommitCounts().then(function(commits){var hasRemote=null!=$gitPanel.find(".git-selected-remote").data("remote"),hasCommitsAhead=commits.ahead>0;toggleAmendCheckbox(!hasRemote||hasRemote&&hasCommitsAhead)}).catch(function(err){ErrorHandler.logError(err)});var $commitMessageCount=$dialog.find("input[name='commit-message-count']"),recalculateMessageLength=function(){var val=getCommitMessageElement().val().trim(),length=val.length;val.indexOf("\n")&&(length=Math.max.apply(null,val.split("\n").map(function(l){return l.length}))),$commitMessageCount.val(length).toggleClass("over50",length>50&&length<=100).toggleClass("over100",length>100)},usingTextArea=!1;function switchCommitMessageElement(){usingTextArea=!usingTextArea;var findStr="[name='commit-message']",currentValue=$dialog.find(findStr+":visible").val();$dialog.find(findStr).toggle(),$dialog.find(findStr+":visible").val(currentValue).focus(),recalculateMessageLength()}function prefillMessage(msg){-1===msg.indexOf("\n")||usingTextArea||switchCommitMessageElement(),$dialog.find("[name='commit-message']:visible").val(msg),recalculateMessageLength()}$dialog.find("button.primary").on("click",function(e){var $commitMessage=getCommitMessageElement();0===$commitMessage.val().trim().length?(e.stopPropagation(),$commitMessage.addClass("invalid")):$commitMessage.removeClass("invalid")}),$dialog.find("button.extendedCommit").on("click",function(){switchCommitMessageElement(),Preferences.set("useTextAreaForCommitByDefault",usingTextArea)}),$dialog.find(".amend-commit").on("click",function(){!1===$(this).prop("checked")?prefillMessage(""):Git.getLastCommitMessage().then(function(msg){prefillMessage(msg)})}),Preferences.get("useTextAreaForCommitByDefault")&&switchCommitMessageElement(),prefilledMessage&&prefillMessage(prefilledMessage.trim()),getCommitMessageElement().focus(),$dialog.find("[name='commit-message']").on("keyup",recalculateMessageLength).on("change",recalculateMessageLength),recalculateMessageLength(),dialog.done(function(buttonId){const commitMessageElement=getCommitMessageElement();if(commitMessageElement&&(lastCommitMessage[ProjectManager.getProjectRoot().fullPath]=commitMessageElement.val()),"ok"===buttonId)if(commitMode===COMMIT_MODE.ALL||commitMode===COMMIT_MODE.CURRENT){var filePaths=_.map(files,function(next){return next.file});Git.stage(filePaths).then(function(){return _getStagedDiff()}).then(function(diff){_doGitCommit($dialog,getCommitMessageElement,diff)}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_CANT_GET_STAGED_DIFF)})}else _doGitCommit($dialog,getCommitMessageElement,stagedDiff);else Git.status()})}function _doGitCommit($dialog,getCommitMessageElement,stagedDiff){var commitMessage=getCommitMessageElement().val(),amendCommit=$dialog.find(".amend-commit").prop("checked"),noVerify=$dialog.find(".commit-no-verify").prop("checked"),s=commitMessage.split("\n");s.length>1&&""!==s[1].trim()&&s.splice(1,0,""),commitMessage=s.join("\n"),lastCommitMessage[ProjectManager.getProjectRoot().fullPath]=commitMessage,_getStagedDiff().then(function(diff){if(diff===stagedDiff){const tracker=ProgressDialog.newProgressTracker();return ProgressDialog.show(Git.commit(commitMessage,amendCommit,noVerify,tracker),tracker,{title:Strings.GIT_COMMIT_IN_PROGRESS,options:{preDelay:1,postDelay:1}}).then(function(){lastCommitMessage[ProjectManager.getProjectRoot().fullPath]=null})}throw new ExpectedError(Strings.ERROR_MODIFIED_DIALOG_FILES)}).then(()=>{Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"commit","success")}).catch(function(err){if(ErrorHandler.contains(err,"Please tell me who you are"))return new Promise(resolve=>{EventEmitter.emit(Events.GIT_CHANGE_USERNAME,function(){EventEmitter.emit(Events.GIT_CHANGE_EMAIL,function(){resolve()})})});ErrorHandler.showError(err,Strings.ERROR_GIT_COMMIT_FAILED,{errorMetric:"commit"}),Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"commit","fail")}).finally(function(){EventEmitter.emit(Events.GIT_COMMITED),refresh()})}function _showAuthors(file,blame,fromLine,toLine){var linesTotal=blame.length,blameStats=blame.reduce(function(stats,lineInfo){var name=lineInfo.author+" "+lineInfo["author-mail"];return stats[name]?stats[name]+=1:stats[name]=1,stats},{});blameStats=_.reduce(blameStats,function(arr,val,key){return arr.push({authorName:key,lines:val,percentage:Math.round(val/(linesTotal/100))}),arr},[]),blameStats=_.sortBy(blameStats,"lines").reverse(),(fromLine||toLine)&&(file+=" ("+Strings.LINES+" "+fromLine+"-"+toLine+")");var compiledTemplate=Mustache.render(gitAuthorsDialogTemplate,{file:file,blameStats:blameStats,Strings:Strings});Dialogs.showModalDialogUsingTemplate(compiledTemplate)}function _getCurrentFilePath(editor){var gitRoot=Preferences.get("currentGitRoot"),document,filePath=(editor?editor.document:DocumentManager.getCurrentDocument()).file.fullPath;return 0===filePath.indexOf(gitRoot)&&(filePath=filePath.substring(gitRoot.length)),filePath}function handleAuthorsSelection(){var editor=EditorManager.getActiveEditor(),filePath=_getCurrentFilePath(editor),currentSelection=editor.getSelection(),fromLine=currentSelection.start.line+1,toLine=currentSelection.end.line+1,isSomethingSelected;0===currentSelection.end.ch&&(toLine-=1),currentSelection.start.line!==currentSelection.end.line||currentSelection.start.ch!==currentSelection.end.ch?editor.document.isDirty?ErrorHandler.showError(new ExpectedError(Strings.ERROR_SAVE_FIRST)):Git.getBlame(filePath,fromLine,toLine).then(function(blame){return _showAuthors(filePath,blame,fromLine,toLine)}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_GIT_BLAME_FAILED)}):ErrorHandler.showError(new ExpectedError(Strings.ERROR_NOTHING_SELECTED))}function handleAuthorsFile(){var filePath=_getCurrentFilePath();Git.getBlame(filePath).then(function(blame){return _showAuthors(filePath,blame)}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_GIT_BLAME_FAILED)})}function handleGitDiff(file){Preferences.get("useDifftool")?Git.difftool(file):Git.diffFileNice(file).then(function(diff){var compiledTemplate=Mustache.render(gitDiffDialogTemplate,{file:file,Strings:Strings}),dialog,$dialog=Dialogs.showModalDialogUsingTemplate(compiledTemplate).getElement();_makeDialogBig($dialog);const diffVal=Utils.formatDiff(diff);diffVal===Utils.FORMAT_DIFF_TOO_LARGE?Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"diffBtn","diffTooLarge"):Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"diffBtn","success"),$dialog.find(".commit-diff").append(diffVal)}).catch(function(err){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"diffBtn","error"),ErrorHandler.showError(err,Strings.ERROR_GIT_DIFF_FAILED)})}function handleGitUndo(file){var compiledTemplate=Mustache.render(questionDialogTemplate,{title:Strings.UNDO_CHANGES,question:StringUtils.format(Strings.Q_UNDO_CHANGES,_.escape(file)),Strings:Strings});Dialogs.showModalDialogUsingTemplate(compiledTemplate).done(function(buttonId){"ok"===buttonId&&Git.discardFileChanges(file).then(function(){var gitRoot=Preferences.get("currentGitRoot");DocumentManager.getAllOpenDocuments().forEach(function(doc){doc.file.fullPath===gitRoot+file&&Utils.reloadDoc(doc)}),refresh()}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_DISCARD_CHANGES_FAILED)})})}function handleGitDelete(file){FileSystem.resolve(Preferences.get("currentGitRoot")+file,function(err,fileEntry){err?ErrorHandler.showError(err,Strings.ERROR_COULD_NOT_RESOLVE_FILE):CommandManager.execute(Commands.FILE_DELETE,{file:fileEntry})})}function _getStagedDiff(commitMode,files=[]){const tracker=ProgressDialog.newProgressTracker(),fileNamesString=files.map(file=>file.file).join(", ");return ProgressDialog.show(_getStagedDiffForCommitMode(commitMode,files),tracker,{title:Strings.GETTING_STAGED_DIFF_PROGRESS,initialMessage:`${fileNamesString}\n${Strings.PLEASE_WAIT}`,options:{preDelay:3,postDelay:1}}).catch(function(err){if(ErrorHandler.contains(err,"cleanup"))return!1;throw err}).then(function(diff){return diff||Git.getListOfStagedFiles().then(function(filesList){return Strings.DIFF_FAILED_SEE_FILES+"\n\n"+filesList})})}function _getStagedDiffForCommitMode(commitMode,files){return commitMode===COMMIT_MODE.ALL?_getStaggedDiffForAllFiles():commitMode===COMMIT_MODE.CURRENT&&_.isArray(files)?files.length>1?Promise.reject("_getStagedDiffForCommitMode() got files.length > 1"):-1!==files[0].status.indexOf(Git.FILE_STATUS.UNTRACKED)?_getDiffForUntrackedFiles(files[0].file):Git.getDiffOfAllIndexFiles(files[0].file):Git.getDiffOfStagedFiles();var isUntracked}function _getStaggedDiffForAllFiles(){return Git.status().then(function(statusFiles){var untrackedFiles=[],fileArray=[];return statusFiles.forEach(function(fileObject){var isUntracked;-1!==fileObject.status.indexOf(Git.FILE_STATUS.UNTRACKED)?untrackedFiles.push(fileObject.file):fileArray.push(fileObject.file)}),untrackedFiles.length>0?_getDiffForUntrackedFiles(fileArray.concat(untrackedFiles)):Git.getDiffOfAllIndexFiles(fileArray)})}function _getDiffForUntrackedFiles(files){var diff;return Git.stage(files,!1).then(function(){return Git.getDiffOfStagedFiles()}).then(function(_diff){return diff=_diff,Git.resetIndex()}).then(function(){return diff})}function handleRebase(whatToDo){Git.rebase(whatToDo).then(function(){EventEmitter.emit(Events.REFRESH_ALL)}).catch(function(err){ErrorHandler.showError(err,"Rebase "+whatToDo+" failed")})}function abortMerge(){Git.discardAllChanges().then(function(){EventEmitter.emit(Events.REFRESH_ALL)}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_MERGE_ABORT_FAILED)})}function findConflicts(){FindInFiles.doSearch(/^<<<<<<<\s|^=======\s|^>>>>>>>\s/gm)}function commitMerge(){Utils.loadPathContent(Preferences.get("currentGitRoot")+"/.git/MERGE_MSG").then(function(msg){handleGitCommit(msg,!0,COMMIT_MODE.DEFAULT),EventEmitter.once(Events.GIT_COMMITED,function(){EventEmitter.emit(Events.REFRESH_ALL)})}).catch(function(err){ErrorHandler.showError(err,"Merge commit failed")})}function inspectFiles(gitStatusResults,$dialog){const lintResults=[];let totalFiles=gitStatusResults.length,totalFilesLinted=0,filesDone=0;function showProgress(){const $progressBar=$dialog.find(".accordion-progress-bar-inner");$progressBar.length&&($progressBar[0].style.width=`${filesDone/totalFiles*100}%`),filesDone===totalFiles&&$dialog.find(".accordion-progress-bar").addClass("forced-inVisible");const progressString=StringUtils.format(Strings.CODE_INSPECTION_DONE_FILES,filesDone,totalFiles);$dialog.find(".lint-errors").html(progressString)}const codeInspectionPromises=gitStatusResults.map(function(fileObj){const isDeleted=-1!==fileObj.status.indexOf(Git.FILE_STATUS.DELETED);return isDeleted?(filesDone++,void showProgress()):new Promise(resolve=>{setTimeout(()=>{lintFile(fileObj.file).catch(function(){return[{provider:{name:"See console [F12] for details"},result:{errors:[{pos:{line:0,ch:0},message:"CodeInspection failed to execute for this file."}]}}]}).then(function(result){result&&lintResults.push({filename:fileObj.file,result:result}),resolve()}).finally(()=>{filesDone++,totalFilesLinted++,showProgress()})},0)})});return Promise.all(_.compact(codeInspectionPromises)).then(function(){return Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"commit","files"+Metrics.getRangeName(totalFiles)),Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"commit","lint"+Metrics.getRangeName(totalFilesLinted)),lintResults})}function handleGitCommit(prefilledMessage,isMerge,commitMode){if(!Utils.isLoading($gitPanel.find(".git-commit"))){var stripWhitespace=Preferences.get("stripWhitespaceFromCommits"),p;Utils.setLoading($gitPanel.find(".git-commit")),commitMode===COMMIT_MODE.DEFAULT?p=Git.status().then(function(files){return 0!==(files=_.filter(files,function(file){return-1!==file.status.indexOf(Git.FILE_STATUS.STAGED)})).length||isMerge?handleGitCommitInternal(stripWhitespace,files,commitMode,prefilledMessage):ErrorHandler.showError(new Error("Commit button should have been disabled"),"Nothing staged to commit")}):commitMode===COMMIT_MODE.ALL?p=Git.status().then(function(files){return handleGitCommitInternal(stripWhitespace,files,commitMode,prefilledMessage)}):commitMode===COMMIT_MODE.CURRENT&&(p=Git.status().then(function(files){var gitRoot=Preferences.get("currentGitRoot"),currentDoc=DocumentManager.getCurrentDocument();if(currentDoc){var relativePath=currentDoc.file.fullPath.substring(gitRoot.length),currentFile=_.filter(files,function(next){return relativePath===next.file});return handleGitCommitInternal(stripWhitespace,currentFile,commitMode,prefilledMessage)}})),p.catch(function(err){ErrorHandler.showError(err,Strings.ERROR_PREPARING_COMMIT_DIALOG)}).finally(function(){Utils.unsetLoading($gitPanel.find(".git-commit"))})}}function handleGitCommitInternal(stripWhitespace,files,commitMode,prefilledMessage){let queue=Promise.resolve();return stripWhitespace&&(queue=queue.then(function(){const tracker=ProgressDialog.newProgressTracker();return ProgressDialog.show(Utils.stripWhitespaceFromFiles(files,commitMode===COMMIT_MODE.DEFAULT,tracker),tracker,{title:Strings.CLEANING_WHITESPACE_PROGRESS,options:{preDelay:3,postDelay:1}})})),queue.then(function(){return _getStagedDiff(commitMode,files).then(function(diff){return _showCommitDialog(diff,prefilledMessage,commitMode,files)})})}function refreshCurrentFile(){var gitRoot=Preferences.get("currentGitRoot"),currentDoc=DocumentManager.getCurrentDocument();currentDoc?$gitPanel.find("tr").each(function(){var currentFullPath=currentDoc.file.fullPath,thisFile=$(this).attr("x-file");$(this).toggleClass("selected",gitRoot+thisFile===currentFullPath)}):$gitPanel.find("tr").removeClass("selected")}function shouldShow(fileObj){return!!showFileWhiteList.test(fileObj.name)||ProjectManager.shouldShow(fileObj)}function _refreshTableContainer(files){if(gitPanel.isVisible()){var allStaged=(files=_.filter(files,function(file){return shouldShow(file)})).length>0&&_.all(files,function(file){return-1!==file.status.indexOf(Git.FILE_STATUS.STAGED)});$gitPanel.find(".check-all").prop("checked",allStaged).prop("disabled",0===files.length);var $editedList=$tableContainer.find(".git-edited-list"),visibleBefore=!$editedList.length||$editedList.is(":visible");$editedList.remove(),0===files.length?$tableContainer.append($("<p class='git-edited-list nothing-to-commit' />").text(Strings.NOTHING_TO_COMMIT)):(!1===showingUntracked&&(files=_.filter(files,function(file){return-1===file.status.indexOf(Git.FILE_STATUS.UNTRACKED)})),files.forEach(function(file){file.staged=-1!==file.status.indexOf(Git.FILE_STATUS.STAGED),file.statusText=file.status.map(function(status){return Strings["FILE_"+status]}).join(", "),file.allowDiff=-1===file.status.indexOf(Git.FILE_STATUS.UNTRACKED)&&-1===file.status.indexOf(Git.FILE_STATUS.RENAMED)&&-1===file.status.indexOf(Git.FILE_STATUS.DELETED),file.allowDelete=-1!==file.status.indexOf(Git.FILE_STATUS.UNTRACKED)||-1!==file.status.indexOf(Git.FILE_STATUS.STAGED)&&-1!==file.status.indexOf(Git.FILE_STATUS.ADDED),file.allowUndo=!file.allowDelete}),$tableContainer.append(Mustache.render(gitPanelResultsTemplate,{files:files,Strings:Strings})),refreshCurrentFile()),$tableContainer.find(".git-edited-list").toggle(visibleBefore)}}function _setName(commandID,newName){const command=CommandManager.get(commandID);command&&command.setName(newName)}function refreshCommitCounts(){var $pullBtn=$gitPanel.find(".git-pull"),$pushBtn=$gitPanel.find(".git-push"),clearCounts=function(){$pullBtn.children("span").remove(),$pushBtn.children("span").remove(),_setName(Constants.CMD_GIT_PULL,Strings.PULL_SHORTCUT),_setName(Constants.CMD_GIT_PUSH,Strings.PUSH_SHORTCUT)},remotes,defaultRemote;return(Preferences.get("defaultRemotes")||{})[Preferences.get("currentGitRoot")]?Git.getCommitCounts().then(function(commits){clearCounts(),commits.behind>0&&($pullBtn.append($("<span/>").text(" ("+commits.behind+")")),_setName(Constants.CMD_GIT_PULL,StringUtils.format(Strings.PULL_SHORTCUT_BEHIND,commits.behind))),commits.ahead>0&&($pushBtn.append($("<span/>").text(" ("+commits.ahead+")")),_setName(Constants.CMD_GIT_PUSH,StringUtils.format(Strings.PUSH_SHORTCUT_AHEAD,commits.ahead)))}).catch(function(err){clearCounts(),ErrorHandler.logError(err)}):(clearCounts(),Promise.resolve())}function refresh(){if($gitPanel.find(".git-history-toggle").removeClass("active").attr("title",Strings.TOOLTIP_SHOW_HISTORY),$gitPanel.find(".git-file-history").removeClass("active").attr("title",Strings.TOOLTIP_SHOW_FILE_HISTORY),"not-repo"===gitPanelMode)return $tableContainer.empty(),Promise.resolve();$tableContainer.find("#git-history-list").remove(),$tableContainer.find(".git-edited-list").show();var p1=Git.status().catch(function(err){ErrorHandler.contains(err,"Not a git repository")}),p2=refreshCommitCounts();return $gitPanel.find(".git-clone").prop("disabled",!1),Promise.all([p1,p2])}function toggle(bool){!0!==gitPanelDisabled&&("boolean"!=typeof bool&&(bool=!gitPanel.isVisible()),Preferences.set("panelEnabled",bool),Main.$icon.toggleClass("on",bool),Main.$icon.toggleClass("selected-button",bool),gitPanel.setVisible(bool),CommandManager.get(Constants.CMD_GIT_TOGGLE_PANEL).setChecked(bool),bool&&($("#git-toolbar-icon").removeClass("forced-hidden"),refresh()))}function handleToggleUntracked(){showingUntracked=!showingUntracked;const command=CommandManager.get(Constants.CMD_GIT_TOGGLE_UNTRACKED);command&&command.setChecked(!showingUntracked),refresh()}function commitCurrentFile(){jsPromise(CommandManager.execute("file.save")).then(function(){return Git.resetIndex()}).then(function(){return handleGitCommit(lastCommitMessage[ProjectManager.getProjectRoot().fullPath],!1,COMMIT_MODE.CURRENT)}).catch(err=>{throw console.error(err),new Error("Error commitCurrentFile in git panel.js. this should not have happened here.")})}function commitAllFiles(){jsPromise(CommandManager.execute("file.saveAll")).then(function(){return Git.resetIndex()}).then(function(){return handleGitCommit(lastCommitMessage[ProjectManager.getProjectRoot().fullPath],!1,COMMIT_MODE.ALL)}).catch(err=>{throw console.error(err),new Error("Error commitAllFiles in git panel.js. this should not have happened here.")})}function _toggleCommitButton(files){var anyStaged=_.any(files,function(file){return-1!==file.status.indexOf(Git.FILE_STATUS.STAGED)});$gitPanel.find(".git-commit").prop("disabled",!anyStaged)}function undoLastLocalCommit(){return Utils.askQuestion(Strings.UNDO_COMMIT,Strings.UNDO_LOCAL_COMMIT_CONFIRM,{booleanResponse:!0}).then(function(response){response&&Git.undoLastLocalCommit().catch(function(err){ErrorHandler.showError(err,Strings.ERROR_UNDO_LAST_COMMIT_FAILED)}).finally(function(){refresh()})})}EventEmitter.on(Events.GIT_STATUS_RESULTS,function(results){_refreshTableContainer(results),_toggleCommitButton(results)});var lastCheckOneClicked=null;function attachDefaultTableHandlers(){$tableContainer=$gitPanel.find(".table-container").off().on("click",".check-one",function(e){e.stopPropagation();var $tr=$(this).closest("tr"),file=$tr.attr("x-file"),status=$tr.attr("x-status"),isChecked=$(this).is(":checked");if(e.shiftKey){var lc=lastCheckOneClicked.localeCompare(file),lcClickedSelector="[x-file='"+lastCheckOneClicked+"']",sequence;if(lc<0?sequence=$tr.prevUntil(lcClickedSelector).andSelf():lc>0&&(sequence=$tr.nextUntil(lcClickedSelector).andSelf()),sequence){var promises=(sequence=sequence.add($tr.parent().children(lcClickedSelector))).map(function(){var $this=$(this),method=isChecked?"stage":"unstage",file=$this.attr("x-file"),status=$this.attr("x-status");return Git[method](file,status===Git.FILE_STATUS.DELETED)}).toArray();return Promise.all(promises).then(function(){return Git.status()}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_MODIFY_FILE_STATUS_FAILED)})}}let stagePromise;lastCheckOneClicked=file,(stagePromise=isChecked?Git.stage(file,status===Git.FILE_STATUS.DELETED).then(function(){return Git.status()}):Git.unstage(file).then(function(){return Git.status()})).catch(err=>{ErrorHandler.showError(err,Strings.ERROR_STAGE_FAILED,{dontStripError:!0,errorMetric:"stageOne",useNotification:!0})})}).on("dblclick",".check-one",function(e){e.stopPropagation()}).on("click",".btn-git-diff",function(e){e.stopPropagation(),handleGitDiff($(e.target).closest("tr").attr("x-file"))}).on("click",".btn-git-undo",function(e){e.stopPropagation(),handleGitUndo($(e.target).closest("tr").attr("x-file"))}).on("click",".btn-git-delete",function(e){e.stopPropagation(),handleGitDelete($(e.target).closest("tr").attr("x-file"))}).on("mousedown",".modified-file",function(e){var $this=$(e.currentTarget);$(e.target).is("button, input")||$(e.target).closest("button").length||$this.attr("x-status")!==Git.FILE_STATUS.DELETED&&CommandManager.execute(Commands.FILE_OPEN,{fullPath:Preferences.get("currentGitRoot")+$this.attr("x-file")})}).on("dblclick",".modified-file",function(e){var $this=$(e.currentTarget);$this.attr("x-status")!==Git.FILE_STATUS.DELETED&&FileViewController.openFileAndAddToWorkingSet(Preferences.get("currentGitRoot")+$this.attr("x-file"))})}function setGerritCheckState(enabled){const command=CommandManager.get(Constants.CMD_GIT_GERRIT_PUSH_REF);command&&command.setChecked(enabled)}function discardAllChanges(){return Utils.askQuestion(Strings.RESET_LOCAL_REPO,Strings.RESET_LOCAL_REPO_CONFIRM,{booleanResponse:!0,customOkBtn:Strings.DISCARD_CHANGES,customOkBtnClass:"danger"}).then(function(response){if(response)return Git.discardAllChanges().catch(function(err){ErrorHandler.showError(err,Strings.ERROR_RESET_LOCAL_REPO_FAILED)}).then(function(){refresh()})})}function getSelectedHistoryCommit(){const $historyRow=$(".history-commit.selected");return $historyRow.is(":visible")?{hash:$historyRow.attr("x-hash"),subject:$historyRow.find(".commit-subject").text()}:{}}function _panelResized(_entries){if(!$mainToolbar||!$mainToolbar.is(":visible"))return;const mainToolbarWidth=$mainToolbar.width();let overFlowWidth=565;const breakpoints=[{width:565,className:"hide-when-small"},{width:400,className:"hide-when-x-small"}];mainToolbarWidth<565?$gitPanel.find(".mainToolbar").addClass("hide-overflow"):$gitPanel.find(".mainToolbar").removeClass("hide-overflow"),breakpoints.forEach(bp=>{mainToolbarWidth<bp.width?$gitPanel.find(`.${bp.className}`).addClass("forced-hidden"):$gitPanel.find(`.${bp.className}`).removeClass("forced-hidden")})}function init(){var panelHtml=Mustache.render(gitPanelTemplate,{S:Strings}),$panelHtml=$(panelHtml);$panelHtml.find(".git-available, .git-not-available").hide(),gitPanel=WorkspaceManager.createBottomPanel("main-git.panel",$panelHtml,100),$gitPanel=gitPanel.$panel;const resizeObserver=new ResizeObserver(_panelResized);resizeObserver.observe($gitPanel[0]),$mainToolbar=$gitPanel.find(".mainToolbar"),$gitPanel.on("click",".close",toggle).on("click",".check-all",function(){return $(this).is(":checked")?Git.stageAll().then(function(){return Git.status()}).catch(err=>{ErrorHandler.showError(err,Strings.ERROR_STAGE_FAILED,{dontStripError:!0,errorMetric:"stageAll",useNotification:!0})}):Git.resetIndex().then(function(){return Git.status()}).catch(err=>{throw console.error(err),new Error("Error unstage all by checkbox in git panel.js. this should not have happened")})}).on("click",".git-refresh",EventEmitter.getEmitter(Events.REFRESH_ALL,["panel","refreshBtn"])).on("click",".git-commit",EventEmitter.getEmitter(Events.HANDLE_GIT_COMMIT)).on("click",".git-rebase-continue",function(e){handleRebase("continue",e)}).on("click",".git-rebase-skip",function(e){handleRebase("skip",e)}).on("click",".git-rebase-abort",function(e){handleRebase("abort",e)}).on("click",".git-commit-merge",commitMerge).on("click",".git-merge-abort",abortMerge).on("click",".git-find-conflicts",findConflicts).on("click",".git-prev-gutter",()=>{Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"panel","prevBtn"),GutterManager.goToPrev()}).on("click",".git-next-gutter",()=>{Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"panel","nextBtn"),GutterManager.goToNext()}).on("click",".git-file-history",EventEmitter.getEmitter(Events.HISTORY_SHOW_FILE)).on("click",".git-history-toggle",EventEmitter.getEmitter(Events.HISTORY_SHOW_GLOBAL)).on("click",".git-fetch",EventEmitter.getEmitter(Events.HANDLE_FETCH,["panel","fetchBtn"])).on("click",".git-push",function(){var typeOfRemote;Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"panel","pushBtn"),"git"===$(this).attr("x-selected-remote-type")&&EventEmitter.emit(Events.HANDLE_PUSH)}).on("click",".git-pull",EventEmitter.getEmitter(Events.HANDLE_PULL,["panel","pullBtn"])).on("click",".git-init",EventEmitter.getEmitter(Events.HANDLE_GIT_INIT)).on("click",".git-clone",EventEmitter.getEmitter(Events.HANDLE_GIT_CLONE)).on("click",".change-remote",EventEmitter.getEmitter(Events.HANDLE_REMOTE_PICK,["panel","changeRemote"])).on("click",".remove-remote",EventEmitter.getEmitter(Events.HANDLE_REMOTE_DELETE,["panel","removeRemote"])).on("click",".git-remote-new",EventEmitter.getEmitter(Events.HANDLE_REMOTE_CREATE,["panel","newRemote"])).on("contextmenu","tr",function(e){const $this=$(this);if($this.hasClass("history-commit"))return Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"cmenu","history"),$this.hasClass("selected")||$this.click(),void Menus.getContextMenu(Constants.GIT_PANEL_HISTORY_CMENU).open(e);$this.click(),setTimeout(function(){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"cmenu","filechanges"),Menus.getContextMenu(Constants.GIT_PANEL_CHANGES_CMENU).open(e)},1)}),attachDefaultTableHandlers(),CommandManager.register(Strings.PANEL_COMMAND,Constants.CMD_GIT_TOGGLE_PANEL,toggle),CommandManager.register(Strings.COMMIT_CURRENT_SHORTCUT,Constants.CMD_GIT_COMMIT_CURRENT,commitCurrentFile),CommandManager.register(Strings.COMMIT_ALL_SHORTCUT,Constants.CMD_GIT_COMMIT_ALL,commitAllFiles),CommandManager.register(Strings.PUSH_SHORTCUT,Constants.CMD_GIT_PUSH,EventEmitter.getEmitter(Events.HANDLE_PUSH)),CommandManager.register(Strings.PULL_SHORTCUT,Constants.CMD_GIT_PULL,EventEmitter.getEmitter(Events.HANDLE_PULL)),CommandManager.register(Strings.FETCH_SHORTCUT,Constants.CMD_GIT_FETCH,EventEmitter.getEmitter(Events.HANDLE_FETCH)),CommandManager.register(Strings.GOTO_PREVIOUS_GIT_CHANGE,Constants.CMD_GIT_GOTO_PREVIOUS_CHANGE,GutterManager.goToPrev),CommandManager.register(Strings.GOTO_NEXT_GIT_CHANGE,Constants.CMD_GIT_GOTO_NEXT_CHANGE,GutterManager.goToNext),CommandManager.register(Strings.REFRESH_GIT,Constants.CMD_GIT_REFRESH,EventEmitter.getEmitter(Events.REFRESH_ALL)),CommandManager.register(Strings.RESET_LOCAL_REPO,Constants.CMD_GIT_DISCARD_ALL_CHANGES,discardAllChanges),CommandManager.register(Strings.UNDO_LAST_LOCAL_COMMIT,Constants.CMD_GIT_UNDO_LAST_COMMIT,undoLastLocalCommit),CommandManager.register(Strings.CHANGE_USER_NAME,Constants.CMD_GIT_CHANGE_USERNAME,EventEmitter.getEmitter(Events.GIT_CHANGE_USERNAME)),CommandManager.register(Strings.CHANGE_USER_EMAIL,Constants.CMD_GIT_CHANGE_EMAIL,EventEmitter.getEmitter(Events.GIT_CHANGE_EMAIL)),CommandManager.register(Strings.ENABLE_GERRIT_PUSH_REF,Constants.CMD_GIT_GERRIT_PUSH_REF,EventEmitter.getEmitter(Events.GERRIT_TOGGLE_PUSH_REF)),CommandManager.register(Strings.VIEW_AUTHORS_SELECTION,Constants.CMD_GIT_AUTHORS_OF_SELECTION,handleAuthorsSelection),CommandManager.register(Strings.VIEW_AUTHORS_FILE,Constants.CMD_GIT_AUTHORS_OF_FILE,handleAuthorsFile),CommandManager.register(Strings.HIDE_UNTRACKED,Constants.CMD_GIT_TOGGLE_UNTRACKED,handleToggleUntracked),CommandManager.register(Strings.GIT_INIT,Constants.CMD_GIT_INIT,EventEmitter.getEmitter(Events.HANDLE_GIT_INIT)),CommandManager.register(Strings.GIT_CLONE,Constants.CMD_GIT_CLONE,EventEmitter.getEmitter(Events.HANDLE_GIT_CLONE)),CommandManager.register(Strings.GIT_SHOW_HISTORY,Constants.CMD_GIT_HISTORY_GLOBAL,()=>{toggle(!0),EventEmitter.emit(Events.HISTORY_SHOW_GLOBAL)}),CommandManager.register(Strings.GIT_SHOW_FILE_HISTORY,Constants.CMD_GIT_HISTORY_FILE,()=>{toggle(!0),EventEmitter.emit(Events.HISTORY_SHOW_FILE)}),Preferences.get("panelEnabled")&&Setup.isExtensionActivated()&&toggle(!0),_panelResized(),GutterManager.init()}function enable(){EventEmitter.emit(Events.GIT_ENABLED),gitPanelMode=null,$gitPanel.find(".git-available").show(),$gitPanel.find(".git-not-available").hide(),Utils.enableCommand(Constants.CMD_GIT_INIT,!1),Utils.enableCommand(Constants.CMD_GIT_CLONE,!1),Main.$icon.removeClass("warning"),gitPanelDisabled=!1,refresh()}function disable(cause){EventEmitter.emit(Events.GIT_DISABLED,cause),"not-repo"===(gitPanelMode=cause)?($gitPanel.find(".git-available").hide(),$gitPanel.find(".git-not-available").show(),Utils.enableCommand(Constants.CMD_GIT_INIT,!0),Utils.enableCommand(Constants.CMD_GIT_CLONE,!0)):(Main.$icon.addClass("warning"),toggle(!1),gitPanelDisabled=!0),refresh()}EventEmitter.on(Events.GIT_CHANGE_USERNAME,function(callback){return Git.getConfig("user.name").then(function(currentUserName){return Utils.askQuestion(Strings.CHANGE_USER_NAME_TITLE,Strings.ENTER_NEW_USER_NAME,{defaultValue:currentUserName}).then(function(userName){return userName.length||(userName=currentUserName),Git.setConfig("user.name",userName,!0).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_CHANGE_USERNAME_FAILED)}).then(function(){EventEmitter.emit(Events.GIT_USERNAME_CHANGED,userName)}).finally(function(){callback&&callback(userName)})})})}),EventEmitter.on(Events.GIT_CHANGE_EMAIL,function(callback){return Git.getConfig("user.email").then(function(currentUserEmail){return Utils.askQuestion(Strings.CHANGE_USER_EMAIL_TITLE,Strings.ENTER_NEW_USER_EMAIL,{defaultValue:currentUserEmail}).then(function(userEmail){return userEmail.length||(userEmail=currentUserEmail),Git.setConfig("user.email",userEmail,!0).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_CHANGE_EMAIL_FAILED)}).then(function(){EventEmitter.emit(Events.GIT_EMAIL_CHANGED,userEmail)}).finally(function(){callback&&callback(userEmail)})})})}),EventEmitter.on(Events.GERRIT_TOGGLE_PUSH_REF,function(){return Git.getConfig("gerrit.pushref").then(function(strEnabled){var toggledValue="true"!==strEnabled;return Preferences.set("gerritPushref",toggledValue),Git.setConfig("gerrit.pushref",toggledValue,!0).then(function(){EventEmitter.emit(Events.GERRIT_PUSH_REF_TOGGLED,toggledValue)})}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_TOGGLE_GERRIT_PUSH_REF_FAILED)})}),EventEmitter.on(Events.GERRIT_PUSH_REF_TOGGLED,function(enabled){setGerritCheckState(enabled)}),EventEmitter.on(Events.GIT_USERNAME_CHANGED,function(userName){_setName(Constants.CMD_GIT_CHANGE_USERNAME,userName?StringUtils.format(Strings.CHANGE_USER_NAME_MENU,userName):Strings.CHANGE_USER_NAME)}),EventEmitter.on(Events.GIT_EMAIL_CHANGED,function(email){$gitPanel.find(".git-user-email").text(email),_setName(Constants.CMD_GIT_CHANGE_EMAIL,email?StringUtils.format(Strings.CHANGE_USER_EMAIL_MENU,email):Strings.CHANGE_USER_EMAIL)}),EventEmitter.on(Events.GIT_REMOTE_AVAILABLE,function(){$gitPanel.find(".git-pull, .git-push, .git-fetch").prop("disabled",!1)}),EventEmitter.on(Events.GIT_REMOTE_NOT_AVAILABLE,function(){$gitPanel.find(".git-pull, .git-push, .git-fetch").prop("disabled",!0)}),EventEmitter.on(Events.GIT_ENABLED,function(){StateManager.get(GIT_PANEL_SHOWN_ON_FIRST_BOOT)||(StateManager.set(GIT_PANEL_SHOWN_ON_FIRST_BOOT,!0),toggle(!0),NotificationUI.createFromTemplate(Strings.GIT_TOAST_TITLE,Strings.GIT_TOAST_MESSAGE,"git-toolbar-icon",{allowedPlacements:["left"],dismissOnClick:!0,toastStyle:"width-250"})),Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"project","enabled"),Git.getConfig("user.name").then(function(currentUserName){EventEmitter.emit(Events.GIT_USERNAME_CHANGED,currentUserName)}),Git.getConfig("user.email").then(function(currentEmail){EventEmitter.emit(Events.GIT_EMAIL_CHANGED,currentEmail)}),Git.getConfig("gerrit.pushref").then(function(strEnabled){var enabled="true"===strEnabled;enabled&&!Preferences.get("gerritPushref")&&Preferences.set("gerritPushref",!0),EventEmitter.emit(Events.GERRIT_PUSH_REF_TOGGLED,enabled)})}),EventEmitter.on(Events.BRACKETS_CURRENT_DOCUMENT_CHANGE,function(){gitPanel&&refreshCurrentFile()}),EventEmitter.on(Events.BRACKETS_DOCUMENT_SAVED,function(){gitPanel&&refresh()}),EventEmitter.on(Events.BRACKETS_FILE_CHANGED,function(fileSystemEntry){fileSystemEntry.isDirectory&&refresh()}),EventEmitter.on(Events.REBASE_MERGE_MODE,function(rebaseEnabled,mergeEnabled){$gitPanel.find(".git-rebase").toggle(rebaseEnabled),$gitPanel.find(".git-merge").toggle(mergeEnabled),$gitPanel.find("button.git-commit").toggle(!rebaseEnabled&&!mergeEnabled)}),EventEmitter.on(Events.FETCH_STARTED,function(){$gitPanel.find(".git-fetch").addClass("btn-loading").prop("disabled",!0)}),EventEmitter.on(Events.FETCH_COMPLETE,function(){$gitPanel.find(".git-fetch").removeClass("btn-loading").prop("disabled",!1),refreshCommitCounts()}),EventEmitter.on(Events.REFRESH_COUNTERS,function(){refreshCommitCounts()}),EventEmitter.on(Events.HANDLE_GIT_COMMIT,function(){handleGitCommit(lastCommitMessage[ProjectManager.getProjectRoot().fullPath],!1,COMMIT_MODE.DEFAULT)}),exports.init=init,exports.refresh=refresh,exports.toggle=toggle,exports.enable=enable,exports.disable=disable,exports.getSelectedHistoryCommit=getSelectedHistoryCommit,exports.getPanel=function(){return $gitPanel}}),define("src/Preferences",function(require,exports,module){var _=brackets.getModule("thirdparty/lodash"),PreferencesManager=brackets.getModule("preferences/PreferencesManager"),StateManager=PreferencesManager.stateManager,prefix="git",defaultPreferences={stripWhitespaceFromCommits:{type:"boolean",value:!0},addEndlineToTheEndOfFile:{type:"boolean",value:!0},removeByteOrderMark:{type:"boolean",value:!1},normalizeLineEndings:{type:"boolean",value:!1},useGitGutter:{type:"boolean",value:!0},markModifiedInTree:{type:"boolean",value:!0},useVerboseDiff:{type:"boolean",value:!1},useDifftool:{type:"boolean",value:!1},clearWhitespaceOnSave:{type:"boolean",value:!1},gerritPushref:{type:"boolean",value:!1},enableGit:{type:"boolean",value:!0},gitTimeout:{type:"number",value:30},gitPath:{type:"string",value:""}},prefs=PreferencesManager.getExtensionPrefs(prefix);function get(key){var location=defaultPreferences[key]?PreferencesManager:StateManager;return arguments[0]=prefix+"."+key,location.get.apply(location,arguments)}function set(key){var location=defaultPreferences[key]?PreferencesManager:StateManager;return arguments[0]=prefix+"."+key,location.set.apply(location,arguments)}function getAll(){var obj={};return _.each(defaultPreferences,function(definition,key){obj[key]=get(key)}),obj}function getDefaults(){var obj={};return _.each(defaultPreferences,function(definition,key){var defaultValue;defaultValue=definition.os&&definition.os[brackets.platform]?definition.os[brackets.platform].value:definition.value,obj[key]=defaultValue}),obj}function getType(key){return defaultPreferences[key].type}function getGlobal(key){return PreferencesManager.get(key)}function getExtensionPref(){return prefs}function save(){PreferencesManager.save()}_.each(defaultPreferences,function(definition,key){definition.os&&definition.os[brackets.platform]?prefs.definePreference(key,definition.type,definition.os[brackets.platform].value):prefs.definePreference(key,definition.type,definition.value)}),prefs.save(),module.exports={get:get,set:set,getAll:getAll,getDefaults:getDefaults,getType:getType,getGlobal:getGlobal,getExtensionPref:getExtensionPref,save:save}}),define("src/ProjectTreeMarks",function(require){var _=brackets.getModule("thirdparty/lodash"),FileSystem=brackets.getModule("filesystem/FileSystem"),ProjectManager=brackets.getModule("project/ProjectManager"),EventEmitter=require("src/EventEmitter"),Events=require("src/Events"),Git=require("src/git/Git"),Preferences=require("src/Preferences"),ignoreEntries=[],newPaths=[],modifiedPaths=[];if(Preferences.get("markModifiedInTree")){ProjectManager.addClassesProvider(function(data){var fullPath=data.fullPath;return isIgnored(fullPath)?"git-ignored":isNew(fullPath)?"git-new":isModified(fullPath)?"git-modified":void 0});var refreshOpenFiles=_.debounce(function(){_refreshOpenFiles()},100);EventEmitter.on(Events.BRACKETS_FILE_CHANGED,function(file){file.fullPath===Preferences.get("currentGitRoot")+".gitignore"&&refreshIgnoreEntries().finally(function(){refreshOpenFiles()})}),EventEmitter.on(Events.GIT_STATUS_RESULTS,function(files){var gitRoot=Preferences.get("currentGitRoot");newPaths=[],modifiedPaths=[],files.forEach(function(entry){var isNew=-1!==entry.status.indexOf(Git.FILE_STATUS.UNTRACKED)||-1!==entry.status.indexOf(Git.FILE_STATUS.ADDED),fullPath=gitRoot+entry.file;isNew?newPaths.push(fullPath):modifiedPaths.push(fullPath)}),ProjectManager.rerenderTree(),refreshOpenFiles()}),EventEmitter.on(Events.GIT_ENABLED,function(){refreshIgnoreEntries(),attachEvents()}),EventEmitter.on(Events.GIT_DISABLED,function(){ignoreEntries=[],newPaths=[],modifiedPaths=[],detachEvents()})}function loadIgnoreContents(){return new Promise(resolve=>{let gitRoot=Preferences.get("currentGitRoot"),excludeContents,gitignoreContents;const finish=_.after(2,function(){resolve(excludeContents+"\n"+gitignoreContents)});FileSystem.getFileForPath(gitRoot+".git/info/exclude").read(function(err,content){excludeContents=err?"":content,finish()}),FileSystem.getFileForPath(gitRoot+".gitignore").read(function(err,content){gitignoreContents=err?"":content,finish()})})}function refreshIgnoreEntries(){function regexEscape(str){return str.replace(/([.?+\^$\\(){}|])/g,"\\$1")}return loadIgnoreContents().then(function(content){var gitRoot=Preferences.get("currentGitRoot");ignoreEntries=_.compact(_.map(content.split("\n"),function(line){var type="deny",leadingSlash,trailingSlash,regex;if((line=line.trim())&&0!==line.indexOf("#"))return 0===line.indexOf("!")&&(line=line.slice(1),type="accept"),0===line.indexOf("\\")&&(line=line.slice(1)),0===line.indexOf("/")&&(line=line.slice(1),leadingSlash=!0),line.lastIndexOf("/")===line.length&&(line+="**",trailingSlash=!0),regex="^"+(regex=(regex=regexEscape(gitRoot)+(leadingSlash?"":"((.+)/)?")+regexEscape(line)+(trailingSlash?"":"(/.{0,})?")).replace(/\*\*$/g,"(.{0,})").replace(/(\*\*|\*$)/g,"(.+)").replace(/\*/g,"([^/]*)"))+"$",{regexp:new RegExp(regex),type:type}}))})}function isIgnored(path){var ignored=!1;return _.forEach(ignoreEntries,function(entry){entry.regexp.test(path)&&(ignored="deny"===entry.type)}),ignored}function isNew(fullPath){return-1!==newPaths.indexOf(fullPath)}function isModified(fullPath){return-1!==modifiedPaths.indexOf(fullPath)}function _refreshOpenFiles(){$("#working-set-list-container").find("li").each(function(){var $li=$(this),data=$li.data("file");if(data){var fullPath=data.fullPath;$li.toggleClass("git-ignored",isIgnored(fullPath)).toggleClass("git-new",isNew(fullPath)).toggleClass("git-modified",isModified(fullPath))}})}function attachEvents(){$("#working-set-list-container").on("contentChanged",refreshOpenFiles).triggerHandler("contentChanged")}function detachEvents(){$("#working-set-list-container").off("contentChanged",refreshOpenFiles)}}),define("src/Remotes",function(require){var _=brackets.getModule("thirdparty/lodash"),DefaultDialogs=brackets.getModule("widgets/DefaultDialogs"),Dialogs=brackets.getModule("widgets/Dialogs"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),Metrics=brackets.getModule("utils/Metrics"),Strings=brackets.getModule("strings"),StringUtils=brackets.getModule("utils/StringUtils"),ErrorHandler=require("src/ErrorHandler"),Events=require("src/Events"),EventEmitter=require("src/EventEmitter"),Git=require("src/git/Git"),Preferences=require("src/Preferences"),ProgressDialog=require("src/dialogs/Progress"),PullDialog=require("src/dialogs/Pull"),PushDialog=require("src/dialogs/Push"),Utils=require("src/Utils"),gitRemotesPickerTemplate='\x3c!-- List of remotes defined for the current local repository --\x3e\n{{#remotes}}\n<li class="remote">\n    <a href="#" data-remote-name="{{name}}" data-type="git" class="remote-name">\n        {{#deletable}}<span class="trash-icon hover-icon remove-remote">&times;</span>{{/deletable}}\n        <span class="change-remote">{{name}}</span>\n    </a>\n</li>\n{{/remotes}}\n<li><a class="git-remote-new"><span>{{Strings.CREATE_NEW_REMOTE}}</span></a></li>\n',$selectedRemote=null,$remotesDropdown=null,$gitPanel=null,$gitPush=null;function initVariables(){$gitPanel=$("#git-panel"),$selectedRemote=$gitPanel.find(".git-selected-remote"),$remotesDropdown=$gitPanel.find(".git-remotes-dropdown"),$gitPush=$gitPanel.find(".git-push")}function getDefaultRemote(allRemotes){var defaultRemotes,candidate=(Preferences.get("defaultRemotes")||{})[Preferences.get("currentGitRoot")],exists;return _.find(allRemotes,function(remote){return remote.name===candidate})||(candidate=null,allRemotes.length>0&&(candidate=_.first(allRemotes).name)),candidate}function setDefaultRemote(remoteName){var defaultRemotes=Preferences.get("defaultRemotes")||{};defaultRemotes[Preferences.get("currentGitRoot")]=remoteName,Preferences.set("defaultRemotes",defaultRemotes)}function clearRemotePicker(){$selectedRemote.html("&mdash;").data("remote",null)}function selectRemote(remoteName,type){if(!remoteName)return clearRemotePicker();"git"===type&&setDefaultRemote(remoteName),$gitPanel.find(".git-pull").prop("disabled","git"!==type),$gitPush.prop("disabled",!1).attr("x-selected-remote-type",type),$selectedRemote.text(remoteName).attr("data-type",type).data("remote",remoteName)}function refreshRemotesPicker(){Git.getRemotes().then(function(remotes){var defaultRemoteName=getDefaultRemote(remotes);$gitPanel.find(".git-pull, .git-push, .git-fetch").prop("disabled",0===remotes.length),remotes.forEach(function(remote){remote.deletable="origin"!==remote.name});var compiledTemplate=Mustache.render(gitRemotesPickerTemplate,{Strings:Strings,remotes:remotes});$remotesDropdown.html(compiledTemplate),EventEmitter.emit(Events.REMOTES_REFRESH_PICKER),remotes.length>0?selectRemote(defaultRemoteName,"git"):clearRemotePicker()}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_GETTING_REMOTES)})}function handleRemoteCreation(){return Utils.askQuestion(Strings.CREATE_NEW_REMOTE,Strings.ENTER_REMOTE_NAME).then(function(name){return Utils.askQuestion(Strings.CREATE_NEW_REMOTE,Strings.ENTER_REMOTE_URL).then(function(url){return[name,url]})}).then(function([name,url]){return Git.createRemote(name,url).then(function(){return refreshRemotesPicker()})}).catch(function(err){ErrorHandler.equals(err,Strings.USER_ABORTED)||ErrorHandler.showError(err,Strings.ERROR_REMOTE_CREATION)})}function deleteRemote(remoteName){return Utils.askQuestion(Strings.DELETE_REMOTE,StringUtils.format(Strings.DELETE_REMOTE_NAME,remoteName),{booleanResponse:!0}).then(function(response){if(!0===response)return Git.deleteRemote(remoteName).then(function(){return refreshRemotesPicker()})}).catch(function(err){ErrorHandler.logError(err)})}function showPushResult(result){"string"==typeof result.remoteUrl&&(result.remoteUrl=Utils.encodeSensitiveInformation(result.remoteUrl));var template=["<h3>{{flagDescription}}</h3>","Info:","Remote url - {{remoteUrl}}","Local branch - {{from}}","Remote branch - {{to}}","Summary - {{summary}}","<h4>Status - {{status}}</h4>"].join("<br>");Dialogs.showModalDialog(DefaultDialogs.DIALOG_ID_INFO,Strings.GIT_PUSH_RESPONSE,Mustache.render(template,result))}function pushToRemote(remote){if(!remote)return ErrorHandler.showError(StringUtils.format(Strings.ERROR_NO_REMOTE_SELECTED,"push"));var pushConfig={remote:remote};PushDialog.show(pushConfig).then(function(pushConfig){var q=Promise.resolve(),additionalArgs=[];return pushConfig.tags&&additionalArgs.push("--tags"),pushConfig.noVerify&&additionalArgs.push("--no-verify"),pushConfig.branch&&pushConfig.setBranchAsTracking&&(q=q.then(function(){return Git.setUpstreamBranch(pushConfig.remote,pushConfig.branch)})),pushConfig.remoteUrlNew&&(q=q.then(function(){return Git.setRemoteUrl(pushConfig.remote,pushConfig.remoteUrlNew)})),q=q.then(function(){let op;const progressTracker=ProgressDialog.newProgressTracker();return pushConfig.pushToNew?op=Git.pushToNewUpstream(pushConfig.remote,pushConfig.branch,{noVerify:!0,progressTracker:progressTracker}):"DEFAULT"===pushConfig.strategy?op=Git.push(pushConfig.remote,pushConfig.branch,additionalArgs,progressTracker):"FORCED"===pushConfig.strategy?op=Git.pushForced(pushConfig.remote,pushConfig.branch,{noVerify:!0,progressTracker:progressTracker}):"DELETE_BRANCH"===pushConfig.strategy&&(op=Git.deleteRemoteBranch(pushConfig.remote,pushConfig.branch,{noVerify:!0,progressTracker:progressTracker})),ProgressDialog.show(op,progressTracker).then(function(result){return ProgressDialog.waitForClose().then(function(){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"push","success"),showPushResult(result)})}).catch(function(err){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"push","fail"),ErrorHandler.showError(err,Strings.ERROR_PUSHING_REMOTE,{errorMetric:"push"})})}),pushConfig.remoteUrlRestore&&(q=q.finally(function(){return Git.setRemoteUrl(pushConfig.remote,pushConfig.remoteUrlRestore)})),q.finally(function(){EventEmitter.emit(Events.REFRESH_ALL)})}).catch(function(err){err&&ErrorHandler.showError(err,Strings.ERROR_PUSHING_OPERATION)})}function pullFromRemote(remote){if(!remote)return ErrorHandler.showError(StringUtils.format(Strings.ERROR_NO_REMOTE_SELECTED,"pull"));var pullConfig={remote:remote};PullDialog.show(pullConfig).then(function(pullConfig){var q=Promise.resolve();return pullConfig.branch&&pullConfig.setBranchAsTracking&&(q=q.then(function(){return Git.setUpstreamBranch(pullConfig.remote,pullConfig.branch)})),pullConfig.remoteUrlNew&&(q=q.then(function(){return Git.setRemoteUrl(pullConfig.remote,pullConfig.remoteUrlNew)})),q=q.then(function(){const progressTracker=ProgressDialog.newProgressTracker();return ProgressDialog.show(Git.fetchRemote(pullConfig.remote,progressTracker),progressTracker).then(function(){return"DEFAULT"===pullConfig.strategy?Git.mergeRemote(pullConfig.remote,pullConfig.branch,!1,!1,{progressTracker:progressTracker}):"AVOID_MERGING"===pullConfig.strategy?Git.mergeRemote(pullConfig.remote,pullConfig.branch,!0,!1,{progressTracker:progressTracker}):"MERGE_NOCOMMIT"===pullConfig.strategy?Git.mergeRemote(pullConfig.remote,pullConfig.branch,!1,!0,{progressTracker:progressTracker}):"REBASE"===pullConfig.strategy?Git.rebaseRemote(pullConfig.remote,pullConfig.branch,progressTracker):"RESET"===pullConfig.strategy?Git.resetRemote(pullConfig.remote,pullConfig.branch,progressTracker):void 0}).then(function(result){return ProgressDialog.waitForClose().then(function(){return Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"pull","success"),Utils.showOutput(result||Strings.GIT_PULL_SUCCESS,Strings.GIT_PULL_RESPONSE)})}).catch(function(err){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"pull","fail"),ErrorHandler.showError(err,Strings.ERROR_PULLING_REMOTE,{errorMetric:"pull"})})}),pullConfig.remoteUrlRestore&&(q=q.finally(function(){return Git.setRemoteUrl(pullConfig.remote,pullConfig.remoteUrlRestore)})),q.finally(function(){EventEmitter.emit(Events.REFRESH_ALL)})}).catch(function(err){err&&ErrorHandler.showError(err,Strings.ERROR_PULLING_OPERATION)})}function handleFetch(){EventEmitter.emit(Events.FETCH_STARTED);const tracker=ProgressDialog.newProgressTracker();return ProgressDialog.show(Git.fetchAllRemotes(tracker),tracker).then(()=>{Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"fetch","success")}).catch(function(err){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"fetch","fail"),ErrorHandler.showError(err,void 0,{errorMetric:"fetch"})}).then(ProgressDialog.waitForClose).finally(function(){EventEmitter.emit(Events.FETCH_COMPLETE)})}EventEmitter.on(Events.GIT_ENABLED,function(){initVariables(),refreshRemotesPicker()}),EventEmitter.on(Events.HANDLE_REMOTE_PICK,function(event){var $remote=$(event.target).closest(".remote-name"),remoteName,type;selectRemote($remote.data("remote-name"),$remote.data("type")),EventEmitter.emit(Events.REFRESH_COUNTERS)}),EventEmitter.on(Events.HANDLE_REMOTE_CREATE,function(){handleRemoteCreation()}),EventEmitter.on(Events.HANDLE_REMOTE_DELETE,function(event){var remoteName;deleteRemote($(event.target).closest(".remote-name").data("remote-name"))}),EventEmitter.on(Events.HANDLE_PULL,function(){var remoteName;pullFromRemote($selectedRemote.data("remote"))}),EventEmitter.on(Events.HANDLE_PUSH,function(){var remoteName;pushToRemote($selectedRemote.data("remote"))}),EventEmitter.on(Events.HANDLE_FETCH,function(){handleFetch()})}),define("src/SettingsDialog",function(require,exports){const Dialogs=brackets.getModule("widgets/Dialogs"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),Preferences=require("./Preferences"),Strings=brackets.getModule("strings"),Git=require("./git/Git"),Setup=require("src/utils/Setup"),settingsDialogTemplate='<div id="git-settings-dialog" class="git modal">\n    <div class="modal-header">\n        <h1 class="dialog-title">{{Strings.GIT_SETTINGS_TITLE}}</h1>\n    </div>\n    <div class="modal-body" style="max-height: fit-content;">\n        <div>\n            <label for="git-settings-enableGit">\n                <input id="git-settings-enableGit" type="checkbox" settingsProperty="enableGit" />\n                {{Strings.ENABLE_GIT}}&nbsp;&nbsp;<i title="{{Strings.REQUIRES_APP_RESTART_SETTING}}" class="settings-info-i fa-solid fa-circle-info"></i>\n            </label>\n        </div>\n        <div class="git-settings-content {{#gitDisabled}}forced-inVisible{{/gitDisabled}}">\n            \x3c!-- #features --\x3e\n            <div>\n                <div>\n                    <label for="git-settings-stripWhitespaceFromCommits">\n                        <input id="git-settings-stripWhitespaceFromCommits" type="checkbox" settingsProperty="stripWhitespaceFromCommits" />\n                        {{Strings.STRIP_WHITESPACE_FROM_COMMITS}}\n                    </label>\n                </div>\n                <div>\n                    <label for="git-settings-addEndlineToTheEndOfFile">\n                        <input id="git-settings-addEndlineToTheEndOfFile" type="checkbox" settingsProperty="addEndlineToTheEndOfFile" />\n                        {{Strings.ADD_ENDLINE_TO_THE_END_OF_FILE}}\n                    </label>\n                </div>\n            </div>\n            <div>\n                <div>\n                    <label for="git-settings-removeByteOrderMark">\n                        <input id="git-settings-removeByteOrderMark" type="checkbox" settingsProperty="removeByteOrderMark" />\n                        {{Strings.REMOVE_BOM}}\n                    </label>\n                </div>\n                <div>\n                    <label for="git-settings-normalizeLineEndings">\n                        <input id="git-settings-normalizeLineEndings" type="checkbox" settingsProperty="normalizeLineEndings" />\n                        {{Strings.NORMALIZE_LINE_ENDINGS}}\n                    </label>\n                </div>\n            </div>\n            <div>\n                <div>\n                    <label for="git-settings-useGitGutter">\n                        <input id="git-settings-useGitGutter" type="checkbox" settingsProperty="useGitGutter" />\n                        {{Strings.USE_GIT_GUTTER}}&nbsp;&nbsp;<i title="{{Strings.REQUIRES_APP_RESTART_SETTING}}" class="settings-info-i fa-solid fa-circle-info"></i>\n                    </label>\n                </div>\n                <div>\n                    <label for="git-settings-markModifiedInTree">\n                        <input id="git-settings-markModifiedInTree" type="checkbox" settingsProperty="markModifiedInTree" />\n                        {{Strings.MARK_MODIFIED_FILES_IN_TREE}}&nbsp;&nbsp;<i title="{{Strings.REQUIRES_APP_RESTART_SETTING}}" class="settings-info-i fa-solid fa-circle-info"></i>\n                    </label>\n                </div>\n            </div>\n            <div>\n                <div>\n                    <label for="git-settings-useVerboseDiff">\n                        <input id="git-settings-useVerboseDiff" type="checkbox" settingsProperty="useVerboseDiff" />\n                        {{Strings.USE_VERBOSE_DIFF}}\n                    </label>\n                </div>\n                <div>\n                    <label for="git-settings-useDifftool">\n                        <input id="git-settings-useDifftool" type="checkbox" settingsProperty="useDifftool" />\n                        {{Strings.USE_DIFFTOOL}}\n                    </label>\n                </div>\n            </div>\n            <div>\n                <div>\n                    <label for="git-settings-clearWhitespaceOnSave">\n                        <input id="git-settings-clearWhitespaceOnSave" type="checkbox" settingsProperty="clearWhitespaceOnSave" />\n                        {{Strings.CLEAR_WHITESPACE_ON_FILE_SAVE}}\n                    </label>\n                </div>\n            </div>\n            \x3c!-- /features --\x3e\n            \x3c!-- #gitConfig --\x3e\n            <h4>{{Strings.SYSTEM_CONFIGURATION}}</h4>\n            <div class="row-fluid">\n                {{#gitNotFound}}\n                <div class="alert alert-warning">\n                    {{Strings.GIT_NOT_FOUND_MESSAGE}}\n                </div>\n                {{/gitNotFound}}\n                <label for="git-settings-gitPath">\n                    {{Strings.PATH_TO_GIT_EXECUTABLE}}:&nbsp;&nbsp;\n                    {{#gitNotFound}}\n                    <i title="{{Strings.REQUIRES_APP_RESTART_SETTING}}" class="settings-info-i fa-solid fa-circle-info"></i>\n                    {{/gitNotFound}}\n                </label>\n                <input id="git-settings-gitPath" type="text" settingsProperty="gitPath" autocomplete="off" spellcheck="false"/>\n            </div>\n            <div class="row-fluid">\n                <label for="git-settings-gitTimeout">{{Strings.DEFAULT_GIT_TIMEOUT}}:</label>\n                <input id="git-settings-gitTimeout" type="number" settingsProperty="gitTimeout" />\n            </div>\n            \x3c!-- /gitConfig --\x3e\n        </div>\n\n\n    </div>\n    <div class="modal-footer">\n        <button data-button-id="defaults"  class="dialog-button btn left"          >{{Strings.BUTTON_DEFAULTS}}</button>\n        <button data-button-id="cancel"    class="dialog-button btn cancel btn-80" >{{Strings.BUTTON_CANCEL}}</button>\n        <button data-button-id="ok"        class="dialog-button btn primary btn-80">{{Strings.BUTTON_SAVE}}</button>\n    </div>\n</div>\n';var dialog,$dialog;function setValues(values){$("*[settingsProperty]",$dialog).each(function(){var $this=$(this),type=$this.attr("type"),tag=$this.prop("tagName").toLowerCase(),property=$this.attr("settingsProperty");"checkbox"===type?$this.prop("checked",values[property]):"select"===tag?$("option[value="+values[property]+"]",$this).prop("selected",!0):$this.val(values[property])})}function collectDialogValues(){$("*[settingsProperty]",$dialog).each(function(){var $this=$(this),type=$this.attr("type"),property=$this.attr("settingsProperty"),prefType=Preferences.getType(property);if("checkbox"===type)Preferences.set(property,$this.prop("checked"));else if("number"===prefType){var newValue=parseInt($this.val().trim(),10);isNaN(newValue)&&(newValue=Preferences.getDefaults()[property]),Preferences.set(property,newValue)}else Preferences.set(property,$this.val().trim()||null)}),Preferences.save()}function assignActions(){var $useDifftoolCheckbox=$("#git-settings-useDifftool",$dialog);Git.getConfig("diff.tool").then(function(diffToolConfiguration){diffToolConfiguration?$useDifftoolCheckbox.prop({disabled:!1}):$useDifftoolCheckbox.prop({checked:!1,disabled:!0})}).catch(function(){$useDifftoolCheckbox.prop({checked:!1,disabled:!0})}),$("#git-settings-stripWhitespaceFromCommits",$dialog).on("change",function(){var on=$(this).is(":checked");$("#git-settings-addEndlineToTheEndOfFile,#git-settings-removeByteOrderMark,#git-settings-normalizeLineEndings",$dialog).prop("checked",on).prop("disabled",!on)}),$("button[data-button-id='defaults']",$dialog).on("click",function(e){e.stopPropagation(),setValues(Preferences.getDefaults())})}function init(){setValues(Preferences.getAll()),assignActions()}exports.show=function(){const enableGitPreference=Preferences.get("enableGit"),compiledTemplate=Mustache.render(settingsDialogTemplate,{Strings:Strings,gitDisabled:!enableGitPreference,gitNotFound:!!enableGitPreference&&!Setup.isExtensionActivated()});dialog=Dialogs.showModalDialogUsingTemplate(compiledTemplate),$dialog=dialog.getElement(),init(),$dialog.find("#git-settings-enableGit").on("change",function(){const anyChecked=$dialog.find("#git-settings-enableGit:checked").length>0;anyChecked?$dialog.find(".git-settings-content").removeClass("forced-inVisible"):$dialog.find(".git-settings-content").addClass("forced-inVisible")}),dialog.done(function(buttonId){"ok"===buttonId&&collectDialogValues()})}}),define("src/TabBarIntegration",function(require){const EventEmitter=require("src/EventEmitter"),Events=require("src/Events"),Git=require("src/git/Git"),Preferences=require("src/Preferences");let fileStatusCache={};function getFileStatus(fullPath){return fileStatusCache[fullPath]||null}function isModified(fullPath){const status=getFileStatus(fullPath);return!!status&&status.some(statusType=>statusType===Git.FILE_STATUS.MODIFIED||statusType===Git.FILE_STATUS.RENAMED||statusType===Git.FILE_STATUS.COPIED)}function isUntracked(fullPath){const status=getFileStatus(fullPath);return!!status&&(status.includes(Git.FILE_STATUS.UNTRACKED)||status.includes(Git.FILE_STATUS.ADDED)&&status.includes(Git.FILE_STATUS.STAGED))}return EventEmitter.on(Events.GIT_STATUS_RESULTS,function(files){fileStatusCache={};const gitRoot=Preferences.get("currentGitRoot");gitRoot&&(files.forEach(function(entry){const fullPath=gitRoot+entry.file;fileStatusCache[fullPath]=entry.status}),EventEmitter.emit("GIT_FILE_STATUS_CHANGED",fileStatusCache))}),EventEmitter.on(Events.GIT_DISABLED,function(){fileStatusCache={},EventEmitter.emit("GIT_FILE_STATUS_CHANGED",fileStatusCache)}),{getFileStatus:getFileStatus,isModified:isModified,isUntracked:isUntracked}}),define("src/Utils",function(require,exports,module){const _=brackets.getModule("thirdparty/lodash"),CommandManager=brackets.getModule("command/CommandManager"),Commands=brackets.getModule("command/Commands"),Dialogs=brackets.getModule("widgets/Dialogs"),DocumentManager=brackets.getModule("document/DocumentManager"),FileSystem=brackets.getModule("filesystem/FileSystem"),FileUtils=brackets.getModule("file/FileUtils"),LanguageManager=brackets.getModule("language/LanguageManager"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),ProjectManager=brackets.getModule("project/ProjectManager"),ErrorHandler=require("src/ErrorHandler"),Events=require("src/Events"),EventEmitter=require("src/EventEmitter"),Git=require("src/git/Git"),Preferences=require("src/Preferences"),Setup=require("src/utils/Setup"),Constants=require("src/Constants"),Strings=brackets.getModule("strings"),FORMAT_DIFF_TOO_LARGE="<div>"+Strings.DIFF_TOO_LONG+"</div>",formatDiffTemplate='<table>\n    <tbody>\n        {{#files}}\n            <tr class="meta-file">\n                <th colspan="3">{{name}}</th>\n            </tr>\n            {{#lines}}\n                <tr class="diff-row {{lineClass}}">\n                    <td class="row-num">{{numLineOld}}</td>\n                    <td class="row-num">{{numLineNew}}</td>\n                    <td><pre>{{{line}}}</pre></td>\n                </tr>\n            {{/lines}}\n            <tr class="separator"></tr>\n        {{/files}}\n    </tbody>\n</table>\n',questionDialogTemplate='<div id="git-question-dialog" class="modal">\n    <div class="modal-header">\n        <h1 class="dialog-title">{{title}}</h1>\n    </div>\n    <div class="modal-body table-striped tab-content">\n        <p>{{{question}}}</p>\n        {{#stringInput}}\n        <input class="stringInput" type="text" value="{{defaultValue}}" autocomplete="off" spellcheck="false" />\n        {{/stringInput}}\n        {{#passwordInput}}\n        <input class="stringInput" type="password" value="{{defaultValue}}" autocomplete="off" spellcheck="false" />\n        {{/passwordInput}}\n    </div>\n    <div class="modal-footer">\n        <button data-button-id="cancel" class="dialog-button btn cancel btn-80" >{{Strings.BUTTON_CANCEL}}</button>\n        <button data-button-id="ok"     class="dialog-button btn btn-80 {{#customOkBtnClass}}{{customOkBtnClass}}{{/customOkBtnClass}}{{^customOkBtnClass}}primary{{/customOkBtnClass}}">\n            {{#customOkBtn}}{{customOkBtn}}{{/customOkBtn}}{{^customOkBtn}}{{Strings.BUTTON_OK}}{{/customOkBtn}}\n        </button>\n    </div>\n</div>\n',outputDialogTemplate='<div id="git-output-dialog" class="modal">\n    {{#title}}\n    <div class="modal-header">\n        <h1 class="dialog-title">{{title}}</h1>\n    </div>\n    {{/title}}\n    <div class="modal-body table-striped tab-content">\n        <pre class="git-output">{{{output}}}</pre>\n        {{#question}}\n        <h4>{{question}}</h4>\n        {{/question}}\n    </div>\n    <div class="modal-footer">\n        <button data-button-id="close" class="dialog-button btn btn-80">{{Strings.BUTTON_CLOSE}}</button>\n        {{#question}}\n        <button data-button-id="ok"    class="dialog-button btn primary btn-80">{{Strings.BUTTON_OK}}</button>\n        {{/question}}\n    </div>\n</div>\n',writeTestResults={},EXT_NAME="[brackets-git] ";function getProjectRoot(){var projectRoot=ProjectManager.getProjectRoot();return projectRoot?projectRoot.fullPath:null}function getExtensionDirectory(){throw new Error("api unsupported")}function formatDiff(diff){for(var DIFF_MAX_LENGTH=2e3,tabReplace="",verbose=Preferences.get("useVerboseDiff"),numLineOld=0,numLineNew=0,lastStatus=0,diffData=[],i=Preferences.getGlobal("tabSize");i--;)tabReplace+="&nbsp;";var LINE_STATUS_HEADER=0,LINE_STATUS_UNCHANGED=1,LINE_STATUS_REMOVED=2,LINE_STATUS_ADDED=3,LINE_STATUS_EOF=4,diffSplit=diff.split("\n");return diffSplit.length>2e3?""+FORMAT_DIFF_TOO_LARGE:(diffSplit.forEach(function(line){" "===line&&(line="");var lineClass="",pushLine=!0;if(0===line.indexOf("diff --git"))lineClass="diffCmd",diffData.push({name:line.split("b/")[1],lines:[]}),verbose||(pushLine=!1);else if(line.match(/index\s[A-z0-9]{7}\.\.[A-z0-9]{7}/))verbose||(pushLine=!1);else if("+++"===line.substr(0,3)||"---"===line.substr(0,3))verbose||(pushLine=!1);else if(0===line.indexOf("@@")){lineClass="position",lastStatus=LINE_STATUS_HEADER;var m=line.match(/^@@ -([,0-9]+) \+([,0-9]+) @@/),s1=m[1].split(","),s2=m[2].split(",");numLineOld=s1[0]-1,numLineNew=s2[0]-1}else"+"===line[0]?(lineClass="added",line=line.substring(1),lastStatus=LINE_STATUS_ADDED,numLineNew++):"-"===line[0]?(lineClass="removed",line=line.substring(1),lastStatus=LINE_STATUS_REMOVED,numLineOld++):" "===line[0]||""===line?(lineClass="unchanged",line=line.substring(1),lastStatus=LINE_STATUS_UNCHANGED,numLineOld++,numLineNew++):"\\ No newline at end of file"===line?(lastStatus=LINE_STATUS_EOF,lineClass="end-of-file"):console.log("Unexpected line in diff: "+line);if(pushLine){var _numLineOld="",_numLineNew="";switch(lastStatus){case LINE_STATUS_HEADER:case LINE_STATUS_EOF:break;case LINE_STATUS_UNCHANGED:_numLineOld=numLineOld,_numLineNew=numLineNew;break;case LINE_STATUS_REMOVED:_numLineOld=numLineOld;break;default:_numLineNew=numLineNew}line=(line=line.replace(/\uFEFF/g,"")).replace(/[\u2000-\uFFFF]/g,function(x){return"<U+"+x.charCodeAt(0).toString(16).toUpperCase()+">"}),line=(line=_.escape(line).replace(/\t/g,tabReplace).replace(/\s/g,"&nbsp;")).replace(/(&nbsp;)+$/g,function(trailingWhitespace){return"<span class='trailingWhitespace'>"+trailingWhitespace+"</span>"}),diffData.length>0&&_.last(diffData).lines.push({numLineOld:_numLineOld,numLineNew:_numLineNew,line:line,lineClass:lineClass})}}),Mustache.render(formatDiffTemplate,{files:diffData}))}function askQuestion(title,question,options){return new Promise(function(resolve,reject){(options=options||{}).noescape||(question=_.escape(question));var compiledTemplate=Mustache.render(questionDialogTemplate,{title:title,question:question,stringInput:!options.booleanResponse&&!options.password,passwordInput:options.password,defaultValue:options.defaultValue,customOkBtn:options.customOkBtn,customOkBtnClass:options.customOkBtnClass,Strings:Strings}),dialog=Dialogs.showModalDialogUsingTemplate(compiledTemplate),$dialog=dialog.getElement();_.defer(function(){var $input=$dialog.find("input:visible");$input.length>0?$input.focus():$dialog.find(".primary").focus()}),dialog.done(function(buttonId){if(options.booleanResponse)return resolve("ok"===buttonId);"ok"===buttonId?resolve(dialog.getElement().find("input").val().trim()):reject(Strings.USER_ABORTED)})})}function showOutput(output,title,options){return new Promise(function(resolve){options=options||{};var compiledTemplate=Mustache.render(outputDialogTemplate,{title:title,output:output,Strings:Strings,question:options.question}),dialog=Dialogs.showModalDialogUsingTemplate(compiledTemplate);dialog.getElement().find("button").focus(),dialog.done(function(buttonId){resolve("ok"===buttonId)})})}function isProjectRootWritable(){return new Promise(function(resolve){var folder=getProjectRoot();if(writeTestResults[folder])return resolve(writeTestResults[folder]);var fileEntry=FileSystem.getFileForPath(folder+".phoenixGitTemp");function finish(bool){fileEntry.unlink(function(){writeTestResults[folder]=bool,resolve(bool)})}jsPromise(FileUtils.writeText(fileEntry,"")).then(function(){finish(!0)}).catch(function(){finish(!1)})})}function pathExists(path){return new Promise(function(resolve){FileSystem.resolve(path,function(err,entry){resolve(!(err||!entry))})})}function loadPathContent(path){return new Promise(function(resolve){FileSystem.resolve(path,function(err,entry){if(err)return resolve(null);entry._clearCachedData&&entry._clearCachedData(),entry.isFile?entry.read(function(err,content){if(err)return resolve(null);resolve(content)}):entry.getContents(function(err,contents){if(err)return resolve(null);resolve(contents)})})})}function isLoading($btn){return $btn.hasClass("btn-loading")}function setLoading($btn){$btn.prop("disabled",!0).addClass("btn-loading")}function unsetLoading($btn){$btn.prop("disabled",!1).removeClass("btn-loading")}function encodeSensitiveInformation(str){return str=(str=str.replace(/(https?:\/\/)([^:@\s]*):([^:@]*)?@/g,function(a,protocol,user){return protocol+user+":***@"})).replace(/(users)(\\|\/)([^\\\/]+)(\\|\/)/i,function(a,users,slash1,username,slash2){return users+slash1+"***"+slash2})}function consoleWarn(msg){console.warn(encodeSensitiveInformation(msg))}function consoleError(msg){console.error(encodeSensitiveInformation(msg))}function consoleDebug(msg){logger.loggingOptions.logGit&&console.log(EXT_NAME+encodeSensitiveInformation(msg))}function reloadDoc(doc){return jsPromise(FileUtils.readAsText(doc.file)).then(function(text){doc.refreshText(text,new Date)}).catch(function(err){ErrorHandler.logError("Error reloading contents of "+doc.file.fullPath),ErrorHandler.logError(err)})}function stripWhitespaceFromFile(filename,clearWholeFile){return new Promise(function(resolve,reject){var fullPath=Preferences.get("currentGitRoot")+filename,addEndlineToTheEndOfFile=Preferences.get("addEndlineToTheEndOfFile"),removeBom=Preferences.get("removeByteOrderMark"),normalizeLineEndings=Preferences.get("normalizeLineEndings"),_cleanLines=function(lineNumbers){if(lineNumbers&&0===lineNumbers.length)return resolve();var fileEntry=FileSystem.getFileForPath(fullPath);return jsPromise(FileUtils.readAsText(fileEntry)).catch(function(err){return ErrorHandler.logError(err+" on FileUtils.readAsText for "+fileEntry.fullPath),null}).then(function(text){if(null===text)return resolve();removeBom&&(text=text.replace(/\uFEFF/g,"")),normalizeLineEndings&&(text=text.replace(/\r\n/g,"\n"));var lines=text.split("\n");if(lineNumbers?lineNumbers.forEach(function(lineNumber){"string"==typeof lines[lineNumber]&&(lines[lineNumber]=lines[lineNumber].replace(/\s+$/,""))}):lines.forEach(function(ln,lineNumber){"string"==typeof lines[lineNumber]&&(lines[lineNumber]=lines[lineNumber].replace(/\s+$/,""))}),addEndlineToTheEndOfFile){var lastLineNumber=lines.length-1;lines[lastLineNumber].length>0&&(lines[lastLineNumber]=lines[lastLineNumber].replace(/\s+$/,"")),lines[lastLineNumber].length>0&&lines.push("")}return text=lines.join("\n"),jsPromise(FileUtils.writeText(fileEntry,text)).catch(function(err){throw ErrorHandler.logError("Wasn't able to clean whitespace from file: "+fullPath),resolve(),err}).then(function(){DocumentManager.getAllOpenDocuments().forEach(function(doc){doc.file.fullPath===fullPath&&reloadDoc(doc)}),resolve()})})};clearWholeFile?_cleanLines(null):Git.diffFile(filename).then(function(diff){if(!diff)return resolve();if(diff.match(/^binary files.*differ$/gim))return resolve();var modified=[],changesets;diff.split("\n").filter(function(l){return null!==l.match(/^@@/)}).forEach(function(line){var i,m,s=line.match(/^@@ -([,0-9]+) \+([,0-9]+) @@/)[2].split(","),from=parseInt(s[0],10),to=from-1+(parseInt(s[1],10)||1);for(i=from;i<=to;i++)modified.push(i>0?i-1:0)}),_cleanLines(modified)}).catch(function(ex){ErrorHandler.logError(ex),reject(ex)})})}function stripWhitespaceFromFiles(gitStatusResults,stageChanges,progressTracker){return new Promise((resolve,reject)=>{const startTime=(new Date).getTime();let queue=Promise.resolve();gitStatusResults.forEach(function(fileObj){var isDeleted;if(!(-1!==fileObj.status.indexOf(Git.FILE_STATUS.DELETED))){var langId=LanguageManager.getLanguageForPath(fileObj.file).getId();-1===["unknown","binary","image","markdown","audio"].indexOf(langId)&&(queue=queue.then(function(){var clearWholeFile=-1!==fileObj.status.indexOf(Git.FILE_STATUS.UNTRACKED)||-1!==fileObj.status.indexOf(Git.FILE_STATUS.RENAMED),t=(new Date).getTime()-startTime;return progressTracker.trigger(Events.GIT_PROGRESS_EVENT,t+"ms - "+Strings.CLEAN_FILE_START+": "+fileObj.file),stripWhitespaceFromFile(fileObj.file,clearWholeFile).then(function(){var notifyProgress=function(){var t=(new Date).getTime()-startTime;progressTracker.trigger(Events.GIT_PROGRESS_EVENT,t+"ms - "+Strings.CLEAN_FILE_END+": "+fileObj.file)};if(stageChanges)return Git.stage(fileObj.file).then(notifyProgress);notifyProgress()})}))}}),queue.then(function(){resolve()}).catch(function(){reject()})})}function openEditorForFile(file,relative){relative&&(file=getProjectRoot()+file),CommandManager.execute(Commands.FILE_OPEN,{fullPath:file})}let clearWhitespace=Preferences.get("clearWhitespaceOnSave");function enableCommand(commandID,enabled){const command=CommandManager.get(commandID);command&&(enabled=commandID===Constants.CMD_GIT_SETTINGS_COMMAND_ID||enabled&&Setup.isExtensionActivated(),command.setEnabled(enabled))}Preferences.getExtensionPref().on("change","clearWhitespaceOnSave",()=>{clearWhitespace=Preferences.get("clearWhitespaceOnSave")}),EventEmitter.on(Events.BRACKETS_DOCUMENT_SAVED,function(doc){if(clearWhitespace){var fullPath=doc.file.fullPath,currentGitRoot=Preferences.get("currentGitRoot"),path;stripWhitespaceFromFile(fullPath.substring(currentGitRoot.length))}}),exports.FORMAT_DIFF_TOO_LARGE=FORMAT_DIFF_TOO_LARGE,exports.formatDiff=formatDiff,exports.getProjectRoot=getProjectRoot,exports.getExtensionDirectory=getExtensionDirectory,exports.askQuestion=askQuestion,exports.showOutput=showOutput,exports.isProjectRootWritable=isProjectRootWritable,exports.pathExists=pathExists,exports.loadPathContent=loadPathContent,exports.setLoading=setLoading,exports.unsetLoading=unsetLoading,exports.isLoading=isLoading,exports.consoleWarn=consoleWarn,exports.consoleError=consoleError,exports.consoleDebug=consoleDebug,exports.encodeSensitiveInformation=encodeSensitiveInformation,exports.reloadDoc=reloadDoc,exports.stripWhitespaceFromFiles=stripWhitespaceFromFiles,exports.openEditorForFile=openEditorForFile,exports.enableCommand=enableCommand}),define("src/dialogs/Clone",function(require,exports){const Dialogs=brackets.getModule("widgets/Dialogs"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),RemoteCommon=require("src/dialogs/RemoteCommon"),Strings=brackets.getModule("strings"),template='<div id="git-clone-dialog" class="git modal">\n    <div class="modal-header">\n        <h1 class="dialog-title">{{Strings.CLONE_REPOSITORY}}</h1>\n    </div>\n    <div class="modal-body">\n\n        <label for="git-clone-url">{{Strings.ENTER_REMOTE_GIT_URL}}</label>\n        <input type="text" class="stringInput" id="git-clone-url" autocomplete="off" spellcheck="false" />\n\n        <hr>\n\n        <div class="accordion">\n            \x3c!-- Hidden checkbox to toggle the accordion --\x3e\n            <input type="checkbox" id="advancedAccordionToggle" class="accordion-toggle" />\n\n            \x3c!-- Accordion Header --\x3e\n            <label for="advancedAccordionToggle" class="accordion-header">\n                {{Strings.MORE_OPTIONS}}\n                <i class="fas fa-chevron-down"></i>\n            </label>\n\n            \x3c!-- Accordion Content --\x3e\n            <div class="accordion-content">\n                <label class="text-bold">\n                    {{Strings.CREDENTIALS}}\n                </label>\n                <div>\n                    <label class="text-quiet">\n                        {{Strings.SAVE_CREDENTIALS_HELP}}\n                    </label>\n                </div>\n\n                <div>\n                    <label>\n                        {{Strings.USERNAME}}:\n                    </label>\n                    <label>\n                        <input type="text" name="username" value="{{config.remoteUsername}}" autocomplete="off" spellcheck="false"/>\n                    </label>\n                </div>\n\n                <div>\n                    <label>\n                        {{Strings.PASSWORD}}:\n                    </label>\n                    <label>\n                        <input type="password" name="password" value="{{config.remotePassword}}" autocomplete="off" spellcheck="false"/>\n                    </label>\n                </div>\n\n                <div>\n                    <label>\n                        <input type="checkbox" name="saveToUrl" />\n                        {{Strings.SAVE_CREDENTIALS_IN_URL}}\n                    </label>\n                </div>\n            </div>\n        </div>\n\n\n    </div>\n    <div class="modal-footer">\n        <button class="dialog-button btn" data-button-id="cancel">{{Strings.CANCEL}}</button>\n        <button class="dialog-button btn primary" data-button-id="ok">{{Strings.OK}}</button>\n    </div>\n</div>\n';let $cloneInput;function _attachEvents($dialog){$cloneInput.on("keyup change",function(){var $authInputs=$dialog.find("input[name='username'],input[name='password'],input[name='saveToUrl']");if($(this).val().length>0)if(/^https?:/.test($(this).val())){$authInputs.prop("disabled",!1);var auth=/:\/\/([^:]+):?([^@]*)@/.exec($(this).val());auth&&($("input[name=username]",$dialog).val(auth[1]),$("input[name=password]",$dialog).val(auth[2]))}else $authInputs.prop("disabled",!0);else $authInputs.prop("disabled",!1)}),$cloneInput.focus()}function show(){return new Promise((resolve,reject)=>{const templateArgs={modeLabel:Strings.CLONE_REPOSITORY,Strings:Strings};var compiledTemplate=Mustache.render(template,templateArgs),dialog=Dialogs.showModalDialogUsingTemplate(compiledTemplate),$dialog=dialog.getElement();$cloneInput=$dialog.find("#git-clone-url"),_attachEvents($dialog),dialog.done(function(buttonId){if("ok"===buttonId){var cloneConfig={remote:"origin"};cloneConfig.remoteUrl=$cloneInput.val(),RemoteCommon.collectValues(cloneConfig,$dialog),resolve(cloneConfig)}else reject()})})}exports.show=show}),define("src/dialogs/Progress",function(require,exports){const EventDispatcher=brackets.getModule("utils/EventDispatcher"),Dialogs=brackets.getModule("widgets/Dialogs"),Strings=brackets.getModule("strings"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),Events=require("src/Events");var template='<div id="git-progress-dialog" class="modal">\n    <div class="modal-header">\n        <h1 class="dialog-title">{{title}}</h1>\n    </div>\n    <div class="modal-body">\n        <textarea readonly="readonly"></textarea>\n    </div>\n    \x3c!--\n    <div class="modal-footer">\n        <button class="dialog-button btn" data-button-id="cancel">{{Strings.CANCEL}}</button>\n        <button class="dialog-button btn primary" data-button-id="ok">{{Strings.OK}}</button>\n    </div>\n    --\x3e\n</div>\n',lines,$textarea;const maxLines=5e3;function addLine(str){lines.length>=maxLines&&lines.shift(),lines.push(str)}let updateTimeout=null;function updateTextarea(){updateTimeout||(updateTimeout=setTimeout(()=>{updateTimeout=null,$textarea&&lines.length&&($textarea.val(lines.join("\n")),$textarea.scrollTop($textarea[0].scrollHeight-$textarea.height()))},100))}function onProgress(str){"string"==typeof str&&addLine(str),updateTextarea()}function show(promise,progressTracker,showOpts={}){if(!promise||!promise.finally)throw new Error("Invalid promise argument for progress dialog!");if(!progressTracker)throw new Error("Invalid progressTracker argument for progress dialog!");const title=showOpts.title,options=showOpts.options||{};return new Promise(function(resolve,reject){lines=showOpts.initialMessage?[showOpts.initialMessage]:[],$textarea=null;var dialog,finished=!1;function showDialog(){if(!finished){var templateArgs={title:title||Strings.OPERATION_IN_PROGRESS_TITLE,Strings:Strings},compiledTemplate=Mustache.render(template,templateArgs);dialog=Dialogs.showModalDialogUsingTemplate(compiledTemplate),($textarea=dialog.getElement().find("textarea")).val(Strings.PLEASE_WAIT),onProgress()}}let finalValue,finalError;function finish(){finished=!0,dialog&&dialog.close(),finalError?reject(finalError):resolve(finalValue)}options.preDelay?setTimeout(function(){showDialog()},1e3*options.preDelay):showDialog(),progressTracker.off(`${Events.GIT_PROGRESS_EVENT}.progressDlg`),progressTracker.on(`${Events.GIT_PROGRESS_EVENT}.progressDlg`,(_evt,data)=>{onProgress(data)}),promise.then(val=>{finalValue=val}).catch(err=>{finalError=err}).finally(function(){progressTracker.off(`${Events.GIT_PROGRESS_EVENT}.progressDlg`),onProgress("Finished!"),options.postDelay&&dialog?setTimeout(function(){finish()},1e3*options.postDelay):finish()})})}function waitForClose(){return new Promise(function(resolve){function check(){var visible;$("#git-progress-dialog").is(":visible")?setTimeout(check,20):resolve()}setTimeout(check,20)})}function newProgressTracker(){const tracker={};return EventDispatcher.makeEventDispatcher(tracker),tracker}exports.show=show,exports.newProgressTracker=newProgressTracker,exports.waitForClose=waitForClose}),define("src/dialogs/Pull",function(require,exports){const Dialogs=brackets.getModule("widgets/Dialogs"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),Preferences=require("src/Preferences"),RemoteCommon=require("src/dialogs/RemoteCommon"),Strings=brackets.getModule("strings"),template='<div id="git-pull-dialog" class="git modal">\n    <div class="modal-header">\n        <h1 class="dialog-title">{{Strings.DIALOG_PULL_TITLE}} &mdash; {{config.remote}}</h1>\n    </div>\n    <div class="modal-body">\n\n        {{> remotes}}\n\n        <hr>\n        <label class="text-bold">\n            {{Strings.PULL_BEHAVIOR}}\n        </label>\n        <div>\n            <label>\n                <input type="radio" name="strategy" value="DEFAULT"> {{Strings.PULL_DEFAULT}}\n            </label>\n        </div>\n\n        <div>\n            <label>\n                <input type="radio" name="strategy" value="AVOID_MERGING"> {{Strings.PULL_AVOID_MERGING}}\n            </label>\n        </div>\n\n        <div>\n            <label>\n                <input type="radio" name="strategy" value="MERGE_NOCOMMIT"> {{Strings.PULL_MERGE_NOCOMMIT}}\n            </label>\n        </div>\n\n        <div>\n            <label>\n                <input type="radio" name="strategy" value="REBASE"> {{Strings.PULL_REBASE}}\n            </label>\n        </div>\n\n        <div>\n            <label>\n                <input type="radio" name="strategy" value="RESET"> {{Strings.PULL_RESET}}\n            </label>\n        </div>\n\n        <hr>\n\n        <div class="accordion">\n            \x3c!-- Hidden checkbox to toggle the accordion --\x3e\n            <input type="checkbox" id="advancedAccordionToggle" class="accordion-toggle" />\n\n            \x3c!-- Accordion Header --\x3e\n            <label for="advancedAccordionToggle" class="accordion-header">\n                {{Strings.MORE_OPTIONS}}\n                <i class="fas fa-chevron-down"></i>\n            </label>\n\n            \x3c!-- Accordion Content --\x3e\n            <div class="accordion-content">\n                <label class="text-bold">\n                    {{Strings.CREDENTIALS}}\n                </label>\n                <div>\n                    <label class="text-quiet">\n                        {{Strings.SAVE_CREDENTIALS_HELP}}\n                    </label>\n                </div>\n\n                <div>\n                    <label>\n                        {{Strings.USERNAME}}:\n                    </label>\n                    <label>\n                        <input type="text" name="username" value="{{config.remoteUsername}}" autocomplete="off" spellcheck="false"/>\n                    </label>\n                </div>\n\n                <div>\n                    <label>\n                        {{Strings.PASSWORD}}:\n                    </label>\n                    <label>\n                        <input type="password" name="password" value="{{config.remotePassword}}" autocomplete="off" spellcheck="false"/>\n                    </label>\n                </div>\n\n                <div>\n                    <label>\n                        <input type="checkbox" name="saveToUrl" />\n                        {{Strings.SAVE_CREDENTIALS_IN_URL}}\n                    </label>\n                </div>\n            </div>\n        </div>\n\n    </div>\n    <div class="modal-footer">\n        <button class="dialog-button btn" data-button-id="cancel">{{Strings.CANCEL}}</button>\n        <button class="dialog-button btn primary" data-button-id="ok">{{Strings.OK}}</button>\n    </div>\n</div>\n',remotesTemplate='<div class="current-tracking-branch">\n    <label>\n        {{Strings.CURRENT_TRACKING_BRANCH}}:\n    </label>\n    <label class="text-bold">\n        {{config.currentTrackingBranch}}\n        {{^config.currentTrackingBranch}}\n        none - "{{config.currentBranchName}}" branch will be created on remote\n        {{/config.currentTrackingBranch}}\n    </label>\n</div>\n\n<div>\n    <label class="text-bold">\n        {{Strings.TARGET_BRANCH}}\n    </label>\n    <label>\n        <input type="radio" name="action" value="{{mode}}_CURRENT" checked> {{modeLabel}} {{Strings._CURRENT_TRACKING_BRANCH}}\n    </label>\n</div>\n\n<div>\n    <label>\n        <input type="radio" name="action" value="{{mode}}_SELECTED"> {{modeLabel}} {{Strings._ANOTHER_BRANCH}}\n    </label>\n</div>\n\n<div class="only-from-selected" style="margin-left: 15px;">\n    <div class="input-append">\n        <select class="branchSelect" name="selectedBranch"></select>\n        <button class="btn fetchBranches" type="button"><i class="octicon octicon-sync"></i></button>\n    </div>\n</div>\n\n<div class="only-from-selected" style="margin-left: 15px;">\n    <label>\n        <input type="checkbox" name="setBranchAsTracking"> {{Strings.SET_THIS_BRANCH_AS_TRACKING}}\n    </label>\n</div>\n';function _attachEvents($dialog,pullConfig){RemoteCommon.attachCommonEvents(pullConfig,$dialog),$dialog.find("input[name='strategy']").filter("[value='"+(Preferences.get("pull.strategy")||"DEFAULT")+"']").prop("checked",!0)}function _show(pullConfig,resolve,reject){const templateArgs={config:pullConfig,mode:"PULL_FROM",modeLabel:Strings.PULL_FROM,Strings:Strings},compiledTemplate=Mustache.render(template,templateArgs,{remotes:remotesTemplate}),dialog=Dialogs.showModalDialogUsingTemplate(compiledTemplate),$dialog=dialog.getElement();_attachEvents($dialog,pullConfig),dialog.done(function(buttonId){"ok"===buttonId?(RemoteCommon.collectValues(pullConfig,$dialog),Preferences.set("pull.strategy",pullConfig.strategy),resolve(pullConfig)):reject()})}function show(pullConfig){return new Promise((resolve,reject)=>{pullConfig.pull=!0,RemoteCommon.collectInfo(pullConfig).then(()=>{_show(pullConfig,resolve,reject)})})}exports.show=show}),define("src/dialogs/Push",function(require,exports){const Dialogs=brackets.getModule("widgets/Dialogs"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),RemoteCommon=require("src/dialogs/RemoteCommon"),Strings=brackets.getModule("strings"),template='<div id="git-push-dialog" class="git modal">\n    <div class="modal-header">\n        <h1 class="dialog-title">{{Strings.DIALOG_PUSH_TITLE}} &mdash; {{config.remote}}</h1>\n    </div>\n    <div class="modal-body">\n\n        {{> remotes}}\n\n        <hr>\n        <label class="text-bold">\n            {{Strings.PUSH_BEHAVIOR}}\n        </label>\n\n        <div>\n            <label>\n                <input type="radio" name="strategy" value="DEFAULT"> {{Strings.PUSH_DEFAULT}}\n            </label>\n        </div>\n\n        <div>\n            <label>\n                <input type="radio" name="strategy" value="FORCED"> {{Strings.PUSH_FORCED}}\n            </label>\n        </div>\n\n        <div>\n            <label>\n                <input type="radio" name="strategy" value="DELETE_BRANCH"> {{Strings.PUSH_DELETE_BRANCH}}\n            </label>\n        </div>\n\n        <hr>\n\n        <div class="accordion">\n            \x3c!-- Hidden checkbox to toggle the accordion --\x3e\n            <input type="checkbox" id="advancedAccordionToggle" class="accordion-toggle" />\n\n            \x3c!-- Accordion Header --\x3e\n            <label for="advancedAccordionToggle" class="accordion-header">\n                {{Strings.MORE_OPTIONS}}\n                <i class="fas fa-chevron-down"></i>\n            </label>\n\n            \x3c!-- Accordion Content --\x3e\n            <div class="accordion-content">\n                <div>\n                    <label>\n                        <input type="checkbox" name="send_tags" value="true"> {{Strings.PUSH_SEND_TAGS}}\n                    </label>\n                </div>\n                <div>\n                    <label>\n                        <input type="checkbox" name="push-no-verify" value="true"> {{Strings.SKIP_PRE_PUSH_CHECKS}}\n                    </label>\n                </div>\n                <br>\n                <label class="text-bold">\n                    {{Strings.CREDENTIALS}}\n                </label>\n                <div>\n                    <label class="text-quiet">\n                        {{Strings.SAVE_CREDENTIALS_HELP}}\n                    </label>\n                </div>\n\n                <div>\n                    <label>\n                        {{Strings.USERNAME}}:\n                    </label>\n                    <label>\n                        <input type="text" name="username" value="{{config.remoteUsername}}" autocomplete="off" spellcheck="false"/>\n                    </label>\n                </div>\n\n                <div>\n                    <label>\n                        {{Strings.PASSWORD}}:\n                    </label>\n                    <label>\n                        <input type="password" name="password" value="{{config.remotePassword}}" autocomplete="off" spellcheck="false"/>\n                    </label>\n                </div>\n\n                <div>\n                    <label>\n                        <input type="checkbox" name="saveToUrl" />\n                        {{Strings.SAVE_CREDENTIALS_IN_URL}}\n                    </label>\n                </div>\n            </div>\n        </div>\n\n    </div>\n    <div class="modal-footer">\n        <button class="dialog-button btn" data-button-id="cancel">{{Strings.CANCEL}}</button>\n        <button class="dialog-button btn primary" data-button-id="ok">{{Strings.OK}}</button>\n    </div>\n</div>\n',remotesTemplate='<div class="current-tracking-branch">\n    <label>\n        {{Strings.CURRENT_TRACKING_BRANCH}}:\n    </label>\n    <label class="text-bold">\n        {{config.currentTrackingBranch}}\n        {{^config.currentTrackingBranch}}\n        none - "{{config.currentBranchName}}" branch will be created on remote\n        {{/config.currentTrackingBranch}}\n    </label>\n</div>\n\n<div>\n    <label class="text-bold">\n        {{Strings.TARGET_BRANCH}}\n    </label>\n    <label>\n        <input type="radio" name="action" value="{{mode}}_CURRENT" checked> {{modeLabel}} {{Strings._CURRENT_TRACKING_BRANCH}}\n    </label>\n</div>\n\n<div>\n    <label>\n        <input type="radio" name="action" value="{{mode}}_SELECTED"> {{modeLabel}} {{Strings._ANOTHER_BRANCH}}\n    </label>\n</div>\n\n<div class="only-from-selected" style="margin-left: 15px;">\n    <div class="input-append">\n        <select class="branchSelect" name="selectedBranch"></select>\n        <button class="btn fetchBranches" type="button"><i class="octicon octicon-sync"></i></button>\n    </div>\n</div>\n\n<div class="only-from-selected" style="margin-left: 15px;">\n    <label>\n        <input type="checkbox" name="setBranchAsTracking"> {{Strings.SET_THIS_BRANCH_AS_TRACKING}}\n    </label>\n</div>\n';function _attachEvents($dialog,pushConfig){RemoteCommon.attachCommonEvents(pushConfig,$dialog),$dialog.find("input[name='strategy']").filter("[value='DEFAULT']").prop("checked",!0)}function _show(pushConfig,resolve,reject){const templateArgs={config:pushConfig,mode:"PUSH_TO",modeLabel:Strings.PUSH_TO,Strings:Strings},compiledTemplate=Mustache.render(template,templateArgs,{remotes:remotesTemplate}),dialog=Dialogs.showModalDialogUsingTemplate(compiledTemplate),$dialog=dialog.getElement();_attachEvents($dialog,pushConfig),dialog.done(function(buttonId){"ok"===buttonId?(RemoteCommon.collectValues(pushConfig,$dialog),resolve(pushConfig)):reject()})}function show(pushConfig){return new Promise((resolve,reject)=>{pushConfig.push=!0,RemoteCommon.collectInfo(pushConfig).then(()=>{_show(pushConfig,resolve,reject)})})}exports.show=show}),define("src/dialogs/RemoteCommon",function(require,exports){const _=brackets.getModule("thirdparty/lodash"),Strings=brackets.getModule("strings"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),ErrorHandler=require("src/ErrorHandler"),Git=require("src/git/Git"),ProgressDialog=require("src/dialogs/Progress");function fillBranches(config,$dialog){Git.getAllBranches().then(function(branches){branches=_.filter(branches,function(branch){return branch.remote===config.remote});const template="{{#branches}}<option value='{{name}}' remote='{{remote}}' {{#currentBranch}}selected{{/currentBranch}}>{{name}}</option>{{/branches}}",html=Mustache.render(template,{branches:branches});$dialog.find(".branchSelect").html(html)}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_BRANCH_LIST)})}exports.collectInfo=function(config){return Git.getCurrentUpstreamBranch().then(function(upstreamBranch){return config.currentTrackingBranch=upstreamBranch,Git.getRemoteUrl(config.remote).then(function(remoteUrl){if(config.remoteUrl=remoteUrl,remoteUrl.match(/^https?:/)){const url=new URL(remoteUrl);config.remoteUsername=url.username,config.remotePassword=url.password}else config._usernamePasswordDisabled=!0;if(!upstreamBranch)return Git.getCurrentBranchName().then(function(currentBranchName){config.currentBranchName=currentBranchName})})}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_FETCH_REMOTE)})},exports.attachCommonEvents=function(config,$dialog){const handleRadioChange=function(){const val=$dialog.find("input[name='action']:checked").val();$dialog.find(".only-from-selected").toggle("PULL_FROM_SELECTED"===val||"PUSH_TO_SELECTED"===val)};$dialog.on("change","input[name='action']",handleRadioChange),handleRadioChange();let trackingBranchRemote=null;config.currentTrackingBranch&&(trackingBranchRemote=config.currentTrackingBranch.substring(0,config.currentTrackingBranch.indexOf("/"))),config.currentTrackingBranch&&trackingBranchRemote!==config.remote&&(config.pull?($dialog.find("input[value='PULL_FROM_CURRENT']").prop("disabled",!0),$dialog.find("input[value='PULL_FROM_SELECTED']").prop("checked",!0).trigger("change")):($dialog.find("input[value='PUSH_TO_CURRENT']").prop("disabled",!0),$dialog.find("input[value='PUSH_TO_SELECTED']").prop("checked",!0).trigger("change"))),$dialog.on("click",".fetchBranches",function(){const tracker=ProgressDialog.newProgressTracker();ProgressDialog.show(Git.fetchRemote(config.remote,tracker),tracker).then(function(){fillBranches(config,$dialog)}).catch(function(err){ErrorHandler.showError(err,Strings.ERROR_FETCH_REMOTE)})}),fillBranches(config,$dialog),config._usernamePasswordDisabled&&$dialog.find("input[name='username'],input[name='password'],input[name='saveToUrl']").prop("disabled",!0)},exports.collectValues=function(config,$dialog){const action=$dialog.find("input[name='action']:checked").val();let remoteUrlNew;if("PULL_FROM_CURRENT"===action||"PUSH_TO_CURRENT"===action?config.currentTrackingBranch?config.branch=config.currentTrackingBranch.substring(config.remote.length+1):(config.branch=config.currentBranchName,config.pushToNew=!0):"PULL_FROM_SELECTED"!==action&&"PUSH_TO_SELECTED"!==action||(config.branch=$dialog.find(".branchSelect").val().substring(config.remote.length+1),config.setBranchAsTracking=$dialog.find("input[name='setBranchAsTracking']").is(":checked")),config.strategy=$dialog.find("input[name='strategy']:checked").val(),config.tags=$dialog.find("input[name='send_tags']:checked").val(),config.noVerify=$dialog.find("input[name='push-no-verify']:checked").val(),config.remoteUsername=$dialog.find("input[name='username']").val(),config.remotePassword=$dialog.find("input[name='password']").val(),config.remoteUrl.match(/^https?:/)){const url=new URL(config.remoteUrl);url.username=config.remoteUsername,url.password=config.remotePassword,remoteUrlNew=url.toString()}remoteUrlNew&&config.remoteUrl!==remoteUrlNew&&(config.remoteUrlNew=remoteUrlNew);const saveToUrl=$dialog.find("input[name='saveToUrl']").is(":checked");config.remoteUrlNew&&!saveToUrl&&(config.remoteUrlRestore=config.remoteUrl)}}),define("src/git/Git",function(require,exports){const Preferences=require("src/Preferences"),GitCli=require("src/git/GitCli"),Utils=require("src/Utils");function pushToNewUpstream(remoteName,remoteBranch,options={}){const args=["--set-upstream"];return options.noVerify&&args.push("--no-verify"),GitCli.push(remoteName,remoteBranch,args,options.progressTracker)}function getRemoteUrl(remote){return GitCli.getConfig("remote."+remote+".url")}function setRemoteUrl(remote,url){return GitCli.setConfig("remote."+remote+".url",url)}function sortBranches(branches){return branches.sort(function(a,b){var ar=a.remote||"",br=b.remote||"";return br&&"origin"===ar&&"origin"!==br?-1:ar&&"origin"!==ar&&"origin"===br?1:ar<br?-1:ar>br?1:a.sortPrefix<b.sortPrefix?-1:a.sortPrefix>b.sortPrefix?1:"master"===a.sortName&&"master"!==b.sortName?-1:"master"!==a.sortName&&"master"===b.sortName?1:a.sortName<b.sortName?-1:a.sortName>b.sortName?1:0})}function getBranches(){return GitCli.getBranches().then(function(branches){return sortBranches(branches)})}function getAllBranches(){return GitCli.getAllBranches().then(function(branches){return sortBranches(branches)})}function getHistory(branch,skip){return GitCli.getHistory(branch,skip)}function getFileHistory(file,branch,skip){return GitCli.getHistory(branch,skip,file)}function resetIndex(){return GitCli.reset()}function discardAllChanges(){return GitCli.reset("--hard").then(function(){return GitCli.clean()})}function getMergeInfo(){var baseCheck=["MERGE_MODE","rebase-apply"],mergeCheck=["MERGE_HEAD","MERGE_MSG"],rebaseCheck=["rebase-apply/next","rebase-apply/last","rebase-apply/head-name"],gitFolder=Preferences.get("currentGitRoot")+".git/";return Promise.all(baseCheck.map(function(fileName){return Utils.loadPathContent(gitFolder+fileName)})).then(function([mergeMode,rebaseMode]){var obj={mergeMode:null!==mergeMode,rebaseMode:null!==rebaseMode};return obj.mergeMode?Promise.all(mergeCheck.map(function(fileName){return Utils.loadPathContent(gitFolder+fileName)})).then(function([head,msg]){head&&(obj.mergeHead=head.trim());var msgSplit=msg?msg.trim().split(/conflicts:/i):[];return msgSplit[0]&&(obj.mergeMessage=msgSplit[0].trim()),msgSplit[1]&&(obj.mergeConflicts=msgSplit[1].trim().split("\n").map(function(line){return line.trim()})),obj}):obj.rebaseMode?Promise.all(rebaseCheck.map(function(fileName){return Utils.loadPathContent(gitFolder+fileName)})).then(function([next,last,head]){return next&&(obj.rebaseNext=next.trim()),last&&(obj.rebaseLast=last.trim()),head&&(obj.rebaseHead=head.trim().substring("refs/heads/".length)),obj}):obj})}function discardFileChanges(file){return GitCli.unstage(file).then(function(){return GitCli.checkout(file)})}function pushForced(remote,branch,options={}){const args=["--force"];return options.noVerify&&args.push("--no-verify"),GitCli.push(remote,branch,args,options.progressTracker)}function deleteRemoteBranch(remote,branch,options={}){const args=["--delete"];return options.noVerify&&args.push("--no-verify"),GitCli.push(remote,branch,args,options.progressTracker)}function undoLastLocalCommit(){return GitCli.reset("--soft","HEAD~1")}exports.pushToNewUpstream=pushToNewUpstream,exports.getBranches=getBranches,exports.getAllBranches=getAllBranches,exports.getHistory=getHistory,exports.getFileHistory=getFileHistory,exports.resetIndex=resetIndex,exports.discardAllChanges=discardAllChanges,exports.getMergeInfo=getMergeInfo,exports.discardFileChanges=discardFileChanges,exports.getRemoteUrl=getRemoteUrl,exports.setRemoteUrl=setRemoteUrl,exports.pushForced=pushForced,exports.deleteRemoteBranch=deleteRemoteBranch,exports.undoLastLocalCommit=undoLastLocalCommit,Object.keys(GitCli).forEach(function(method){exports[method]||(exports[method]=GitCli[method])})}),define("src/git/GitCli",function(require,exports){const _=brackets.getModule("thirdparty/lodash"),FileSystem=brackets.getModule("filesystem/FileSystem"),Strings=brackets.getModule("strings"),FileUtils=brackets.getModule("file/FileUtils"),Cli=require("src/Cli"),ErrorHandler=require("src/ErrorHandler"),Events=require("src/Events"),EventEmitter=require("src/EventEmitter"),ExpectedError=require("src/ExpectedError"),Preferences=require("src/Preferences"),Utils=require("src/Utils");let _gitPath=null,_gitQueue=[],_gitQueueBusy=!1,lastGitStatusResults;var FILE_STATUS={STAGED:"STAGED",UNMODIFIED:"UNMODIFIED",IGNORED:"IGNORED",UNTRACKED:"UNTRACKED",MODIFIED:"MODIFIED",ADDED:"ADDED",DELETED:"DELETED",RENAMED:"RENAMED",COPIED:"COPIED",UNMERGED:"UNMERGED"},EMPTY_TREE="4b825dc642cb6eb9a060e54bf8d69288fbee4904";function getGitPath(){return _gitPath||(_gitPath=Preferences.get("gitPath"))}function setGitPath(path){!0===path&&(path="git"),Preferences.set("gitPath",path),_gitPath=path}function strEndsWith(subjectString,searchString,position){(void 0===position||position>subjectString.length)&&(position=subjectString.length),position-=searchString.length;var lastIndex=subjectString.indexOf(searchString,position);return-1!==lastIndex&&lastIndex===position}function _processQueue(){if(_gitQueueBusy)return;if(0===_gitQueue.length)return void(_gitQueueBusy=!1);const item=_gitQueue.shift(),resolve=item[0],reject=item[1],args=item[2],opts=item[3];!0!==opts.nonblocking&&(_gitQueueBusy=!0),Cli.spawnCommand(getGitPath(),args,opts).then(function(r){resolve(r)}).catch(function(e){const call="call: git "+args.join(" ");e.stack=[call,e.stack].join("\n"),reject(e)}).finally(function(){!0!==opts.nonblocking&&(_gitQueueBusy=!1),_processQueue()})}function git(args,opts){return new Promise((resolve,reject)=>{_gitQueue.push([resolve,reject,args||[],opts||{}]),setTimeout(_processQueue)})}function setUpstreamBranch(remoteName,remoteBranch,progressTracker){if(!remoteName)throw new TypeError("remoteName argument is missing!");if(!remoteBranch)throw new TypeError("remoteBranch argument is missing!");return git(["branch","--no-color","-u",remoteName+"/"+remoteBranch],{progressTracker:progressTracker})}function branchDelete(branchName,progressTracker){return git(["branch","--no-color","-d",branchName],{progressTracker:progressTracker})}function forceBranchDelete(branchName,progressTracker){return git(["branch","--no-color","-D",branchName],{progressTracker:progressTracker})}function getBranches(moreArgs,progressTracker){var args=["branch","--no-color"];return moreArgs&&(args=args.concat(moreArgs)),git(args,{progressTracker:progressTracker}).then(function(stdout){return stdout?stdout.split("\n").reduce(function(arr,l){var name=l.trim(),currentBranch=!1,remote=null,sortPrefix="";if(-1!==name.indexOf("->"))return arr;0===name.indexOf("* ")&&(name=name.substring(2),currentBranch=!0),0===name.indexOf("remotes/")&&(remote=(name=name.substring("remotes/".length)).substring(0,name.indexOf("/")));var sortName=name.toLowerCase();return remote&&(sortName=sortName.substring(remote.length+1)),-1!==sortName.indexOf("#")&&(sortPrefix=sortName.slice(0,sortName.indexOf("#"))),arr.push({name:name,sortPrefix:sortPrefix,sortName:sortName,currentBranch:currentBranch,remote:remote}),arr},[]):[]})}function getAllBranches(progressTracker){return getBranches(["-a"],progressTracker)}function repositoryNotFoundHandler(err){var m=ErrorHandler.matches(err,/Repository (.*) not found$/gim);if(m)throw new ExpectedError(m[0]);throw err}function fetchRemote(remote,progressTracker){return git(["fetch","--progress",remote],{progressTracker:progressTracker,timeout:!1}).catch(repositoryNotFoundHandler)}function fetchAllRemotes(progressTracker){return git(["fetch","--progress","--all"],{progressTracker:progressTracker,timeout:!1}).catch(repositoryNotFoundHandler)}function getRemotes(){return git(["remote","-v"]).then(function(stdout){return stdout?_.uniq(stdout.replace(/\((push|fetch)\)/g,"").split("\n")).map(function(l){var s=l.trim().split("\t");return{name:s[0],url:s[1]}}):[]})}function createRemote(name,url){return git(["remote","add",name,url]).then(function(){return!0})}function deleteRemote(name){return git(["remote","rm",name]).then(function(){return!0})}function mergeRemote(remote,branch,ffOnly,noCommit,options={}){var args=["merge"];ffOnly&&args.push("--ff-only"),noCommit&&args.push("--no-commit","--no-ff"),args.push(remote+"/"+branch);var readMergeMessage=function(){return Utils.loadPathContent(Preferences.get("currentGitRoot")+"/.git/MERGE_MSG").then(function(msg){return msg})};return git(args,{progressTracker:options.progressTracker}).then(function(stdout){return stdout||readMergeMessage().then(function(msg){return msg||"Remote branch "+branch+" from "+remote+" was merged to current branch"})}).catch(function(error){return readMergeMessage().then(function(msg){if(msg)return msg;throw error})})}function rebaseRemote(remote,branch,progressTracker){return git(["rebase",remote+"/"+branch],{progressTracker:progressTracker})}function resetRemote(remote,branch,progressTracker){return git(["reset","--soft",remote+"/"+branch],{progressTracker:progressTracker}).then(function(stdout){return stdout||"Current branch was resetted to branch "+branch+" from "+remote})}function mergeBranch(branchName,mergeMessage,useNoff){var args=["merge"];return useNoff&&args.push("--no-ff"),mergeMessage&&mergeMessage.trim()&&args.push("-m",mergeMessage),args.push(branchName),git(args)}function push(remoteName,remoteBranch,additionalArgs,progressTracker){if(!remoteName)throw new TypeError("remoteName argument is missing!");var args=["push","--porcelain","--progress"];return Array.isArray(additionalArgs)&&(args=args.concat(additionalArgs)),args.push(remoteName),remoteBranch&&Preferences.get("gerritPushref")?getConfig("gerrit.pushref").then(function(strGerritEnabled){return"true"===strGerritEnabled?args.push("HEAD:refs/for/"+remoteBranch):args.push(remoteBranch),doPushWithArgs(args,progressTracker)}):(remoteBranch&&args.push(remoteBranch),doPushWithArgs(args,progressTracker))}function doPushWithArgs(args,progressTracker){return git(args,{progressTracker:progressTracker}).catch(repositoryNotFoundHandler).then(function(stdout){for(var lines=stdout.split("\n");lines.length>0&&null===lines[0].match(/^To/);)lines.shift();var retObj={},lineTwo=lines[1].split("\t");switch(retObj.remoteUrl=lines[0].trim().split(" ")[1],retObj.flag=lineTwo[0],retObj.from=lineTwo[1].split(":")[0],retObj.to=lineTwo[1].split(":")[1],retObj.summary=lineTwo[2],retObj.status=lines[2],retObj.flag){case" ":retObj.flagDescription=Strings.GIT_PUSH_SUCCESS_MSG;break;case"+":retObj.flagDescription=Strings.GIT_PUSH_FORCE_UPDATED_MSG;break;case"-":retObj.flagDescription=Strings.GIT_PUSH_DELETED_MSG;break;case"*":retObj.flagDescription=Strings.GIT_PUSH_NEW_REF_MSG;break;case"!":retObj.flagDescription=Strings.GIT_PUSH_REJECTED_MSG;break;case"=":retObj.flagDescription=Strings.GIT_PUSH_UP_TO_DATE_MSG;break;default:retObj.flagDescription="Unknown push flag received: "+retObj.flag}return retObj})}function getCurrentBranchName(){return git(["branch","--no-color"]).then(function(stdout){var branchName=_.find(stdout.split("\n"),function(l){return"*"===l[0]});if(branchName){var m=(branchName=branchName.substring(1).trim()).match(/^\(.*\s(\S+)\)$/);return m?m[1]:branchName}return stdout.match(/^\s*$/)?(EventEmitter.emit(Events.GIT_NO_BRANCH_EXISTS),"master"):git(["log","--pretty=format:%H %d","-1"]).then(function(stdout){var m=stdout.trim().match(/^(\S+)\s+\((.*)\)$/),hash=m[1].substring(0,20);return m[2].split(",").forEach(function(info){if("HEAD"!==(info=info.trim())){var m=info.match(/^tag:(.+)$/);hash=m?m[1].trim():info}}),hash})})}function getCurrentUpstreamBranch(){return git(["rev-parse","--abbrev-ref","--symbolic-full-name","@{u}"]).catch(function(){return null})}function getDeletedFiles(oldBranch,newBranch){return git(["diff","--no-ext-diff","--name-status",oldBranch+".."+newBranch]).then(function(stdout){var regex=/^D/;return stdout.split("\n").reduce(function(arr,row){return regex.test(row)&&arr.push(row.substring(1).trim()),arr},[])})}function getConfig(key){return git(["config",key.replace(/\s/g,"")])}function setConfig(key,value,allowGlobal){return git(["config",key=key.replace(/\s/g,""),value]).catch(function(err){if(allowGlobal&&ErrorHandler.contains(err,"No such file or directory"))return git(["config","--global",key,value]);throw err})}function getHistory(branch,skipCommits,file){var separator="_._",newline="_.nw._",format=["%h","%H","%an","%aI","%ae","%s","%b","%d"].join("_._")+newline,args=["log","-100","--date=iso"];return skipCommits&&args.push("--skip="+skipCommits),args.push("--format="+format,branch,"--"),file&&args.push(file),git(args).then(function(stdout){return(stdout=stdout.substring(0,stdout.length-newline.length))?stdout.split(newline).map(function(line){var data=line.trim().split("_._"),commit={};if(commit.hashShort=data[0],commit.hash=data[1],commit.author=data[2],commit.date=data[3],commit.email=data[4],commit.subject=data[5],commit.body=data[6],data[7]){var tags=data[7],regex=new RegExp("tag: ([^,|)]+)","g");for(var key in tags=tags.match(regex))tags[key]&&tags[key].replace&&(tags[key]=tags[key].replace("tag:",""));commit.tags=tags}return commit}):[]})}function init(){return git(["init"])}function clone(remoteGitUrl,destinationFolder,progressTracker){return git(["clone",remoteGitUrl,destinationFolder,"--progress"],{progressTracker:progressTracker,timeout:!1})}function stage(fileOrFiles,updateIndex){var args=["add"];return updateIndex&&args.push("-u"),git(args.concat("--",fileOrFiles))}function stageAll(){return git(["add","--all"])}function commit(message,amend,noVerify,progressTracker){var lines=message.split("\n"),args=["commit"];return amend&&args.push("--amend","--reset-author"),noVerify&&args.push("--no-verify"),1===lines.length?(args.push("-m",message),git(args,{progressTracker:progressTracker})):new Promise(function(resolve,reject){var fileEntry=FileSystem.getFileForPath(Preferences.get("currentGitRoot")+".phoenixGitTemp");jsPromise(FileUtils.writeText(fileEntry,message)).then(function(){return args.push("-F",".phoenixGitTemp"),git(args,{progressTracker:progressTracker})}).then(function(res){fileEntry.unlink(function(){resolve(res)})}).catch(function(err){fileEntry.unlink(function(){reject(err)})})})}function reset(type,hash){var args=["reset",type||"--mixed"];return hash&&args.push(hash,"--"),git(args)}function unstage(file){return git(["reset","--",file])}function checkout(hash){return git(["checkout",hash],{timeout:!1})}function createBranch(branchName,originBranch,trackOrigin){var args=["checkout","-b",branchName];return originBranch&&(trackOrigin&&args.push("--track"),args.push(originBranch)),git(args)}function _isquoted(str){return'"'===str[0]&&'"'===str[str.length-1]}function _unquote(str){return str.substring(1,str.length-1)}function _isescaped(str){return/\\[0-9]{3}/.test(str)}function status(type){return git(["status","-u","--porcelain"]).then(function(stdout){if(!stdout)return[];var currentSubFolder=Preferences.get("currentGitSubfolder"),isEscaped=!1,needReset=[],results=[],lines;return stdout.split("\n").forEach(function(line){var statusStaged=line.substring(0,1),statusUnstaged=line.substring(1,2),status=[],file=line.substring(3);if(_isquoted(file)&&_isescaped(file=_unquote(file))&&(isEscaped=!0)," "===statusStaged||" "===statusUnstaged||"?"===statusStaged||"?"===statusUnstaged){var statusChar;switch(" "!==statusStaged&&"?"!==statusStaged?(status.push(FILE_STATUS.STAGED),statusChar=statusStaged):statusChar=statusUnstaged,statusChar){case" ":status.push(FILE_STATUS.UNMODIFIED);break;case"!":status.push(FILE_STATUS.IGNORED);break;case"?":status.push(FILE_STATUS.UNTRACKED);break;case"M":status.push(FILE_STATUS.MODIFIED);break;case"A":status.push(FILE_STATUS.ADDED);break;case"D":status.push(FILE_STATUS.DELETED);break;case"R":status.push(FILE_STATUS.RENAMED);break;case"C":status.push(FILE_STATUS.COPIED);break;case"U":status.push(FILE_STATUS.UNMERGED);break;default:throw new Error("Unexpected status: "+statusChar)}var display=file,io=file.indexOf("->");-1!==io&&(file=file.substring(io+2).trim()),currentSubFolder&&0===display.indexOf(currentSubFolder)&&(display=display.substring(currentSubFolder.length)),results.push({status:status,display:display,file:file,name:file.substring(file.lastIndexOf("/")+1)})}else needReset.push(file)}),isEscaped?setConfig("core.quotepath","false").then(function(){if("SET_QUOTEPATH"===type)throw new Error("git status is calling itself in a recursive loop!");return status("SET_QUOTEPATH")}):needReset.length>0?Promise.all(needReset.map(function(fileName){return-1!==fileName.indexOf("->")&&(fileName=fileName.split("->")[1].trim()),unstage(fileName)})).then(function(){if("RECURSIVE_CALL"===type)throw new Error("git status is calling itself in a recursive loop!");return status("RECURSIVE_CALL")}):results.sort(function(a,b){return a.file<b.file?-1:a.file>b.file?1:0})}).then(function(results){return lastGitStatusResults=results,EventEmitter.emit(Events.GIT_STATUS_RESULTS,results),results})}function hasStatusChanged(){const prevStatus=lastGitStatusResults;return status().then(function(currentStatus){if(!prevStatus||prevStatus.length!==currentStatus.length)return!0;for(let i=0;i<prevStatus.length;i++)if(prevStatus[i].file!==currentStatus[i].file||prevStatus[i].status.join(", ")!==currentStatus[i].status.join(", "))return!0;return!1}).catch(function(error){return console.error("Error fetching Git status in hasStatusChanged:",error),!1})}function _isFileStaged(file){return git(["status","-u","--porcelain","--",file]).then(function(stdout){return!!stdout&&_.any(stdout.split("\n"),function(line){return" "!==line[0]&&"?"!==line[0]&&line.lastIndexOf(" "+file)===line.length-file.length-1})})}function getDiffOfStagedFiles(){return git(["diff","--no-ext-diff","--no-color","--staged"],{timeout:!1})}function getDiffOfAllIndexFiles(files){var args=["diff","--no-ext-diff","--no-color","--full-index"];return files&&(args=args.concat("--",files)),git(args,{timeout:!1})}function getListOfStagedFiles(){return git(["diff","--no-ext-diff","--no-color","--staged","--name-only"],{timeout:!1})}function diffFile(file){return _isFileStaged(file).then(function(staged){var args=["diff","--no-ext-diff","--no-color"];return staged&&args.push("--staged"),args.push("-U0","--",file),git(args,{timeout:!1})})}function diffFileNice(file){return _isFileStaged(file).then(function(staged){var args=["diff","--no-ext-diff","--no-color"];return staged&&args.push("--staged"),args.push("--",file),git(args,{timeout:!1})})}function difftool(file){return _isFileStaged(file).then(function(staged){var args=["difftool"];return staged&&args.push("--staged"),args.push("--",file),git(args,{timeout:!1,nonblocking:!0})})}function clean(){return git(["clean","-f","-d"])}function getFilesFromCommit(hash,isInitial){var args=["diff","--no-ext-diff","--name-only"];return git(args=(args=args.concat((isInitial?EMPTY_TREE:hash+"^")+".."+hash)).concat("--")).then(function(stdout){return stdout?stdout.split("\n"):[]})}function getDiffOfFileFromCommit(hash,file,isInitial){var args=["diff","--no-ext-diff","--no-color"];return git(args=(args=args.concat((isInitial?EMPTY_TREE:hash+"^")+".."+hash)).concat("--",file))}function difftoolFromHash(hash,file,isInitial){return git(["difftool",(isInitial?EMPTY_TREE:hash+"^")+".."+hash,"--",file],{timeout:!1})}function rebaseInit(branchName){return git(["rebase","--ignore-date",branchName])}function rebase(whatToDo){return git(["rebase","--"+whatToDo])}function getVersion(){return git(["--version"]).then(function(stdout){var m=stdout.match(/[0-9].*/);return m?m[0]:stdout.trim()})}function getCommitCountsFallback(){return git(["rev-list","HEAD","--not","--remotes"]).then(function(stdout){var ahead;return"-1 "+(stdout?stdout.split("\n").length:0)}).catch(function(err){return ErrorHandler.logError(err),"-1 -1"})}function getCommitCounts(){var remotes,remote=(Preferences.get("defaultRemotes")||{})[Preferences.get("currentGitRoot")];return getCurrentBranchName().then(function(branch){return branch&&remote?git(["rev-list","--left-right","--count",remote+"/"+branch+"...@{0}","--"]).catch(function(err){return ErrorHandler.logError(err),getCommitCountsFallback()}).then(function(stdout){var matches=/(-?\d+)\s+(-?\d+)/.exec(stdout);return matches?{behind:parseInt(matches[1],10),ahead:parseInt(matches[2],10)}:{behind:-1,ahead:-1}}):getCommitCountsFallback()})}function getLastCommitMessage(){return git(["log","-1","--pretty=%B"]).then(function(stdout){return stdout.trim()})}function getBlame(file,from,to){var args=["blame","-w","--line-porcelain"];return(from||to)&&args.push("-L"+from+","+to),args.push(file),git(args).then(function(stdout){if(!stdout)return[];var sep="-@-BREAK-HERE-@-",sep2="$$#-#$BREAK$$-$#";return(stdout=stdout.replace(sep,sep2).replace(/^\t(.*)$/gm,function(a,b){return b+sep})).split(sep).reduce(function(arr,lineInfo){if(!(lineInfo=lineInfo.replace(sep2,sep).trimLeft()))return arr;var obj={},lines=lineInfo.split("\n"),firstLine=_.first(lines).split(" ");obj.hash=firstLine[0],obj.num=firstLine[2],obj.content=_.last(lines);for(var i=1,l=lines.length-1;i<l;i++){var line=lines[i],io=line.indexOf(" "),key=line.substring(0,io),val=line.substring(io+1);obj[key]=val}return arr.push(obj),arr},[])}).catch(function(stderr){var m=stderr.match(/no such path (\S+)/);if(m)throw new Error("File is not tracked by Git: "+m[1]);throw stderr})}function getGitRoot(){var projectRoot=Utils.getProjectRoot();return git(["rev-parse","--show-toplevel"],{cwd:fs.getTauriPlatformPath(projectRoot)}).catch(function(e){if(ErrorHandler.contains(e,"Not a git repository"))return null;throw e}).then(function(root){if(null===root)return root;function checkPathRecursive(path){return strEndsWith(path,"/")&&(path=path.slice(0,-1)),Utils.consoleDebug("Checking path for .git: "+path),new Promise(function(resolve){"undefined"!=typeof brackets&&brackets.fs&&brackets.fs.stat?brackets.fs.stat(path+"/.git",function(err,result){var exists;!err&&(result.isFile()||result.isDirectory())?(Utils.consoleDebug("Found .git in path: "+path),resolve(path)):(Utils.consoleDebug("Failed to find .git in path: "+path),(path=path.split("/")).pop(),path=path.join("/"),resolve(checkPathRecursive(path)))}):FileSystem.resolve(path+"/.git",function(err,item,stat){var exists;!err&&(stat.isFile||stat.isDirectory)?(Utils.consoleDebug("Found .git in path: "+path),resolve(path)):(Utils.consoleDebug("Failed to find .git in path: "+path),(path=path.split("/")).pop(),path=path.join("/"),resolve(checkPathRecursive(path)))})})}return checkPathRecursive(projectRoot).then(function(path){return path+"/"})})}function setTagName(tagname,commitHash){const args=["tag",tagname];return commitHash&&args.push(commitHash),git(args).then(function(stdout){return stdout.trim()})}Preferences.getExtensionPref().on("change","gitPath",()=>{_gitPath=Preferences.get("gitPath")}),exports._git=git,exports.setGitPath=setGitPath,exports.FILE_STATUS=FILE_STATUS,exports.fetchRemote=fetchRemote,exports.fetchAllRemotes=fetchAllRemotes,exports.getRemotes=getRemotes,exports.createRemote=createRemote,exports.deleteRemote=deleteRemote,exports.push=push,exports.setUpstreamBranch=setUpstreamBranch,exports.getCurrentBranchName=getCurrentBranchName,exports.getCurrentUpstreamBranch=getCurrentUpstreamBranch,exports.getConfig=getConfig,exports.setConfig=setConfig,exports.getBranches=getBranches,exports.getAllBranches=getAllBranches,exports.branchDelete=branchDelete,exports.forceBranchDelete=forceBranchDelete,exports.getDeletedFiles=getDeletedFiles,exports.getHistory=getHistory,exports.init=init,exports.clone=clone,exports.stage=stage,exports.unstage=unstage,exports.stageAll=stageAll,exports.commit=commit,exports.reset=reset,exports.checkout=checkout,exports.createBranch=createBranch,exports.status=status,exports.hasStatusChanged=hasStatusChanged,exports.diffFile=diffFile,exports.diffFileNice=diffFileNice,exports.difftool=difftool,exports.clean=clean,exports.getFilesFromCommit=getFilesFromCommit,exports.getDiffOfFileFromCommit=getDiffOfFileFromCommit,exports.difftoolFromHash=difftoolFromHash,exports.rebase=rebase,exports.rebaseInit=rebaseInit,exports.mergeRemote=mergeRemote,exports.rebaseRemote=rebaseRemote,exports.resetRemote=resetRemote,exports.getVersion=getVersion,exports.getCommitCounts=getCommitCounts,exports.getLastCommitMessage=getLastCommitMessage,exports.mergeBranch=mergeBranch,exports.getDiffOfAllIndexFiles=getDiffOfAllIndexFiles,exports.getDiffOfStagedFiles=getDiffOfStagedFiles,exports.getListOfStagedFiles=getListOfStagedFiles,exports.getBlame=getBlame,exports.getGitRoot=getGitRoot,exports.setTagName=setTagName}),define("src/utils/Setup",function(require,exports){const _=brackets.getModule("thirdparty/lodash"),Metrics=brackets.getModule("utils/Metrics"),Cli=require("src/Cli"),Git=require("src/git/Git"),Preferences=require("src/Preferences");let standardGitPathsWin=["C:\\Program Files (x86)\\Git\\cmd\\git.exe","C:\\Program Files\\Git\\cmd\\git.exe"],standardGitPathsNonWin=["/usr/local/git/bin/git","/usr/local/bin/git","/usr/bin/git"],extensionActivated=!1;function getGitVersion(){return new Promise(function(resolve,reject){var pathsToLook=[Preferences.get("gitPath"),"git"].concat("win"===brackets.platform?standardGitPathsWin:standardGitPathsNonWin);pathsToLook=_.unique(_.compact(pathsToLook));var results=[],errors=[],finish=_.after(pathsToLook.length,function(){var searchedPaths="\n\nSearched paths:\n"+pathsToLook.join("\n");if(0===results.length)reject("No Git has been found on this computer"+searchedPaths);else{var gits=_.sortBy(results,"version").reverse(),latestGit=gits[0],m=latestGit.version.match(/([0-9]+)\.([0-9]+)/),major=parseInt(m[1],10),minor=parseInt(m[2],10);if(1===major&&minor<8)return reject("Brackets Git requires Git 1.8 or later - latest version found was "+latestGit.version+searchedPaths);latestGit=_.sortBy(_.filter(gits,function(git){return git.version===latestGit.version}),"index")[0],Git.setGitPath(latestGit.path),resolve(latestGit.version)}});pathsToLook.forEach(function(path,index){Cli.spawnCommand(path,["--version"],{cwd:"./"}).then(function(stdout){var m=stdout.match(/^git version\s+(.*)$/);m&&results.push({path:path,version:m[1],index:index})}).catch(function(err){errors.push({path:path,err:err})}).finally(function(){finish()})})})}function isExtensionActivated(){return extensionActivated&&Preferences.get("enableGit")}function init(){return new Promise(resolve=>{if(!Preferences.get("enableGit"))return resolve(!1),void console.log("Git is disabled in preferences.");getGitVersion().then(function(_version){resolve(extensionActivated=!0),Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"installed","yes")}).catch(function(err){extensionActivated=!1,console.warn("Failed to launch Git executable. Deactivating Git extension. Is git installed?",err),resolve(extensionActivated),Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"installed","no")})})}exports.init=init,exports.isExtensionActivated=isExtensionActivated,exports.getGitVersion=getGitVersion});
//# sourceMappingURL=extension-min.js.map
