define(function(require,exports,module){const _=brackets.getModule("thirdparty/lodash"),CommandManager=brackets.getModule("command/CommandManager"),Commands=brackets.getModule("command/Commands"),Dialogs=brackets.getModule("widgets/Dialogs"),DocumentManager=brackets.getModule("document/DocumentManager"),FileSystem=brackets.getModule("filesystem/FileSystem"),FileUtils=brackets.getModule("file/FileUtils"),LanguageManager=brackets.getModule("language/LanguageManager"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),ProjectManager=brackets.getModule("project/ProjectManager"),ErrorHandler=require("src/ErrorHandler"),Events=require("src/Events"),EventEmitter=require("src/EventEmitter"),Git=require("src/git/Git"),Preferences=require("src/Preferences"),Setup=require("src/utils/Setup"),Constants=require("src/Constants"),Strings=brackets.getModule("strings"),FORMAT_DIFF_TOO_LARGE="<div>"+Strings.DIFF_TOO_LONG+"</div>",formatDiffTemplate=require("text!templates/format-diff.html"),questionDialogTemplate=require("text!templates/git-question-dialog.html"),outputDialogTemplate=require("text!templates/git-output.html"),writeTestResults={},EXT_NAME="[brackets-git] ";function getProjectRoot(){var projectRoot=ProjectManager.getProjectRoot();return projectRoot?projectRoot.fullPath:null}function getExtensionDirectory(){throw new Error("api unsupported")}function formatDiff(diff){for(var DIFF_MAX_LENGTH=2e3,tabReplace="",verbose=Preferences.get("useVerboseDiff"),numLineOld=0,numLineNew=0,lastStatus=0,diffData=[],i=Preferences.getGlobal("tabSize");i--;)tabReplace+="&nbsp;";var LINE_STATUS_HEADER=0,LINE_STATUS_UNCHANGED=1,LINE_STATUS_REMOVED=2,LINE_STATUS_ADDED=3,LINE_STATUS_EOF=4,diffSplit=diff.split("\n");return diffSplit.length>2e3?""+FORMAT_DIFF_TOO_LARGE:(diffSplit.forEach(function(line){" "===line&&(line="");var lineClass="",pushLine=!0;if(0===line.indexOf("diff --git"))lineClass="diffCmd",diffData.push({name:line.split("b/")[1],lines:[]}),verbose||(pushLine=!1);else if(line.match(/index\s[A-z0-9]{7}\.\.[A-z0-9]{7}/))verbose||(pushLine=!1);else if("+++"===line.substr(0,3)||"---"===line.substr(0,3))verbose||(pushLine=!1);else if(0===line.indexOf("@@")){lineClass="position",lastStatus=LINE_STATUS_HEADER;var m=line.match(/^@@ -([,0-9]+) \+([,0-9]+) @@/),s1=m[1].split(","),s2=m[2].split(",");numLineOld=s1[0]-1,numLineNew=s2[0]-1}else"+"===line[0]?(lineClass="added",line=line.substring(1),lastStatus=LINE_STATUS_ADDED,numLineNew++):"-"===line[0]?(lineClass="removed",line=line.substring(1),lastStatus=LINE_STATUS_REMOVED,numLineOld++):" "===line[0]||""===line?(lineClass="unchanged",line=line.substring(1),lastStatus=LINE_STATUS_UNCHANGED,numLineOld++,numLineNew++):"\\ No newline at end of file"===line?(lastStatus=LINE_STATUS_EOF,lineClass="end-of-file"):console.log("Unexpected line in diff: "+line);if(pushLine){var _numLineOld="",_numLineNew="";switch(lastStatus){case LINE_STATUS_HEADER:case LINE_STATUS_EOF:break;case LINE_STATUS_UNCHANGED:_numLineOld=numLineOld,_numLineNew=numLineNew;break;case LINE_STATUS_REMOVED:_numLineOld=numLineOld;break;default:_numLineNew=numLineNew}line=(line=line.replace(/\uFEFF/g,"")).replace(/[\u2000-\uFFFF]/g,function(x){return"<U+"+x.charCodeAt(0).toString(16).toUpperCase()+">"}),line=(line=_.escape(line).replace(/\t/g,tabReplace).replace(/\s/g,"&nbsp;")).replace(/(&nbsp;)+$/g,function(trailingWhitespace){return"<span class='trailingWhitespace'>"+trailingWhitespace+"</span>"}),diffData.length>0&&_.last(diffData).lines.push({numLineOld:_numLineOld,numLineNew:_numLineNew,line:line,lineClass:lineClass})}}),Mustache.render(formatDiffTemplate,{files:diffData}))}function askQuestion(title,question,options){return new Promise(function(resolve,reject){(options=options||{}).noescape||(question=_.escape(question));var compiledTemplate=Mustache.render(questionDialogTemplate,{title:title,question:question,stringInput:!options.booleanResponse&&!options.password,passwordInput:options.password,defaultValue:options.defaultValue,customOkBtn:options.customOkBtn,customOkBtnClass:options.customOkBtnClass,Strings:Strings}),dialog=Dialogs.showModalDialogUsingTemplate(compiledTemplate),$dialog=dialog.getElement();_.defer(function(){var $input=$dialog.find("input:visible");$input.length>0?$input.focus():$dialog.find(".primary").focus()}),dialog.done(function(buttonId){if(options.booleanResponse)return resolve("ok"===buttonId);"ok"===buttonId?resolve(dialog.getElement().find("input").val().trim()):reject(Strings.USER_ABORTED)})})}function showOutput(output,title,options){return new Promise(function(resolve){options=options||{};var compiledTemplate=Mustache.render(outputDialogTemplate,{title:title,output:output,Strings:Strings,question:options.question}),dialog=Dialogs.showModalDialogUsingTemplate(compiledTemplate);dialog.getElement().find("button").focus(),dialog.done(function(buttonId){resolve("ok"===buttonId)})})}function isProjectRootWritable(){return new Promise(function(resolve){var folder=getProjectRoot();if(writeTestResults[folder])return resolve(writeTestResults[folder]);var fileEntry=FileSystem.getFileForPath(folder+".phoenixGitTemp");function finish(bool){fileEntry.unlink(function(){writeTestResults[folder]=bool,resolve(bool)})}jsPromise(FileUtils.writeText(fileEntry,"")).then(function(){finish(!0)}).catch(function(){finish(!1)})})}function pathExists(path){return new Promise(function(resolve){FileSystem.resolve(path,function(err,entry){resolve(!(err||!entry))})})}function loadPathContent(path){return new Promise(function(resolve){FileSystem.resolve(path,function(err,entry){if(err)return resolve(null);entry._clearCachedData&&entry._clearCachedData(),entry.isFile?entry.read(function(err,content){if(err)return resolve(null);resolve(content)}):entry.getContents(function(err,contents){if(err)return resolve(null);resolve(contents)})})})}function isLoading($btn){return $btn.hasClass("btn-loading")}function setLoading($btn){$btn.prop("disabled",!0).addClass("btn-loading")}function unsetLoading($btn){$btn.prop("disabled",!1).removeClass("btn-loading")}function encodeSensitiveInformation(str){return str=(str=str.replace(/(https?:\/\/)([^:@\s]*):([^:@]*)?@/g,function(a,protocol,user){return protocol+user+":***@"})).replace(/(users)(\\|\/)([^\\\/]+)(\\|\/)/i,function(a,users,slash1,username,slash2){return users+slash1+"***"+slash2})}function consoleWarn(msg){console.warn(encodeSensitiveInformation(msg))}function consoleError(msg){console.error(encodeSensitiveInformation(msg))}function consoleDebug(msg){logger.loggingOptions.logGit&&console.log(EXT_NAME+encodeSensitiveInformation(msg))}function reloadDoc(doc){return jsPromise(FileUtils.readAsText(doc.file)).then(function(text){doc.refreshText(text,new Date)}).catch(function(err){ErrorHandler.logError("Error reloading contents of "+doc.file.fullPath),ErrorHandler.logError(err)})}function stripWhitespaceFromFile(filename,clearWholeFile){return new Promise(function(resolve,reject){var fullPath=Preferences.get("currentGitRoot")+filename,addEndlineToTheEndOfFile=Preferences.get("addEndlineToTheEndOfFile"),removeBom=Preferences.get("removeByteOrderMark"),normalizeLineEndings=Preferences.get("normalizeLineEndings"),_cleanLines=function(lineNumbers){if(lineNumbers&&0===lineNumbers.length)return resolve();var fileEntry=FileSystem.getFileForPath(fullPath);return jsPromise(FileUtils.readAsText(fileEntry)).catch(function(err){return ErrorHandler.logError(err+" on FileUtils.readAsText for "+fileEntry.fullPath),null}).then(function(text){if(null===text)return resolve();removeBom&&(text=text.replace(/\uFEFF/g,"")),normalizeLineEndings&&(text=text.replace(/\r\n/g,"\n"));var lines=text.split("\n");if(lineNumbers?lineNumbers.forEach(function(lineNumber){"string"==typeof lines[lineNumber]&&(lines[lineNumber]=lines[lineNumber].replace(/\s+$/,""))}):lines.forEach(function(ln,lineNumber){"string"==typeof lines[lineNumber]&&(lines[lineNumber]=lines[lineNumber].replace(/\s+$/,""))}),addEndlineToTheEndOfFile){var lastLineNumber=lines.length-1;lines[lastLineNumber].length>0&&(lines[lastLineNumber]=lines[lastLineNumber].replace(/\s+$/,"")),lines[lastLineNumber].length>0&&lines.push("")}return text=lines.join("\n"),jsPromise(FileUtils.writeText(fileEntry,text)).catch(function(err){throw ErrorHandler.logError("Wasn't able to clean whitespace from file: "+fullPath),resolve(),err}).then(function(){DocumentManager.getAllOpenDocuments().forEach(function(doc){doc.file.fullPath===fullPath&&reloadDoc(doc)}),resolve()})})};clearWholeFile?_cleanLines(null):Git.diffFile(filename).then(function(diff){if(!diff)return resolve();if(diff.match(/^binary files.*differ$/gim))return resolve();var modified=[],changesets;diff.split("\n").filter(function(l){return null!==l.match(/^@@/)}).forEach(function(line){var i,m,s=line.match(/^@@ -([,0-9]+) \+([,0-9]+) @@/)[2].split(","),from=parseInt(s[0],10),to=from-1+(parseInt(s[1],10)||1);for(i=from;i<=to;i++)modified.push(i>0?i-1:0)}),_cleanLines(modified)}).catch(function(ex){ErrorHandler.logError(ex),reject(ex)})})}function stripWhitespaceFromFiles(gitStatusResults,stageChanges,progressTracker){return new Promise((resolve,reject)=>{const startTime=(new Date).getTime();let queue=Promise.resolve();gitStatusResults.forEach(function(fileObj){var isDeleted;if(!(-1!==fileObj.status.indexOf(Git.FILE_STATUS.DELETED))){var langId=LanguageManager.getLanguageForPath(fileObj.file).getId();-1===["unknown","binary","image","markdown","audio"].indexOf(langId)&&(queue=queue.then(function(){var clearWholeFile=-1!==fileObj.status.indexOf(Git.FILE_STATUS.UNTRACKED)||-1!==fileObj.status.indexOf(Git.FILE_STATUS.RENAMED),t=(new Date).getTime()-startTime;return progressTracker.trigger(Events.GIT_PROGRESS_EVENT,t+"ms - "+Strings.CLEAN_FILE_START+": "+fileObj.file),stripWhitespaceFromFile(fileObj.file,clearWholeFile).then(function(){var notifyProgress=function(){var t=(new Date).getTime()-startTime;progressTracker.trigger(Events.GIT_PROGRESS_EVENT,t+"ms - "+Strings.CLEAN_FILE_END+": "+fileObj.file)};if(stageChanges)return Git.stage(fileObj.file).then(notifyProgress);notifyProgress()})}))}}),queue.then(function(){resolve()}).catch(function(){reject()})})}function openEditorForFile(file,relative){relative&&(file=getProjectRoot()+file),CommandManager.execute(Commands.FILE_OPEN,{fullPath:file})}let clearWhitespace=Preferences.get("clearWhitespaceOnSave");function enableCommand(commandID,enabled){const command=CommandManager.get(commandID);command&&(enabled=commandID===Constants.CMD_GIT_SETTINGS_COMMAND_ID||enabled&&Setup.isExtensionActivated(),command.setEnabled(enabled))}Preferences.getExtensionPref().on("change","clearWhitespaceOnSave",()=>{clearWhitespace=Preferences.get("clearWhitespaceOnSave")}),EventEmitter.on(Events.BRACKETS_DOCUMENT_SAVED,function(doc){if(clearWhitespace){var fullPath=doc.file.fullPath,currentGitRoot=Preferences.get("currentGitRoot"),path;stripWhitespaceFromFile(fullPath.substring(currentGitRoot.length))}}),exports.FORMAT_DIFF_TOO_LARGE=FORMAT_DIFF_TOO_LARGE,exports.formatDiff=formatDiff,exports.getProjectRoot=getProjectRoot,exports.getExtensionDirectory=getExtensionDirectory,exports.askQuestion=askQuestion,exports.showOutput=showOutput,exports.isProjectRootWritable=isProjectRootWritable,exports.pathExists=pathExists,exports.loadPathContent=loadPathContent,exports.setLoading=setLoading,exports.unsetLoading=unsetLoading,exports.isLoading=isLoading,exports.consoleWarn=consoleWarn,exports.consoleError=consoleError,exports.consoleDebug=consoleDebug,exports.encodeSensitiveInformation=encodeSensitiveInformation,exports.reloadDoc=reloadDoc,exports.stripWhitespaceFromFiles=stripWhitespaceFromFiles,exports.openEditorForFile=openEditorForFile,exports.enableCommand=enableCommand});
//# sourceMappingURL=Utils.js.map
