define(function(require){var _=brackets.getModule("thirdparty/lodash"),FileSystem=brackets.getModule("filesystem/FileSystem"),ProjectManager=brackets.getModule("project/ProjectManager"),EventEmitter=require("src/EventEmitter"),Events=require("src/Events"),Git=require("src/git/Git"),Preferences=require("src/Preferences"),ignoreEntries=[],newPaths=[],modifiedPaths=[];if(Preferences.get("markModifiedInTree")){ProjectManager.addClassesProvider(function(data){var fullPath=data.fullPath;return isIgnored(fullPath)?"git-ignored":isNew(fullPath)?"git-new":isModified(fullPath)?"git-modified":void 0});var refreshOpenFiles=_.debounce(function(){_refreshOpenFiles()},100);EventEmitter.on(Events.BRACKETS_FILE_CHANGED,function(file){file.fullPath===Preferences.get("currentGitRoot")+".gitignore"&&refreshIgnoreEntries().finally(function(){refreshOpenFiles()})}),EventEmitter.on(Events.GIT_STATUS_RESULTS,function(files){var gitRoot=Preferences.get("currentGitRoot");newPaths=[],modifiedPaths=[],files.forEach(function(entry){var isNew=-1!==entry.status.indexOf(Git.FILE_STATUS.UNTRACKED)||-1!==entry.status.indexOf(Git.FILE_STATUS.ADDED),fullPath=gitRoot+entry.file;isNew?newPaths.push(fullPath):modifiedPaths.push(fullPath)}),ProjectManager.rerenderTree(),refreshOpenFiles()}),EventEmitter.on(Events.GIT_ENABLED,function(){refreshIgnoreEntries(),attachEvents()}),EventEmitter.on(Events.GIT_DISABLED,function(){ignoreEntries=[],newPaths=[],modifiedPaths=[],detachEvents()})}function loadIgnoreContents(){return new Promise(resolve=>{let gitRoot=Preferences.get("currentGitRoot"),excludeContents,gitignoreContents;const finish=_.after(2,function(){resolve(excludeContents+"\n"+gitignoreContents)});FileSystem.getFileForPath(gitRoot+".git/info/exclude").read(function(err,content){excludeContents=err?"":content,finish()}),FileSystem.getFileForPath(gitRoot+".gitignore").read(function(err,content){gitignoreContents=err?"":content,finish()})})}function refreshIgnoreEntries(){function regexEscape(str){return str.replace(/([.?+\^$\\(){}|])/g,"\\$1")}return loadIgnoreContents().then(function(content){var gitRoot=Preferences.get("currentGitRoot");ignoreEntries=_.compact(_.map(content.split("\n"),function(line){var type="deny",leadingSlash,trailingSlash,regex;if((line=line.trim())&&0!==line.indexOf("#"))return 0===line.indexOf("!")&&(line=line.slice(1),type="accept"),0===line.indexOf("\\")&&(line=line.slice(1)),0===line.indexOf("/")&&(line=line.slice(1),leadingSlash=!0),line.lastIndexOf("/")===line.length&&(line+="**",trailingSlash=!0),regex="^"+(regex=(regex=regexEscape(gitRoot)+(leadingSlash?"":"((.+)/)?")+regexEscape(line)+(trailingSlash?"":"(/.{0,})?")).replace(/\*\*$/g,"(.{0,})").replace(/(\*\*|\*$)/g,"(.+)").replace(/\*/g,"([^/]*)"))+"$",{regexp:new RegExp(regex),type:type}}))})}function isIgnored(path){var ignored=!1;return _.forEach(ignoreEntries,function(entry){entry.regexp.test(path)&&(ignored="deny"===entry.type)}),ignored}function isNew(fullPath){return-1!==newPaths.indexOf(fullPath)}function isModified(fullPath){return-1!==modifiedPaths.indexOf(fullPath)}function _refreshOpenFiles(){$("#working-set-list-container").find("li").each(function(){var $li=$(this),data=$li.data("file");if(data){var fullPath=data.fullPath;$li.toggleClass("git-ignored",isIgnored(fullPath)).toggleClass("git-new",isNew(fullPath)).toggleClass("git-modified",isModified(fullPath))}})}function attachEvents(){$("#working-set-list-container").on("contentChanged",refreshOpenFiles).triggerHandler("contentChanged")}function detachEvents(){$("#working-set-list-container").off("contentChanged",refreshOpenFiles)}});
//# sourceMappingURL=ProjectTreeMarks.js.map
