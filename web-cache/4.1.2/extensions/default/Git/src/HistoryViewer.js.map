{"version":3,"sources":["extensions/default/Git/src/HistoryViewer.js"],"names":["define","require","exports","_","brackets","getModule","LanguageManager","Mustache","WorkspaceManager","Strings","Metrics","marked","ErrorHandler","Git","Preferences","Utils","historyViewerTemplate","historyViewerFilesTemplate","useDifftool","isShown","commit","currentlyViewedCommit","isInitial","$viewer","$editorHolder","setExpandState","debounce","allFiles","find","activeFiles","filter","allExpanded","length","toggleClass","PAGE_SIZE","currentPage","hasNextPage","toggleDiff","$a","hasClass","removeClass","$","attr","scrollTop","is","addClass","$li","closest","relativeFilePath","$diffContainer","getDiffOfFileFromCommit","hash","then","diff","html","formatDiff","catch","err","showError","ERROR_GET_DIFF_FILE_COMMIT","showDiff","$el","file","difftoolFromHash","expandAll","not","trigger","set","collapseAll","attachEvents","on","this","e","stopPropagation","openEditorForFile","hide","remove","$parent","parent","sha","data","text","get","renderViewerContent","files","selectedFile","bodyMarkdown","body","gfm","breaks","render","renderFiles","$fileEntry","first","window","setTimeout","animate","position","top","append","toggle","off","loadMoreFiles","getFilesFromCommit","slice","list","map","fileExtension","getCompoundFileExtension","i","lastIndexOf","fileName","name","substring","extension","ERROR_GET_DIFF_FILES","finally","appendTo","initialize","once","getConfig","config","commitInfo","doc","options","commitHash","show","countEvent","EVENT_TYPE","GIT","firstPaneStyle","prop","cssText","secondPaneStyle","onRemove","recomputeLayout","isVisible"],"mappings":"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","sourcesContent":["define(function (require, exports) {\n\n    const _             = brackets.getModule(\"thirdparty/lodash\"),\n        LanguageManager = brackets.getModule(\"language/LanguageManager\"),\n        Mustache        = brackets.getModule(\"thirdparty/mustache/mustache\"),\n        WorkspaceManager  = brackets.getModule(\"view/WorkspaceManager\"),\n        Strings           = brackets.getModule(\"strings\"),\n        Metrics         = brackets.getModule(\"utils/Metrics\"),\n        marked          = brackets.getModule('thirdparty/marked.min').marked;\n\n    const ErrorHandler  = require(\"src/ErrorHandler\"),\n        Git           = require(\"src/git/Git\"),\n        Preferences   = require(\"src/Preferences\"),\n        Utils         = require(\"src/Utils\");\n\n    var historyViewerTemplate       = require(\"text!templates/history-viewer.html\"),\n        historyViewerFilesTemplate  = require(\"text!templates/history-viewer-files.html\");\n\n    let useDifftool            = false,\n        isShown                = false,\n        commit                 = null,\n        currentlyViewedCommit  = null,\n        isInitial              = null,\n        $viewer                = null,\n        $editorHolder          = null;\n\n    var setExpandState = _.debounce(function () {\n        var allFiles = $viewer.find(\".commit-files a\"),\n            activeFiles = allFiles.filter(\".active\"),\n            allExpanded = allFiles.length === activeFiles.length;\n        $viewer.find(\".toggle-diffs\").toggleClass(\"opened\", allExpanded);\n    }, 100);\n\n    var PAGE_SIZE = 25;\n    var currentPage = 0;\n    var hasNextPage = false;\n\n    function toggleDiff($a) {\n        if ($a.hasClass(\"active\")) {\n            // Close the clicked diff\n            $a.removeClass(\"active\");\n            setExpandState();\n            return;\n        }\n\n        // Open the clicked diff\n        $(\".commit-files a.active\").attr(\"scrollPos\", $(\".commit-diff\").scrollTop());\n\n        // If this diff was not previously loaded then load it\n        if (!$a.is(\".loaded\")) {\n            var $li = $a.closest(\"[x-file]\"),\n                relativeFilePath = $li.attr(\"x-file\"),\n                $diffContainer = $li.find(\".commit-diff\");\n\n            Git.getDiffOfFileFromCommit(commit.hash, relativeFilePath, isInitial).then(function (diff) {\n                $diffContainer.html(Utils.formatDiff(diff));\n                $diffContainer.scrollTop($a.attr(\"scrollPos\") || 0);\n\n                $a.addClass(\"active loaded\");\n                setExpandState();\n            }).catch(function (err) {\n                ErrorHandler.showError(err, Strings.ERROR_GET_DIFF_FILE_COMMIT);\n            });\n        } else {\n            // If this diff was previously loaded just open it\n            $a.addClass(\"active\");\n            setExpandState();\n        }\n    }\n\n    function showDiff($el) {\n        var file = $el.closest(\"[x-file]\").attr(\"x-file\");\n        Git.difftoolFromHash(commit.hash, file, isInitial);\n    }\n\n    function expandAll() {\n        $viewer.find(\".commit-files a\").not(\".active\").trigger(\"click\");\n        Preferences.set(\"autoExpandDiffsInHistory\", true);\n    }\n\n    function collapseAll() {\n        $viewer.find(\".commit-files a\").filter(\".active\").trigger(\"click\");\n        Preferences.set(\"autoExpandDiffsInHistory\", false);\n    }\n\n    function attachEvents() {\n        $viewer\n            .on(\"click\", \".commit-files a\", function () {\n                toggleDiff($(this));\n            })\n            .on(\"click\", \".commit-files .difftool\", function (e) {\n                e.stopPropagation();\n                showDiff($(this));\n            })\n            .on(\"click\", \".openFile\", function (e) {\n                e.stopPropagation();\n                var file = $(this).closest(\"[x-file]\").attr(\"x-file\");\n                Utils.openEditorForFile(file, true);\n                hide();\n            })\n            .on(\"click\", \".close\", function () {\n                // Close history viewer\n                remove();\n            })\n            .on(\"click\", \".git-extend-sha\", function () {\n                // Show complete commit SHA\n                var $parent = $(this).parent(),\n                    sha = $parent.data(\"hash\");\n                $parent.find(\"span.selectable-text\").text(sha);\n                $(this).remove();\n            })\n            .on(\"click\", \".toggle-diffs\", expandAll)\n            .on(\"click\", \".toggle-diffs.opened\", collapseAll);\n\n        // Add/Remove shadow on bottom of header\n        $viewer.find(\".body\")\n            .on(\"scroll\", function () {\n                if ($viewer.find(\".body\").scrollTop() > 0) {\n                    $viewer.find(\".header\").addClass(\"shadow\");\n                } else {\n                    $viewer.find(\".header\").removeClass(\"shadow\");\n                }\n            });\n\n        // Expand the diffs when wanted\n        if (Preferences.get(\"autoExpandDiffsInHistory\")) {\n            expandAll();\n        }\n    }\n\n    function renderViewerContent(files, selectedFile) {\n        var bodyMarkdown = marked(commit.body, { gfm: true, breaks: true });\n\n        $viewer.html(Mustache.render(historyViewerTemplate, {\n            commit: commit,\n            bodyMarkdown: bodyMarkdown,\n            Strings: Strings\n        }));\n\n        renderFiles(files);\n\n        if (selectedFile) {\n            var $fileEntry = $viewer.find(\".commit-files li[x-file='\" + selectedFile + \"'] a\").first();\n            if ($fileEntry.length) {\n                toggleDiff($fileEntry);\n                window.setTimeout(function () {\n                    $viewer.find(\".body\").animate({ scrollTop: $fileEntry.position().top - 10 });\n                }, 80);\n            }\n        }\n\n        attachEvents();\n    }\n\n    function renderFiles(files) {\n        $viewer.find(\".filesContainer\").append(Mustache.render(historyViewerFilesTemplate, {\n            files: files,\n            Strings: Strings,\n            useDifftool: useDifftool\n        }));\n\n        // Activate/Deactivate load more button\n        $viewer.find(\".loadMore\")\n            .toggle(hasNextPage)\n            .off(\"click\")\n            .on(\"click\", function () {\n                currentPage++;\n                loadMoreFiles();\n            });\n    }\n\n    function loadMoreFiles() {\n        Git.getFilesFromCommit(commit.hash, isInitial).then(function (files) {\n\n            hasNextPage = files.slice((currentPage + 1) * PAGE_SIZE).length > 0;\n            files = files.slice(currentPage * PAGE_SIZE, (currentPage + 1) * PAGE_SIZE);\n\n            var list = files.map(function (file) {\n                var fileExtension = LanguageManager.getCompoundFileExtension(file),\n                    i = file.lastIndexOf(\".\" + fileExtension),\n                    fileName = file.substring(0, fileExtension && i >= 0 ? i : file.length);\n                return {\n                    name: fileName,\n                    extension: fileExtension ? \".\" + fileExtension : \"\",\n                    file: file\n                };\n            });\n\n            if (currentPage === 0) {\n                var file = $(\"#git-history-list\").data(\"file-relative\");\n                return renderViewerContent(list, file);\n            } else {\n                return renderFiles(list);\n            }\n        }).catch(function (err) {\n            ErrorHandler.showError(err, Strings.ERROR_GET_DIFF_FILES);\n        }).finally(function () {\n            $viewer.removeClass(\"spinner large spin\");\n        });\n    }\n\n    function render() {\n        if ($viewer) {\n            // Reset the viewer listeners\n            $viewer.off(\"click\");\n            $viewer.find(\".body\").off(\"scroll\");\n        } else {\n            // Create the viewer if it doesn't exist\n            $viewer = $(\"<div>\").addClass(\"git spinner large spin\");\n            $viewer.appendTo($editorHolder);\n        }\n\n        currentPage = 0;\n        loadMoreFiles();\n    }\n\n    var initialize = _.once(function () {\n        Git.getConfig(\"diff.tool\").then(function (config) {\n            useDifftool = !!config;\n        });\n    });\n\n    function toggle(commitInfo, doc, options) {\n        const commitHash = commitInfo.hash;\n        if(isShown && commitHash === currentlyViewedCommit) {\n            // the history view already showing the current commit, the user intent is to close\n            remove();\n            return false;\n        }\n        // a new history is to be shown\n        show(commitInfo, doc, options);\n        return true;\n    }\n\n    function show(commitInfo, doc, options) {\n        Metrics.countEvent(Metrics.EVENT_TYPE.GIT, 'history', \"detailView\");\n        initialize();\n\n        commit    = commitInfo;\n        isInitial = options.isInitial;\n\n        $editorHolder = $(\"#editor-holder\");\n        render();\n        currentlyViewedCommit = commitInfo.hash;\n        isShown   = true;\n        if ($(\"#first-pane\").length) {\n            const firstPaneStyle =\n                $(\"#first-pane\").prop(\"style\") && $(\"#first-pane\").prop(\"style\").cssText ?\n                    $(\"#first-pane\").prop(\"style\").cssText : \"\";\n            $(\"#first-pane\").prop(\"style\", firstPaneStyle + \";display: none !important;\");\n        }\n\n        if ($(\"#second-pane\").length) {\n            const secondPaneStyle =\n                $(\"#second-pane\").prop(\"style\") && $(\"#second-pane\").prop(\"style\").cssText ?\n                    $(\"#second-pane\").prop(\"style\").cssText : \"\";\n            $(\"#second-pane\").prop(\"style\", secondPaneStyle + \";display: none !important;\");\n        }\n    }\n\n    function onRemove() {\n        isShown = false;\n        $viewer = null;\n        currentlyViewedCommit = null;\n        $(\"#first-pane\").show();\n        $(\"#second-pane\").show();\n        // we need to relayout as when the history overlay is visible over the editor, we\n        // hide the editor with css, and if we resize app while history view is open, the editor wont\n        // be resized. So we relayout on panel close.\n        WorkspaceManager.recomputeLayout();\n        // detach events that were added by this viewer to another element than one added to $editorHolder\n    }\n\n    function hide() {\n        if (isShown) {\n            remove();\n        }\n    }\n\n    function remove() {\n        $viewer.remove();\n        onRemove();\n    }\n\n    function isVisible() {\n        return isShown;\n    }\n\n    // Public API\n    exports.toggle = toggle;\n    exports.show = show;\n    exports.hide = hide;\n    exports.isVisible = isVisible;\n\n});\n"],"file":"HistoryViewer.js"}