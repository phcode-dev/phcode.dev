define(function(require,exports,module){const NodeConnector=brackets.getModule("NodeConnector"),ErrorHandler=require("src/ErrorHandler"),Preferences=require("src/Preferences"),Events=require("src/Events"),Utils=require("src/Utils");let gitTimeout=1e3*Preferences.get("gitTimeout"),nextCliId=0,deferredMap={};Preferences.getExtensionPref().on("change","gitTimeout",()=>{gitTimeout=1e3*Preferences.get("gitTimeout")});var MAX_COUNTER_VALUE=4294967295;let gitNodeConnector=NodeConnector.createNodeConnector("phcode-git-core",exports);function getNextCliId(){return nextCliId>=MAX_COUNTER_VALUE&&(nextCliId=0),++nextCliId}function normalizePathForOs(path){return"win"===brackets.platform&&(path=path.replace(/\//g,"\\")),path}function sanitizeOutput(str){return"string"!=typeof str&&(str=null!=str?str.toString():""),str}function logDebug(opts,debugInfo,method,type,out){if(logger.loggingOptions.logGit){var processInfo=[],duration=(new Date).getTime()-debugInfo.startTime;processInfo.push(duration+"ms"),opts.cliId&&processInfo.push("ID="+opts.cliId);var msg="cmd-"+method+"-"+type+" ("+processInfo.join(";")+")";out&&(msg+=': "'+out+'"'),Utils.consoleDebug(msg)}}function cliHandler(method,cmd,args,opts,retry){const cliPromise=new Promise((resolve,reject)=>{const cliId=getNextCliId();args=args||[];const progressTracker=(opts=opts||{}).progressTracker,savedDefer={resolve:resolve,reject:reject,progressTracker:progressTracker};deferredMap[cliId]=savedDefer;const watchProgress=!!progressTracker||-1!==args.indexOf("--progress"),startTime=(new Date).getTime();opts.cwd||(opts.cwd=fs.getTauriPlatformPath(Preferences.get("currentGitRoot")||Utils.getProjectRoot())),opts.cwd=normalizePathForOs(opts.cwd),Utils.consoleDebug("cmd-"+method+(watchProgress?"-watch":"")+": "+opts.cwd+" -> "+cmd+" "+args.join(" "));let resolved=!1,timeoutLength=opts.timeout?1e3*opts.timeout:gitTimeout;const domainOpts={cliId:cliId,watchProgress:watchProgress},debugInfo={startTime:startTime};function timeoutPromise(){logDebug(domainOpts,debugInfo,method,"timeout");var err=new Error("cmd-"+method+"-timeout: "+cmd+" "+args.join(" "));opts.timeoutExpected||ErrorHandler.logError(err),gitNodeConnector.execPeer("kill",domainOpts.cliId).catch(function(err){ErrorHandler.logError(err)}),delete deferredMap[cliId],reject(ErrorHandler.toError(err)),resolved=!0,progressTracker&&progressTracker.off(`${Events.GIT_PROGRESS_EVENT}.${cliId}`)}watchProgress&&progressTracker&&progressTracker.trigger(Events.GIT_PROGRESS_EVENT,"Running command: git "+args.join(" ")),gitNodeConnector.execPeer(method,{directory:opts.cwd,command:cmd,args:args,opts:domainOpts}).catch(function(err){if(!resolved){err=sanitizeOutput(err),logDebug(domainOpts,debugInfo,method,"fail",err),delete deferredMap[cliId];var invalidCwdErr="spawn ENOENT";if((err=ErrorHandler.toError(err)).stack&&err.stack.indexOf(invalidCwdErr)&&(err.message=err.message.replace(invalidCwdErr,"spawn ENOENT ("+opts.cwd+")"),err.stack=err.stack.replace(invalidCwdErr,"spawn ENOENT ("+opts.cwd+")")),err.stack&&-1!==err.stack.indexOf("WebSocket.self._ws.onclose")&&!retry)return void cliHandler(method,cmd,args,opts,!0).then(function(response){savedDefer.isResolved=!0,resolve(response)}).catch(function(err){reject(err)});reject(err)}}).then(function(out){resolved||(out=sanitizeOutput(out),logDebug(domainOpts,debugInfo,method,"out",out),delete deferredMap[cliId],resolve(out))}).finally(function(){progressTracker&&progressTracker.off(`${Events.GIT_PROGRESS_EVENT}.${cliId}`),resolved=!0});var lastProgressTime=0;function timeoutCall(){setTimeout(function(){if(!resolved)if(domainOpts.watchProgress){const currentTime=(new Date).getTime(),diff=currentTime-lastProgressTime;diff>timeoutLength?(Utils.consoleDebug("cmd("+cliId+") - last progress message was sent "+diff+"ms ago - timeout"),timeoutPromise()):(Utils.consoleDebug("cmd("+cliId+") - last progress message was sent "+diff+"ms ago - delay"),timeoutCall())}else timeoutPromise()},timeoutLength)}!1!==opts.timeout&&(domainOpts.watchProgress&&progressTracker&&(progressTracker.off(`${Events.GIT_PROGRESS_EVENT}.${cliId}`),progressTracker.on(`${Events.GIT_PROGRESS_EVENT}.${cliId}`,function(){lastProgressTime=(new Date).getTime()})),timeoutCall())});return cliPromise}function which(cmd){return cliHandler("which",cmd)}function spawnCommand(cmd,args,opts){return cliHandler("spawn",cmd,args,opts)}gitNodeConnector.on(Events.GIT_PROGRESS_EVENT,(_event,evtData)=>{const deferred=deferredMap[evtData.cliId];deferred?!deferred.isResolved&&deferred.progressTracker&&deferred.progressTracker.trigger(Events.GIT_PROGRESS_EVENT,evtData.data):ErrorHandler.logError("Progress sent for a non-existing process("+evtData.cliId+"): "+evtData)}),exports.cliHandler=cliHandler,exports.which=which,exports.spawnCommand=spawnCommand});
//# sourceMappingURL=Cli.js.map
