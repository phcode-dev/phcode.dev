{"version":3,"sources":["extensions/default/Git/src/NoRepo.js"],"names":["define","require","FileSystem","brackets","getModule","FileUtils","ProjectManager","CommandManager","Metrics","Strings","StringUtils","ErrorHandler","Events","EventEmitter","ExpectedError","ProgressDialog","CloneDialog","Git","Preferences","Constants","Utils","gitignoreTemplate","createGitIgnore","gitIgnorePath","get","pathExists","then","exists","jsPromise","writeText","getFileForPath","stageGitIgnore","stage","handleGitInit","isProjectRootWritable","writable","initPath","Phoenix","app","getDisplayPath","getProjectRoot","errorStr","format","FOLDER_NOT_WRITABLE","init","catch","err","Promise","resolve","reject","contains","emit","GIT_CHANGE_USERNAME","GIT_CHANGE_EMAIL","result","error","countEvent","EVENT_TYPE","GIT","showError","INIT_NEW_REPO_FAILED","dontStripError","REFRESH_ALL","isProjectRootEmpty","getContents","entries","length","handleGitClone","gitCloneURL","destPath","$gitPanel","$cloneButton","$","find","prop","isEmpty","_clone","remote","remoteUrlNew","show","GIT_CLONE_REMOTE_FAILED","clonePath","GIT_CLONE_ERROR_EXPLAIN","cloneConfig","q","remoteUrl","tracker","newProgressTracker","fs","getTauriPlatformPath","clone","errorMetric","remoteUrlRestore","setRemoteUrl","finally","register","GIT_CLONE","CMD_GIT_CLONE_WITH_URL","on","HANDLE_GIT_INIT","HANDLE_GIT_CLONE","GIT_NO_BRANCH_EXISTS"],"mappings":"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","sourcesContent":["/*globals jsPromise, fs*/\ndefine(function (require) {\n\n    // Brackets modules\n    const FileSystem    = brackets.getModule(\"filesystem/FileSystem\"),\n        FileUtils       = brackets.getModule(\"file/FileUtils\"),\n        ProjectManager  = brackets.getModule(\"project/ProjectManager\"),\n        CommandManager  = brackets.getModule(\"command/CommandManager\"),\n        Metrics         = brackets.getModule(\"utils/Metrics\"),\n        Strings         = brackets.getModule(\"strings\"),\n        StringUtils     = brackets.getModule(\"utils/StringUtils\");\n\n    // Local modules\n    const ErrorHandler  = require(\"src/ErrorHandler\"),\n        Events          = require(\"src/Events\"),\n        EventEmitter    = require(\"src/EventEmitter\"),\n        ExpectedError   = require(\"src/ExpectedError\"),\n        ProgressDialog  = require(\"src/dialogs/Progress\"),\n        CloneDialog     = require(\"src/dialogs/Clone\"),\n        Git             = require(\"src/git/Git\"),\n        Preferences     = require(\"src/Preferences\"),\n        Constants       = require(\"src/Constants\"),\n        Utils           = require(\"src/Utils\");\n\n    // Templates\n    var gitignoreTemplate = require(\"text!templates/default-gitignore\");\n\n    // Module variables\n\n    // Implementation\n\n    function createGitIgnore() {\n        var gitIgnorePath = Preferences.get(\"currentGitRoot\") + \".gitignore\";\n        return Utils.pathExists(gitIgnorePath).then(function (exists) {\n            if (!exists) {\n                return jsPromise(\n                    FileUtils.writeText(FileSystem.getFileForPath(gitIgnorePath), gitignoreTemplate));\n            }\n        });\n    }\n\n    function stageGitIgnore() {\n        return createGitIgnore().then(function () {\n            return Git.stage(\".gitignore\");\n        });\n    }\n\n    function handleGitInit() {\n        Utils.isProjectRootWritable().then(function (writable) {\n            if (!writable) {\n                const initPath = Phoenix.app.getDisplayPath(Utils.getProjectRoot());\n                const errorStr = StringUtils.format(Strings.FOLDER_NOT_WRITABLE, initPath);\n                throw new ExpectedError(errorStr);\n            }\n            return Git.init().catch(function (err) {\n                return new Promise((resolve, reject)=>{\n                    if (ErrorHandler.contains(err, \"Please tell me who you are\")) {\n                        EventEmitter.emit(Events.GIT_CHANGE_USERNAME, function () {\n                            EventEmitter.emit(Events.GIT_CHANGE_EMAIL, function () {\n                                Git.init().then(function (result) {\n                                    resolve(result);\n                                }).catch(function (error) {\n                                    reject(error);\n                                });\n                            });\n                        });\n                        return;\n                    }\n\n                    reject(err);\n                });\n            });\n        }).then(function () {\n            Metrics.countEvent(Metrics.EVENT_TYPE.GIT, 'init', \"success\");\n            return stageGitIgnore(\"Initial staging\");\n        }).catch(function (err) {\n            ErrorHandler.showError(err, Strings.INIT_NEW_REPO_FAILED, {dontStripError: true});\n            Metrics.countEvent(Metrics.EVENT_TYPE.GIT, 'init', \"fail\");\n        }).then(function () {\n            EventEmitter.emit(Events.REFRESH_ALL);\n        });\n    }\n\n    // This checks if the project root is empty (to let Git clone repositories)\n    function isProjectRootEmpty() {\n        return new Promise(function (resolve, reject) {\n            ProjectManager.getProjectRoot().getContents(function (err, entries) {\n                if (err) {\n                    return reject(err);\n                }\n                resolve(entries.length === 0);\n            });\n        });\n    }\n\n    function handleGitClone(gitCloneURL, destPath) {\n        var $gitPanel = $(\"#git-panel\");\n        var $cloneButton = $gitPanel.find(\".git-clone\");\n        $cloneButton.prop(\"disabled\", true);\n        isProjectRootEmpty().then(function (isEmpty) {\n            if (!isEmpty) {\n                const clonePath = Phoenix.app.getDisplayPath(Utils.getProjectRoot());\n                const err = new ExpectedError(\n                    StringUtils.format(Strings.GIT_CLONE_ERROR_EXPLAIN, clonePath));\n                ErrorHandler.showError(err, Strings.GIT_CLONE_REMOTE_FAILED, {dontStripError: true});\n                return;\n            }\n            function _clone(cloneConfig) {\n                var q = Promise.resolve();\n                // put username and password into remote url\n                var remoteUrl = cloneConfig.remoteUrl;\n                if (cloneConfig.remoteUrlNew) {\n                    remoteUrl = cloneConfig.remoteUrlNew;\n                }\n\n                // do the clone\n                q = q.then(function () {\n                    const tracker = ProgressDialog.newProgressTracker();\n                    destPath = destPath ? fs.getTauriPlatformPath(destPath) : \".\";\n                    return ProgressDialog.show(Git.clone(remoteUrl, destPath, tracker), tracker);\n                }).then(()=>{\n                    Metrics.countEvent(Metrics.EVENT_TYPE.GIT, 'clone', \"success\");\n                }).catch(function (err) {\n                    Metrics.countEvent(Metrics.EVENT_TYPE.GIT, 'clone', \"fail\");\n                    ErrorHandler.showError(err, Strings.GIT_CLONE_REMOTE_FAILED, {errorMetric: \"clone\"});\n                });\n\n                // restore original url if desired\n                if (cloneConfig.remoteUrlRestore) {\n                    q = q.then(function () {\n                        return Git.setRemoteUrl(cloneConfig.remote, cloneConfig.remoteUrlRestore);\n                    });\n                }\n\n                return q.finally(function () {\n                    EventEmitter.emit(Events.REFRESH_ALL);\n                });\n            }\n            if(gitCloneURL){\n                return _clone({\n                    remote: \"origin\",\n                    remoteUrlNew: gitCloneURL\n                });\n            }\n            CloneDialog.show().then(_clone).catch(function (err) {\n                // when dialog is cancelled, there's no error\n                if (err) { ErrorHandler.showError(err, Strings.GIT_CLONE_REMOTE_FAILED); }\n            });\n        }).catch(function (err) {\n            ErrorHandler.showError(err);\n        }).finally(function () {\n            $cloneButton.prop(\"disabled\", false);\n        });\n    }\n\n    CommandManager.register(Strings.GIT_CLONE, Constants.CMD_GIT_CLONE_WITH_URL, handleGitClone);\n\n    // Event subscriptions\n    EventEmitter.on(Events.HANDLE_GIT_INIT, function () {\n        handleGitInit();\n    });\n    EventEmitter.on(Events.HANDLE_GIT_CLONE, function () {\n        handleGitClone();\n    });\n    EventEmitter.on(Events.GIT_NO_BRANCH_EXISTS, function () {\n        stageGitIgnore();\n    });\n\n});\n"],"file":"NoRepo.js"}