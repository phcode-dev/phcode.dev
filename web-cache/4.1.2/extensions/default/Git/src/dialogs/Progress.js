define(function(require,exports){const EventDispatcher=brackets.getModule("utils/EventDispatcher"),Dialogs=brackets.getModule("widgets/Dialogs"),Strings=brackets.getModule("strings"),Mustache=brackets.getModule("thirdparty/mustache/mustache"),Events=require("src/Events");var template=require("text!src/dialogs/templates/progress-dialog.html"),lines,$textarea;const maxLines=5e3;function addLine(str){lines.length>=maxLines&&lines.shift(),lines.push(str)}let updateTimeout=null;function updateTextarea(){updateTimeout||(updateTimeout=setTimeout(()=>{updateTimeout=null,$textarea&&lines.length&&($textarea.val(lines.join("\n")),$textarea.scrollTop($textarea[0].scrollHeight-$textarea.height()))},100))}function onProgress(str){"string"==typeof str&&addLine(str),updateTextarea()}function show(promise,progressTracker,showOpts={}){if(!promise||!promise.finally)throw new Error("Invalid promise argument for progress dialog!");if(!progressTracker)throw new Error("Invalid progressTracker argument for progress dialog!");const title=showOpts.title,options=showOpts.options||{};return new Promise(function(resolve,reject){lines=showOpts.initialMessage?[showOpts.initialMessage]:[],$textarea=null;var dialog,finished=!1;function showDialog(){if(!finished){var templateArgs={title:title||Strings.OPERATION_IN_PROGRESS_TITLE,Strings:Strings},compiledTemplate=Mustache.render(template,templateArgs);dialog=Dialogs.showModalDialogUsingTemplate(compiledTemplate),($textarea=dialog.getElement().find("textarea")).val(Strings.PLEASE_WAIT),onProgress()}}let finalValue,finalError;function finish(){finished=!0,dialog&&dialog.close(),finalError?reject(finalError):resolve(finalValue)}options.preDelay?setTimeout(function(){showDialog()},1e3*options.preDelay):showDialog(),progressTracker.off(`${Events.GIT_PROGRESS_EVENT}.progressDlg`),progressTracker.on(`${Events.GIT_PROGRESS_EVENT}.progressDlg`,(_evt,data)=>{onProgress(data)}),promise.then(val=>{finalValue=val}).catch(err=>{finalError=err}).finally(function(){progressTracker.off(`${Events.GIT_PROGRESS_EVENT}.progressDlg`),onProgress("Finished!"),options.postDelay&&dialog?setTimeout(function(){finish()},1e3*options.postDelay):finish()})})}function waitForClose(){return new Promise(function(resolve){function check(){var visible;$("#git-progress-dialog").is(":visible")?setTimeout(check,20):resolve()}setTimeout(check,20)})}function newProgressTracker(){const tracker={};return EventDispatcher.makeEventDispatcher(tracker),tracker}exports.show=show,exports.newProgressTracker=newProgressTracker,exports.waitForClose=waitForClose});
//# sourceMappingURL=Progress.js.map
