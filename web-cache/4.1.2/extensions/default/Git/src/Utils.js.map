{"version":3,"sources":["extensions/default/Git/src/Utils.js"],"names":["define","require","exports","module","_","brackets","getModule","CommandManager","Commands","Dialogs","DocumentManager","FileSystem","FileUtils","LanguageManager","Mustache","ProjectManager","ErrorHandler","Events","EventEmitter","Git","Preferences","Setup","Constants","Strings","FORMAT_DIFF_TOO_LARGE","DIFF_TOO_LONG","formatDiffTemplate","questionDialogTemplate","outputDialogTemplate","writeTestResults","EXT_NAME","getProjectRoot","projectRoot","fullPath","getExtensionDirectory","Error","formatDiff","diff","DIFF_MAX_LENGTH","tabReplace","verbose","get","numLineOld","numLineNew","lastStatus","diffData","i","getGlobal","LINE_STATUS","diffSplit","split","length","forEach","line","lineClass","pushLine","indexOf","push","name","lines","match","substr","m","s1","s2","substring","console","log","_numLineOld","_numLineNew","replace","x","charCodeAt","toString","toUpperCase","escape","trailingWhitespace","last","render","files","askQuestion","title","question","options","Promise","resolve","reject","noescape","compiledTemplate","stringInput","booleanResponse","password","passwordInput","defaultValue","customOkBtn","customOkBtnClass","dialog","showModalDialogUsingTemplate","$dialog","getElement","defer","$input","find","focus","done","buttonId","val","trim","USER_ABORTED","showOutput","output","isProjectRootWritable","folder","fileEntry","getFileForPath","finish","bool","unlink","jsPromise","writeText","then","catch","pathExists","path","err","entry","loadPathContent","_clearCachedData","isFile","read","content","getContents","contents","isLoading","$btn","hasClass","setLoading","prop","addClass","unsetLoading","removeClass","encodeSensitiveInformation","str","a","protocol","user","users","slash1","username","slash2","consoleWarn","msg","warn","consoleError","error","consoleDebug","logger","loggingOptions","logGit","reloadDoc","doc","readAsText","file","text","refreshText","Date","logError","stripWhitespaceFromFile","filename","clearWholeFile","addEndlineToTheEndOfFile","removeBom","normalizeLineEndings","_cleanLines","lineNumbers","lineNumber","ln","lastLineNumber","join","getAllOpenDocuments","diffFile","modified","changesets","filter","l","s","from","parseInt","to","ex","stripWhitespaceFromFiles","gitStatusResults","stageChanges","progressTracker","startTime","getTime","queue","fileObj","isDeleted","status","FILE_STATUS","DELETED","langId","getLanguageForPath","getId","UNTRACKED","RENAMED","t","trigger","GIT_PROGRESS_EVENT","CLEAN_FILE_START","notifyProgress","CLEAN_FILE_END","stage","openEditorForFile","relative","execute","FILE_OPEN","clearWhitespace","enableCommand","commandID","enabled","command","CMD_GIT_SETTINGS_COMMAND_ID","isExtensionActivated","setEnabled","getExtensionPref","on","BRACKETS_DOCUMENT_SAVED","currentGitRoot"],"mappings":"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","sourcesContent":["/*globals jsPromise, logger*/\ndefine(function (require, exports, module) {\n\n    // Brackets modules\n    const _               = brackets.getModule(\"thirdparty/lodash\"),\n        CommandManager  = brackets.getModule(\"command/CommandManager\"),\n        Commands        = brackets.getModule(\"command/Commands\"),\n        Dialogs         = brackets.getModule(\"widgets/Dialogs\"),\n        DocumentManager = brackets.getModule(\"document/DocumentManager\"),\n        FileSystem      = brackets.getModule(\"filesystem/FileSystem\"),\n        FileUtils       = brackets.getModule(\"file/FileUtils\"),\n        LanguageManager = brackets.getModule(\"language/LanguageManager\"),\n        Mustache        = brackets.getModule(\"thirdparty/mustache/mustache\"),\n        ProjectManager  = brackets.getModule(\"project/ProjectManager\");\n\n    // Local modules\n    const ErrorHandler    = require(\"src/ErrorHandler\"),\n        Events          = require(\"src/Events\"),\n        EventEmitter    = require(\"src/EventEmitter\"),\n        Git             = require(\"src/git/Git\"),\n        Preferences     = require(\"src/Preferences\"),\n        Setup           = require(\"src/utils/Setup\"),\n        Constants       = require(\"src/Constants\"),\n        Strings         = brackets.getModule(\"strings\");\n\n    const FORMAT_DIFF_TOO_LARGE = \"<div>\" + Strings.DIFF_TOO_LONG + \"</div>\";\n\n    // Module variables\n    const formatDiffTemplate      = require(\"text!templates/format-diff.html\"),\n        questionDialogTemplate  = require(\"text!templates/git-question-dialog.html\"),\n        outputDialogTemplate    = require(\"text!templates/git-output.html\"),\n        writeTestResults        = {},\n        EXT_NAME                = \"[brackets-git] \";\n\n    // Implementation\n    function getProjectRoot() {\n        var projectRoot = ProjectManager.getProjectRoot();\n        return projectRoot ? projectRoot.fullPath : null;\n    }\n\n    // returns \"C:/Users/Zaggi/AppData/Roaming/Brackets/extensions/user/zaggino.brackets-git/\"\n    function getExtensionDirectory() {\n        throw new Error(\"api unsupported\");\n        // var modulePath = ExtensionUtils.getModulePath(module);\n        // return modulePath.slice(0, -1 * \"src/\".length);\n    }\n\n    function formatDiff(diff) {\n        var DIFF_MAX_LENGTH = 2000;\n\n        var tabReplace   = \"\",\n            verbose      = Preferences.get(\"useVerboseDiff\"),\n            numLineOld   = 0,\n            numLineNew   = 0,\n            lastStatus   = 0,\n            diffData     = [];\n\n        var i = Preferences.getGlobal(\"tabSize\");\n        while (i--) {\n            tabReplace += \"&nbsp;\";\n        }\n\n        var LINE_STATUS = {\n            HEADER: 0,\n            UNCHANGED: 1,\n            REMOVED: 2,\n            ADDED: 3,\n            EOF: 4\n        };\n\n        var diffSplit = diff.split(\"\\n\");\n\n        if (diffSplit.length > DIFF_MAX_LENGTH) {\n            return \"\" + FORMAT_DIFF_TOO_LARGE; // create new str to return\n        }\n\n        diffSplit.forEach(function (line) {\n            if (line === \" \") { line = \"\"; }\n\n            var lineClass   = \"\",\n                pushLine    = true;\n\n            if (line.indexOf(\"diff --git\") === 0) {\n                lineClass = \"diffCmd\";\n\n                diffData.push({\n                    name: line.split(\"b/\")[1],\n                    lines: []\n                });\n\n                if (!verbose) {\n                    pushLine = false;\n                }\n            } else if (line.match(/index\\s[A-z0-9]{7}\\.\\.[A-z0-9]{7}/)) {\n                if (!verbose) {\n                    pushLine = false;\n                }\n            } else if (line.substr(0, 3) === \"+++\" || line.substr(0, 3) === \"---\") {\n                if (!verbose) {\n                    pushLine = false;\n                }\n            } else if (line.indexOf(\"@@\") === 0) {\n                lineClass = \"position\";\n\n                // Define the type of the line: Header\n                lastStatus = LINE_STATUS.HEADER;\n\n                // This read the start line for the diff and substract 1 for this line\n                var m = line.match(/^@@ -([,0-9]+) \\+([,0-9]+) @@/);\n                var s1 = m[1].split(\",\");\n                var s2 = m[2].split(\",\");\n\n                numLineOld = s1[0] - 1;\n                numLineNew = s2[0] - 1;\n            } else if (line[0] === \"+\") {\n                lineClass = \"added\";\n                line = line.substring(1);\n\n                // Define the type of the line: Added\n                lastStatus = LINE_STATUS.ADDED;\n\n                // Add 1 to the num line for new document\n                numLineNew++;\n            } else if (line[0] === \"-\") {\n                lineClass = \"removed\";\n                line = line.substring(1);\n\n                // Define the type of the line: Removed\n                lastStatus = LINE_STATUS.REMOVED;\n\n                // Add 1 to the num line for old document\n                numLineOld++;\n            } else if (line[0] === \" \" || line === \"\") {\n                lineClass = \"unchanged\";\n                line = line.substring(1);\n\n                // Define the type of the line: Unchanged\n                lastStatus = LINE_STATUS.UNCHANGED;\n\n                // Add 1 to old a new num lines\n                numLineOld++;\n                numLineNew++;\n            } else if (line === \"\\\\ No newline at end of file\") {\n                lastStatus = LINE_STATUS.EOF;\n                lineClass = \"end-of-file\";\n            } else {\n                console.log(\"Unexpected line in diff: \" + line);\n            }\n\n            if (pushLine) {\n                var _numLineOld = \"\",\n                    _numLineNew = \"\";\n\n                switch (lastStatus) {\n                    case LINE_STATUS.HEADER:\n                    case LINE_STATUS.EOF:\n                        // _numLineOld = \"\";\n                        // _numLineNew = \"\";\n                        break;\n                    case LINE_STATUS.UNCHANGED:\n                        _numLineOld = numLineOld;\n                        _numLineNew = numLineNew;\n                        break;\n                    case LINE_STATUS.REMOVED:\n                        _numLineOld = numLineOld;\n                        // _numLineNew = \"\";\n                        break;\n                    // case LINE_STATUS.ADDED:\n                    default:\n                        // _numLineOld = \"\";\n                        _numLineNew = numLineNew;\n                }\n\n                // removes ZERO WIDTH NO-BREAK SPACE character (BOM)\n                line = line.replace(/\\uFEFF/g, \"\");\n\n                // exposes other potentially harmful characters\n                line = line.replace(/[\\u2000-\\uFFFF]/g, function (x) {\n                    return \"<U+\" + x.charCodeAt(0).toString(16).toUpperCase() + \">\";\n                });\n\n                line = _.escape(line)\n                    .replace(/\\t/g, tabReplace)\n                    .replace(/\\s/g, \"&nbsp;\");\n\n                line = line.replace(/(&nbsp;)+$/g, function (trailingWhitespace) {\n                    return \"<span class='trailingWhitespace'>\" + trailingWhitespace + \"</span>\";\n                });\n\n                if (diffData.length > 0) {\n                    _.last(diffData).lines.push({\n                        \"numLineOld\": _numLineOld,\n                        \"numLineNew\": _numLineNew,\n                        \"line\": line,\n                        \"lineClass\": lineClass\n                    });\n                }\n            }\n        });\n\n        return Mustache.render(formatDiffTemplate, { files: diffData });\n    }\n\n    function askQuestion(title, question, options) {\n        return new Promise(function (resolve, reject) {\n            options = options || {};\n\n            if (!options.noescape) {\n                question = _.escape(question);\n            }\n\n            var compiledTemplate = Mustache.render(questionDialogTemplate, {\n                title: title,\n                question: question,\n                stringInput: !options.booleanResponse && !options.password,\n                passwordInput: options.password,\n                defaultValue: options.defaultValue,\n                customOkBtn: options.customOkBtn,\n                customOkBtnClass: options.customOkBtnClass,\n                Strings: Strings\n            });\n\n            var dialog  = Dialogs.showModalDialogUsingTemplate(compiledTemplate),\n                $dialog = dialog.getElement();\n\n            _.defer(function () {\n                var $input = $dialog.find(\"input:visible\");\n                if ($input.length > 0) {\n                    $input.focus();\n                } else {\n                    $dialog.find(\".primary\").focus();\n                }\n            });\n\n            dialog.done(function (buttonId) {\n                if (options.booleanResponse) {\n                    return resolve(buttonId === \"ok\");\n                }\n                if (buttonId === \"ok\") {\n                    resolve(dialog.getElement().find(\"input\").val().trim());\n                } else {\n                    reject(Strings.USER_ABORTED);\n                }\n            });\n        });\n    }\n\n    function showOutput(output, title, options) {\n        return new Promise(function (resolve) {\n            options = options || {};\n            var compiledTemplate = Mustache.render(outputDialogTemplate, {\n                title: title,\n                output: output,\n                Strings: Strings,\n                question: options.question\n            });\n            var dialog = Dialogs.showModalDialogUsingTemplate(compiledTemplate);\n            dialog.getElement().find(\"button\").focus();\n            dialog.done(function (buttonId) {\n                resolve(buttonId === \"ok\");\n            });\n        });\n    }\n\n    function isProjectRootWritable() {\n        return new Promise(function (resolve) {\n\n            var folder = getProjectRoot();\n\n            // if we previously tried, assume nothing has changed\n            if (writeTestResults[folder]) {\n                return resolve(writeTestResults[folder]);\n            }\n\n            // create entry for temporary file\n            var fileEntry = FileSystem.getFileForPath(folder + \".phoenixGitTemp\");\n\n            function finish(bool) {\n                // delete the temp file and resolve\n                fileEntry.unlink(function () {\n                    writeTestResults[folder] = bool;\n                    resolve(bool);\n                });\n            }\n\n            // try writing some text into the temp file\n            jsPromise(FileUtils.writeText(fileEntry, \"\"))\n                .then(function () {\n                    finish(true);\n                })\n                .catch(function () {\n                    finish(false);\n                });\n        });\n    }\n\n    function pathExists(path) {\n        return new Promise(function (resolve) {\n            FileSystem.resolve(path, function (err, entry) {\n                resolve(!err && entry ? true : false);\n            });\n        });\n    }\n\n    function loadPathContent(path) {\n        return new Promise(function (resolve) {\n            FileSystem.resolve(path, function (err, entry) {\n                if (err) {\n                    return resolve(null);\n                }\n                if (entry._clearCachedData) {\n                    entry._clearCachedData();\n                }\n                if (entry.isFile) {\n                    entry.read(function (err, content) {\n                        if (err) {\n                            return resolve(null);\n                        }\n                        resolve(content);\n                    });\n                } else {\n                    entry.getContents(function (err, contents) {\n                        if (err) {\n                            return resolve(null);\n                        }\n                        resolve(contents);\n                    });\n                }\n            });\n        });\n    }\n\n    function isLoading($btn) {\n        return $btn.hasClass(\"btn-loading\");\n    }\n\n    function setLoading($btn) {\n        $btn.prop(\"disabled\", true).addClass(\"btn-loading\");\n    }\n\n    function unsetLoading($btn) {\n        $btn.prop(\"disabled\", false).removeClass(\"btn-loading\");\n    }\n\n    function encodeSensitiveInformation(str) {\n        // should match passwords in http/https urls\n        str = str.replace(/(https?:\\/\\/)([^:@\\s]*):([^:@]*)?@/g, function (a, protocol, user/*, pass*/) {\n            return protocol + user + \":***@\";\n        });\n        // should match user name in windows user folders\n        str = str.replace(/(users)(\\\\|\\/)([^\\\\\\/]+)(\\\\|\\/)/i, function (a, users, slash1, username, slash2) {\n            return users + slash1 + \"***\" + slash2;\n        });\n        return str;\n    }\n\n    function consoleWarn(msg) {\n        console.warn(encodeSensitiveInformation(msg));\n    }\n\n    function consoleError(msg) {\n        console.error(encodeSensitiveInformation(msg));\n    }\n\n    function consoleDebug(msg) {\n        if (logger.loggingOptions.logGit) {\n            console.log(EXT_NAME + encodeSensitiveInformation(msg));\n        }\n    }\n\n    /**\n     * Reloads the Document's contents from disk, discarding any unsaved changes in the editor.\n     *\n     * @param {!Document} doc\n     * @return {Promise} Resolved after editor has been refreshed; rejected if unable to load the\n     *      file's new content. Errors are logged but no UI is shown.\n     */\n    function reloadDoc(doc) {\n        return jsPromise(FileUtils.readAsText(doc.file))\n            .then(function (text) {\n                doc.refreshText(text, new Date());\n            })\n            .catch(function (err) {\n                ErrorHandler.logError(\"Error reloading contents of \" + doc.file.fullPath);\n                ErrorHandler.logError(err);\n            });\n    }\n\n    /**\n     *  strips trailing whitespace from all the diffs and adds \\n to the end\n     */\n    function stripWhitespaceFromFile(filename, clearWholeFile) {\n        return new Promise(function (resolve, reject) {\n\n            var fullPath                  = Preferences.get(\"currentGitRoot\") + filename,\n                addEndlineToTheEndOfFile  = Preferences.get(\"addEndlineToTheEndOfFile\"),\n                removeBom                 = Preferences.get(\"removeByteOrderMark\"),\n                normalizeLineEndings      = Preferences.get(\"normalizeLineEndings\");\n\n            var _cleanLines = function (lineNumbers) {\n                // do not clean if there's nothing to clean\n                if (lineNumbers && lineNumbers.length === 0) {\n                    return resolve();\n                }\n                // clean the file\n                var fileEntry = FileSystem.getFileForPath(fullPath);\n                return jsPromise(FileUtils.readAsText(fileEntry))\n                    .catch(function (err) {\n                        ErrorHandler.logError(err + \" on FileUtils.readAsText for \" + fileEntry.fullPath);\n                        return null;\n                    })\n                    .then(function (text) {\n                        if (text === null) {\n                            return resolve();\n                        }\n\n                        if (removeBom) {\n                            // remove BOM - \\uFEFF\n                            text = text.replace(/\\uFEFF/g, \"\");\n                        }\n                        if (normalizeLineEndings) {\n                            // normalizes line endings\n                            text = text.replace(/\\r\\n/g, \"\\n\");\n                        }\n                        // process lines\n                        var lines = text.split(\"\\n\");\n\n                        if (lineNumbers) {\n                            lineNumbers.forEach(function (lineNumber) {\n                                if (typeof lines[lineNumber] === \"string\") {\n                                    lines[lineNumber] = lines[lineNumber].replace(/\\s+$/, \"\");\n                                }\n                            });\n                        } else {\n                            lines.forEach(function (ln, lineNumber) {\n                                if (typeof lines[lineNumber] === \"string\") {\n                                    lines[lineNumber] = lines[lineNumber].replace(/\\s+$/, \"\");\n                                }\n                            });\n                        }\n\n                        // add empty line to the end, i've heard that git likes that for some reason\n                        if (addEndlineToTheEndOfFile) {\n                            var lastLineNumber = lines.length - 1;\n                            if (lines[lastLineNumber].length > 0) {\n                                lines[lastLineNumber] = lines[lastLineNumber].replace(/\\s+$/, \"\");\n                            }\n                            if (lines[lastLineNumber].length > 0) {\n                                lines.push(\"\");\n                            }\n                        }\n\n                        text = lines.join(\"\\n\");\n                        return jsPromise(FileUtils.writeText(fileEntry, text))\n                            .catch(function (err) {\n                                ErrorHandler.logError(\"Wasn't able to clean whitespace from file: \" + fullPath);\n                                resolve();\n                                throw err;\n                            })\n                            .then(function () {\n                                // refresh the file if it's open in the background\n                                DocumentManager.getAllOpenDocuments().forEach(function (doc) {\n                                    if (doc.file.fullPath === fullPath) {\n                                        reloadDoc(doc);\n                                    }\n                                });\n                                // diffs were cleaned in this file\n                                resolve();\n                            });\n                    });\n            };\n\n            if (clearWholeFile) {\n                _cleanLines(null);\n            } else {\n                Git.diffFile(filename).then(function (diff) {\n                    // if git returned an empty diff\n                    if (!diff) { return resolve(); }\n\n                    // if git detected that the file is binary\n                    if (diff.match(/^binary files.*differ$/img)) { return resolve(); }\n\n                    var modified = [],\n                        changesets = diff.split(\"\\n\").filter(function (l) { return l.match(/^@@/) !== null; });\n                    // collect line numbers to clean\n                    changesets.forEach(function (line) {\n                        var i,\n                            m = line.match(/^@@ -([,0-9]+) \\+([,0-9]+) @@/),\n                            s = m[2].split(\",\"),\n                            from = parseInt(s[0], 10),\n                            to = from - 1 + (parseInt(s[1], 10) || 1);\n                        for (i = from; i <= to; i++) { modified.push(i > 0 ? i - 1 : 0); }\n                    });\n                    _cleanLines(modified);\n                }).catch(function (ex) {\n                    // This error will bubble up to preparing commit dialog so just log here\n                    ErrorHandler.logError(ex);\n                    reject(ex);\n                });\n            }\n        });\n    }\n\n    function stripWhitespaceFromFiles(gitStatusResults, stageChanges, progressTracker) {\n        return new Promise((resolve, reject)=>{\n            const startTime = (new Date()).getTime();\n            let queue = Promise.resolve();\n\n            gitStatusResults.forEach(function (fileObj) {\n                var isDeleted = fileObj.status.indexOf(Git.FILE_STATUS.DELETED) !== -1;\n\n                // strip whitespace if the file was not deleted\n                if (!isDeleted) {\n                    // strip whitespace only for recognized languages so binary files won't get corrupted\n                    var langId = LanguageManager.getLanguageForPath(fileObj.file).getId();\n                    if ([\"unknown\", \"binary\", \"image\", \"markdown\", \"audio\"].indexOf(langId) === -1) {\n\n                        queue = queue.then(function () {\n                            var clearWholeFile = fileObj.status.indexOf(Git.FILE_STATUS.UNTRACKED) !== -1 ||\n                                fileObj.status.indexOf(Git.FILE_STATUS.RENAMED) !== -1;\n\n                            var t = (new Date()).getTime() - startTime;\n                            progressTracker.trigger(Events.GIT_PROGRESS_EVENT,\n                                t + \"ms - \" + Strings.CLEAN_FILE_START + \": \" + fileObj.file);\n\n                            return stripWhitespaceFromFile(fileObj.file, clearWholeFile).then(function () {\n                                // stage the files again to include stripWhitespace changes\n                                var notifyProgress = function () {\n                                    var t = (new Date()).getTime() - startTime;\n                                    progressTracker.trigger(Events.GIT_PROGRESS_EVENT,\n                                        t + \"ms - \" + Strings.CLEAN_FILE_END + \": \" + fileObj.file);\n                                };\n                                if (stageChanges) {\n                                    return Git.stage(fileObj.file).then(notifyProgress);\n                                } else {\n                                    notifyProgress();\n                                }\n                            });\n                        });\n\n                    }\n                }\n            });\n\n            queue\n                .then(function () {\n                    resolve();\n                })\n                .catch(function () {\n                    reject();\n                });\n        });\n    }\n\n    function openEditorForFile(file, relative) {\n        if (relative) {\n            file = getProjectRoot() + file;\n        }\n        CommandManager.execute(Commands.FILE_OPEN, {\n            fullPath: file\n        });\n    }\n\n    let clearWhitespace = Preferences.get(\"clearWhitespaceOnSave\");\n    Preferences.getExtensionPref().on(\"change\", \"clearWhitespaceOnSave\", ()=>{\n        clearWhitespace = Preferences.get(\"clearWhitespaceOnSave\");\n    });\n\n    EventEmitter.on(Events.BRACKETS_DOCUMENT_SAVED, function (doc) {\n        if(!clearWhitespace){\n            return;\n        }\n        var fullPath       = doc.file.fullPath,\n            currentGitRoot = Preferences.get(\"currentGitRoot\"),\n            path           = fullPath.substring(currentGitRoot.length);\n        stripWhitespaceFromFile(path);\n    });\n\n    function enableCommand(commandID, enabled) {\n        const command = CommandManager.get(commandID);\n        if(!command){\n            return;\n        }\n        enabled = commandID === Constants.CMD_GIT_SETTINGS_COMMAND_ID ?\n            true : enabled && Setup.isExtensionActivated();\n        command.setEnabled(enabled);\n    }\n\n    // Public API\n    exports.FORMAT_DIFF_TOO_LARGE       = FORMAT_DIFF_TOO_LARGE;\n    exports.formatDiff                  = formatDiff;\n    exports.getProjectRoot              = getProjectRoot;\n    exports.getExtensionDirectory       = getExtensionDirectory;\n    exports.askQuestion                 = askQuestion;\n    exports.showOutput                  = showOutput;\n    exports.isProjectRootWritable       = isProjectRootWritable;\n    exports.pathExists                  = pathExists;\n    exports.loadPathContent             = loadPathContent;\n    exports.setLoading                  = setLoading;\n    exports.unsetLoading                = unsetLoading;\n    exports.isLoading                   = isLoading;\n    exports.consoleWarn                 = consoleWarn;\n    exports.consoleError                = consoleError;\n    exports.consoleDebug                = consoleDebug;\n    exports.encodeSensitiveInformation  = encodeSensitiveInformation;\n    exports.reloadDoc                   = reloadDoc;\n    exports.stripWhitespaceFromFiles    = stripWhitespaceFromFiles;\n    exports.openEditorForFile           = openEditorForFile;\n    exports.enableCommand               = enableCommand;\n\n});\n"],"file":"Utils.js"}