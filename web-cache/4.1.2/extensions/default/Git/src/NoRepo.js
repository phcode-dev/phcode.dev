define(function(require){const FileSystem=brackets.getModule("filesystem/FileSystem"),FileUtils=brackets.getModule("file/FileUtils"),ProjectManager=brackets.getModule("project/ProjectManager"),CommandManager=brackets.getModule("command/CommandManager"),Metrics=brackets.getModule("utils/Metrics"),Strings=brackets.getModule("strings"),StringUtils=brackets.getModule("utils/StringUtils"),ErrorHandler=require("src/ErrorHandler"),Events=require("src/Events"),EventEmitter=require("src/EventEmitter"),ExpectedError=require("src/ExpectedError"),ProgressDialog=require("src/dialogs/Progress"),CloneDialog=require("src/dialogs/Clone"),Git=require("src/git/Git"),Preferences=require("src/Preferences"),Constants=require("src/Constants"),Utils=require("src/Utils");var gitignoreTemplate=require("text!templates/default-gitignore");function createGitIgnore(){var gitIgnorePath=Preferences.get("currentGitRoot")+".gitignore";return Utils.pathExists(gitIgnorePath).then(function(exists){if(!exists)return jsPromise(FileUtils.writeText(FileSystem.getFileForPath(gitIgnorePath),gitignoreTemplate))})}function stageGitIgnore(){return createGitIgnore().then(function(){return Git.stage(".gitignore")})}function handleGitInit(){Utils.isProjectRootWritable().then(function(writable){if(!writable){const initPath=Phoenix.app.getDisplayPath(Utils.getProjectRoot()),errorStr=StringUtils.format(Strings.FOLDER_NOT_WRITABLE,initPath);throw new ExpectedError(errorStr)}return Git.init().catch(function(err){return new Promise((resolve,reject)=>{ErrorHandler.contains(err,"Please tell me who you are")?EventEmitter.emit(Events.GIT_CHANGE_USERNAME,function(){EventEmitter.emit(Events.GIT_CHANGE_EMAIL,function(){Git.init().then(function(result){resolve(result)}).catch(function(error){reject(error)})})}):reject(err)})})}).then(function(){return Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"init","success"),stageGitIgnore("Initial staging")}).catch(function(err){ErrorHandler.showError(err,Strings.INIT_NEW_REPO_FAILED,{dontStripError:!0}),Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"init","fail")}).then(function(){EventEmitter.emit(Events.REFRESH_ALL)})}function isProjectRootEmpty(){return new Promise(function(resolve,reject){ProjectManager.getProjectRoot().getContents(function(err,entries){if(err)return reject(err);resolve(0===entries.length)})})}function handleGitClone(gitCloneURL,destPath){var $gitPanel,$cloneButton=$("#git-panel").find(".git-clone");$cloneButton.prop("disabled",!0),isProjectRootEmpty().then(function(isEmpty){if(isEmpty){if(gitCloneURL)return _clone({remote:"origin",remoteUrlNew:gitCloneURL});CloneDialog.show().then(_clone).catch(function(err){err&&ErrorHandler.showError(err,Strings.GIT_CLONE_REMOTE_FAILED)})}else{const clonePath=Phoenix.app.getDisplayPath(Utils.getProjectRoot()),err=new ExpectedError(StringUtils.format(Strings.GIT_CLONE_ERROR_EXPLAIN,clonePath));ErrorHandler.showError(err,Strings.GIT_CLONE_REMOTE_FAILED,{dontStripError:!0})}function _clone(cloneConfig){var q=Promise.resolve(),remoteUrl=cloneConfig.remoteUrl;return cloneConfig.remoteUrlNew&&(remoteUrl=cloneConfig.remoteUrlNew),q=q.then(function(){const tracker=ProgressDialog.newProgressTracker();return destPath=destPath?fs.getTauriPlatformPath(destPath):".",ProgressDialog.show(Git.clone(remoteUrl,destPath,tracker),tracker)}).then(()=>{Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"clone","success")}).catch(function(err){Metrics.countEvent(Metrics.EVENT_TYPE.GIT,"clone","fail"),ErrorHandler.showError(err,Strings.GIT_CLONE_REMOTE_FAILED,{errorMetric:"clone"})}),cloneConfig.remoteUrlRestore&&(q=q.then(function(){return Git.setRemoteUrl(cloneConfig.remote,cloneConfig.remoteUrlRestore)})),q.finally(function(){EventEmitter.emit(Events.REFRESH_ALL)})}}).catch(function(err){ErrorHandler.showError(err)}).finally(function(){$cloneButton.prop("disabled",!1)})}CommandManager.register(Strings.GIT_CLONE,Constants.CMD_GIT_CLONE_WITH_URL,handleGitClone),EventEmitter.on(Events.HANDLE_GIT_INIT,function(){handleGitInit()}),EventEmitter.on(Events.HANDLE_GIT_CLONE,function(){handleGitClone()}),EventEmitter.on(Events.GIT_NO_BRANCH_EXISTS,function(){stageGitIgnore()})});
//# sourceMappingURL=NoRepo.js.map
