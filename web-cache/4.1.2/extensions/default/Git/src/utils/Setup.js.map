{"version":3,"sources":["extensions/default/Git/src/utils/Setup.js"],"names":["define","require","exports","_","brackets","getModule","Metrics","Cli","Git","Preferences","standardGitPathsWin","standardGitPathsNonWin","extensionActivated","getGitVersion","Promise","resolve","reject","pathsToLook","get","concat","platform","unique","compact","results","errors","finish","after","length","searchedPaths","join","gits","sortBy","reverse","latestGit","m","version","match","major","parseInt","minor","filter","git","setGitPath","path","forEach","index","spawnCommand","cwd","then","stdout","push","catch","err","finally","isExtensionActivated","init","console","log","_version","countEvent","EVENT_TYPE","GIT","warn"],"mappings":"AAAAA,OAAO,SAAUC,QAASC,SAGtB,MAAMC,EAAIC,SAASC,UAAU,qBACzBC,QAAUF,SAASC,UAAU,iBAG3BE,IAAcN,QAAQ,WACxBO,IAAcP,QAAQ,eACtBQ,YAAcR,QAAQ,mBAG1B,IAAIS,oBAAsB,CACtB,6CACA,wCAGAC,uBAAyB,CACzB,yBACA,qBACA,gBAGAC,oBAAqB,EAGzB,SAASC,gBACL,OAAO,IAAIC,QAAQ,SAAUC,QAASC,QAGlC,IAAIC,YAAc,CAACR,YAAYS,IAAI,WAAY,OAAOC,OAA6B,QAAtBf,SAASgB,SAAqBV,oBAAsBC,wBACjHM,YAAcd,EAAEkB,OAAOlB,EAAEmB,QAAQL,cAEjC,IAAIM,QAAU,GACVC,OAAS,GACTC,OAAStB,EAAEuB,MAAMT,YAAYU,OAAQ,WAErC,IAAIC,cAAgB,wBAA0BX,YAAYY,KAAK,MAE/D,GAAuB,IAAnBN,QAAQI,OAERX,OAAO,yCAA2CY,mBAC/C,CAEH,IAAIE,KAAO3B,EAAE4B,OAAOR,QAAS,WAAWS,UACpCC,UAAYH,KAAK,GACjBI,EAAID,UAAUE,QAAQC,MAAM,sBAC5BC,MAAQC,SAASJ,EAAE,GAAI,IACvBK,MAAQD,SAASJ,EAAE,GAAI,IAE3B,GAAc,IAAVG,OAAeE,MAAQ,EACvB,OAAOvB,OAAO,qEAAuEiB,UAAUE,QAAUP,eAI7GK,UAAY9B,EAAE4B,OAAO5B,EAAEqC,OAAOV,KAAM,SAAUW,KAAO,OAAOA,IAAIN,UAAYF,UAAUE,UAAa,SAAS,GAG5G3B,IAAIkC,WAAWT,UAAUU,MACzB5B,QAAQkB,UAAUE,YAK1BlB,YAAY2B,QAAQ,SAAUD,KAAME,OAChCtC,IAAIuC,aAAaH,KAAM,CAAC,aAAc,CAClCI,IAAK,OACNC,KAAK,SAAUC,QACd,IAAIf,EAAIe,OAAOb,MAAM,wBACjBF,GACAX,QAAQ2B,KAAK,CACTP,KAAMA,KACNR,QAASD,EAAE,GACXW,MAAOA,UAGhBM,MAAM,SAAUC,KACf5B,OAAO0B,KAAK,CACRP,KAAMA,KACNS,IAAKA,QAEVC,QAAQ,WACP5B,eAOhB,SAAS6B,uBACL,OAAO1C,oBAAsBH,YAAYS,IAAI,aAajD,SAASqC,OACL,OAAO,IAAIzC,QAASC,UAChB,IAAIN,YAAYS,IAAI,aAGhB,OAFAH,SAAQ,QACRyC,QAAQC,IAAI,mCAGhB5C,gBAAgBmC,KAAK,SAAUU,UAE3B3C,QADAH,oBAAqB,GAErBN,QAAQqD,WAAWrD,QAAQsD,WAAWC,IAAK,YAAa,SACzDV,MAAM,SAAUC,KACfxC,oBAAqB,EACrB4C,QAAQM,KAAK,iFAAkFV,KAC/FrC,QAAQH,oBACRN,QAAQqD,WAAWrD,QAAQsD,WAAWC,IAAK,YAAa,UAMpE3D,QAAQqD,KAAOA,KACfrD,QAAQoD,qBAAuBA,qBAC/BpD,QAAQW,cAAgBA","sourcesContent":["define(function (require, exports) {\n\n    // Brackets modules\n    const _ = brackets.getModule(\"thirdparty/lodash\"),\n        Metrics = brackets.getModule(\"utils/Metrics\");\n\n    // Local modules\n    const Cli         = require(\"src/Cli\"),\n        Git         = require(\"src/git/Git\"),\n        Preferences = require(\"src/Preferences\");\n\n    // Module variables\n    let standardGitPathsWin = [\n        \"C:\\\\Program Files (x86)\\\\Git\\\\cmd\\\\git.exe\",\n        \"C:\\\\Program Files\\\\Git\\\\cmd\\\\git.exe\"\n    ];\n\n    let standardGitPathsNonWin = [\n        \"/usr/local/git/bin/git\",\n        \"/usr/local/bin/git\",\n        \"/usr/bin/git\"\n    ];\n\n    let extensionActivated = false;\n\n    // Implementation\n    function getGitVersion() {\n        return new Promise(function (resolve, reject) {\n\n            // TODO: do this in two steps - first check user config and then check all\n            var pathsToLook = [Preferences.get(\"gitPath\"), \"git\"].concat(brackets.platform === \"win\" ? standardGitPathsWin : standardGitPathsNonWin);\n            pathsToLook = _.unique(_.compact(pathsToLook));\n\n            var results = [],\n                errors = [];\n            var finish = _.after(pathsToLook.length, function () {\n\n                var searchedPaths = \"\\n\\nSearched paths:\\n\" + pathsToLook.join(\"\\n\");\n\n                if (results.length === 0) {\n                    // no git found\n                    reject(\"No Git has been found on this computer\" + searchedPaths);\n                } else {\n                    // at least one git is found\n                    var gits = _.sortBy(results, \"version\").reverse(),\n                        latestGit = gits[0],\n                        m = latestGit.version.match(/([0-9]+)\\.([0-9]+)/),\n                        major = parseInt(m[1], 10),\n                        minor = parseInt(m[2], 10);\n\n                    if (major === 1 && minor < 8) {\n                        return reject(\"Brackets Git requires Git 1.8 or later - latest version found was \" + latestGit.version + searchedPaths);\n                    }\n\n                    // prefer the first defined so it doesn't change all the time and confuse people\n                    latestGit = _.sortBy(_.filter(gits, function (git) { return git.version === latestGit.version; }), \"index\")[0];\n\n                    // this will save the settings also\n                    Git.setGitPath(latestGit.path);\n                    resolve(latestGit.version);\n                }\n\n            });\n\n            pathsToLook.forEach(function (path, index) {\n                Cli.spawnCommand(path, [\"--version\"], {\n                    cwd: \"./\"\n                }).then(function (stdout) {\n                    var m = stdout.match(/^git version\\s+(.*)$/);\n                    if (m) {\n                        results.push({\n                            path: path,\n                            version: m[1],\n                            index: index\n                        });\n                    }\n                }).catch(function (err) {\n                    errors.push({\n                        path: path,\n                        err: err\n                    });\n                }).finally(function () {\n                    finish();\n                });\n            });\n\n        });\n    }\n\n    function isExtensionActivated() {\n        return extensionActivated && Preferences.get(\"enableGit\");\n    }\n\n    /**\n     * Initializes the Git extension by checking for the Git executable and returns true if active.\n     *\n     * @async\n     * @function init\n     * @returns {Promise<boolean>}\n     *   A promise that resolves to a boolean indicating whether the extension was activated (`true`)\n     *   or deactivated (`false`) due to a missing or inaccessible Git executable.\n     * });\n     */\n    function init() {\n        return new Promise((resolve) =>{\n            if(!Preferences.get(\"enableGit\")){\n                resolve(false);\n                console.log(\"Git is disabled in preferences.\");\n                return;\n            }\n            getGitVersion().then(function (_version) {\n                extensionActivated = true;\n                resolve(extensionActivated);\n                Metrics.countEvent(Metrics.EVENT_TYPE.GIT, 'installed', \"yes\");\n            }).catch(function (err) {\n                extensionActivated = false;\n                console.warn(\"Failed to launch Git executable. Deactivating Git extension. Is git installed?\", err);\n                resolve(extensionActivated);\n                Metrics.countEvent(Metrics.EVENT_TYPE.GIT, 'installed', \"no\");\n            });\n        });\n    }\n\n    // Public API\n    exports.init = init;\n    exports.isExtensionActivated = isExtensionActivated;\n    exports.getGitVersion = getGitVersion;\n\n});\n"],"file":"Setup.js"}