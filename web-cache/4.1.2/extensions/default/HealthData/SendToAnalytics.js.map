{"version":3,"sources":["extensions/default/HealthData/SendToAnalytics.js"],"names":["define","require","exports","module","Metrics","brackets","getModule","PreferencesManager","PerfUtils","NodeUtils","themesPref","getExtensionPrefs","BugsnagPerformance","window","PLATFORM","EVENT_TYPE","PERFORMANCE","STORAGE","_emitDeviceTypeMetrics","browser","isDeskTop","countEvent","isMobile","isTablet","_emitMobileMetricsIfPresent","platform","mobile","isIos","isWindows","isAndroid","_emitBrowserMetrics","desktop","isChrome","isChromeBased","isEdgeChromium","isFirefox","isOpera","isOperaChromium","async","_sendStorageMetrics","navigator","storage","estimate","quota","percentageUsed","Math","round","usage","usedMB","console","log","valueEvent","_getPlatformInfo","OS","test","userAgent","appVersion","sendPlatformMetrics","app","language","getLocale","metadata","version","Phoenix","isNativeApp","getLinuxOSFlavorName","then","flavor","bugsnagPerformanceInited","_initBugsnagPerformance","start","apiKey","AppConfig","releaseStage","__TAURI__","config","bugsnagEnv","autoInstrumentRouteChanges","autoInstrumentNetworkRequests","autoInstrumentFullPageLoads","_bugsnagPerformance","key","valueMs","isDisabled","isTestWindow","activityStartTime","Date","activityEndTime","getTime","startSpan","startTime","end","sendStartupPerformanceMetrics","healthReport","getHealthReport","labelAppStart","firstBoot","Number","PhStore","_storageBootstrapTime","_tauriBootVars","bootstrapTime","nodeSetupDonePromise","PhNodeEngine","_nodeLoadTime","catch","_err","_getCurrentTheme","get","sendThemesMetrics","THEMES"],"mappings":"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","sourcesContent":["/*\n * Copyright (c) 2021 - present core.ai . All rights reserved.\n *\n * Permission is hereby granted, free of charge, to any person obtaining a\n * copy of this software and associated documentation files (the \"Software\"),\n * to deal in the Software without restriction, including without limitation\n * the rights to use, copy, modify, merge, publish, distribute, sublicense,\n * and/or sell copies of the Software, and to permit persons to whom the\n * Software is furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in\n * all copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\n * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER\n * DEALINGS IN THE SOFTWARE.\n *\n */\n\n/*global AppConfig*/\ndefine(function (require, exports, module) {\n    const Metrics = brackets.getModule(\"utils/Metrics\"),\n        PreferencesManager  = brackets.getModule(\"preferences/PreferencesManager\"),\n        PerfUtils           = brackets.getModule(\"utils/PerfUtils\"),\n        NodeUtils           = brackets.getModule(\"utils/NodeUtils\"),\n        themesPref          = PreferencesManager.getExtensionPrefs(\"themes\");\n\n    const BugsnagPerformance = window.BugsnagPerformance;\n\n    const PLATFORM = Metrics.EVENT_TYPE.PLATFORM,\n        PERFORMANCE = Metrics.EVENT_TYPE.PERFORMANCE,\n        STORAGE = Metrics.EVENT_TYPE.STORAGE;\n\n    // Platform metrics to be sent at startup\n    function _emitDeviceTypeMetrics() {\n        if(brackets.browser.isDeskTop) {\n            Metrics.countEvent(PLATFORM, \"device\", \"desktop\");\n        }\n        if(brackets.browser.isMobile) {\n            Metrics.countEvent(PLATFORM, \"device\", \"mobile\");\n        }\n        if(brackets.browser.isTablet) {\n            Metrics.countEvent(PLATFORM, \"device\", \"tablet\");\n        }\n    }\n    function _emitMobileMetricsIfPresent() {\n        let platform = \"none\";\n        if(brackets.browser.mobile.isIos) {\n            platform = \"ios\";\n        } else if(brackets.browser.mobile.isWindows) {\n            platform = \"windows\";\n        } else if(brackets.browser.mobile.isAndroid) {\n            platform = \"android\";\n        } else {\n            return;\n        }\n        Metrics.countEvent(PLATFORM, \"mobile\", platform);\n    }\n    function _emitBrowserMetrics() {\n        if(brackets.browser.desktop.isChrome) {\n            Metrics.countEvent(PLATFORM, \"browser\", \"chrome\");\n        }\n        if(brackets.browser.desktop.isChromeBased) {\n            Metrics.countEvent(PLATFORM, \"browser\", \"chromeBased\");\n        }\n        if(brackets.browser.desktop.isEdgeChromium) {\n            Metrics.countEvent(PLATFORM, \"browser\", \"EdgeChromium\");\n        }\n        if(brackets.browser.desktop.isFirefox) {\n            Metrics.countEvent(PLATFORM, \"browser\", \"firefox\");\n        }\n        if(brackets.browser.desktop.isOpera) {\n            Metrics.countEvent(PLATFORM, \"browser\", \"opera\");\n        }\n        if(brackets.browser.desktop.isOperaChromium) {\n            Metrics.countEvent(PLATFORM, \"browser\", \"operaChromium\");\n        }\n    }\n\n    // web storage\n    async function _sendStorageMetrics() {\n        if (navigator.storage && navigator.storage.estimate) {\n            const quota = await navigator.storage.estimate();\n            // quota.usage -> Number of bytes used.\n            // quota.quota -> Maximum number of bytes available.\n            const percentageUsed = Math.round((quota.usage / quota.quota) * 100);\n            const usedMB = Math.round(quota.usage / 1024 / 1024);\n            console.log(`Web Storage quota used: ${percentageUsed}%, ${usedMB}MB`);\n            Metrics.valueEvent(STORAGE, \"browserQuota\", \"percentUsed\", percentageUsed);\n            Metrics.valueEvent(STORAGE, \"browserQuota\", \"usedMB\", usedMB);\n        }\n    }\n\n    function _getPlatformInfo() {\n        let OS = \"\";\n        if (/Windows|Win32|WOW64|Win64/.test(window.navigator.userAgent)) {\n            OS = \"WIN\";\n        } else if (/Mac/.test(window.navigator.userAgent)) {\n            OS = \"OSX\";\n        } else if (/Linux|X11/.test(window.navigator.userAgent)) {\n            OS = \"LINUX32\";\n            if (/x86_64/.test(window.navigator.appVersion + window.navigator.userAgent)) {\n                OS = \"LINUX64\";\n            }\n        }\n\n        return OS;\n    }\n\n    function sendPlatformMetrics() {\n        Metrics.countEvent(PLATFORM, \"os\", brackets.platform);\n        Metrics.countEvent(PLATFORM, \"userAgent\", window.navigator.userAgent);\n        Metrics.countEvent(PLATFORM, \"languageOS\", brackets.app.language);\n        Metrics.countEvent(PLATFORM, \"languageBrackets\", brackets.getLocale());\n        Metrics.countEvent(PLATFORM, \"bracketsVersion\", brackets.metadata.version);\n        if(Phoenix.platform === \"linux\" && Phoenix.isNativeApp) {\n            NodeUtils.getLinuxOSFlavorName()\n                .then(flavor=>{\n                    if(flavor){\n                        Metrics.countEvent(PLATFORM, \"os.flavor\", flavor);\n                    } else {\n                        Metrics.countEvent(PLATFORM, \"os.flavor\", _getPlatformInfo());\n                    }\n                });\n        } else {\n            Metrics.countEvent(PLATFORM, \"os.flavor\", _getPlatformInfo());\n        }\n        _emitDeviceTypeMetrics();\n        _emitBrowserMetrics();\n        _emitMobileMetricsIfPresent();\n        _sendStorageMetrics();\n    }\n\n    let bugsnagPerformanceInited = false;\n    function _initBugsnagPerformance() {\n        bugsnagPerformanceInited = true;\n        BugsnagPerformance.start({\n            apiKey: '94ef94f4daf871ca0f2fc912c6d4764d',\n            appVersion: AppConfig.version,\n            releaseStage: window.__TAURI__ ?\n                `tauri-${AppConfig.config.bugsnagEnv}-${Phoenix.platform}` : AppConfig.config.bugsnagEnv,\n            autoInstrumentRouteChanges: false,\n            autoInstrumentNetworkRequests: false,\n            autoInstrumentFullPageLoads: false\n        });\n    }\n\n    function _bugsnagPerformance(key, valueMs) {\n        if(Metrics.isDisabled() || !BugsnagPerformance || Phoenix.isTestWindow){\n            return;\n        }\n        if(!bugsnagPerformanceInited) {\n            _initBugsnagPerformance();\n        }\n        let activityStartTime = new Date();\n        let activityEndTime = new Date(activityStartTime.getTime() + valueMs);\n        BugsnagPerformance\n            .startSpan(key, { startTime: activityStartTime })\n            .end(activityEndTime);\n    }\n\n    // Performance\n    function sendStartupPerformanceMetrics() {\n        const healthReport = PerfUtils.getHealthReport();\n        let labelAppStart = \"AppStartupTime\";\n        if(Phoenix.firstBoot){\n            labelAppStart = \"FirstBootTime\";\n        }\n        Metrics.valueEvent(PERFORMANCE, \"startup\", labelAppStart,\n            Number(healthReport[\"AppStartupTime\"]));\n        _bugsnagPerformance(labelAppStart, Number(healthReport[\"AppStartupTime\"])); // expensive api, use sparsely\n        Metrics.valueEvent(PERFORMANCE, \"startup\", \"ModuleDepsResolved\",\n            Number(healthReport[\"ModuleDepsResolved\"]));\n        _bugsnagPerformance(\"ModuleDepsResolved\", Number(healthReport[\"ModuleDepsResolved\"])); // expensive api, use sparsely\n        Metrics.valueEvent(PERFORMANCE, \"startup\", \"PhStore\", PhStore._storageBootstrapTime);\n        _bugsnagPerformance(\"PhStore\",\n            PhStore._storageBootstrapTime); // expensive api, use sparsely\n        if(Phoenix.isNativeApp) {\n            Metrics.valueEvent(PERFORMANCE, \"startup\", \"tauriBoot\", window._tauriBootVars.bootstrapTime);\n            _bugsnagPerformance(\"tauriBootVars\",\n                window._tauriBootVars.bootstrapTime); // expensive api, use sparsely\n        }\n        if(window.nodeSetupDonePromise) {\n            window.nodeSetupDonePromise\n                .then(()=>{\n                    if(window.PhNodeEngine && window.PhNodeEngine._nodeLoadTime){\n                        Metrics.valueEvent(PERFORMANCE, \"startup\", \"nodeBoot\", window.PhNodeEngine._nodeLoadTime);\n                        _bugsnagPerformance(\"nodeBoot\",\n                            window.PhNodeEngine._nodeLoadTime); // expensive api, use sparsely\n                    }\n                    Metrics.countEvent(PERFORMANCE, \"nodeBoot\", \"success\", 1);\n                })\n                .catch(_err=>{\n                    Metrics.countEvent(PERFORMANCE, \"nodeBoot\", \"fail\", 1);\n                });\n        }\n    }\n\n    // Themes\n    function _getCurrentTheme() {\n        // TODO: currently phoenix only have default themes, but in future, we should ensure that only themes in the\n        //  registry and user installed are logged for privacy.\n        return themesPref.get(\"theme\") || \"default\";\n    }\n    function sendThemesMetrics() {\n        Metrics.countEvent(Metrics.EVENT_TYPE.THEMES, \"currentTheme\", _getCurrentTheme());\n    }\n\n    exports.sendPlatformMetrics = sendPlatformMetrics;\n    exports.sendStartupPerformanceMetrics = sendStartupPerformanceMetrics;\n    exports.sendThemesMetrics = sendThemesMetrics;\n    // TODO: send extension metrics\n});\n"],"file":"SendToAnalytics.js"}