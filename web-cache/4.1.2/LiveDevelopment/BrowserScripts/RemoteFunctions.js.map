{"version":3,"sources":["LiveDevelopment/BrowserScripts/RemoteFunctions.js"],"names":["RemoteFunctions","config","previouslyClickedElement","req","timeout","animateHighlight","time","window","cancelAnimationFrame","clearTimeout","requestAnimationFrame","redrawHighlights","setTimeout","_editHandler","HIGHLIGHT_CLASSNAME","_autoScrollTimer","_isAutoScrolling","AUTO_SCROLL_SPEED","AUTO_SCROLL_EDGE_SIZE","_handleAutoScroll","clientY","viewportHeight","innerHeight","scrollEdgeSize","clearInterval","scrollDirection","setInterval","scrollBy","_stopAutoScroll","_validEvent","event","navigator","platform","substr","metaKey","ctrlKey","isElementEditable","element","onlyHighlight","isProUser","hasAttribute","tagName","_isInsideHeadTag","parent","document","parentElement","_screenOffset","elemBounds","getBoundingClientRect","body","offsetTop","offsetLeft","getComputedStyle","position","left","pageXOffset","top","pageYOffset","bodyBounds","_trigger","name","value","autoRemove","key","setAttribute","removeAttribute","bind","isInViewport","rect","html","documentElement","bottom","clientHeight","right","innerWidth","clientWidth","isElementVisible","width","height","computedStyle","display","visibility","opacity","parentStyle","getDocumentOffsetTop","offsetParent","_handleAIOptionClick","dismissAllUIBoxes","_aiPromptBox","AIPromptBox","_handleDeleteOptionClick","tagId","getAttribute","_Brackets_MessageBroker","send","livePreviewEditEnabled","Number","delete","console","error","_handleDuplicateOptionClick","duplicate","_handleSelectParentOptionClick","click","handleOptionClick","e","action","startEditing","_dragStartChores","_originalDragOpacity","style","_dragEndChores","DROP_MARKER_CLASSNAME","DROP_MARKER_VERTICAL_CLASSNAME","DROP_MARKER_INSIDE_CLASSNAME","_getIndicatorType","flexDirection","startsWith","_canAcceptChildren","voidElements","nonContainerElements","toUpperCase","includes","_isValidNesting","sourceElement","targetElement","sourceTag","targetTag","blockElements","inlineElements","interactiveElements","sectioningContent","noSelfNesting","restrictedContainers","UL","OL","DL","TABLE","THEAD","TBODY","TFOOT","TR","COLGROUP","SELECT","OPTGROUP","DATALIST","PICTURE","AUDIO","VIDEO","FIGURE","DETAILS","_getDropZone","clientX","indicatorType","canAcceptChildren","isValidNesting","leftThird","rightThird","topThird","bottomThird","_createDropMarker","dropZone","_removeDropMarkerFromElement","marker","createElement","className","zIndex","borderRadius","pointerEvents","border","backgroundColor","animation","background","boxShadow","_dropMarker","appendChild","parentNode","removeChild","_clearDropMarkers","horizontalMarkers","querySelectorAll","verticalMarkers","insideMarkers","i","length","elements","j","undefined","_originalDragBackgroundColor","_originalDragTransform","transform","_originalDragTransition","transition","_findNearestValidTarget","searchRadius","step","radius","points","point","x","y","target","elementFromPoint","_currentDraggedElement","onDragOver","preventDefault","onDragLeave","relatedTarget","onDrop","stopPropagation","dismissUIAndCleanupState","sourceId","targetId","messageData","move","insertInside","insertAfter","_shouldShowEditTextOption","toLowerCase","nonEditableElements","_shouldShowSelectParentOption","NodeMoreOptionsBox","this","remove","create","NodeInfoBox","selectedModel","prototype","_registerDragDrop","allElements","forEach","el","addEventListener","dataTransfer","setData","dismissImageRibbonGallery","effectAllowed","_getBoxPosition","boxWidth","boxHeight","offset","topPos","leftPos","_style","shadow","attachShadow","mode","showEditTextOption","showSelectParentOption","ICONS","content","strings","ai","selectParent","editText","styles","innerHTML","_shadow","boxElement","querySelector","boxRect","pos","spans","span","currentTarget","_nodeMoreOptionsBox","_checkOverlap","nodeInfoBoxPos","nodeInfoBoxDimensions","moreOptionsBoxElement","moreOptionsBoxOffset","moreOptionsBoxRect","infoBox","moreOptionsBox","isOverlapping","boxDimensions","overlap","bottomPosition","wouldIncreaseViewportHeight","isHoverMode","shouldShowHighlightOnHover","shouldUseFloatingPosition","id","classes","Array","from","classList","Math","min","isBoxOverlapping","newPos","viewportWidth","aiPromptPlaceholder","textarea","focus","_attachEventHandlers","sendButton","modelSelect","hasText","trim","disabled","shiftKey","_handleSend","prompt","AISend","_handleKeydown","removeEventListener","_handleResize","_imageGalleryCache","currentQuery","allImages","totalPages","currentPage","maxImages","ImageRibbonGallery","imagesPerPage","scrollPosition","maxWidth","maxHeight","Highlight","color","trigger","selector","_localHighlight","_hoverHighlight","_clickHighlight","_nodeInfoBox","_imageRibbonGallery","imageGallerySearchPlaceholder","imageGallerySelectFromComputer","_getDefaultQuery","qualityQueries","randIndex","floor","random","_fetchImages","searchQuery","page","append","_currentSearchQuery","_loadFromCache","_loadPageFromCache","_fetchFromAPI","_clearCache","apiUrl","encodeURIComponent","_showLoading","fetch","then","response","ok","Error","status","json","data","results","concat","_renderImages","total_pages","_updateNavButtons","_updateSearchInput","_updateCache","_showError","_isLoadingMore","_hideLoadingMore","catch","newImages","slice","searchInput","placeholder","ceil","startIdx","endIdx","pageImages","_handleNavLeft","container","containerWidth","scrollAmount","max","scrollTo","behavior","_handleNavRight","totalWidth","scrollWidth","nearEnd","_showLoadingMore","navLeft","navRight","atEnd","hasMorePages","rowElement","loadingIndicator","cssText","textContent","ribbonContainer","searchButton","closeButton","selectImageBtn","fileInput","performSearch","query","file","files","_handleLocalImageSelection","images","savedScrollPosition","scrollLeft","image","thumbDiv","img","src","thumb_url","url","alt","alt_text","loading","_originalImageStyle","objectFit","_originalImageSrc","attribution","photographer","href","photographer_url","rel","user","source","unsplash_url","downloadIcon","title","imageGalleryUseImage","contains","_showDownloadIndicator","filename","_generateFilename","extnName","targetWidth","targetHeight","widthNum","parseInt","heightNum","downloadUrl","_useImage","message","photographerName","searchTerm","cleanSearchTerm","replace","cleanPhotographerName","imageUrl","isLocalFile","useImage","byteCharacters","atob","split","byteNumbers","charCodeAt","imageData","_hideDownloadIndicator","type","reader","FileReader","onload","imageDataUrl","result","originalName","nameWithoutExt","substring","lastIndexOf","extension","cleanName","onerror","readAsDataURL","queryToUse","add","indicator","spinner","_elementExists","_makeHighlightDiv","doAnimation","elementBounds","highlight","elementStyling","transitionDuration","parseFloat","getPropertyValue","animationDuration","trackingElement","realElBorder","borderBox","boxSizing","outerHeight","outerWidth","paddingLeft","paddingRight","paddingTop","paddingBottom","visualisations","horizontal","vertical","drawPaddingRect","side","elStyling","indexOf","drawMarginRect","margin","setVisibility","remoteHighlight","showPaddingMargin","mainBoxStyles","stylesToSet","paddingVisualisations","marginVisualisations","setupVisualisations","arr","_setStyleValues","Object","assign","marginStyling","paddingStyling","z-index","padding","pointer-events","box-shadow","box-sizing","border-right","border-left","border-top","border-bottom","border-color","borderColor","mergedStyles","animateStartValues","animateStartValue","animateEndValues","animateEndValue","transitionValues","transition-property","transition-duration","styleValues","obj","prop","setProperty","shouldAutoScroll","MessageEvent","push","clear","highlights","redraw","highlighted","_setup","onMouseOver","nodeType","Node","ELEMENT_NODE","onMouseOut","onMouseMove","getHighlightMode","elemHighlights","shouldShowImageRibbon","imageRibbon","clearElementBackground","_originalBackgroundColor","currentBg","onElementHover","dismissNodeInfoBox","onElementHoverOut","_selectElement","_originalOutline","outline","onClick","stopImmediatePropagation","onDoubleClick","onKeyUp","onKeyDown","hideHighlight","highlightRule","rule","nodes","foundValidElement","redrawUIBoxes","redrawEverything","_dismissBoxesForFixedElements","moreOptionsBoxBounds","_possDifference","calcNewDifference","prevDifference","abs","infoBoxElement","_prevElement","infoBoxBounds","_scrollHandler","DOMEditHandler","htmlDocument","rememberedNodes","entityParseParent","_isRawTextNode","node","test","applyDOMEdits","edits","apply","updateConfig","newConfig","oldConfig","JSON","parse","oldHighlightMode","newHighlightMode","highlightModeChanged","isProStatusChanged","highlightSettingChanged","imageRibbonJustEnabled","_handleConfigurationChange","_updateEventListeners","stringify","cleanupPreviousElementState","hasVisibleLivePreviewBoxes","dismissNodeMoreOptionsBox","dismissAIPromptBox","dismissed","moveCursorToEnd","selection","range","createRange","selectNodeContents","collapse","removeAllRanges","addRange","oldContent","getSelection","rangeCount","isCollapsed","isEscapePressed","onBlur","finishEditingCleanup","newContent","finishEditing","execCommand","_editListeners","blur","keydown","isEditSuccessful","livePreviewTextEdit","outerHTML","registerHandlers","_queryBracketsID","_insertChildNode","childElement","edit","before","beforeID","after","afterID","firstChild","lastChild","insertBefore","nextSibling","_parseEntities","text","_textReplace","prevIgnoringHighlights","previousSibling","nextIgnoringHighlights","lastChildIgnoringHighlights","childNodes","item","start","startMissing","end","endMissing","moveNext","current","next","textNode","createTextNode","lastRemovedWasText","isText","TEXT_NODE","targetID","self","editIsSpecialTag","tag","match","parentID","tagID","attribute","keys","attributes","attr","textElement","tagIDs"],"mappings":"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AAaG,SAASjF,WAAY+E,qBAAqBE,SAASjF,SAcxE,SAASkF,gBAAgBC,cAAeC,eACpC,MAAMC,UAAYF,cAAcnF,QAAQgF,cAClCM,UAAYF,cAAcpF,QAAQgF,cAGlCO,cAAgB,CAClB,MACA,IACA,KACA,KACA,KACA,KACA,KACA,KACA,UACA,UACA,SACA,SACA,MACA,QACA,OACA,aACA,MACA,QACA,KACA,KACA,KACA,KACA,KACA,KACA,OACA,WACA,UACA,SACA,aACA,UACA,WAIEC,eAAiB,CACnB,OACA,IACA,SACA,KACA,IACA,IACA,IACA,QACA,OACA,MACA,OACA,MACA,MACA,MACA,OACA,MACA,MACA,IACA,OACA,OACA,OACA,OACA,UAIEC,oBAAsB,CACxB,IACA,SACA,QACA,SACA,WACA,QACA,UACA,UACA,QACA,QACA,QACA,SACA,UAIEC,kBAAoB,CAAC,UAAW,QAAS,MAAO,WAGhDC,cAAgB,CAClB,IACA,IACA,SACA,QACA,OACA,SACA,SACA,MACA,OACA,QACA,UACA,UACA,UACA,KACA,KACA,KACA,KACA,KACA,KACA,SACA,aACA,UACA,WAIEC,qBAAuB,CAEzBC,GAAI,CAAC,MACLC,GAAI,CAAC,MACLC,GAAI,CAAC,KAAM,MAGXC,MAAO,CAAC,QAAS,QAAS,QAAS,KAAM,UAAW,YACpDC,MAAO,CAAC,MACRC,MAAO,CAAC,MACRC,MAAO,CAAC,MACRC,GAAI,CAAC,KAAM,MACXC,SAAU,CAAC,OAGXC,OAAQ,CAAC,SAAU,YACnBC,SAAU,CAAC,UACXC,SAAU,CAAC,UAGXC,QAAS,CAAC,SAAU,OACpBC,MAAO,CAAC,SAAU,SAClBC,MAAO,CAAC,SAAU,SAGlBC,OAAQ,CAAC,aAAc,MAAO,IAAK,MAAO,SAAU,MAAO,QAAS,MAAO,QAC3EC,QAAS,CAAC,YAId,QAAIlB,cAAcV,SAASI,YAAcA,YAAcC,eAKnDC,cAAcN,SAASI,aAAcG,eAAeP,SAASK,cAK7DM,qBAAqBN,WACdM,qBAAqBN,WAAWL,SAASI,YAIlC,MAAdC,YAAqBC,cAAcN,SAASI,gBAK5CI,oB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","sourcesContent":["/*\n * GNU AGPL-3.0 License\n *\n * Copyright (c) 2021 - present core.ai . All rights reserved.\n * Original work Copyright (c) 2012 - 2021 Adobe Systems Incorporated. All rights reserved.\n *\n * This program is free software: you can redistribute it and/or modify it\n * under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT\n * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License\n * for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see https://opensource.org/licenses/AGPL-3.0.\n *\n */\n\n/*jslint forin: true */\n/*global Node, MessageEvent */\n/*theseus instrument: false */\n\n/**\n * RemoteFunctions define the functions to be executed in the browser. This\n * modules should define a single function that returns an object of all\n * exported functions.\n */\nfunction RemoteFunctions(config = {}) {\n    // this will store the element that was clicked previously (before the new click)\n    // we need this so that we can remove click styling from the previous element when a new element is clicked\n    let previouslyClickedElement = null;\n\n    var req, timeout;\n    var animateHighlight = function (time) {\n        if(req) {\n            window.cancelAnimationFrame(req);\n            window.clearTimeout(timeout);\n        }\n        req = window.requestAnimationFrame(redrawHighlights);\n\n        timeout = setTimeout(function () {\n            window.cancelAnimationFrame(req);\n            req = null;\n        }, time * 1000);\n    };\n\n    /**\n     * @type {DOMEditHandler}\n     */\n    var _editHandler;\n\n    var HIGHLIGHT_CLASSNAME = \"__brackets-ld-highlight\";\n\n    // auto-scroll variables to auto scroll the live preview when an element is dragged to the top/bottom\n    let _autoScrollTimer = null;\n    let _isAutoScrolling = false; // to disable highlights when auto scrolling\n    const AUTO_SCROLL_SPEED = 12; // pixels per scroll\n    const AUTO_SCROLL_EDGE_SIZE = 0.05; // 5% of viewport height (either top/bottom)\n\n    /**\n     * this function is responsible to auto scroll the live preview when\n     * dragging an element to the viewport edges\n     * @param {number} clientY - curr mouse Y position\n     */\n    function _handleAutoScroll(clientY) {\n        const viewportHeight = window.innerHeight;\n        const scrollEdgeSize = viewportHeight * AUTO_SCROLL_EDGE_SIZE;\n\n        // Clear existing timer\n        if (_autoScrollTimer) {\n            clearInterval(_autoScrollTimer);\n            _autoScrollTimer = null;\n        }\n\n        let scrollDirection = 0;\n\n        // check if near top edge (scroll up)\n        if (clientY <= scrollEdgeSize) {\n            scrollDirection = -AUTO_SCROLL_SPEED;\n        } else if (clientY >= viewportHeight - scrollEdgeSize) {\n            // check if near bottom edge (scroll down)\n            scrollDirection = AUTO_SCROLL_SPEED;\n        }\n\n        // Start scrolling if needed\n        if (scrollDirection !== 0) {\n            _isAutoScrolling = true;\n            _autoScrollTimer = setInterval(() => {\n                window.scrollBy(0, scrollDirection);\n            }, 16); // 16 is ~60fps\n        }\n    }\n\n    // stop autoscrolling\n    function _stopAutoScroll() {\n        if (_autoScrollTimer) {\n            clearInterval(_autoScrollTimer);\n            _autoScrollTimer = null;\n        }\n        _isAutoScrolling = false;\n    }\n\n    // determine whether an event should be processed for Live Development\n    function _validEvent(event) {\n        if (window.navigator.platform.substr(0, 3) === \"Mac\") {\n            // Mac\n            return event.metaKey;\n        }\n        // Windows\n        return event.ctrlKey;\n    }\n\n    /**\n     * This is a checker function for editable elements, it makes sure that the element satisfies all the required checks\n     * - When onlyHighlight is false  config.isProUser must be true\n     * - When onlyHighlight is true  config.isProUser can be true or false (doesn't matter)\n     * @param {DOMElement} element\n     * @param {boolean} [onlyHighlight=false] - If true, bypasses the isProUser check\n     * @returns {boolean} - True if the element is editable else false\n     */\n    function isElementEditable(element, onlyHighlight = false) {\n        if(!config.isProUser && !onlyHighlight) {\n            return false;\n        }\n\n        if(element && // element should exist\n           element.hasAttribute(\"data-brackets-id\") && // should have the data-brackets-id attribute\n           element.tagName !== \"BODY\" && // shouldn't be the body tag\n           element.tagName !== \"HTML\" && // shouldn't be the HTML tag\n           !_isInsideHeadTag(element)) { // shouldn't be inside the head tag like meta tags and all\n            return true;\n        }\n        return false;\n    }\n\n    // helper function to check if an element is inside the HEAD tag\n    // we need this because we don't wanna trigger the element highlights on head tag and its children,\n    // except for <style> tags which should be allowed\n    function _isInsideHeadTag(element) {\n        let parent = element;\n        while (parent && parent !== window.document) {\n            if (parent.tagName === \"HEAD\") {\n                // allow <style> tags inside <head>\n                return element.tagName !== \"STYLE\";\n            }\n            parent = parent.parentElement;\n        }\n        return false;\n    }\n\n    // compute the screen offset of an element\n    function _screenOffset(element) {\n        var elemBounds = element.getBoundingClientRect(),\n            body = window.document.body,\n            offsetTop,\n            offsetLeft;\n\n        if (window.getComputedStyle(body).position === \"static\") {\n            offsetLeft = elemBounds.left + window.pageXOffset;\n            offsetTop = elemBounds.top + window.pageYOffset;\n        } else {\n            var bodyBounds = body.getBoundingClientRect();\n            offsetLeft = elemBounds.left - bodyBounds.left;\n            offsetTop = elemBounds.top - bodyBounds.top;\n        }\n        return { left: offsetLeft, top: offsetTop };\n    }\n\n    // set an event on a element\n    function _trigger(element, name, value, autoRemove) {\n        var key = \"data-ld-\" + name;\n        if (value !== undefined && value !== null) {\n            element.setAttribute(key, value);\n            if (autoRemove) {\n                window.setTimeout(element.removeAttribute.bind(element, key));\n            }\n        } else {\n            element.removeAttribute(key);\n        }\n    }\n\n    // Checks if the element is in Viewport in the client browser\n    function isInViewport(element) {\n        var rect = element.getBoundingClientRect();\n        var html = window.document.documentElement;\n        return (\n            rect.top >= 0 &&\n            rect.left >= 0 &&\n            rect.bottom <= (window.innerHeight || html.clientHeight) &&\n            rect.right <= (window.innerWidth || html.clientWidth)\n        );\n    }\n\n    // Checks if an element is actually visible to the user (not hidden, collapsed, or off-screen)\n    function isElementVisible(element) {\n        // Check if element has zero dimensions (indicates it's hidden or collapsed)\n        const rect = element.getBoundingClientRect();\n        if (rect.width === 0 && rect.height === 0) {\n            return false;\n        }\n\n        // Check computed styles for visibility\n        const computedStyle = window.getComputedStyle(element);\n        if (computedStyle.display === 'none' ||\n            computedStyle.visibility === 'hidden' ||\n            computedStyle.opacity === '0') {\n            return false;\n        }\n\n        // Check if any parent element is hidden\n        let parent = element.parentElement;\n        while (parent && parent !== document.body) {\n            const parentStyle = window.getComputedStyle(parent);\n            if (parentStyle.display === 'none' ||\n                parentStyle.visibility === 'hidden') {\n                return false;\n            }\n            parent = parent.parentElement;\n        }\n\n        return true;\n    }\n\n    // returns the distance from the top of the closest relatively positioned parent element\n    function getDocumentOffsetTop(element) {\n        return element.offsetTop + (element.offsetParent ? getDocumentOffsetTop(element.offsetParent) : 0);\n    }\n\n    /**\n     * This function gets called when the AI button is clicked\n     * it shows a AI prompt box to the user\n     * @param {Event} event\n     * @param {DOMElement} element - the HTML DOM element that was clicked\n     */\n    function _handleAIOptionClick(event, element) {\n        // make sure there is no existing AI prompt box, and no other box as well\n        dismissAllUIBoxes();\n        _aiPromptBox = new AIPromptBox(element); // create a new one\n    }\n\n    /**\n     * This function gets called when the delete button is clicked\n     * it sends a message to the editor using postMessage to delete the element from the source code\n     * @param {Event} event\n     * @param {DOMElement} element - the HTML DOM element that was clicked. it is to get the data-brackets-id attribute\n     */\n    function _handleDeleteOptionClick(event, element) {\n        if (isElementEditable(element)) {\n            const tagId = element.getAttribute(\"data-brackets-id\");\n\n            window._Brackets_MessageBroker.send({\n                livePreviewEditEnabled: true,\n                element: element,\n                event: event,\n                tagId: Number(tagId),\n                delete: true\n            });\n        } else {\n            console.error(\"The TagID might be unavailable or the element tag is directly body or html\");\n        }\n    }\n\n    /**\n     * this is for duplicate button. Read '_handleDeleteOptionClick' jsdoc to understand more on how this works\n     * @param {Event} event\n     * @param {DOMElement} element - the HTML DOM element that was clicked. it is to get the data-brackets-id attribute\n     */\n    function _handleDuplicateOptionClick(event, element) {\n        if (isElementEditable(element)) {\n            const tagId = element.getAttribute(\"data-brackets-id\");\n\n            window._Brackets_MessageBroker.send({\n                livePreviewEditEnabled: true,\n                element: element,\n                event: event,\n                tagId: Number(tagId),\n                duplicate: true\n            });\n        } else {\n            console.error(\"The TagID might be unavailable or the element tag is directly body or html\");\n        }\n    }\n\n    /**\n     * this is for select-parent button\n     * When user clicks on this option for a particular element, we get its parent element and trigger a click on it\n     * @param {Event} event\n     * @param {DOMElement} element - the HTML DOM element that was clicked. it is to get the data-brackets-id attribute\n     */\n    function _handleSelectParentOptionClick(event, element) {\n        if (!isElementEditable(element)) {\n            return;\n        }\n\n        const parentElement = element.parentElement;\n        if (isElementEditable(parentElement)) {\n            parentElement.click();\n        } else {\n            console.error(\"The TagID might be unavailable or the parent element tag is directly body or html\");\n        }\n    }\n\n    /**\n     * This function will get triggered when from the multiple advance DOM buttons, one is clicked\n     * this function just checks which exact button was clicked and call the required function\n     * @param {Event} e\n     * @param {String} action - the data-action attribute to differentiate between buttons\n     * @param {DOMElement} element - the selected DOM element\n     */\n    function handleOptionClick(e, action, element) {\n        if (action === \"select-parent\") {\n            _handleSelectParentOptionClick(e, element);\n        } else if (action === \"edit-text\") {\n            startEditing(element);\n        } else if (action === \"duplicate\") {\n            _handleDuplicateOptionClick(e, element);\n        } else if (action === \"delete\") {\n            _handleDeleteOptionClick(e, element);\n        } else if (action === \"ai\") {\n            _handleAIOptionClick(e, element);\n        }\n    }\n\n    function _dragStartChores(element) {\n        element._originalDragOpacity = element.style.opacity;\n        element.style.opacity = 0.4;\n    }\n\n\n    function _dragEndChores(element) {\n        if (element._originalDragOpacity) {\n            element.style.opacity = element._originalDragOpacity;\n        } else {\n            element.style.opacity = 1;\n        }\n        delete element._originalDragOpacity;\n    }\n\n    // CSS class names for drop markers\n    let DROP_MARKER_CLASSNAME = \"__brackets-drop-marker-horizontal\";\n    let DROP_MARKER_VERTICAL_CLASSNAME = \"__brackets-drop-marker-vertical\";\n    let DROP_MARKER_INSIDE_CLASSNAME = \"__brackets-drop-marker-inside\";\n\n    /**\n     * This function is responsible to determine whether to show vertical/horizontal indicators\n     *\n     * @param {DOMElement} element - the target element\n     * @returns {String} 'vertical' or 'horizontal'\n     */\n    function _getIndicatorType(element) {\n        // we need to check the parent element's property if its a flex container\n        const parent = element.parentElement;\n        if (!parent) {\n            return 'horizontal';\n        }\n\n        const parentStyle = window.getComputedStyle(parent);\n        const display = parentStyle.display;\n        const flexDirection = parentStyle.flexDirection;\n\n        if ((display === \"flex\" || display === \"inline-flex\") && flexDirection.startsWith(\"row\")) {\n            return \"vertical\";\n        }\n\n        // default is horizontal\n        return 'horizontal';\n    }\n\n    /**\n     * this function is to determine if an element can accept children (inside drops)\n     *\n     * @param {DOMElement} element - The target element\n     * @returns {Boolean} true if element can accept children\n     */\n    function _canAcceptChildren(element) {\n        // self-closing elements, cannot have children\n        const voidElements = [\n            \"IMG\",\n            \"BR\",\n            \"HR\",\n            \"INPUT\",\n            \"META\",\n            \"LINK\",\n            \"AREA\",\n            \"BASE\",\n            \"COL\",\n            \"EMBED\",\n            \"SOURCE\",\n            \"TRACK\",\n            \"WBR\"\n        ];\n\n        // Elements that shouldn't accept visual children\n        const nonContainerElements = [\n            \"SCRIPT\", \"STYLE\", \"NOSCRIPT\", \"CANVAS\", \"SVG\", \"VIDEO\", \"AUDIO\", \"IFRAME\", \"OBJECT\"\n        ];\n\n        const tagName = element.tagName.toUpperCase();\n\n        if (voidElements.includes(tagName) || nonContainerElements.includes(tagName)) {\n            return false;\n        }\n\n        return true;\n    }\n\n    /**\n     * it is to check if a source element can be placed inside a target element according to HTML rules\n     *\n     * @param {DOMElement} sourceElement - The element being dragged\n     * @param {DOMElement} targetElement - The target container element\n     * @returns {Boolean} true if the nesting is valid\n     */\n    function _isValidNesting(sourceElement, targetElement) {\n        const sourceTag = sourceElement.tagName.toUpperCase();\n        const targetTag = targetElement.tagName.toUpperCase();\n\n        // block elements, cannot come inside inline elements\n        const blockElements = [\n            \"DIV\",\n            \"P\",\n            \"H1\",\n            \"H2\",\n            \"H3\",\n            \"H4\",\n            \"H5\",\n            \"H6\",\n            \"SECTION\",\n            \"ARTICLE\",\n            \"HEADER\",\n            \"FOOTER\",\n            \"NAV\",\n            \"ASIDE\",\n            \"MAIN\",\n            \"BLOCKQUOTE\",\n            \"PRE\",\n            \"TABLE\",\n            \"UL\",\n            \"OL\",\n            \"LI\",\n            \"DL\",\n            \"DT\",\n            \"DD\",\n            \"FORM\",\n            \"FIELDSET\",\n            \"ADDRESS\",\n            \"FIGURE\",\n            \"FIGCAPTION\",\n            \"DETAILS\",\n            \"SUMMARY\"\n        ];\n\n        // inline elements that can't contain block elements\n        const inlineElements = [\n            \"SPAN\",\n            \"A\",\n            \"STRONG\",\n            \"EM\",\n            \"B\",\n            \"I\",\n            \"U\",\n            \"SMALL\",\n            \"CODE\",\n            \"KBD\",\n            \"SAMP\",\n            \"VAR\",\n            \"SUB\",\n            \"SUP\",\n            \"MARK\",\n            \"DEL\",\n            \"INS\",\n            \"Q\",\n            \"CITE\",\n            \"ABBR\",\n            \"TIME\",\n            \"DATA\",\n            \"OUTPUT\"\n        ];\n\n        // interactive elements that can't be nested inside each other\n        const interactiveElements = [\n            \"A\",\n            \"BUTTON\",\n            \"INPUT\",\n            \"SELECT\",\n            \"TEXTAREA\",\n            \"LABEL\",\n            \"DETAILS\",\n            \"SUMMARY\",\n            \"AUDIO\",\n            \"VIDEO\",\n            \"EMBED\",\n            \"IFRAME\",\n            \"OBJECT\"\n        ];\n\n        // Sectioning content - semantic HTML5 sections\n        const sectioningContent = [\"ARTICLE\", \"ASIDE\", \"NAV\", \"SECTION\"];\n\n        // Elements that can't contain themselves (prevent nesting)\n        const noSelfNesting = [\n            \"P\",\n            \"A\",\n            \"BUTTON\",\n            \"LABEL\",\n            \"FORM\",\n            \"HEADER\",\n            \"FOOTER\",\n            \"NAV\",\n            \"MAIN\",\n            \"ASIDE\",\n            \"SECTION\",\n            \"ARTICLE\",\n            \"ADDRESS\",\n            \"H1\",\n            \"H2\",\n            \"H3\",\n            \"H4\",\n            \"H5\",\n            \"H6\",\n            \"FIGURE\",\n            \"FIGCAPTION\",\n            \"DETAILS\",\n            \"SUMMARY\"\n        ];\n\n        // Special cases - elements that have specific content restrictions\n        const restrictedContainers = {\n            // List elements\n            UL: [\"LI\"],\n            OL: [\"LI\"],\n            DL: [\"DT\", \"DD\"],\n\n            // Table elements\n            TABLE: [\"THEAD\", \"TBODY\", \"TFOOT\", \"TR\", \"CAPTION\", \"COLGROUP\"],\n            THEAD: [\"TR\"],\n            TBODY: [\"TR\"],\n            TFOOT: [\"TR\"],\n            TR: [\"TD\", \"TH\"],\n            COLGROUP: [\"COL\"],\n\n            // Form elements\n            SELECT: [\"OPTION\", \"OPTGROUP\"],\n            OPTGROUP: [\"OPTION\"],\n            DATALIST: [\"OPTION\"],\n\n            // Media elements\n            PICTURE: [\"SOURCE\", \"IMG\"],\n            AUDIO: [\"SOURCE\", \"TRACK\"],\n            VIDEO: [\"SOURCE\", \"TRACK\"],\n\n            // Other specific containers\n            FIGURE: [\"FIGCAPTION\", \"DIV\", \"P\", \"IMG\", \"CANVAS\", \"SVG\", \"TABLE\", \"PRE\", \"CODE\"],\n            DETAILS: [\"SUMMARY\"] // SUMMARY should be the first child\n        };\n\n        // 1. Check self-nesting (elements that can't contain themselves)\n        if (noSelfNesting.includes(sourceTag) && sourceTag === targetTag) {\n            return false;\n        }\n\n        // 2. Check block elements inside inline elements\n        if (blockElements.includes(sourceTag) && inlineElements.includes(targetTag)) {\n            return false;\n        }\n\n        // 3. Check restricted containers (strict parent-child relationships)\n        if (restrictedContainers[targetTag]) {\n            return restrictedContainers[targetTag].includes(sourceTag);\n        }\n\n        // 4. Special case: P tags can't contain block elements (phrasing content only)\n        if (targetTag === \"P\" && blockElements.includes(sourceTag)) {\n            return false;\n        }\n\n        // 5. Interactive elements can't contain other interactive elements\n        if (interactiveElements.includes(targetTag) && interactiveElements.includes(sourceTag)) {\n            return false;\n        }\n\n        // 6. Semantic HTML5 sectioning rules\n        if (targetTag === \"HEADER\") {\n            // Header can't contain other headers, footers, or main\n            if ([\"HEADER\", \"FOOTER\", \"MAIN\"].includes(sourceTag)) {\n                return false;\n            }\n        }\n\n        if (targetTag === \"FOOTER\") {\n            // Footer can't contain headers, footers, or main\n            if ([\"HEADER\", \"FOOTER\", \"MAIN\"].includes(sourceTag)) {\n                return false;\n            }\n        }\n\n        if (targetTag === \"MAIN\") {\n            // Main can't contain other mains\n            if (sourceTag === \"MAIN\") {\n                return false;\n            }\n        }\n\n        if (targetTag === \"ADDRESS\") {\n            // Address can't contain sectioning content, headers, footers, or address\n            if (sectioningContent.includes(sourceTag) || [\"HEADER\", \"FOOTER\", \"ADDRESS\", \"MAIN\"].includes(sourceTag)) {\n                return false;\n            }\n        }\n\n        // 7. Form-related validation\n        if (targetTag === \"FORM\") {\n            // Form can't contain other forms\n            if (sourceTag === \"FORM\") {\n                return false;\n            }\n        }\n\n        if (targetTag === \"FIELDSET\") {\n            // Fieldset should have legend as first child (but we'll allow it anywhere for flexibility)\n            // No specific restrictions beyond normal content\n        }\n\n        if (targetTag === \"LABEL\") {\n            // Label can't contain other labels or form controls (except one input)\n            if ([\"LABEL\", \"BUTTON\", \"SELECT\", \"TEXTAREA\"].includes(sourceTag)) {\n                return false;\n            }\n        }\n\n        // 8. Heading hierarchy validation (optional - can be strict or flexible)\n        if ([\"H1\", \"H2\", \"H3\", \"H4\", \"H5\", \"H6\"].includes(targetTag)) {\n            // Headings can't contain block elements (should only contain phrasing content)\n            if (blockElements.includes(sourceTag)) {\n                return false;\n            }\n        }\n\n        // 9. List item specific rules\n        if (sourceTag === \"LI\") {\n            // LI can only be inside UL, OL, or MENU\n            if (![\"UL\", \"OL\", \"MENU\"].includes(targetTag)) {\n                return false;\n            }\n        }\n\n        if ([\"DT\", \"DD\"].includes(sourceTag)) {\n            // DT and DD can only be inside DL\n            if (targetTag !== \"DL\") {\n                return false;\n            }\n        }\n\n        // 10. Table-related validation\n        if ([\"THEAD\", \"TBODY\", \"TFOOT\"].includes(sourceTag)) {\n            if (targetTag !== \"TABLE\") {\n                return false;\n            }\n        }\n\n        if (sourceTag === \"TR\") {\n            if (![\"TABLE\", \"THEAD\", \"TBODY\", \"TFOOT\"].includes(targetTag)) {\n                return false;\n            }\n        }\n\n        if ([\"TD\", \"TH\"].includes(sourceTag)) {\n            if (targetTag !== \"TR\") {\n                return false;\n            }\n        }\n\n        if (sourceTag === \"CAPTION\") {\n            if (targetTag !== \"TABLE\") {\n                return false;\n            }\n        }\n\n        // 11. Media and embedded content\n        if ([\"SOURCE\", \"TRACK\"].includes(sourceTag)) {\n            if (![\"AUDIO\", \"VIDEO\", \"PICTURE\"].includes(targetTag)) {\n                return false;\n            }\n        }\n\n        // 12. Ruby annotation elements (if supported)\n        if ([\"RP\", \"RT\"].includes(sourceTag)) {\n            if (targetTag !== \"RUBY\") {\n                return false;\n            }\n        }\n\n        // 13. Option elements\n        if (sourceTag === \"OPTION\") {\n            if (![\"SELECT\", \"OPTGROUP\", \"DATALIST\"].includes(targetTag)) {\n                return false;\n            }\n        }\n\n        return true;\n    }\n\n    /**\n     * this function determines the drop zone based on cursor position relative to element\n     *\n     * @param {DOMElement} element - The target element\n     * @param {Number} clientX - x pos\n     * @param {Number} clientY - y pos\n     * @param {String} indicatorType - 'vertical' or 'horizontal'\n     * @param {DOMElement} sourceElement - The element being dragged (for validation)\n     * @returns {String} 'before', 'inside', or 'after'\n     */\n    function _getDropZone(element, clientX, clientY, indicatorType, sourceElement) {\n        const rect = element.getBoundingClientRect();\n        const canAcceptChildren = _canAcceptChildren(element);\n        const isValidNesting = sourceElement ? _isValidNesting(sourceElement, element) : true;\n\n        if (indicatorType === \"vertical\") {\n            const leftThird = rect.left + rect.width * 0.3;\n            const rightThird = rect.right - rect.width * 0.3;\n\n            if (clientX < leftThird) {\n                return \"before\";\n            } else if (clientX > rightThird) {\n                return \"after\";\n            } else if (canAcceptChildren && isValidNesting) {\n                return \"inside\";\n            }\n            // If can't accept children or invalid nesting, use middle as \"after\"\n            return clientX < rect.left + rect.width / 2 ? \"before\" : \"after\";\n        }\n\n        const topThird = rect.top + rect.height * 0.3;\n        const bottomThird = rect.bottom - rect.height * 0.3;\n\n        if (clientY < topThird) {\n            return \"before\";\n        } else if (clientY > bottomThird) {\n            return \"after\";\n        } else if (canAcceptChildren && isValidNesting) {\n            return \"inside\";\n        }\n        // If can't accept children or invalid nesting, use middle as \"after\"\n        return clientY < rect.top + rect.height / 2 ? \"before\" : \"after\";\n    }\n\n    /**\n     * this is to create a marker to indicate a valid drop position\n     *\n     * @param {DOMElement} element - The element where the drop is possible\n     * @param {String} dropZone - 'before', 'inside', or 'after'\n     * @param {String} indicatorType - 'vertical' or 'horizontal'\n     */\n    function _createDropMarker(element, dropZone, indicatorType = \"horizontal\") {\n        // clean any existing marker from that element\n        _removeDropMarkerFromElement(element);\n\n        // create the marker element\n        let marker = window.document.createElement(\"div\");\n\n        // Set marker class based on drop zone\n        if (dropZone === \"inside\") {\n            marker.className = DROP_MARKER_INSIDE_CLASSNAME;\n        } else {\n            marker.className = indicatorType === \"vertical\" ? DROP_MARKER_VERTICAL_CLASSNAME : DROP_MARKER_CLASSNAME;\n        }\n\n        let rect = element.getBoundingClientRect();\n        marker.style.position = \"fixed\";\n        marker.style.zIndex = \"2147483647\";\n        marker.style.borderRadius = \"2px\";\n        marker.style.pointerEvents = \"none\";\n\n        if (dropZone === \"inside\") {\n            // inside marker - outline around the element\n            marker.style.border = \"2px dashed #4285F4\";\n            marker.style.backgroundColor = \"rgba(66, 133, 244, 0.05)\";\n            marker.style.left = rect.left + \"px\";\n            marker.style.top = rect.top + \"px\";\n            marker.style.width = rect.width + \"px\";\n            marker.style.height = rect.height + \"px\";\n            marker.style.animation = \"insideMarkerPulse 1s ease-in-out infinite alternate\";\n        } else {\n            // Before/After markers - lines\n            marker.style.background = \"linear-gradient(90deg, #4285F4, #1976D2)\";\n            marker.style.boxShadow = \"0 0 8px rgba(66, 133, 244, 0.5)\";\n            marker.style.animation = \"dropMarkerPulse 0.8s ease-in-out infinite alternate\";\n\n            if (indicatorType === \"vertical\") {\n                // Vertical marker (for flex row containers)\n                marker.style.width = \"3px\";\n                marker.style.height = rect.height + \"px\";\n                marker.style.top = rect.top + \"px\";\n\n                if (dropZone === \"after\") {\n                    marker.style.left = rect.right + 3 + \"px\";\n                } else {\n                    marker.style.left = rect.left - 5 + \"px\";\n                }\n            } else {\n                // Horizontal marker (for block/grid containers)\n                marker.style.width = rect.width + \"px\";\n                marker.style.height = \"3px\";\n                marker.style.left = rect.left + \"px\";\n\n                if (dropZone === \"after\") {\n                    marker.style.top = rect.bottom + 3 + \"px\";\n                } else {\n                    marker.style.top = rect.top - 5 + \"px\";\n                }\n            }\n        }\n\n        element._dropMarker = marker; // we need this in the _removeDropMarkerFromElement function\n        window.document.body.appendChild(marker);\n    }\n\n    /**\n     * This function removes a drop marker from a specific element\n     * @param {DOMElement} element - The element to remove the marker from\n     */\n    function _removeDropMarkerFromElement(element) {\n        if (element._dropMarker && element._dropMarker.parentNode) {\n            element._dropMarker.parentNode.removeChild(element._dropMarker);\n            delete element._dropMarker;\n        }\n    }\n\n    /**\n     * this function is to clear all the drop markers from the document\n     */\n    function _clearDropMarkers() {\n        // Clear all types of markers\n        let horizontalMarkers = window.document.querySelectorAll(\".\" + DROP_MARKER_CLASSNAME);\n        let verticalMarkers = window.document.querySelectorAll(\".\" + DROP_MARKER_VERTICAL_CLASSNAME);\n        let insideMarkers = window.document.querySelectorAll(\".\" + DROP_MARKER_INSIDE_CLASSNAME);\n\n        for (let i = 0; i < horizontalMarkers.length; i++) {\n            if (horizontalMarkers[i].parentNode) {\n                horizontalMarkers[i].parentNode.removeChild(horizontalMarkers[i]);\n            }\n        }\n\n        for (let i = 0; i < verticalMarkers.length; i++) {\n            if (verticalMarkers[i].parentNode) {\n                verticalMarkers[i].parentNode.removeChild(verticalMarkers[i]);\n            }\n        }\n\n        for (let i = 0; i < insideMarkers.length; i++) {\n            if (insideMarkers[i].parentNode) {\n                insideMarkers[i].parentNode.removeChild(insideMarkers[i]);\n            }\n        }\n\n        // Also clear any element references\n        let elements = window.document.querySelectorAll(\"[data-brackets-id]\");\n        for (let j = 0; j < elements.length; j++) {\n            delete elements[j]._dropMarker;\n            // only restore the styles that were modified by drag operations\n            if (elements[j]._originalDragBackgroundColor !== undefined) {\n                elements[j].style.backgroundColor = elements[j]._originalDragBackgroundColor;\n                delete elements[j]._originalDragBackgroundColor;\n            }\n            if (elements[j]._originalDragTransform !== undefined) {\n                elements[j].style.transform = elements[j]._originalDragTransform;\n                delete elements[j]._originalDragTransform;\n            }\n            if (elements[j]._originalDragTransition !== undefined) {\n                elements[j].style.transition = elements[j]._originalDragTransition;\n                delete elements[j]._originalDragTransition;\n            }\n        }\n    }\n\n    /**\n     * Find the nearest valid drop target when direct elementFromPoint fails\n     * @param {number} clientX - x coordinate\n     * @param {number} clientY - y coordinate\n     * @returns {Element|null} - nearest valid target or null\n     */\n    function _findNearestValidTarget(clientX, clientY) {\n        const searchRadius = 500;\n        const step = 10; // pixel step for search\n\n        // Search in expanding squares around the cursor position\n        for (let radius = step; radius <= searchRadius; radius += step) {\n            // Check points in a square pattern around the cursor\n            const points = [\n                [clientX + radius, clientY],\n                [clientX - radius, clientY],\n                [clientX, clientY + radius],\n                [clientX, clientY - radius],\n                [clientX + radius, clientY + radius],\n                [clientX - radius, clientY - radius],\n                [clientX + radius, clientY - radius],\n                [clientX - radius, clientY + radius]\n            ];\n\n            for (let point of points) {\n                const [x, y] = point;\n                let target = document.elementFromPoint(x, y);\n\n                if (!target || target === window._currentDraggedElement) {\n                    continue;\n                }\n\n                // Find closest element with data-brackets-id\n                while (target && !target.hasAttribute(\"data-brackets-id\")) {\n                    target = target.parentElement;\n                }\n\n                // Check if target is valid (not BODY, HTML or inside HEAD)\n                if (isElementEditable(target) && target !== window._currentDraggedElement) {\n                    return target;\n                }\n            }\n        }\n        return null;\n    }\n\n    /**\n     * Handle dragover events on the document (throttled version)\n     * Shows drop markers on valid drop targets\n     * @param {Event} event - The dragover event\n     */\n    function onDragOver(event) {\n        // we set this on dragStart\n        if (!window._currentDraggedElement) {\n            return;\n        }\n\n        event.preventDefault();\n\n        // get the element under the cursor\n        let target = document.elementFromPoint(event.clientX, event.clientY);\n        if (!target || target === window._currentDraggedElement) {\n            return;\n        }\n\n        // get the closest element with a data-brackets-id\n        while (target && !target.hasAttribute(\"data-brackets-id\")) {\n            target = target.parentElement;\n        }\n\n        if (!isElementEditable(target) || target === window._currentDraggedElement) {\n            // if direct detection fails, we try to find a nearby valid target\n            target = _findNearestValidTarget(event.clientX, event.clientY);\n            if (!target) {\n                return;\n            }\n        }\n\n        // Store original styles before modifying them\n        if (target._originalDragBackgroundColor === undefined) {\n            target._originalDragBackgroundColor = target.style.backgroundColor;\n        }\n        if (target._originalDragTransition === undefined) {\n            target._originalDragTransition = target.style.transition;\n        }\n\n        // Add subtle hover effect to target element\n        target.style.backgroundColor = \"rgba(66, 133, 244, 0.1)\";\n        target.style.transition = \"background-color 0.2s ease\";\n\n        // Determine indicator type and drop zone based on container layout and cursor position\n        const indicatorType = _getIndicatorType(target);\n        const dropZone = _getDropZone(\n            target, event.clientX, event.clientY, indicatorType, window._currentDraggedElement\n        );\n\n        // before creating a drop marker, make sure that we clear all the drop markers\n        _clearDropMarkers();\n        _createDropMarker(target, dropZone, indicatorType);\n        _handleAutoScroll(event.clientY);\n    }\n\n    /**\n     * handles drag leave event. mainly to clear the drop markers\n     * @param {Event} event\n     */\n    function onDragLeave(event) {\n        if (!event.relatedTarget) {\n            _clearDropMarkers();\n            _stopAutoScroll();\n        }\n    }\n\n    /**\n     * Handle drop events on the document\n     * Processes the drop of a dragged element onto a valid target\n     * @param {Event} event - The drop event\n     */\n    function onDrop(event) {\n        if (!window._currentDraggedElement) {\n            return;\n        }\n\n        event.preventDefault();\n        event.stopPropagation();\n\n        // get the element under the cursor\n        let target = document.elementFromPoint(event.clientX, event.clientY);\n\n        // get the closest element with a data-brackets-id\n        while (target && !target.hasAttribute(\"data-brackets-id\")) {\n            target = target.parentElement;\n        }\n\n        if (!isElementEditable(target) || target === window._currentDraggedElement) {\n            // if direct detection fails, we try to find a nearby valid target\n            target = _findNearestValidTarget(event.clientX, event.clientY);\n        }\n\n        // skip if no valid target found or if it's the dragged element\n        if (!isElementEditable(target) || target === window._currentDraggedElement) {\n            _clearDropMarkers();\n            _stopAutoScroll();\n            _dragEndChores(window._currentDraggedElement);\n            dismissUIAndCleanupState();\n            delete window._currentDraggedElement;\n            return;\n        }\n\n        // Determine drop position based on container layout and cursor position\n        const indicatorType = _getIndicatorType(target);\n        const dropZone = _getDropZone(\n            target, event.clientX, event.clientY, indicatorType, window._currentDraggedElement\n        );\n\n        // IDs of the source and target elements\n        const sourceId = window._currentDraggedElement.getAttribute(\"data-brackets-id\");\n        const targetId = target.getAttribute(\"data-brackets-id\");\n\n        // Handle different drop zones\n        let messageData = {\n            livePreviewEditEnabled: true,\n            sourceElement: window._currentDraggedElement,\n            targetElement: target,\n            sourceId: Number(sourceId),\n            targetId: Number(targetId),\n            move: true\n        };\n\n        if (dropZone === \"inside\") {\n            // For inside drops, we want to insert as a child of the target element\n            messageData.insertInside = true;\n            messageData.insertAfter = false; // Will be handled differently in backend\n        } else {\n            // For before/after drops, use the existing logic\n            messageData.insertAfter = dropZone === \"after\";\n        }\n\n        // send message to the editor\n        window._Brackets_MessageBroker.send(messageData);\n\n        _clearDropMarkers();\n        _stopAutoScroll();\n        _dragEndChores(window._currentDraggedElement);\n        dismissUIAndCleanupState();\n        delete window._currentDraggedElement;\n    }\n\n    /**\n     * this function is to check if an element should show the edit text option\n     * it is needed because edit text option doesn't make sense with many elements like images, videos, hr tag etc\n     * @param {Element} element - DOM element to check\n     * @returns {boolean} - true if we should show the edit text option otherwise false\n     */\n    function _shouldShowEditTextOption(element) {\n        if (!element || !element.tagName) {\n            return false;\n        }\n\n        const tagName = element.tagName.toLowerCase();\n\n        // these are self-closing tags and don't allow any text content\n        const voidElements = [\n            \"img\",\n            \"br\",\n            \"hr\",\n            \"input\",\n            \"meta\",\n            \"link\",\n            \"area\",\n            \"base\",\n            \"col\",\n            \"embed\",\n            \"source\",\n            \"track\",\n            \"wbr\"\n        ];\n\n        // these elements are non-editable as they have their own mechanisms\n        const nonEditableElements = [\n            \"script\",\n            \"style\",\n            \"noscript\",\n            \"canvas\",\n            \"svg\",\n            \"video\",\n            \"audio\",\n            \"iframe\",\n            \"object\",\n            \"select\",\n            \"textarea\"\n        ];\n\n        if (voidElements.includes(tagName) || nonEditableElements.includes(tagName)) {\n            return false;\n        }\n\n        return true;\n    }\n\n    /**\n     * this function is to check if an element should show the 'select-parent' option\n     * because we don't want to show the select parent option when the parent is directly the body/html tag\n     * or the parent doesn't have the 'data-brackets-id'\n     * @param {Element} element - DOM element to check\n     * @returns {boolean} - true if we should show the select parent option otherwise false\n     */\n    function _shouldShowSelectParentOption(element) {\n        if(!isElementEditable(element)) {\n            return false;\n        }\n\n        const parentElement = element.parentElement;\n        if(!isElementEditable(parentElement)) {\n            return false;\n        }\n        return true;\n    }\n\n    /**\n     * This is for the advanced DOM options that appears when a DOM element is clicked\n     * advanced options like: 'select parent', 'duplicate', 'delete'\n     */\n    function NodeMoreOptionsBox(element) {\n        this.element = element;\n        this.remove = this.remove.bind(this);\n        this.create();\n    }\n\n    NodeMoreOptionsBox.prototype = {\n        _registerDragDrop: function() {\n            // disable dragging on all elements and then enable it on the current element\n            const allElements = document.querySelectorAll('[data-brackets-id]');\n            allElements.forEach(el => el.setAttribute(\"draggable\", false));\n            this.element.setAttribute(\"draggable\", true);\n\n            this.element.addEventListener(\"dragstart\", (event) => {\n                event.stopPropagation();\n                event.dataTransfer.setData(\"text/plain\", this.element.getAttribute(\"data-brackets-id\"));\n                _dragStartChores(this.element);\n                _clearDropMarkers();\n                window._currentDraggedElement = this.element;\n                dismissUIAndCleanupState();\n                dismissImageRibbonGallery();\n                // Add drag image styling\n                event.dataTransfer.effectAllowed = \"move\";\n            });\n\n            this.element.addEventListener(\"dragend\", (event) => {\n                event.preventDefault();\n                event.stopPropagation();\n                _dragEndChores(this.element);\n                _clearDropMarkers();\n                _stopAutoScroll();\n                delete window._currentDraggedElement;\n            });\n        },\n\n        _getBoxPosition: function(boxWidth, boxHeight) {\n            const elemBounds = this.element.getBoundingClientRect();\n            const offset = _screenOffset(this.element);\n\n            let topPos = offset.top - boxHeight - 6; // 6 for just some little space to breathe\n            let leftPos = offset.left + elemBounds.width - boxWidth;\n\n            // Check if the box would go off the top of the viewport\n            if (elemBounds.top - boxHeight < 6) {\n                topPos = offset.top + elemBounds.height + 6;\n            }\n\n            // Check if the box would go off the left of the viewport\n            if (leftPos < 0) {\n                leftPos = offset.left;\n            }\n\n            return {topPos: topPos, leftPos: leftPos};\n        },\n\n        _style: function() {\n            this.body = window.document.createElement(\"div\");\n\n            // this is shadow DOM.\n            // we need it because if we add the box directly to the DOM then users style might override it.\n            // {mode: \"open\"} allows us to access the shadow DOM to get actual height/position of the boxes\n            const shadow = this.body.attachShadow({ mode: \"open\" });\n\n            // check which options should be shown to determine box width\n            const showEditTextOption = _shouldShowEditTextOption(this.element);\n            const showSelectParentOption = _shouldShowSelectParentOption(this.element);\n\n            // the icons that is displayed in the box\n            const ICONS = {\n                ai: `\n                <svg xmlns=\"http://www.w3.org/2000/svg\" x=\"0px\" y=\"0px\" width=\"100\" height=\"100\" viewBox=\"0,0,256,256\">\n                    <g fill=\"#fffbfb\" fill-rule=\"nonzero\" stroke=\"none\" stroke-width=\"1\" stroke-linecap=\"butt\" stroke-linejoin=\"miter\" stroke-miterlimit=\"10\" stroke-dasharray=\"\" stroke-dashoffset=\"0\" font-family=\"none\" font-weight=\"none\" font-size=\"none\" text-anchor=\"none\" style=\"mix-blend-mode: normal\"><g transform=\"scale(4,4)\"><path d=\"M30.701,41.663l-2.246,5.145c-0.864,1.978 -3.6,1.978 -4.464,0l-2.247,-5.145c-1.999,-4.579 -5.598,-8.224 -10.086,-10.216l-6.183,-2.745c-1.966,-0.873 -1.966,-3.733 0,-4.605l5.99,-2.659c4.604,-2.044 8.267,-5.824 10.232,-10.559l2.276,-5.483c0.844,-2.035 3.656,-2.035 4.5,0l2.276,5.483c1.965,4.735 5.628,8.515 10.232,10.559l5.99,2.659c1.966,0.873 1.966,3.733 0,4.605l-6.183,2.745c-4.489,1.992 -8.088,5.637 -10.087,10.216z\"></path><path d=\"M30.701,41.663l-2.246,5.145c-0.864,1.978 -3.6,1.978 -4.464,0l-2.247,-5.145c-1.999,-4.579 -5.598,-8.224 -10.086,-10.216l-6.183,-2.745c-1.966,-0.873 -1.966,-3.733 0,-4.605l5.99,-2.659c4.604,-2.044 8.267,-5.824 10.232,-10.559l2.276,-5.483c0.844,-2.035 3.656,-2.035 4.5,0l2.276,5.483c1.965,4.735 5.628,8.515 10.232,10.559l5.99,2.659c1.966,0.873 1.966,3.733 0,4.605l-6.183,2.745c-4.489,1.992 -8.088,5.637 -10.087,10.216z\"></path><g><path d=\"M51.578,57.887l-0.632,1.448c-0.462,1.06 -1.93,1.06 -2.393,0l-0.632,-1.448c-1.126,-2.582 -3.155,-4.637 -5.686,-5.762l-1.946,-0.865c-1.052,-0.468 -1.052,-1.998 0,-2.465l1.838,-0.816c2.596,-1.153 4.661,-3.285 5.768,-5.955l0.649,-1.565c0.452,-1.091 1.96,-1.091 2.412,0l0.649,1.565c1.107,2.669 3.172,4.801 5.768,5.955l1.837,0.816c1.053,0.468 1.053,1.998 0,2.465l-1.946,0.865c-2.531,1.125 -4.56,3.18 -5.686,5.762z\"></path><path d=\"M51.578,57.887l-0.632,1.448c-0.462,1.06 -1.93,1.06 -2.393,0l-0.632,-1.448c-1.126,-2.582 -3.155,-4.637 -5.686,-5.762l-1.946,-0.865c-1.052,-0.468 -1.052,-1.998 0,-2.465l1.838,-0.816c2.596,-1.153 4.661,-3.285 5.768,-5.955l0.649,-1.565c0.452,-1.091 1.96,-1.091 2.412,0l0.649,1.565c1.107,2.669 3.172,4.801 5.768,5.955l1.837,0.816c1.053,0.468 1.053,1.998 0,2.465l-1.946,0.865c-2.531,1.125 -4.56,3.18 -5.686,5.762z\"></path></g></g></g>\n                </svg>\n                `,\n\n                arrowUp: `\n                <svg viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                  <path d=\"M4 12l1.41 1.41L11 7.83V20h2V7.83l5.59 5.58L20 12l-8-8-8 8z\"/>\n                </svg>\n              `,\n\n                edit: `\n                <svg viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                  <path d=\"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z\"/>\n                </svg>\n              `,\n\n                duplicate: `\n                <svg viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                  <path d=\"M18 3H4C3.44772 3 3 3.44772 3 4V18C3 18.5523 2.55228 19 2 19C1.44772 19 1 18.5523 1 18V4C1 2.34315 2.34315 1 4 1H18C18.5523 1 19 1.44772 19 2C19 2.55228 18.5523 3 18 3Z\"/>\n                  <path d=\"M13 11C13 10.4477 13.4477 10 14 10C14.5523 10 15 10.4477 15 11V13H17C17.5523 13 18 13.4477 18 14C18 14.5523 17.5523 15 17 15H15V17C15 17.5523 14.5523 18 14 18C13.4477 18 13 17.5523 13 17V15H11C10.4477 15 10 14.5523 10 14C10 13.4477 10.4477 13 11 13H13V11Z\"/>\n                  <path fill-rule=\"evenodd\" clip-rule=\"evenodd\" d=\"M20 5C21.6569 5 23 6.34315 23 8V20C23 21.6569 21.6569 23 20 23H8C6.34315 23 5 21.6569 5 20V8C5 6.34315 6.34315 5 8 5H20ZM20 7C20.5523 7 21 7.44772 21 8V20C21 20.5523 20.5523 21 20 21H8C7.44772 21 7 20.5523 7 20V8C7 7.44772 7.44772 7 8 7H20Z\"/>\n                </svg>\n              `,\n\n                trash: `\n                <svg viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                  <path d=\"M6 7V5a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v2h3v2h-2l-1.5 12.5a2 2 0 0\n                  1-2 1.5H8.5a2 2 0 0 1-2-1.5L5 9H3V7h3zm2 0h8V5H8v2z\"/>\n                </svg>\n              `\n            };\n\n            let content = `<div class=\"node-options\">`;\n\n            // not sure if we need to hide/show the AI icon, right now showing always\n            content += `<span data-action=\"ai\" title=\"${config.strings.ai}\">\n                    ${ICONS.ai}\n                </span>`;\n\n            // Only include select parent option if element supports it\n            if (showSelectParentOption) {\n                content += `<span data-action=\"select-parent\" title=\"${config.strings.selectParent}\">\n                    ${ICONS.arrowUp}\n                </span>`;\n            }\n\n            // Only include edit text option if element supports it\n            if (showEditTextOption) {\n                content += `<span data-action=\"edit-text\" title=\"${config.strings.editText}\">\n                    ${ICONS.edit}\n                </span>`;\n            }\n\n            // Always include duplicate and delete options\n            content += `<span data-action=\"duplicate\" title=\"${config.strings.duplicate}\">\n                    ${ICONS.duplicate}\n                </span>\n                <span data-action=\"delete\" title=\"${config.strings.delete}\">\n                    ${ICONS.trash}\n                </span>\n            </div>`;\n\n            const styles = `\n                :host {\n                  all: initial !important;\n                }\n\n                .phoenix-more-options-box {\n                    background-color: #4285F4 !important;\n                    color: white !important;\n                    border-radius: 3px !important;\n                    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2) !important;\n                    font-size: 12px !important;\n                    font-family: Arial, sans-serif !important;\n                    z-index: 2147483647 !important;\n                    position: absolute !important;\n                    left: -1000px;\n                    top: -1000px;\n                    box-sizing: border-box !important;\n                }\n\n                .node-options {\n                    display: flex !important;\n                    align-items: center !important;\n                }\n\n                .node-options span {\n                    padding: 4px 3.9px !important;\n                    cursor: pointer !important;\n                    display: flex !important;\n                    align-items: center !important;\n                    border-radius: 0 !important;\n                }\n\n                .node-options span:first-child {\n                    border-radius: 3px 0 0 3px !important;\n                }\n\n                .node-options span:last-child {\n                    border-radius: 0 3px 3px 0 !important;\n                }\n\n                .node-options span:hover {\n                    background-color: rgba(255, 255, 255, 0.15) !important;\n                }\n\n                .node-options span > svg {\n                    width: 16px !important;\n                    height: 16px !important;\n                    display: block !important;\n                }\n            `;\n\n            // add everything to the shadow box\n            shadow.innerHTML = `<style>${styles}</style><div class=\"phoenix-more-options-box\">${content}</div>`;\n            this._shadow = shadow;\n        },\n\n        create: function() {\n            this.remove(); // remove existing box if already present\n\n            if(!config.isProUser) {\n                return;\n            }\n\n            // this check because when there is no element visible to the user, we don't want to show the box\n            // for ex: when user clicks on a 'x' button and the button is responsible to hide a panel\n            // then clicking on that button shouldn't show the more options box\n            // also covers cases where elements are inside closed/collapsed menus\n            if(!isElementVisible(this.element)) {\n                return;\n            }\n\n            this._style(); // style the box\n\n            window.document.body.appendChild(this.body);\n\n            // get the actual rendered dimensions of the box and then we reposition it to the actual place\n            const boxElement = this._shadow.querySelector('.phoenix-more-options-box');\n            if (boxElement) {\n                const boxRect = boxElement.getBoundingClientRect();\n                const pos = this._getBoxPosition(boxRect.width, boxRect.height);\n\n                boxElement.style.left = pos.leftPos + 'px';\n                boxElement.style.top = pos.topPos + 'px';\n            }\n\n            // add click handler to all the buttons\n            const spans = this._shadow.querySelectorAll('.node-options span');\n            spans.forEach(span => {\n                span.addEventListener('click', (event) => {\n                    event.stopPropagation();\n                    event.preventDefault();\n                    // data-action is to differentiate between the buttons (duplicate, delete or select-parent)\n                    const action = event.currentTarget.getAttribute('data-action');\n                    handleOptionClick(event, action, this.element);\n                    if (action !== 'duplicate') {\n                        this.remove();\n                    }\n                });\n            });\n\n            this._registerDragDrop();\n        },\n\n        remove: function() {\n            if (this.body && this.body.parentNode && this.body.parentNode === window.document.body) {\n                window.document.body.removeChild(this.body);\n                this.body = null;\n                _nodeMoreOptionsBox = null;\n            }\n        }\n    };\n\n    // Node info box to display DOM node ID and classes on hover\n    function NodeInfoBox(element) {\n        this.element = element;\n        this.remove = this.remove.bind(this);\n        this.create();\n    }\n\n    NodeInfoBox.prototype = {\n        _checkOverlap: function(nodeInfoBoxPos, nodeInfoBoxDimensions) {\n            if (_nodeMoreOptionsBox && _nodeMoreOptionsBox._shadow) {\n                const moreOptionsBoxElement = _nodeMoreOptionsBox._shadow.querySelector('.phoenix-more-options-box');\n                if (moreOptionsBoxElement) {\n                    const moreOptionsBoxOffset = _screenOffset(moreOptionsBoxElement);\n                    const moreOptionsBoxRect = moreOptionsBoxElement.getBoundingClientRect();\n\n                    const infoBox = {\n                        left: nodeInfoBoxPos.leftPos,\n                        top: nodeInfoBoxPos.topPos,\n                        right: nodeInfoBoxPos.leftPos + nodeInfoBoxDimensions.width,\n                        bottom: nodeInfoBoxPos.topPos + nodeInfoBoxDimensions.height\n                    };\n\n                    const moreOptionsBox = {\n                        left: moreOptionsBoxOffset.left,\n                        top: moreOptionsBoxOffset.top,\n                        right: moreOptionsBoxOffset.left + moreOptionsBoxRect.width,\n                        bottom: moreOptionsBoxOffset.top + moreOptionsBoxRect.height\n                    };\n\n                    const isOverlapping = !(infoBox.right < moreOptionsBox.left ||\n                             moreOptionsBox.right < infoBox.left ||\n                             infoBox.bottom < moreOptionsBox.top ||\n                             moreOptionsBox.bottom < infoBox.top);\n\n                    return isOverlapping;\n                }\n            }\n            return false;\n        },\n\n        _getBoxPosition: function(boxDimensions, overlap = false) {\n            const elemBounds = this.element.getBoundingClientRect();\n            const offset = _screenOffset(this.element);\n            let topPos = 0;\n            let leftPos = 0;\n\n            if (overlap) {\n                topPos = offset.top + 2;\n                leftPos = offset.left + elemBounds.width + 6; // positioning at the right side\n\n                // Check if overlap position would go off the right of the viewport\n                if (leftPos + boxDimensions.width > window.innerWidth) {\n                    leftPos = offset.left - boxDimensions.width - 6; // positioning at the left side\n\n                    if (leftPos < 0) { // if left positioning not perfect, position at bottom\n                        topPos = offset.top + elemBounds.height + 6;\n                        leftPos = offset.left;\n\n                        // if bottom position not perfect, move at top above the more options box\n                        if (elemBounds.bottom + 6 + boxDimensions.height > window.innerHeight) {\n                            topPos = offset.top - boxDimensions.height - 34; // 34 is for moreOptions box height\n                            leftPos = offset.left;\n                        }\n                    }\n                }\n            } else {\n                topPos = offset.top - boxDimensions.height - 6; // 6 for just some little space to breathe\n                leftPos = offset.left;\n\n                if (elemBounds.top - boxDimensions.height < 6) {\n                    // check if placing the box below would cause viewport height increase\n                    // we need this or else it might cause a flickering issue\n                    // read this to know why flickering occurs:\n                    // when we hover over the bottom part of a tall element, the info box appears below it.\n                    // this increases the live preview height, which makes the cursor position relatively\n                    // higher due to content shift. the cursor then moves out of the element boundary,\n                    // ending the hover state. this makes the info box disappear, decreasing the height\n                    // back, causing the cursor to fall back into the element, restarting the hover cycle.\n                    // this creates a continuous flickering loop.\n                    const bottomPosition = offset.top + elemBounds.height + 6;\n                    const wouldIncreaseViewportHeight = bottomPosition + boxDimensions.height > window.innerHeight;\n\n                    // we only need to use floating position during hover mode (not on click mode)\n                    const isHoverMode = shouldShowHighlightOnHover();\n                    const shouldUseFloatingPosition = wouldIncreaseViewportHeight && isHoverMode;\n\n                    if (shouldUseFloatingPosition) {\n                        // float over element at bottom-right to prevent layout shift during hover\n                        topPos = offset.top + elemBounds.height - boxDimensions.height - 6;\n                        leftPos = offset.left + elemBounds.width - boxDimensions.width;\n\n                        // make sure it doesn't go off-screen\n                        if (leftPos < 0) {\n                            leftPos = offset.left; // align to left edge of element\n                        }\n                        if (topPos < 0) {\n                            topPos = offset.top + 6; // for the top of element\n                        }\n                    } else {\n                        topPos = bottomPosition;\n                    }\n                }\n\n                // Check if the box would go off the right of the viewport\n                if (leftPos + boxDimensions.width > window.innerWidth) {\n                    leftPos = window.innerWidth - boxDimensions.width - 10;\n                }\n            }\n\n            return {topPos: topPos, leftPos: leftPos};\n        },\n\n        _style: function() {\n            this.body = window.document.createElement(\"div\");\n\n            // this is shadow DOM.\n            // we need it because if we add the box directly to the DOM then users style might override it.\n            // {mode: \"open\"} allows us to access the shadow DOM to get actual height/position of the boxes\n            const shadow = this.body.attachShadow({ mode: \"open\" });\n\n            // get the ID and classes for that element, as we need to display it in the box\n            const id = this.element.id;\n            const classes = Array.from(this.element.classList || []);\n\n            let content = \"\"; // this will hold the main content that will be displayed\n            content += \"<div class='tag-name'>\" + this.element.tagName.toLowerCase() + \"</div>\"; // add element tag name\n\n            // Add ID if present\n            if (id) {\n                content += \"<div class='id-name'>#\" + id + \"</div>\";\n            }\n\n            // Add classes (limit to 3 with dropdown indicator)\n            if (classes.length > 0) {\n                content += \"<div class='class-name'>\";\n                for (var i = 0; i < Math.min(classes.length, 3); i++) {\n                    content += \".\" + classes[i] + \" \";\n                }\n                if (classes.length > 3) {\n                    content += \"<span class='exceeded-classes'>+\" + (classes.length - 3) + \" more</span>\";\n                }\n                content += \"</div>\";\n            }\n\n            // initially, we place our info box -1000px to the top but at the right left pos. this is done so that\n            // we can take the text-wrapping inside the info box in account when calculating the height\n            // after calculating the height of the box, we place it at the exact position above the element\n            const offset = _screenOffset(this.element);\n            const leftPos = offset.left;\n\n            const styles = `\n                :host {\n                  all: initial !important;\n                }\n\n                .phoenix-node-info-box {\n                    background-color: #4285F4 !important;\n                    color: white !important;\n                    border-radius: 3px !important;\n                    padding: 5px 8px !important;\n                    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2) !important;\n                    font-size: 12px !important;\n                    font-family: Arial, sans-serif !important;\n                    z-index: 2147483647 !important;\n                    position: absolute !important;\n                    left: ${leftPos}px;\n                    top: -1000px;\n                    max-width: 300px !important;\n                    box-sizing: border-box !important;\n                    pointer-events: none !important;\n                }\n\n                .tag-name {\n                    font-weight: bold !important;\n                }\n\n                .id-name,\n                .class-name {\n                    margin-top: 3px !important;\n                }\n\n                .exceeded-classes {\n                    opacity: 0.8 !important;\n                }\n            `;\n\n            // add everything to the shadow box\n            shadow.innerHTML = `<style>${styles}</style><div class=\"phoenix-node-info-box\">${content}</div>`;\n            this._shadow = shadow;\n        },\n\n        create: function() {\n            this.remove(); // remove existing box if already present\n\n            if(!config.isProUser) {\n                return;\n            }\n\n            // this check because when there is no element visible to the user, we don't want to show the box\n            // for ex: when user clicks on a 'x' button and the button is responsible to hide a panel\n            // then clicking on that button shouldn't show the more options box\n            // also covers cases where elements are inside closed/collapsed menus\n            if(!isElementVisible(this.element)) {\n                return;\n            }\n\n            this._style(); // style the box\n\n            window.document.body.appendChild(this.body);\n\n            // get the actual rendered height of the box and then we reposition it to the actual place\n            const boxElement = this._shadow.querySelector('.phoenix-node-info-box');\n            if (boxElement) {\n                const nodeInfoBoxDimensions = {\n                    height: boxElement.getBoundingClientRect().height,\n                    width: boxElement.getBoundingClientRect().width\n                };\n                const nodeInfoBoxPos = this._getBoxPosition(nodeInfoBoxDimensions, false);\n\n                boxElement.style.left = nodeInfoBoxPos.leftPos + 'px';\n                boxElement.style.top = nodeInfoBoxPos.topPos + 'px';\n\n                const isBoxOverlapping = this._checkOverlap(nodeInfoBoxPos, nodeInfoBoxDimensions);\n                if(isBoxOverlapping) {\n                    const newPos = this._getBoxPosition(nodeInfoBoxDimensions, true);\n                    boxElement.style.left = newPos.leftPos + 'px';\n                    boxElement.style.top = newPos.topPos + 'px';\n                }\n            }\n        },\n\n        remove: function() {\n            if (this.body && this.body.parentNode && this.body.parentNode === window.document.body) {\n                window.document.body.removeChild(this.body);\n                this.body = null;\n            }\n        }\n    };\n\n    // AI prompt box, it is displayed when user clicks on the AI button in the more options box\n    function AIPromptBox(element) {\n        this.element = element;\n        this.selectedModel = 'fast';\n        this.remove = this.remove.bind(this);\n        this.create();\n    }\n\n    AIPromptBox.prototype = {\n        _getBoxPosition: function(boxWidth, boxHeight) {\n            const elemBounds = this.element.getBoundingClientRect();\n            const offset = _screenOffset(this.element);\n\n            let topPos = offset.top - boxHeight - 6; // 6 for just some little space to breathe\n            let leftPos = offset.left + elemBounds.width - boxWidth;\n\n            // Check if the box would go off the top of the viewport\n            if (elemBounds.top - boxHeight < 6) {\n                topPos = offset.top + elemBounds.height + 6;\n            }\n\n            // Check if the box would go off the left of the viewport\n            if (leftPos < 0) {\n                leftPos = offset.left;\n            }\n\n            return {topPos: topPos, leftPos: leftPos};\n        },\n\n        _style: function() {\n            this.body = window.document.createElement(\"div\");\n            // using shadow dom so that user styles doesn't override it\n            const shadow = this.body.attachShadow({ mode: \"open\" });\n\n            // Calculate responsive dimensions based on viewport width\n            const viewportWidth = window.innerWidth;\n            let boxWidth, boxHeight;\n\n            if (viewportWidth >= 400) {\n                boxWidth = Math.min(310, viewportWidth * 0.85);\n                boxHeight = 60;\n            } else if (viewportWidth >= 350) {\n                boxWidth = Math.min(275, viewportWidth * 0.85);\n                boxHeight = 70;\n            } else if (viewportWidth >= 300) {\n                boxWidth = Math.min(230, viewportWidth * 0.85);\n                boxHeight = 80;\n            } else if (viewportWidth >= 250) {\n                boxWidth = Math.min(180, viewportWidth * 0.85);\n                boxHeight = 100;\n            } else if (viewportWidth >= 200) {\n                boxWidth = Math.min(130, viewportWidth * 0.85);\n                boxHeight = 120;\n            } else {\n                boxWidth = Math.min(100, viewportWidth * 0.85);\n                boxHeight = 140;\n            }\n\n            const styles = `\n                :host {\n                  all: initial !important;\n                }\n\n                .phoenix-ai-prompt-box {\n                    position: absolute !important;\n                    background: white !important;\n                    border: 1px solid #4285F4 !important;\n                    border-radius: 8px !important;\n                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;\n                    font-family: Arial, sans-serif !important;\n                    z-index: 2147483647 !important;\n                    width: ${boxWidth}px !important;\n                    padding: 0 !important;\n                    box-sizing: border-box !important;\n                }\n\n                .phoenix-ai-prompt-input-container {\n                    position: relative !important;\n                }\n\n                .phoenix-ai-prompt-textarea {\n                    width: 100% !important;\n                    height: ${boxHeight}px !important;\n                    border: none !important;\n                    border-radius: 8px !important;\n                    padding: 12px 40px 12px 16px !important;\n                    font-size: 14px !important;\n                    font-family: Arial, sans-serif !important;\n                    resize: none !important;\n                    outline: none !important;\n                    box-sizing: border-box !important;\n                    background: #f9f9f9 !important;\n                }\n\n                .phoenix-ai-prompt-textarea:focus {\n                    background: white !important;\n                }\n\n                .phoenix-ai-prompt-textarea::placeholder {\n                    color: #999 !important;\n                }\n\n                .phoenix-ai-prompt-send-button {\n                    width: 28px !important;\n                    height: 28px !important;\n                    border: none !important;\n                    border-radius: 50% !important;\n                    background: #4285F4 !important;\n                    color: white !important;\n                    cursor: pointer !important;\n                    display: flex !important;\n                    align-items: center !important;\n                    justify-content: center !important;\n                    font-size: 14px !important;\n                    transition: background-color 0.2s !important;\n                    line-height: 0.5 !important;\n                }\n\n                .phoenix-ai-prompt-send-button:hover:not(:disabled) {\n                    background: #4285F4 !important;\n                }\n\n                .phoenix-ai-prompt-send-button:disabled {\n                    background: #dadce0 !important;\n                    color: #9aa0a6 !important;\n                    cursor: not-allowed !important;\n                }\n\n                .phoenix-ai-bottom-controls {\n                    border-top: 1px solid #e0e0e0 !important;\n                    padding: 8px 16px !important;\n                    background: #f9f9f9 !important;\n                    border-radius: 0 0 8px 8px !important;\n                    display: flex !important;\n                    align-items: center !important;\n                    justify-content: space-between !important;\n                }\n\n                .phoenix-ai-model-select {\n                    padding: 4px 8px !important;\n                    border: 1px solid #ddd !important;\n                    border-radius: 4px !important;\n                    font-size: 12px !important;\n                    background: white !important;\n                    outline: none !important;\n                    cursor: pointer !important;\n                }\n\n                .phoenix-ai-model-select:focus {\n                    border-color: #4285F4 !important;\n                }\n            `;\n\n            const content = `\n                <div class=\"phoenix-ai-prompt-box\">\n                    <div class=\"phoenix-ai-prompt-input-container\">\n                        <textarea\n                            class=\"phoenix-ai-prompt-textarea\"\n                            placeholder=\"${config.strings.aiPromptPlaceholder}\"\n                        ></textarea>\n                    </div>\n                    <div class=\"phoenix-ai-bottom-controls\">\n                        <select class=\"phoenix-ai-model-select\">\n                            <option value=\"fast\">Fast AI</option>\n                            <option value=\"moderate\">Moderate AI</option>\n                            <option value=\"slow\">Slow AI</option>\n                        </select>\n                        <button class=\"phoenix-ai-prompt-send-button\" disabled>\n                            \n                        </button>\n                    </div>\n                </div>\n            `;\n\n            shadow.innerHTML = `<style>${styles}</style>${content}`;\n            this._shadow = shadow;\n        },\n\n        create: function() {\n            this._style();\n            window.document.body.appendChild(this.body);\n\n            // Get the actual rendered dimensions of the box and position it\n            const boxElement = this._shadow.querySelector('.phoenix-ai-prompt-box');\n            if (boxElement) {\n                const boxRect = boxElement.getBoundingClientRect();\n                const pos = this._getBoxPosition(boxRect.width, boxRect.height);\n\n                boxElement.style.left = pos.leftPos + 'px';\n                boxElement.style.top = pos.topPos + 'px';\n            }\n\n            // Focus on the textarea\n            const textarea = this._shadow.querySelector('.phoenix-ai-prompt-textarea');\n            if (textarea) { // small timer to make sure that the text area element is fetched\n                setTimeout(() => textarea.focus(), 50);\n            }\n\n            this._attachEventHandlers();\n\n            // Prevent clicks inside the AI box from bubbling up and closing it\n            this.body.addEventListener('click', (event) => {\n                event.stopPropagation();\n            });\n        },\n\n        _attachEventHandlers: function() {\n            const textarea = this._shadow.querySelector('.phoenix-ai-prompt-textarea');\n            const sendButton = this._shadow.querySelector('.phoenix-ai-prompt-send-button');\n            const modelSelect = this._shadow.querySelector('.phoenix-ai-model-select');\n\n            // Handle textarea input to enable/disable send button\n            if (textarea && sendButton) {\n                textarea.addEventListener('input', (event) => {\n                    const hasText = event.target.value.trim().length > 0;\n                    sendButton.disabled = !hasText;\n                });\n\n                // enter key\n                textarea.addEventListener('keydown', (event) => {\n                    if (event.key === 'Enter' && !event.shiftKey) {\n                        event.preventDefault();\n                        if (textarea.value.trim()) {\n                            this._handleSend(event, textarea.value.trim());\n                        }\n                    } else if (event.key === 'Escape') {\n                        event.preventDefault();\n                        this.remove();\n                    }\n                });\n            }\n\n            // send button click\n            if (sendButton) {\n                sendButton.addEventListener('click', (event) => {\n                    event.preventDefault();\n                    event.stopPropagation();\n                    if (textarea && textarea.value.trim()) {\n                        this._handleSend(event, textarea.value.trim());\n                    }\n                });\n            }\n\n            // model selection change\n            if (modelSelect) {\n                modelSelect.addEventListener('change', (event) => {\n                    this.selectedModel = event.target.value;\n                });\n            }\n        },\n\n        _handleSend: function(event, prompt) {\n            const element = this.element;\n            if(!isElementEditable(element)) {\n                return;\n            }\n            const tagId = element.getAttribute(\"data-brackets-id\");\n\n            window._Brackets_MessageBroker.send({\n                livePreviewEditEnabled: true,\n                event: event,\n                element: element,\n                prompt: prompt,\n                tagId: Number(tagId),\n                selectedModel: this.selectedModel,\n                AISend: true\n            });\n            this.remove();\n        },\n\n        remove: function() {\n            if (this._handleKeydown) {\n                document.removeEventListener('keydown', this._handleKeydown);\n                this._handleKeydown = null;\n            }\n\n            if (this._handleResize) {\n                window.removeEventListener('resize', this._handleResize);\n                this._handleResize = null;\n            }\n\n            if (this.body && this.body.parentNode && this.body.parentNode === window.document.body) {\n                window.document.body.removeChild(this.body);\n                this.body = null;\n                _aiPromptBox = null;\n            }\n        }\n    };\n\n    // image ribbon gallery cache, to store the last query and its results\n    // then next time we can load it from cache itself instead of making a new API call\n    const _imageGalleryCache = {\n        currentQuery: null,\n        allImages: [],\n        totalPages: 1,\n        currentPage: 1,\n        maxImages: 50\n    };\n\n    /**\n     * when user clicks on an image we call this,\n     * this creates a image ribbon gallery at the bottom of the live preview\n     */\n    function ImageRibbonGallery(element) {\n        this.element = element;\n        this.remove = this.remove.bind(this);\n        this.currentPage = 1;\n        this.totalPages = 1;\n        this.allImages = [];\n        this.imagesPerPage = 10;\n        this.scrollPosition = 0;\n        this.maxWidth = '800px'; // when current image dimension is not defined we use this as unsplash images are very large\n        this.maxHeight = '600px';\n\n        this.create();\n    }\n\n    ImageRibbonGallery.prototype = {\n        _style: function () {\n            this.body = window.document.createElement(\"div\");\n            this._shadow = this.body.attachShadow({mode: 'closed'});\n\n            this._shadow.innerHTML = `\n                <style>\n                    .phoenix-image-ribbon {\n                        position: fixed !important;\n                        bottom: 0 !important;\n                        left: 0 !important;\n                        right: 0 !important;\n                        width: 100vw !important;\n                        background: linear-gradient(180deg, rgba(12,14,20,0.0), rgba(12,14,20,0.7)) !important;\n                        z-index: 2147483647 !important;\n                        display: flex !important;\n                        font-family: ui-sans-serif, system-ui, -apple-system, \"Segoe UI\", Roboto, Arial !important;\n                        pointer-events: auto !important;\n                    }\n\n                    .phoenix-ribbon-container {\n                        width: 100% !important;\n                        height: 156px !important;\n                        background: rgba(255, 255, 255, 0.3) !important;\n                        backdrop-filter: blur(10px) !important;\n                        -webkit-backdrop-filter: blur(10px) !important;\n                        border: 1px solid rgba(255, 255, 255, 0.2) !important;\n                        border-radius: 12px !important;\n                        position: relative !important;\n                    }\n\n                    .phoenix-ribbon-strip {\n                        position: absolute !important;\n                        inset: 0 !important;\n                        overflow: hidden !important;\n                        scroll-behavior: smooth !important;\n                        padding: 6px !important;\n                        top: 34px !important;\n                    }\n\n                    .phoenix-ribbon-row {\n                        display: flex !important;\n                        gap: 2px !important;\n                    }\n\n                    .phoenix-ribbon-thumb {\n                        flex: 0 0 auto !important;\n                        width: 112px !important;\n                        height: 112px !important;\n                        border-radius: 14px !important;\n                        overflow: hidden !important;\n                        position: relative !important;\n                        cursor: pointer !important;\n                        outline: 1px solid rgba(255,255,255,0.08) !important;\n                        transition: transform 0.15s ease, outline-color 0.15s ease, box-shadow 0.15s ease !important;\n                        background: #0b0e14 !important;\n                    }\n\n                    .phoenix-ribbon-thumb img {\n                        width: 100% !important;\n                        height: 100% !important;\n                        object-fit: cover !important;\n                        display: block !important;\n                    }\n\n                    .phoenix-ribbon-thumb:hover {\n                        transform: translateY(-2px) scale(1.02) !important;\n                        outline-color: rgba(255,255,255,0.25) !important;\n                        box-shadow: 0 8px 18px rgba(0,0,0,0.36) !important;\n                    }\n\n                    .phoenix-ribbon-nav {\n                        position: absolute !important;\n                        top: 58% !important;\n                        transform: translateY(-50%) !important;\n                        border-radius: 12px !important;\n                        border: 1px solid rgba(255,255,255,0.14) !important;\n                        color: #eaeaf0 !important;\n                        background: rgba(21,25,36,0.65) !important;\n                        cursor: pointer !important;\n                        backdrop-filter: blur(8px) !important;\n                        font-size: 20px !important;\n                        font-weight: 600 !important;\n                        user-select: none !important;\n                        transition: all 0.2s ease !important;\n                        z-index: 2147483647 !important;\n                        padding: 2px 12px 6px 12px !important;\n                    }\n\n                    .phoenix-ribbon-nav:hover {\n                        background: rgba(21,25,36,0.85) !important;\n                        border-color: rgba(255,255,255,0.25) !important;\n                        transform: translateY(-50%) scale(1.05) !important;\n                        box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;\n                    }\n\n                    .phoenix-ribbon-nav:active {\n                        transform: translateY(-50%) scale(0.95) !important;\n                    }\n\n                    .phoenix-ribbon-nav.left {\n                        left: 18px !important;\n                    }\n\n                    .phoenix-ribbon-nav.right {\n                        right: 18px !important;\n                    }\n\n                    .phoenix-ribbon-loading {\n                        display: flex !important;\n                        align-items: center !important;\n                        justify-content: center !important;\n                        height: 100% !important;\n                        color: #eaeaf0 !important;\n                        font-size: 14px !important;\n                    }\n\n                    .phoenix-ribbon-error {\n                        display: flex !important;\n                        align-items: center !important;\n                        justify-content: center !important;\n                        height: 100% !important;\n                        color: #ff6b6b !important;\n                        font-size: 14px !important;\n                    }\n\n                    .phoenix-ribbon-header {\n                        display: flex !important;\n                        width: 100% !important;\n                        position: absolute !important;\n                        top: 5px !important;\n                    }\n\n                    .phoenix-ribbon-header-left {\n                        width: 80% !important;\n                        display: flex !important;\n                    }\n\n                    .phoenix-ribbon-header-right {\n                        width: 20% !important;\n                        display: flex !important;\n                        justify-content: flex-end !important;\n                    }\n\n                    .phoenix-ribbon-search {\n                        display: flex !important;\n                        align-items: center !important;\n                        background: rgba(0,0,0,0.5) !important;\n                        padding: 5px !important;\n                        border-radius: 5px !important;\n                        margin-left: 8px !important;\n                    }\n\n                    .phoenix-ribbon-search input {\n                        background: transparent !important;\n                        border: none !important;\n                        outline: none !important;\n                        color: white !important;\n                        width: 200px !important;\n                    }\n\n                    .phoenix-ribbon-search input::placeholder {\n                        color: rgba(255, 255, 255, 0.7) !important;\n                        opacity: 1 !important;\n                    }\n\n                    .phoenix-ribbon-search input::-webkit-input-placeholder {\n                        color: rgba(255, 255, 255, 0.7) !important;\n                    }\n\n                    .phoenix-ribbon-search input::-moz-placeholder {\n                        color: rgba(255, 255, 255, 0.7) !important;\n                        opacity: 1 !important;\n                    }\n\n                    .phoenix-ribbon-search-btn {\n                        background: none !important;\n                        border: none !important;\n                        color: #6aa9ff !important;\n                        cursor: pointer !important;\n                    }\n\n                    .phoenix-ribbon-select {\n                        margin-left: 10px !important;\n                    }\n\n                    .phoenix-select-image-btn {\n                        background: gray !important;\n                        border: 1px solid rgba(255, 255, 255, 0.2) !important;\n                        color: #fff !important;\n                        padding: 2px 4px !important;\n                        border-radius: 6px !important;\n                        font-size: 12px !important;\n                        cursor: pointer !important;\n                        transition: all 0.2s ease !important;\n                    }\n\n                    .phoenix-ribbon-close {\n                        background: rgba(0,0,0,0.5) !important;\n                        border: none !important;\n                        color: white !important;\n                        cursor: pointer !important;\n                        padding: 4px 8px !important;\n                        border-radius: 3px !important;\n                        margin-right: 16px !important;\n                    }\n\n                    .phoenix-ribbon-attribution {\n                        position: absolute !important;\n                        bottom: 6px !important;\n                        left: 6px !important;\n                        background: rgba(0,0,0,0.8) !important;\n                        color: white !important;\n                        padding: 4px 6px !important;\n                        border-radius: 5px !important;\n                        font-size: 10px !important;\n                        line-height: 1.2 !important;\n                        max-width: calc(100% - 12px) !important;\n                        text-shadow: 0 1px 2px rgba(0,0,0,0.9) !important;\n                        pointer-events: auto !important;\n                        opacity: 0 !important;\n                        transition: all 0.2s ease !important;\n                    }\n\n                    .phoenix-ribbon-attribution .photographer {\n                        display: block !important;\n                        font-weight: 500 !important;\n                        white-space: nowrap !important;\n                        overflow: hidden !important;\n                        text-overflow: ellipsis !important;\n                        color: white !important;\n                        text-decoration: none !important;\n                    }\n\n                    .phoenix-ribbon-attribution .photographer:hover {\n                        text-decoration: underline !important;\n                    }\n\n                    .phoenix-ribbon-attribution .source {\n                        display: block !important;\n                        font-size: 9px !important;\n                        opacity: 0.85 !important;\n                        color: white !important;\n                        text-decoration: none !important;\n                    }\n\n                    .phoenix-ribbon-attribution .source:hover {\n                        text-decoration: underline !important;\n                    }\n\n                    .phoenix-download-icon {\n                        position: absolute !important;\n                        top: 8px !important;\n                        right: 8px !important;\n                        background: rgba(0,0,0,0.7) !important;\n                        border: none !important;\n                        color: #eee !important;\n                        border-radius: 50% !important;\n                        width: 18px !important;\n                        height: 18px !important;\n                        padding: 4px !important;\n                        display: flex !important;\n                        align-items: center !important;\n                        justify-content: center !important;\n                        cursor: pointer !important;\n                        font-size: 16px !important;\n                        z-index: 2147483647 !important;\n                        transition: all 0.2s ease !important;\n                        pointer-events: none !important;\n                        opacity: 0 !important;\n                    }\n\n                    .phoenix-ribbon-thumb:hover .phoenix-download-icon {\n                        opacity: 1 !important;\n                        pointer-events: auto !important;\n                    }\n\n                    .phoenix-ribbon-thumb:hover .phoenix-ribbon-attribution {\n                        opacity: 1 !important;\n                    }\n\n                    .phoenix-ribbon-attribution:hover {\n                        opacity: 1 !important;\n                    }\n\n                    .phoenix-download-icon:hover {\n                        background: rgba(0,0,0,0.9) !important;\n                        transform: scale(1.1) !important;\n                    }\n\n                    .phoenix-ribbon-thumb {\n                        cursor: pointer !important;\n                    }\n\n                    .phoenix-ribbon-thumb.downloading {\n                        opacity: 0.6 !important;\n                        pointer-events: none !important;\n                    }\n\n                    .phoenix-download-indicator {\n                        position: absolute !important;\n                        top: 50% !important;\n                        left: 50% !important;\n                        transform: translate(-50%, -50%) !important;\n                        background: rgba(0, 0, 0, 0.8) !important;\n                        border-radius: 50% !important;\n                        width: 40px !important;\n                        height: 40px !important;\n                        display: flex !important;\n                        align-items: center !important;\n                        justify-content: center !important;\n                        z-index: 10 !important;\n                    }\n\n                    .phoenix-download-spinner {\n                        width: 20px !important;\n                        height: 20px !important;\n                        border: 2px solid rgba(255, 255, 255, 0.3) !important;\n                        border-top: 2px solid #fff !important;\n                        border-radius: 50% !important;\n                        animation: phoenix-spin 1s linear infinite !important;\n                    }\n\n                    @keyframes phoenix-spin {\n                        0% { transform: rotate(0deg); }\n                        100% { transform: rotate(360deg); }\n                    }\n                </style>\n                <div class=\"phoenix-image-ribbon\">\n                    <div class=\"phoenix-ribbon-container\">\n                        <div class=\"phoenix-ribbon-header\">\n                            <div class=\"phoenix-ribbon-header-left\">\n                                <div class=\"phoenix-ribbon-search\">\n                                    <input type=\"text\" placeholder=\"${config.strings.imageGallerySearchPlaceholder}\" />\n                                    <button class=\"phoenix-ribbon-search-btn\">Search</button>\n                                </div>\n                                <div class=\"phoenix-ribbon-select\">\n                                    <button class=\"phoenix-select-image-btn\" title=\"${config.strings.imageGallerySelectFromComputer}\">\n                                        <svg viewBox=\"0 0 24 24\" fill=\"currentColor\" width=\"20\" height=\"20\">\n                                            <path d=\"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z\"/>\n                                            <path d=\"M12,12L10.5,13.5L8.5,11.5L6,14H18L15,11L12,12Z\"/>\n                                        </svg>\n                                    </button>\n                                    <input type=\"file\" class=\"phoenix-file-input\" accept=\"image/*\" style=\"display: none;\">\n                                </div>\n                            </div>\n                            <div class=\"phoenix-ribbon-header-right\">\n                                <button class=\"phoenix-ribbon-close\"></button>\n                            </div>\n                        </div>\n                        <div class=\"phoenix-ribbon-nav left\">&#8249;</div>\n                        <div class=\"phoenix-ribbon-strip\">\n                            <div class=\"phoenix-ribbon-row phoenix-ribbon-loading\">\n                                Loading images...\n                            </div>\n                        </div>\n                        <div class=\"phoenix-ribbon-nav right\">&#8250;</div>\n                    </div>\n                </div>\n            `;\n        },\n\n        _getDefaultQuery: function() {\n            // this are the default queries, so when image ribbon gallery is shown, we select a random query and show it\n            const qualityQueries = [\n                'nature', 'minimal', 'workspace', 'abstract', 'coffee',\n                'mountains', 'city', 'flowers', 'ocean', 'sunset',\n                'architecture', 'forest', 'travel', 'technology', 'sky',\n                'landscape', 'creative', 'design', 'art', 'modern',\n                'food', 'patterns', 'colors', 'photography', 'studio',\n                'light', 'winter', 'summer', 'vintage', 'geometric',\n                'water', 'beach', 'space', 'garden', 'textures',\n                'urban', 'portrait', 'music', 'books', 'home',\n                'cozy', 'aesthetic', 'autumn', 'spring', 'clouds'\n            ];\n\n            const randIndex = Math.floor(Math.random() * qualityQueries.length);\n            return qualityQueries[randIndex];\n        },\n\n        _fetchImages: function(searchQuery, page = 1, append = false) {\n            this._currentSearchQuery = searchQuery;\n\n            if (!append && this._loadFromCache(searchQuery)) { // try cache first\n                return;\n            }\n            if (append && this._loadPageFromCache(searchQuery, page)) { // try to load new page from cache\n                return;\n            }\n            // if unable to load from cache, we make the API call\n            this._fetchFromAPI(searchQuery, page, append);\n        },\n\n        _fetchFromAPI: function(searchQuery, page, append) {\n            // when we fetch from API, we clear the cache and then store a fresh copy\n            if (searchQuery !== _imageGalleryCache.currentQuery) {\n                this._clearCache();\n            }\n\n            const apiUrl = `https://images.phcode.dev/api/images/search?q=${encodeURIComponent(searchQuery)}&per_page=10&page=${page}&safe=true`;\n\n            if (!append) {\n                this._showLoading();\n            }\n\n            fetch(apiUrl)\n                .then(response => {\n                    if (!response.ok) {\n                        throw new Error(`API request failed: ${response.status}`);\n                    }\n                    return response.json();\n                })\n                .then(data => {\n                    if (data.results && data.results.length > 0) {\n                        if (append) {\n                            this.allImages = this.allImages.concat(data.results);\n                            this._renderImages(data.results, true); // true means need to append new images at the end\n                        } else {\n                            this.allImages = data.results;\n                            this._renderImages(this.allImages, false); // false means its a new search\n                        }\n                        this.totalPages = data.total_pages || 1;\n                        this.currentPage = page;\n                        this._updateNavButtons();\n                        this._updateSearchInput(searchQuery);\n                        this._updateCache(searchQuery, data, append);\n                    } else if (!append) {\n                        this._showError('No images found');\n                    }\n\n                    if (append) {\n                        this._isLoadingMore = false;\n                        this._hideLoadingMore();\n                    }\n                })\n                .catch(error => {\n                    console.error('Failed to fetch images:', error);\n                    if (!append) {\n                        this._showError('Failed to load images');\n                    } else {\n                        this._isLoadingMore = false;\n                        this._hideLoadingMore();\n                    }\n                });\n        },\n\n        _updateCache: function(searchQuery, data, append) {\n            // Update cache with new data for current query\n            _imageGalleryCache.currentQuery = searchQuery;\n            _imageGalleryCache.totalPages = data.total_pages || 1;\n            _imageGalleryCache.currentPage = this.currentPage;\n\n            if (append) {\n                // Append new results to existing cache\n                const newImages = _imageGalleryCache.allImages.concat(data.results);\n\n                if (newImages.length > _imageGalleryCache.maxImages) { // max = 50\n                    _imageGalleryCache.allImages = newImages.slice(-_imageGalleryCache.maxImages);\n                } else {\n                    _imageGalleryCache.allImages = newImages;\n                }\n            } else {\n                // new search replace cache\n                _imageGalleryCache.allImages = data.results;\n            }\n        },\n\n        _clearCache: function() {\n            // clear current cache when switching to new query\n            _imageGalleryCache.currentQuery = null;\n            _imageGalleryCache.allImages = [];\n            _imageGalleryCache.totalPages = 1;\n            _imageGalleryCache.currentPage = 1;\n        },\n\n        _updateSearchInput: function(searchQuery) {\n            // write the current query in the search input\n            const searchInput = this._shadow.querySelector('.phoenix-ribbon-search input');\n            if (searchInput && searchQuery) {\n                searchInput.value = searchQuery;\n                searchInput.placeholder = searchQuery;\n            }\n        },\n\n        _loadFromCache: function(searchQuery) {\n            // Check if we can load from cache for this query\n            if (searchQuery === _imageGalleryCache.currentQuery && _imageGalleryCache.allImages.length > 0) {\n                this.allImages = _imageGalleryCache.allImages;\n                this.totalPages = _imageGalleryCache.totalPages;\n                this.currentPage = _imageGalleryCache.currentPage;\n\n                this._renderImages(this.allImages, false);\n                this._updateNavButtons();\n                this._updateSearchInput(searchQuery);\n                return true; // Successfully loaded from cache\n            }\n            return false; // unable to load from cache\n        },\n\n        _loadPageFromCache: function(searchQuery, page) {\n            // check if this page is in cache\n            if (searchQuery === _imageGalleryCache.currentQuery && page <= Math.ceil(_imageGalleryCache.allImages.length / 10)) {\n                const startIdx = (page - 1) * 10;\n                const endIdx = startIdx + 10;\n                const pageImages = _imageGalleryCache.allImages.slice(startIdx, endIdx);\n\n                if (pageImages.length > 0) {\n                    this.allImages = this.allImages.concat(pageImages);\n                    this._renderImages(pageImages, true);\n                    this.currentPage = page;\n                    this._updateNavButtons();\n                    this._isLoadingMore = false;\n                    this._hideLoadingMore();\n                    return true; // Successfully loaded page from cache\n                }\n            }\n            return false;\n        },\n\n        _handleNavLeft: function() {\n            const container = this._shadow.querySelector('.phoenix-ribbon-strip');\n            if (!container) { return; }\n\n            const containerWidth = container.clientWidth;\n            const scrollAmount = containerWidth;\n\n            this.scrollPosition = Math.max(0, this.scrollPosition - scrollAmount);\n            container.scrollTo({ left: this.scrollPosition, behavior: 'smooth' });\n            this._updateNavButtons();\n        },\n\n        _handleNavRight: function() {\n            const container = this._shadow.querySelector('.phoenix-ribbon-strip');\n            if (!container) { return; }\n\n            const containerWidth = container.clientWidth;\n            const totalWidth = container.scrollWidth;\n            const scrollAmount = containerWidth;\n\n            // if we're near the end, we need to load more images\n            const nearEnd = (this.scrollPosition + containerWidth + scrollAmount) >= totalWidth - 100;\n            if (nearEnd && this.currentPage < this.totalPages && !this._isLoadingMore) {\n                this._isLoadingMore = true;\n                this._showLoadingMore();\n                this._fetchImages(this._currentSearchQuery, this.currentPage + 1, true);\n            }\n\n            this.scrollPosition = Math.min(totalWidth - containerWidth, this.scrollPosition + scrollAmount);\n            container.scrollTo({ left: this.scrollPosition, behavior: 'smooth' });\n            this._updateNavButtons();\n        },\n\n        _updateNavButtons: function() {\n            // this function is responsible to update the nav buttons\n            // when we're at the very left, we hide the nav-left button completely\n            // when we're at the very right and no more pages available, we hide the nav-right button\n            const navLeft = this._shadow.querySelector('.phoenix-ribbon-nav.left');\n            const navRight = this._shadow.querySelector('.phoenix-ribbon-nav.right');\n            const container = this._shadow.querySelector('.phoenix-ribbon-strip');\n\n            if (!navLeft || !navRight || !container) { return; }\n\n            // show/hide left button\n            if (this.scrollPosition <= 0) {\n                navLeft.style.display = 'none';\n            } else {\n                navLeft.style.display = 'block';\n            }\n\n            // show/hide right button\n            const containerWidth = container.clientWidth;\n            const totalWidth = container.scrollWidth;\n            const atEnd = (this.scrollPosition + containerWidth) >= totalWidth - 10;\n            const hasMorePages = this.currentPage < this.totalPages;\n\n            if (atEnd && !hasMorePages) {\n                navRight.style.display = 'none';\n            } else {\n                navRight.style.display = 'block';\n            }\n        },\n\n        _showLoading: function() {\n            const rowElement = this._shadow.querySelector('.phoenix-ribbon-row');\n            if (!rowElement) { return; }\n\n            rowElement.innerHTML = 'Loading images...';\n            rowElement.className = 'phoenix-ribbon-row phoenix-ribbon-loading';\n        },\n\n        _showLoadingMore: function() {\n            const rowElement = this._shadow.querySelector('.phoenix-ribbon-row');\n            if (!rowElement) { return; }\n\n            // when loading more images we need to show the message at the end of the image ribbon\n            const loadingIndicator = window.document.createElement('div');\n            loadingIndicator.className = 'phoenix-loading-more';\n            loadingIndicator.style.cssText = `\n                display: flex !important;\n                align-items: center !important;\n                justify-content: center !important;\n                min-width: 120px !important;\n                height: 116px !important;\n                margin-left: 2px !important;\n                background: rgba(255,255,255,0.03) !important;\n                border-radius: 8px !important;\n                color: #e8eaf0 !important;\n                font-size: 12px !important;\n                border: 1px dashed rgba(255,255,255,0.1) !important;\n            `;\n            loadingIndicator.textContent = 'Loading...';\n            rowElement.appendChild(loadingIndicator);\n        },\n\n        _hideLoadingMore: function() {\n            const loadingIndicator = this._shadow.querySelector('.phoenix-loading-more');\n            if (loadingIndicator) {\n                loadingIndicator.remove();\n            }\n        },\n\n        _attachEventHandlers: function() {\n            const ribbonContainer = this._shadow.querySelector('.phoenix-image-ribbon');\n            const searchInput = this._shadow.querySelector('.phoenix-ribbon-search input');\n            const searchButton = this._shadow.querySelector('.phoenix-ribbon-search-btn');\n            const closeButton = this._shadow.querySelector('.phoenix-ribbon-close');\n            const navLeft = this._shadow.querySelector('.phoenix-ribbon-nav.left');\n            const navRight = this._shadow.querySelector('.phoenix-ribbon-nav.right');\n            const selectImageBtn = this._shadow.querySelector('.phoenix-select-image-btn');\n            const fileInput = this._shadow.querySelector('.phoenix-file-input');\n\n            if (searchInput && searchButton) {\n                const performSearch = (e) => {\n                    e.stopPropagation();\n                    const query = searchInput.value.trim();\n                    if (query) {\n                        // reset pagination when searching\n                        this.currentPage = 1;\n                        this.allImages = [];\n                        this.scrollPosition = 0;\n                        this._fetchImages(query);\n                    }\n                };\n\n                searchButton.addEventListener('click', performSearch);\n                searchInput.addEventListener('keydown', (e) => {\n                    if (e.key === 'Enter') {\n                        performSearch(e);\n                    }\n                });\n\n                searchInput.addEventListener('click', (e) => {\n                    e.stopPropagation();\n                });\n            }\n\n            if (selectImageBtn && fileInput) {\n                selectImageBtn.addEventListener('click', (e) => {\n                    e.stopPropagation();\n                    fileInput.click();\n                });\n\n                fileInput.addEventListener('change', (e) => {\n                    e.stopPropagation();\n                    const file = e.target.files[0];\n                    if (file) {\n                        this._handleLocalImageSelection(file);\n                        fileInput.value = '';\n                    }\n                });\n            }\n\n            if (closeButton) {\n                closeButton.addEventListener('click', (e) => {\n                    e.stopPropagation();\n                    this.remove();\n                });\n            }\n\n            if (navLeft) {\n                navLeft.addEventListener('click', (e) => {\n                    e.stopPropagation();\n                    this._handleNavLeft();\n                });\n            }\n\n            if (navRight) {\n                navRight.addEventListener('click', (e) => {\n                    e.stopPropagation();\n                    this._handleNavRight();\n                });\n            }\n\n            // Prevent clicks anywhere inside the ribbon from bubbling up\n            if (ribbonContainer) {\n                ribbonContainer.addEventListener('click', (e) => {\n                    e.stopPropagation();\n                });\n            }\n        },\n\n        // append true means load more images (user clicked on nav-right)\n        // append false means its a new query\n        _renderImages: function(images, append = false) {\n            const rowElement = this._shadow.querySelector('.phoenix-ribbon-row');\n            if (!rowElement) { return; }\n\n            const container = this._shadow.querySelector('.phoenix-ribbon-strip');\n            const savedScrollPosition = container ? container.scrollLeft : 0;\n\n            // if not appending we clear the phoenix ribbon\n            if (!append) {\n                rowElement.innerHTML = '';\n                rowElement.className = 'phoenix-ribbon-row';\n            } else {\n                // when appending we add the new images at the end\n                const loadingIndicator = this._shadow.querySelector('.phoenix-loading-more');\n                if (loadingIndicator) {\n                    loadingIndicator.remove();\n                }\n            }\n\n            // Create thumbnails from API data\n            images.forEach(image => {\n                const thumbDiv = window.document.createElement('div');\n                thumbDiv.className = 'phoenix-ribbon-thumb';\n\n                const img = window.document.createElement('img');\n                img.src = image.thumb_url || image.url;\n                img.alt = image.alt_text || 'Unsplash image';\n                img.loading = 'lazy';\n\n                // show hovered image along with dimensions\n                thumbDiv.addEventListener('mouseenter', () => {\n                    this.element.style.width = this._originalImageStyle.width || this.maxWidth;\n                    this.element.style.height = this._originalImageStyle.height || this.maxHeight;\n\n                    this.element.style.objectFit = this._originalImageStyle.objectFit || 'cover';\n                    this.element.src = image.url || image.thumb_url;\n                });\n\n                // show original image when hover ends\n                thumbDiv.addEventListener('mouseleave', () => {\n                    this.element.src = this._originalImageSrc;\n                });\n\n                // attribution overlay, we show this only in the image ribbon gallery\n                const attribution = window.document.createElement('div');\n                attribution.className = 'phoenix-ribbon-attribution';\n\n                const photographer = window.document.createElement('a');\n                photographer.className = 'photographer';\n                photographer.href = image.photographer_url;\n                photographer.target = '_blank';\n                photographer.rel = 'noopener noreferrer';\n                photographer.textContent = (image.user && image.user.name) || 'Anonymous';\n                photographer.addEventListener('click', (e) => {\n                    e.stopPropagation();\n                });\n\n                const source = window.document.createElement('a');\n                source.className = 'source';\n                source.href = image.unsplash_url;\n                source.target = '_blank';\n                source.rel = 'noopener noreferrer';\n                source.textContent = 'on Unsplash';\n                source.addEventListener('click', (e) => {\n                    e.stopPropagation();\n                });\n\n                attribution.appendChild(photographer);\n                attribution.appendChild(source);\n\n                // download icon\n                const downloadIcon = window.document.createElement('div');\n                downloadIcon.className = 'phoenix-download-icon';\n                downloadIcon.title = config.strings.imageGalleryUseImage;\n                downloadIcon.innerHTML = `<svg viewBox=\"0 0 640 640\" fill=\"currentColor\">\n                  <path d=\"M352 96C352 78.3 337.7 64 320 64C302.3 64 288 78.3 288 96L288 306.7L246.6 265.3C234.1 252.8 213.8 252.8 201.3 265.3C188.8 277.8 188.8 298.1 201.3 310.6L297.3 406.6C309.8 419.1 330.1 419.1 342.6 406.6L438.6 310.6C451.1 298.1 451.1 277.8 438.6 265.3C426.1 252.8 405.8 252.8 393.3 265.3L352 306.7L352 96zM160 384C124.7 384 96 412.7 96 448L96 480C96 515.3 124.7 544 160 544L480 544C515.3 544 544 515.3 544 480L544 448C544 412.7 515.3 384 480 384L433.1 384L376.5 440.6C345.3 471.8 294.6 471.8 263.4 440.6L206.9 384L160 384zM464 440C477.3 440 488 450.7 488 464C488 477.3 477.3 488 464 488C450.7 488 440 477.3 440 464C440 450.7 450.7 440 464 440z\"/>\n                </svg>`;\n\n                // when the image is clicked we download the image\n                thumbDiv.addEventListener('click', (e) => {\n                    e.stopPropagation();\n                    e.preventDefault();\n\n                    // prevent multiple downloads of the same image\n                    if (thumbDiv.classList.contains('downloading')) { return; }\n\n                    // show download indicator\n                    this._showDownloadIndicator(thumbDiv);\n\n                    const filename = this._generateFilename(image);\n                    const extnName = \".jpg\";\n\n                    const targetWidth = this._originalImageStyle.width || this.maxWidth;\n                    const targetHeight = this._originalImageStyle.height || this.maxHeight;\n                    const widthNum = parseInt(targetWidth);\n                    const heightNum = parseInt(targetHeight);\n\n                    const downloadUrl = image.url ? `${image.url}?w=${widthNum}&h=${heightNum}&fit=crop` : image.thumb_url;\n                    this._useImage(downloadUrl, filename, extnName, false, thumbDiv);\n                });\n\n                thumbDiv.appendChild(img);\n                thumbDiv.appendChild(attribution);\n                thumbDiv.appendChild(downloadIcon);\n                rowElement.appendChild(thumbDiv);\n            });\n\n            if (append && container && savedScrollPosition > 0) {\n                setTimeout(() => {\n                    container.scrollLeft = savedScrollPosition;\n                }, 0);\n            }\n        },\n\n        _showError: function(message) {\n            const rowElement = this._shadow.querySelector('.phoenix-ribbon-row');\n            if (!rowElement) { return; }\n\n            rowElement.innerHTML = message;\n            rowElement.className = 'phoenix-ribbon-row phoenix-ribbon-error';\n        },\n\n        // file name with which we need to save the image\n        _generateFilename: function(image) {\n            const photographerName = (image.user && image.user.name) || 'Anonymous';\n            const searchTerm = this._currentSearchQuery || 'image';\n\n            // clean the search term and the photograper name to write in file name\n            const cleanSearchTerm = searchTerm.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');\n            const cleanPhotographerName = photographerName.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');\n\n            return `${cleanSearchTerm}-by-${cleanPhotographerName}`;\n        },\n\n        _useImage: function(imageUrl, filename, extnName, isLocalFile, thumbDiv) {\n            // send the message to the editor instance to save the image and update the source code\n            const tagId = this.element.getAttribute(\"data-brackets-id\");\n\n            const messageData = {\n                livePreviewEditEnabled: true,\n                useImage: true,\n                imageUrl: imageUrl,\n                filename: filename,\n                extnName: extnName,\n                element: this.element,\n                tagId: Number(tagId)\n            };\n\n            // if this is a local file we need some more data before sending it to the editor\n            if (isLocalFile) {\n                messageData.isLocalFile = true;\n                // Convert data URL to binary data array for local files\n                const byteCharacters = atob(imageUrl.split(',')[1]);\n                const byteNumbers = new Array(byteCharacters.length);\n                for (let i = 0; i < byteCharacters.length; i++) {\n                    byteNumbers[i] = byteCharacters.charCodeAt(i);\n                }\n                messageData.imageData = byteNumbers;\n            }\n\n            window._Brackets_MessageBroker.send(messageData);\n\n            // if thumbDiv is provided, hide the download indicator after a reasonable timeout\n            // this is to make sure that the indicator is always removed even if there's no explicit success callback\n            if (thumbDiv) {\n                setTimeout(() => {\n                    this._hideDownloadIndicator(thumbDiv);\n                }, 3000);\n            }\n        },\n\n        _handleLocalImageSelection: function(file) {\n            if (!file || !file.type.startsWith('image/')) {\n                return;\n            }\n\n            const reader = new FileReader();\n            reader.onload = (e) => {\n                const imageDataUrl = e.target.result;\n\n                const originalName = file.name;\n                const nameWithoutExt = originalName.substring(0, originalName.lastIndexOf('.')) || originalName;\n                const extension = originalName.substring(originalName.lastIndexOf('.')) || '.jpg';\n\n                // we clean the file name because the file might have some chars which might not be compatible\n                const cleanName = nameWithoutExt.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');\n                const filename = cleanName || 'selected-image';\n\n                // Use the unified _useImage method with isLocalFile flag\n                this._useImage(imageDataUrl, filename, extension, true, null);\n\n                // Close the ribbon after successful selection\n                this.remove();\n            };\n\n            reader.onerror = (error) => {\n                console.error('Something went wrong when reading the image:', error);\n            };\n\n            reader.readAsDataURL(file);\n        },\n\n\n        create: function() {\n            this.remove(); // remove existing ribbon if already present\n\n            // when image ribbon gallery is created we get the original image along with its dimensions\n            // so that on hover in we can show the hovered image and on hover out we can restore the original image\n            this._originalImageSrc = this.element.src;\n            this._originalImageStyle = {\n                width: window.getComputedStyle(this.element).width,\n                height: window.getComputedStyle(this.element).height,\n                objectFit: window.getComputedStyle(this.element).objectFit\n            };\n\n            this._style();\n            window.document.body.appendChild(this.body);\n            this._attachEventHandlers();\n\n            const queryToUse = _imageGalleryCache.currentQuery || this._getDefaultQuery();\n            this._fetchImages(queryToUse);\n            setTimeout(() => this._updateNavButtons(), 0);\n        },\n\n        remove: function () {\n            _imageRibbonGallery = null;\n            if (this.body && this.body.parentNode && this.body.parentNode === window.document.body) {\n                window.document.body.removeChild(this.body);\n                this.body = null;\n            }\n        },\n\n        _showDownloadIndicator: function(thumbDiv) {\n            // add downloading class\n            thumbDiv.classList.add('downloading');\n\n            // create download indicator\n            const indicator = window.document.createElement('div');\n            indicator.className = 'phoenix-download-indicator';\n\n            const spinner = window.document.createElement('div');\n            spinner.className = 'phoenix-download-spinner';\n\n            indicator.appendChild(spinner);\n            thumbDiv.appendChild(indicator);\n        },\n\n        _hideDownloadIndicator: function(thumbDiv) {\n            // remove downloading class\n            thumbDiv.classList.remove('downloading');\n\n            // remove download indicator\n            const indicator = thumbDiv.querySelector('.phoenix-download-indicator');\n            if (indicator) {\n                indicator.remove();\n            }\n        }\n    };\n\n    function Highlight(color, trigger) {\n        this.color = color;\n        this.trigger = !!trigger;\n        this.elements = [];\n        this.selector = \"\";\n    }\n\n    Highlight.prototype = {\n        _elementExists: function (element) {\n            var i;\n            for (i in this.elements) {\n                if (this.elements[i] === element) {\n                    return true;\n                }\n            }\n            return false;\n        },\n        _makeHighlightDiv: function (element, doAnimation) {\n            var elementBounds = element.getBoundingClientRect(),\n                highlight = window.document.createElement(\"div\"),\n                elementStyling = window.getComputedStyle(element),\n                transitionDuration = parseFloat(elementStyling.getPropertyValue('transition-duration')),\n                animationDuration = parseFloat(elementStyling.getPropertyValue('animation-duration'));\n\n            highlight.trackingElement = element; // save which node are we highlighting\n\n            if (transitionDuration) {\n                animateHighlight(transitionDuration);\n            }\n\n            if (animationDuration) {\n                animateHighlight(animationDuration);\n            }\n\n            // Don't highlight elements with 0 width & height\n            if (elementBounds.width === 0 && elementBounds.height === 0) {\n                return;\n            }\n\n            var realElBorder = {\n              right: elementStyling.getPropertyValue('border-right-width'),\n              left: elementStyling.getPropertyValue('border-left-width'),\n              top: elementStyling.getPropertyValue('border-top-width'),\n              bottom: elementStyling.getPropertyValue('border-bottom-width')\n            };\n\n            var borderBox = elementStyling.boxSizing === 'border-box';\n\n            var innerWidth = parseFloat(elementStyling.width),\n                innerHeight = parseFloat(elementStyling.height),\n                outerHeight = innerHeight,\n                outerWidth = innerWidth;\n\n            if (!borderBox) {\n                innerWidth += parseFloat(elementStyling.paddingLeft) + parseFloat(elementStyling.paddingRight);\n                innerHeight += parseFloat(elementStyling.paddingTop) + parseFloat(elementStyling.paddingBottom);\n                outerWidth = innerWidth + parseFloat(realElBorder.right) +\n                parseFloat(realElBorder.left),\n                outerHeight = innerHeight + parseFloat(realElBorder.bottom) + parseFloat(realElBorder.top);\n            }\n\n\n            var visualisations = {\n                horizontal: \"left, right\",\n                vertical: \"top, bottom\"\n            };\n\n            var drawPaddingRect = function(side) {\n              var elStyling = {};\n\n              if (visualisations.horizontal.indexOf(side) >= 0) {\n                elStyling['width'] =  elementStyling.getPropertyValue('padding-' + side);\n                elStyling['height'] = innerHeight + \"px\";\n                elStyling['top'] = 0;\n\n                  if (borderBox) {\n                    elStyling['height'] = innerHeight - parseFloat(realElBorder.top) - parseFloat(realElBorder.bottom) + \"px\";\n                  }\n\n              } else {\n                elStyling['height'] = elementStyling.getPropertyValue('padding-' + side);\n                elStyling['width'] = innerWidth + \"px\";\n                elStyling['left'] = 0;\n\n                  if (borderBox) {\n                    elStyling['width'] = innerWidth - parseFloat(realElBorder.left) - parseFloat(realElBorder.right) + \"px\";\n                  }\n              }\n\n              elStyling[side] = 0;\n              elStyling['position'] = 'absolute';\n\n              return elStyling;\n            };\n\n          var drawMarginRect = function(side) {\n            var elStyling = {};\n\n            var margin = [];\n            margin['right'] = parseFloat(elementStyling.getPropertyValue('margin-right'));\n            margin['top'] = parseFloat(elementStyling.getPropertyValue('margin-top'));\n            margin['bottom'] = parseFloat(elementStyling.getPropertyValue('margin-bottom'));\n            margin['left'] = parseFloat(elementStyling.getPropertyValue('margin-left'));\n\n            if(visualisations['horizontal'].indexOf(side) >= 0) {\n\n              elStyling['width'] = elementStyling.getPropertyValue('margin-' + side);\n              elStyling['height'] = outerHeight + margin['top'] + margin['bottom'] + \"px\";\n              elStyling['top'] = \"-\" + (margin['top'] + parseFloat(realElBorder.top))  + \"px\";\n            } else {\n              elStyling['height'] = elementStyling.getPropertyValue('margin-' + side);\n              elStyling['width'] = outerWidth + \"px\";\n              elStyling['left'] = \"-\" + realElBorder.left;\n            }\n\n            elStyling[side] = \"-\" + (margin[side] + parseFloat(realElBorder[side])) + \"px\";\n            elStyling['position'] = 'absolute';\n\n            return elStyling;\n          };\n\n            var setVisibility = function (el) {\n                if (\n                    !config.remoteHighlight.showPaddingMargin ||\n                    parseInt(el.height, 10) <= 0 ||\n                    parseInt(el.width, 10) <= 0\n                ) {\n                    el.display = 'none';\n                } else {\n                    el.display = 'block';\n                }\n            };\n\n            var mainBoxStyles = config.remoteHighlight.stylesToSet;\n\n            var paddingVisualisations = [\n              drawPaddingRect('top'),\n              drawPaddingRect('right'),\n              drawPaddingRect('bottom'),\n              drawPaddingRect('left')\n            ];\n\n            var marginVisualisations = [\n              drawMarginRect('top'),\n              drawMarginRect('right'),\n              drawMarginRect('bottom'),\n              drawMarginRect('left')\n            ];\n\n            var setupVisualisations = function (arr, config) {\n                var i;\n                for (i = 0; i < arr.length; i++) {\n                    setVisibility(arr[i]);\n\n                    // Applies to every visualisationElement (padding or margin div)\n                    arr[i][\"transform\"] = \"none\";\n                    var el = window.document.createElement(\"div\"),\n                        styles = Object.assign(\n                        {},\n                        config,\n                        arr[i]\n                    );\n\n                    _setStyleValues(styles, el.style);\n\n                    highlight.appendChild(el);\n                }\n            };\n\n            setupVisualisations(\n                marginVisualisations,\n                config.remoteHighlight.marginStyling\n            );\n            setupVisualisations(\n                paddingVisualisations,\n                config.remoteHighlight.paddingStyling\n            );\n\n            highlight.className = HIGHLIGHT_CLASSNAME;\n\n            var offset = _screenOffset(element);\n\n            // some code to find element left/top was removed here. This seems to be relevant to box model\n            // live highlights. firether reading: https://github.com/adobe/brackets/pull/13357/files\n            // we removed this in phoenix because it was throwing the rendering of live highlight boxes in phonix\n            // default project at improper places. Some other cases might fail as the above code said they\n            // introduces that removed computation for fixing some box-model regression. If you are here to fix a\n            // related bug, check history of this changes in git.\n\n            var stylesToSet = {\n                \"left\": offset.left + \"px\",\n                \"top\": offset.top + \"px\",\n                \"width\": elementBounds.width + \"px\",\n                \"height\": elementBounds.height + \"px\",\n                \"z-index\": 2147483647,\n                \"margin\": 0,\n                \"padding\": 0,\n                \"position\": \"absolute\",\n                \"pointer-events\": \"none\",\n                \"box-shadow\": \"0 0 1px #fff\",\n                \"box-sizing\": elementStyling.getPropertyValue('box-sizing'),\n                \"border-right\": elementStyling.getPropertyValue('border-right'),\n                \"border-left\": elementStyling.getPropertyValue('border-left'),\n                \"border-top\": elementStyling.getPropertyValue('border-top'),\n                \"border-bottom\": elementStyling.getPropertyValue('border-bottom'),\n                \"border-color\": config.remoteHighlight.borderColor\n            };\n\n            var mergedStyles = Object.assign({}, stylesToSet,  config.remoteHighlight.stylesToSet);\n\n            var animateStartValues = config.remoteHighlight.animateStartValue;\n\n            var animateEndValues = config.remoteHighlight.animateEndValue;\n\n            var transitionValues = {\n                \"transition-property\": \"opacity, background-color, transform\",\n                \"transition-duration\": \"300ms, 2.3s\"\n            };\n\n            function _setStyleValues(styleValues, obj) {\n                var prop;\n\n                for (prop in styleValues) {\n                    obj.setProperty(prop, styleValues[prop]);\n                }\n            }\n\n            _setStyleValues(mergedStyles, highlight.style);\n            _setStyleValues(\n                doAnimation ? animateStartValues : animateEndValues,\n                highlight.style\n            );\n\n\n            if (doAnimation) {\n                _setStyleValues(transitionValues, highlight.style);\n\n                window.setTimeout(function () {\n                    _setStyleValues(animateEndValues, highlight.style);\n                }, 20);\n            }\n\n            window.document.body.appendChild(highlight);\n        },\n\n        // shouldAutoScroll is whether to scroll page to element if not in view\n        // true when user clicks on the source code of some element, in that case we want to scroll the live preview\n        add: function (element, doAnimation, shouldAutoScroll) {\n            if (this._elementExists(element) || element === window.document) {\n                return;\n            }\n            if (this.trigger) {\n                _trigger(element, \"highlight\", 1);\n            }\n\n            if (shouldAutoScroll && (!window.event || window.event instanceof MessageEvent) && !isInViewport(element)) {\n                var top = getDocumentOffsetTop(element);\n                if (top) {\n                    top -= (window.innerHeight / 2);\n                    window.scrollTo(0, top);\n                }\n            }\n            this.elements.push(element);\n\n            this._makeHighlightDiv(element, doAnimation);\n        },\n\n        clear: function () {\n            var i, highlights = window.document.querySelectorAll(\".\" + HIGHLIGHT_CLASSNAME),\n                body = window.document.body;\n\n            for (i = 0; i < highlights.length; i++) {\n                body.removeChild(highlights[i]);\n            }\n\n            if (this.trigger) {\n                for (i = 0; i < this.elements.length; i++) {\n                    _trigger(this.elements[i], \"highlight\", 0);\n                }\n            }\n\n            this.elements = [];\n        },\n\n        redraw: function () {\n            var i, highlighted;\n\n            // When redrawing a selector-based highlight, run a new selector\n            // query to ensure we have the latest set of elements to highlight.\n            if (this.selector) {\n                highlighted = window.document.querySelectorAll(this.selector);\n            } else {\n                highlighted = this.elements.slice(0);\n            }\n\n            this.clear();\n            for (i = 0; i < highlighted.length; i++) {\n                this.add(highlighted[i], false, false); // 3rd arg is for auto-scroll\n            }\n        }\n    };\n\n    var _localHighlight;\n    var _hoverHighlight;\n    var _clickHighlight;\n    var _nodeInfoBox;\n    var _nodeMoreOptionsBox;\n    var _aiPromptBox;\n    var _imageRibbonGallery;\n    var _setup = false;\n\n    function onMouseOver(event) {\n        if (_validEvent(event)) {\n            const element = event.target;\n            if(isElementEditable(element) && element.nodeType === Node.ELEMENT_NODE ) {\n                _localHighlight.add(element, true, false); // false means no-auto scroll\n            }\n        }\n    }\n\n    function onMouseOut(event) {\n        if (_validEvent(event)) {\n            _localHighlight.clear();\n        }\n    }\n\n    function onMouseMove(event) {\n        onMouseOver(event);\n        window.document.removeEventListener(\"mousemove\", onMouseMove);\n    }\n\n    // helper function to get the current elements highlight mode\n    // this is as per user settings (either click or hover)\n    function getHighlightMode() {\n        return config.elemHighlights ? config.elemHighlights.toLowerCase() : \"hover\";\n    }\n\n    // helper function to check if highlights should show on hover\n    function shouldShowHighlightOnHover() {\n        return getHighlightMode() !== \"click\";\n    }\n\n    // helper function to check if image ribbon gallery should be shown\n    function shouldShowImageRibbon() {\n        if (_imageRibbonGallery) { return false; }\n        return config.imageRibbon !== false;\n    }\n\n    // helper function to clear element background highlighting\n    function clearElementBackground(element) {\n        if (element._originalBackgroundColor !== undefined) {\n            element.style.backgroundColor = element._originalBackgroundColor;\n        } else {\n            // only clear background if it's currently a highlight color, not if it's an original user style\n            const currentBg = element.style.backgroundColor;\n            if (currentBg === \"rgba(0, 162, 255, 0.2)\" || currentBg.includes(\"rgba(0, 162, 255\")) {\n                element.style.backgroundColor = \"\";\n            }\n            // if it's some other color, we just leave it as is - it's likely a user-defined style\n        }\n        delete element._originalBackgroundColor;\n    }\n\n    function onElementHover(event) {\n        // don't want highlighting and stuff when auto scrolling\n        if (_isAutoScrolling) {\n            return;\n        }\n\n        const element = event.target;\n        if(!isElementEditable(element) || element.nodeType !== Node.ELEMENT_NODE) {\n            return false;\n        }\n\n        // if _hoverHighlight is uninitialized, initialize it\n        if (!_hoverHighlight && shouldShowHighlightOnHover()) {\n            _hoverHighlight = new Highlight(\"#c8f9c5\", true);\n        }\n\n        // this is to check the user's settings, if they want to show the elements highlights on hover or click\n        if (_hoverHighlight && shouldShowHighlightOnHover()) {\n            _hoverHighlight.clear();\n\n            // Store original background color to restore on hover out\n            element._originalBackgroundColor = element.style.backgroundColor;\n            element.style.backgroundColor = \"rgba(0, 162, 255, 0.2)\";\n\n            _hoverHighlight.add(element, false, false); // false means no auto-scroll\n\n            // Create info box for the hovered element\n            dismissNodeInfoBox();\n            _nodeInfoBox = new NodeInfoBox(element);\n        }\n    }\n\n    function onElementHoverOut(event) {\n        // don't want highlighting and stuff when auto scrolling\n        if (_isAutoScrolling) {\n            return;\n        }\n\n        const element = event.target;\n        if(isElementEditable(element) && element.nodeType === Node.ELEMENT_NODE) {\n            // this is to check the user's settings, if they want to show the elements highlights on hover or click\n            if (_hoverHighlight && shouldShowHighlightOnHover()) {\n                _hoverHighlight.clear();\n                clearElementBackground(element);\n                dismissNodeInfoBox();\n            }\n        }\n    }\n\n    /**\n     * this function is responsible to select an element in the live preview\n     * @param {Element} element - The DOM element to select\n     */\n    function _selectElement(element) {\n        // dismiss all UI boxes and cleanup previous element state when selecting a different element\n        dismissUIAndCleanupState();\n        dismissImageRibbonGallery();\n        if(!isElementEditable(element)) {\n            return false;\n        }\n\n        // make sure that the element is actually visible to the user\n        if (isElementVisible(element)) {\n            _nodeMoreOptionsBox = new NodeMoreOptionsBox(element);\n            _nodeInfoBox = new NodeInfoBox(element);\n        } else {\n            // Element is hidden, so don't show UI boxes but still apply visual styling\n            _nodeMoreOptionsBox = null;\n        }\n\n        // if the selected element is an image, show the image ribbon gallery (make sure its enabled in preferences)\n        if(element && element.tagName.toLowerCase() === 'img' && shouldShowImageRibbon()) {\n            if (!_imageRibbonGallery) {\n                _imageRibbonGallery = new ImageRibbonGallery(element);\n            }\n        }\n\n        element._originalOutline = element.style.outline;\n        element.style.outline = \"1px solid #4285F4\";\n\n        if (element._originalBackgroundColor === undefined) {\n            element._originalBackgroundColor = element.style.backgroundColor;\n        }\n        element.style.backgroundColor = \"rgba(0, 162, 255, 0.2)\";\n\n        if (_hoverHighlight) {\n            _hoverHighlight.clear();\n            _hoverHighlight.add(element, true, false); // false means no auto-scroll\n        }\n\n        previouslyClickedElement = element;\n    }\n\n    /**\n     * This function handles the click event on the live preview DOM element\n     * this just stops the propagation because otherwise users might not be able to edit buttons or hyperlinks etc\n     * @param {Event} event\n     */\n    function onClick(event) {\n        const element = event.target;\n\n        if(isElementEditable(element)) {\n            event.preventDefault();\n            event.stopPropagation();\n            event.stopImmediatePropagation();\n        }\n    }\n\n    /**\n     * this function handles the double click event\n     * @param {Event} event\n     */\n    function onDoubleClick(event) {\n        const element = event.target;\n        if (isElementEditable(element)) {\n            // because we only want to allow double click text editing where we show the edit option\n            if (_shouldShowEditTextOption(element)) {\n                event.preventDefault();\n                event.stopPropagation();\n                startEditing(element);\n            }\n        }\n    }\n\n    function onKeyUp(event) {\n        if (_setup && !_validEvent(event)) {\n            window.document.removeEventListener(\"keyup\", onKeyUp);\n            window.document.removeEventListener(\"mouseover\", onMouseOver);\n            window.document.removeEventListener(\"mouseout\", onMouseOut);\n            window.document.removeEventListener(\"mousemove\", onMouseMove);\n            _localHighlight.clear();\n            _localHighlight = undefined;\n            _setup = false;\n        }\n    }\n\n    function onKeyDown(event) {\n        if (!_setup && _validEvent(event)) {\n            window.document.addEventListener(\"keyup\", onKeyUp);\n            window.document.addEventListener(\"mouseover\", onMouseOver);\n            window.document.addEventListener(\"mouseout\", onMouseOut);\n            window.document.addEventListener(\"mousemove\", onMouseMove);\n            window.document.addEventListener(\"click\", onClick);\n            _localHighlight = new Highlight(\"#ecc\", true);\n            _setup = true;\n        }\n    }\n\n    // remove active highlights\n    function hideHighlight() {\n        if (_clickHighlight) {\n            _clickHighlight.clear();\n            _clickHighlight = null;\n        }\n        if (_hoverHighlight) {\n            _hoverHighlight.clear();\n        }\n    }\n\n    // highlight an element\n    function highlight(element, clear) {\n        if (!_clickHighlight) {\n            _clickHighlight = new Highlight(\"#cfc\");\n        }\n        if (clear) {\n            _clickHighlight.clear();\n        }\n        if (isElementEditable(element, true) && element.nodeType === Node.ELEMENT_NODE) {\n            _clickHighlight.add(element, true, true); // 3rd arg is for auto-scroll\n        }\n    }\n\n    // highlight a rule\n    function highlightRule(rule) {\n        hideHighlight();\n        var i, nodes = window.document.querySelectorAll(rule);\n\n        for (i = 0; i < nodes.length; i++) {\n            highlight(nodes[i]);\n        }\n        if (_clickHighlight) {\n            _clickHighlight.selector = rule;\n        }\n\n        // select the first valid highlighted element\n        var foundValidElement = false;\n        for (i = 0; i < nodes.length; i++) {\n            if(isElementEditable(nodes[i], true) && nodes[i].tagName !== \"BR\") {\n                _selectElement(nodes[i]);\n                foundValidElement = true;\n                break;\n            }\n        }\n\n        // if no valid element present we dismiss the boxes\n        if (!foundValidElement) {\n            dismissUIAndCleanupState();\n            dismissImageRibbonGallery();\n        }\n    }\n\n    // recreate UI boxes (info box and more options box)\n    function redrawUIBoxes() {\n        if (_nodeMoreOptionsBox) {\n            const element = _nodeMoreOptionsBox.element;\n            _nodeMoreOptionsBox.remove();\n            _nodeMoreOptionsBox = new NodeMoreOptionsBox(element);\n\n            if (_nodeInfoBox) {\n                dismissNodeInfoBox();\n                _nodeInfoBox = new NodeInfoBox(element);\n            }\n        }\n\n        if (_aiPromptBox) {\n            const element = _aiPromptBox.element;\n            _aiPromptBox.remove();\n            _aiPromptBox = new AIPromptBox(element);\n        }\n    }\n\n    // redraw active highlights\n    function redrawHighlights() {\n        if (_clickHighlight) {\n            _clickHighlight.redraw();\n        }\n        if (_hoverHighlight) {\n            _hoverHighlight.redraw();\n        }\n    }\n\n    // just a wrapper function when we need to redraw highlights as well as UI boxes\n    function redrawEverything() {\n        redrawHighlights();\n        redrawUIBoxes();\n    }\n\n    window.addEventListener(\"resize\", redrawEverything);\n\n    // Helper function to dismiss boxes only for elements that don't move with scroll\n    // this is needed for fixed positioned elements because otherwise the boxes will move along with scroll,\n    // but the element stays at position which will lead to drift between the element & boxes\n    function _dismissBoxesForFixedElements() {\n        // first we try more options box, because its position is generally fixed even in overlapping cases\n        if (_nodeMoreOptionsBox && _nodeMoreOptionsBox.element) {\n            const moreOptionsBoxElement = _nodeMoreOptionsBox._shadow.querySelector('.phoenix-more-options-box');\n            if(moreOptionsBoxElement) {\n\n                // get the position of both the moreOptionsBox as well as the element\n                const moreOptionsBoxBounds = moreOptionsBoxElement.getBoundingClientRect();\n                const elementBounds = _nodeMoreOptionsBox.element.getBoundingClientRect();\n\n                // this is to store the prev value, so that we can compare it the second time\n                if(!_nodeMoreOptionsBox._possDifference) {\n                    _nodeMoreOptionsBox._possDifference = moreOptionsBoxBounds.top - elementBounds.top;\n                } else {\n                    const calcNewDifference = moreOptionsBoxBounds.top - elementBounds.top;\n                    const prevDifference = _nodeMoreOptionsBox._possDifference;\n\n                    // 4 is just for pixelated differences\n                    if (Math.abs(calcNewDifference - prevDifference) > 4) {\n                        dismissUIAndCleanupState();\n                    }\n                }\n            }\n        } else if (_nodeInfoBox && _nodeInfoBox.element) {\n            // if more options box didn't exist, we check with info box (logic is same)\n            const infoBoxElement = _nodeInfoBox._shadow.querySelector('.phoenix-node-info-box');\n            if (infoBoxElement) {\n                // here just we make sure that the element is same\n                if(!_nodeInfoBox._prevElement) {\n                    _nodeInfoBox._prevElement = _nodeInfoBox.element;\n                } else if(_nodeInfoBox._prevElement !== _nodeInfoBox.element) {\n                    return;\n                } else {\n                    const infoBoxBounds = infoBoxElement.getBoundingClientRect();\n                    const elementBounds = _nodeInfoBox.element.getBoundingClientRect();\n\n                    if(!_nodeInfoBox._possDifference) {\n                        _nodeInfoBox._possDifference = infoBoxBounds.top - elementBounds.top;\n                    } else {\n                        const calcNewDifference = infoBoxBounds.top - elementBounds.top;\n                        const prevDifference = _nodeInfoBox._possDifference;\n\n                        if (Math.abs(calcNewDifference - prevDifference) > 4) {\n                            dismissUIAndCleanupState();\n                        }\n                    }\n                }\n            }\n        }\n    }\n\n    function _scrollHandler(e) {\n        // Document scrolls can be updated immediately. Any other scrolls\n        // need to be updated on a timer to ensure the layout is correct.\n        if (e.target === window.document) {\n            redrawHighlights();\n            // need to dismiss the box if the elements are fixed, otherwise they drift at times\n            _dismissBoxesForFixedElements();\n        } else {\n            if (_localHighlight || _clickHighlight || _hoverHighlight) {\n                window.setTimeout(redrawHighlights, 0);\n            }\n            _dismissBoxesForFixedElements();\n        }\n    }\n\n    window.addEventListener(\"scroll\", _scrollHandler, true);\n\n    /**\n     * Constructor\n     * @param {Document} htmlDocument\n     */\n    function DOMEditHandler(htmlDocument) {\n        this.htmlDocument = htmlDocument;\n        this.rememberedNodes = null;\n        this.entityParseParent = htmlDocument.createElement(\"div\");\n    }\n\n    /**\n     * @private\n     * Find the first matching element with the specified data-brackets-id\n     * @param {string} id\n     * @return {Element}\n     */\n    DOMEditHandler.prototype._queryBracketsID = function (id) {\n        if (!id) {\n            return null;\n        }\n\n        if (this.rememberedNodes && this.rememberedNodes[id]) {\n            return this.rememberedNodes[id];\n        }\n\n        var results = this.htmlDocument.querySelectorAll(\"[data-brackets-id='\" + id + \"']\");\n        return results && results[0];\n    };\n\n    /**\n     * @private\n     * Insert a new child element\n     * @param {Element} targetElement Parent element already in the document\n     * @param {Element} childElement New child element\n     * @param {Object} edit\n     */\n    DOMEditHandler.prototype._insertChildNode = function (targetElement, childElement, edit) {\n        var before = this._queryBracketsID(edit.beforeID),\n            after  = this._queryBracketsID(edit.afterID);\n\n        if (edit.firstChild) {\n            before = targetElement.firstChild;\n        } else if (edit.lastChild) {\n            after = targetElement.lastChild;\n        }\n\n        if (before) {\n            targetElement.insertBefore(childElement, before);\n        } else if (after && (after !== targetElement.lastChild)) {\n            targetElement.insertBefore(childElement, after.nextSibling);\n        } else {\n            targetElement.appendChild(childElement);\n        }\n    };\n\n    /**\n     * @private\n     * Given a string containing encoded entity references, returns the string with the entities decoded.\n     * @param {string} text The text to parse.\n     * @return {string} The decoded text.\n     */\n    DOMEditHandler.prototype._parseEntities = function (text) {\n        // Kind of a hack: just set the innerHTML of a div to the text, which will parse the entities, then\n        // read the content out.\n        var result;\n        this.entityParseParent.innerHTML = text;\n        result = this.entityParseParent.textContent;\n        this.entityParseParent.textContent = \"\";\n        return result;\n    };\n\n    /**\n     * @private\n     * @param {Node} node\n     * @return {boolean} true if node expects its content to be raw text (not parsed for entities) according to the HTML5 spec.\n     */\n    function _isRawTextNode(node) {\n        return (node.nodeType === Node.ELEMENT_NODE && /script|style|noscript|noframes|noembed|iframe|xmp/i.test(node.tagName));\n    }\n\n    /**\n     * @private\n     * Replace a range of text and comment nodes with an optional new text node\n     * @param {Element} targetElement\n     * @param {Object} edit\n     */\n    DOMEditHandler.prototype._textReplace = function (targetElement, edit) {\n        function prevIgnoringHighlights(node) {\n            do {\n                node = node.previousSibling;\n            } while (node && node.className === HIGHLIGHT_CLASSNAME);\n            return node;\n        }\n        function nextIgnoringHighlights(node) {\n            do {\n                node = node.nextSibling;\n            } while (node && node.className === HIGHLIGHT_CLASSNAME);\n            return node;\n        }\n        function lastChildIgnoringHighlights(node) {\n            node = (node.childNodes.length ? node.childNodes.item(node.childNodes.length - 1) : null);\n            if (node && node.className === HIGHLIGHT_CLASSNAME) {\n                node = prevIgnoringHighlights(node);\n            }\n            return node;\n        }\n\n        var start           = (edit.afterID)  ? this._queryBracketsID(edit.afterID)  : null,\n            startMissing    = edit.afterID && !start,\n            end             = (edit.beforeID) ? this._queryBracketsID(edit.beforeID) : null,\n            endMissing      = edit.beforeID && !end,\n            moveNext        = start && nextIgnoringHighlights(start),\n            current         = moveNext || (end && prevIgnoringHighlights(end)) || lastChildIgnoringHighlights(targetElement),\n            next,\n            textNode        = (edit.content !== undefined) ? this.htmlDocument.createTextNode(_isRawTextNode(targetElement) ? edit.content : this._parseEntities(edit.content)) : null,\n            lastRemovedWasText,\n            isText;\n\n        // remove all nodes inside the range\n        while (current && (current !== end)) {\n            isText = current.nodeType === Node.TEXT_NODE;\n\n            // if start is defined, delete following text nodes\n            // if start is not defined, delete preceding text nodes\n            next = (moveNext) ? nextIgnoringHighlights(current) : prevIgnoringHighlights(current);\n\n            // only delete up to the nearest element.\n            // if the start/end tag was deleted in a prior edit, stop removing\n            // nodes when we hit adjacent text nodes\n            if ((current.nodeType === Node.ELEMENT_NODE) ||\n                    ((startMissing || endMissing) && (isText && lastRemovedWasText))) {\n                break;\n            } else {\n                lastRemovedWasText = isText;\n\n                if (current.remove) {\n                    current.remove();\n                } else if (current.parentNode && current.parentNode.removeChild) {\n                    current.parentNode.removeChild(current);\n                }\n                current = next;\n            }\n        }\n\n        if (textNode) {\n            // OK to use nextSibling here (not nextIgnoringHighlights) because we do literally\n            // want to insert immediately after the start tag.\n            if (start && start.nextSibling) {\n                targetElement.insertBefore(textNode, start.nextSibling);\n            } else if (end) {\n                targetElement.insertBefore(textNode, end);\n            } else {\n                targetElement.appendChild(textNode);\n            }\n        }\n    };\n\n    /**\n     * @private\n     * Apply an array of DOM edits to the document\n     * @param {Array.<Object>} edits\n     */\n    DOMEditHandler.prototype.apply = function (edits) {\n        var targetID,\n            targetElement,\n            childElement,\n            self = this;\n\n        this.rememberedNodes = {};\n\n        edits.forEach(function (edit) {\n            var editIsSpecialTag = edit.type === \"elementInsert\" && (edit.tag === \"html\" || edit.tag === \"head\" || edit.tag === \"body\");\n\n            if (edit.type === \"rememberNodes\") {\n                edit.tagIDs.forEach(function (tagID) {\n                    var node = self._queryBracketsID(tagID);\n                    self.rememberedNodes[tagID] = node;\n                    if (node.remove) {\n                        node.remove();\n                    } else if (node.parentNode && node.parentNode.removeChild) {\n                        node.parentNode.removeChild(node);\n                    }\n                });\n                return;\n            }\n\n            targetID = edit.type.match(/textReplace|textDelete|textInsert|elementInsert|elementMove/) ? edit.parentID : edit.tagID;\n            targetElement = self._queryBracketsID(targetID);\n\n            if (!targetElement && !editIsSpecialTag) {\n                console.error(\"data-brackets-id=\" + targetID + \" not found\");\n                return;\n            }\n\n            switch (edit.type) {\n            case \"attrChange\":\n            case \"attrAdd\":\n                targetElement.setAttribute(edit.attribute, self._parseEntities(edit.value));\n                break;\n            case \"attrDelete\":\n                targetElement.removeAttribute(edit.attribute);\n                break;\n            case \"elementDelete\":\n                if (targetElement.remove) {\n                    targetElement.remove();\n                } else if (targetElement.parentNode && targetElement.parentNode.removeChild) {\n                    targetElement.parentNode.removeChild(targetElement);\n                }\n                break;\n            case \"elementInsert\":\n                childElement = null;\n                if (editIsSpecialTag) {\n                    // If we already have one of these elements (which we should), then\n                    // just copy the attributes and set the ID.\n                    childElement = self.htmlDocument[edit.tag === \"html\" ? \"documentElement\" : edit.tag];\n                    if (!childElement) {\n                        // Treat this as a normal insertion.\n                        editIsSpecialTag = false;\n                    }\n                }\n                if (!editIsSpecialTag) {\n                    childElement = self.htmlDocument.createElement(edit.tag);\n                }\n\n                Object.keys(edit.attributes).forEach(function (attr) {\n                    childElement.setAttribute(attr, self._parseEntities(edit.attributes[attr]));\n                });\n                childElement.setAttribute(\"data-brackets-id\", edit.tagID);\n\n                if (!editIsSpecialTag) {\n                    self._insertChildNode(targetElement, childElement, edit);\n                }\n                break;\n            case \"elementMove\":\n                childElement = self._queryBracketsID(edit.tagID);\n                self._insertChildNode(targetElement, childElement, edit);\n                break;\n            case \"textInsert\":\n                var textElement = self.htmlDocument.createTextNode(_isRawTextNode(targetElement) ? edit.content : self._parseEntities(edit.content));\n                self._insertChildNode(targetElement, textElement, edit);\n                break;\n            case \"textReplace\":\n            case \"textDelete\":\n                self._textReplace(targetElement, edit);\n                break;\n            }\n        });\n\n        this.rememberedNodes = {};\n\n        // update highlight after applying diffs\n        redrawEverything();\n    };\n\n    function applyDOMEdits(edits) {\n        _editHandler.apply(edits);\n    }\n\n    function updateConfig(newConfig) {\n        const oldConfig = config;\n        config = JSON.parse(newConfig);\n\n        // Determine if configuration has changed significantly\n        const oldHighlightMode = oldConfig.elemHighlights ? oldConfig.elemHighlights.toLowerCase() : \"hover\";\n        const newHighlightMode = getHighlightMode();\n        const highlightModeChanged = oldHighlightMode !== newHighlightMode;\n        const isProStatusChanged = oldConfig.isProUser !== config.isProUser;\n        const highlightSettingChanged = oldConfig.highlight !== config.highlight;\n        const imageRibbonJustEnabled = !oldConfig.imageRibbon && config.imageRibbon;\n\n        // Handle significant configuration changes\n        if (highlightModeChanged || isProStatusChanged || highlightSettingChanged) {\n            _handleConfigurationChange();\n        }\n\n        // if user enabled the image ribbon setting and an image is selected, then we show the image ribbon\n        if (imageRibbonJustEnabled && previouslyClickedElement &&\n            previouslyClickedElement.tagName.toLowerCase() === 'img') {\n            if (!_imageRibbonGallery) {\n                _imageRibbonGallery = new ImageRibbonGallery(previouslyClickedElement);\n            }\n        }\n\n        _updateEventListeners();\n\n        return JSON.stringify(config);\n    }\n\n    /**\n     * when config is changed we clear all the highlighting and stuff\n     */\n    function _handleConfigurationChange() {\n        if (_hoverHighlight) {\n            _hoverHighlight.clear();\n        }\n        cleanupPreviousElementState();\n        const allElements = window.document.querySelectorAll(\"[data-brackets-id]\");\n        for (let i = 0; i < allElements.length; i++) {\n            if (allElements[i]._originalBackgroundColor !== undefined) {\n                clearElementBackground(allElements[i]);\n            }\n        }\n        dismissUIAndCleanupState();\n    }\n\n    /**\n     * Update event listeners based on current configuration\n     */\n    function _updateEventListeners() {\n        window.document.removeEventListener(\"mouseover\", onElementHover);\n        window.document.removeEventListener(\"mouseout\", onElementHoverOut);\n        if (config.highlight || (config.isProUser && shouldShowHighlightOnHover())) {\n            window.document.addEventListener(\"mouseover\", onElementHover);\n            window.document.addEventListener(\"mouseout\", onElementHoverOut);\n        }\n    }\n\n    /**\n     * This function checks if there are any live preview boxes currently visible\n     * @return {boolean} true if any boxes are visible, false otherwise\n     */\n    function hasVisibleLivePreviewBoxes() {\n        return _nodeMoreOptionsBox !== null ||\n                _nodeInfoBox !== null ||\n                _aiPromptBox !== null ||\n                previouslyClickedElement !== null;\n    }\n\n    /**\n     * Helper function to dismiss NodeMoreOptionsBox if it exists\n     * @return {boolean} true if box was dismissed, false if it didn't exist\n     */\n    function dismissNodeMoreOptionsBox() {\n        if (_nodeMoreOptionsBox) {\n            _nodeMoreOptionsBox.remove();\n            _nodeMoreOptionsBox = null;\n            return true;\n        }\n        return false;\n    }\n\n    /**\n     * Helper function to dismiss NodeInfoBox if it exists\n     * @return {boolean} true if box was dismissed, false if it didn't exist\n     */\n    function dismissNodeInfoBox() {\n        if (_nodeInfoBox) {\n            _nodeInfoBox.remove();\n            _nodeInfoBox = null;\n            return true;\n        }\n        return false;\n    }\n\n    /**\n     * Helper function to dismiss AIPromptBox if it exists\n     * @return {boolean} true if box was dismissed, false if it didn't exist\n     */\n    function dismissAIPromptBox() {\n        if (_aiPromptBox) {\n            _aiPromptBox.remove();\n            _aiPromptBox = null;\n            return true;\n        }\n        return false;\n    }\n\n    /**\n     * to dismiss the image ribbon gallery if its available\n     */\n    function dismissImageRibbonGallery() {\n        if (_imageRibbonGallery) {\n            _imageRibbonGallery.remove();\n            _imageRibbonGallery = null;\n            return true;\n        }\n        return false;\n    }\n\n    /**\n     * Helper function to dismiss all UI boxes at once\n     * @return {boolean} true if any boxes were dismissed, false otherwise\n     */\n    function dismissAllUIBoxes() {\n        let dismissed = false;\n        dismissed = dismissNodeMoreOptionsBox() || dismissed;\n        dismissed = dismissAIPromptBox() || dismissed;\n        dismissed = dismissNodeInfoBox() || dismissed;\n        return dismissed;\n    }\n\n    /**\n     * Helper function to cleanup previously clicked element highlighting and state\n     * @return {boolean} true if cleanup was performed, false if no element to cleanup\n     */\n    function cleanupPreviousElementState() {\n        if (previouslyClickedElement) {\n            if (previouslyClickedElement._originalOutline !== undefined) {\n                previouslyClickedElement.style.outline = previouslyClickedElement._originalOutline;\n            } else {\n                previouslyClickedElement.style.outline = \"\";\n            }\n            delete previouslyClickedElement._originalOutline;\n\n            clearElementBackground(previouslyClickedElement);\n            if (_hoverHighlight) {\n                _hoverHighlight.clear();\n            }\n\n            previouslyClickedElement = null;\n            return true;\n        }\n        return false;\n    }\n\n    /**\n     * This function dismisses all UI elements and cleans up application state\n     * Called when user presses Esc key, clicks on HTML/Body tags, or other dismissal events\n     * @return {boolean} true if any cleanup was performed, false otherwise\n     */\n    function dismissUIAndCleanupState() {\n        let dismissed = false;\n\n        // Dismiss all UI boxes\n        dismissed = dismissAllUIBoxes() || dismissed;\n\n        // Cleanup previously clicked element state and highlighting\n        dismissed = cleanupPreviousElementState() || dismissed;\n\n        return dismissed;\n    }\n\n\n    /**\n     * This function is responsible to move the cursor to the end of the text content when we start editing\n     * @param {DOMElement} element\n     */\n    function moveCursorToEnd(selection, element) {\n        const range = document.createRange();\n        range.selectNodeContents(element);\n        range.collapse(false);\n        selection.removeAllRanges();\n        selection.addRange(range);\n    }\n\n    // Function to handle direct editing of elements in the live preview\n    function startEditing(element) {\n        if (!isElementEditable(element)) {\n            return;\n        }\n\n        // Make the element editable\n        element.setAttribute(\"contenteditable\", \"true\");\n        element.focus();\n        // to compare with the new text content, if same we don't make any changes in the editor area\n        const oldContent = element.textContent;\n\n        // Move cursor to end if no existing selection\n        const selection = window.getSelection();\n        if (selection.rangeCount === 0 || selection.isCollapsed) {\n            moveCursorToEnd(selection, element);\n        }\n\n        dismissUIAndCleanupState();\n\n        // flag to check if escape is pressed, if pressed we prevent onBlur from handling it as keydown already handles\n        let isEscapePressed = false;\n\n        function onBlur() {\n            // Small delay so that keydown can handle things first\n            setTimeout(() => {\n                if (isEscapePressed) {\n                    isEscapePressed = false;\n                    finishEditingCleanup(element);\n                    return;\n                }\n\n                const newContent = element.textContent;\n                if (oldContent !== newContent) {\n                    finishEditing(element);\n                } else { // if same content, we just cleanup things\n                    finishEditingCleanup(element);\n                }\n            }, 10);\n        }\n\n        function onKeyDown(event) {\n            if (event.key === \"Escape\") {\n                isEscapePressed = true;\n                // Cancel editing\n                event.preventDefault();\n                const newContent = element.textContent;\n                if (oldContent !== newContent) {\n                    finishEditing(element, false); // false means that the edit operation was cancelled\n                } else { // no content change we can avoid sending details to the editor\n                    finishEditingCleanup(element);\n                }\n            } else if (event.key === \"Enter\" && !event.shiftKey) {\n                isEscapePressed = false;\n                // Finish editing on Enter (unless Shift is held)\n                event.preventDefault();\n                finishEditing(element);\n            } else if ((event.key === \" \" || event.key === \"Spacebar\") && element.tagName.toLowerCase() === 'button') {\n                event.preventDefault();\n                document.execCommand(\"insertText\", false, \" \");\n            }\n        }\n\n        element.addEventListener(\"blur\", onBlur);\n        element.addEventListener(\"keydown\", onKeyDown);\n\n        // Store the event listeners for later removal\n        element._editListeners = {\n            blur: onBlur,\n            keydown: onKeyDown\n        };\n    }\n\n    function finishEditingCleanup(element) {\n        if (!isElementEditable(element) || !element.hasAttribute(\"contenteditable\")) {\n            return;\n        }\n\n        // Remove contenteditable attribute\n        element.removeAttribute(\"contenteditable\");\n        dismissUIAndCleanupState();\n\n        // Remove event listeners\n        if (element._editListeners) {\n            element.removeEventListener(\"blur\", element._editListeners.blur);\n            element.removeEventListener(\"keydown\", element._editListeners.keydown);\n            delete element._editListeners;\n        }\n    }\n\n    // Function to finish editing and apply changes\n    // isEditSuccessful: this is a boolean value, defaults to true. false only when the edit operation is cancelled\n    function finishEditing(element, isEditSuccessful = true) {\n        finishEditingCleanup(element);\n\n        const tagId = element.getAttribute(\"data-brackets-id\");\n        window._Brackets_MessageBroker.send({\n            livePreviewEditEnabled: true,\n            livePreviewTextEdit: true,\n            element: element,\n            newContent: element.outerHTML,\n            tagId: Number(tagId),\n            isEditSuccessful: isEditSuccessful\n        });\n    }\n\n    // init\n    _editHandler = new DOMEditHandler(window.document);\n\n    function registerHandlers() {\n        // Always remove existing listeners first to avoid duplicates\n        window.document.removeEventListener(\"mouseover\", onElementHover);\n        window.document.removeEventListener(\"mouseout\", onElementHoverOut);\n        window.document.removeEventListener(\"click\", onClick);\n        window.document.removeEventListener(\"dblclick\", onDoubleClick);\n        window.document.removeEventListener(\"dragover\", onDragOver);\n        window.document.removeEventListener(\"drop\", onDrop);\n        window.document.removeEventListener(\"dragleave\", onDragLeave);\n        window.document.removeEventListener(\"keydown\", onKeyDown);\n\n        if (config.isProUser) {\n            // Initialize hover highlight with Chrome-like colors\n            _hoverHighlight = new Highlight(\"#c8f9c5\", true); // Green similar to Chrome's padding color\n\n            // Initialize click highlight with animation\n            _clickHighlight = new Highlight(\"#cfc\", true); // Light green for click highlight\n\n            window.document.addEventListener(\"mouseover\", onElementHover);\n            window.document.addEventListener(\"mouseout\", onElementHoverOut);\n            window.document.addEventListener(\"click\", onClick);\n            window.document.addEventListener(\"dblclick\", onDoubleClick);\n            window.document.addEventListener(\"dragover\", onDragOver);\n            window.document.addEventListener(\"drop\", onDrop);\n            window.document.addEventListener(\"dragleave\", onDragLeave);\n            window.document.addEventListener(\"keydown\", onKeyDown);\n        } else {\n            // Clean up any existing UI when edit features are disabled\n            dismissUIAndCleanupState();\n        }\n    }\n\n    registerHandlers();\n\n    return {\n        \"DOMEditHandler\"        : DOMEditHandler,\n        \"hideHighlight\"         : hideHighlight,\n        \"highlight\"             : highlight,\n        \"highlightRule\"         : highlightRule,\n        \"redrawHighlights\"      : redrawHighlights,\n        \"redrawEverything\"      : redrawEverything,\n        \"applyDOMEdits\"         : applyDOMEdits,\n        \"updateConfig\"          : updateConfig,\n        \"startEditing\"          : startEditing,\n        \"finishEditing\"         : finishEditing,\n        \"hasVisibleLivePreviewBoxes\" : hasVisibleLivePreviewBoxes,\n        \"dismissUIAndCleanupState\" : dismissUIAndCleanupState,\n        \"dismissImageRibbonGallery\" : dismissImageRibbonGallery,\n        \"registerHandlers\" : registerHandlers\n    };\n}\n"],"file":"RemoteFunctions.js"}