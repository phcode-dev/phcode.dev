define(function(require,exports,module){const HTMLInstrumentation=require("LiveDevelopment/MultiBrowserImpl/language/HTMLInstrumentation"),LiveDevMultiBrowser=require("LiveDevelopment/LiveDevMultiBrowser"),CodeMirror=require("thirdparty/CodeMirror/lib/codemirror"),ProjectManager=require("project/ProjectManager"),FileSystem=require("filesystem/FileSystem"),PathUtils=require("thirdparty/path-utils/path-utils"),ProDialogs=require("services/pro-dialogs"),KernalModeTrust=window.KernalModeTrust;if(!KernalModeTrust)throw new Error("LivePreviewEdit.js should have access to KernalModeTrust. Cannot boot without trust ring");function _syncTextContentChanges(oldContent,newContent){const parser=new DOMParser,oldDoc=parser.parseFromString(oldContent,"text/html"),newDoc=parser.parseFromString(newContent,"text/html"),oldRoot=oldDoc.body,newRoot=newDoc.body;function cleanClonedElement(clonedElement){if(clonedElement.nodeType===Node.ELEMENT_NODE){const attrs=["data-brackets-id","data-ld-highlight"];attrs.forEach(attr=>clonedElement.removeAttribute(attr)),clonedElement.querySelectorAll(attrs.map(a=>`[${a}]`).join(",")).forEach(el=>attrs.forEach(attr=>el.removeAttribute(attr)))}return clonedElement}function syncText(oldNode,newNode){if(oldNode&&newNode)if(oldNode.nodeType!==Node.TEXT_NODE||newNode.nodeType!==Node.TEXT_NODE){if(oldNode.nodeType===Node.ELEMENT_NODE&&newNode.nodeType===Node.ELEMENT_NODE){const oldChildren=Array.from(oldNode.childNodes),newChildren=Array.from(newNode.childNodes),maxLen=Math.max(oldChildren.length,newChildren.length);for(let i=0;i<maxLen;i++){const oldChild=oldChildren[i],newChild=newChildren[i];if(!oldChild&&newChild){const cloned=newChild.cloneNode(!0);oldNode.appendChild(cleanClonedElement(cloned))}else if(oldChild&&!newChild)oldNode.removeChild(oldChild);else if(oldChild.nodeType===newChild.nodeType&&oldChild.nodeType===Node.ELEMENT_NODE&&oldChild.tagName===newChild.tagName)syncText(oldChild,newChild);else if(oldChild.nodeType===Node.TEXT_NODE&&newChild.nodeType===Node.TEXT_NODE)oldChild.nodeValue!==newChild.nodeValue&&(oldChild.nodeValue=newChild.nodeValue);else{const cloned=newChild.cloneNode(!0);oldNode.replaceChild(cleanClonedElement(cloned),oldChild)}}}}else oldNode.nodeValue!==newNode.nodeValue&&(oldNode.nodeValue=newNode.nodeValue)}const oldEls=Array.from(oldRoot.children),newEls=Array.from(newRoot.children);for(let i=0;i<Math.min(oldEls.length,newEls.length);i++)syncText(oldEls[i],newEls[i]);return oldRoot.innerHTML}function _getEditorAndValidate(tagId){const currLiveDoc=LiveDevMultiBrowser.getCurrentLiveDoc();return currLiveDoc&&currLiveDoc.editor&&(void 0===tagId||tagId)?currLiveDoc.editor:null}function _getElementRange(editor,tagId){const startRange=HTMLInstrumentation.getPositionFromTagId(editor,tagId);if(!startRange)return null;const endRange=CodeMirror.findMatchingTag(editor._codeMirror,startRange.from);if(!endRange)return null;const startPos=startRange.from,endPos=endRange.close?endRange.close.to:endRange.open.to;return{startPos:startPos,endPos:endPos}}function _editTextInSource(message){const editor=_getEditorAndValidate(message.tagId);if(!editor)return;const range=_getElementRange(editor,message.tagId);if(!range)return;const{startPos:startPos,endPos:endPos}=range,text=editor.getTextBetween(startPos,endPos);if(message.isEditSuccessful){const finalText=_syncTextContentChanges(text,message.newContent);editor.replaceRange(finalText,startPos,endPos)}else editor.document.batchOperation(function(){editor.replaceRange(text,startPos,endPos),setTimeout(()=>{editor.undo()},0)})}function _duplicateElementInSourceByTagId(tagId){const editor=_getEditorAndValidate(tagId);if(!editor)return;const range=_getElementRange(editor,tagId);if(!range)return;const{startPos:startPos,endPos:endPos}=range,text=editor.getTextBetween(startPos,endPos),indent=editor.getTextBetween({line:startPos.line,ch:0},startPos);editor.document.batchOperation(function(){if(""===indent.trim()){const insertPos={line:startPos.line+(endPos.line-startPos.line+1),ch:0};editor.replaceRange("\n",endPos),editor.replaceRange(indent+text,insertPos)}else editor.replaceRange(text,startPos)})}function _deleteElementInSourceByTagId(tagId){const editor=_getEditorAndValidate(tagId);if(!editor)return;const range=_getElementRange(editor,tagId);if(!range)return;const{startPos:startPos,endPos:endPos}=range;editor.document.batchOperation(function(){if(editor.replaceRange("",startPos,endPos),0!==startPos.line&&!editor.getLine(startPos.line).trim()){const prevLineText=editor.getLine(startPos.line-1),chPrevLine=prevLineText?prevLineText.length:0;editor.replaceRange("",{line:startPos.line-1,ch:chPrevLine},startPos)}})}function _cleanupAfterRemoval(editor,range){const lineToCheck=range.from.line;if(lineToCheck<editor.lineCount()){const currentLineText=editor.getLine(lineToCheck);if(currentLineText&&""===currentLineText.trim()){const lineStart={line:lineToCheck,ch:0},lineEnd={line:lineToCheck+1,ch:0};editor.replaceRange("",lineStart,lineEnd)}}if(lineToCheck>0){const prevLineText=editor.getLine(lineToCheck-1);if(prevLineText&&""===prevLineText.trim()){const lineStart={line:lineToCheck-1,ch:0},lineEnd={line:lineToCheck,ch:0};editor.replaceRange("",lineStart,lineEnd)}}}function _insertElementWithIndentation(editor,insertPos,insertAfterMode,targetIndent,sourceText){if(insertAfterMode)editor.replaceRange("\n"+targetIndent+sourceText,insertPos);else{const insertLine=insertPos.line,lineStart={line:insertLine,ch:0},currentLine=editor.getLine(insertLine);currentLine&&""===currentLine.trim()?editor.replaceRange(targetIndent+sourceText,lineStart,{line:insertLine,ch:currentLine.length}):editor.replaceRange(targetIndent+sourceText+"\n",lineStart)}}function _targetInsideSource(source,target){return(source.from.line<target.from.line||source.from.line===target.from.line&&source.from.ch<=target.from.ch)&&(source.to.line>target.to.line||source.to.line===target.to.line&&source.to.ch>=target.to.ch)}function _moveElementInSource(sourceId,targetId,insertAfter,insertInside=!1){const editor=_getEditorAndValidate(sourceId);if(!editor||!targetId)return;const sourceRange=_getElementRange(editor,sourceId);if(!sourceRange)return;const targetRange=_getElementRange(editor,targetId);if(!targetRange)return;const sourceRangeObj={from:sourceRange.startPos,to:sourceRange.endPos},targetRangeObj={from:targetRange.startPos,to:targetRange.endPos};if(_targetInsideSource(sourceRangeObj,targetRangeObj))return;const sourceText=editor.getTextBetween(sourceRangeObj.from,sourceRangeObj.to);let targetIndent=editor.getTextBetween({line:targetRangeObj.from.line,ch:0},targetRangeObj.from);if(targetIndent&&""!==targetIndent.trim()){let indentLength=targetIndent.search(/\S/);-1===indentLength&&(indentLength=targetIndent.length),targetIndent=" ".repeat(indentLength)}const sourceBeforeTarget=sourceRangeObj.from.line<targetRangeObj.from.line||sourceRangeObj.from.line===targetRangeObj.from.line&&sourceRangeObj.from.ch<targetRangeObj.from.ch;editor.document.batchOperation(function(){if(sourceBeforeTarget){if(insertInside){const matchingTagInfo=CodeMirror.findMatchingTag(editor._codeMirror,targetRangeObj.from);if(matchingTagInfo&&matchingTagInfo.open){const insertPos={line:matchingTagInfo.open.to.line,ch:matchingTagInfo.open.to.ch},indentInfo=editor._detectIndent(),childIndent=targetIndent+indentInfo.indent;_insertElementWithIndentation(editor,insertPos,!0,childIndent,sourceText)}}else if(insertAfter){const insertPos={line:targetRangeObj.to.line,ch:targetRangeObj.to.ch};_insertElementWithIndentation(editor,insertPos,!0,targetIndent,sourceText)}else _insertElementWithIndentation(editor,targetRangeObj.from,!1,targetIndent,sourceText);const updatedSourceRange=_getElementRange(editor,sourceId);if(updatedSourceRange){const updatedSourceRangeObj={from:updatedSourceRange.startPos,to:updatedSourceRange.endPos};editor.replaceRange("",updatedSourceRangeObj.from,updatedSourceRangeObj.to),_cleanupAfterRemoval(editor,updatedSourceRangeObj)}}else{const originalSourceRange={...sourceRangeObj};editor.replaceRange("",sourceRangeObj.from,sourceRangeObj.to),_cleanupAfterRemoval(editor,originalSourceRange);const updatedTargetRange=_getElementRange(editor,targetId);if(!updatedTargetRange)return;const updatedTargetRangeObj={from:updatedTargetRange.startPos,to:updatedTargetRange.endPos};if(insertInside){const matchingTagInfo=CodeMirror.findMatchingTag(editor._codeMirror,updatedTargetRangeObj.from);if(matchingTagInfo&&matchingTagInfo.open){const insertPos={line:matchingTagInfo.open.to.line,ch:matchingTagInfo.open.to.ch},indentInfo=editor._detectIndent(),childIndent=targetIndent+indentInfo.indent;_insertElementWithIndentation(editor,insertPos,!0,childIndent,sourceText)}}else if(insertAfter){const insertPos={line:updatedTargetRangeObj.to.line,ch:updatedTargetRangeObj.to.ch};_insertElementWithIndentation(editor,insertPos,!0,targetIndent,sourceText)}else _insertElementWithIndentation(editor,updatedTargetRangeObj.from,!1,targetIndent,sourceText)}})}function handleUndoRedoOperation(undoOrRedo){const editor=_getEditorAndValidate();editor&&("undo"===undoOrRedo?editor.undo():"redo"===undoOrRedo&&editor.redo())}function _getRequiredDataForAI(message){const editor=_getEditorAndValidate(message.tagId);if(!editor)return;const range=_getElementRange(editor,message.tagId);if(!range)return;const{startPos:startPos,endPos:endPos}=range,text=editor.getTextBetween(startPos,endPos),fileName=editor.document.file.name,filePath=editor.document.file.fullPath,AIData={editor:editor,fileName:fileName,filePath:filePath,tagId:message.tagId,range:{startPos:startPos,endPos:endPos},text:text,prompt:message.prompt,model:message.selectedModel};return AIData}async function _editWithAI(message){const AIData=_getRequiredDataForAI(message),aiEntitlement=await KernalModeTrust.EntitlementsManager.getAIEntitlement();aiEntitlement.activated?console.log(AIData):ProDialogs.showAIUpsellDialog(aiEntitlement)}function getUniqueFilename(basePath,filename,extnName){let counter=0,uniqueFilename=filename+extnName;function checkAndIncrement(){const filePath=basePath+uniqueFilename,file=FileSystem.getFileForPath(filePath);return new Promise(resolve=>{file.exists((err,exists)=>{exists?(uniqueFilename=`${filename}-${++counter}${extnName}`,checkAndIncrement().then(resolve)):resolve(uniqueFilename)})})}return checkAndIncrement()}function _updateImageSrcAttribute(tagId,newSrcValue){const editor=_getEditorAndValidate(tagId);if(!editor)return;const range=_getElementRange(editor,tagId);if(!range)return;const{startPos:startPos,endPos:endPos}=range,elementText=editor.getTextBetween(startPos,endPos),parser=new DOMParser,doc=parser.parseFromString(elementText,"text/html"),imgElement=doc.querySelector("img");if(imgElement){imgElement.setAttribute("src",newSrcValue);const updatedElementText=imgElement.outerHTML;editor.document.batchOperation(function(){editor.replaceRange(updatedElementText,startPos,endPos)})}}function _updateImageAndDismissRibbon(tagId,targetPath,filename){const editor=_getEditorAndValidate(tagId);if(editor){const htmlFilePath=editor.document.file.fullPath,relativePath=PathUtils.makePathRelative(targetPath,htmlFilePath);_updateImageSrcAttribute(tagId,relativePath)}else _updateImageSrcAttribute(tagId,filename);const currLiveDoc=LiveDevMultiBrowser.getCurrentLiveDoc();currLiveDoc&&currLiveDoc.protocol&&currLiveDoc.protocol.evaluate&&currLiveDoc.protocol.evaluate("_LD.dismissImageRibbonGallery()")}function _handleUseThisImageLocalFiles(message,filename,projectRoot){const{tagId:tagId,imageData:imageData}=message,uint8Array=new Uint8Array(imageData),targetPath=projectRoot.fullPath+filename;window.fs.writeFile(targetPath,window.Filer.Buffer.from(uint8Array),{encoding:window.fs.BYTE_ARRAY_ENCODING},err=>{err?console.error("Failed to save image:",err):_updateImageAndDismissRibbon(tagId,targetPath,filename)})}function _handleUseThisImageRemote(message,filename,projectRoot){const{imageUrl:imageUrl,tagId:tagId}=message;fetch(imageUrl).then(response=>{if(!response.ok)throw new Error(`HTTP error! status: ${response.status}`);return response.arrayBuffer()}).then(arrayBuffer=>{const uint8Array=new Uint8Array(arrayBuffer),targetPath=projectRoot.fullPath+filename;window.fs.writeFile(targetPath,window.Filer.Buffer.from(uint8Array),{encoding:window.fs.BYTE_ARRAY_ENCODING},err=>{err?console.error("Failed to save image:",err):_updateImageAndDismissRibbon(tagId,targetPath,filename)})}).catch(error=>{console.error("Failed to fetch image:",error)})}function _handleUseThisImage(message){const filename=message.filename,extnName=message.extnName||"jpg",projectRoot=ProjectManager.getProjectRoot();if(!projectRoot)return;const phoenixAssetsPath=projectRoot.fullPath+"phoenix-code-assets/",phoenixAssetsDir=FileSystem.getDirectoryForPath(phoenixAssetsPath);phoenixAssetsDir.exists((err,exists)=>{err||(exists?_downloadImageToPhoenixAssets(message,filename,extnName,phoenixAssetsDir):phoenixAssetsDir.create(err=>{err?console.error("Error creating phoenix-code-assets directory:",err):_downloadImageToPhoenixAssets(message,filename,extnName,phoenixAssetsDir)}))})}function _downloadImageToPhoenixAssets(message,filename,extnName,phoenixAssetsDir){getUniqueFilename(phoenixAssetsDir.fullPath,filename,extnName).then(uniqueFilename=>{message.isLocalFile&&message.imageData?_handleUseThisImageLocalFiles(message,uniqueFilename,phoenixAssetsDir):_handleUseThisImageRemote(message,uniqueFilename,phoenixAssetsDir)}).catch(error=>{console.error("Something went wrong when trying to use this image",error)})}function handleLivePreviewEditOperation(message){message.move&&message.sourceId&&message.targetId?_moveElementInSource(message.sourceId,message.targetId,message.insertAfter,message.insertInside):message.useImage&&message.imageUrl&&message.filename?_handleUseThisImage(message):message.element&&message.tagId?message.delete?_deleteElementInSourceByTagId(message.tagId):message.duplicate?_duplicateElementInSourceByTagId(message.tagId):message.livePreviewTextEdit?_editTextInSource(message):message.AISend&&_editWithAI(message):(message.undoLivePreviewOperation||message.redoLivePreviewOperation)&&(message.undoLivePreviewOperation?handleUndoRedoOperation("undo"):handleUndoRedoOperation("redo"))}exports.handleLivePreviewEditOperation=handleLivePreviewEditOperation});
//# sourceMappingURL=LivePreviewEdit.js.map
