{"version":3,"sources":["extensionsIntegrated/RecentProjects/main.js"],"names":["define","require","exports","module","ProjectManager","SidebarView","PreferencesManager","Commands","CommandManager","Menus","FileSystem","AppInit","KeyEvent","FileUtils","PopUpManager","Strings","Mustache","ProjectsMenuTemplate","ExtensionInterface","RECENT_PROJECTS_INTERFACE","registerExtensionInterface","RECENT_PROJECT_STATE","MAX_PROJECTS","$dropdown","getRecentProjects","recentProjects","getViewState","i","length","stripTrailingSlash","updateWelcomeProjectPath","add","projectToAdd","getProjectRoot","fullPath","getPlaceholderProjectPath","root","index","indexOf","splice","unshift","slice","setViewState","removeFromRecentProject","newProjects","push","_handlePopupKeyEvents","event","$popUp","keyCode","DOM_VK_DELETE","stopPropagation","$selectedItem","find","data","selectNextItem","closest","remove","closeDropdown","removePopUp","cleanupDropdown","$","off","openProjectWithPath","Promise","resolve","reject","openProject","then","fail","err","item","_handleListEvents","on","e","this","parent","$link","id","attr","path","execute","FILE_OPEN_FOLDER","FILE_NEW_PROJECT","FILE_DOWNLOAD_PROJECT","renderPath","parentDirPath","Phoenix","VFS","ensureTrailingSlash","window","dirname","rest","startsWith","getTauriDir","fs","getTauriPlatformPath","getMountDir","displayPath","replace","PROJECT_FROM_BROWSER_TERSE","folder","basename","renderList","downloadProjectCommand","get","currentProject","templateVars","projectList","downloadProjectClass","getEnabled","forEach","render","showDropdown","position","closeAll","css","left","pageX","top","pageY","appendTo","addPopUp","closeCurrentPopups","handleSelectionEvents","enableSearchFilter","keyboardEventHandler","appReady","stateManager","definePreference","watchExternalChanges","htmlReady","removeClass","cmenuAdapter","open","close","isOpen","ContextMenu","assignContextMenuToSelector"],"mappings":"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","sourcesContent":["/*\n * GNU AGPL-3.0 License\n *\n * Copyright (c) 2021 - present core.ai . All rights reserved.\n * Original work Copyright (c) 2012 - 2021 Adobe Systems Incorporated. All rights reserved.\n *\n * This program is free software: you can redistribute it and/or modify it\n * under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT\n * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License\n * for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see https://opensource.org/licenses/AGPL-3.0.\n *\n */\n\n/*global Phoenix*/\n\ndefine(function (require, exports, module) {\n\n\n    // Brackets modules\n    const ProjectManager          = require(\"project/ProjectManager\"),\n        SidebarView             = require(\"project/SidebarView\"),\n        PreferencesManager      = require(\"preferences/PreferencesManager\"),\n        Commands                = require(\"command/Commands\"),\n        CommandManager          = require(\"command/CommandManager\"),\n        Menus                   = require(\"command/Menus\"),\n        FileSystem              = require(\"filesystem/FileSystem\"),\n        AppInit                 = require(\"utils/AppInit\"),\n        KeyEvent                = require(\"utils/KeyEvent\"),\n        FileUtils               = require(\"file/FileUtils\"),\n        PopUpManager            = require(\"widgets/PopUpManager\"),\n        Strings                 = require(\"strings\"),\n        Mustache                = require(\"thirdparty/mustache/mustache\"),\n        ProjectsMenuTemplate    = require(\"text!./htmlContent/projects-menu.html\"),\n        ExtensionInterface = require(\"utils/ExtensionInterface\");\n\n    const RECENT_PROJECTS_INTERFACE = \"Extn.Phoenix.recentProjects\";\n\n    ExtensionInterface.registerExtensionInterface(RECENT_PROJECTS_INTERFACE, exports);\n    const RECENT_PROJECT_STATE = \"recentProjects\";\n\n    /** @const {number} Maximum number of displayed recent projects */\n    var MAX_PROJECTS = 20;\n\n    /** @type {$.Element} jQuery elements used for the dropdown menu */\n    let $dropdown;\n\n    /**\n     * Get the stored list of recent projects, fixing up paths as appropriate.\n     * Warning: unlike most paths in Brackets, these lack a trailing \"/\"\n     */\n    function getRecentProjects() {\n        var recentProjects = PreferencesManager.getViewState(RECENT_PROJECT_STATE) || [],\n            i;\n\n        for (i = 0; i < recentProjects.length; i++) {\n            // We have to canonicalize & then de-canonicalize the path here, since our pref format uses no trailing \"/\"\n            recentProjects[i] = FileUtils.stripTrailingSlash(ProjectManager.updateWelcomeProjectPath(recentProjects[i] + \"/\"));\n        }\n        return recentProjects;\n    }\n\n    /**\n     * Add a project to the stored list of recent projects, up to MAX_PROJECTS.\n     */\n    function add() {\n        const projectToAdd = ProjectManager.getProjectRoot().fullPath;\n        if(projectToAdd === ProjectManager.getPlaceholderProjectPath()){\n            return;\n        }\n        var root = FileUtils.stripTrailingSlash(projectToAdd),\n            recentProjects = getRecentProjects(),\n            index = recentProjects.indexOf(root);\n\n        if (index !== -1) {\n            recentProjects.splice(index, 1);\n        }\n        recentProjects.unshift(root);\n        if (recentProjects.length > MAX_PROJECTS) {\n            recentProjects = recentProjects.slice(0, MAX_PROJECTS);\n        }\n        PreferencesManager.setViewState(RECENT_PROJECT_STATE, recentProjects);\n    }\n\n    function removeFromRecentProject(fullPath) {\n        fullPath = FileUtils.stripTrailingSlash(fullPath);\n        let recentProjects = getRecentProjects(),\n            index = recentProjects.indexOf(fullPath),\n            newProjects = [],\n            i;\n        for (i = 0; i < recentProjects.length; i++) {\n            if (i !== index) {\n                newProjects.push(recentProjects[i]);\n            }\n        }\n        PreferencesManager.setViewState(RECENT_PROJECT_STATE, newProjects);\n    }\n\n    /**\n     * Handles the Key Down events\n     * @param {KeyboardEvent} event\n     * @param $popUp\n     * @return {boolean} True if the key was handled\n     */\n    function _handlePopupKeyEvents(event, $popUp) {\n        if(event.keyCode === KeyEvent.DOM_VK_DELETE){\n            event.stopPropagation();\n            const $selectedItem = $popUp.find(\".selected\");\n            if ($selectedItem.length && $selectedItem.data(\"path\")) {\n                // Remove the project from the preferences.\n                removeFromRecentProject($selectedItem.data(\"path\"));\n                PopUpManager.selectNextItem(+1, $popUp);\n                $selectedItem.closest(\"li\").remove();\n\n                if (getRecentProjects().length === 1) {\n                    $dropdown.find(\".divider\").remove();\n                }\n            }\n            return true;\n        }\n    }\n\n\n    /**\n     * Close the dropdown.\n     */\n    function closeDropdown() {\n        // Since we passed \"true\" for autoRemove to addPopUp(), this will\n        // automatically remove the dropdown from the DOM. Also, PopUpManager\n        // will call cleanupDropdown().\n        if ($dropdown) {\n            PopUpManager.removePopUp($dropdown);\n        }\n    }\n\n    /**\n     * Remove the various event handlers that close the dropdown. This is called by the\n     * PopUpManager when the dropdown is closed.\n     */\n    function cleanupDropdown() {\n        $(\"html\").off(\"click\", closeDropdown);\n        $(\"#project-files-container\").off(\"scroll\", closeDropdown);\n        $(\"#titlebar .nav\").off(\"click\", closeDropdown);\n        $dropdown = null;\n    }\n\n    function openProjectWithPath(fullPath) {\n        return new Promise((resolve, reject)=>{\n            ProjectManager.openProject(fullPath)\n                .then(resolve)\n                .fail(function () {\n                    // Remove the project from the list only if it does not exist on disk\n                    var recentProjects = getRecentProjects(),\n                        index = recentProjects.indexOf(fullPath);\n                    if (index === -1) {\n                        reject();\n                        return;\n                    }\n                    FileSystem.resolve(fullPath, function (err, item) {\n                        if (err) {\n                            removeFromRecentProject(fullPath);\n                        }\n                        reject();\n                    });\n                });\n        });\n    }\n\n    /**\n     * Adds the click and mouse enter/leave events to the dropdown\n     */\n    function _handleListEvents() {\n        $dropdown\n            .on(\"click\", \".recent-project-delete\", function (e) {\n                // Don't let the click bubble upward.\n                e.stopPropagation();\n\n                // Remove the project from the preferences.\n                removeFromRecentProject($(this).parent().data(\"path\"));\n                $(this).closest(\"li\").remove();\n\n                if (getRecentProjects().length === 1) {\n                    $dropdown.find(\".divider\").remove();\n                }\n            })\n            .on(\"click\", \"a\", function () {\n                var $link = $(this),\n                    id    = $link.attr(\"id\"),\n                    path  = $link.data(\"path\");\n\n                if (path) {\n                    openProjectWithPath(path);\n                    closeDropdown();\n\n                } else if (id === \"open-folder-link\") {\n                    CommandManager.execute(Commands.FILE_OPEN_FOLDER);\n                } else if (id === \"new-project-link\") {\n                    CommandManager.execute(Commands.FILE_NEW_PROJECT);\n                } else if (id === \"download-project-link\") {\n                    CommandManager.execute(Commands.FILE_DOWNLOAD_PROJECT);\n                }\n\n            });\n    }\n\n    /**\n     * Parses the path and returns an object with the full path, the folder name and the path without the folder.\n     * @param {string} fullPath The full path to the folder.\n     * @return {{path: string, folder: string, rest: string}}\n     */\n    function renderPath(fullPath) {\n        let parentDirPath = Phoenix.VFS.ensureTrailingSlash(window.path.dirname(fullPath));\n        let rest;\n        if(parentDirPath.startsWith(Phoenix.VFS.getTauriDir())) {\n            rest = \" - \" + window.fs.getTauriPlatformPath(parentDirPath);\n        } else if(parentDirPath.startsWith(Phoenix.VFS.getMountDir())) {\n            const displayPath = parentDirPath.replace(Phoenix.VFS.getMountDir(), \"\");\n            if(displayPath){\n                rest = \" - \" + displayPath;\n            }\n        } else {\n            rest = \" - \" + Strings.PROJECT_FROM_BROWSER_TERSE;\n        }\n\n        return {path: fullPath, folder: window.path.basename(fullPath), rest: rest};\n    }\n\n    /**\n     * Create the list of projects in the dropdown menu.\n     * @return {string} The html content\n     */\n    function renderList() {\n        const recentProjects = getRecentProjects(),\n            downloadProjectCommand = CommandManager.get(Commands.FILE_DOWNLOAD_PROJECT),\n            currentProject = FileUtils.stripTrailingSlash(ProjectManager.getProjectRoot().fullPath),\n            templateVars   = {\n                projectList: [],\n                Strings: Strings,\n                downloadProjectClass: downloadProjectCommand.getEnabled() ? \"\": \"forced-hidden\"\n            };\n\n        recentProjects.forEach(function (root) {\n            if (root !== currentProject) {\n                templateVars.projectList.push(renderPath(root));\n            }\n        });\n\n        return Mustache.render(ProjectsMenuTemplate, templateVars);\n    }\n\n    /**\n     * Show or hide the recent projects dropdown.\n     *\n     * @param {{pageX:number, pageY:number}} position - the absolute position where to open the dropdown\n     */\n    function showDropdown(position) {\n        // If the dropdown is already visible, just return (so the root click handler on html\n        // will close it).\n        if ($dropdown) {\n            return;\n        }\n\n        Menus.closeAll();\n\n        $dropdown = $(renderList())\n            .css({\n                left: position.pageX,\n                top: position.pageY\n            })\n            .appendTo($(\"body\"));\n\n        PopUpManager.addPopUp($dropdown, cleanupDropdown, true, {closeCurrentPopups: true});\n        PopUpManager.handleSelectionEvents($dropdown, {\n            enableSearchFilter: true,\n            keyboardEventHandler: _handlePopupKeyEvents\n        });\n\n        // TODO: should use capture, otherwise clicking on the menus doesn't close it. More fallout\n        // from the fact that we can't use the Boostrap (1.4) dropdowns.\n        $(\"html\").on(\"click\", closeDropdown);\n\n        // Hide the menu if the user scrolls in the project tree. Otherwise the Lion scrollbar\n        // overlaps it.\n        // TODO: This duplicates logic that's already in ProjectManager (which calls Menus.close()).\n        // We should fix this when the popup handling is centralized in PopupManager, as well\n        // as making Esc close the dropdown. See issue #1381.\n        $(\"#project-files-container\").on(\"scroll\", closeDropdown);\n\n        // Note: PopUpManager will automatically hide the sidebar in other cases, such as when a\n        // command is run, Esc is pressed, or the menu is focused.\n\n        // Hacky: if we detect a click in the menubar, close ourselves.\n        // TODO: again, we should have centralized popup management.\n        $(\"#titlebar .nav\").on(\"click\", closeDropdown);\n\n        _handleListEvents();\n    }\n\n    // Initialize extension\n    AppInit.appReady(function () {\n        PreferencesManager.stateManager.definePreference(RECENT_PROJECT_STATE, 'array', [])\n            .watchExternalChanges();\n        ProjectManager.on(\"projectOpen\", add);\n        ProjectManager.on(\"beforeProjectClose\", add);\n        // add the current project at startup.\n        add();\n    });\n\n    AppInit.htmlReady(function () {\n        $(\"#project-dropdown-toggle .dropdown-arrow\").removeClass(\"forced-hidden\");\n\n        var cmenuAdapter = {\n            open: showDropdown,\n            close: closeDropdown,\n            isOpen: function () {\n                return !!$dropdown;\n            }\n        };\n        Menus.ContextMenu.assignContextMenuToSelector(\"#project-dropdown-toggle\", cmenuAdapter);\n    });\n\n    exports.getRecentProjects = getRecentProjects;\n    exports.openProjectWithPath = openProjectWithPath;\n    exports.removeFromRecentProject = removeFromRecentProject;\n});\n"],"file":"main.js"}