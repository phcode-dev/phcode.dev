{"version":3,"sources":["extensionsIntegrated/Phoenix-live-preview/main.js"],"names":["define","require","exports","module","ExtensionUtils","EditorManager","FileViewController","DocumentManager","ExtensionInterface","CommandManager","Commands","Menus","WorkspaceManager","AppInit","ModalBar","PreferencesManager","ProjectManager","MainViewManager","Strings","Mustache","Metrics","LiveDevelopment","LiveDevServerManager","MultiBrowserLiveDev","NativeApp","StringUtils","FileSystem","DropdownButton","BrowserStaticServer","NodeStaticServer","LivePreviewSettings","NodeUtils","TrustProjectHTML","panelHTML","Dialogs","DefaultDialogs","utils","StateManager","stateManager","STATE_CUSTOM_SERVER_BANNER_ACK","customServerModalBar","isBrowser","Phoenix","isNativeApp","StaticServer","EVENT_EMBEDDED_IFRAME_WHO_AM_I","EVENT_EMBEDDED_IFRAME_FOCUS_EDITOR","PREVIEW_TRUSTED_PROJECT_KEY","PREVIEW_PROJECT_README_KEY","PREFERENCE_LIVE_PREVIEW_MODE","$dropdown","_getDefaultMode","isProUser","definePreference","description","format","LIVE_PREVIEW_MODE_PREFERENCE","values","PREFERENCE_PROJECT_ELEMENT_HIGHLIGHT","LIVE_DEV_SETTINGS_ELEMENT_HIGHLIGHT_PREFERENCE","PREFERENCE_PROJECT_IMAGE_RIBBON","LIVE_PREVIEW_EDIT_IMAGE_RIBBON","LIVE_PREVIEW_PANEL_ID","LIVE_PREVIEW_IFRAME_ID","LIVE_PREVIEW_IFRAME_HTML","$icon","$settingsIcon","$iframe","$panel","$pinUrlBtn","$livePreviewPopBtn","$reloadBtn","$chromeButton","$safariButton","$edgeButton","$firefoxButton","$chromeButtonBallast","$safariButtonBallast","$edgeButtonBallast","$firefoxButtonBallast","$panelTitle","$modeBtn","$previewBtn","isTestWindow","window","_livePreviewIntegTest","urlLoadCount","customLivePreviewBannerShown","modeThatWasSelected","$overlayContainer","shouldShowSyncErrorOverlay","shouldShowConnectingOverlay","connectingOverlayTimer","connectingOverlayTimeDuration","_handleOverlay","textMessage","status","_hideOverlay","isUsingCustomServer","STATUS_CONNECTING","STATUS_SYNC_ERROR","_createAndShowOverlay","setTimeout","$","addClass","$message","text","$close","attr","LIVE_PREVIEW_HIDE_OVERLAY","on","$closeIcon","append","_clearConnectingOverlayTimer","remove","clearTimeout","_setOverlayWidth","length","width","removeClass","_showProFeatureDialog","dialog","showModalDialog","DIALOG_ID_INFO","LIVE_PREVIEW_PRO_FEATURE_TITLE","LIVE_PREVIEW_PRO_FEATURE_MESSAGE","className","DIALOG_BTN_CLASS_NORMAL","id","DIALOG_BTN_CANCEL","CANCEL","DIALOG_BTN_CLASS_PRIMARY","LIVE_PREVIEW_PRO_SUBSCRIBE","done","buttonId","console","log","_isLiveHighlightEnabled","get","FILE_LIVE_HIGHLIGHT","getChecked","_LPPreviewMode","setLivePreviewEditFeaturesActive","togglePreviewHighlight","_LPHighlightMode","_LPEditMode","_updateModeButton","mode","textContent","LIVE_PREVIEW_MODE_HIGHLIGHT","LIVE_PREVIEW_MODE_EDIT","LIVE_PREVIEW_MODE_PREVIEW","_initializeMode","isFreeTrialUser","set","savedMode","isEditFeaturesActive","effectiveMode","_showModeSelectionDropdown","event","items","push","LIVE_PREVIEW_EDIT_HIGHLIGHT_ON","rawMode","currentMode","includes","item","index","repeat","checkmark","crownIcon","html","enabled","isHoverMode","isImageRibbonEnabled","$button","css","position","left","pageX","top","pageY","zIndex","dropdownExtraClasses","showDropdown","e","newMode","currentEnabled","hideHighlight","dismissLivePreviewBoxes","display","_closeDropdown","_handleLPModeBtnClick","stopPropagation","_getTrustProjectPage","trustProjectMessage","TRUST_PROJECT","path","basename","getProjectRoot","fullPath","templateVars","render","_isProjectPreviewTrusted","projectPath","getWelcomeProjectPath","getExploreProjectPath","isTrustedProject","PhStore","getItem","_setProjectReadmePreviewdOnce","previewReadmeKey","setItem","_isProjectReadmePreviewdOnce","_createStaticServer","config","pathResolver","makeProjectRelativeIfPossible","root","iframeDom","contentWindow","postMessage","type","isTauri","platform","editor","getActiveEditor","focus","_trustCurrentProjectForLivePreview","isTrustedProjectKey","_loadPreview","registerExtensionInterface","_DEFAULT_EXTENSIONS_INTERFACE_NAMES","PHOENIX_LIVE_PREVIEW","loadStyleSheet","panel","urlPinned","currentLivePreviewURL","currentPreviewFile","panelShownAtStartup","_blankIframe","newIframe","insertAfter","_setPanelVisibility","isVisible","toggleClass","show","_showCustomServerBannerIfNeeded","hide","_startOrStopLivePreviewIfRequired","explicitClickOnLPIcon","visible","isInactive","openLivePreview","isActive","hasActiveLivePreviews","closeLivePreview","_toggleVisibilityOnClick","_togglePinUrl","pinStatus","hasClass","setLivePreviewPinned","countEvent","EVENT_TYPE","LIVE_PREVIEW","ALLOWED_BROWSERS_NAMES","_popoutLivePreview","browserName","openURL","getTabPopoutURL","openUrlInBrowser","then","catch","err","error","DIALOG_ID_ERROR","LIVE_DEV_OPEN_ERROR_TITLE","LIVE_DEV_OPEN_ERROR_MESSAGE","openURLInDefaultBrowser","_setTitle","fileName","message","LIVE_DEV_SELECT_FILE_TO_PREVIEW","tooltip","LIVE_DEV_TOOLTIP_SHOW_IN_EDITOR","_showOpenBrowserIcons","brackets","_handlePreviewBtnClick","async","_createExtensionPanel","livePreview","LIVE_DEV_STATUS_TIP_OUT_OF_SYNC","clickToReload","LIVE_DEV_CLICK_TO_RELOAD_PAGE","clickToPreview","livePreviewSettings","LIVE_DEV_SETTINGS","livePreviewConfigureModes","LIVE_PREVIEW_CONFIGURE_MODES","clickToPopout","LIVE_DEV_CLICK_POPOUT","openInChrome","LIVE_DEV_OPEN_CHROME","openInSafari","LIVE_DEV_OPEN_SAFARI","openInEdge","LIVE_DEV_OPEN_EDGE","openInFirefox","LIVE_DEV_OPEN_FIREFOX","clickToPinUnpin","LIVE_DEV_CLICK_TO_PIN_UNPIN","PANEL_MIN_SIZE","INITIAL_PANEL_SIZE","document","body","clientWidth","click","find","execute","FILE_LIVE_FILE_PREVIEW_SETTINGS","onload","openPanes","findInAllWorkingSets","paneToUse","ACTIVE_PANE","paneId","openFileAndAddToWorkingSet","popoutSupported","browser","desktop","isChromeBased","isFirefox","createPluginPanel","recomputeLayout","ResizeObserver","observe","force","isReload","isPreviewLoadable","previewDetails","getPreviewDetails","newSrc","encodeURI","URL","existingPreviewFile","existingPreviewURL","isNoPreview","isWithinProject","relativeOrFullPath","app","getDisplayPath","isCustomServer","LIVE_PREVIEW_CUSTOM_SERVER_BANNER","getCustomServeBaseURL","getExtension","redirectAllTabs","redirectURL","redirectURLforce","_projectFileChanges","evt","changedFile","isFile","isPreviewableFile","isServerRenderedFile","shouldReload","serverSupportsHotReload","isHTMLFile","_openReadmeMDIfFirstTime","readmePath","fileEntry","getFileForPath","exists","CMD_ADD_TO_WORKINGSET_AND_OPEN","startupFilesLoadHandled","_projectOpened","_customServerMetrics","getNoPreviewURL","isStartupFilesLoaded","currentDocument","getCurrentDocument","currentFile","file","getSelectedItem","isPreviewable","_startupFilesLoaded","_projectClosed","close","_activeDocChanged","focusedEditor","lostEditor","filePath","customServeURL","getCustomServerConfig","_openLivePreviewURL","_event","currentPreviewDetails","LIVE_DEV_STATUS_TIP_PROGRESS1","LIVE_DEV_STATUS_TIP_SYNC_ERROR","_currentFileChanged","_shouldShowCustomServerBar","_showCustomServerBar","shouldUseInbuiltPreview","isMarkdownFile","isSVG","shouldSwitchCustomServer","startsWith","_showSettingsDialog","Promise","resolve","showSettingsDialog","getCustomServerFramework","isBannerAck","PROJECT_CONTEXT","panelVisible","fullFilePath","LIVE_DEV_SETTINGS_BANNER","extname","searchBarHTML","CLOSE","$modal","getRoot","_registerHandlers","target","closest","appReady","isSpecRunnerWindow","shouldShowLivePreviewAtStartup","init","registerServer","create","EVENT_PROJECT_FILE_CHANGED","EVENT_PROJECT_OPEN","EVENT_PROJECT_CLOSE","EVENT_AFTER_STARTUP_FILES_LOADED","fileChangeListenerStartDelay","getCurrentlyViewedFile","register","CMD_LIVE_FILE_PREVIEW","FILE_LIVE_FILE_PREVIEW","CMD_LIVE_FILE_PREVIEW_SETTINGS","fileMenu","getMenu","AppMenuBar","FILE_MENU","refreshPreview","addMenuItem","AFTER","FILE_EXTENSION_MANAGER","addMenuDivider","BEFORE","updateElementHighlightConfig","updateImageRibbonConfig","EVENT_OPEN_PREVIEW_URL","EVENT_LIVE_PREVIEW_RELOAD","EVENT_STATUS_CHANGE","customServerRefreshedOnce","_handleNewCustomServer","EVENT_SERVER_READY","_evt","EVENT_SERVER_CHANGED","EVENT_CUSTOM_SERVER_ENABLED_CHANGED","consecutiveEmptyClientsCount","setInterval"],"mappings":"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","sourcesContent":["/*\n * GNU AGPL-3.0 License\n *\n * Copyright (c) 2021 - present core.ai . All rights reserved.\n *\n * This program is free software: you can redistribute it and/or modify it\n * under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT\n * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License\n * for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see https://opensource.org/licenses/AGPL-3.0.\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all\n * copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n * SOFTWARE.\n */\n\n/*jslint vars: true, plusplus: true, devel: true, nomen: true, regexp: true, indent: 4, maxerr: 50 */\n/*global path, jsPromise*/\n//jshint-ignore:no-start\n\ndefine(function (require, exports, module) {\n    const ExtensionUtils   = require(\"utils/ExtensionUtils\"),\n        EditorManager      = require(\"editor/EditorManager\"),\n        FileViewController  = require(\"project/FileViewController\"),\n        DocumentManager = require(\"document/DocumentManager\"),\n        ExtensionInterface = require(\"utils/ExtensionInterface\"),\n        CommandManager     = require(\"command/CommandManager\"),\n        Commands           = require(\"command/Commands\"),\n        Menus              = require(\"command/Menus\"),\n        WorkspaceManager   = require(\"view/WorkspaceManager\"),\n        AppInit            = require(\"utils/AppInit\"),\n        ModalBar           = require(\"widgets/ModalBar\").ModalBar,\n        PreferencesManager = require(\"preferences/PreferencesManager\"),\n        ProjectManager     = require(\"project/ProjectManager\"),\n        MainViewManager    = require(\"view/MainViewManager\"),\n        Strings            = require(\"strings\"),\n        Mustache           = require(\"thirdparty/mustache/mustache\"),\n        Metrics            = require(\"utils/Metrics\"),\n        LiveDevelopment    = require(\"LiveDevelopment/main\"),\n        LiveDevServerManager = require(\"LiveDevelopment/LiveDevServerManager\"),\n        MultiBrowserLiveDev = require(\"LiveDevelopment/LiveDevMultiBrowser\"),\n        NativeApp           = require(\"utils/NativeApp\"),\n        StringUtils         = require(\"utils/StringUtils\"),\n        FileSystem          = require(\"filesystem/FileSystem\"),\n        DropdownButton     = require(\"widgets/DropdownButton\"),\n        BrowserStaticServer  = require(\"./BrowserStaticServer\"),\n        NodeStaticServer  = require(\"./NodeStaticServer\"),\n        LivePreviewSettings  = require(\"./LivePreviewSettings\"),\n        NodeUtils = require(\"utils/NodeUtils\"),\n        TrustProjectHTML    = require(\"text!./trust-project.html\"),\n        panelHTML       = require(\"text!./panel.html\"),\n        Dialogs = require(\"widgets/Dialogs\"),\n        DefaultDialogs = require(\"widgets/DefaultDialogs\"),\n        utils = require('./utils');\n\n    const StateManager = PreferencesManager.stateManager;\n    const STATE_CUSTOM_SERVER_BANNER_ACK = \"customServerBannerDone\";\n    let customServerModalBar;\n\n    const isBrowser = !Phoenix.isNativeApp;\n    const StaticServer = Phoenix.isNativeApp? NodeStaticServer : BrowserStaticServer;\n\n    const EVENT_EMBEDDED_IFRAME_WHO_AM_I = 'whoAmIframePhoenix';\n    const EVENT_EMBEDDED_IFRAME_FOCUS_EDITOR = 'embeddedIframeFocusEditor';\n\n    const PREVIEW_TRUSTED_PROJECT_KEY = \"preview_trusted\";\n    const PREVIEW_PROJECT_README_KEY = \"preview_readme\";\n\n    // live preview mode pref\n    const PREFERENCE_LIVE_PREVIEW_MODE = \"livePreviewMode\";\n\n    // holds the dropdown instance\n    let $dropdown = null;\n\n    /**\n     * Get the appropriate default mode based on whether edit features are active\n     * @returns {string} \"highlight\" if edit features inactive, \"edit\" if active\n     */\n    function _getDefaultMode() {\n        return LiveDevelopment.isProUser ? \"edit\" : \"highlight\";\n    }\n\n    // define the live preview mode preference\n    PreferencesManager.definePreference(PREFERENCE_LIVE_PREVIEW_MODE, \"string\", _getDefaultMode(), {\n        description: StringUtils.format(Strings.LIVE_PREVIEW_MODE_PREFERENCE, \"'preview'\", \"'highlight'\", \"'edit'\"),\n        values: [\"preview\", \"highlight\", \"edit\"]\n    });\n\n    // live preview element highlights preference (whether on hover or click)\n    const PREFERENCE_PROJECT_ELEMENT_HIGHLIGHT = \"livePreviewElementHighlights\";\n    PreferencesManager.definePreference(PREFERENCE_PROJECT_ELEMENT_HIGHLIGHT, \"string\", \"hover\", {\n        description: Strings.LIVE_DEV_SETTINGS_ELEMENT_HIGHLIGHT_PREFERENCE\n    });\n\n    // live preview image picker preference (whether to show image gallery when clicking images)\n    const PREFERENCE_PROJECT_IMAGE_RIBBON = \"livePreviewImagePicker\";\n    PreferencesManager.definePreference(PREFERENCE_PROJECT_IMAGE_RIBBON, \"boolean\", true, {\n        description: Strings.LIVE_PREVIEW_EDIT_IMAGE_RIBBON\n    });\n\n    const LIVE_PREVIEW_PANEL_ID = \"live-preview-panel\";\n    const LIVE_PREVIEW_IFRAME_ID = \"panel-live-preview-frame\";\n    const LIVE_PREVIEW_IFRAME_HTML = `\n    <iframe id=\"${LIVE_PREVIEW_IFRAME_ID}\" title=\"Live Preview\" style=\"border: none\"\n             width=\"100%\" height=\"100%\" seamless=\"true\"\n             src='about:blank'\n             sandbox=\"allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-scripts allow-forms allow-modals allow-pointer-lock\">\n    </iframe>\n    `;\n\n    if(Phoenix.isTestWindow) {\n        // for integ tests\n        window._livePreviewIntegTest = {\n            urlLoadCount: 0,\n            STATE_CUSTOM_SERVER_BANNER_ACK\n        };\n    }\n\n    // jQuery objects\n    let $icon,\n        $settingsIcon,\n        $iframe,\n        $panel,\n        $pinUrlBtn,\n        $livePreviewPopBtn,\n        $reloadBtn,\n        $chromeButton,\n        $safariButton,\n        $edgeButton,\n        $firefoxButton,\n        $chromeButtonBallast,\n        $safariButtonBallast,\n        $edgeButtonBallast,\n        $firefoxButtonBallast,\n        $panelTitle,\n        $modeBtn,\n        $previewBtn;\n\n    let customLivePreviewBannerShown = false;\n\n    // so this variable stores the mode that was previously selected\n    // this is needed when the preview mode (play button icon) is clicked, we store the current mode\n    // so that when user unclicks the button we can revert back to the mode that was originally selected\n    let modeThatWasSelected = null;\n\n    // live Preview overlay variables (overlays are shown when live preview is connecting or there's a syntax error)\n    let $overlayContainer = null; // the overlay container\n    let shouldShowSyncErrorOverlay = true; // once user closes the overlay we don't show them again\n    let shouldShowConnectingOverlay = true;\n    let connectingOverlayTimer = null; // this is needed as we show the connecting overlay after 3s\n    let connectingOverlayTimeDuration = 3000;\n\n    StaticServer.on(EVENT_EMBEDDED_IFRAME_WHO_AM_I, function () {\n        if($iframe && $iframe[0]) {\n            const iframeDom = $iframe[0];\n            iframeDom.contentWindow.postMessage({\n                type: \"WHO_AM_I_RESPONSE\",\n                isTauri: Phoenix.isNativeApp,\n                platform: Phoenix.platform\n            }, \"*\"); // this is not sensitive info, and is only dispatched if requested by the iframe\n        }\n    });\n    StaticServer.on(EVENT_EMBEDDED_IFRAME_FOCUS_EDITOR, function () {\n        const editor  = EditorManager.getActiveEditor();\n        editor.focus();\n    });\n\n    /**\n     * this function is responsible to check whether to show the overlay or not and how it should be shown\n     * because if user has closed the overlay manually, we don't show it again\n     * secondly, for connecting overlay we show that after a 3s timer, but sync error overlay is shown immediately\n     * @param {String} textMessage - the text that is written inside the overlay\n     * @param {Number} status - 1 for connect, 4 for sync error but we match it using MultiBrowserLiveDev\n     */\n    function _handleOverlay(textMessage, status) {\n        if (!$panel) { return; }\n\n        // remove any existing overlay & timer\n        _hideOverlay();\n\n        if(LivePreviewSettings.isUsingCustomServer()){\n            return;\n        }\n\n        // to not show the overlays if user has already closed it before\n        if(status === MultiBrowserLiveDev.STATUS_CONNECTING && !shouldShowConnectingOverlay) { return; }\n        if(status === MultiBrowserLiveDev.STATUS_SYNC_ERROR && !shouldShowSyncErrorOverlay) { return; }\n\n        // for connecting status, we delay showing the overlay by 3 seconds\n        if(status === MultiBrowserLiveDev.STATUS_CONNECTING) {\n            connectingOverlayTimer = setTimeout(() => {\n                _createAndShowOverlay(textMessage, status);\n                connectingOverlayTimer = null;\n            }, connectingOverlayTimeDuration);\n            return;\n        }\n\n        // for sync error status, show immediately\n        _createAndShowOverlay(textMessage, status);\n    }\n\n    /**\n     * this function is responsible to create & show the overlay.\n     * so overlay is shown when the live preview is connecting or live preview stopped because of some syntax error\n     * @param {String} textMessage - the text that is written inside the overlay\n     * @param {Number} status - 1 for connect, 4 for sync error but we match it using MultiBrowserLiveDev\n     */\n    function _createAndShowOverlay(textMessage, status) {\n        if (!$panel) { return; }\n\n        // create the overlay element\n        // styled inside the 'live-preview.css'\n        $overlayContainer = $(\"<div>\").addClass(\"live-preview-status-overlay\"); // the wrapper for overlay element\n        const $message = $(\"<div>\").addClass(\"live-preview-overlay-message\").text(textMessage);\n\n        // the close button at the right end of the overlay\n        const $close = $(\"<div>\").addClass(\"live-preview-overlay-close\")\n            .attr(\"title\", Strings.LIVE_PREVIEW_HIDE_OVERLAY)\n            .on('click', () => {\n                if(status === MultiBrowserLiveDev.STATUS_CONNECTING) {\n                    shouldShowConnectingOverlay = false;\n                } else if(status === MultiBrowserLiveDev.STATUS_SYNC_ERROR) {\n                    shouldShowSyncErrorOverlay = false;\n                }\n                _hideOverlay();\n            });\n        const $closeIcon = $(\"<i>\").addClass(\"fas fa-times\");\n\n        $close.append($closeIcon);\n        $overlayContainer.append($message);\n        $overlayContainer.append($close);\n        $panel.append($overlayContainer);\n    }\n\n    /**\n     * responsible to hide the overlay\n     */\n    function _hideOverlay() {\n        _clearConnectingOverlayTimer();\n        if ($overlayContainer) {\n            $overlayContainer.remove();\n            $overlayContainer = null;\n        }\n    }\n\n    /**\n     * This is a helper function that just checks that if connectingOverlayTimer exists, we clear it\n     */\n    function _clearConnectingOverlayTimer() {\n        if (connectingOverlayTimer) {\n            clearTimeout(connectingOverlayTimer);\n            connectingOverlayTimer = null;\n        }\n    }\n\n    /**\n     * this function adds/remove the full-width class from the overlay container\n     * styled inside 'live-preview.css'\n     *\n     * we need this because\n     * normally when live preview has a good width (more than 305px) then a 3px divider is shown at the left end\n     * so in that case we give the overlay a width of (100% - 3px),\n     * but when the live preview width is reduced\n     * then that divider line gets cut off, so in that case we make the width 100% for this overlay\n     *\n     * without this handling, a white gap appears on the left side, which is distracting\n     */\n    function _setOverlayWidth() {\n        if(!$overlayContainer || !$panel || !$panel.length) { return; }\n        if($panel.width() <= 305) {\n            $overlayContainer.addClass(\"full-width\");\n        } else {\n            $overlayContainer.removeClass(\"full-width\");\n        }\n    }\n\n    function _showProFeatureDialog() {\n        const dialog = Dialogs.showModalDialog(\n            DefaultDialogs.DIALOG_ID_INFO,\n            Strings.LIVE_PREVIEW_PRO_FEATURE_TITLE,\n            Strings.LIVE_PREVIEW_PRO_FEATURE_MESSAGE,\n            [\n                {\n                    className: Dialogs.DIALOG_BTN_CLASS_NORMAL,\n                    id: Dialogs.DIALOG_BTN_CANCEL,\n                    text: Strings.CANCEL\n                },\n                {\n                    className: Dialogs.DIALOG_BTN_CLASS_PRIMARY,\n                    id: \"subscribe\",\n                    text: Strings.LIVE_PREVIEW_PRO_SUBSCRIBE\n                }\n            ]\n        );\n\n        dialog.done(function (buttonId) {\n            if (buttonId === \"subscribe\") {\n                // TODO: write the implementation here...@abose\n                console.log(\"the subscribe button got clicked\");\n            }\n        });\n\n        return dialog;\n    }\n\n    // this function is to check if the live highlight feature is enabled or not\n    function _isLiveHighlightEnabled() {\n        return CommandManager.get(Commands.FILE_LIVE_HIGHLIGHT).getChecked();\n    }\n\n    /**\n     * Live Preview 'Preview Mode'. in this mode no live preview highlight or any such features are active\n     * Just the plain website\n     */\n    function _LPPreviewMode() {\n        LiveDevelopment.setLivePreviewEditFeaturesActive(false);\n        if(_isLiveHighlightEnabled()) {\n            LiveDevelopment.togglePreviewHighlight();\n        }\n    }\n\n    /**\n     * Live Preview 'Highlight Mode'. in this mode only the live preview matching with the source code is active\n     * Meaning that if user clicks on some element that element's source code will be highlighted and vice versa\n     */\n    function _LPHighlightMode() {\n        LiveDevelopment.setLivePreviewEditFeaturesActive(false);\n        if(!_isLiveHighlightEnabled()) {\n            LiveDevelopment.togglePreviewHighlight();\n        }\n    }\n\n    /**\n     * Live Preview 'Edit Mode'. this is the most interactive mode, in here the highlight features are available\n     * along with that we also show element's highlighted boxes and such\n     */\n    function _LPEditMode() {\n        LiveDevelopment.setLivePreviewEditFeaturesActive(true);\n        if(!_isLiveHighlightEnabled()) {\n            LiveDevelopment.togglePreviewHighlight();\n        }\n    }\n\n    /**\n     * update the mode button text in the live preview toolbar UI based on the current mode\n     * @param {String} mode - The current mode (\"preview\", \"highlight\", or \"edit\")\n     */\n    function _updateModeButton(mode) {\n        if ($modeBtn) {\n            if (mode === \"highlight\") {\n                $modeBtn[0].textContent = Strings.LIVE_PREVIEW_MODE_HIGHLIGHT;\n            } else if (mode === \"edit\") {\n                $modeBtn[0].textContent = Strings.LIVE_PREVIEW_MODE_EDIT;\n            } else {\n                $modeBtn[0].textContent = Strings.LIVE_PREVIEW_MODE_PREVIEW;\n            }\n        }\n    }\n\n    /**\n     * init live preview mode from saved preferences\n     */\n    function _initializeMode() {\n        // when user is on free trial we just push the edit mode to them every time they open/reload Phoenix\n        if(LiveDevelopment.isFreeTrialUser) {\n            PreferencesManager.set(PREFERENCE_LIVE_PREVIEW_MODE, \"edit\");\n            _LPEditMode();\n            $previewBtn.removeClass('selected');\n            _updateModeButton(\"edit\");\n            return;\n        }\n\n        const savedMode = PreferencesManager.get(PREFERENCE_LIVE_PREVIEW_MODE) || _getDefaultMode();\n        const isEditFeaturesActive = LiveDevelopment.isProUser;\n\n        // If user has edit mode saved but edit features are not active, default to highlight\n        let effectiveMode = savedMode;\n        if (savedMode === \"edit\" && !isEditFeaturesActive) {\n            effectiveMode = \"highlight\";\n            // Update the preference to reflect the actual mode being used\n            PreferencesManager.set(PREFERENCE_LIVE_PREVIEW_MODE, \"highlight\");\n        }\n\n        // apply the effective mode\n        if (effectiveMode === \"highlight\") {\n            _LPHighlightMode();\n            $previewBtn.removeClass('selected');\n        } else if (effectiveMode === \"edit\" && isEditFeaturesActive) {\n            _LPEditMode();\n            $previewBtn.removeClass('selected');\n        } else {\n            _LPPreviewMode();\n            $previewBtn.addClass('selected');\n        }\n\n        _updateModeButton(effectiveMode);\n    }\n\n    function _showModeSelectionDropdown(event) {\n        const isEditFeaturesActive = LiveDevelopment.isProUser;\n        const items = [\n            Strings.LIVE_PREVIEW_MODE_PREVIEW,\n            Strings.LIVE_PREVIEW_MODE_HIGHLIGHT,\n            Strings.LIVE_PREVIEW_MODE_EDIT\n        ];\n\n        // Only add edit highlight option if edit features are active\n        if (isEditFeaturesActive) {\n            items.push(\"---\");\n            items.push(Strings.LIVE_PREVIEW_EDIT_HIGHLIGHT_ON);\n            items.push(Strings.LIVE_PREVIEW_EDIT_IMAGE_RIBBON);\n        }\n\n        const rawMode = PreferencesManager.get(PREFERENCE_LIVE_PREVIEW_MODE) || _getDefaultMode();\n        // this is to take care of invalid values in the pref file\n        const currentMode = [\"preview\", \"highlight\", \"edit\"].includes(rawMode) ? rawMode : _getDefaultMode();\n\n        $dropdown = new DropdownButton.DropdownButton(\"\", items, function(item, index) {\n            if (item === Strings.LIVE_PREVIEW_MODE_PREVIEW) {\n                // using empty spaces to keep content aligned\n                return currentMode === \"preview\" ? `✓ ${item}` : `${'\\u00A0'.repeat(4)}${item}`;\n            } else if (item === Strings.LIVE_PREVIEW_MODE_HIGHLIGHT) {\n                return currentMode === \"highlight\" ? `✓ ${item}` : `${'\\u00A0'.repeat(4)}${item}`;\n            } else if (item === Strings.LIVE_PREVIEW_MODE_EDIT) {\n                const checkmark = currentMode === \"edit\" ? \"✓ \" : `${'\\u00A0'.repeat(4)}`;\n                const crownIcon = !isEditFeaturesActive ? ' <span style=\"color: #FBB03B; border: 1px solid #FBB03B; padding: 2px 4px; border-radius: 10px; font-size: 9px; margin-left: 12px;\"><i class=\"fas fa-crown\"></i> Pro</span>' : '';\n                return {\n                    html: `${checkmark}${item}${crownIcon}`,\n                    enabled: true\n                };\n            } else if (item === Strings.LIVE_PREVIEW_EDIT_HIGHLIGHT_ON) {\n                const isHoverMode = PreferencesManager.get(PREFERENCE_PROJECT_ELEMENT_HIGHLIGHT) !== \"click\";\n                if(isHoverMode) {\n                    return `✓ ${Strings.LIVE_PREVIEW_EDIT_HIGHLIGHT_ON}`;\n                }\n                return `${'\\u00A0'.repeat(4)}${Strings.LIVE_PREVIEW_EDIT_HIGHLIGHT_ON}`;\n            } else if (item === Strings.LIVE_PREVIEW_EDIT_IMAGE_RIBBON) {\n                const isImageRibbonEnabled = PreferencesManager.get(PREFERENCE_PROJECT_IMAGE_RIBBON) !== false;\n                if(isImageRibbonEnabled) {\n                    return `✓ ${item}`;\n                }\n                return `${'\\u00A0'.repeat(4)}${item}`;\n            }\n            return item;\n        });\n\n        // Append to document body for absolute positioning\n        $(\"body\").append($dropdown.$button);\n\n        // Position the dropdown at the mouse coordinates\n        $dropdown.$button.css({\n            position: \"absolute\",\n            left: event.pageX + \"px\",\n            top: event.pageY + \"px\",\n            zIndex: 1000\n        });\n\n        // Add a custom class to override the max-height\n        $dropdown.dropdownExtraClasses = \"mode-context-menu\";\n\n        $dropdown.showDropdown();\n\n        $(\".mode-context-menu\").css(\"max-height\", \"300px\");\n\n        // handle the option selection\n        $dropdown.on(\"select\", function (e, item, index) {\n            // here we just set the preference\n            // as the preferences listener will automatically handle the required changes\n            if (index === 0) {\n                PreferencesManager.set(PREFERENCE_LIVE_PREVIEW_MODE, \"preview\");\n            } else if (index === 1) {\n                PreferencesManager.set(PREFERENCE_LIVE_PREVIEW_MODE, \"highlight\");\n            } else if (index === 2) {\n                if (!isEditFeaturesActive) {\n                    // when the feature is not active we need to show a dialog to the user asking\n                    // them to subscribe to pro\n                    _showProFeatureDialog();\n                } else {\n                    PreferencesManager.set(PREFERENCE_LIVE_PREVIEW_MODE, \"edit\");\n                }\n            } else if (item === Strings.LIVE_PREVIEW_EDIT_HIGHLIGHT_ON) {\n                // Don't allow edit highlight toggle if edit features are not active\n                if (!isEditFeaturesActive) {\n                    return;\n                }\n                // Toggle between hover and click\n                const currentMode = PreferencesManager.get(PREFERENCE_PROJECT_ELEMENT_HIGHLIGHT);\n                const newMode = currentMode !== \"click\" ? \"click\" : \"hover\";\n                PreferencesManager.set(PREFERENCE_PROJECT_ELEMENT_HIGHLIGHT, newMode);\n                return; // Don't dismiss highlights for this option\n            } else if (item === Strings.LIVE_PREVIEW_EDIT_IMAGE_RIBBON) {\n                // Don't allow image ribbon toggle if edit features are not active\n                if (!isEditFeaturesActive) {\n                    return;\n                }\n                // Toggle image ribbon preference\n                const currentEnabled = PreferencesManager.get(PREFERENCE_PROJECT_IMAGE_RIBBON);\n                PreferencesManager.set(PREFERENCE_PROJECT_IMAGE_RIBBON, !currentEnabled);\n                return; // Don't dismiss highlights for this option\n            }\n\n            // need to dismiss the previous highlighting and stuff\n            LiveDevelopment.hideHighlight();\n            LiveDevelopment.dismissLivePreviewBoxes();\n        });\n\n        // Remove the button after the dropdown is hidden\n        $dropdown.$button.css({\n            display: \"none\"\n        });\n    }\n\n    /**\n     * to close the overflow button's dropdown\n     */\n    function _closeDropdown() {\n        if ($dropdown) {\n            if ($dropdown.$button) {\n                $dropdown.$button.remove();\n            }\n            $dropdown = null;\n        }\n    }\n\n    function _handleLPModeBtnClick(e) {\n        e.stopPropagation();\n        $dropdown ? _closeDropdown() : _showModeSelectionDropdown(e);\n    }\n\n    function _getTrustProjectPage() {\n        const trustProjectMessage = StringUtils.format(Strings.TRUST_PROJECT,\n            path.basename(ProjectManager.getProjectRoot().fullPath));\n        const templateVars = {\n            trustProjectMessage,\n            Strings: Strings\n        };\n        return Mustache.render(TrustProjectHTML, templateVars);\n    }\n\n    function _isProjectPreviewTrusted() {\n        // We Do not show a trust project window before executing a live preview in desktop builds as in\n        // desktop, each project will have its on live preview `server:port` domain isolation.\n        // Live preview is almost the same as opening a url in the browser. The user opening a project by going though\n        // a lot of selection folder picker dialogs should be regarded as enough confirmation that the user\n        // intents to open that file for preview via a browser url. The browser security sandbox should\n        // take care of most of the security issues as much as any other normal browsing in a browser.\n        // Showing a trust window is UI friction for 99% of users. The user confirm dialog also relies on the user\n        // taking the decision that an anti-virus/firewall would make- which is not going to end well; and a lot of\n        // our users are school students or new devs, who we should assist. Phoenix trust model will heavily rely on\n        // us doing the necessary sand boxing whenever possible.\n        // A compromised project can have special html that can instruct phoenix to change editor selections and\n        // edit only the project files. We will have safeguards in place to detect anomalous large change requests\n        // to mitigate DOS attacks coming from the live preview in the future. A malicious project changing its on\n        // text only using its own code should be an acceptable risk for now as it cant affect anything else in the\n        // system.\n        if(Phoenix.isTestWindow || Phoenix.isNativeApp){ // for test windows, we trust all test files\n            return true;\n        }\n        // In browsers, The url bar will show up as phcode.dev for live previews and there is a chance that\n        // a malicious project can appear as `phcode.dev` when user live previews. So for every live preview\n        // popout tab which shows `phcode.dev` in browser address bar, we will show a trust live preview\n        // confirm dialog every single time when user opens live preivew project.\n        // Further, since all live previews for all projects uses the same phcode.live domain,\n        // untrusted projects can access data of past opened projects. Future plans for browser versions\n        // include adopting a similar approach to desktop to dynamically generate URLs in the format\n        // `project-name.phcode.live` preventing the past data access problem in browser. This will also let us drop the\n        // trust project screen an work the same as desktop apps.\n        const projectPath = ProjectManager.getProjectRoot().fullPath;\n        if(projectPath === ProjectManager.getWelcomeProjectPath() ||\n            projectPath === ProjectManager.getExploreProjectPath()){\n            return true;\n        }\n        const isTrustedProject = `${PREVIEW_TRUSTED_PROJECT_KEY}-${projectPath}`;\n        return !!PhStore.getItem(isTrustedProject);\n    }\n\n    window._trustCurrentProjectForLivePreview = function () {\n        $iframe.attr('srcdoc', null);\n        const projectPath = ProjectManager.getProjectRoot().fullPath;\n        const isTrustedProjectKey = `${PREVIEW_TRUSTED_PROJECT_KEY}-${projectPath}`;\n        PhStore.setItem(isTrustedProjectKey, true);\n        _loadPreview(true);\n    };\n\n    function _setProjectReadmePreviewdOnce() {\n        const projectPath = ProjectManager.getProjectRoot().fullPath;\n        const previewReadmeKey = `${PREVIEW_PROJECT_README_KEY}-${projectPath}`;\n        PhStore.setItem(previewReadmeKey, true);\n    }\n\n    function _isProjectReadmePreviewdOnce() {\n        const projectPath = ProjectManager.getProjectRoot().fullPath;\n        const previewReadmeKey = `${PREVIEW_PROJECT_README_KEY}-${projectPath}`;\n        return !!PhStore.getItem(previewReadmeKey);\n    }\n\n    ExtensionInterface.registerExtensionInterface(\n        ExtensionInterface._DEFAULT_EXTENSIONS_INTERFACE_NAMES.PHOENIX_LIVE_PREVIEW, exports);\n\n    /**\n     * @private\n     * @return {StaticServerProvider} The singleton StaticServerProvider initialized\n     * on app ready.\n     */\n    function _createStaticServer() {\n        var config = {\n            pathResolver: ProjectManager.makeProjectRelativeIfPossible,\n            root: ProjectManager.getProjectRoot().fullPath\n        };\n\n        return new StaticServer.StaticServer(config);\n    }\n\n    // Templates\n    ExtensionUtils.loadStyleSheet(module, \"live-preview.css\");\n    // Other vars\n    let panel,\n        urlPinned,\n        currentLivePreviewURL = \"\",\n        currentPreviewFile = '';\n\n    function _blankIframe() {\n        // we have to remove the dom node altog as at time chrome fails to clear workers if we just change\n        // src. so we delete the node itself to eb thorough.\n        let newIframe = $(LIVE_PREVIEW_IFRAME_HTML);\n        newIframe.insertAfter($iframe);\n        $iframe.remove();\n        $iframe = newIframe;\n    }\n\n    let panelShownAtStartup;\n    function _setPanelVisibility(isVisible) {\n        if (isVisible) {\n            panelShownAtStartup = true;\n            $icon.toggleClass(\"active\");\n            panel.show();\n            _loadPreview(true, true);\n            _showCustomServerBannerIfNeeded();\n        } else {\n            $icon.toggleClass(\"active\");\n            _blankIframe();\n            panel.hide();\n        }\n    }\n\n    function _startOrStopLivePreviewIfRequired(explicitClickOnLPIcon) {\n        let visible = panel && panel.isVisible();\n        if(visible && (LiveDevelopment.isInactive() || explicitClickOnLPIcon)) {\n            LiveDevelopment.openLivePreview();\n        } else if(!visible && LiveDevelopment.isActive()\n            && !StaticServer.hasActiveLivePreviews()) {\n            LiveDevelopment.closeLivePreview();\n        }\n    }\n    function _toggleVisibilityOnClick() {\n        let visible = !panel.isVisible();\n        _setPanelVisibility(visible);\n        _startOrStopLivePreviewIfRequired(true);\n    }\n\n    function _togglePinUrl() {\n        let pinStatus = $pinUrlBtn.hasClass('pin-icon');\n        if(pinStatus){\n            $pinUrlBtn.removeClass('pin-icon').addClass('unpin-icon');\n        } else {\n            $pinUrlBtn.removeClass('unpin-icon').addClass('pin-icon');\n        }\n        urlPinned = !pinStatus;\n        LiveDevelopment.setLivePreviewPinned(urlPinned, currentPreviewFile);\n        _loadPreview(true);\n        Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW, \"pinURLBtn\", \"click\");\n    }\n\n    const ALLOWED_BROWSERS_NAMES = [`chrome`, `firefox`, `safari`, `edge`, `browser`, `browserPrivate`];\n    function _popoutLivePreview(browserName) {\n        // We cannot use $iframe.src here if panel is hidden\n        const openURL = StaticServer.getTabPopoutURL(currentLivePreviewURL);\n        if(browserName && ALLOWED_BROWSERS_NAMES.includes(browserName)){\n            Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW, \"popout\", browserName);\n            NodeUtils.openUrlInBrowser(openURL, browserName)\n                .then(()=>{\n                    _loadPreview(true);\n                    _setPanelVisibility(false);\n                })\n                .catch(err=>{\n                    console.error(\"Error opening url in browser: \", browserName, err);\n                    Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW, \"popFail\", browserName);\n                    Dialogs.showModalDialog(\n                        DefaultDialogs.DIALOG_ID_ERROR,\n                        StringUtils.format(Strings.LIVE_DEV_OPEN_ERROR_TITLE, browserName),\n                        StringUtils.format(Strings.LIVE_DEV_OPEN_ERROR_MESSAGE, browserName)\n                    );\n                });\n        } else {\n            NativeApp.openURLInDefaultBrowser(openURL, \"livePreview\");\n            Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW, \"popoutBtn\", \"click\");\n            _loadPreview(true);\n            _setPanelVisibility(false);\n        }\n    }\n\n    function _setTitle(fileName, fullPath, currentLivePreviewURL) {\n        let message = Strings.LIVE_DEV_SELECT_FILE_TO_PREVIEW,\n            tooltip = message;\n        if(fileName){\n            message = `${fileName}`;\n            tooltip = StringUtils.format(Strings.LIVE_DEV_TOOLTIP_SHOW_IN_EDITOR, fileName);\n        }\n        if(currentLivePreviewURL){\n            tooltip = `${tooltip}\\n${currentLivePreviewURL}`;\n        }\n        $panelTitle.text(currentLivePreviewURL || message);\n        $panelTitle.attr(\"title\", tooltip);\n        $panelTitle.attr(\"data-fullPath\", fullPath);\n    }\n\n    function _showOpenBrowserIcons() {\n        if(!Phoenix.isNativeApp) {\n            return;\n        }\n        // only in desktop builds we show open with browser icons\n        $chromeButton.removeClass(\"forced-hidden\");\n        $chromeButtonBallast.removeClass(\"forced-hidden\");\n        $chromeButtonBallast.addClass(\"forced-inVisible\");\n\n        $edgeButton.removeClass(\"forced-hidden\");\n        $edgeButtonBallast.removeClass(\"forced-hidden\");\n        $edgeButtonBallast.addClass(\"forced-inVisible\");\n\n        $firefoxButton.removeClass(\"forced-hidden\");\n        $firefoxButtonBallast.removeClass(\"forced-hidden\");\n        $firefoxButtonBallast.addClass(\"forced-inVisible\");\n        if (brackets.platform === \"mac\") {\n            $safariButton.removeClass(\"forced-hidden\");\n            $safariButtonBallast.removeClass(\"forced-hidden\");\n            $safariButtonBallast.addClass(\"forced-inVisible\");\n        }\n    }\n\n    /**\n     * This function is called when user clicks the preview mode button (play button icon)\n     * when this button is clicked we switch the mode button dropdown to preview mode\n     */\n    function _handlePreviewBtnClick() {\n        if($previewBtn.hasClass('selected')) {\n            $previewBtn.removeClass('selected');\n            const isEditFeaturesActive = LiveDevelopment.isProUser;\n            if(modeThatWasSelected) {\n                if(modeThatWasSelected === 'edit' && !isEditFeaturesActive) {\n                    // we just set the preference as preference has change handlers that will update the config\n                    PreferencesManager.set(PREFERENCE_LIVE_PREVIEW_MODE, \"highlight\");\n                } else {\n                    PreferencesManager.set(PREFERENCE_LIVE_PREVIEW_MODE, modeThatWasSelected);\n                }\n            }\n        } else {\n            $previewBtn.addClass('selected');\n            modeThatWasSelected = PreferencesManager.get(PREFERENCE_LIVE_PREVIEW_MODE);\n            PreferencesManager.set(PREFERENCE_LIVE_PREVIEW_MODE, \"preview\");\n        }\n    }\n\n    async function _createExtensionPanel() {\n        let templateVars = {\n            Strings: Strings,\n            livePreview: Strings.LIVE_DEV_STATUS_TIP_OUT_OF_SYNC,\n            clickToReload: Strings.LIVE_DEV_CLICK_TO_RELOAD_PAGE,\n            clickToPreview: Strings.LIVE_PREVIEW_MODE_PREVIEW,\n            livePreviewSettings: Strings.LIVE_DEV_SETTINGS,\n            livePreviewConfigureModes: Strings.LIVE_PREVIEW_CONFIGURE_MODES,\n            clickToPopout: Strings.LIVE_DEV_CLICK_POPOUT,\n            openInChrome: Strings.LIVE_DEV_OPEN_CHROME,\n            openInSafari: Strings.LIVE_DEV_OPEN_SAFARI,\n            openInEdge: Strings.LIVE_DEV_OPEN_EDGE,\n            openInFirefox: Strings.LIVE_DEV_OPEN_FIREFOX,\n            clickToPinUnpin: Strings.LIVE_DEV_CLICK_TO_PIN_UNPIN\n        };\n        const PANEL_MIN_SIZE = 50;\n        const INITIAL_PANEL_SIZE = document.body.clientWidth/2.5;\n        $icon = $(\"#toolbar-go-live\");\n        $icon.click(_toggleVisibilityOnClick);\n        $panel = $(Mustache.render(panelHTML, templateVars));\n        $iframe = $panel.find(\"#panel-live-preview-frame\");\n        $pinUrlBtn = $panel.find(\"#pinURLButton\");\n        $reloadBtn = $panel.find(\"#reloadLivePreviewButton\");\n        $livePreviewPopBtn = $panel.find(\"#livePreviewPopoutButton\");\n        $chromeButton = $panel.find(\"#chromeButton\");\n        $safariButton = $panel.find(\"#safariButton\");\n        $edgeButton = $panel.find(\"#edgeButton\");\n        $firefoxButton = $panel.find(\"#firefoxButton\");\n        // ok i dont know enough CSS to do this without these Ballast/ this works for the limited dev time I have.\n        $chromeButtonBallast = $panel.find(\"#chromeButtonBallast\");\n        $safariButtonBallast = $panel.find(\"#safariButtonBallast\");\n        $edgeButtonBallast = $panel.find(\"#edgeButtonBallast\");\n        $firefoxButtonBallast = $panel.find(\"#firefoxButtonBallast\");\n        $panelTitle = $panel.find(\"#panel-live-preview-title\");\n        $settingsIcon = $panel.find(\"#livePreviewSettingsBtn\");\n        $modeBtn = $panel.find(\"#livePreviewModeBtn\");\n        $previewBtn = $panel.find(\"#previewModeLivePreviewButton\");\n\n        $panel.find(\".live-preview-settings-banner-btn\").on(\"click\", ()=>{\n            CommandManager.execute(Commands.FILE_LIVE_FILE_PREVIEW_SETTINGS);\n            Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW, \"settingsBtnBanner\", \"click\");\n        });\n        $panel.find(\".custom-server-banner-close-icon\").on(\"click\", ()=>{\n            $panel.find(\".live-preview-custom-banner\").addClass(\"forced-hidden\");\n        });\n        $iframe[0].onload = function () {\n            $iframe.attr('srcdoc', null);\n        };\n        $panelTitle.on(\"click\", ()=>{\n            const fullPath = $panelTitle.attr(\"data-fullPath\");\n            const openPanes = MainViewManager.findInAllWorkingSets(fullPath);\n            let paneToUse = MainViewManager.ACTIVE_PANE;\n            if(openPanes.length) {\n                paneToUse = openPanes[0].paneId;\n            }\n            FileViewController.openFileAndAddToWorkingSet(fullPath, paneToUse);\n        });\n        $chromeButton.on(\"click\", ()=>{\n            _popoutLivePreview(\"chrome\");\n        });\n        $safariButton.on(\"click\", ()=>{\n            _popoutLivePreview(\"safari\");\n        });\n        $edgeButton.on(\"click\", ()=>{\n            _popoutLivePreview(\"edge\");\n        });\n        $firefoxButton.on(\"click\", ()=>{\n            _popoutLivePreview(\"firefox\");\n        });\n\n        $modeBtn.on(\"click\", _handleLPModeBtnClick);\n        $previewBtn.on(\"click\", _handlePreviewBtnClick);\n\n        _showOpenBrowserIcons();\n        $settingsIcon.click(()=>{\n            CommandManager.execute(Commands.FILE_LIVE_FILE_PREVIEW_SETTINGS);\n            Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW, \"settingsBtn\", \"click\");\n        });\n\n        const popoutSupported = Phoenix.isNativeApp\n            || Phoenix.browser.desktop.isChromeBased || Phoenix.browser.desktop.isFirefox;\n        if(!popoutSupported){\n            // live preview can be popped out currently in only chrome based browsers. The cross domain iframe\n            // that serves the live preview(phcode.live) is sandboxed to the tab in which phcode.dev resides.\n            // all iframes in the tab can communicate between each other, but when you popout another tab, it forms\n            // its own sandbox and firefox/safari prevents communication from iframe in one tab to another. chrome\n            // doesn't seem to enforce this restriction. Since this is a core usecase, we will try to enable this\n            // workflow whenever possible.\n            $livePreviewPopBtn.addClass(\"forced-hidden\");\n        }\n\n        panel = WorkspaceManager.createPluginPanel(LIVE_PREVIEW_PANEL_ID, $panel,\n            PANEL_MIN_SIZE, $icon, INITIAL_PANEL_SIZE);\n\n        WorkspaceManager.recomputeLayout(false);\n        $pinUrlBtn.click(_togglePinUrl);\n        $livePreviewPopBtn.click(_popoutLivePreview);\n        $reloadBtn.click(()=>{\n            _loadPreview(true, true);\n            Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW, \"reloadBtn\", \"click\");\n        });\n\n        // Set up ResizeObserver for overlay width adjustments\n        // to understand why we're doing this read _setOverlayWidth function\n        new ResizeObserver(_setOverlayWidth).observe($panel[0]);\n    }\n\n    async function _loadPreview(force, isReload) {\n        // we wait till the first server ready event is received till we render anything. else a 404-page may\n        // briefly flash on first load of phoenix as we try to load the page before the server is available.\n        const isPreviewLoadable = panel.isVisible() || StaticServer.hasActiveLivePreviews();\n        if(!isPreviewLoadable){\n            return;\n        }\n        // panel-live-preview-title\n        let previewDetails = await StaticServer.getPreviewDetails();\n        if(urlPinned && !force) {\n            return;\n        }\n        let newSrc = encodeURI(previewDetails.URL);\n        if($iframe.attr('src') === newSrc && !force){\n            // we already have this url loaded in previews!\n            return;\n        }\n        // we have to create a new iframe on every switch as we use cross domain iframes for phcode.live which\n        // the browser sandboxes strictly and sometimes it wont allow a src change on our iframe causing live\n        // preview breaks sporadically. to alleviate this, we create a new iframe every time.\n        if(!urlPinned) {\n            currentLivePreviewURL = newSrc;\n            currentPreviewFile = previewDetails.fullPath;\n        }\n        const existingPreviewFile = $iframe && $iframe.attr('data-original-path');\n        const existingPreviewURL = $iframe && $iframe.attr('data-original-src');\n        if(isReload && previewDetails.isNoPreview && existingPreviewURL &&\n            existingPreviewFile && ProjectManager.isWithinProject(existingPreviewFile)) {\n            currentLivePreviewURL = existingPreviewURL;\n            currentPreviewFile = existingPreviewFile;\n        } else if(isReload){\n            LiveDevelopment.openLivePreview();\n        }\n        let relativeOrFullPath= ProjectManager.makeProjectRelativeIfPossible(currentPreviewFile);\n        relativeOrFullPath = Phoenix.app.getDisplayPath(relativeOrFullPath);\n        _setTitle(relativeOrFullPath, currentPreviewFile,\n            previewDetails.isCustomServer ? currentLivePreviewURL : \"\");\n        if(panel.isVisible()) {\n            if(!customLivePreviewBannerShown && LivePreviewSettings.isUsingCustomServer()\n                && previewDetails.isCustomServer) {\n                customLivePreviewBannerShown = true;\n                $panel.find(\".live-preview-custom-banner\").removeClass(\"forced-hidden\");\n                $panel.find(\".live-preview-banner-message\").text(\n                    StringUtils.format(Strings.LIVE_PREVIEW_CUSTOM_SERVER_BANNER,\n                        LivePreviewSettings.getCustomServeBaseURL())\n                );\n            }\n            let newIframe = $(LIVE_PREVIEW_IFRAME_HTML);\n            newIframe.insertAfter($iframe);\n            $iframe.remove();\n            $iframe = newIframe;\n            if(_isProjectPreviewTrusted()){\n                $iframe.attr('src', currentLivePreviewURL);\n                // we have to save src as the iframe src attribute may have redirected, and we cannot read it as its\n                // a third party domain once its redirected.\n                $iframe.attr('data-original-src', currentLivePreviewURL);\n                $iframe.attr('data-original-path', currentPreviewFile);\n                if(Phoenix.isTestWindow) {\n                    window._livePreviewIntegTest.currentLivePreviewURL = currentLivePreviewURL;\n                    window._livePreviewIntegTest.urlLoadCount++;\n                }\n            } else {\n                $iframe.attr('srcdoc', _getTrustProjectPage());\n            }\n        }\n        Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW, \"render\",\n            utils.getExtension(previewDetails.fullPath));\n        StaticServer.redirectAllTabs(currentLivePreviewURL, force);\n        if(Phoenix.isTestWindow) {\n            // for integ tests\n            window._livePreviewIntegTest.redirectURL = currentLivePreviewURL;\n            window._livePreviewIntegTest.redirectURLforce = force;\n        }\n    }\n\n    async function _projectFileChanges(evt, changedFile) {\n        if(changedFile && changedFile.isFile && (utils.isPreviewableFile(changedFile.fullPath) ||\n            utils.isServerRenderedFile(changedFile.fullPath))){\n            // we are getting this change event somehow.\n            // bug, investigate why we get this change event as a project file change.\n            const previewDetails = await StaticServer.getPreviewDetails();\n            let shouldReload = false;\n            if(previewDetails.isCustomServer && !previewDetails.serverSupportsHotReload){\n                shouldReload = true;\n            }\n            if(!previewDetails.isCustomServer && !(LiveDevelopment.isActive() && previewDetails.isHTMLFile)) {\n                // We force reload live preview on save for all non html preview-able file or\n                // if html file and live preview isnt active.\n                shouldReload = true;\n            }\n            if(shouldReload) {\n                _loadPreview(true);\n            }\n        }\n    }\n\n    function _openReadmeMDIfFirstTime() {\n        if(!_isProjectReadmePreviewdOnce() && !Phoenix.isTestWindow){\n            const readmePath = `${ProjectManager.getProjectRoot().fullPath}README.md`;\n            const fileEntry = FileSystem.getFileForPath(readmePath);\n            fileEntry.exists(function (err, exists) {\n                if (!err && exists) {\n                    _setPanelVisibility(true);\n                    CommandManager.execute(Commands.CMD_ADD_TO_WORKINGSET_AND_OPEN, {fullPath: readmePath});\n                    _setProjectReadmePreviewdOnce();\n                }\n            });\n        }\n    }\n\n    let startupFilesLoadHandled = false;\n    async function _projectOpened() {\n        customLivePreviewBannerShown = false;\n        $panel.find(\".live-preview-custom-banner\").addClass(\"forced-hidden\");\n        _openReadmeMDIfFirstTime();\n        _customServerMetrics();\n        if(!LiveDevelopment.isActive()\n            && (panel.isVisible() || StaticServer.hasActiveLivePreviews())) {\n            // we do this only once after project switch if live preview for a doc is not active.\n            LiveDevelopment.openLivePreview();\n        }\n        if(urlPinned){\n            _togglePinUrl();\n        }\n        $iframe.attr('src', StaticServer.getNoPreviewURL());\n        if(!panelShownAtStartup && !isBrowser && ProjectManager.isStartupFilesLoaded()){\n            // we dont do this in browser as the virtual server may not yet be started on app start\n            // project open and a 404 page will briefly flash in the browser!\n            // this mainly applies when phoenix is started with a preview file already open in previous exit\n            startupFilesLoadHandled = true;\n            const currentDocument = DocumentManager.getCurrentDocument();\n            const currentFile = currentDocument? currentDocument.file : ProjectManager.getSelectedItem();\n            const isPreviewable = currentFile ? utils.isPreviewableFile(currentFile.fullPath) : false;\n            if(isPreviewable){\n                _setPanelVisibility(true);\n            }\n        }\n        if(!panel.isVisible()){\n            return;\n        }\n        _loadPreview(true);\n    }\n\n    function _startupFilesLoaded() {\n        if(startupFilesLoadHandled) {\n            return;\n            // we have to use this handled flag as there is no ordering of EVENT_AFTER_STARTUP_FILES_LOADED\n            // and EVENT_PROJECT_OPEN. if _projectOpened has already shown the live preview panel when it saw that\n            // ProjectManager.isStartupFilesLoaded() is true, we should not call project opened again at boot.\n        }\n        if(!panelShownAtStartup && !isBrowser && ProjectManager.isStartupFilesLoaded()){\n            // we dont do this in browser as the virtual server may not yet be started on app start\n            // project open and a 404 page will briefly flash in the browser!\n            // this mainly applies when phoenix is started with a preview file already open in previous exit\n            const currentDocument = DocumentManager.getCurrentDocument();\n            const currentFile = currentDocument? currentDocument.file : ProjectManager.getSelectedItem();\n            const isPreviewable = currentFile ? utils.isPreviewableFile(currentFile.fullPath) : false;\n            if(isPreviewable){\n                _setPanelVisibility(true);\n                _loadPreview(true, true);\n            }\n        }\n    }\n\n    function _projectClosed() {\n        if(urlPinned) {\n            _togglePinUrl();\n        }\n        LiveDevelopment.closeLivePreview();\n        if(customServerModalBar){\n            customServerModalBar.close();\n            customServerModalBar = null;\n        }\n    }\n\n    function _activeDocChanged(event, focusedEditor, lostEditor) {\n        if(!LivePreviewSettings.isUsingCustomServer() && !LiveDevelopment.isActive()\n            && (panel.isVisible() || StaticServer.hasActiveLivePreviews())) {\n            // we do this only once after project switch if live preview for a doc is not active.\n            LiveDevelopment.openLivePreview();\n        }\n\n        // we hide the overlay when there's no editor or its a non-previewable file\n        if (!focusedEditor || !focusedEditor.document) {\n            _hideOverlay();\n            return;\n        }\n\n        const filePath = focusedEditor.document.file.fullPath;\n        const isPreviewable = utils.isPreviewableFile(filePath) || utils.isServerRenderedFile(filePath);\n        const customServeURL = LivePreviewSettings.isUsingCustomServer() &&\n            LivePreviewSettings.getCustomServerConfig(filePath);\n\n        if (!isPreviewable && !customServeURL) {\n            _hideOverlay();\n        }\n    }\n\n    /**\n     * EVENT_OPEN_PREVIEW_URL triggers this once live preview infrastructure is instrumented and ready to accept live\n     * preview connections from browsers. So, if we have loaded an earlier live preview, that is most likely not\n     * instrumented code and just plain html for the previewed file. We force load the live preview again here to\n     * load the instrumented live preview code.\n     * @param _event\n     * @param previewDetails\n     * @return {Promise<void>}\n     * @private\n     */\n    async function _openLivePreviewURL(_event, previewDetails) {\n        if(LivePreviewSettings.isUsingCustomServer()){\n            _hideOverlay();\n            return;\n        }\n        _loadPreview(true);\n        const currentPreviewDetails = await StaticServer.getPreviewDetails();\n        if(currentPreviewDetails.isHTMLFile && currentPreviewDetails.fullPath !== previewDetails.fullPath){\n            console.error(\"Live preview URLs differ between phoenix live preview extension and core live preview\",\n                currentPreviewDetails, previewDetails);\n        }\n\n        const status = MultiBrowserLiveDev.status;\n        if (status === MultiBrowserLiveDev.STATUS_CONNECTING) {\n            _handleOverlay(Strings.LIVE_DEV_STATUS_TIP_PROGRESS1, status);\n        } else if (status === MultiBrowserLiveDev.STATUS_SYNC_ERROR) {\n            _handleOverlay(Strings.LIVE_DEV_STATUS_TIP_SYNC_ERROR, status);\n        }\n    }\n\n    async function _currentFileChanged(_event, changedFile) {\n        if(!changedFile || !changedFile.fullPath || !ProjectManager.isStartupFilesLoaded()){\n            return;\n        }\n        const fullPath = changedFile.fullPath;\n        if(changedFile && _shouldShowCustomServerBar(fullPath)){\n            _showCustomServerBar(fullPath);\n        }\n        const shouldUseInbuiltPreview = utils.isMarkdownFile(fullPath) || utils.isSVG(fullPath);\n        const customServeURL = LivePreviewSettings.isUsingCustomServer() &&\n            LivePreviewSettings.getCustomServerConfig(fullPath);\n        if(urlPinned || (LivePreviewSettings.isUsingCustomServer() && !customServeURL && !shouldUseInbuiltPreview)){\n            return;\n        }\n        // If we are using a custom server URL, we need to handle the live preview carefully:\n        // - If the user has not clicked on a previewable file from the custom server URL,\n        //   we should always show the base server URL. This is because some projects, like React,\n        //   do not have an HTML file and only contain JSX/render files. In these cases, we should show the live preview\n        // - However, if the user is already previewing a file from the custom server (e.g., customBaseURL/some.html),\n        //   we should not switch back to the base URL when they click on another file (e.g., a JS file).\n        //   This is because the user might be editing a related file of the custom-served page.\n        // - Therefore, we only switch to the base URL if the current preview has nothing to do with the custom server\n        //   URL for a better user experience.\n        const shouldSwitchCustomServer = customServeURL && currentLivePreviewURL !== customServeURL &&\n            (!currentLivePreviewURL || !currentLivePreviewURL.startsWith(customServeURL));\n        if(changedFile && (utils.isPreviewableFile(fullPath) ||\n            utils.isServerRenderedFile(fullPath) || shouldSwitchCustomServer)){\n            _loadPreview();\n            if(!panelShownAtStartup && ProjectManager.isStartupFilesLoaded()){\n                let previewDetails = await StaticServer.getPreviewDetails();\n                if(previewDetails && !previewDetails.isNoPreview) {\n                    _setPanelVisibility(true);\n                    _loadPreview();\n                }\n            }\n        }\n    }\n\n    function _showSettingsDialog() {\n        return new Promise(resolve=>{\n            LivePreviewSettings.showSettingsDialog()\n                .then(()=>{\n                    _loadPreview();\n                    resolve();\n                });\n        });\n    }\n\n    function _customServerMetrics() {\n        if(LivePreviewSettings.isUsingCustomServer()){\n            Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW, \"customServ\", \"yes\");\n            Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW, \"framework\",\n                LivePreviewSettings.getCustomServerFramework() || \"unknown\");\n            if(LivePreviewSettings.serverSupportsHotReload()) {\n                Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW, \"hotReload\", \"yes\");\n            }\n        }\n    }\n\n    function _showCustomServerBannerIfNeeded() {\n        const editor = EditorManager.getActiveEditor();\n        if(!editor || !_shouldShowCustomServerBar(editor.document.file.fullPath)){\n            return;\n        }\n        _showCustomServerBar(editor.document.file.fullPath);\n    }\n\n    function _shouldShowCustomServerBar(fullPath) {\n        const isBannerAck = StateManager.get(STATE_CUSTOM_SERVER_BANNER_ACK, StateManager.PROJECT_CONTEXT);\n        let panelVisible = panel && panel.isVisible();\n        if(isBannerAck || LivePreviewSettings.isUsingCustomServer() || !panelVisible){\n            return false;\n        }\n        return utils.isServerRenderedFile(fullPath);\n    }\n\n    function _showCustomServerBar(fullFilePath) {\n        if(customServerModalBar){\n            $(\".custom-banner-setup-server-text-message\").html(\n                StringUtils.format(Strings.LIVE_DEV_SETTINGS_BANNER, path.extname(fullFilePath))\n            );\n            return;\n        }\n        // Show the search bar\n        const searchBarHTML =`<div style=\"display: flex;justify-content: end;align-items: baseline;\">\n            <div style=\"margin-right: 5px;\" class=\"custom-banner-setup-server-text-message\">\n                ${StringUtils.format(Strings.LIVE_DEV_SETTINGS_BANNER, path.extname(fullFilePath))}\n            </div>\n            <button class=\"btn btn-mini live-preview-settings\" style=\"margin-right: 5px;\">\n                ${Strings.LIVE_DEV_SETTINGS}\n            </button>\n            <div class=\"close-icon\" style=\"align-self: center;margin-left: 10px;margin-right: 5px;cursor: pointer;\"\n                title=\"${Strings.CLOSE}\">\n                <i class=\"fa-solid fa-xmark\"></i>\n            </div>\n        </div>`;\n        customServerModalBar = new ModalBar(searchBarHTML);\n        const $modal = customServerModalBar.getRoot();\n        $modal.find(\".live-preview-settings\")\n            .click(()=>{\n                _showSettingsDialog()\n                    .then(()=>{\n                        if(LivePreviewSettings.isUsingCustomServer()){\n                            customServerModalBar && customServerModalBar.close();\n                            customServerModalBar = null;\n                            StateManager.set(STATE_CUSTOM_SERVER_BANNER_ACK, true, StateManager.PROJECT_CONTEXT);\n                        }\n                    });\n            });\n        $modal.find(\".close-icon\").click(()=>{\n            customServerModalBar && customServerModalBar.close();\n            customServerModalBar = null;\n            StateManager.set(STATE_CUSTOM_SERVER_BANNER_ACK, true, StateManager.PROJECT_CONTEXT);\n        });\n    }\n\n    function _registerHandlers() {\n        // when clicked anywhere on the page we want to close the dropdown\n        $(\"html\").on(\"click\", function (e) {\n            if ($(e.target).closest(\"#livePreviewModeBtn\").length) { return; }\n            _closeDropdown();\n        });\n\n        $(document).on(\"click\", \"#livePreviewModeBtn\", function (e) {\n            _handleLPModeBtnClick(e);\n        });\n    }\n\n    AppInit.appReady(function () {\n        if(Phoenix.isSpecRunnerWindow){\n            return;\n        }\n        panelShownAtStartup = !LivePreviewSettings.shouldShowLivePreviewAtStartup();\n        Metrics.countEvent(Metrics.EVENT_TYPE.LIVE_PREVIEW, \"atStart\",\n            LivePreviewSettings.shouldShowLivePreviewAtStartup() ? \"show\" : \"hide\");\n        _createExtensionPanel();\n        StaticServer.init();\n        LiveDevServerManager.registerServer({ create: _createStaticServer }, 5);\n        ProjectManager.on(ProjectManager.EVENT_PROJECT_FILE_CHANGED, _projectFileChanges);\n        ProjectManager.on(ProjectManager.EVENT_PROJECT_OPEN, _projectOpened);\n        ProjectManager.on(ProjectManager.EVENT_PROJECT_CLOSE, _projectClosed);\n        EditorManager.on(\"activeEditorChange\", _activeDocChanged);\n        ProjectManager.on(ProjectManager.EVENT_AFTER_STARTUP_FILES_LOADED, _startupFilesLoaded);\n        let fileChangeListenerStartDelay = 0;\n        if(Phoenix.isNativeApp && Phoenix.platform === \"mac\") {\n            // in mac, if we do the `open with Phoenix Code` from finder, then, the open with events come as events\n            // after app start. This causes a problem where if we open a txt file with open with, and an html file was\n            // open previously, then currentFileChange listener will see the html file at first and open the live\n            // preview panel, and immediately, the txt file event will be sent by os resulting in a no preview page.\n            // we should not show a no preview page for opening txt / non-previewable files. So, we dont attach the\n            // change listener in macos for a second to give some time for the os event to reach.\n            fileChangeListenerStartDelay = 600;\n        }\n        setTimeout(()=>{\n            MainViewManager.on(\"currentFileChange\", _currentFileChanged);\n            if(Phoenix.isNativeApp && Phoenix.platform === \"mac\" && MainViewManager.getCurrentlyViewedFile()) {\n                _currentFileChanged(null, MainViewManager.getCurrentlyViewedFile());\n            }\n        }, fileChangeListenerStartDelay);\n        CommandManager.register(Strings.CMD_LIVE_FILE_PREVIEW,  Commands.FILE_LIVE_FILE_PREVIEW, function () {\n            _toggleVisibilityOnClick();\n        });\n        CommandManager.register(Strings.CMD_LIVE_FILE_PREVIEW_SETTINGS,\n            Commands.FILE_LIVE_FILE_PREVIEW_SETTINGS, _showSettingsDialog);\n        let fileMenu = Menus.getMenu(Menus.AppMenuBar.FILE_MENU);\n        fileMenu.addMenuItem(Commands.FILE_LIVE_FILE_PREVIEW, \"\", Menus.AFTER, Commands.FILE_EXTENSION_MANAGER);\n        fileMenu.addMenuItem(Commands.FILE_LIVE_FILE_PREVIEW_SETTINGS, \"\",\n            Menus.AFTER, Commands.FILE_LIVE_FILE_PREVIEW);\n        fileMenu.addMenuDivider(Menus.BEFORE, Commands.FILE_LIVE_FILE_PREVIEW);\n\n        _registerHandlers();\n        // init live preview mode from saved preferences\n        _initializeMode();\n        // listen for pref changes\n        PreferencesManager.on(\"change\", PREFERENCE_LIVE_PREVIEW_MODE, function () {\n            // Get the current preference value directly\n            const newMode = PreferencesManager.get(PREFERENCE_LIVE_PREVIEW_MODE);\n            const isEditFeaturesActive = LiveDevelopment.isProUser;\n\n            // If user tries to set edit mode but edit features are not active, default to highlight\n            let effectiveMode = newMode;\n            if (newMode === \"edit\" && !isEditFeaturesActive) {\n                effectiveMode = \"highlight\";\n                // Update the preference to reflect the actual mode being used\n                PreferencesManager.set(PREFERENCE_LIVE_PREVIEW_MODE, \"highlight\");\n                return; // Return to avoid infinite loop\n            }\n\n            if (effectiveMode === \"highlight\") {\n                _LPHighlightMode();\n                $previewBtn.removeClass('selected');\n            } else if (effectiveMode === \"edit\" && isEditFeaturesActive) {\n                _LPEditMode();\n                $previewBtn.removeClass('selected');\n            } else {\n                _LPPreviewMode();\n                $previewBtn.addClass('selected');\n            }\n\n            _updateModeButton(effectiveMode);\n        });\n\n        // Handle element highlight preference changes from this extension\n        PreferencesManager.on(\"change\", PREFERENCE_PROJECT_ELEMENT_HIGHLIGHT, function() {\n            LiveDevelopment.updateElementHighlightConfig();\n        });\n\n        // Handle image ribbon preference changes from this extension\n        PreferencesManager.on(\"change\", PREFERENCE_PROJECT_IMAGE_RIBBON, function() {\n            LiveDevelopment.updateImageRibbonConfig();\n        });\n\n        // Initialize element highlight config on startup\n        LiveDevelopment.updateElementHighlightConfig();\n        // Initialize image ribbon config on startup\n        LiveDevelopment.updateImageRibbonConfig();\n\n        LiveDevelopment.openLivePreview();\n        LiveDevelopment.on(LiveDevelopment.EVENT_OPEN_PREVIEW_URL, _openLivePreviewURL);\n        LiveDevelopment.on(LiveDevelopment.EVENT_LIVE_PREVIEW_RELOAD, ()=>{\n            // Usually, this event is listened by live preview iframes/tabs and they initiate a location.reload.\n            // But in firefox, the embedded iframe will throw a 404 when we try to reload from within the iframe as\n            // in firefox security posture, the third party live preview iframe phcode.live itself cannot activate\n            // the service worker. So we have to reload the iframe from its parent- ie. phcode.dev. This is not\n            // required in chrome, but we just keep it just for all platforms behaving the same.\n            _loadPreview(true);\n        });\n\n        MultiBrowserLiveDev.on(MultiBrowserLiveDev.EVENT_STATUS_CHANGE, function(event, status) {\n            if(LivePreviewSettings.isUsingCustomServer()){\n                _hideOverlay();\n            } else if (status === MultiBrowserLiveDev.STATUS_CONNECTING) {\n                _handleOverlay(Strings.LIVE_DEV_STATUS_TIP_PROGRESS1, status);\n            } else if (status === MultiBrowserLiveDev.STATUS_SYNC_ERROR) {\n                _handleOverlay(Strings.LIVE_DEV_STATUS_TIP_SYNC_ERROR, status);\n            } else {\n                _hideOverlay();\n            }\n        });\n\n        function refreshPreview() {\n            StaticServer.getPreviewDetails().then((previewDetails)=>{\n                _openReadmeMDIfFirstTime();\n                if(!LivePreviewSettings.shouldShowLivePreviewAtStartup()){\n                    return;\n                }\n                // we show the live preview\n                // in browser, we always show the live preview on startup even if its a no preview page\n                // Eg. in mac safari browser we show mac doesnt support live preview page in live preview.\n                if(previewDetails.URL && (isBrowser || !previewDetails.isNoPreview) && !panelShownAtStartup){\n                    // only show if there is some file to preview and not the default no-preview preview on startup\n                    _setPanelVisibility(true);\n                }\n                // in browsers, the static server is not reset on every call to open live preview, so its safe to reload\n                // we need to reload once as\n                const shouldReload = !Phoenix.isNativeApp;\n                _loadPreview(true, shouldReload);\n            });\n        }\n\n        let customServerRefreshedOnce = false;\n        StaticServer.on(StaticServer.EVENT_SERVER_READY, function (_evt, event) {\n            if(LivePreviewSettings.isUsingCustomServer() && customServerRefreshedOnce){\n                return;\n            }\n            customServerRefreshedOnce = true;\n            refreshPreview();\n        });\n        function _handleNewCustomServer() {\n            customLivePreviewBannerShown = false;\n            refreshPreview();\n            _customServerMetrics();\n        }\n\n        LivePreviewSettings.on(LivePreviewSettings.EVENT_SERVER_CHANGED, _handleNewCustomServer);\n        LivePreviewSettings.on(LivePreviewSettings.EVENT_CUSTOM_SERVER_ENABLED_CHANGED, (_evt, enabled)=>{\n            if(!enabled) {\n                $panel.find(\".live-preview-custom-banner\").addClass(\"forced-hidden\");\n            } else {\n                _handleNewCustomServer();\n            }\n        });\n\n        let consecutiveEmptyClientsCount = 0;\n        setInterval(()=>{\n            if(!StaticServer.hasActiveLivePreviews()){\n                consecutiveEmptyClientsCount ++;\n            } else {\n                consecutiveEmptyClientsCount = 0;\n            }\n            if(consecutiveEmptyClientsCount > 5){\n                _startOrStopLivePreviewIfRequired();\n            }\n        }, 1000);\n        _projectOpened();\n    });\n\n    // private API to be used inside phoenix codebase only\n    exports.LIVE_PREVIEW_PANEL_ID = LIVE_PREVIEW_PANEL_ID;\n});\n\n\n"],"file":"main.js"}