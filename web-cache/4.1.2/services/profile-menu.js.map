{"version":3,"sources":["services/profile-menu.js"],"names":["define","require","exports","module","Mustache","PopUpManager","ThemeManager","Strings","StringUtils","LoginService","KernalModeTrust","window","Error","$icon","_createSVGIcon","initials","bgColor","_updateProfileIcon","empty","append","_removeProfileIcon","loginTemplate","profileTemplate","$popup","isPopupVisible","isBackgroundRefresh","documentClickHandler","_handleSignInBtnClick","closePopup","loginService","signInToAccount","_handleSignOutBtnClick","signOutAccount","_handleContactSupportBtnClick","Phoenix","app","openURLInDefaultBrowser","brackets","config","support_url","_handleAccountDetailsBtnClick","account_url","removePopUp","$","document","off","positionPopup","$profileButton","length","buttonPos","offset","popupWidth","outerWidth","windowWidth","width","top","outerHeight","left","Math","min","max","css","_setupDocumentClickHandler","event","contains","target","setTimeout","on","showLoginPopup","renderedTemplate","render","getProLink","purchase_url","getEffectiveEntitlements","then","effectiveEntitlements","proInfoHtml","isInProTrial","planName","format","PROMO_PRO_TRIAL_DAYS_LEFT","trialDaysRemaining","plan","isSubscriber","fullName","main_pro_plan","find","after","catch","error","console","addPopUp","remove","closeCurrentPopups","_updateBranding","entitlements","$brandingLink","pro","name","USER_FREE_PLAN_NAME_DO_NOT_TRANSLATE","validTill","displayName","attr","addClass","html","removeClass","text","userEmail","SecureEmail","HTMLElement","[object Object]","super","shadow","this","attachShadow","mode","innerHTML","customElements","userName","SecureName","_loadUserDetailsIframe","isNativeApp","$iframe","$secureName","$secureEmail","accountBaseURL","getAccountBaseURL","currentTheme","getCurrentTheme","nameColor","dark","iframeURL","messageHandler","trustedOrigin","startsWith","location","origin","URL","data","loaded","hide","show","removeEventListener","addEventListener","is","log","_updatePopupWithEntitlements","$getProLink","$planName","proTitle","profileview","quota","$quotaSection","titleText","usageText","usedPercent","htmlMessage","$htmlMessageSection","showProfilePopup","profileData","getProfile","email","firstName","lastName","templateData","profileIcon","avatarColor","color","planClass","cachedEntitlements","_refreshEntitlementsInBackground","async","freshEntitlements","togglePopup","isLoggedIn","wasLoggedInBefore","_verifyLoginStatus","isLoggedInNow","_hasProActive","_setBrandingForNonLoggedInUser","inited","init","helpButtonID","id","href","class","title","CMD_USER_PROFILE","appendTo","EVENT_ENTITLEMENTS_CHANGED","setNotLoggedIn","hasProActive","clearEntitlements","setLoggedIn","initial"],"mappings":"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","sourcesContent":["define(function (require, exports, module) {\n    const Mustache = require(\"thirdparty/mustache/mustache\"),\n        PopUpManager = require(\"widgets/PopUpManager\"),\n        ThemeManager = require(\"view/ThemeManager\"),\n        Strings      = require(\"strings\"),\n        StringUtils = require(\"utils/StringUtils\"),\n        LoginService = require(\"./login-service\");\n\n    const KernalModeTrust = window.KernalModeTrust;\n    if(!KernalModeTrust){\n        // integrated extensions will have access to kernal mode, but not external extensions\n        throw new Error(\"profile menu should have access to KernalModeTrust. Cannot boot without trust ring\");\n    }\n\n    let $icon;\n\n    function _createSVGIcon(initials, bgColor) {\n        return `<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\">\n                <circle cx=\"12\" cy=\"12\" r=\"10\" fill=\"${bgColor}\"/>\n            <text x=\"12\" y=\"12\" text-anchor=\"middle\" dominant-baseline=\"central\" font-size=\"10\" fill=\"#fff\" font-family=\"Inter, sans-serif\">\n            ${initials}</text>\n        </svg>`;\n    }\n\n    function _updateProfileIcon(initials, bgColor) {\n        $icon.empty()\n            .append(_createSVGIcon(initials, bgColor));\n    }\n\n    function _removeProfileIcon() {\n        $icon.empty();\n    }\n\n    // HTML templates\n    const loginTemplate = require(\"text!./html/login-popup.html\");\n    const profileTemplate = require(\"text!./html/profile-popup.html\");\n\n    // for the popup DOM element\n    let $popup = null;\n\n    // this is to track whether the popup is visible or not\n    let isPopupVisible = false;\n\n    // Track if we're doing a background refresh to avoid closing user-opened popups\n    let isBackgroundRefresh = false;\n\n    // this is to handle document click events to close popup\n    let documentClickHandler = null;\n\n    function _handleSignInBtnClick() {\n        closePopup(); // need to close the current popup to show the new one\n        KernalModeTrust.loginService.signInToAccount();\n    }\n\n    function _handleSignOutBtnClick() {\n        closePopup();\n        KernalModeTrust.loginService.signOutAccount();\n    }\n\n    function _handleContactSupportBtnClick() {\n        Phoenix.app.openURLInDefaultBrowser(brackets.config.support_url);\n    }\n\n    function _handleAccountDetailsBtnClick() {\n        Phoenix.app.openURLInDefaultBrowser(brackets.config.account_url);\n    }\n\n    /**\n     * Close the popup if it's open\n     * this is called at various instances like when the user click on the profile icon even if the popup is open\n     * or when user clicks somewhere else on the document\n     */\n    function closePopup() {\n        if ($popup) {\n            PopUpManager.removePopUp($popup);\n            $popup = null;\n            isPopupVisible = false;\n        }\n\n        // we need to remove document click handler if it already exists\n        if (documentClickHandler) {\n            $(document).off(\"mousedown\", documentClickHandler);\n            documentClickHandler = null;\n        }\n    }\n\n    /**\n     * this function is to position the popup near the profile button\n     */\n    function positionPopup() {\n        const $profileButton = $(\"#user-profile-button\");\n\n        if ($profileButton.length && $popup) {\n            const buttonPos = $profileButton.offset();\n            const popupWidth = $popup.outerWidth();\n            const windowWidth = $(window).width();\n\n            // pos above the profile button\n            let top = buttonPos.top - $popup.outerHeight() - 10;\n\n            // If popup would go off the right edge of the window, align right edge of popup with right edge of button\n            let left = Math.min(\n                buttonPos.left - popupWidth + $profileButton.outerWidth(),\n                windowWidth - popupWidth - 10\n            );\n\n            // never go off left edge\n            left = Math.max(10, left);\n\n            $popup.css({\n                top: top + \"px\",\n                left: left + \"px\"\n            });\n        }\n    }\n\n    /**\n     * this function is responsible to set up a click handler to close the popup when clicking outside\n     */\n    function _setupDocumentClickHandler() {\n        // remove any existing handlers\n        if (documentClickHandler) {\n            $(document).off(\"mousedown\", documentClickHandler);\n        }\n\n        // add the new click handler\n        documentClickHandler = function (event) {\n            // if the click is outside the popup and not on the profile button (which toggles the popup)\n            if ($popup && !$popup[0].contains(event.target) && !$(\"#user-profile-button\")[0].contains(event.target)) {\n                closePopup();\n            }\n        };\n\n        // this is needed so we don't close the popup immediately as the profile button is clicked\n        setTimeout(function() {\n            $(document).on(\"mousedown\", documentClickHandler);\n        }, 100);\n    }\n\n    /**\n     * Shows the sign-in popup when the user is not logged in\n     */\n    function showLoginPopup() {\n        // If popup is already visible, just close it\n        if (isPopupVisible) {\n            closePopup();\n            return;\n        }\n\n        // create the popup element\n        closePopup(); // close any existing popup first\n\n        // Render template with basic data first for instant response\n        const renderedTemplate = Mustache.render(loginTemplate, {\n            Strings,\n            getProLink: brackets.config.purchase_url\n        });\n        $popup = $(renderedTemplate);\n\n        $(\"body\").append($popup);\n        isPopupVisible = true;\n\n        positionPopup();\n\n        // Check for trial info or device license asynchronously and update popup\n        KernalModeTrust.loginService.getEffectiveEntitlements().then(effectiveEntitlements => {\n            // this is the login popup, so user is not logged in yet if we are here.\n            if (effectiveEntitlements && isPopupVisible && $popup) {\n                let proInfoHtml = null;\n\n                if (effectiveEntitlements.isInProTrial) {\n                    // isInProTrial will never be set if user has a pro device license(or a pro sub,\n                    // but that isn't relevant here). Add trial info to the existing popup.\n                    const planName = StringUtils.format(Strings.PROMO_PRO_TRIAL_DAYS_LEFT,\n                        effectiveEntitlements.trialDaysRemaining);\n                    proInfoHtml = `<div class=\"trial-plan-info\">\n                        <span class=\"phoenix-pro-title-plain\">\n                            <span class=\"pro-plan-name user-plan-name\">${planName}</span>\n                            <i class=\"fa-solid fa-feather\" style=\"margin-left: 3px;\"></i>\n                        </span>\n                    </div>`;\n                } else if (effectiveEntitlements.plan && effectiveEntitlements.plan.isSubscriber) {\n                    // Device-licensed user: show Phoenix Pro branding\n                    const planName = effectiveEntitlements.plan.fullName || brackets.config.main_pro_plan;\n                    proInfoHtml = `<div class=\"trial-plan-info\">\n                        <span class=\"phoenix-pro-title-plain\">\n                            <span class=\"pro-plan-name user-plan-name\">${planName}</span>\n                            <i class=\"fa-solid fa-feather\" style=\"margin-left: 3px;\"></i>\n                        </span>\n                    </div>`;\n                }\n\n                if (proInfoHtml) {\n                    $popup.find('.popup-title').after(proInfoHtml);\n                    positionPopup(); // Reposition after adding content\n                }\n            }\n        }).catch(error => {\n            console.error('Failed to check entitlements for login popup:', error);\n        });\n\n        PopUpManager.addPopUp($popup, function() {\n            $popup.remove();\n            $popup = null;\n            isPopupVisible = false;\n        }, true, { closeCurrentPopups: true });\n\n        // event handlers for buttons\n        $popup.find(\"#phoenix-signin-btn\").on(\"click\", function () {\n            _handleSignInBtnClick();\n        });\n\n        $popup.find(\"#phoenix-support-btn\").on(\"click\", function () {\n            _handleContactSupportBtnClick();\n            closePopup();\n        });\n\n        // handle window resize to reposition popup\n        $(window).on(\"resize.profilePopup\", function () {\n            if (isPopupVisible) {\n                positionPopup();\n            }\n        });\n\n        _setupDocumentClickHandler();\n    }\n\n    /**\n     * Update main navigation branding based on entitlements\n     */\n    function _updateBranding(entitlements) {\n        const $brandingLink = $(\"#phcode-io-main-nav\");\n        if (!entitlements) {\n            // Phoenix.pro is only for display purposes and should not be used to gate features.\n            // Use kernal mode apis for trusted check of pro features.\n            Phoenix.pro.plan = {\n                isSubscriber: false,\n                name: Strings.USER_FREE_PLAN_NAME_DO_NOT_TRANSLATE,\n                fullName: Strings.USER_FREE_PLAN_NAME_DO_NOT_TRANSLATE\n            };\n        }\n\n        if (entitlements && entitlements.plan){\n            Phoenix.pro.plan = {\n                isSubscriber: entitlements.plan.isSubscriber,\n                name: entitlements.plan.name,\n                fullName: entitlements.plan.fullName,\n                validTill: entitlements.plan.validTill\n            };\n        }\n        if (entitlements && entitlements.plan && entitlements.plan.isSubscriber) {\n            // Pro user (paid subscriber or trial): show short name branding with `name feather icon`(not full name)\n            let displayName = entitlements.plan.name || brackets.config.main_pro_plan;\n            if (entitlements.isInProTrial) {\n                displayName = brackets.config.main_pro_plan; // Just \"Phoenix Pro\" for branding, not \"Phoenix Pro Trial\"\n            }\n            $brandingLink\n                .attr(\"href\", \"https://account.phcode.dev\")\n                .addClass(\"phoenix-pro\")\n                .html(`${displayName}<i class=\"fa-solid fa-feather orange-gold\" style=\"margin-left: 3px;\"></i>`);\n        } else {\n            // Free user: show phcode.io branding\n            $brandingLink\n                .attr(\"href\", \"https://phcode.io\")\n                .removeClass(\"phoenix-pro\")\n                .text(\"phcode.io\");\n        }\n    }\n\n    let userEmail=\"\";\n    class SecureEmail extends HTMLElement {\n        constructor() {\n            super();\n            // Create closed shadow root - this is for security that extensions wont be able to read email from DOM\n            const shadow = this.attachShadow({ mode: 'closed' });\n            // Create the email display with some obfuscation techniques\n            shadow.innerHTML = `<span>${userEmail}</span>`;\n        }\n    }\n    // Register the custom element\n    /* eslint-disable-next-line*/\n    customElements.define ('secure-email', SecureEmail); // space is must in define ( to prevent build fail\n\n    let userName=\"\";\n    class SecureName extends HTMLElement {\n        constructor() {\n            super();\n            // Create closed shadow root - this is for security that extensions wont be able to read name from DOM\n            const shadow = this.attachShadow({ mode: 'closed' });\n            // Create the email display with some obfuscation techniques\n            shadow.innerHTML = `<span>${userName}</span>`;\n        }\n    }\n    // Register the custom element\n\n    /* eslint-disable-next-line*/\n    customElements.define ('secure-name', SecureName); // space is must in define ( to prevent build fail\n\n    /**\n     * Load user details iframe with secure user information\n     */\n    function _loadUserDetailsIframe() {\n        if (!Phoenix.isNativeApp && $popup) {\n            const $iframe = $popup.find(\"#user-details-frame\");\n            const $secureName = $popup.find(\".user-name secure-name\");\n            const $secureEmail = $popup.find(\".user-email secure-email\");\n\n            if ($iframe.length) {\n                // Get account base URL for iframe using login service\n                const accountBaseURL = KernalModeTrust.loginService.getAccountBaseURL();\n                const currentTheme = ThemeManager.getCurrentTheme();\n                const nameColor = (currentTheme && currentTheme.dark) ? \"FFFFFF\" : \"000000\";\n\n                // Configure iframe URL with styling parameters\n                const iframeURL = `${accountBaseURL}/getUserDetailFrame?` +\n                    `includeName=true&` +\n                    `nameFontSize=14px&` +\n                    `emailFontSize=12px&` +\n                    `nameColor=%23${nameColor}&` +\n                    `emailColor=%23666666&` +\n                    `backgroundColor=transparent`;\n\n                // Listen for iframe load events\n                const messageHandler = function(event) {\n                    // Only accept messages from trusted account domain\n                    // Handle proxy case where accountBaseURL is '/proxy/accounts'\n                    let trustedOrigin;\n                    if (accountBaseURL.startsWith('/proxy/accounts')) {\n                        // For localhost with proxy, accept messages from current origin\n                        trustedOrigin = window.location.origin;\n                    } else {\n                        // For production, get origin from account URL\n                        trustedOrigin = new URL(accountBaseURL).origin;\n                    }\n\n                    if (event.origin !== trustedOrigin) {\n                        return;\n                    }\n\n                    if (event.data && event.data.loaded) {\n                        // Hide secure DOM elements and show iframe\n                        $secureName.hide();\n                        $secureEmail.hide();\n                        $iframe.show();\n\n                        // Adjust iframe height based on content\n                        $iframe.css('height', '36px'); // Approximate height for name + email\n\n                        // Remove event listener\n                        window.removeEventListener('message', messageHandler);\n                    }\n                };\n\n                // Add message listener\n                window.addEventListener('message', messageHandler);\n\n                // Set iframe source to load user details\n                $iframe.attr('src', iframeURL);\n\n                // Fallback timeout - if iframe doesn't load in 5 seconds, keep secure elements\n                setTimeout(() => {\n                    if ($iframe.is(':hidden')) {\n                        console.log('User details iframe failed to load, keeping secure elements');\n                        window.removeEventListener('message', messageHandler);\n                    }\n                }, 5000);\n            }\n        }\n    }\n\n    /**\n     * Update popup content with entitlements data\n     */\n    function _updatePopupWithEntitlements(entitlements) {\n        if (!$popup || !entitlements) {\n            return;\n        }\n        // entitlements will always be present for login popup.\n        // Update plan information\n        const $getProLink = $popup.find('.get-phoenix-pro-profile');\n        if (entitlements.plan) {\n            const $planName = $popup.find('.user-plan-name');\n\n            // Update plan class and content based on paid subscriber status\n            $planName.removeClass('user-plan-free user-plan-paid');\n\n            if (entitlements.plan.isSubscriber) {\n                // Use pro styling with feather icon for pro users (paid or trial)\n                if (entitlements.isInProTrial) {\n                    // For trial users: separate \"Phoenix Pro\" with icon from \"(X days left)\" text\n                    const planName = StringUtils.format(Strings.PROMO_PRO_TRIAL_DAYS_LEFT,\n                        entitlements.trialDaysRemaining);\n                    const proTitle = `<span class=\"phoenix-pro-title-plain\">\n                        <span class=\"pro-plan-name user-plan-name\">${planName}</span>\n                        <i class=\"fa-solid fa-feather\" style=\"margin-left: 3px;\"></i>\n                    </span>`;\n                    $planName.addClass('user-plan-paid').html(proTitle);\n                    $getProLink.removeClass('forced-hidden');\n                } else {\n                    // For paid users: regular plan name with icon\n                    const proTitle = `<span class=\"phoenix-pro-title\">\n                        <span class=\"pro-plan-name user-plan-name\">${entitlements.plan.fullName}</span>\n                        <i class=\"fa-solid fa-feather\" style=\"margin-left: 3px;\"></i>\n                    </span>`;\n                    $planName.addClass('user-plan-paid').html(proTitle);\n                    $getProLink.addClass('forced-hidden');\n                }\n            } else {\n                // Use simple text for free users\n                $planName.addClass('user-plan-free').text(entitlements.plan.fullName);\n            }\n        } else {\n            $getProLink.removeClass('forced-hidden');\n        }\n\n        // Update quota section if available\n        if (entitlements.profileview && entitlements.profileview.quota) {\n            const $quotaSection = $popup.find('.quota-section');\n            const quota = entitlements.profileview.quota;\n\n            // Remove forced-hidden and show quota section\n            $quotaSection.removeClass('forced-hidden');\n\n            // Update quota content\n            $quotaSection.find('.titleText').text(quota.titleText);\n            $quotaSection.find('.usageText').text(quota.usageText);\n            $quotaSection.find('.progress-fill').css('width', quota.usedPercent + '%');\n        }\n\n        // Update HTML message if available\n        if (entitlements.profileview && entitlements.profileview.htmlMessage) {\n            const $htmlMessageSection = $popup.find('.html-message');\n            $htmlMessageSection.removeClass('forced-hidden');\n            $htmlMessageSection.html(entitlements.profileview.htmlMessage);\n        }\n\n        // Reposition popup after content changes\n        positionPopup();\n    }\n\n    /**\n     * Shows the user profile popup when the user is logged in\n     */\n    function showProfilePopup() {\n        // If popup is already visible, just close it\n        if (isPopupVisible) {\n            closePopup();\n            return;\n        }\n        const profileData = KernalModeTrust.loginService.getProfile();\n        userEmail = profileData.email;\n        userName = profileData.firstName + \" \" + profileData.lastName;\n\n        // Default template data (fallback) - start with cached plan info if available\n        const templateData = {\n            initials: profileData.profileIcon.initials,\n            avatarColor: profileData.profileIcon.color,\n            planClass: \"user-plan-free\",\n            planName: Strings.USER_FREE_PLAN_NAME_DO_NOT_TRANSLATE,\n            titleText: \"Ai Quota Used\",\n            usageText: \"100 / 200 credits\",\n            usedPercent: 0,\n            Strings: Strings,\n            getProLink: brackets.config.purchase_url\n        };\n\n        // Note: We don't await here to keep popup display instant\n        // Cached entitlements will be applied asynchronously after popup is shown\n\n        // Render template with data immediately\n        const renderedTemplate = Mustache.render(profileTemplate, templateData);\n        $popup = $(renderedTemplate);\n\n        $(\"body\").append($popup);\n        isPopupVisible = true;\n\n        positionPopup();\n\n        // Apply cached effective entitlements immediately if available (including quota/messages)\n        KernalModeTrust.loginService.getEffectiveEntitlements(false).then(cachedEntitlements => {\n            if (cachedEntitlements && isPopupVisible) {\n                _updatePopupWithEntitlements(cachedEntitlements);\n            }\n        }).catch(error => {\n            console.error('Failed to apply cached entitlements to popup:', error);\n        });\n\n        PopUpManager.addPopUp($popup, function() {\n            $popup.remove();\n            $popup = null;\n            isPopupVisible = false;\n        }, true, { closeCurrentPopups: true });\n\n        $popup.find(\"#phoenix-account-btn\").on(\"click\", function () {\n            _handleAccountDetailsBtnClick();\n            closePopup();\n        });\n\n        $popup.find(\"#phoenix-support-btn\").on(\"click\", function () {\n            _handleContactSupportBtnClick();\n            closePopup();\n        });\n\n        $popup.find(\"#phoenix-signout-btn\").on(\"click\", function () {\n            _handleSignOutBtnClick();\n        });\n\n        // handle window resize to reposition popup\n        $(window).on(\"resize.profilePopup\", function () {\n            if (isPopupVisible) {\n                positionPopup();\n            }\n        });\n\n        _setupDocumentClickHandler();\n\n        // Load user details iframe for browser apps (after popup is created)\n        _loadUserDetailsIframe();\n\n        // Refresh entitlements in background and update popup if still visible\n        _refreshEntitlementsInBackground();\n    }\n\n    /**\n     * Refresh entitlements in background and update popup if still visible\n     */\n    async function _refreshEntitlementsInBackground() {\n        try {\n            const freshEntitlements = await KernalModeTrust.loginService.getEffectiveEntitlements(true);\n\n            // Only update popup if it's still visible\n            if (isPopupVisible && $popup && freshEntitlements) {\n                _updatePopupWithEntitlements(freshEntitlements);\n            }\n        } catch (error) {\n            console.error('Failed to refresh entitlements in background:', error);\n        }\n    }\n\n    /**\n     * Toggle the profile popup based on the user's login status\n     */\n    function togglePopup() {\n        // check if the popup is already visible or not. if visible close it\n        if (isPopupVisible) {\n            closePopup();\n            return;\n        }\n\n        // Show popup immediately with cached status for instant response\n        if (KernalModeTrust.loginService.isLoggedIn()) {\n            showProfilePopup();\n        } else {\n            showLoginPopup();\n        }\n\n        // Schedule background verification to update the popup if status changed\n        // Store the current login state before verification\n        const wasLoggedInBefore = KernalModeTrust.loginService.isLoggedIn();\n\n        // Set flag to indicate this is a background refresh\n        isBackgroundRefresh = true;\n\n        KernalModeTrust.loginService._verifyLoginStatus().then(() => {\n            // Clear the background refresh flag\n            isBackgroundRefresh = false;\n\n            // If the login status changed while popup is open, update it\n            if (isPopupVisible) {\n                const isLoggedInNow = KernalModeTrust.loginService.isLoggedIn();\n\n                if (wasLoggedInBefore !== isLoggedInNow) {\n                    // Status changed, close current popup and show correct one\n                    closePopup();\n                    if (isLoggedInNow) {\n                        showProfilePopup();\n                    } else {\n                        showLoginPopup();\n                    }\n                }\n                // If status didn't change, don't do anything to avoid closing popup\n            }\n        }).catch(error => {\n            // Clear the background refresh flag even on error\n            isBackgroundRefresh = false;\n            console.error(\"Background login status verification failed:\", error);\n        });\n    }\n\n    /**\n     * Check if user has Pro access (active trial or device license)\n     * Works for both logged-in and non-logged-in users\n     */\n    async function _hasProActive() {\n        try {\n            const effectiveEntitlements = await KernalModeTrust.loginService.getEffectiveEntitlements();\n            return effectiveEntitlements &&\n                (effectiveEntitlements.isInProTrial ||\n                    (effectiveEntitlements.plan && effectiveEntitlements.plan.isSubscriber));\n        } catch (error) {\n            console.error('Failed to check Pro access status:', error);\n            return false;\n        }\n    }\n\n    /**\n     * Initialize branding for non-logged-in users with Pro access (trial or device license) on startup\n     */\n    async function _setBrandingForNonLoggedInUser() {\n        try {\n            const effectiveEntitlements = await KernalModeTrust.loginService.getEffectiveEntitlements();\n            if (effectiveEntitlements &&\n                (effectiveEntitlements.isInProTrial ||\n                    (effectiveEntitlements.plan && effectiveEntitlements.plan.isSubscriber))) {\n                console.log('Profile Menu: Found Pro entitlements (trial or device license), updating branding...');\n                _updateBranding(effectiveEntitlements);\n            } else {\n                console.log('Profile Menu: No Pro entitlements found');\n                _updateBranding(null);\n            }\n        } catch (error) {\n            console.error('Failed to initialize branding for non-logged-in Pro users:', error);\n        }\n    }\n\n    let inited = false;\n    function init() {\n        if (inited) {\n            return;\n        }\n        inited = true;\n        const helpButtonID = \"user-profile-button\";\n        $icon = $(\"<a>\")\n            .attr({\n                id: helpButtonID,\n                href: \"#\",\n                class: \"user\",\n                title: Strings.CMD_USER_PROFILE\n            })\n            .appendTo($(\"#main-toolbar .bottom-buttons\"));\n        $icon.on('click', ()=>{\n            togglePopup();\n        });\n\n        // Initialize branding for non-logged-in users with Pro access (trial or device license)\n        _setBrandingForNonLoggedInUser();\n\n        // Listen for entitlements changes to update branding for non-logged-in Pro users\n        KernalModeTrust.loginService.on(KernalModeTrust.loginService.EVENT_ENTITLEMENTS_CHANGED, () => {\n            // When entitlements change (trial activation or device license) for non-logged-in users, update branding\n            if (!KernalModeTrust.loginService.isLoggedIn()) {\n                _setBrandingForNonLoggedInUser();\n            }\n        });\n    }\n\n    function setNotLoggedIn() {\n        // Only close popup if it's not a background refresh\n        if (isPopupVisible && !isBackgroundRefresh) {\n            closePopup();\n        }\n        _removeProfileIcon();\n\n        // Reset branding, but preserve Pro branding if user has active trial or device license\n        _hasProActive().then(hasProActive => {\n            if (!hasProActive) {\n                // Only reset branding if no trial or device license exists\n                console.log('Profile Menu: No Pro access, resetting branding to free');\n                _updateBranding(null);\n            } else {\n                // User has trial or device license, maintain pro branding\n                console.log('Profile Menu: Pro access exists, maintaining pro branding');\n                _setBrandingForNonLoggedInUser();\n            }\n        }).catch(error => {\n            console.error('Failed to check Pro access status during logout:', error);\n            // Fallback to resetting branding\n            _updateBranding(null);\n        });\n        // Clear cached entitlements when user logs out\n        KernalModeTrust.loginService.clearEntitlements();\n    }\n\n    function setLoggedIn(initial, color) {\n        // Only close popup if it's not a background refresh\n        if (isPopupVisible && !isBackgroundRefresh) {\n            closePopup();\n        }\n        _updateProfileIcon(initial, color);\n\n        // Preload effective entitlements when user logs in\n        KernalModeTrust.loginService.getEffectiveEntitlements()\n            .then(_updateBranding)\n            .catch(error => {\n                console.error('Failed to preload effective entitlements on login:', error);\n            });\n    }\n\n    exports.init = init;\n    exports.setNotLoggedIn = setNotLoggedIn;\n    exports.setLoggedIn = setLoggedIn;\n\n    // dont public exports things that extensions can use to get/put credentials and entitlements, display mods is fine\n});\n"],"file":"profile-menu.js"}