define(function(require,exports,module){const KernalModeTrust=window.KernalModeTrust;if(!KernalModeTrust)throw new Error("UserNotifications should have access to KernalModeTrust. Cannot boot without trust ring");const PreferencesManager=require("preferences/PreferencesManager"),NotificationUI=require("widgets/NotificationUI"),PREF_NOTIFICATIONS_SHOWN_LIST="notificationsShownList";let EntitlementsManager,LoginService;PreferencesManager.stateManager.definePreference(PREF_NOTIFICATIONS_SHOWN_LIST,"object",{});const currentlyShownNotifications=new Set;let fetchFn=window.fetch;function getShownNotifications(){return PreferencesManager.stateManager.get(PREF_NOTIFICATIONS_SHOWN_LIST)||{}}function markNotificationAsShown(notificationID){const shownNotifications=getShownNotifications();shownNotifications[notificationID]=Date.now(),PreferencesManager.stateManager.set(PREF_NOTIFICATIONS_SHOWN_LIST,shownNotifications),currentlyShownNotifications.delete(notificationID)}async function acknowledgeNotificationToServer(notificationID){try{const accountBaseURL=LoginService.getAccountBaseURL();let url=`${accountBaseURL}/notificationAcknowledged`;const requestBody={notificationID:notificationID};let fetchOptions={method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(requestBody)};if(Phoenix.isNativeApp){const profile=LoginService.getProfile();profile&&profile.apiKey&&profile.validationCode&&(requestBody.appSessionID=profile.apiKey,requestBody.validationCode=profile.validationCode,fetchOptions.body=JSON.stringify(requestBody))}else fetchOptions.credentials="include";const response=await fetchFn(url,fetchOptions);if(response.ok){const result=await response.json();if(result.isSuccess)return console.log(`Notification ${notificationID} acknowledged successfully`),!0}return console.warn(`Failed to acknowledge notification ${notificationID}:`,response.status),!1}catch(error){return console.error(`Error acknowledging notification ${notificationID}:`,error),!1}}async function handleNotificationDismiss(notificationID){return markNotificationAsShown(notificationID),acknowledgeNotificationToServer(notificationID)}function shouldShowNotification(notification){if(!notification||!notification.notificationID)return!1;if(notification.validTill&&Date.now()>notification.validTill)return!1;const shownNotifications=getShownNotifications();return!shownNotifications[notification.notificationID]&&!currentlyShownNotifications.has(notification.notificationID)}function displayNotification(notification){const{notificationID:notificationID,title:title,htmlContent:htmlContent,options:options={}}=notification;currentlyShownNotifications.add(notificationID);const toastOptions={dismissOnClick:void 0===options.dismissOnClick||options.dismissOnClick,toastStyle:options.toastStyle||NotificationUI.NOTIFICATION_STYLES_CSS_CLASS.INFO};options.autoCloseTimeS&&(toastOptions.autoCloseTimeS=options.autoCloseTimeS);const notificationInstance=NotificationUI.createToastFromTemplate(title,htmlContent,toastOptions);notificationInstance.done(()=>{handleNotificationDismiss(notificationID)})}function cleanupStaleNotifications(remoteNotifications){if(!remoteNotifications||0===remoteNotifications.length)return;const remoteIDs=new Set;for(const notification of remoteNotifications)notification.notificationID&&remoteIDs.add(notification.notificationID);const shownNotifications=getShownNotifications(),updatedShownNotifications={};for(const id in shownNotifications)remoteIDs.has(id)&&(updatedShownNotifications[id]=shownNotifications[id]);const oldCount=Object.keys(shownNotifications).length,newCount=Object.keys(updatedShownNotifications).length;newCount<oldCount&&(console.log(`Cleaning up ${oldCount-newCount} stale notification ID(s) from state`),PreferencesManager.stateManager.set(PREF_NOTIFICATIONS_SHOWN_LIST,updatedShownNotifications))}async function processNotifications(){try{const notifications=await EntitlementsManager.getNotifications();if(!notifications||!Array.isArray(notifications))return;notifications.length>0&&cleanupStaleNotifications(notifications);const notificationsToShow=notifications.filter(shouldShowNotification);notificationsToShow.length>0&&(console.log(`Showing ${notificationsToShow.length} new notification(s)`),notificationsToShow.forEach(displayNotification))}catch(error){console.error("Error processing notifications:",error)}}function init(){if(EntitlementsManager=KernalModeTrust.EntitlementsManager,LoginService=KernalModeTrust.loginService,!EntitlementsManager||!LoginService)throw new Error("UserNotifications requires EntitlementsManager and LoginService in KernalModeTrust");EntitlementsManager.on(EntitlementsManager.EVENT_ENTITLEMENTS_CHANGED,processNotifications),console.log("UserNotifications service initialized")}Phoenix.isTestWindow&&(window._test_user_notifications_exports={getShownNotifications:getShownNotifications,markNotificationAsShown:markNotificationAsShown,shouldShowNotification:shouldShowNotification,acknowledgeNotificationToServer:acknowledgeNotificationToServer,processNotifications:processNotifications,cleanupStaleNotifications:cleanupStaleNotifications,currentlyShownNotifications:currentlyShownNotifications,setFetchFn:function(fn){fetchFn=fn}}),exports.init=init});
//# sourceMappingURL=UserNotifications.js.map
