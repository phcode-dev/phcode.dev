define(function(require,exports,module){const LoginServiceDirectImport=require("./login-service"),PreferencesManager=require("preferences/PreferencesManager"),Metrics=require("utils/Metrics"),Dialogs=require("widgets/Dialogs"),DefaultDialogs=require("widgets/DefaultDialogs"),Strings=require("strings"),StringUtils=require("utils/StringUtils"),ProfileMenu=require("./profile-menu"),Mustache=require("thirdparty/mustache/mustache"),browserLoginWaitingTemplate=require("text!./html/browser-login-waiting-dialog.html"),KernalModeTrust=window.KernalModeTrust;if(!KernalModeTrust)throw new Error("Browser Login service should have access to KernalModeTrust. Cannot boot without trust ring");const LoginService=KernalModeTrust.loginService;let userProfile=null,isLoggedInUser=!1;const PREF_USER_PROFILE_VERSION="userProfileVersion";function isLoggedIn(){return isLoggedInUser}function getProfile(){return userProfile}function _getAccountBaseURL(){return"localhost"===location.hostname||"127.0.0.1"===location.hostname?"/proxy/accounts":Phoenix.config.account_url.replace(/\/$/,"")}function _getAccountWebURL(){return Phoenix.config.account_url}const ERR_RETRY_LATER="retry_later",ERR_INVALID="invalid",ERR_NOT_LOGGED_IN="not_logged_in";let fetchFn=window.fetch;async function _resolveBrowserSession(){const resolveURL=`${_getAccountBaseURL()}/resolveBrowserSession`;if(!navigator.onLine)return{err:ERR_RETRY_LATER};try{if(Phoenix.isTestWindow&&fetchFn===fetch)return{err:ERR_NOT_LOGGED_IN};const response=await fetchFn(resolveURL,{method:"GET",credentials:"include",headers:{Accept:"application/json"}});if(401===response.status||403===response.status||404===response.status)return{err:ERR_NOT_LOGGED_IN};if(400===response.status)return{err:ERR_INVALID};if(response.ok){const userDetails=await response.json();return userDetails.isSuccess?{userDetails:userDetails}:{err:ERR_NOT_LOGGED_IN}}return console.log("Browser session resolve error:",response.status),{err:ERR_RETRY_LATER}}catch(e){return console.error(e,"Failed to call resolveBrowserSession endpoint",resolveURL),{err:ERR_RETRY_LATER}}}async function _resetBrowserLogin(){isLoggedInUser=!1,userProfile=null,ProfileMenu.setNotLoggedIn(),PreferencesManager.stateManager.set(PREF_USER_PROFILE_VERSION,crypto.randomUUID())}async function _verifyBrowserLogin(silentCheck=!1){console.log("Verifying browser login status...");const resolveResponse=await _resolveBrowserSession();return resolveResponse.userDetails?(userProfile=resolveResponse.userDetails,isLoggedInUser=!0,ProfileMenu.setLoggedIn(userProfile.profileIcon.initials,userProfile.profileIcon.color),console.log("Browser login verified for:",userProfile.email),void Metrics.countEvent(Metrics.EVENT_TYPE.AUTH,"browser","OKLogin")):resolveResponse.err===ERR_NOT_LOGGED_IN?(console.log("No browser session found. Not logged in"),Metrics.countEvent(Metrics.EVENT_TYPE.AUTH,"browser","NotLoggedIn"),void _handleLoginError(silentCheck)):resolveResponse.err===ERR_INVALID?(console.log("Invalid auth token, resetting login state"),Metrics.countEvent(Metrics.EVENT_TYPE.AUTH,"browser","invalidLogin"),void _handleLoginError(silentCheck)):(console.log("Browser login verification failed (temporary):",resolveResponse.err),void Metrics.countEvent(Metrics.EVENT_TYPE.AUTH,"browser","RetryLogin"))}function _handleLoginError(silentCheck){silentCheck?(isLoggedInUser=!1,userProfile=null):_resetBrowserLogin()}let loginWaitingDialog=null;function _showLoginWaitingDialog(){if(loginWaitingDialog)return;const dialogData={Strings:{SIGN_IN_WAITING_TITLE:Strings.SIGN_IN_WAITING_TITLE,SIGN_IN_WAITING_MESSAGE:Strings.SIGN_IN_WAITING_MESSAGE,WAITING_FOR_LOGIN:Strings.WAITING_FOR_LOGIN,CHECK_NOW:Strings.CHECK_NOW,CANCEL:Strings.CANCEL}},$template=$(Mustache.render(browserLoginWaitingTemplate,dialogData));loginWaitingDialog=Dialogs.showModalDialogUsingTemplate($template),$template.on("click",'[data-button-id="check"]',async function(){const $btn=$(this),originalText=$btn.text();$btn.prop("disabled",!0).text(Strings.CHECKING),$template.find("#login-status").text(Strings.CHECKING_STATUS),await _verifyBrowserLogin(),isLoggedInUser?_onLoginSuccess():($template.find("#login-status").text(Strings.NOT_SIGNED_IN_YET),$btn.prop("disabled",!1).text(originalText))}),$template.on("click",'[data-button-id="cancel"]',function(){loginWaitingDialog.close()});const onFocusCheck=async()=>{loginWaitingDialog&&!isLoggedInUser&&($template.find("#login-status").text(Strings.CHECKING_STATUS),await _verifyBrowserLogin(),isLoggedInUser&&_onLoginSuccess())};$(window).off("focus.loginWaiting"),$(window).on("focus.loginWaiting",onFocusCheck),loginWaitingDialog.done(()=>{_cancelLoginWaiting()})}function _onLoginSuccess(){if(loginWaitingDialog){const $template=loginWaitingDialog.getElement(),welcomeBackMessage=Phoenix.isNativeApp?StringUtils.format(Strings.WELCOME_BACK_USER,userProfile.firstName):Strings.WELCOME_BACK;$template.find("#login-status").text(welcomeBackMessage).css("color","#10b981"),setTimeout(()=>{_cancelLoginWaiting(),Metrics.countEvent(Metrics.EVENT_TYPE.AUTH,"browserLogin","browser")},1500)}}function _cancelLoginWaiting(){loginWaitingDialog&&(loginWaitingDialog.close(),loginWaitingDialog=null),$(window).off("focus.loginWaiting")}async function signInToBrowser(){if(!navigator.onLine)return void Dialogs.showModalDialog(DefaultDialogs.DIALOG_ID_ERROR,Strings.SIGNED_IN_OFFLINE_TITLE,Strings.SIGNED_IN_OFFLINE_MESSAGE);const signInURL=_getAccountWebURL()+"authorizeBrowserApp",newTab=window.open(signInURL,"_blank");newTab?(_showLoginWaitingDialog(),Metrics.countEvent(Metrics.EVENT_TYPE.AUTH,"browserLoginAttempt","browser")):Dialogs.showModalDialog(DefaultDialogs.DIALOG_ID_ERROR,Strings.SIGNED_IN_FAILED_TITLE,StringUtils.format(Strings.POPUP_BLOCKED,_getAccountWebURL()))}async function signOutBrowser(){const logoutURL=`${_getAccountBaseURL()}/signOut`;try{if(Phoenix.isTestWindow&&fetchFn===fetch)return;const response=await fetchFn(logoutURL,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});if(await _resetBrowserLogin(),await _verifyBrowserLogin(),response.ok){const result=await response.json();if(result.isSuccess)return Dialogs.showModalDialog(DefaultDialogs.DIALOG_ID_INFO,Strings.SIGNED_OUT,Strings.SIGNED_OUT_MESSAGE_FRIENDLY),void Metrics.countEvent(Metrics.EVENT_TYPE.AUTH,"browserLogoutOK","browser")}console.warn("Logout may not have completed on server, but signed out locally");const dialog=Dialogs.showModalDialog(DefaultDialogs.DIALOG_ID_ERROR,Strings.SIGNED_OUT_FAILED_TITLE,Strings.SIGNED_OUT_FAILED_MESSAGE);dialog.done(()=>{window.open(_getAccountWebURL()+"#advanced","_blank")}),Metrics.countEvent(Metrics.EVENT_TYPE.AUTH,"browserLogoutPartial","browser")}catch(error){await _resetBrowserLogin(),await _verifyBrowserLogin(),console.error("Network error during logout:",error);const dialog=Dialogs.showModalDialog(DefaultDialogs.DIALOG_ID_ERROR,Strings.SIGNED_OUT_FAILED_TITLE,Strings.SIGNED_OUT_FAILED_MESSAGE);dialog.done(()=>{window.open(_getAccountWebURL()+"#advanced","_blank")}),Metrics.countEvent(Metrics.EVENT_TYPE.AUTH,"browserLogoutError","browser")}}function init(){if(Phoenix.isNativeApp)return void console.log("Browser login service is not needed for native app");ProfileMenu.init(),LoginServiceDirectImport.init(),_verifyBrowserLogin().catch(console.error);const pref=PreferencesManager.stateManager.definePreference(PREF_USER_PROFILE_VERSION,"string","0");pref.watchExternalChanges(),pref.on("change",()=>{_verifyBrowserLogin(!0).catch(console.error)})}Phoenix.isNativeApp||(LoginService.isLoggedIn=isLoggedIn,LoginService.signInToAccount=signInToBrowser,LoginService.signOutAccount=signOutBrowser,LoginService.getProfile=getProfile,LoginService._verifyLoginStatus=(()=>_verifyBrowserLogin(!1)),LoginService.getAccountBaseURL=_getAccountBaseURL,init()),Phoenix.isTestWindow&&(window._test_login_browser_exports={setFetchFn:function _setFetchFn(fn){fetchFn=fn}}),exports.isLoggedIn=isLoggedIn});
//# sourceMappingURL=login-browser.js.map
