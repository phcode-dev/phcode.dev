{"version":3,"sources":["services/manage-licenses.js"],"names":["define","require","exports","module","KernalModeTrust","window","Error","Strings","Dialogs","Mustache","licenseManagementHTML","fetchFn","fetch","_getAPIBaseURL","location","hostname","Phoenix","config","account_url","replace","async","_validateDeviceLicense","deviceLicenseKey","apiURL","response","method","headers","Content-Type","body","JSON","stringify","ok","status","statusText","json","error","console","_registerDevice","licenseKey","platform","deviceLabel","result","errorMessage","_formatDate","timestamp","LICENSE_VALID_NEVER","date","Date","toLocaleDateString","getLocale","year","month","day","_updateLicenseStatusDisplay","$dialog","licenseData","$loading","find","$none","$valid","$error","$reapplyContainer","hide","isValid","text","licensedToName","LICENSE_STATUS_UNKNOWN","licenseTypeName","validTill","show","isLicensed","loginService","isLicensedDeviceSystemWide","LICENSE_STATUS_ERROR_CHECK","_showActivationMessage","isSuccess","message","$messageDiv","$messageText","removeClass","addClass","setTimeout","fadeOut","_loadLicenseStatus","deviceID","getDeviceID","_handleLicenseActivation","$btn","$btnText","$btnSpinner","prop","addSuccess","addDeviceLicense","successString","LICENSE_ACTIVATE_SUCCESS","LICENSE_ACTIVATE_SUCCESS_PARTIAL","val","LICENSE_ACTIVATE_FAIL","_handleReapplyLicense","$link","originalText","html","css","LICENSE_ACTIVATE_FAIL_APPLY","showManageLicensesDialog","$template","$","render","showModalDialogUsingTemplate","$licenseInput","$activateBtn","$reapplyLink","on","trim","LICENSE_ENTER_KEY","e","which","click","preventDefault"],"mappings":"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","sourcesContent":["/*\n * GNU AGPL-3.0 License\n *\n * Copyright (c) 2021 - present core.ai . All rights reserved.\n *\n * This program is free software: you can redistribute it and/or modify it under\n * the terms of the GNU Affero General Public License as published by the Free\n * Software Foundation, either version 3 of the License, or (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n * See the GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see https://opensource.org/licenses/AGPL-3.0.\n *\n */\n\n/*global logger*/\n\n/**\n * Shared Login Service\n *\n * This module contains shared login service functionality used by both\n * browser and desktop login implementations, including entitlements management.\n */\n\ndefine(function (require, exports, module) {\n    const KernalModeTrust = window.KernalModeTrust;\n    if(!KernalModeTrust){\n        // integrated extensions will have access to kernal mode, but not external extensions\n        throw new Error(\"manage-licenses should have access to KernalModeTrust. Cannot boot without trust ring\");\n    }\n\n    const Strings = require(\"strings\"),\n        Dialogs = require(\"widgets/Dialogs\"),\n        Mustache = require(\"thirdparty/mustache/mustache\"),\n        licenseManagementHTML = require(\"text!./html/license-management.html\");\n\n    // Save a copy of window.fetch so that extensions won't tamper with it\n    let fetchFn = window.fetch;\n\n    /**\n     * Get the API base URL for license operations\n     */\n    function _getAPIBaseURL() {\n        if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {\n            return '/proxy/accounts';\n        }\n        return Phoenix.config.account_url.replace(/\\/$/, ''); // Remove trailing slash\n    }\n\n    /**\n     * Call the validateDeviceLicense API\n     */\n    async function _validateDeviceLicense(deviceLicenseKey) {\n        const apiURL = `${_getAPIBaseURL()}/validateDeviceLicense`;\n\n        try {\n            const response = await fetchFn(apiURL, {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/json'\n                },\n                body: JSON.stringify({\n                    deviceLicenseKey: deviceLicenseKey\n                })\n            });\n\n            if (!response.ok) {\n                throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n            }\n\n            return await response.json();\n        } catch (error) {\n            console.error('Error validating device license:', error);\n            throw error;\n        }\n    }\n\n    /**\n     * Call the registerDevice API to activate a license\n     */\n    async function _registerDevice(licenseKey, deviceLicenseKey, platform, deviceLabel) {\n        const apiURL = `${_getAPIBaseURL()}/registerDevice`;\n\n        try {\n            const response = await fetchFn(apiURL, {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/json'\n                },\n                body: JSON.stringify({\n                    licenseKey: licenseKey,\n                    deviceLicenseKey: deviceLicenseKey,\n                    platform: platform,\n                    deviceLabel: deviceLabel\n                })\n            });\n\n            const result = await response.json();\n\n            if (!response.ok) {\n                throw new Error(result.errorMessage || `HTTP ${response.status}: ${response.statusText}`);\n            }\n\n            return result;\n        } catch (error) {\n            console.error('Error registering device:', error);\n            throw error;\n        }\n    }\n\n    /**\n     * Format date for display\n     */\n    function _formatDate(timestamp) {\n        if (!timestamp) {\n            return Strings.LICENSE_VALID_NEVER;\n        }\n        const date = new Date(timestamp);\n        return date.toLocaleDateString(Phoenix.getLocale(), {\n            year: 'numeric',\n            month: 'long',\n            day: 'numeric'\n        });\n    }\n\n    /**\n     * Update the license status display in the dialog\n     */\n    async function _updateLicenseStatusDisplay($dialog, licenseData) {\n        const $loading = $dialog.find('#license-status-loading');\n        const $none = $dialog.find('#license-status-none');\n        const $valid = $dialog.find('#license-status-valid');\n        const $error = $dialog.find('#license-status-error');\n        const $reapplyContainer = $dialog.find('#reapply-license-container');\n\n        // Hide all status sections\n        $loading.hide();\n        $none.hide();\n        $valid.hide();\n        $error.hide();\n        $reapplyContainer.hide();\n\n        if (licenseData && licenseData.isValid) {\n            // Show valid license info\n            $dialog.find('#licensed-to-name').text(licenseData.licensedToName || Strings.LICENSE_STATUS_UNKNOWN);\n            $dialog.find('#license-type-name').text(licenseData.licenseTypeName || Strings.LICENSE_STATUS_UNKNOWN);\n            $dialog.find('#license-valid-till').text(_formatDate(licenseData.validTill));\n            $valid.show();\n\n            // Show reapply button if license is valid but not applied system-wide\n            const isLicensed = await KernalModeTrust.loginService.isLicensedDeviceSystemWide();\n            if (!isLicensed) {\n                $reapplyContainer.show();\n            }\n        } else if (licenseData && licenseData.isValid === false) {\n            // No valid license\n            $none.show();\n        } else {\n            // Error state\n            $dialog.find('#license-error-message').text(Strings.LICENSE_STATUS_ERROR_CHECK);\n            $error.show();\n        }\n    }\n\n    /**\n     * Show activation result message\n     */\n    function _showActivationMessage($dialog, isSuccess, message) {\n        const $messageDiv = $dialog.find('#activation-message');\n        const $messageText = $dialog.find('#activation-message-text');\n\n        $messageText.text(message);\n\n        // Remove previous classes\n        $messageDiv.removeClass('success error');\n\n        // Add appropriate class\n        if (isSuccess) {\n            $messageDiv.addClass('success');\n        } else {\n            $messageDiv.addClass('error');\n        }\n\n        $messageDiv.show();\n\n        // Hide message after 5 seconds\n        setTimeout(() => {\n            $messageDiv.fadeOut();\n        }, 5000);\n    }\n\n    /**\n     * Load and display current license status\n     */\n    async function _loadLicenseStatus($dialog) {\n        try {\n            const deviceID = await KernalModeTrust.loginService.getDeviceID();\n            if (!deviceID) {\n                _updateLicenseStatusDisplay($dialog, { isValid: false });\n                return;\n            }\n\n            const licenseData = await _validateDeviceLicense(deviceID);\n            _updateLicenseStatusDisplay($dialog, licenseData);\n        } catch (error) {\n            console.error('Error loading license status:', error);\n            _updateLicenseStatusDisplay($dialog, null);\n        }\n    }\n\n    /**\n     * Handle license activation\n     */\n    async function _handleLicenseActivation($dialog, licenseKey) {\n        const $btn = $dialog.find('#activate-license-btn');\n        const $btnText = $btn.find('.btn-text');\n        const $btnSpinner = $btn.find('.btn-spinner');\n\n        try {\n            // Show loading state\n            $btn.prop('disabled', true);\n            $btnText.hide();\n            $btnSpinner.show();\n\n            const deviceID = await KernalModeTrust.loginService.getDeviceID();\n            if (!deviceID) {\n                throw new Error('Unable to get device ID. Device licenses are only supported on desktop applications.');\n            }\n\n            const platform = Phoenix.platform || 'unknown';\n            const deviceLabel = `Phoenix Code - ${platform}`;\n\n            const result = await _registerDevice(licenseKey, deviceID, platform, deviceLabel);\n\n            if (result.isSuccess) {\n                const addSuccess = await KernalModeTrust.loginService.addDeviceLicense();\n                const successString = addSuccess ?\n                    Strings.LICENSE_ACTIVATE_SUCCESS : Strings.LICENSE_ACTIVATE_SUCCESS_PARTIAL;\n                _showActivationMessage($dialog, true, successString);\n\n                // Clear the input field\n                $dialog.find('#license-key-input').val('');\n\n                // Refresh license status\n                await _loadLicenseStatus($dialog);\n            } else {\n                _showActivationMessage($dialog, false, result.errorMessage || Strings.LICENSE_ACTIVATE_FAIL);\n            }\n        } catch (error) {\n            _showActivationMessage($dialog, false, error.message || Strings.LICENSE_ACTIVATE_FAIL);\n        } finally {\n            // Reset button state\n            $btn.prop('disabled', false);\n            $btnText.show();\n            $btnSpinner.hide();\n        }\n    }\n\n    /**\n     * Handle reapply license to device\n     */\n    async function _handleReapplyLicense($dialog) {\n        const $link = $dialog.find('#reapply-license-link');\n        const originalText = $link.html();\n\n        try {\n            // Show loading state\n            $link.html('<i class=\"fa fa-spinner fa-spin\" style=\"margin-right: 6px;\"></i>Applying...');\n            $link.css('pointer-events', 'none');\n\n            const addSuccess = await KernalModeTrust.loginService.addDeviceLicense();\n            if (addSuccess) {\n                _showActivationMessage($dialog, true, Strings.LICENSE_ACTIVATE_SUCCESS);\n                // Refresh license status\n                await _loadLicenseStatus($dialog);\n            } else {\n                _showActivationMessage($dialog, false, Strings.LICENSE_ACTIVATE_FAIL_APPLY);\n            }\n        } catch (error) {\n            _showActivationMessage($dialog, false, Strings.LICENSE_ACTIVATE_FAIL_APPLY);\n        } finally {\n            // Reset link state\n            $link.html(originalText);\n            $link.css('pointer-events', 'auto');\n        }\n    }\n\n    async function showManageLicensesDialog() {\n        const $template = $(Mustache.render(licenseManagementHTML, {Strings}));\n\n        Dialogs.showModalDialogUsingTemplate($template);\n\n        // Set up event handlers\n        const $dialog = $template;\n        const $licenseInput = $dialog.find('#license-key-input');\n        const $activateBtn = $dialog.find('#activate-license-btn');\n        const $reapplyLink = $dialog.find('#reapply-license-link');\n\n        // Handle activate button click\n        $activateBtn.on('click', async function() {\n            const licenseKey = $licenseInput.val().trim();\n            if (!licenseKey) {\n                _showActivationMessage($dialog, false, Strings.LICENSE_ENTER_KEY);\n                return;\n            }\n\n            await _handleLicenseActivation($dialog, licenseKey);\n        });\n\n        // Handle Enter key in license input\n        $licenseInput.on('keypress', function(e) {\n            if (e.which === 13) { // Enter key\n                $activateBtn.click();\n            }\n        });\n\n        // Handle reapply license link click\n        $reapplyLink.on('click', async function(e) {\n            e.preventDefault();\n            await _handleReapplyLicense($dialog);\n        });\n\n        // Load current license status\n        await _loadLicenseStatus($dialog);\n    }\n\n    exports.showManageLicensesDialog = showManageLicensesDialog;\n});\n"],"file":"manage-licenses.js"}