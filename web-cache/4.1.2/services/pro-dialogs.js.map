{"version":3,"sources":["services/pro-dialogs.js"],"names":["define","require","exports","module","KernalModeTrust","window","Error","proTitle","brackets","config","main_pro_plan","proTitlePlain","Dialogs","Mustache","Strings","StringUtils","ThemeManager","Metrics","proUpgradeHTML","proEndedHTML","fetchFn","fetch","UPSELL_TYPE_LIVE_EDIT","UPSELL_TYPE_PRO_TRIAL_ENDED","UPSELL_TYPE_GET_PRO","showProTrialStartDialog","trialDays","title","format","PROMO_UPGRADE_TITLE","message","PROMO_UPGRADE_MESSAGE","$template","$","render","secondaryButton","PROMO_LEARN_MORE","primaryButton","OK","showModalDialogUsingTemplate","done","id","console","log","countEvent","EVENT_TYPE","PRO","Phoenix","app","openURLInDefaultBrowser","purchase_url","_getUpsellDialogText","upsellType","buttonGetProText","PROMO_GET_APP_UPSELL_BUTTON","PROMO_PRO_ENDED_TITLE","localDialogMessage","PROMO_ENDED_MESSAGE","PROMO_PRO_UNLOCK_LIVE_EDIT_TITLE","PROMO_PRO_UNLOCK_MESSAGE","PROMO_PRO_UNLOCK_PRO_TITLE","_showLocalProEndedDialog","dlgText","buttonGetPro","CANCEL","_showRemoteProEndedDialog","currentVersion","promoHtmlURL","upsellPurchaseURL","currentTheme","getCurrentTheme","theme","dark","promoURL","getLocale","async","showProUpsellDialog","AppConfig","apiVersion","navigator","onLine","configURL","promotions_url","response","ok","json","upsell_after_trial_url","upsell_purchase_url","error","showAIUpsellDialog","getAIEntitlementResponse","upsellDialog","buyURL","needsLogin","buttons","primaryButtonText","PROFILE_SIGN_IN","AI_LOGIN_DIALOG_BUTTON","className","DIALOG_BTN_CLASS_NORMAL","DIALOG_BTN_CANCEL","text","DIALOG_BTN_CLASS_PRIMARY","DIALOG_BTN_OK","showModalDialog","DIALOG_ID_INFO","AI","EntitlementsManager","loginToAccount","isTestWindow","_test_pro_dlg_login_exports","setFetchFn","_setDdateNowFn","fn"],"mappings":"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","sourcesContent":["/*\n * GNU AGPL-3.0 License\n *\n * Copyright (c) 2021 - present core.ai . All rights reserved.\n *\n * This program is free software: you can redistribute it and/or modify it under\n * the terms of the GNU Affero General Public License as published by the Free\n * Software Foundation, either version 3 of the License, or (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;\n * without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n * See the GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see https://opensource.org/licenses/AGPL-3.0.\n *\n */\n\n/*global logger*/\n\n/**\n * Phoenix pro pre and post promo dialogs\n * shows dialog where we give Phoenix pro to all users on app install\n * and dialogs on pro trial ends.\n *\n */\n\ndefine(function (require, exports, module) {\n    const KernalModeTrust = window.KernalModeTrust;\n    if(!KernalModeTrust){\n        // integrated extensions will have access to kernal mode, but not external extensions\n        throw new Error(\"pro-dialogs.js should have access to KernalModeTrust. Cannot boot without trust ring\");\n    }\n\n    const proTitle = `<span class=\"phoenix-pro-title\">\n                    <span class=\"pro-plan-name\">${brackets.config.main_pro_plan}</span>\n                    <i class=\"fa-solid fa-feather orange-gold\" style=\"margin-left: 3px;\"></i>\n                </span>`,\n        proTitlePlain = `<span class=\"pro-plan-name\">${brackets.config.main_pro_plan}</span>\n                    <i class=\"fa-solid fa-feather\" style=\"margin-left: 2px;\"></i>`;\n    require(\"./setup-login-service\"); // this adds loginService to KernalModeTrust\n    const Dialogs = require(\"widgets/Dialogs\"),\n        Mustache = require(\"thirdparty/mustache/mustache\"),\n        Strings = require(\"strings\"),\n        StringUtils = require(\"utils/StringUtils\"),\n        ThemeManager = require(\"view/ThemeManager\"),\n        Metrics = require(\"utils/Metrics\"),\n        proUpgradeHTML = require(\"text!./html/pro-upgrade.html\"),\n        proEndedHTML = require(\"text!./html/promo-ended.html\");\n\n    // save a copy of window.fetch so that extensions wont tamper with it.\n    let fetchFn = window.fetch;\n\n    const UPSELL_TYPE_LIVE_EDIT = \"live_edit\";\n    const UPSELL_TYPE_PRO_TRIAL_ENDED = \"pro_trial_ended\";\n    const UPSELL_TYPE_GET_PRO = \"get_pro\";\n\n    function showProTrialStartDialog(trialDays) {\n        const title = StringUtils.format(Strings.PROMO_UPGRADE_TITLE, proTitle);\n        const message = StringUtils.format(Strings.PROMO_UPGRADE_MESSAGE, trialDays);\n        const $template = $(Mustache.render(proUpgradeHTML, {\n            title, message, Strings,\n            secondaryButton: Strings.PROMO_LEARN_MORE,\n            primaryButton: Strings.OK\n        }));\n        Dialogs.showModalDialogUsingTemplate($template).done(function (id) {\n            console.log(\"Dialog closed with id: \" + id);\n            Metrics.countEvent(Metrics.EVENT_TYPE.PRO, \"dlgShow\", \"promo\");\n            if(id === 'secondaryButton') {\n                Metrics.countEvent(Metrics.EVENT_TYPE.PRO, \"dlgAct\", \"promoLearn\");\n                Phoenix.app.openURLInDefaultBrowser(brackets.config.purchase_url);\n            } else {\n                Metrics.countEvent(Metrics.EVENT_TYPE.PRO, \"dlgAct\", \"promoCancel\");\n            }\n        });\n    }\n\n    function _getUpsellDialogText(upsellType) {\n        // our pro dialog has 2 flavors. Local which is shipped with the release for showing if user is offline\n        // and remote which is fetched from the server if we have a remote offer to show. This fn will be called\n        // by both of these flavors and we need to return the appropriate text for each.\n        const buttonGetProText = StringUtils.format(Strings.PROMO_GET_APP_UPSELL_BUTTON, proTitlePlain);\n        switch (upsellType) {\n        case UPSELL_TYPE_PRO_TRIAL_ENDED: return {\n            title: StringUtils.format(Strings.PROMO_PRO_ENDED_TITLE, proTitle),\n            localDialogMessage: Strings.PROMO_ENDED_MESSAGE, // this will be shown in the local dialog\n            buttonGetProText\n        };\n        case UPSELL_TYPE_LIVE_EDIT: return {\n            title: StringUtils.format(Strings.PROMO_PRO_UNLOCK_LIVE_EDIT_TITLE, proTitle),\n            localDialogMessage: Strings.PROMO_PRO_UNLOCK_MESSAGE,\n            buttonGetProText\n        };\n        case UPSELL_TYPE_GET_PRO:\n        default: return {\n            title: StringUtils.format(Strings.PROMO_PRO_UNLOCK_PRO_TITLE, proTitle),\n            localDialogMessage: Strings.PROMO_PRO_UNLOCK_MESSAGE,\n            buttonGetProText\n        };\n        }\n    }\n\n    function _showLocalProEndedDialog(upsellType) {\n        const dlgText = _getUpsellDialogText(upsellType);\n        const title = dlgText.title;\n        const buttonGetPro = dlgText.buttonGetProText;\n        const $template = $(Mustache.render(proUpgradeHTML, {\n            title, Strings,\n            message: dlgText.localDialogMessage,\n            secondaryButton: Strings.CANCEL,\n            primaryButton: buttonGetPro\n        }));\n        Dialogs.showModalDialogUsingTemplate($template).done(function (id) {\n            console.log(\"Dialog closed with id: \" + id);\n            Metrics.countEvent(Metrics.EVENT_TYPE.PRO, \"dlgShow\", \"localUpgrade\");\n            if(id === 'ok') {\n                Metrics.countEvent(Metrics.EVENT_TYPE.PRO, \"dlgAct\", \"localGetPro\");\n                Phoenix.app.openURLInDefaultBrowser(brackets.config.purchase_url);\n            } else {\n                Metrics.countEvent(Metrics.EVENT_TYPE.PRO, \"dlgAct\", \"localCancel\");\n            }\n        });\n    }\n\n    function _showRemoteProEndedDialog(upsellType, currentVersion, promoHtmlURL, upsellPurchaseURL) {\n        const dlgText = _getUpsellDialogText(upsellType);\n        const title = dlgText.title;\n        const buttonGetPro = dlgText.buttonGetProText;\n        const currentTheme = ThemeManager.getCurrentTheme();\n        const theme = currentTheme && currentTheme.dark ? \"dark\" : \"light\";\n        const promoURL = `${promoHtmlURL}?lang=${\n            brackets.getLocale()}&theme=${theme}&version=${currentVersion}&upsellType=${upsellType}`;\n        const $template = $(Mustache.render(proEndedHTML, {Strings, title, buttonGetPro, promoURL}));\n        Dialogs.showModalDialogUsingTemplate($template).done(function (id) {\n            console.log(\"Dialog closed with id: \" + id);\n            Metrics.countEvent(Metrics.EVENT_TYPE.PRO, \"dlgShow\", \"remoteUpgrade\");\n            if(id === 'get_pro') {\n                Metrics.countEvent(Metrics.EVENT_TYPE.PRO, \"dlgAct\", \"remoteGetPro\");\n                Phoenix.app.openURLInDefaultBrowser(upsellPurchaseURL || brackets.config.purchase_url);\n            } else {\n                Metrics.countEvent(Metrics.EVENT_TYPE.PRO, \"dlgAct\", \"remoteCancel\");\n            }\n        });\n    }\n\n    async function showProUpsellDialog(upsellType) {\n        const currentVersion = window.AppConfig.apiVersion;\n\n        if (!navigator.onLine) {\n            _showLocalProEndedDialog(upsellType);\n            return;\n        }\n\n        try {\n            const configURL = `${brackets.config.promotions_url}app/config.json`;\n            const response = await fetchFn(configURL);\n            if (!response.ok) {\n                _showLocalProEndedDialog(upsellType);\n                return;\n            }\n\n            const config = await response.json();\n            if (config.upsell_after_trial_url) {\n                _showRemoteProEndedDialog(upsellType, currentVersion,\n                    config.upsell_after_trial_url, config.upsell_purchase_url);\n            } else {\n                _showLocalProEndedDialog(upsellType);\n            }\n        } catch (error) {\n            _showLocalProEndedDialog(upsellType);\n        }\n    }\n\n    function showAIUpsellDialog(getAIEntitlementResponse) {\n        // Only show dialog if upsellDialog field is present\n        if (!getAIEntitlementResponse || !getAIEntitlementResponse.upsellDialog) {\n            return;\n        }\n\n        const upsellDialog = getAIEntitlementResponse.upsellDialog;\n        const title = upsellDialog.title;\n        const message = upsellDialog.message;\n        const buyURL = upsellDialog.buyURL;\n        const needsLogin = getAIEntitlementResponse.needsLogin;\n\n        let buttons;\n        if (needsLogin || buyURL) {\n            // Show primary action button and Cancel\n            const primaryButtonText = needsLogin ? Strings.PROFILE_SIGN_IN : Strings.AI_LOGIN_DIALOG_BUTTON;\n            buttons = [\n                { className: Dialogs.DIALOG_BTN_CLASS_NORMAL, id: Dialogs.DIALOG_BTN_CANCEL, text: Strings.CANCEL },\n                { className: Dialogs.DIALOG_BTN_CLASS_PRIMARY, id: \"mainAction\", text: primaryButtonText }\n            ];\n        } else {\n            // Show only OK button (for disabled AI messages)\n            buttons = [\n                { className: Dialogs.DIALOG_BTN_CLASS_PRIMARY, id: Dialogs.DIALOG_BTN_OK, text: Strings.OK }\n            ];\n        }\n\n        Dialogs.showModalDialog(Dialogs.DIALOG_ID_INFO, title, message, buttons).done(function (id) {\n            Metrics.countEvent(Metrics.EVENT_TYPE.AI, \"dlgUpsell\", \"show\");\n            if(id === 'mainAction') {\n                if (needsLogin) {\n                    Metrics.countEvent(Metrics.EVENT_TYPE.AI, \"dlgUpsell\", \"signIn\");\n                    KernalModeTrust.EntitlementsManager.loginToAccount();\n                } else {\n                    Metrics.countEvent(Metrics.EVENT_TYPE.AI, \"dlgUpsell\", \"buyClick\");\n                    Phoenix.app.openURLInDefaultBrowser(buyURL);\n                }\n            } else {\n                Metrics.countEvent(Metrics.EVENT_TYPE.AI, \"dlgUpsell\", id);\n            }\n        });\n    }\n\n    if (Phoenix.isTestWindow) {\n        window._test_pro_dlg_login_exports = {\n            setFetchFn: function _setDdateNowFn(fn) {\n                fetchFn = fn;\n            }\n        };\n    }\n\n    exports.showProTrialStartDialog = showProTrialStartDialog;\n    exports.showProUpsellDialog = showProUpsellDialog;\n    exports.showAIUpsellDialog = showAIUpsellDialog;\n    exports.UPSELL_TYPE_PRO_TRIAL_ENDED = UPSELL_TYPE_PRO_TRIAL_ENDED;\n    exports.UPSELL_TYPE_GET_PRO = UPSELL_TYPE_GET_PRO;\n    exports.UPSELL_TYPE_LIVE_EDIT = UPSELL_TYPE_LIVE_EDIT;\n});\n"],"file":"pro-dialogs.js"}