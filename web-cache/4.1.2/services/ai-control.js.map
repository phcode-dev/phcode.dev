{"version":3,"sources":["services/ai-control.js"],"names":["define","require","exports","module","KernalModeTrust","window","Error","NodeUtils","Strings","StringUtils","EntitlementsManager","_getAIConfigFilePath","aiConfigPath","Phoenix","isNativeApp","platform","VFS","getTauriVirtualPath","AI_CONFIG_FILE_PATH","_isCurrentUserAllowed","allowedUsers","currentUser","Array","isArray","length","includes","async","getAIControlStatus","aiEnabled","fileData","readFileResolves","error","data","message","AI_CONTROL_ALL_ALLOWED_NO_CONFIG","aiConfig","JSON","parse","getOSUserName","disableAI","format","AI_CONTROL_USER_ALLOWED","managedByEmail","AI_CONTROL_ADMIN_DISABLED_CONTACT","AI_CONTROL_ADMIN_DISABLED","AI_CONTROL_ALL_ALLOWED","console","log","inited","init"],"mappings":"AAgBAA,OAAO,SAAUC,QAASC,QAASC,QAC/B,MAAMC,gBAAkBC,OAAOD,gBAC/B,IAAIA,gBAEA,MAAM,IAAIE,MAAM,uFAGpB,MAAMC,UAAYN,QAAQ,mBACtBO,QAAUP,QAAQ,WAClBQ,YAAcR,QAAQ,qBAC1B,IAAIS,oBAMJ,SAASC,uBACL,IAAIC,aAGJ,IAAIC,QAAQC,YACR,MAAO,GAGX,GAAyB,QAArBD,QAAQE,SACRH,aAAe,0DACZ,GAAyB,QAArBC,QAAQE,SACfH,aAAe,kEACZ,CAAA,GAAyB,UAArBC,QAAQE,SAGf,MAAM,IAAIT,+BAA+BO,QAAQE,YAFjDH,aAAe,sCAInB,OAAOC,QAAQG,IAAIC,oBAAoBL,cAE3C,MAAMM,oBAAsBP,uBAW5B,SAASQ,sBAAsBC,aAAcC,aACzC,SAAKD,eAAiBE,MAAMC,QAAQH,eAAyC,IAAxBA,aAAaI,SAI3DJ,aAAaK,SAASJ,aAOjCK,eAAeC,qBACX,IACI,IAAId,QAAQC,YACR,MAAO,CAACc,WAAW,GAGvB,MAAMC,eAAiBhB,QAAQG,IAAIc,iBAAiBZ,oBAAqB,QAEzE,GAAIW,SAASE,QAAUF,SAASG,KAC5B,MAAO,CACHJ,WAAW,EACXK,QAASzB,QAAQ0B,kCAIzB,MAAMC,SAAWC,KAAKC,MAAMR,SAASG,MAC/BX,kBAAoBd,UAAU+B,gBAGpC,OAA2B,IAAvBH,SAASI,UAELJ,SAASf,cAAgBD,sBAAsBgB,SAASf,aAAcC,aAC/D,CACHO,WAAW,EACXK,QAASxB,YAAY+B,OAAOhC,QAAQiC,wBAAyBpB,cAE3Dc,SAASO,eACR,CACHd,WAAW,EACXK,QAASxB,YAAY+B,OAAOhC,QAAQmC,kCAAmCR,SAASO,iBAGjF,CACHd,WAAW,EACXK,QAASzB,QAAQoC,2BAIlB,CACHhB,WAAW,EACXK,QAASzB,QAAQqC,wBAEvB,MAAOd,OAEL,OADAe,QAAQf,MAAM,6BAA8BA,OACrC,CAACH,WAAW,EAAMK,QAASF,MAAME,UAlE7CpB,QAAQC,aACPgC,QAAQC,IAAI,6BAA8B7B,qBAqE9C,IAAI8B,QAAS,EACb,SAASC,OACFD,SAGHA,QAAS,GACTtC,oBAAsBN,gBAAgBM,qBAClBiB,mBAAqBA,oBAG7CzB,QAAQ+C,KAAOA","sourcesContent":["// SPDX-License-Identifier: AGPL-3.0-only\n// Copyright (c) 2021 - present core.ai. All rights reserved.\n\n/**\n * This file is only relevant to desktop apps.\n *\n * AI can be not active in phoenix code either by:\n * 1. Schools with admin control. See https://docs.phcode.dev/docs/control-ai\n * 2. user is not entitled to ai services by his subscription.\n *\n * This file only deals with case 1. you should use `EntitlementsManager.js` to resolve the correct AI entitlment,\n * which will reconcile 1 and 2 to give you appropriate status.\n **/\n\n/*global */\n\ndefine(function (require, exports, module) {\n    const KernalModeTrust = window.KernalModeTrust;\n    if(!KernalModeTrust){\n        // integrated extensions will have access to kernal mode, but not external extensions\n        throw new Error(\"ai-control.js should have access to KernalModeTrust. Cannot boot without trust ring\");\n    }\n\n    const NodeUtils = require(\"utils/NodeUtils\"),\n        Strings = require(\"strings\"),\n        StringUtils = require(\"utils/StringUtils\");\n    let EntitlementsManager;\n\n    /**\n     * Get the platform-specific config file path\n     * @returns {string} The path to the config file\n     */\n    function _getAIConfigFilePath() {\n        let aiConfigPath;\n        // The path is decided by https://github.com/phcode-dev/phoenix-code-ai-control/tree/main/install_scripts\n\n        if(!Phoenix.isNativeApp) {\n            return \"\";\n        }\n\n        if (Phoenix.platform === 'win') {\n            aiConfigPath = 'C:\\\\Program Files\\\\Phoenix AI Control\\\\config.json';\n        } else if (Phoenix.platform === 'mac') {\n            aiConfigPath = '/Library/Application Support/Phoenix AI Control/config.json';\n        } else if (Phoenix.platform === 'linux') {\n            aiConfigPath = '/etc/phoenix-ai-control/config.json';\n        } else {\n            throw new Error(`Unsupported platform: ${Phoenix.platform}`);\n        }\n        return Phoenix.VFS.getTauriVirtualPath(aiConfigPath);\n    }\n    const AI_CONFIG_FILE_PATH = _getAIConfigFilePath();\n    if(Phoenix.isNativeApp) {\n        console.log(\"AI system Config File is: \", AI_CONFIG_FILE_PATH);\n    }\n\n    /**\n     * Check if the current user is in the allowed users list\n     * @param {Array<string>} allowedUsers - List of allowed usernames\n     * @param {string} currentUser to check against\n     * @returns {boolean} True if current user is allowed\n     */\n    function _isCurrentUserAllowed(allowedUsers, currentUser) {\n        if (!allowedUsers || !Array.isArray(allowedUsers) || allowedUsers.length === 0) {\n            return false;\n        }\n\n        return allowedUsers.includes(currentUser);\n    }\n\n    /**\n     * Get AI control configuration\n     * @returns {Object} The configuration status and details\n     */\n    async function getAIControlStatus() {\n        try {\n            if(!Phoenix.isNativeApp) {\n                return {aiEnabled: true}; // AI control with system files in not available in browser.\n                // In browser, AI can be disabled with firewall only.\n            }\n            const fileData = await Phoenix.VFS.readFileResolves(AI_CONFIG_FILE_PATH, 'utf8');\n\n            if (fileData.error || !fileData.data) {\n                return {\n                    aiEnabled: true,\n                    message: Strings.AI_CONTROL_ALL_ALLOWED_NO_CONFIG\n                }; // No ai config file exists\n            }\n\n            const aiConfig = JSON.parse(fileData.data);\n            const currentUser = await NodeUtils.getOSUserName();\n\n            // Check if AI is disabled globally\n            if (aiConfig.disableAI === true) {\n                // Check if current user is in allowed users list\n                if (aiConfig.allowedUsers && _isCurrentUserAllowed(aiConfig.allowedUsers, currentUser)) {\n                    return {\n                        aiEnabled: true,\n                        message: StringUtils.format(Strings.AI_CONTROL_USER_ALLOWED, currentUser)\n                    };\n                } else if(aiConfig.managedByEmail){\n                    return {\n                        aiEnabled: false,\n                        message: StringUtils.format(Strings.AI_CONTROL_ADMIN_DISABLED_CONTACT, aiConfig.managedByEmail)\n                    };\n                }\n                return {\n                    aiEnabled: false,\n                    message: Strings.AI_CONTROL_ADMIN_DISABLED\n                };\n            }\n            // AI is enabled globally\n            return {\n                aiEnabled: true,\n                message: Strings.AI_CONTROL_ALL_ALLOWED\n            };\n        } catch (error) {\n            console.error('Error checking AI control:', error);\n            return {aiEnabled: true, message: error.message};\n        }\n    }\n\n    let inited = false;\n    function init() {\n        if(inited){\n            return;\n        }\n        inited = true;\n        EntitlementsManager = KernalModeTrust.EntitlementsManager;\n        EntitlementsManager.getAIControlStatus = getAIControlStatus;\n    }\n\n    exports.init = init;\n});\n"],"file":"ai-control.js"}