define(function(require,exports,module){require("./setup-login-service");const Metrics=require("utils/Metrics"),semver=require("thirdparty/semver.browser"),ProDialogs=require("./pro-dialogs");let dateNowFn=Date.now;const KernalModeTrust=window.KernalModeTrust;if(!KernalModeTrust)throw new Error("Promotions service requires access to KernalModeTrust. Cannot boot without trust ring");const LoginService=KernalModeTrust.loginService,EVENT_PRO_UPGRADE_ON_INSTALL="pro_upgrade_on_install",PROMO_LOCAL_FILE=path.join(Phoenix.app.getApplicationSupportDirectory(),Phoenix.isTestWindow?"entitlements_promo_test.json":"entitlements_promo.json"),TRIAL_POLL_MS=1e3,FIRST_INSTALL_TRIAL_DAYS=30,SUBSEQUENT_TRIAL_DAYS=7,MS_PER_DAY=864e5,ERR_CORRUPTED="corrupted";function _writeFileAsync(filePath,data){return new Promise((resolve,reject)=>{window.fs.writeFile(filePath,data,"utf8",err=>{err?reject(err):resolve()})})}async function _clearTrialData(){try{Phoenix.isNativeApp?await KernalModeTrust.removeCredential(KernalModeTrust.CRED_KEY_PROMO):await new Promise(resolve=>{window.fs.unlink(PROMO_LOCAL_FILE,()=>resolve())})}catch(error){console.log("Error clearing trial data:",error)}}async function _generateSignature(proVersion,endDate){const salt=await LoginService.getSalt(),data=proVersion+"|"+endDate;return KernalModeTrust.generateDataSignature(data,salt)}async function _isValidSignature(trialData){if(!trialData.signature||!trialData.proVersion||!trialData.endDate)return!1;const expectedSignature=await _generateSignature(trialData.proVersion,trialData.endDate);return trialData.signature===expectedSignature}async function _getTrialData(){try{if(Phoenix.isNativeApp){const data=await KernalModeTrust.getCredential(KernalModeTrust.CRED_KEY_PROMO);if(!data)return null;try{const trialData=JSON.parse(data),isValid=await _isValidSignature(trialData);return isValid?{data:trialData}:{error:ERR_CORRUPTED}}catch(e){return{error:ERR_CORRUPTED}}}else{const fileData=await Phoenix.VFS.readFileResolves(PROMO_LOCAL_FILE,"utf8");if(fileData.error)return null;try{const trialData=JSON.parse(fileData.data),isValid=await _isValidSignature(trialData);return isValid?{data:trialData}:{error:ERR_CORRUPTED}}catch(e){return{error:ERR_CORRUPTED}}}}catch(error){return console.error("Error getting trial data:",error),{error:ERR_CORRUPTED}}}async function _setTrialData(trialData){trialData.signature=await _generateSignature(trialData.proVersion,trialData.endDate);try{Phoenix.isNativeApp?await KernalModeTrust.setCredential(KernalModeTrust.CRED_KEY_PROMO,JSON.stringify(trialData)):await _writeFileAsync(PROMO_LOCAL_FILE,JSON.stringify(trialData))}catch(error){throw console.error("Error setting trial data:",error),error}}function _calculateRemainingTrialDays(existingTrialData){const now=dateNowFn(),trialEndDate=existingTrialData.endDate,msRemaining=trialEndDate-now;return Math.max(0,Math.ceil(msRemaining/MS_PER_DAY))}function _isNewerVersion(version1,version2){try{return semver.gt(version1,version2)}catch(error){return console.error("Error comparing versions:",error,version1,version2),!1}}async function _hasProSubscription(){try{await LoginService._verifyLoginStatus();const entitlements=await LoginService.getEntitlements();return entitlements&&entitlements.plan&&!0===entitlements.plan.isSubscriber}catch(error){return console.error("Error checking pro subscription:",error),!1}}function _isTrialClosedForCurrentVersion(currentTrialData){if(!currentTrialData)return!1;const currentVersion=window.AppConfig?window.AppConfig.apiVersion:"1.0.0",remainingDays=_calculateRemainingTrialDays(currentTrialData),trialVersion=currentTrialData.proVersion,isNewerVersion=_isNewerVersion(currentVersion,trialVersion),trialClosedDialogShown=currentTrialData.upgradeDialogShownVersion===currentVersion;return trialClosedDialogShown||remainingDays<=0&&!isNewerVersion}async function getProTrialDaysRemaining(){const result=await _getTrialData();return!result||result.error||_isTrialClosedForCurrentVersion(result.data)?0:_calculateRemainingTrialDays(result.data)}async function activateProTrial(){const currentVersion=window.AppConfig?window.AppConfig.apiVersion:"1.0.0",result=await _getTrialData();let trialDays=FIRST_INSTALL_TRIAL_DAYS,endDate;const now=dateNowFn();let metricString=`${currentVersion.replaceAll(".","_")}`;if(result&&result.error){console.warn(`Trial data error detected (${result.error}) - resetting trial state without granting trial`),Metrics.countEvent(Metrics.EVENT_TYPE.PRO,"trial","corrupt");const hasProSubscription=await _hasProSubscription();return hasProSubscription?(console.log("User has pro subscription - resetting corrupted trial marker"),void await _setTrialData({proVersion:currentVersion,endDate:now})):(console.warn("trial data corrupted"),ProDialogs.showProUpsellDialog(ProDialogs.UPSELL_TYPE_PRO_TRIAL_ENDED),void await _setTrialData({proVersion:currentVersion,endDate:now}))}const existingTrialData=result?result.data:null;if(existingTrialData){const remainingDays=_calculateRemainingTrialDays(existingTrialData),trialVersion=existingTrialData.proVersion,isNewerVersion=_isNewerVersion(currentVersion,trialVersion);if(_isTrialClosedForCurrentVersion(existingTrialData)){if(existingTrialData.upgradeDialogShownVersion!==currentVersion){const hasProSubscription=await _hasProSubscription();hasProSubscription?console.log("Existing trial expired, but user has pro subscription - skipping promo dialog"):(console.log("Existing trial expired, showing promo ended dialog"),ProDialogs.showProUpsellDialog(ProDialogs.UPSELL_TYPE_PRO_TRIAL_ENDED)),await _setTrialData({...existingTrialData,upgradeDialogShownVersion:currentVersion})}else console.log("Existing trial expired, upgrade dialog already shown for this version");return}if(!isNewerVersion)return void console.log(`Same/older version - keeping existing ${remainingDays} day trial.`);remainingDays>=SUBSEQUENT_TRIAL_DAYS?(console.log(`Newer version, keeping existing trial (${remainingDays} days)`),trialDays=remainingDays,endDate=existingTrialData.endDate,metricString=`nD_${metricString}_upgrade`):(console.log(`Newer version - granting ${SUBSEQUENT_TRIAL_DAYS} days trial`),endDate=now+(trialDays=SUBSEQUENT_TRIAL_DAYS)*MS_PER_DAY,metricString=`3D_${metricString}`)}else endDate=now+FIRST_INSTALL_TRIAL_DAYS*MS_PER_DAY,metricString=`1Mo_${metricString}`;const trialData={proVersion:currentVersion,endDate:endDate};await _setTrialData(trialData),Metrics.countEvent(Metrics.EVENT_TYPE.PRO,"trialAct",metricString),Metrics.countEvent(Metrics.EVENT_TYPE.PRO,"trial","activated"),console.log(`Pro trial activated for ${trialDays} days`);const hasProSubscription=await _hasProSubscription();hasProSubscription?console.log("Pro trial activated, but user has pro subscription - skipping upgrade dialog"):ProDialogs.showProTrialStartDialog(trialDays),LoginService.trigger(EVENT_PRO_UPGRADE_ON_INSTALL,{trialDays:trialDays,isFirstInstall:!existingTrialData}),await LoginService.getEffectiveEntitlements(),LoginService.trigger(LoginService.EVENT_ENTITLEMENTS_CHANGED)}function _isAnyDialogsVisible(){const dialogsVisible=$(".modal.instance").is(":visible"),notificationsVisible=$(".notification-ui-tooltip").is(":visible");return dialogsVisible||notificationsVisible}console.log("Checking pro trial activation in 1 seconds...");const trialActivatePoller=setInterval(()=>{Phoenix.isTestWindow?clearInterval(trialActivatePoller):_isAnyDialogsVisible()||(clearInterval(trialActivatePoller),activateProTrial().catch(error=>{Metrics.countEvent(Metrics.EVENT_TYPE.PRO,"trial","errActivate"),logger.reportError(error,"Error activating pro trial:")}))},1e3);LoginService.getProTrialDaysRemaining=getProTrialDaysRemaining,LoginService.EVENT_PRO_UPGRADE_ON_INSTALL=EVENT_PRO_UPGRADE_ON_INSTALL,Phoenix.isTestWindow&&(window._test_promo_login_exports={LoginService:LoginService,ProDialogs:ProDialogs,_getTrialData:_getTrialData,_setTrialData:_setTrialData,_isTrialClosedForCurrentVersion:_isTrialClosedForCurrentVersion,_cleanTrialData:_clearTrialData,_cleanSaltData:async function(){try{Phoenix.isNativeApp&&(await KernalModeTrust.removeCredential(KernalModeTrust.SIGNATURE_SALT_KEY),console.log("Salt data cleanup completed"))}catch(error){console.log("Salt data cleanup completed (ignoring errors)")}},_testSetPromoJSON:async function(data){Phoenix.isNativeApp?await KernalModeTrust.setCredential(KernalModeTrust.CRED_KEY_PROMO,JSON.stringify(data)):await _writeFileAsync(PROMO_LOCAL_FILE,JSON.stringify(data))},activateProTrial:activateProTrial,getProTrialDaysRemaining:getProTrialDaysRemaining,setDateNowFn:function _setDdateNowFn(fn){dateNowFn=fn},EVENT_PRO_UPGRADE_ON_INSTALL:EVENT_PRO_UPGRADE_ON_INSTALL,TRIAL_CONSTANTS:{FIRST_INSTALL_TRIAL_DAYS:FIRST_INSTALL_TRIAL_DAYS,SUBSEQUENT_TRIAL_DAYS:SUBSEQUENT_TRIAL_DAYS,MS_PER_DAY:MS_PER_DAY},ERROR_CONSTANTS:{ERR_CORRUPTED:ERR_CORRUPTED}})});
//# sourceMappingURL=promotions.js.map
