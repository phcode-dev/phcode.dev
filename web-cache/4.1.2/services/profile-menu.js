define(function(require,exports,module){const Mustache=require("thirdparty/mustache/mustache"),PopUpManager=require("widgets/PopUpManager"),ThemeManager=require("view/ThemeManager"),Strings=require("strings"),StringUtils=require("utils/StringUtils"),LoginService=require("./login-service"),KernalModeTrust=window.KernalModeTrust;if(!KernalModeTrust)throw new Error("profile menu should have access to KernalModeTrust. Cannot boot without trust ring");let $icon;function _createSVGIcon(initials,bgColor){return`<svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n                <circle cx="12" cy="12" r="10" fill="${bgColor}"/>\n            <text x="12" y="12" text-anchor="middle" dominant-baseline="central" font-size="10" fill="#fff" font-family="Inter, sans-serif">\n            ${initials}</text>\n        </svg>`}function _updateProfileIcon(initials,bgColor){$icon.empty().append(_createSVGIcon(initials,bgColor))}function _removeProfileIcon(){$icon.empty()}const loginTemplate=require("text!./html/login-popup.html"),profileTemplate=require("text!./html/profile-popup.html");let $popup=null,isPopupVisible=!1,isBackgroundRefresh=!1,documentClickHandler=null;function _handleSignInBtnClick(){closePopup(),KernalModeTrust.loginService.signInToAccount()}function _handleSignOutBtnClick(){closePopup(),KernalModeTrust.loginService.signOutAccount()}function _handleContactSupportBtnClick(){Phoenix.app.openURLInDefaultBrowser(brackets.config.support_url)}function _handleAccountDetailsBtnClick(){Phoenix.app.openURLInDefaultBrowser(brackets.config.account_url)}function closePopup(){$popup&&(PopUpManager.removePopUp($popup),$popup=null,isPopupVisible=!1),documentClickHandler&&($(document).off("mousedown",documentClickHandler),documentClickHandler=null)}function positionPopup(){const $profileButton=$("#user-profile-button");if($profileButton.length&&$popup){const buttonPos=$profileButton.offset(),popupWidth=$popup.outerWidth(),windowWidth=$(window).width();let top=buttonPos.top-$popup.outerHeight()-10,left=Math.min(buttonPos.left-popupWidth+$profileButton.outerWidth(),windowWidth-popupWidth-10);left=Math.max(10,left),$popup.css({top:top+"px",left:left+"px"})}}function _setupDocumentClickHandler(){documentClickHandler&&$(document).off("mousedown",documentClickHandler),documentClickHandler=function(event){!$popup||$popup[0].contains(event.target)||$("#user-profile-button")[0].contains(event.target)||closePopup()},setTimeout(function(){$(document).on("mousedown",documentClickHandler)},100)}function showLoginPopup(){if(isPopupVisible)return void closePopup();closePopup();const renderedTemplate=Mustache.render(loginTemplate,{Strings:Strings,getProLink:brackets.config.purchase_url});$popup=$(renderedTemplate),$("body").append($popup),isPopupVisible=!0,positionPopup(),KernalModeTrust.loginService.getEffectiveEntitlements().then(effectiveEntitlements=>{if(effectiveEntitlements&&isPopupVisible&&$popup){let proInfoHtml=null;if(effectiveEntitlements.isInProTrial){const planName=StringUtils.format(Strings.PROMO_PRO_TRIAL_DAYS_LEFT,effectiveEntitlements.trialDaysRemaining);proInfoHtml=`<div class="trial-plan-info">\n                        <span class="phoenix-pro-title-plain">\n                            <span class="pro-plan-name user-plan-name">${planName}</span>\n                            <i class="fa-solid fa-feather" style="margin-left: 3px;"></i>\n                        </span>\n                    </div>`}else if(effectiveEntitlements.plan&&effectiveEntitlements.plan.isSubscriber){const planName=effectiveEntitlements.plan.fullName||brackets.config.main_pro_plan;proInfoHtml=`<div class="trial-plan-info">\n                        <span class="phoenix-pro-title-plain">\n                            <span class="pro-plan-name user-plan-name">${planName}</span>\n                            <i class="fa-solid fa-feather" style="margin-left: 3px;"></i>\n                        </span>\n                    </div>`}proInfoHtml&&($popup.find(".popup-title").after(proInfoHtml),positionPopup())}}).catch(error=>{console.error("Failed to check entitlements for login popup:",error)}),PopUpManager.addPopUp($popup,function(){$popup.remove(),$popup=null,isPopupVisible=!1},!0,{closeCurrentPopups:!0}),$popup.find("#phoenix-signin-btn").on("click",function(){_handleSignInBtnClick()}),$popup.find("#phoenix-support-btn").on("click",function(){_handleContactSupportBtnClick(),closePopup()}),$(window).on("resize.profilePopup",function(){isPopupVisible&&positionPopup()}),_setupDocumentClickHandler()}function _updateBranding(entitlements){const $brandingLink=$("#phcode-io-main-nav");if(entitlements||(Phoenix.pro.plan={isSubscriber:!1,name:Strings.USER_FREE_PLAN_NAME_DO_NOT_TRANSLATE,fullName:Strings.USER_FREE_PLAN_NAME_DO_NOT_TRANSLATE}),entitlements&&entitlements.plan&&(Phoenix.pro.plan={isSubscriber:entitlements.plan.isSubscriber,name:entitlements.plan.name,fullName:entitlements.plan.fullName,validTill:entitlements.plan.validTill}),entitlements&&entitlements.plan&&entitlements.plan.isSubscriber){let displayName=entitlements.plan.name||brackets.config.main_pro_plan;entitlements.isInProTrial&&(displayName=brackets.config.main_pro_plan),$brandingLink.attr("href","https://account.phcode.dev").addClass("phoenix-pro").html(`${displayName}<i class="fa-solid fa-feather orange-gold" style="margin-left: 3px;"></i>`)}else $brandingLink.attr("href","https://phcode.io").removeClass("phoenix-pro").text("phcode.io")}let userEmail="";class SecureEmail extends HTMLElement{constructor(){super();const shadow=this.attachShadow({mode:"closed"});shadow.innerHTML=`<span>${userEmail}</span>`}}customElements.define("secure-email",SecureEmail);let userName="";class SecureName extends HTMLElement{constructor(){super();const shadow=this.attachShadow({mode:"closed"});shadow.innerHTML=`<span>${userName}</span>`}}function _loadUserDetailsIframe(){if(!Phoenix.isNativeApp&&$popup){const $iframe=$popup.find("#user-details-frame"),$secureName=$popup.find(".user-name secure-name"),$secureEmail=$popup.find(".user-email secure-email");if($iframe.length){const accountBaseURL=KernalModeTrust.loginService.getAccountBaseURL(),currentTheme=ThemeManager.getCurrentTheme(),nameColor=currentTheme&&currentTheme.dark?"FFFFFF":"000000",iframeURL=`${accountBaseURL}/getUserDetailFrame?`+"includeName=true&nameFontSize=14px&emailFontSize=12px&"+`nameColor=%23${nameColor}&`+"emailColor=%23666666&backgroundColor=transparent",messageHandler=function(event){let trustedOrigin;trustedOrigin=accountBaseURL.startsWith("/proxy/accounts")?window.location.origin:new URL(accountBaseURL).origin,event.origin===trustedOrigin&&event.data&&event.data.loaded&&($secureName.hide(),$secureEmail.hide(),$iframe.show(),$iframe.css("height","36px"),window.removeEventListener("message",messageHandler))};window.addEventListener("message",messageHandler),$iframe.attr("src",iframeURL),setTimeout(()=>{$iframe.is(":hidden")&&(console.log("User details iframe failed to load, keeping secure elements"),window.removeEventListener("message",messageHandler))},5e3)}}}function _updatePopupWithEntitlements(entitlements){if(!$popup||!entitlements)return;const $getProLink=$popup.find(".get-phoenix-pro-profile");if(entitlements.plan){const $planName=$popup.find(".user-plan-name");if($planName.removeClass("user-plan-free user-plan-paid"),entitlements.plan.isSubscriber)if(entitlements.isInProTrial){const planName=StringUtils.format(Strings.PROMO_PRO_TRIAL_DAYS_LEFT,entitlements.trialDaysRemaining),proTitle=`<span class="phoenix-pro-title-plain">\n                        <span class="pro-plan-name user-plan-name">${planName}</span>\n                        <i class="fa-solid fa-feather" style="margin-left: 3px;"></i>\n                    </span>`;$planName.addClass("user-plan-paid").html(proTitle),$getProLink.removeClass("forced-hidden")}else{const proTitle=`<span class="phoenix-pro-title">\n                        <span class="pro-plan-name user-plan-name">${entitlements.plan.fullName}</span>\n                        <i class="fa-solid fa-feather" style="margin-left: 3px;"></i>\n                    </span>`;$planName.addClass("user-plan-paid").html(proTitle),$getProLink.addClass("forced-hidden")}else $planName.addClass("user-plan-free").text(entitlements.plan.fullName)}else $getProLink.removeClass("forced-hidden");if(entitlements.profileview&&entitlements.profileview.quota){const $quotaSection=$popup.find(".quota-section"),quota=entitlements.profileview.quota;$quotaSection.removeClass("forced-hidden"),$quotaSection.find(".titleText").text(quota.titleText),$quotaSection.find(".usageText").text(quota.usageText),$quotaSection.find(".progress-fill").css("width",quota.usedPercent+"%")}if(entitlements.profileview&&entitlements.profileview.htmlMessage){const $htmlMessageSection=$popup.find(".html-message");$htmlMessageSection.removeClass("forced-hidden"),$htmlMessageSection.html(entitlements.profileview.htmlMessage)}positionPopup()}function showProfilePopup(){if(isPopupVisible)return void closePopup();const profileData=KernalModeTrust.loginService.getProfile();userEmail=profileData.email,userName=profileData.firstName+" "+profileData.lastName;const templateData={initials:profileData.profileIcon.initials,avatarColor:profileData.profileIcon.color,planClass:"user-plan-free",planName:Strings.USER_FREE_PLAN_NAME_DO_NOT_TRANSLATE,titleText:"Ai Quota Used",usageText:"100 / 200 credits",usedPercent:0,Strings:Strings,getProLink:brackets.config.purchase_url},renderedTemplate=Mustache.render(profileTemplate,templateData);$popup=$(renderedTemplate),$("body").append($popup),isPopupVisible=!0,positionPopup(),KernalModeTrust.loginService.getEffectiveEntitlements(!1).then(cachedEntitlements=>{cachedEntitlements&&isPopupVisible&&_updatePopupWithEntitlements(cachedEntitlements)}).catch(error=>{console.error("Failed to apply cached entitlements to popup:",error)}),PopUpManager.addPopUp($popup,function(){$popup.remove(),$popup=null,isPopupVisible=!1},!0,{closeCurrentPopups:!0}),$popup.find("#phoenix-account-btn").on("click",function(){_handleAccountDetailsBtnClick(),closePopup()}),$popup.find("#phoenix-support-btn").on("click",function(){_handleContactSupportBtnClick(),closePopup()}),$popup.find("#phoenix-signout-btn").on("click",function(){_handleSignOutBtnClick()}),$(window).on("resize.profilePopup",function(){isPopupVisible&&positionPopup()}),_setupDocumentClickHandler(),_loadUserDetailsIframe(),_refreshEntitlementsInBackground()}async function _refreshEntitlementsInBackground(){try{const freshEntitlements=await KernalModeTrust.loginService.getEffectiveEntitlements(!0);isPopupVisible&&$popup&&freshEntitlements&&_updatePopupWithEntitlements(freshEntitlements)}catch(error){console.error("Failed to refresh entitlements in background:",error)}}function togglePopup(){if(isPopupVisible)return void closePopup();KernalModeTrust.loginService.isLoggedIn()?showProfilePopup():showLoginPopup();const wasLoggedInBefore=KernalModeTrust.loginService.isLoggedIn();isBackgroundRefresh=!0,KernalModeTrust.loginService._verifyLoginStatus().then(()=>{if(isBackgroundRefresh=!1,isPopupVisible){const isLoggedInNow=KernalModeTrust.loginService.isLoggedIn();wasLoggedInBefore!==isLoggedInNow&&(closePopup(),isLoggedInNow?showProfilePopup():showLoginPopup())}}).catch(error=>{isBackgroundRefresh=!1,console.error("Background login status verification failed:",error)})}async function _hasProActive(){try{const effectiveEntitlements=await KernalModeTrust.loginService.getEffectiveEntitlements();return effectiveEntitlements&&(effectiveEntitlements.isInProTrial||effectiveEntitlements.plan&&effectiveEntitlements.plan.isSubscriber)}catch(error){return console.error("Failed to check Pro access status:",error),!1}}async function _setBrandingForNonLoggedInUser(){try{const effectiveEntitlements=await KernalModeTrust.loginService.getEffectiveEntitlements();effectiveEntitlements&&(effectiveEntitlements.isInProTrial||effectiveEntitlements.plan&&effectiveEntitlements.plan.isSubscriber)?(console.log("Profile Menu: Found Pro entitlements (trial or device license), updating branding..."),_updateBranding(effectiveEntitlements)):(console.log("Profile Menu: No Pro entitlements found"),_updateBranding(null))}catch(error){console.error("Failed to initialize branding for non-logged-in Pro users:",error)}}customElements.define("secure-name",SecureName);let inited=!1;function init(){if(inited)return;inited=!0;const helpButtonID="user-profile-button";($icon=$("<a>").attr({id:helpButtonID,href:"#",class:"user",title:Strings.CMD_USER_PROFILE}).appendTo($("#main-toolbar .bottom-buttons"))).on("click",()=>{togglePopup()}),_setBrandingForNonLoggedInUser(),KernalModeTrust.loginService.on(KernalModeTrust.loginService.EVENT_ENTITLEMENTS_CHANGED,()=>{KernalModeTrust.loginService.isLoggedIn()||_setBrandingForNonLoggedInUser()})}function setNotLoggedIn(){isPopupVisible&&!isBackgroundRefresh&&closePopup(),_removeProfileIcon(),_hasProActive().then(hasProActive=>{hasProActive?(console.log("Profile Menu: Pro access exists, maintaining pro branding"),_setBrandingForNonLoggedInUser()):(console.log("Profile Menu: No Pro access, resetting branding to free"),_updateBranding(null))}).catch(error=>{console.error("Failed to check Pro access status during logout:",error),_updateBranding(null)}),KernalModeTrust.loginService.clearEntitlements()}function setLoggedIn(initial,color){isPopupVisible&&!isBackgroundRefresh&&closePopup(),_updateProfileIcon(initial,color),KernalModeTrust.loginService.getEffectiveEntitlements().then(_updateBranding).catch(error=>{console.error("Failed to preload effective entitlements on login:",error)})}exports.init=init,exports.setNotLoggedIn=setNotLoggedIn,exports.setLoggedIn=setLoggedIn});
//# sourceMappingURL=profile-menu.js.map
