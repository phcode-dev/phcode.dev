{"version":3,"sources":["extensionsIntegrated/indentGuides/main.js"],"names":["define","require","exports","module","PreferencesManager","Menus","Editor","EditorManager","AppInit","Commands","CommandManager","MainViewManager","Strings","COMMAND_NAME","CMD_TOGGLE_INDENT_GUIDES","COMMAND_ID","TOGGLE_INDENT_GUIDES","GUIDE_CLASS","GUIDE_CLASS_NONE","PREFERENCES_EDITOR_INDENT_GUIDES","PREFERENCES_EDITOR_INDENT_HIDE_FIRST","enabled","hideFirst","_createOverlayObject","spaceUnits","_spaceUnits","_cmRefreshPending","token","stream","_state","char","colNum","isTabStart","next","column","skipToEnd","this","flattenSpans","applyPreferences","get","updateUI","editor","getActiveEditor","_codeMirror","cm","_reRenderOverlay","removeOverlay","__indentGuidesOverlay","addOverlay","getSpaceUnits","document","file","fullPath","off","EVENT_OPTION_CHANGE","on","newSpaceUnits","console","log","shouldRerender","__indentGuidesOverlayAttached","__overlayEnabled","handleToggleGuides","set","preferenceChanged","setChecked","definePreference","description","DESCRIPTION_INDENT_GUIDES_ENABLED","DESCRIPTION_HIDE_FIRST","appReady","register","getMenu","AppMenuBar","VIEW_MENU","addMenuItem","AFTER","TOGGLE_RULERS"],"mappings":"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","sourcesContent":["/*\n * GNU AGPL-3.0 License\n *\n * Copyright (c) 2021 - present core.ai . All rights reserved.\n *\n * This program is free software: you can redistribute it and/or modify it\n * under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful, but WITHOUT\n * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or\n * FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License\n * for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see https://opensource.org/licenses/AGPL-3.0.\n *\n */\n\n// Adapted from https://github.com/lkcampbell/brackets-indent-guides by Lance Campbell.\n\n/*jslint vars: true, plusplus: true, devel: true, regexp: true, nomen: true, indent: 4, maxerr: 50 */\n\ndefine(function (require, exports, module) {\n\n    const PreferencesManager  = require(\"preferences/PreferencesManager\"),\n        Menus               = require(\"command/Menus\"),\n        Editor              = require(\"editor/Editor\").Editor,\n        EditorManager       = require(\"editor/EditorManager\"),\n        AppInit             = require(\"utils/AppInit\"),\n        Commands            = require(\"command/Commands\"),\n        CommandManager      = require(\"command/CommandManager\"),\n        MainViewManager     = require(\"view/MainViewManager\"),\n        Strings             = require(\"strings\");\n\n    const COMMAND_NAME    = Strings.CMD_TOGGLE_INDENT_GUIDES,\n        COMMAND_ID      = Commands.TOGGLE_INDENT_GUIDES,\n        GUIDE_CLASS     = \"phcode-indent-guides\",\n        GUIDE_CLASS_NONE     = \"phcode-indent-guides-none\";\n\n    const PREFERENCES_EDITOR_INDENT_GUIDES = \"editor.indentGuides\",\n        PREFERENCES_EDITOR_INDENT_HIDE_FIRST = \"editor.indentHideFirst\";\n\n    // Define extension preferences\n    let enabled     = true,\n        hideFirst   = false;\n\n    PreferencesManager.definePreference(PREFERENCES_EDITOR_INDENT_GUIDES, \"boolean\", enabled, {\n        description: Strings.DESCRIPTION_INDENT_GUIDES_ENABLED\n    });\n\n    PreferencesManager.definePreference(PREFERENCES_EDITOR_INDENT_HIDE_FIRST, \"boolean\", hideFirst, {\n        description: Strings.DESCRIPTION_HIDE_FIRST\n    });\n\n    // CodeMirror overlay code\n    function _createOverlayObject(spaceUnits) {\n        return {\n            _spaceUnits: spaceUnits,\n            _cmRefreshPending: false,\n            token: function (stream, _state) {\n                let char        = \"\",\n                    colNum      = 0,\n                    isTabStart  = false;\n\n                char    = stream.next();\n                colNum  = stream.column();\n\n                // Check for \"hide first guide\" preference\n                if ((hideFirst) && (colNum === 0)) {\n                    return null;\n                }\n\n                if (char === \"\\t\") {\n                    return enabled? GUIDE_CLASS : GUIDE_CLASS_NONE;\n                }\n\n                if (char !== \" \") {\n                    stream.skipToEnd();\n                    return null;\n                }\n\n                isTabStart = (colNum % this._spaceUnits) === 0 ? true : false;\n\n                if ((char === \" \") && (isTabStart)) {\n                    return enabled? GUIDE_CLASS : GUIDE_CLASS_NONE;\n                }\n                return null;\n            },\n            flattenSpans: false\n        };\n    }\n\n    function applyPreferences() {\n        enabled     = PreferencesManager.get(PREFERENCES_EDITOR_INDENT_GUIDES);\n        hideFirst   = PreferencesManager.get(PREFERENCES_EDITOR_INDENT_HIDE_FIRST);\n    }\n\n    function updateUI() {\n        const editor  = EditorManager.getActiveEditor();\n        if(!editor || !editor._codeMirror) {\n            return;\n        }\n        const cm = editor._codeMirror;\n        if(!editor.__indentGuidesOverlay) {\n            editor.__indentGuidesOverlay = _createOverlayObject(Editor.getSpaceUnits(editor.document.file.fullPath));\n        }\n        function _reRenderOverlay() {\n            cm.removeOverlay(editor.__indentGuidesOverlay);\n            cm.addOverlay(editor.__indentGuidesOverlay);\n        }\n        editor.off(Editor.EVENT_OPTION_CHANGE+\".indentGuide\");\n        editor.on(Editor.EVENT_OPTION_CHANGE+\".indentGuide\", ()=>{\n            const newSpaceUnits = Editor.getSpaceUnits(editor.document.file.fullPath);\n            if(newSpaceUnits !== editor.__indentGuidesOverlay._spaceUnits){\n                editor.__indentGuidesOverlay._spaceUnits = newSpaceUnits;\n                if(EditorManager.getActiveEditor() === editor){\n                    console.log(\"space units changed, refreshing indent guides for\",\n                        newSpaceUnits, editor.document.file.fullPath);\n                    _reRenderOverlay();\n                }\n            }\n        });\n\n        let shouldRerender = false;\n        if(!cm.__indentGuidesOverlayAttached){\n            cm.addOverlay(editor.__indentGuidesOverlay);\n            cm.__indentGuidesOverlayAttached = editor.__indentGuidesOverlay;\n            cm.__overlayEnabled = enabled;\n        } else if(cm.__indentGuidesOverlayAttached &&\n            cm.__indentGuidesOverlayAttached !== editor.__indentGuidesOverlay) {\n            cm.removeOverlay(cm.__indentGuidesOverlayAttached);\n            cm.addOverlay(editor.__indentGuidesOverlay);\n            cm.__overlayEnabled = enabled;\n        } else if (shouldRerender || cm.__overlayEnabled !== enabled) {\n            cm.__overlayEnabled = enabled;\n            _reRenderOverlay();\n            console.log(\"Refreshing indent guides\");\n        }\n    }\n\n    function handleToggleGuides() {\n        enabled = !enabled;\n        PreferencesManager.set(PREFERENCES_EDITOR_INDENT_GUIDES, enabled);\n    }\n\n    function preferenceChanged() {\n        applyPreferences();\n        updateUI();\n        CommandManager.get(COMMAND_ID)\n            .setChecked(enabled);\n    }\n\n    // Initialize extension\n    AppInit.appReady(function () {\n        // Register command and add to menu\n        CommandManager.register(COMMAND_NAME, COMMAND_ID, handleToggleGuides);\n        Menus.getMenu(Menus.AppMenuBar.VIEW_MENU)\n            .addMenuItem(COMMAND_ID, \"\", Menus.AFTER, Commands.TOGGLE_RULERS);\n\n        // Set up event listeners\n        PreferencesManager.on(\"change\", PREFERENCES_EDITOR_INDENT_GUIDES, preferenceChanged);\n        PreferencesManager.on(\"change\", PREFERENCES_EDITOR_INDENT_HIDE_FIRST, preferenceChanged);\n\n        MainViewManager.on(\"currentFileChange\", updateUI);\n        EditorManager.on(\"activeEditorChange\", updateUI);\n\n        // Apply preferences and draw indent guides\n        preferenceChanged();\n    });\n});"],"file":"main.js"}